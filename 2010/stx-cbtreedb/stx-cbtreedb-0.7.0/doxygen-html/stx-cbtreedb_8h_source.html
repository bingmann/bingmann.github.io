<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>stx-cbtreedb: include/stx-cbtreedb.h Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
<h1>include/stx-cbtreedb.h</h1><a href="stx-cbtreedb_8h.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">// -*- mode: c++; fill-column: 79 -*-</span>
<a name="l00002"></a>00002 <span class="comment">// $Id: stx-cbtreedb.h 7 2010-04-14 11:24:20Z tb $</span>
<a name="l00003"></a>00003 
<a name="l00008"></a>00008 <span class="comment">/*</span>
<a name="l00009"></a>00009 <span class="comment"> * STX Constant B-Tree Database Template Classes v0.7.0</span>
<a name="l00010"></a>00010 <span class="comment"> * Copyright (C) 2010 Timo Bingmann</span>
<a name="l00011"></a>00011 <span class="comment"> *</span>
<a name="l00012"></a>00012 <span class="comment"> * This library is free software; you can redistribute it and/or modify it</span>
<a name="l00013"></a>00013 <span class="comment"> * under the terms of the GNU Lesser General Public License as published by the</span>
<a name="l00014"></a>00014 <span class="comment"> * Free Software Foundation; either version 2.1 of the License, or (at your</span>
<a name="l00015"></a>00015 <span class="comment"> * option) any later version.</span>
<a name="l00016"></a>00016 <span class="comment"> *</span>
<a name="l00017"></a>00017 <span class="comment"> * This library is distributed in the hope that it will be useful, but WITHOUT</span>
<a name="l00018"></a>00018 <span class="comment"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<a name="l00019"></a>00019 <span class="comment"> * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU Lesser General Public License</span>
<a name="l00020"></a>00020 <span class="comment"> * for more details.</span>
<a name="l00021"></a>00021 <span class="comment"> *</span>
<a name="l00022"></a>00022 <span class="comment"> * You should have received a copy of the GNU Lesser General Public License</span>
<a name="l00023"></a>00023 <span class="comment"> * along with this library; if not, write to the Free Software Foundation,</span>
<a name="l00024"></a>00024 <span class="comment"> * Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA</span>
<a name="l00025"></a>00025 <span class="comment"> */</span>
<a name="l00026"></a>00026 
<a name="l00027"></a>00027 <span class="preprocessor">#ifndef _STX_CBTREEDB_H_</span>
<a name="l00028"></a>00028 <span class="preprocessor"></span><span class="preprocessor">#define _STX_CBTREEDB_H_</span>
<a name="l00029"></a>00029 <span class="preprocessor"></span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &lt;stdint.h&gt;</span>
<a name="l00032"></a>00032 
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;stdexcept&gt;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;vector&gt;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;map&gt;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &lt;iostream&gt;</span>
<a name="l00037"></a>00037 
<a name="l00039"></a><a class="code" href="namespacestx.html">00039</a> <span class="keyword">namespace </span>stx {
<a name="l00040"></a>00040 
<a name="l00041"></a>00041 <span class="comment">// *** Compile-time assertion macros borrowed from Boost</span>
<a name="l00042"></a>00042 
<a name="l00043"></a>00043 <span class="preprocessor">#ifndef STX_STATIC_ASSERT</span>
<a name="l00044"></a>00044 <span class="preprocessor"></span>
<a name="l00045"></a>00045 <span class="keyword">template</span> &lt;<span class="keywordtype">bool</span>&gt; <span class="keyword">struct </span>STATIC_ASSERTION_FAILURE;
<a name="l00046"></a><a class="code" href="structstx_1_1STATIC__ASSERTION__FAILURE_3_01true_01_4.html#a3fca9de85aa45a5fa9c8d6ff5273a553abfadf8f7aa72dca0cdc38b3c606e6a58">00046</a> <span class="keyword">template</span> &lt;&gt; <span class="keyword">struct </span>STATIC_ASSERTION_FAILURE&lt;true&gt; { <span class="keyword">enum</span> { value = 1 }; };
<a name="l00047"></a><a class="code" href="structstx_1_1static__assert__test.html">00047</a> <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> x&gt; <span class="keyword">struct </span><a class="code" href="structstx_1_1static__assert__test.html">static_assert_test</a> {};
<a name="l00048"></a>00048 
<a name="l00049"></a><a class="code" href="stx-cbtreedb_8h.html#a87b24be5b8caa4d665bb621d63617e58">00049</a> <span class="preprocessor">#define STX_MACRO_JOIN(X,Y) STX_MACRO_DO_JOIN(X,Y)</span>
<a name="l00050"></a><a class="code" href="stx-cbtreedb_8h.html#a24b49c025776399cfd2b8242847f0b99">00050</a> <span class="preprocessor"></span><span class="preprocessor">#define STX_MACRO_DO_JOIN(X,Y) STX_MACRO_DO_JOIN2(X,Y)</span>
<a name="l00051"></a><a class="code" href="stx-cbtreedb_8h.html#aeb50e9cfa71a924001a61fd6e62c6421">00051</a> <span class="preprocessor"></span><span class="preprocessor">#define STX_MACRO_DO_JOIN2(X,Y) X##Y</span>
<a name="l00052"></a>00052 <span class="preprocessor"></span>
<a name="l00053"></a><a class="code" href="stx-cbtreedb_8h.html#a3d0d8c8e38e2f98aee5c813855f0f2d2">00053</a> <span class="preprocessor">#define STX_STATIC_ASSERT(A) \</span>
<a name="l00054"></a>00054 <span class="preprocessor">    typedef static_assert_test&lt;sizeof(STATIC_ASSERTION_FAILURE&lt; static_cast&lt;bool&gt;(A) &gt;)&gt; \</span>
<a name="l00055"></a>00055 <span class="preprocessor">        STX_MACRO_JOIN(static_assert_typedef_, __LINE__)</span>
<a name="l00056"></a>00056 <span class="preprocessor"></span>
<a name="l00057"></a>00057 <span class="preprocessor">#endif</span>
<a name="l00058"></a>00058 <span class="preprocessor"></span>
<a name="l00086"></a>00086 <span class="keyword">template</span> &lt; <span class="keyword">typename</span> _Key = uint32_t,
<a name="l00087"></a>00087            <span class="keyword">typename</span> _Compare = std::less&lt;_Key&gt;,
<a name="l00088"></a>00088            <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> _BTreePageSize = 1024,
<a name="l00089"></a>00089            uint32_t _AppVersionId = 0&gt;
<a name="l00090"></a><a class="code" href="classstx_1_1CBTreeDB.html">00090</a> <span class="keyword">class </span><a class="code" href="classstx_1_1CBTreeDB.html" title="Template super-class enclosing all classes which can operate on a constant B-tree...">CBTreeDB</a>
<a name="l00091"></a>00091 {
<a name="l00092"></a>00092 <span class="keyword">public</span>:
<a name="l00093"></a>00093     <span class="comment">// *** Template Parameters</span>
<a name="l00094"></a>00094 
<a name="l00097"></a><a class="code" href="classstx_1_1CBTreeDB.html#a3853858e7d8cc630c832232bc46ed2c0">00097</a>     <span class="keyword">typedef</span> _Key        <a class="code" href="classstx_1_1CBTreeDB.html#a3853858e7d8cc630c832232bc46ed2c0" title="first template parameter: the key type of the B-tree.">key_type</a>;
<a name="l00098"></a>00098 
<a name="l00100"></a><a class="code" href="classstx_1_1CBTreeDB.html#aa8d64c69bfec9eb6728d50ce1668d522">00100</a>     <span class="keyword">typedef</span> _Compare    <a class="code" href="classstx_1_1CBTreeDB.html#aa8d64c69bfec9eb6728d50ce1668d522" title="second template parameter: key comparison function object type.">key_compare</a>;
<a name="l00101"></a>00101 
<a name="l00103"></a><a class="code" href="classstx_1_1CBTreeDB.html#a924efff56b96b6c5a0397211b0cf8685">00103</a>     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="classstx_1_1CBTreeDB.html#a924efff56b96b6c5a0397211b0cf8685" title="third template parameter: B-tree page size. Usually 1024 or 2048.">BTreePageSize</a> = _BTreePageSize;
<a name="l00104"></a>00104 
<a name="l00107"></a><a class="code" href="classstx_1_1CBTreeDB.html#afbb1611aa42b9f5630ca5dc1b8546988">00107</a>     <span class="keyword">static</span> <span class="keyword">const</span> uint32_t <a class="code" href="classstx_1_1CBTreeDB.html#afbb1611aa42b9f5630ca5dc1b8546988" title="fourth template parameter: application-defined 32-bit identifier to mark database...">AppVersionId</a> = _AppVersionId;
<a name="l00108"></a>00108 
<a name="l00109"></a>00109     <span class="comment">// *** Structure parameters calculated from page size</span>
<a name="l00110"></a>00110 
<a name="l00113"></a><a class="code" href="classstx_1_1CBTreeDB.html#a7e0cd4ed3915f9b944b5828b02b27fa5">00113</a>     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="classstx_1_1CBTreeDB.html#a7e0cd4ed3915f9b944b5828b02b27fa5" title="size of fields before key+offset array in LeafNode and additional offset at end.">LeafNodeHead</a> = 2 * <span class="keyword">sizeof</span>(uint16_t) + <span class="keyword">sizeof</span>(uint64_t) + <span class="keyword">sizeof</span>(uint32_t);
<a name="l00114"></a>00114 
<a name="l00116"></a><a class="code" href="classstx_1_1CBTreeDB.html#acca9b452de05001486b111a4c415cfcb">00116</a>     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="classstx_1_1CBTreeDB.html#acca9b452de05001486b111a4c415cfcb" title="number of key+offsets in each LeafNode">LeafNodeNumKeys</a> = (<a class="code" href="classstx_1_1CBTreeDB.html#a924efff56b96b6c5a0397211b0cf8685" title="third template parameter: B-tree page size. Usually 1024 or 2048.">BTreePageSize</a> - <a class="code" href="classstx_1_1CBTreeDB.html#a7e0cd4ed3915f9b944b5828b02b27fa5" title="size of fields before key+offset array in LeafNode and additional offset at end.">LeafNodeHead</a>) / (<span class="keyword">sizeof</span>(<a class="code" href="classstx_1_1CBTreeDB.html#a3853858e7d8cc630c832232bc46ed2c0" title="first template parameter: the key type of the B-tree.">key_type</a>) + <span class="keyword">sizeof</span>(uint32_t));
<a name="l00117"></a>00117 
<a name="l00118"></a>00118     <a class="code" href="classstx_1_1CBTreeDB.html#a651bc40a21e741a77d73163da358c262">STX_STATIC_ASSERT</a>( <a class="code" href="classstx_1_1CBTreeDB.html#acca9b452de05001486b111a4c415cfcb" title="number of key+offsets in each LeafNode">LeafNodeNumKeys</a> &gt;= 1 );
<a name="l00119"></a>00119 
<a name="l00121"></a><a class="code" href="classstx_1_1CBTreeDB.html#ab19bfe8cccf12e1d2d38bf98369e6fb8">00121</a>     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="classstx_1_1CBTreeDB.html#ab19bfe8cccf12e1d2d38bf98369e6fb8" title="number of unused fill bytes in each LeafNode">LeafNodeFiller</a> = <a class="code" href="classstx_1_1CBTreeDB.html#a924efff56b96b6c5a0397211b0cf8685" title="third template parameter: B-tree page size. Usually 1024 or 2048.">BTreePageSize</a> - <a class="code" href="classstx_1_1CBTreeDB.html#a7e0cd4ed3915f9b944b5828b02b27fa5" title="size of fields before key+offset array in LeafNode and additional offset at end.">LeafNodeHead</a> - <a class="code" href="classstx_1_1CBTreeDB.html#acca9b452de05001486b111a4c415cfcb" title="number of key+offsets in each LeafNode">LeafNodeNumKeys</a> * (<span class="keyword">sizeof</span>(<a class="code" href="classstx_1_1CBTreeDB.html#a3853858e7d8cc630c832232bc46ed2c0" title="first template parameter: the key type of the B-tree.">key_type</a>) + <span class="keyword">sizeof</span>(uint32_t));
<a name="l00122"></a>00122 
<a name="l00124"></a><a class="code" href="classstx_1_1CBTreeDB.html#af944ce7bcec9897ed7c0e1a3f3c8bebf">00124</a>     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="classstx_1_1CBTreeDB.html#af944ce7bcec9897ed7c0e1a3f3c8bebf" title="size of fields before key array in InnerNode">InnerNodeHead</a> = 2 * <span class="keyword">sizeof</span>(uint16_t) + <span class="keyword">sizeof</span>(uint32_t);
<a name="l00125"></a>00125 
<a name="l00127"></a><a class="code" href="classstx_1_1CBTreeDB.html#ae95b23de1103556bb96353fda4efe052">00127</a>     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="classstx_1_1CBTreeDB.html#ae95b23de1103556bb96353fda4efe052" title="number of keys in each InnerNode">InnerNodeNumKeys</a> = (<a class="code" href="classstx_1_1CBTreeDB.html#a924efff56b96b6c5a0397211b0cf8685" title="third template parameter: B-tree page size. Usually 1024 or 2048.">BTreePageSize</a> - <a class="code" href="classstx_1_1CBTreeDB.html#af944ce7bcec9897ed7c0e1a3f3c8bebf" title="size of fields before key array in InnerNode">InnerNodeHead</a>) / <span class="keyword">sizeof</span>(<a class="code" href="classstx_1_1CBTreeDB.html#a3853858e7d8cc630c832232bc46ed2c0" title="first template parameter: the key type of the B-tree.">key_type</a>);
<a name="l00128"></a>00128 
<a name="l00129"></a>00129     <a class="code" href="classstx_1_1CBTreeDB.html#a651bc40a21e741a77d73163da358c262">STX_STATIC_ASSERT</a>( <a class="code" href="classstx_1_1CBTreeDB.html#ae95b23de1103556bb96353fda4efe052" title="number of keys in each InnerNode">InnerNodeNumKeys</a> &gt;= 2 );
<a name="l00130"></a>00130 
<a name="l00132"></a><a class="code" href="classstx_1_1CBTreeDB.html#a0e3da86f9a215193cb291ca7321143dc">00132</a>     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="classstx_1_1CBTreeDB.html#a0e3da86f9a215193cb291ca7321143dc" title="number of unused fill bytes in each InnerNode">InnerNodeFiller</a> = <a class="code" href="classstx_1_1CBTreeDB.html#a924efff56b96b6c5a0397211b0cf8685" title="third template parameter: B-tree page size. Usually 1024 or 2048.">BTreePageSize</a> - <a class="code" href="classstx_1_1CBTreeDB.html#af944ce7bcec9897ed7c0e1a3f3c8bebf" title="size of fields before key array in InnerNode">InnerNodeHead</a> - <a class="code" href="classstx_1_1CBTreeDB.html#ae95b23de1103556bb96353fda4efe052" title="number of keys in each InnerNode">InnerNodeNumKeys</a> * <span class="keyword">sizeof</span>(<a class="code" href="classstx_1_1CBTreeDB.html#a3853858e7d8cc630c832232bc46ed2c0" title="first template parameter: the key type of the B-tree.">key_type</a>);
<a name="l00133"></a>00133 
<a name="l00134"></a>00134 <span class="keyword">public</span>:
<a name="l00138"></a><a class="code" href="classstx_1_1CBTreeDB_1_1Exception.html">00138</a>     <span class="keyword">class </span><a class="code" href="classstx_1_1CBTreeDB_1_1Exception.html" title="Our own exception class derived from std::runtime_error.">Exception</a> : <span class="keyword">public</span> std::runtime_error
<a name="l00139"></a>00139     {
<a name="l00140"></a>00140     <span class="keyword">public</span>:
<a name="l00142"></a><a class="code" href="classstx_1_1CBTreeDB_1_1Exception.html#a7d0125ee2da926d39c3f6ee7610b07b5">00142</a>         <span class="keyword">explicit</span> <a class="code" href="classstx_1_1CBTreeDB_1_1Exception.html#a7d0125ee2da926d39c3f6ee7610b07b5" title="Create new exception object with error message.">Exception</a>(<span class="keyword">const</span> std::string&amp; str)
<a name="l00143"></a>00143             : std::runtime_error(<span class="stringliteral">&quot;CBTreeDB: &quot;</span> + str)
<a name="l00144"></a>00144         {
<a name="l00145"></a>00145         }
<a name="l00146"></a>00146     };
<a name="l00147"></a>00147 
<a name="l00150"></a><a class="code" href="stx-cbtreedb_8h.html#ab44bd6c500e8dbe3a232e4c44f28b67e">00150</a> <span class="preprocessor">#define CBTREEDB_ASSERT(x) do { if (!(x)) throw(Exception(&quot;Assertion failed: &quot; #x)); } while(0)</span>
<a name="l00151"></a>00151 <span class="preprocessor"></span>
<a name="l00155"></a><a class="code" href="stx-cbtreedb_8h.html#aea46b67a1c31f750df77b32d5db56e2f">00155</a> <span class="preprocessor">#define CBTREEDB_CHECK(x,msg) do { if (!(x)) throw(Exception(msg)); } while(0)</span>
<a name="l00156"></a>00156 <span class="preprocessor"></span>
<a name="l00157"></a>00157 <span class="keyword">public</span>:
<a name="l00165"></a><a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html">00165</a>     <span class="keyword">struct </span><a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html" title="Signature page which heads all cbtreedb files.">SignaturePage</a>
<a name="l00166"></a>00166     {
<a name="l00167"></a><a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#ae797c2f1bb21f13ddf4008156424a76c">00167</a>         <span class="keywordtype">char</span>            <a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#ae797c2f1bb21f13ddf4008156424a76c" title="&amp;quot;cbtreedb&amp;quot; or custom string">signature</a>[8];   
<a name="l00168"></a><a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#a6600a8e6bef01f7ec30af5f4ad2b4823">00168</a>         uint32_t        <a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#a6600a8e6bef01f7ec30af5f4ad2b4823" title="CRC32 of following bytes.">header_crc32</a>;   
<a name="l00169"></a><a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#ad47a6a5d93fff2689f58d8a4c5dd426f">00169</a>         uint32_t        <a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#ad47a6a5d93fff2689f58d8a4c5dd426f" title="0x00010000">version</a>;        
<a name="l00170"></a><a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#a97ef2f19de2402cc23a723e513a37fb5">00170</a>         uint32_t        <a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#a97ef2f19de2402cc23a723e513a37fb5" title="custom id defined by template">app_version_id</a>; 
<a name="l00171"></a>00171 
<a name="l00172"></a><a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#a72aa9d25a46e2d8645759e983c2dd207">00172</a>         uint32_t        <a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#a72aa9d25a46e2d8645759e983c2dd207" title="key-value pairs in db">items</a>;          
<a name="l00173"></a><a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#a89ff60cdddd1e47cd625bca380b04aab">00173</a>         uint32_t        <a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#a89ff60cdddd1e47cd625bca380b04aab" title="sizeof(key_type)">key_size</a>;       
<a name="l00174"></a>00174 
<a name="l00175"></a><a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#a15d319c4ae75a1d16e6c63e28a10dc03">00175</a>         uint64_t        <a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#a15d319c4ae75a1d16e6c63e28a10dc03" title="b-tree offset in file">btree_offset</a>;   
<a name="l00176"></a><a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#a0ae66a64d4404955ee7df3d65c298876">00176</a>         uint64_t        <a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#a0ae66a64d4404955ee7df3d65c298876" title="b-tree total size in bytes">btree_size</a>;     
<a name="l00177"></a><a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#a26efd4b957baf1edde0aa13981b355f0">00177</a>         uint64_t        <a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#a26efd4b957baf1edde0aa13981b355f0" title="offset of first leaf in file">btree_firstleaf</a>; 
<a name="l00178"></a><a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#ab515a6550576bc2b2664a5c7b9ca3644">00178</a>         uint32_t        <a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#ab515a6550576bc2b2664a5c7b9ca3644" title="size of b-tree nodes">btree_pagesize</a>; 
<a name="l00179"></a><a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#ad992a1e376b01b0e1e1f2d47c297404d">00179</a>         uint32_t        <a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#ad992a1e376b01b0e1e1f2d47c297404d" title="number of levels in tree">btree_levels</a>;   
<a name="l00180"></a><a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#a2eb180e1d95d991a3eb233e0217b3642">00180</a>         uint32_t        <a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#a2eb180e1d95d991a3eb233e0217b3642" title="number of leaf nodes in tree">btree_leaves</a>;   
<a name="l00181"></a><a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#a927c832ad13552500beb604ea44ee7ea">00181</a>         uint8_t         <a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#a927c832ad13552500beb604ea44ee7ea" title="SHA256 digest of all tree nodes.">btree_sha256</a>[32]; 
<a name="l00182"></a>00182 
<a name="l00183"></a><a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#a32547b948043297c36349fa1f72a07f0">00183</a>         uint64_t        <a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#a32547b948043297c36349fa1f72a07f0" title="file offset of value data area">value_offset</a>;   
<a name="l00184"></a><a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#ae7b237b7498fe2cc48844222861de850">00184</a>         uint64_t        <a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#ae7b237b7498fe2cc48844222861de850" title="total size of value data area">value_size</a>;     
<a name="l00185"></a><a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#a6837b8e8b502df1f3c233e7f5c689d2e">00185</a>         uint8_t         <a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#a6837b8e8b502df1f3c233e7f5c689d2e" title="SHA256 digest of all value data.">value_sha256</a>[32]; 
<a name="l00186"></a>00186     }
<a name="l00187"></a>00187         __attribute__((<a class="code" href="classstx_1_1CBTreeDB.html#a0a57e296404542a54803e92ef3539de8" title="Signature page which heads all cbtreedb files.">packed</a>));
<a name="l00188"></a>00188 
<a name="l00190"></a><a class="code" href="classstx_1_1CBTreeDB.html#af31d6adca51ce73acce0abbb0ac3bd72">00190</a>     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="classstx_1_1CBTreeDB.html#af31d6adca51ce73acce0abbb0ac3bd72" title="Fixed signature page size: always equal to the B-tree page.">SignaturePageSize</a> = <a class="code" href="classstx_1_1CBTreeDB.html#a924efff56b96b6c5a0397211b0cf8685" title="third template parameter: B-tree page size. Usually 1024 or 2048.">BTreePageSize</a>;
<a name="l00191"></a>00191 
<a name="l00192"></a>00192     <a class="code" href="classstx_1_1CBTreeDB.html#a651bc40a21e741a77d73163da358c262">STX_STATIC_ASSERT</a>( <span class="keyword">sizeof</span>(<a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html" title="Signature page which heads all cbtreedb files.">SignaturePage</a>) &lt;= <a class="code" href="classstx_1_1CBTreeDB.html#a924efff56b96b6c5a0397211b0cf8685" title="third template parameter: B-tree page size. Usually 1024 or 2048.">BTreePageSize</a> );
<a name="l00193"></a>00193 
<a name="l00194"></a>00194 <span class="keyword">protected</span>:
<a name="l00206"></a><a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html">00206</a>     <span class="keyword">struct </span><a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html" title="Leaf node structure of the B-tree leaf pages.">LeafNode</a>
<a name="l00207"></a>00207     {
<a name="l00209"></a><a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#a4e588b2700983fb765abf1c68908874b">00209</a>         uint16_t        <a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#a4e588b2700983fb765abf1c68908874b" title="level of this leaf node -&amp;gt; always 0.">level</a>;
<a name="l00210"></a>00210 
<a name="l00212"></a><a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#a7355e231680da86d20a036675b9cedc9">00212</a>         uint16_t        <a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#a7355e231680da86d20a036675b9cedc9" title="number of used slots in the arrays.">slots</a>;
<a name="l00213"></a>00213 
<a name="l00215"></a><a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#ae16aa36d66c1ec576cdf5885fb7446e8">00215</a>         uint64_t        <a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#ae16aa36d66c1ec576cdf5885fb7446e8" title="base of value offsets enumerated in array.">baseoffset</a>;
<a name="l00216"></a>00216 
<a name="l00217"></a>00217         <span class="keyword">union</span>
<a name="l00218"></a>00218         {
<a name="l00219"></a>00219             <span class="keyword">struct</span>
<a name="l00220"></a>00220             {
<a name="l00222"></a><a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#a92d237e7bc59ffcfb4530303af043a7f">00222</a>                 <a class="code" href="classstx_1_1CBTreeDB.html#a3853858e7d8cc630c832232bc46ed2c0" title="first template parameter: the key type of the B-tree.">key_type</a>        <a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#a92d237e7bc59ffcfb4530303af043a7f" title="key array of ascending key in this leaf.">keys</a>[<a class="code" href="classstx_1_1CBTreeDB.html#acca9b452de05001486b111a4c415cfcb" title="number of key+offsets in each LeafNode">LeafNodeNumKeys</a>];
<a name="l00223"></a>00223 
<a name="l00225"></a><a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#a65c94b32f23036adb8e864b440c1c6ae">00225</a>                 uint32_t        <a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#a65c94b32f23036adb8e864b440c1c6ae" title="file offset of value data associated with key.">offsets</a>[<a class="code" href="classstx_1_1CBTreeDB.html#acca9b452de05001486b111a4c415cfcb" title="number of key+offsets in each LeafNode">LeafNodeNumKeys</a>+1];
<a name="l00226"></a>00226             }
<a name="l00227"></a>00227                 __attribute__((<a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#a5e7cb444c7e93766574e1c9f904e447c">packed</a>));
<a name="l00228"></a>00228 
<a name="l00230"></a><a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#a4ce8abec860cdc48def886b05643f6cc">00230</a>             <span class="keywordtype">char</span>        <a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#a4ce8abec860cdc48def886b05643f6cc" title="union with filler char array to assure page size.">filler</a>[<a class="code" href="classstx_1_1CBTreeDB.html#a924efff56b96b6c5a0397211b0cf8685" title="third template parameter: B-tree page size. Usually 1024 or 2048.">BTreePageSize</a> - <a class="code" href="classstx_1_1CBTreeDB.html#a7e0cd4ed3915f9b944b5828b02b27fa5" title="size of fields before key+offset array in LeafNode and additional offset at end.">LeafNodeHead</a> + <span class="keyword">sizeof</span>(uint32_t)];
<a name="l00231"></a>00231         };
<a name="l00232"></a>00232 
<a name="l00234"></a><a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#a13e413b1d87bf16f037948a19cada3ff">00234</a>         <span class="keyword">inline</span> <span class="keyword">explicit</span> <a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#a13e413b1d87bf16f037948a19cada3ff" title="Initializes structure with zero.">LeafNode</a>()
<a name="l00235"></a>00235             : <a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#a4e588b2700983fb765abf1c68908874b" title="level of this leaf node -&amp;gt; always 0.">level</a>(0), <a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#a7355e231680da86d20a036675b9cedc9" title="number of used slots in the arrays.">slots</a>(0), <a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#ae16aa36d66c1ec576cdf5885fb7446e8" title="base of value offsets enumerated in array.">baseoffset</a>(0)
<a name="l00236"></a>00236         {
<a name="l00237"></a>00237             memset(<a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#a4ce8abec860cdc48def886b05643f6cc" title="union with filler char array to assure page size.">filler</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#a4ce8abec860cdc48def886b05643f6cc" title="union with filler char array to assure page size.">filler</a>));
<a name="l00238"></a>00238         }
<a name="l00239"></a>00239 
<a name="l00241"></a><a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#ac4ea9a2887d2c31f835e466d79ee66b3">00241</a>         <span class="keyword">inline</span> <span class="keywordtype">bool</span> <a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#ac4ea9a2887d2c31f835e466d79ee66b3" title="Returns true if no more keys can be added.">IsFull</a>()<span class="keyword"> const</span>
<a name="l00242"></a>00242 <span class="keyword">        </span>{
<a name="l00243"></a>00243             <span class="keywordflow">return</span> (<a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#a7355e231680da86d20a036675b9cedc9" title="number of used slots in the arrays.">slots</a> &gt;= <a class="code" href="classstx_1_1CBTreeDB.html#acca9b452de05001486b111a4c415cfcb" title="number of key+offsets in each LeafNode">LeafNodeNumKeys</a>);
<a name="l00244"></a>00244         }
<a name="l00245"></a>00245 
<a name="l00247"></a><a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#a88857726917ddbcb3662c7fc14c4cb91">00247</a>         <span class="keyword">inline</span> <span class="keyword">const</span> <a class="code" href="classstx_1_1CBTreeDB.html#a3853858e7d8cc630c832232bc46ed2c0" title="first template parameter: the key type of the B-tree.">key_type</a>&amp; <a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#a88857726917ddbcb3662c7fc14c4cb91" title="Returns the currently last key in the node.">LastKey</a>()<span class="keyword"> const</span>
<a name="l00248"></a>00248 <span class="keyword">        </span>{
<a name="l00249"></a>00249             <a class="code" href="stx-cbtreedb_8h.html#ab44bd6c500e8dbe3a232e4c44f28b67e" title="Instead of assert() we use this macro to throw exceptions.">CBTREEDB_ASSERT</a>(<a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#a7355e231680da86d20a036675b9cedc9" title="number of used slots in the arrays.">slots</a> &gt; 0 &amp;&amp; <a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#a7355e231680da86d20a036675b9cedc9" title="number of used slots in the arrays.">slots</a> &lt; <a class="code" href="classstx_1_1CBTreeDB.html#acca9b452de05001486b111a4c415cfcb" title="number of key+offsets in each LeafNode">LeafNodeNumKeys</a>+1);
<a name="l00250"></a>00250             <span class="keywordflow">return</span> <a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#a92d237e7bc59ffcfb4530303af043a7f" title="key array of ascending key in this leaf.">keys</a>[<a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#a7355e231680da86d20a036675b9cedc9" title="number of used slots in the arrays.">slots</a>-1];
<a name="l00251"></a>00251         }
<a name="l00252"></a>00252     }
<a name="l00253"></a>00253         __attribute__((<a class="code" href="classstx_1_1CBTreeDB.html#a0a57e296404542a54803e92ef3539de8" title="Signature page which heads all cbtreedb files.">packed</a>));
<a name="l00254"></a>00254 
<a name="l00255"></a>00255     <a class="code" href="classstx_1_1CBTreeDB.html#a651bc40a21e741a77d73163da358c262">STX_STATIC_ASSERT</a>( <span class="keyword">sizeof</span>(LeafNode) == <a class="code" href="classstx_1_1CBTreeDB.html#a924efff56b96b6c5a0397211b0cf8685" title="third template parameter: B-tree page size. Usually 1024 or 2048.">BTreePageSize</a> );
<a name="l00256"></a>00256 
<a name="l00264"></a><a class="code" href="structstx_1_1CBTreeDB_1_1InnerNode.html">00264</a>     <span class="keyword">struct </span><a class="code" href="structstx_1_1CBTreeDB_1_1InnerNode.html" title="Inner node structure of the B-tree inner pages.">InnerNode</a>
<a name="l00265"></a>00265     {
<a name="l00267"></a><a class="code" href="structstx_1_1CBTreeDB_1_1InnerNode.html#a03dfd6173cbf57de4bf30dbe2c1c23bb">00267</a>         uint16_t        <a class="code" href="structstx_1_1CBTreeDB_1_1InnerNode.html#a03dfd6173cbf57de4bf30dbe2c1c23bb" title="level of this inner node, always &amp;gt; 0.">level</a>;
<a name="l00268"></a>00268 
<a name="l00270"></a><a class="code" href="structstx_1_1CBTreeDB_1_1InnerNode.html#a39993c719c0479b1ab32d0b64758ecf0">00270</a>         uint16_t        <a class="code" href="structstx_1_1CBTreeDB_1_1InnerNode.html#a39993c719c0479b1ab32d0b64758ecf0" title="number of used slots in the arrays.">slots</a>;
<a name="l00271"></a>00271 
<a name="l00273"></a><a class="code" href="structstx_1_1CBTreeDB_1_1InnerNode.html#aa8a393e3980026418172cb866576d47e">00273</a>         uint32_t        <a class="code" href="structstx_1_1CBTreeDB_1_1InnerNode.html#aa8a393e3980026418172cb866576d47e" title="base offset of child B-tree nodes enumerated by keys.">childrenoffset</a>;
<a name="l00274"></a>00274 
<a name="l00275"></a>00275         <span class="keyword">union</span>
<a name="l00276"></a>00276         {
<a name="l00278"></a><a class="code" href="structstx_1_1CBTreeDB_1_1InnerNode.html#ae991d7c99f3ab0820bcd0254ed53fca8">00278</a>             <a class="code" href="classstx_1_1CBTreeDB.html#a3853858e7d8cc630c832232bc46ed2c0" title="first template parameter: the key type of the B-tree.">key_type</a>    <a class="code" href="structstx_1_1CBTreeDB_1_1InnerNode.html#ae991d7c99f3ab0820bcd0254ed53fca8" title="key array of ascending keys in this inner node.">keys</a>[<a class="code" href="classstx_1_1CBTreeDB.html#ae95b23de1103556bb96353fda4efe052" title="number of keys in each InnerNode">InnerNodeNumKeys</a>];
<a name="l00279"></a>00279 
<a name="l00281"></a><a class="code" href="structstx_1_1CBTreeDB_1_1InnerNode.html#ac9cfadfe0f68704e6cc91a8f82bf383c">00281</a>             <span class="keywordtype">char</span>        <a class="code" href="structstx_1_1CBTreeDB_1_1InnerNode.html#ac9cfadfe0f68704e6cc91a8f82bf383c" title="union with filler char array to assure page size.">filler</a>[<a class="code" href="classstx_1_1CBTreeDB.html#a924efff56b96b6c5a0397211b0cf8685" title="third template parameter: B-tree page size. Usually 1024 or 2048.">BTreePageSize</a> - <a class="code" href="classstx_1_1CBTreeDB.html#af944ce7bcec9897ed7c0e1a3f3c8bebf" title="size of fields before key array in InnerNode">InnerNodeHead</a>];
<a name="l00282"></a>00282         };
<a name="l00283"></a>00283 
<a name="l00285"></a><a class="code" href="structstx_1_1CBTreeDB_1_1InnerNode.html#aae00d607bdeea1204c12f151ffef7c1b">00285</a>         <span class="keyword">inline</span> <span class="keyword">explicit</span> <a class="code" href="structstx_1_1CBTreeDB_1_1InnerNode.html#aae00d607bdeea1204c12f151ffef7c1b" title="Initializes structure with zero.">InnerNode</a>(uint16_t level_)
<a name="l00286"></a>00286             : <a class="code" href="structstx_1_1CBTreeDB_1_1InnerNode.html#a03dfd6173cbf57de4bf30dbe2c1c23bb" title="level of this inner node, always &amp;gt; 0.">level</a>(level_), <a class="code" href="structstx_1_1CBTreeDB_1_1InnerNode.html#a39993c719c0479b1ab32d0b64758ecf0" title="number of used slots in the arrays.">slots</a>(0), <a class="code" href="structstx_1_1CBTreeDB_1_1InnerNode.html#aa8a393e3980026418172cb866576d47e" title="base offset of child B-tree nodes enumerated by keys.">childrenoffset</a>(0)
<a name="l00287"></a>00287         {
<a name="l00288"></a>00288             memset(<a class="code" href="structstx_1_1CBTreeDB_1_1InnerNode.html#ac9cfadfe0f68704e6cc91a8f82bf383c" title="union with filler char array to assure page size.">filler</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="structstx_1_1CBTreeDB_1_1InnerNode.html#ac9cfadfe0f68704e6cc91a8f82bf383c" title="union with filler char array to assure page size.">filler</a>));
<a name="l00289"></a>00289         }
<a name="l00290"></a>00290 
<a name="l00292"></a><a class="code" href="structstx_1_1CBTreeDB_1_1InnerNode.html#a4cb8908d7a882ea35a895f9479d6a9ec">00292</a>         <span class="keyword">inline</span> <span class="keywordtype">bool</span> <a class="code" href="structstx_1_1CBTreeDB_1_1InnerNode.html#a4cb8908d7a882ea35a895f9479d6a9ec" title="Returns true if no more keys can be added.">IsFull</a>()<span class="keyword"> const</span>
<a name="l00293"></a>00293 <span class="keyword">        </span>{
<a name="l00294"></a>00294             <span class="keywordflow">return</span> (<a class="code" href="structstx_1_1CBTreeDB_1_1InnerNode.html#a39993c719c0479b1ab32d0b64758ecf0" title="number of used slots in the arrays.">slots</a> &gt;= <a class="code" href="classstx_1_1CBTreeDB.html#ae95b23de1103556bb96353fda4efe052" title="number of keys in each InnerNode">InnerNodeNumKeys</a>);
<a name="l00295"></a>00295         }
<a name="l00296"></a>00296 
<a name="l00298"></a><a class="code" href="structstx_1_1CBTreeDB_1_1InnerNode.html#abaa4fd865be345c309841c93e68c9646">00298</a>         <span class="keyword">inline</span> <span class="keyword">const</span> <a class="code" href="classstx_1_1CBTreeDB.html#a3853858e7d8cc630c832232bc46ed2c0" title="first template parameter: the key type of the B-tree.">key_type</a>&amp; <a class="code" href="structstx_1_1CBTreeDB_1_1InnerNode.html#abaa4fd865be345c309841c93e68c9646" title="Returns the currently last key in the node.">LastKey</a>()<span class="keyword"> const</span>
<a name="l00299"></a>00299 <span class="keyword">        </span>{
<a name="l00300"></a>00300             <a class="code" href="stx-cbtreedb_8h.html#ab44bd6c500e8dbe3a232e4c44f28b67e" title="Instead of assert() we use this macro to throw exceptions.">CBTREEDB_ASSERT</a>(<a class="code" href="structstx_1_1CBTreeDB_1_1InnerNode.html#a39993c719c0479b1ab32d0b64758ecf0" title="number of used slots in the arrays.">slots</a> &gt; 0 &amp;&amp; <a class="code" href="structstx_1_1CBTreeDB_1_1InnerNode.html#a39993c719c0479b1ab32d0b64758ecf0" title="number of used slots in the arrays.">slots</a> &lt; <a class="code" href="classstx_1_1CBTreeDB.html#ae95b23de1103556bb96353fda4efe052" title="number of keys in each InnerNode">InnerNodeNumKeys</a>+1);
<a name="l00301"></a>00301             <span class="keywordflow">return</span> <a class="code" href="structstx_1_1CBTreeDB_1_1InnerNode.html#ae991d7c99f3ab0820bcd0254ed53fca8" title="key array of ascending keys in this inner node.">keys</a>[<a class="code" href="structstx_1_1CBTreeDB_1_1InnerNode.html#a39993c719c0479b1ab32d0b64758ecf0" title="number of used slots in the arrays.">slots</a>-1];
<a name="l00302"></a>00302         }
<a name="l00303"></a>00303     }
<a name="l00304"></a>00304         __attribute__((<a class="code" href="classstx_1_1CBTreeDB.html#a0a57e296404542a54803e92ef3539de8" title="Signature page which heads all cbtreedb files.">packed</a>));
<a name="l00305"></a>00305 
<a name="l00306"></a>00306     <a class="code" href="classstx_1_1CBTreeDB.html#a651bc40a21e741a77d73163da358c262">STX_STATIC_ASSERT</a>( <span class="keyword">sizeof</span>(InnerNode) == <a class="code" href="classstx_1_1CBTreeDB.html#a924efff56b96b6c5a0397211b0cf8685" title="third template parameter: B-tree page size. Usually 1024 or 2048.">BTreePageSize</a> );
<a name="l00307"></a>00307 
<a name="l00308"></a>00308 <span class="keyword">protected</span>:
<a name="l00314"></a><a class="code" href="classstx_1_1CBTreeDB_1_1CRC32.html">00314</a>     <span class="keyword">class </span><a class="code" href="classstx_1_1CBTreeDB_1_1CRC32.html" title="CRC32 Cyclic redundancy check implementation class.">CRC32</a>
<a name="l00315"></a>00315     {
<a name="l00316"></a>00316     <span class="keyword">private</span>:
<a name="l00318"></a><a class="code" href="classstx_1_1CBTreeDB_1_1CRC32.html#ab3c5afe4ad9a55e7f6d1d5ad051dfaf2">00318</a>         uint32_t        <a class="code" href="classstx_1_1CBTreeDB_1_1CRC32.html#ab3c5afe4ad9a55e7f6d1d5ad051dfaf2" title="CRC intermediate value.">m_crc</a>;
<a name="l00319"></a>00319 
<a name="l00320"></a>00320     <span class="keyword">public</span>:
<a name="l00322"></a><a class="code" href="classstx_1_1CBTreeDB_1_1CRC32.html#ae56b274b8b95f8a2fbd9d085b21b5094">00322</a>         <a class="code" href="classstx_1_1CBTreeDB_1_1CRC32.html#ae56b274b8b95f8a2fbd9d085b21b5094" title="Initialize new CRC object.">CRC32</a>()
<a name="l00323"></a>00323         {
<a name="l00324"></a>00324             <a class="code" href="classstx_1_1CBTreeDB_1_1CRC32.html#aa9e0614474290dd10a88f2e1d3d40339" title="Clear current CRC object.">clear</a>();
<a name="l00325"></a>00325         }
<a name="l00326"></a>00326 
<a name="l00328"></a><a class="code" href="classstx_1_1CBTreeDB_1_1CRC32.html#aa9e0614474290dd10a88f2e1d3d40339">00328</a>         <span class="keywordtype">void</span> <a class="code" href="classstx_1_1CBTreeDB_1_1CRC32.html#aa9e0614474290dd10a88f2e1d3d40339" title="Clear current CRC object.">clear</a>()
<a name="l00329"></a>00329         {
<a name="l00330"></a>00330             <a class="code" href="classstx_1_1CBTreeDB_1_1CRC32.html#ab3c5afe4ad9a55e7f6d1d5ad051dfaf2" title="CRC intermediate value.">m_crc</a> = 0xFFFFFFFF;
<a name="l00331"></a>00331         }
<a name="l00332"></a>00332 
<a name="l00334"></a><a class="code" href="classstx_1_1CBTreeDB_1_1CRC32.html#a26e3fdfc4e8a6670b1c3500a81f2b764">00334</a>         <a class="code" href="classstx_1_1CBTreeDB_1_1CRC32.html" title="CRC32 Cyclic redundancy check implementation class.">CRC32</a>&amp; <a class="code" href="classstx_1_1CBTreeDB_1_1CRC32.html#a26e3fdfc4e8a6670b1c3500a81f2b764" title="Update this CRC value with new data.">update</a>(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* input, uint32_t length)
<a name="l00335"></a>00335         {
<a name="l00336"></a>00336             <span class="keyword">static</span> <span class="keyword">const</span> uint32_t table[256] = {
<a name="l00337"></a>00337                 0x00000000, 0x77073096, 0xEE0E612C, 0x990951BA, 0x076DC419,
<a name="l00338"></a>00338                 0x706AF48F, 0xE963A535, 0x9E6495A3, 0x0EDB8832, 0x79DCB8A4,
<a name="l00339"></a>00339                 0xE0D5E91E, 0x97D2D988, 0x09B64C2B, 0x7EB17CBD, 0xE7B82D07,
<a name="l00340"></a>00340                 0x90BF1D91, 0x1DB71064, 0x6AB020F2, 0xF3B97148, 0x84BE41DE,
<a name="l00341"></a>00341                 0x1ADAD47D, 0x6DDDE4EB, 0xF4D4B551, 0x83D385C7, 0x136C9856,
<a name="l00342"></a>00342                 0x646BA8C0, 0xFD62F97A, 0x8A65C9EC, 0x14015C4F, 0x63066CD9,
<a name="l00343"></a>00343                 0xFA0F3D63, 0x8D080DF5, 0x3B6E20C8, 0x4C69105E, 0xD56041E4,
<a name="l00344"></a>00344                 0xA2677172, 0x3C03E4D1, 0x4B04D447, 0xD20D85FD, 0xA50AB56B,
<a name="l00345"></a>00345                 0x35B5A8FA, 0x42B2986C, 0xDBBBC9D6, 0xACBCF940, 0x32D86CE3,
<a name="l00346"></a>00346                 0x45DF5C75, 0xDCD60DCF, 0xABD13D59, 0x26D930AC, 0x51DE003A,
<a name="l00347"></a>00347                 0xC8D75180, 0xBFD06116, 0x21B4F4B5, 0x56B3C423, 0xCFBA9599,
<a name="l00348"></a>00348                 0xB8BDA50F, 0x2802B89E, 0x5F058808, 0xC60CD9B2, 0xB10BE924,
<a name="l00349"></a>00349                 0x2F6F7C87, 0x58684C11, 0xC1611DAB, 0xB6662D3D, 0x76DC4190,
<a name="l00350"></a>00350                 0x01DB7106, 0x98D220BC, 0xEFD5102A, 0x71B18589, 0x06B6B51F,
<a name="l00351"></a>00351                 0x9FBFE4A5, 0xE8B8D433, 0x7807C9A2, 0x0F00F934, 0x9609A88E,
<a name="l00352"></a>00352                 0xE10E9818, 0x7F6A0DBB, 0x086D3D2D, 0x91646C97, 0xE6635C01,
<a name="l00353"></a>00353                 0x6B6B51F4, 0x1C6C6162, 0x856530D8, 0xF262004E, 0x6C0695ED,
<a name="l00354"></a>00354                 0x1B01A57B, 0x8208F4C1, 0xF50FC457, 0x65B0D9C6, 0x12B7E950,
<a name="l00355"></a>00355                 0x8BBEB8EA, 0xFCB9887C, 0x62DD1DDF, 0x15DA2D49, 0x8CD37CF3,
<a name="l00356"></a>00356                 0xFBD44C65, 0x4DB26158, 0x3AB551CE, 0xA3BC0074, 0xD4BB30E2,
<a name="l00357"></a>00357                 0x4ADFA541, 0x3DD895D7, 0xA4D1C46D, 0xD3D6F4FB, 0x4369E96A,
<a name="l00358"></a>00358                 0x346ED9FC, 0xAD678846, 0xDA60B8D0, 0x44042D73, 0x33031DE5,
<a name="l00359"></a>00359                 0xAA0A4C5F, 0xDD0D7CC9, 0x5005713C, 0x270241AA, 0xBE0B1010,
<a name="l00360"></a>00360                 0xC90C2086, 0x5768B525, 0x206F85B3, 0xB966D409, 0xCE61E49F,
<a name="l00361"></a>00361                 0x5EDEF90E, 0x29D9C998, 0xB0D09822, 0xC7D7A8B4, 0x59B33D17,
<a name="l00362"></a>00362                 0x2EB40D81, 0xB7BD5C3B, 0xC0BA6CAD, 0xEDB88320, 0x9ABFB3B6,
<a name="l00363"></a>00363                 0x03B6E20C, 0x74B1D29A, 0xEAD54739, 0x9DD277AF, 0x04DB2615,
<a name="l00364"></a>00364                 0x73DC1683, 0xE3630B12, 0x94643B84, 0x0D6D6A3E, 0x7A6A5AA8,
<a name="l00365"></a>00365                 0xE40ECF0B, 0x9309FF9D, 0x0A00AE27, 0x7D079EB1, 0xF00F9344,
<a name="l00366"></a>00366                 0x8708A3D2, 0x1E01F268, 0x6906C2FE, 0xF762575D, 0x806567CB,
<a name="l00367"></a>00367                 0x196C3671, 0x6E6B06E7, 0xFED41B76, 0x89D32BE0, 0x10DA7A5A,
<a name="l00368"></a>00368                 0x67DD4ACC, 0xF9B9DF6F, 0x8EBEEFF9, 0x17B7BE43, 0x60B08ED5,
<a name="l00369"></a>00369                 0xD6D6A3E8, 0xA1D1937E, 0x38D8C2C4, 0x4FDFF252, 0xD1BB67F1,
<a name="l00370"></a>00370                 0xA6BC5767, 0x3FB506DD, 0x48B2364B, 0xD80D2BDA, 0xAF0A1B4C,
<a name="l00371"></a>00371                 0x36034AF6, 0x41047A60, 0xDF60EFC3, 0xA867DF55, 0x316E8EEF,
<a name="l00372"></a>00372                 0x4669BE79, 0xCB61B38C, 0xBC66831A, 0x256FD2A0, 0x5268E236,
<a name="l00373"></a>00373                 0xCC0C7795, 0xBB0B4703, 0x220216B9, 0x5505262F, 0xC5BA3BBE,
<a name="l00374"></a>00374                 0xB2BD0B28, 0x2BB45A92, 0x5CB36A04, 0xC2D7FFA7, 0xB5D0CF31,
<a name="l00375"></a>00375                 0x2CD99E8B, 0x5BDEAE1D, 0x9B64C2B0, 0xEC63F226, 0x756AA39C,
<a name="l00376"></a>00376                 0x026D930A, 0x9C0906A9, 0xEB0E363F, 0x72076785, 0x05005713,
<a name="l00377"></a>00377                 0x95BF4A82, 0xE2B87A14, 0x7BB12BAE, 0x0CB61B38, 0x92D28E9B,
<a name="l00378"></a>00378                 0xE5D5BE0D, 0x7CDCEFB7, 0x0BDBDF21, 0x86D3D2D4, 0xF1D4E242,
<a name="l00379"></a>00379                 0x68DDB3F8, 0x1FDA836E, 0x81BE16CD, 0xF6B9265B, 0x6FB077E1,
<a name="l00380"></a>00380                 0x18B74777, 0x88085AE6, 0xFF0F6A70, 0x66063BCA, 0x11010B5C,
<a name="l00381"></a>00381                 0x8F659EFF, 0xF862AE69, 0x616BFFD3, 0x166CCF45, 0xA00AE278,
<a name="l00382"></a>00382                 0xD70DD2EE, 0x4E048354, 0x3903B3C2, 0xA7672661, 0xD06016F7,
<a name="l00383"></a>00383                 0x4969474D, 0x3E6E77DB, 0xAED16A4A, 0xD9D65ADC, 0x40DF0B66,
<a name="l00384"></a>00384                 0x37D83BF0, 0xA9BCAE53, 0xDEBB9EC5, 0x47B2CF7F, 0x30B5FFE9,
<a name="l00385"></a>00385                 0xBDBDF21C, 0xCABAC28A, 0x53B39330, 0x24B4A3A6, 0xBAD03605,
<a name="l00386"></a>00386                 0xCDD70693, 0x54DE5729, 0x23D967BF, 0xB3667A2E, 0xC4614AB8,
<a name="l00387"></a>00387                 0x5D681B02, 0x2A6F2B94, 0xB40BBE37, 0xC30C8EA1, 0x5A05DF1B,
<a name="l00388"></a>00388                 0x2D02EF8D };
<a name="l00389"></a>00389 
<a name="l00390"></a>00390             <span class="keyword">register</span> uint32_t tmp = <a class="code" href="classstx_1_1CBTreeDB_1_1CRC32.html#ab3c5afe4ad9a55e7f6d1d5ad051dfaf2" title="CRC intermediate value.">m_crc</a>;
<a name="l00391"></a>00391 
<a name="l00392"></a>00392             <span class="keywordflow">while</span>(length &gt;= 16)
<a name="l00393"></a>00393             {
<a name="l00394"></a>00394                 tmp = table[(tmp ^ input[ 0]) &amp; 0xFF] ^ (tmp &gt;&gt; 8);
<a name="l00395"></a>00395                 tmp = table[(tmp ^ input[ 1]) &amp; 0xFF] ^ (tmp &gt;&gt; 8);
<a name="l00396"></a>00396                 tmp = table[(tmp ^ input[ 2]) &amp; 0xFF] ^ (tmp &gt;&gt; 8);
<a name="l00397"></a>00397                 tmp = table[(tmp ^ input[ 3]) &amp; 0xFF] ^ (tmp &gt;&gt; 8);
<a name="l00398"></a>00398                 tmp = table[(tmp ^ input[ 4]) &amp; 0xFF] ^ (tmp &gt;&gt; 8);
<a name="l00399"></a>00399                 tmp = table[(tmp ^ input[ 5]) &amp; 0xFF] ^ (tmp &gt;&gt; 8);
<a name="l00400"></a>00400                 tmp = table[(tmp ^ input[ 6]) &amp; 0xFF] ^ (tmp &gt;&gt; 8);
<a name="l00401"></a>00401                 tmp = table[(tmp ^ input[ 7]) &amp; 0xFF] ^ (tmp &gt;&gt; 8);
<a name="l00402"></a>00402                 tmp = table[(tmp ^ input[ 8]) &amp; 0xFF] ^ (tmp &gt;&gt; 8);
<a name="l00403"></a>00403                 tmp = table[(tmp ^ input[ 9]) &amp; 0xFF] ^ (tmp &gt;&gt; 8);
<a name="l00404"></a>00404                 tmp = table[(tmp ^ input[10]) &amp; 0xFF] ^ (tmp &gt;&gt; 8);
<a name="l00405"></a>00405                 tmp = table[(tmp ^ input[11]) &amp; 0xFF] ^ (tmp &gt;&gt; 8);
<a name="l00406"></a>00406                 tmp = table[(tmp ^ input[12]) &amp; 0xFF] ^ (tmp &gt;&gt; 8);
<a name="l00407"></a>00407                 tmp = table[(tmp ^ input[13]) &amp; 0xFF] ^ (tmp &gt;&gt; 8);
<a name="l00408"></a>00408                 tmp = table[(tmp ^ input[14]) &amp; 0xFF] ^ (tmp &gt;&gt; 8);
<a name="l00409"></a>00409                 tmp = table[(tmp ^ input[15]) &amp; 0xFF] ^ (tmp &gt;&gt; 8);
<a name="l00410"></a>00410                 input += 16;
<a name="l00411"></a>00411                 length -= 16;
<a name="l00412"></a>00412             }
<a name="l00413"></a>00413 
<a name="l00414"></a>00414             <span class="keywordflow">for</span>(uint32_t j = 0; j != length; ++j)
<a name="l00415"></a>00415                 tmp = table[(tmp ^ input[j]) &amp; 0xFF] ^ (tmp &gt;&gt; 8);
<a name="l00416"></a>00416 
<a name="l00417"></a>00417             <a class="code" href="classstx_1_1CBTreeDB_1_1CRC32.html#ab3c5afe4ad9a55e7f6d1d5ad051dfaf2" title="CRC intermediate value.">m_crc</a> = tmp;
<a name="l00418"></a>00418 
<a name="l00419"></a>00419             <span class="keywordflow">return</span> *<span class="keyword">this</span>;
<a name="l00420"></a>00420         }
<a name="l00421"></a>00421 
<a name="l00423"></a><a class="code" href="classstx_1_1CBTreeDB_1_1CRC32.html#a6767173117e77be19ea94e821ac9cda0">00423</a>         <a class="code" href="classstx_1_1CBTreeDB_1_1CRC32.html" title="CRC32 Cyclic redundancy check implementation class.">CRC32</a>&amp; <a class="code" href="classstx_1_1CBTreeDB_1_1CRC32.html#a26e3fdfc4e8a6670b1c3500a81f2b764" title="Update this CRC value with new data.">update</a>(<span class="keyword">const</span> <span class="keywordtype">void</span>* input, uint32_t length)
<a name="l00424"></a>00424         {
<a name="l00425"></a>00425             <span class="keywordflow">return</span> <a class="code" href="classstx_1_1CBTreeDB_1_1CRC32.html#a26e3fdfc4e8a6670b1c3500a81f2b764" title="Update this CRC value with new data.">update</a>(reinterpret_cast&lt;const unsigned char*&gt;(input), length);
<a name="l00426"></a>00426         }
<a name="l00427"></a>00427 
<a name="l00429"></a><a class="code" href="classstx_1_1CBTreeDB_1_1CRC32.html#a3bc24769bcdabb3df85d77969e6b68ac">00429</a>         uint32_t <span class="keyword">final</span>() <span class="keyword">const</span>
<a name="l00430"></a>00430         {
<a name="l00431"></a>00431             <span class="keywordflow">return</span> (<a class="code" href="classstx_1_1CBTreeDB_1_1CRC32.html#ab3c5afe4ad9a55e7f6d1d5ad051dfaf2" title="CRC intermediate value.">m_crc</a> ^ 0xFFFFFFFF);
<a name="l00432"></a>00432         }
<a name="l00433"></a>00433 
<a name="l00435"></a><a class="code" href="classstx_1_1CBTreeDB_1_1CRC32.html#a9eb10033fa35e3a5db820e5e37111b27">00435</a>         <span class="keyword">static</span> uint32_t <a class="code" href="classstx_1_1CBTreeDB_1_1CRC32.html#a9eb10033fa35e3a5db820e5e37111b27" title="Calculate CRC32 digest of bytes in the given range.">digest</a>(<span class="keyword">const</span> <span class="keywordtype">void</span>* input, uint32_t length)
<a name="l00436"></a>00436         {
<a name="l00437"></a>00437             <span class="keywordflow">return</span> <a class="code" href="classstx_1_1CBTreeDB_1_1CRC32.html#ae56b274b8b95f8a2fbd9d085b21b5094" title="Initialize new CRC object.">CRC32</a>().update(input, length).final();
<a name="l00438"></a>00438         }
<a name="l00439"></a>00439 
<a name="l00441"></a><a class="code" href="classstx_1_1CBTreeDB_1_1CRC32.html#ab5215559a497efb3d93b169c2cc12d41">00441</a>         <span class="keyword">static</span> uint32_t <a class="code" href="classstx_1_1CBTreeDB_1_1CRC32.html#a9eb10033fa35e3a5db820e5e37111b27" title="Calculate CRC32 digest of bytes in the given range.">digest</a>(<span class="keyword">const</span> std::string&amp; input)
<a name="l00442"></a>00442         {
<a name="l00443"></a>00443             <span class="keywordflow">return</span> <a class="code" href="classstx_1_1CBTreeDB_1_1CRC32.html#a9eb10033fa35e3a5db820e5e37111b27" title="Calculate CRC32 digest of bytes in the given range.">digest</a>(input.data(), input.size());
<a name="l00444"></a>00444         }
<a name="l00445"></a>00445     };
<a name="l00446"></a>00446 
<a name="l00447"></a>00447 <span class="keyword">protected</span>:
<a name="l00453"></a><a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html">00453</a>     <span class="keyword">class </span><a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html" title="SHA-256 Message Digest implementation class.">SHA256</a>
<a name="l00454"></a>00454     {
<a name="l00455"></a>00455     <span class="keyword">private</span>:
<a name="l00457"></a><a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a1bc4967fe1c5d91f0377567bccf83949">00457</a>         <span class="keyword">typedef</span> uint8_t <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a1bc4967fe1c5d91f0377567bccf83949" title="local typedef from Botan library">byte</a>;
<a name="l00458"></a>00458 
<a name="l00460"></a><a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a3f10e041c073cb2f56c8ca3fcf4532eb">00460</a>         <span class="keyword">typedef</span> uint32_t <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a3f10e041c073cb2f56c8ca3fcf4532eb" title="local typedef from Botan library">u32bit</a>;
<a name="l00461"></a>00461 
<a name="l00463"></a><a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a5c1a7ba5d9cdd8cb223945b443df90eb">00463</a>         <span class="keyword">typedef</span> uint64_t <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a5c1a7ba5d9cdd8cb223945b443df90eb" title="local typedef from Botan library">u64bit</a>;
<a name="l00464"></a>00464 
<a name="l00466"></a><a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#afdba7f212f9eb3bc478d6f63e33570e0">00466</a>         <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a3f10e041c073cb2f56c8ca3fcf4532eb" title="local typedef from Botan library">u32bit</a> <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#afdba7f212f9eb3bc478d6f63e33570e0" title="length of the resulting digest">OUTPUT_LENGTH</a> = 32;
<a name="l00467"></a>00467 
<a name="l00469"></a><a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a4f2819a15fbb30e09ce797bf7706de8e">00469</a>         <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a3f10e041c073cb2f56c8ca3fcf4532eb" title="local typedef from Botan library">u32bit</a> <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a4f2819a15fbb30e09ce797bf7706de8e" title="block of bytes to process in hash function">HASH_BLOCK_SIZE</a> = 64;
<a name="l00470"></a>00470 
<a name="l00472"></a><a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a9b33fe0ec3ed40965e2df74fad2f8e1e">00472</a>         <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a3f10e041c073cb2f56c8ca3fcf4532eb" title="local typedef from Botan library">u32bit</a> <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a9b33fe0ec3ed40965e2df74fad2f8e1e" title="length of size suffix hashed during finalization">COUNT_SIZE</a> = 8;
<a name="l00473"></a>00473 
<a name="l00474"></a>00474     <span class="keyword">private</span>:
<a name="l00475"></a><a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#afd515411f08f7ed035bef1161909ed40">00475</a>         <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a3f10e041c073cb2f56c8ca3fcf4532eb" title="local typedef from Botan library">u32bit</a>          <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#afd515411f08f7ed035bef1161909ed40">W</a>[64];
<a name="l00476"></a><a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a17db6bd918e637441419766a6f434fd0">00476</a>         <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a3f10e041c073cb2f56c8ca3fcf4532eb" title="local typedef from Botan library">u32bit</a>          <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a17db6bd918e637441419766a6f434fd0">digest</a>[8];
<a name="l00477"></a>00477 
<a name="l00478"></a><a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a66d62aaaab77f19f052d2536715c6741">00478</a>         <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a1bc4967fe1c5d91f0377567bccf83949" title="local typedef from Botan library">byte</a>            <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a66d62aaaab77f19f052d2536715c6741">buffer</a>[<a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a4f2819a15fbb30e09ce797bf7706de8e" title="block of bytes to process in hash function">HASH_BLOCK_SIZE</a>];
<a name="l00479"></a>00479 
<a name="l00480"></a><a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a0291988699cc20a186275d87ba5804af">00480</a>         <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a5c1a7ba5d9cdd8cb223945b443df90eb" title="local typedef from Botan library">u64bit</a>          <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a0291988699cc20a186275d87ba5804af">count</a>;
<a name="l00481"></a><a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#aac541a215ed5d94d5d8ea06ffe2f3e35">00481</a>         <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a3f10e041c073cb2f56c8ca3fcf4532eb" title="local typedef from Botan library">u32bit</a>          <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#aac541a215ed5d94d5d8ea06ffe2f3e35">position</a>;
<a name="l00482"></a>00482 
<a name="l00483"></a>00483     <span class="keyword">private</span>:
<a name="l00485"></a><a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a30f663f47f43db16d6ba99f11d96d511">00485</a>         <span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt; <span class="keyword">inline</span> T <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a30f663f47f43db16d6ba99f11d96d511" title="Rotation Functions.">rotate_left</a>(T input, <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a3f10e041c073cb2f56c8ca3fcf4532eb" title="local typedef from Botan library">u32bit</a> rot)
<a name="l00486"></a>00486         { <span class="keywordflow">return</span> <span class="keyword">static_cast&lt;</span>T<span class="keyword">&gt;</span>((input &lt;&lt; rot) | (input &gt;&gt; (8*<span class="keyword">sizeof</span>(T)-rot))); }
<a name="l00487"></a>00487 
<a name="l00489"></a><a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a5ffca5bf584f0bbdff490e8ca7c95304">00489</a>         <span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt; <span class="keyword">inline</span> T <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a5ffca5bf584f0bbdff490e8ca7c95304" title="Rotation Functions.">rotate_right</a>(T input, <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a3f10e041c073cb2f56c8ca3fcf4532eb" title="local typedef from Botan library">u32bit</a> rot)
<a name="l00490"></a>00490         { <span class="keywordflow">return</span> <span class="keyword">static_cast&lt;</span>T<span class="keyword">&gt;</span>((input &gt;&gt; rot) | (input &lt;&lt; (8*<span class="keyword">sizeof</span>(T)-rot))); }
<a name="l00491"></a>00491 
<a name="l00493"></a><a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#afa931e91496af8c1ebf16950d4f41a11">00493</a>         <span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt; <span class="keyword">inline</span> <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a1bc4967fe1c5d91f0377567bccf83949" title="local typedef from Botan library">byte</a> <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#afa931e91496af8c1ebf16950d4f41a11" title="Byte Extraction Function.">get_byte</a>(<a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a3f10e041c073cb2f56c8ca3fcf4532eb" title="local typedef from Botan library">u32bit</a> byte_num, T input)
<a name="l00494"></a>00494         { <span class="keywordflow">return</span> <span class="keyword">static_cast&lt;</span><a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a1bc4967fe1c5d91f0377567bccf83949" title="local typedef from Botan library">byte</a><span class="keyword">&gt;</span>(input &gt;&gt; ((<span class="keyword">sizeof</span>(T)-1-(byte_num&amp;(<span class="keyword">sizeof</span>(T)-1))) &lt;&lt; 3)); }
<a name="l00495"></a>00495 
<a name="l00497"></a><a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a5f800619d8c876e463e6d30610f58505">00497</a>         <span class="keyword">inline</span> <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a3f10e041c073cb2f56c8ca3fcf4532eb" title="local typedef from Botan library">u32bit</a> <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a5f800619d8c876e463e6d30610f58505" title="Byte to Word Conversions.">make_u32bit</a>(<a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a1bc4967fe1c5d91f0377567bccf83949" title="local typedef from Botan library">byte</a> input0, <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a1bc4967fe1c5d91f0377567bccf83949" title="local typedef from Botan library">byte</a> input1, <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a1bc4967fe1c5d91f0377567bccf83949" title="local typedef from Botan library">byte</a> input2, <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a1bc4967fe1c5d91f0377567bccf83949" title="local typedef from Botan library">byte</a> input3)
<a name="l00498"></a>00498         { <span class="keywordflow">return</span> <span class="keyword">static_cast&lt;</span><a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a3f10e041c073cb2f56c8ca3fcf4532eb" title="local typedef from Botan library">u32bit</a><span class="keyword">&gt;</span>((<span class="keyword">static_cast&lt;</span><a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a3f10e041c073cb2f56c8ca3fcf4532eb" title="local typedef from Botan library">u32bit</a><span class="keyword">&gt;</span>(input0) &lt;&lt; 24) |
<a name="l00499"></a>00499                                      (<span class="keyword">static_cast&lt;</span><a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a3f10e041c073cb2f56c8ca3fcf4532eb" title="local typedef from Botan library">u32bit</a><span class="keyword">&gt;</span>(input1) &lt;&lt; 16) |
<a name="l00500"></a>00500                                      (<span class="keyword">static_cast&lt;</span><a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a3f10e041c073cb2f56c8ca3fcf4532eb" title="local typedef from Botan library">u32bit</a><span class="keyword">&gt;</span>(input2) &lt;&lt;  8) | input3); }
<a name="l00501"></a>00501 
<a name="l00503"></a><a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a4e4c480b74e2c5d6d75626e7f5b54c8e">00503</a>         <span class="keyword">inline</span> <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a3f10e041c073cb2f56c8ca3fcf4532eb" title="local typedef from Botan library">u32bit</a> <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a4e4c480b74e2c5d6d75626e7f5b54c8e" title="SHA-256 Rho Function.">rho</a>(<a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a3f10e041c073cb2f56c8ca3fcf4532eb" title="local typedef from Botan library">u32bit</a> X, <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a3f10e041c073cb2f56c8ca3fcf4532eb" title="local typedef from Botan library">u32bit</a> rot1, <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a3f10e041c073cb2f56c8ca3fcf4532eb" title="local typedef from Botan library">u32bit</a> rot2, <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a3f10e041c073cb2f56c8ca3fcf4532eb" title="local typedef from Botan library">u32bit</a> rot3)
<a name="l00504"></a>00504         {
<a name="l00505"></a>00505             <span class="keywordflow">return</span> (<a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a5ffca5bf584f0bbdff490e8ca7c95304" title="Rotation Functions.">rotate_right</a>(X, rot1) ^ <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a5ffca5bf584f0bbdff490e8ca7c95304" title="Rotation Functions.">rotate_right</a>(X, rot2) ^
<a name="l00506"></a>00506                     <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a5ffca5bf584f0bbdff490e8ca7c95304" title="Rotation Functions.">rotate_right</a>(X, rot3));
<a name="l00507"></a>00507         }
<a name="l00508"></a>00508 
<a name="l00510"></a><a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a799f86f13747021df60932bbc432da92">00510</a>         <span class="keyword">inline</span> <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a3f10e041c073cb2f56c8ca3fcf4532eb" title="local typedef from Botan library">u32bit</a> <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a799f86f13747021df60932bbc432da92" title="SHA-256 Sigma Function.">sigma</a>(<a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a3f10e041c073cb2f56c8ca3fcf4532eb" title="local typedef from Botan library">u32bit</a> X, <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a3f10e041c073cb2f56c8ca3fcf4532eb" title="local typedef from Botan library">u32bit</a> rot1, <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a3f10e041c073cb2f56c8ca3fcf4532eb" title="local typedef from Botan library">u32bit</a> rot2, <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a3f10e041c073cb2f56c8ca3fcf4532eb" title="local typedef from Botan library">u32bit</a> shift)
<a name="l00511"></a>00511         {
<a name="l00512"></a>00512             <span class="keywordflow">return</span> (<a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a5ffca5bf584f0bbdff490e8ca7c95304" title="Rotation Functions.">rotate_right</a>(X, rot1) ^ <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a5ffca5bf584f0bbdff490e8ca7c95304" title="Rotation Functions.">rotate_right</a>(X, rot2) ^ (X &gt;&gt; shift));
<a name="l00513"></a>00513         }
<a name="l00514"></a>00514 
<a name="l00516"></a><a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a54dd456b8908bb6724cc7f312b38d9e2">00516</a>         <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a54dd456b8908bb6724cc7f312b38d9e2" title="SHA-256 F1 Function.">F1</a>(<a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a3f10e041c073cb2f56c8ca3fcf4532eb" title="local typedef from Botan library">u32bit</a> A, <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a3f10e041c073cb2f56c8ca3fcf4532eb" title="local typedef from Botan library">u32bit</a> B, <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a3f10e041c073cb2f56c8ca3fcf4532eb" title="local typedef from Botan library">u32bit</a> C, <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a3f10e041c073cb2f56c8ca3fcf4532eb" title="local typedef from Botan library">u32bit</a>&amp; D,
<a name="l00517"></a>00517                        <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a3f10e041c073cb2f56c8ca3fcf4532eb" title="local typedef from Botan library">u32bit</a> E, <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a3f10e041c073cb2f56c8ca3fcf4532eb" title="local typedef from Botan library">u32bit</a> F, <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a3f10e041c073cb2f56c8ca3fcf4532eb" title="local typedef from Botan library">u32bit</a> G, <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a3f10e041c073cb2f56c8ca3fcf4532eb" title="local typedef from Botan library">u32bit</a>&amp; H,
<a name="l00518"></a>00518                        <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a3f10e041c073cb2f56c8ca3fcf4532eb" title="local typedef from Botan library">u32bit</a> msg, <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a3f10e041c073cb2f56c8ca3fcf4532eb" title="local typedef from Botan library">u32bit</a> magic)
<a name="l00519"></a>00519         {
<a name="l00520"></a>00520             magic += <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a4e4c480b74e2c5d6d75626e7f5b54c8e" title="SHA-256 Rho Function.">rho</a>(E, 6, 11, 25) + ((E &amp; F) ^ (~E &amp; G)) + msg;
<a name="l00521"></a>00521             D += magic + H;
<a name="l00522"></a>00522             H += magic + <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a4e4c480b74e2c5d6d75626e7f5b54c8e" title="SHA-256 Rho Function.">rho</a>(A, 2, 13, 22) + ((A &amp; B) ^ (A &amp; C) ^ (B &amp; C));
<a name="l00523"></a>00523         }
<a name="l00524"></a>00524 
<a name="l00526"></a><a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#adedf2be3225d2518364b217c746f90b3">00526</a>         <span class="keywordtype">void</span> <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#adedf2be3225d2518364b217c746f90b3" title="SHA-256 Compression Function.">hash</a>(<span class="keyword">const</span> <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a1bc4967fe1c5d91f0377567bccf83949" title="local typedef from Botan library">byte</a> input[])
<a name="l00527"></a>00527         {
<a name="l00528"></a>00528             <span class="keywordflow">for</span>(<a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a3f10e041c073cb2f56c8ca3fcf4532eb" title="local typedef from Botan library">u32bit</a> j = 0; j != 16; ++j)
<a name="l00529"></a>00529                 <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#afd515411f08f7ed035bef1161909ed40">W</a>[j] = <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a5f800619d8c876e463e6d30610f58505" title="Byte to Word Conversions.">make_u32bit</a>(input[4*j], input[4*j+1], input[4*j+2], input[4*j+3]);
<a name="l00530"></a>00530             <span class="keywordflow">for</span>(<a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a3f10e041c073cb2f56c8ca3fcf4532eb" title="local typedef from Botan library">u32bit</a> j = 16; j != 64; ++j)
<a name="l00531"></a>00531                 <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#afd515411f08f7ed035bef1161909ed40">W</a>[j] = <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a799f86f13747021df60932bbc432da92" title="SHA-256 Sigma Function.">sigma</a>(<a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#afd515411f08f7ed035bef1161909ed40">W</a>[j- 2], 17, 19, 10) + <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#afd515411f08f7ed035bef1161909ed40">W</a>[j- 7] +
<a name="l00532"></a>00532                     <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a799f86f13747021df60932bbc432da92" title="SHA-256 Sigma Function.">sigma</a>(<a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#afd515411f08f7ed035bef1161909ed40">W</a>[j-15],  7, 18,  3) + <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#afd515411f08f7ed035bef1161909ed40">W</a>[j-16];
<a name="l00533"></a>00533 
<a name="l00534"></a>00534             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a3f10e041c073cb2f56c8ca3fcf4532eb" title="local typedef from Botan library">u32bit</a> A = <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a17db6bd918e637441419766a6f434fd0">digest</a>[0], B = <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a17db6bd918e637441419766a6f434fd0">digest</a>[1], C = <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a17db6bd918e637441419766a6f434fd0">digest</a>[2],
<a name="l00535"></a>00535                 D = <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a17db6bd918e637441419766a6f434fd0">digest</a>[3], E = <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a17db6bd918e637441419766a6f434fd0">digest</a>[4], F = <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a17db6bd918e637441419766a6f434fd0">digest</a>[5],
<a name="l00536"></a>00536                 G = <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a17db6bd918e637441419766a6f434fd0">digest</a>[6], H = <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a17db6bd918e637441419766a6f434fd0">digest</a>[7];
<a name="l00537"></a>00537 
<a name="l00538"></a>00538             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a54dd456b8908bb6724cc7f312b38d9e2" title="SHA-256 F1 Function.">F1</a>(A,B,C,D,E,F,G,H,W[ 0],0x428A2F98);
<a name="l00539"></a>00539             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a54dd456b8908bb6724cc7f312b38d9e2" title="SHA-256 F1 Function.">F1</a>(H,A,B,C,D,E,F,G,W[ 1],0x71374491);
<a name="l00540"></a>00540             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a54dd456b8908bb6724cc7f312b38d9e2" title="SHA-256 F1 Function.">F1</a>(G,H,A,B,C,D,E,F,W[ 2],0xB5C0FBCF);
<a name="l00541"></a>00541             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a54dd456b8908bb6724cc7f312b38d9e2" title="SHA-256 F1 Function.">F1</a>(F,G,H,A,B,C,D,E,W[ 3],0xE9B5DBA5);
<a name="l00542"></a>00542             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a54dd456b8908bb6724cc7f312b38d9e2" title="SHA-256 F1 Function.">F1</a>(E,F,G,H,A,B,C,D,W[ 4],0x3956C25B);
<a name="l00543"></a>00543             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a54dd456b8908bb6724cc7f312b38d9e2" title="SHA-256 F1 Function.">F1</a>(D,E,F,G,H,A,B,C,W[ 5],0x59F111F1);
<a name="l00544"></a>00544             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a54dd456b8908bb6724cc7f312b38d9e2" title="SHA-256 F1 Function.">F1</a>(C,D,E,F,G,H,A,B,W[ 6],0x923F82A4);
<a name="l00545"></a>00545             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a54dd456b8908bb6724cc7f312b38d9e2" title="SHA-256 F1 Function.">F1</a>(B,C,D,E,F,G,H,A,W[ 7],0xAB1C5ED5);
<a name="l00546"></a>00546             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a54dd456b8908bb6724cc7f312b38d9e2" title="SHA-256 F1 Function.">F1</a>(A,B,C,D,E,F,G,H,W[ 8],0xD807AA98);
<a name="l00547"></a>00547             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a54dd456b8908bb6724cc7f312b38d9e2" title="SHA-256 F1 Function.">F1</a>(H,A,B,C,D,E,F,G,W[ 9],0x12835B01);
<a name="l00548"></a>00548             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a54dd456b8908bb6724cc7f312b38d9e2" title="SHA-256 F1 Function.">F1</a>(G,H,A,B,C,D,E,F,W[10],0x243185BE);
<a name="l00549"></a>00549             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a54dd456b8908bb6724cc7f312b38d9e2" title="SHA-256 F1 Function.">F1</a>(F,G,H,A,B,C,D,E,W[11],0x550C7DC3);
<a name="l00550"></a>00550             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a54dd456b8908bb6724cc7f312b38d9e2" title="SHA-256 F1 Function.">F1</a>(E,F,G,H,A,B,C,D,W[12],0x72BE5D74);
<a name="l00551"></a>00551             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a54dd456b8908bb6724cc7f312b38d9e2" title="SHA-256 F1 Function.">F1</a>(D,E,F,G,H,A,B,C,W[13],0x80DEB1FE);
<a name="l00552"></a>00552             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a54dd456b8908bb6724cc7f312b38d9e2" title="SHA-256 F1 Function.">F1</a>(C,D,E,F,G,H,A,B,W[14],0x9BDC06A7);
<a name="l00553"></a>00553             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a54dd456b8908bb6724cc7f312b38d9e2" title="SHA-256 F1 Function.">F1</a>(B,C,D,E,F,G,H,A,W[15],0xC19BF174);
<a name="l00554"></a>00554             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a54dd456b8908bb6724cc7f312b38d9e2" title="SHA-256 F1 Function.">F1</a>(A,B,C,D,E,F,G,H,W[16],0xE49B69C1);
<a name="l00555"></a>00555             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a54dd456b8908bb6724cc7f312b38d9e2" title="SHA-256 F1 Function.">F1</a>(H,A,B,C,D,E,F,G,W[17],0xEFBE4786);
<a name="l00556"></a>00556             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a54dd456b8908bb6724cc7f312b38d9e2" title="SHA-256 F1 Function.">F1</a>(G,H,A,B,C,D,E,F,W[18],0x0FC19DC6);
<a name="l00557"></a>00557             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a54dd456b8908bb6724cc7f312b38d9e2" title="SHA-256 F1 Function.">F1</a>(F,G,H,A,B,C,D,E,W[19],0x240CA1CC);
<a name="l00558"></a>00558             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a54dd456b8908bb6724cc7f312b38d9e2" title="SHA-256 F1 Function.">F1</a>(E,F,G,H,A,B,C,D,W[20],0x2DE92C6F);
<a name="l00559"></a>00559             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a54dd456b8908bb6724cc7f312b38d9e2" title="SHA-256 F1 Function.">F1</a>(D,E,F,G,H,A,B,C,W[21],0x4A7484AA);
<a name="l00560"></a>00560             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a54dd456b8908bb6724cc7f312b38d9e2" title="SHA-256 F1 Function.">F1</a>(C,D,E,F,G,H,A,B,W[22],0x5CB0A9DC);
<a name="l00561"></a>00561             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a54dd456b8908bb6724cc7f312b38d9e2" title="SHA-256 F1 Function.">F1</a>(B,C,D,E,F,G,H,A,W[23],0x76F988DA);
<a name="l00562"></a>00562             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a54dd456b8908bb6724cc7f312b38d9e2" title="SHA-256 F1 Function.">F1</a>(A,B,C,D,E,F,G,H,W[24],0x983E5152);
<a name="l00563"></a>00563             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a54dd456b8908bb6724cc7f312b38d9e2" title="SHA-256 F1 Function.">F1</a>(H,A,B,C,D,E,F,G,W[25],0xA831C66D);
<a name="l00564"></a>00564             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a54dd456b8908bb6724cc7f312b38d9e2" title="SHA-256 F1 Function.">F1</a>(G,H,A,B,C,D,E,F,W[26],0xB00327C8);
<a name="l00565"></a>00565             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a54dd456b8908bb6724cc7f312b38d9e2" title="SHA-256 F1 Function.">F1</a>(F,G,H,A,B,C,D,E,W[27],0xBF597FC7);
<a name="l00566"></a>00566             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a54dd456b8908bb6724cc7f312b38d9e2" title="SHA-256 F1 Function.">F1</a>(E,F,G,H,A,B,C,D,W[28],0xC6E00BF3);
<a name="l00567"></a>00567             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a54dd456b8908bb6724cc7f312b38d9e2" title="SHA-256 F1 Function.">F1</a>(D,E,F,G,H,A,B,C,W[29],0xD5A79147);
<a name="l00568"></a>00568             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a54dd456b8908bb6724cc7f312b38d9e2" title="SHA-256 F1 Function.">F1</a>(C,D,E,F,G,H,A,B,W[30],0x06CA6351);
<a name="l00569"></a>00569             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a54dd456b8908bb6724cc7f312b38d9e2" title="SHA-256 F1 Function.">F1</a>(B,C,D,E,F,G,H,A,W[31],0x14292967);
<a name="l00570"></a>00570             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a54dd456b8908bb6724cc7f312b38d9e2" title="SHA-256 F1 Function.">F1</a>(A,B,C,D,E,F,G,H,W[32],0x27B70A85);
<a name="l00571"></a>00571             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a54dd456b8908bb6724cc7f312b38d9e2" title="SHA-256 F1 Function.">F1</a>(H,A,B,C,D,E,F,G,W[33],0x2E1B2138);
<a name="l00572"></a>00572             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a54dd456b8908bb6724cc7f312b38d9e2" title="SHA-256 F1 Function.">F1</a>(G,H,A,B,C,D,E,F,W[34],0x4D2C6DFC);
<a name="l00573"></a>00573             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a54dd456b8908bb6724cc7f312b38d9e2" title="SHA-256 F1 Function.">F1</a>(F,G,H,A,B,C,D,E,W[35],0x53380D13);
<a name="l00574"></a>00574             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a54dd456b8908bb6724cc7f312b38d9e2" title="SHA-256 F1 Function.">F1</a>(E,F,G,H,A,B,C,D,W[36],0x650A7354);
<a name="l00575"></a>00575             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a54dd456b8908bb6724cc7f312b38d9e2" title="SHA-256 F1 Function.">F1</a>(D,E,F,G,H,A,B,C,W[37],0x766A0ABB);
<a name="l00576"></a>00576             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a54dd456b8908bb6724cc7f312b38d9e2" title="SHA-256 F1 Function.">F1</a>(C,D,E,F,G,H,A,B,W[38],0x81C2C92E);
<a name="l00577"></a>00577             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a54dd456b8908bb6724cc7f312b38d9e2" title="SHA-256 F1 Function.">F1</a>(B,C,D,E,F,G,H,A,W[39],0x92722C85);
<a name="l00578"></a>00578             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a54dd456b8908bb6724cc7f312b38d9e2" title="SHA-256 F1 Function.">F1</a>(A,B,C,D,E,F,G,H,W[40],0xA2BFE8A1);
<a name="l00579"></a>00579             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a54dd456b8908bb6724cc7f312b38d9e2" title="SHA-256 F1 Function.">F1</a>(H,A,B,C,D,E,F,G,W[41],0xA81A664B);
<a name="l00580"></a>00580             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a54dd456b8908bb6724cc7f312b38d9e2" title="SHA-256 F1 Function.">F1</a>(G,H,A,B,C,D,E,F,W[42],0xC24B8B70);
<a name="l00581"></a>00581             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a54dd456b8908bb6724cc7f312b38d9e2" title="SHA-256 F1 Function.">F1</a>(F,G,H,A,B,C,D,E,W[43],0xC76C51A3);
<a name="l00582"></a>00582             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a54dd456b8908bb6724cc7f312b38d9e2" title="SHA-256 F1 Function.">F1</a>(E,F,G,H,A,B,C,D,W[44],0xD192E819);
<a name="l00583"></a>00583             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a54dd456b8908bb6724cc7f312b38d9e2" title="SHA-256 F1 Function.">F1</a>(D,E,F,G,H,A,B,C,W[45],0xD6990624);
<a name="l00584"></a>00584             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a54dd456b8908bb6724cc7f312b38d9e2" title="SHA-256 F1 Function.">F1</a>(C,D,E,F,G,H,A,B,W[46],0xF40E3585);
<a name="l00585"></a>00585             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a54dd456b8908bb6724cc7f312b38d9e2" title="SHA-256 F1 Function.">F1</a>(B,C,D,E,F,G,H,A,W[47],0x106AA070);
<a name="l00586"></a>00586             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a54dd456b8908bb6724cc7f312b38d9e2" title="SHA-256 F1 Function.">F1</a>(A,B,C,D,E,F,G,H,W[48],0x19A4C116);
<a name="l00587"></a>00587             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a54dd456b8908bb6724cc7f312b38d9e2" title="SHA-256 F1 Function.">F1</a>(H,A,B,C,D,E,F,G,W[49],0x1E376C08);
<a name="l00588"></a>00588             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a54dd456b8908bb6724cc7f312b38d9e2" title="SHA-256 F1 Function.">F1</a>(G,H,A,B,C,D,E,F,W[50],0x2748774C);
<a name="l00589"></a>00589             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a54dd456b8908bb6724cc7f312b38d9e2" title="SHA-256 F1 Function.">F1</a>(F,G,H,A,B,C,D,E,W[51],0x34B0BCB5);
<a name="l00590"></a>00590             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a54dd456b8908bb6724cc7f312b38d9e2" title="SHA-256 F1 Function.">F1</a>(E,F,G,H,A,B,C,D,W[52],0x391C0CB3);
<a name="l00591"></a>00591             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a54dd456b8908bb6724cc7f312b38d9e2" title="SHA-256 F1 Function.">F1</a>(D,E,F,G,H,A,B,C,W[53],0x4ED8AA4A);
<a name="l00592"></a>00592             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a54dd456b8908bb6724cc7f312b38d9e2" title="SHA-256 F1 Function.">F1</a>(C,D,E,F,G,H,A,B,W[54],0x5B9CCA4F);
<a name="l00593"></a>00593             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a54dd456b8908bb6724cc7f312b38d9e2" title="SHA-256 F1 Function.">F1</a>(B,C,D,E,F,G,H,A,W[55],0x682E6FF3);
<a name="l00594"></a>00594             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a54dd456b8908bb6724cc7f312b38d9e2" title="SHA-256 F1 Function.">F1</a>(A,B,C,D,E,F,G,H,W[56],0x748F82EE);
<a name="l00595"></a>00595             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a54dd456b8908bb6724cc7f312b38d9e2" title="SHA-256 F1 Function.">F1</a>(H,A,B,C,D,E,F,G,W[57],0x78A5636F);
<a name="l00596"></a>00596             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a54dd456b8908bb6724cc7f312b38d9e2" title="SHA-256 F1 Function.">F1</a>(G,H,A,B,C,D,E,F,W[58],0x84C87814);
<a name="l00597"></a>00597             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a54dd456b8908bb6724cc7f312b38d9e2" title="SHA-256 F1 Function.">F1</a>(F,G,H,A,B,C,D,E,W[59],0x8CC70208);
<a name="l00598"></a>00598             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a54dd456b8908bb6724cc7f312b38d9e2" title="SHA-256 F1 Function.">F1</a>(E,F,G,H,A,B,C,D,W[60],0x90BEFFFA);
<a name="l00599"></a>00599             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a54dd456b8908bb6724cc7f312b38d9e2" title="SHA-256 F1 Function.">F1</a>(D,E,F,G,H,A,B,C,W[61],0xA4506CEB);
<a name="l00600"></a>00600             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a54dd456b8908bb6724cc7f312b38d9e2" title="SHA-256 F1 Function.">F1</a>(C,D,E,F,G,H,A,B,W[62],0xBEF9A3F7);
<a name="l00601"></a>00601             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a54dd456b8908bb6724cc7f312b38d9e2" title="SHA-256 F1 Function.">F1</a>(B,C,D,E,F,G,H,A,W[63],0xC67178F2);
<a name="l00602"></a>00602 
<a name="l00603"></a>00603             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a17db6bd918e637441419766a6f434fd0">digest</a>[0] += A; <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a17db6bd918e637441419766a6f434fd0">digest</a>[1] += B; <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a17db6bd918e637441419766a6f434fd0">digest</a>[2] += C;
<a name="l00604"></a>00604             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a17db6bd918e637441419766a6f434fd0">digest</a>[3] += D; <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a17db6bd918e637441419766a6f434fd0">digest</a>[4] += E; <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a17db6bd918e637441419766a6f434fd0">digest</a>[5] += F;
<a name="l00605"></a>00605             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a17db6bd918e637441419766a6f434fd0">digest</a>[6] += G; <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a17db6bd918e637441419766a6f434fd0">digest</a>[7] += H;
<a name="l00606"></a>00606         }
<a name="l00607"></a>00607 
<a name="l00609"></a><a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#ae5436ff6858e6dd278984e6617c23e4c">00609</a>         <span class="keywordtype">void</span> <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#ae5436ff6858e6dd278984e6617c23e4c" title="Copy out the digest.">copy_out</a>(<a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a1bc4967fe1c5d91f0377567bccf83949" title="local typedef from Botan library">byte</a> output[])
<a name="l00610"></a>00610         {
<a name="l00611"></a>00611             <span class="keywordflow">for</span>(<a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a3f10e041c073cb2f56c8ca3fcf4532eb" title="local typedef from Botan library">u32bit</a> j = 0; j != <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#afdba7f212f9eb3bc478d6f63e33570e0" title="length of the resulting digest">OUTPUT_LENGTH</a>; ++j)
<a name="l00612"></a>00612                 output[j] = <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#afa931e91496af8c1ebf16950d4f41a11" title="Byte Extraction Function.">get_byte</a>(j % 4, <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a17db6bd918e637441419766a6f434fd0">digest</a>[j/4]);
<a name="l00613"></a>00613         }
<a name="l00614"></a>00614 
<a name="l00615"></a>00615     <span class="keyword">protected</span>:
<a name="l00616"></a>00616 
<a name="l00618"></a><a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a6b078fdac553adff9b22d481cc94ab34">00618</a>         <span class="keywordtype">void</span> <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a6b078fdac553adff9b22d481cc94ab34" title="Update the hash.">add_data</a>(<span class="keyword">const</span> <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a1bc4967fe1c5d91f0377567bccf83949" title="local typedef from Botan library">byte</a> input[], <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a3f10e041c073cb2f56c8ca3fcf4532eb" title="local typedef from Botan library">u32bit</a> length)
<a name="l00619"></a>00619         {
<a name="l00620"></a>00620             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a0291988699cc20a186275d87ba5804af">count</a> += length;
<a name="l00621"></a>00621 
<a name="l00622"></a>00622             <span class="keywordflow">if</span> (<a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#aac541a215ed5d94d5d8ea06ffe2f3e35">position</a>)
<a name="l00623"></a>00623             {
<a name="l00624"></a>00624                 memcpy(<a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a66d62aaaab77f19f052d2536715c6741">buffer</a> + <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#aac541a215ed5d94d5d8ea06ffe2f3e35">position</a>, input,
<a name="l00625"></a>00625                        std::min&lt;u32bit&gt;(length, <span class="keyword">sizeof</span>(<a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a66d62aaaab77f19f052d2536715c6741">buffer</a>) - <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#aac541a215ed5d94d5d8ea06ffe2f3e35">position</a>));
<a name="l00626"></a>00626 
<a name="l00627"></a>00627                 <span class="keywordflow">if</span>(<a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#aac541a215ed5d94d5d8ea06ffe2f3e35">position</a> + length &gt;= <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a4f2819a15fbb30e09ce797bf7706de8e" title="block of bytes to process in hash function">HASH_BLOCK_SIZE</a>)
<a name="l00628"></a>00628                 {
<a name="l00629"></a>00629                     <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#adedf2be3225d2518364b217c746f90b3" title="SHA-256 Compression Function.">hash</a>(<a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a66d62aaaab77f19f052d2536715c6741">buffer</a>);
<a name="l00630"></a>00630                     input += (<a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a4f2819a15fbb30e09ce797bf7706de8e" title="block of bytes to process in hash function">HASH_BLOCK_SIZE</a> - <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#aac541a215ed5d94d5d8ea06ffe2f3e35">position</a>);
<a name="l00631"></a>00631                     length -= (<a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a4f2819a15fbb30e09ce797bf7706de8e" title="block of bytes to process in hash function">HASH_BLOCK_SIZE</a> - <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#aac541a215ed5d94d5d8ea06ffe2f3e35">position</a>);
<a name="l00632"></a>00632                     <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#aac541a215ed5d94d5d8ea06ffe2f3e35">position</a> = 0;
<a name="l00633"></a>00633                 }
<a name="l00634"></a>00634             }
<a name="l00635"></a>00635 
<a name="l00636"></a>00636             <span class="keywordflow">while</span>(length &gt;= <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a4f2819a15fbb30e09ce797bf7706de8e" title="block of bytes to process in hash function">HASH_BLOCK_SIZE</a>)
<a name="l00637"></a>00637             {
<a name="l00638"></a>00638                 <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#adedf2be3225d2518364b217c746f90b3" title="SHA-256 Compression Function.">hash</a>(input);
<a name="l00639"></a>00639                 input += <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a4f2819a15fbb30e09ce797bf7706de8e" title="block of bytes to process in hash function">HASH_BLOCK_SIZE</a>;
<a name="l00640"></a>00640                 length -= <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a4f2819a15fbb30e09ce797bf7706de8e" title="block of bytes to process in hash function">HASH_BLOCK_SIZE</a>;
<a name="l00641"></a>00641             }
<a name="l00642"></a>00642 
<a name="l00643"></a>00643             memcpy(<a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a66d62aaaab77f19f052d2536715c6741">buffer</a> + <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#aac541a215ed5d94d5d8ea06ffe2f3e35">position</a>, input,
<a name="l00644"></a>00644                    std::min&lt;u32bit&gt;(length, <span class="keyword">sizeof</span>(<a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a66d62aaaab77f19f052d2536715c6741">buffer</a>) - <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#aac541a215ed5d94d5d8ea06ffe2f3e35">position</a>));
<a name="l00645"></a>00645 
<a name="l00646"></a>00646             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#aac541a215ed5d94d5d8ea06ffe2f3e35">position</a> += length;
<a name="l00647"></a>00647         }
<a name="l00648"></a>00648 
<a name="l00650"></a><a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#afe7afc5a7ef8c9a93dbb496f0786bfa4">00650</a>         <span class="keywordtype">void</span> <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#afe7afc5a7ef8c9a93dbb496f0786bfa4" title="Write the count bits to the buffer.">write_count</a>(<a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a1bc4967fe1c5d91f0377567bccf83949" title="local typedef from Botan library">byte</a> out[])
<a name="l00651"></a>00651         {
<a name="l00652"></a>00652             <span class="keywordflow">for</span>(<a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a3f10e041c073cb2f56c8ca3fcf4532eb" title="local typedef from Botan library">u32bit</a> j = 0; j != 8; ++j)
<a name="l00653"></a>00653             {
<a name="l00654"></a>00654                 out[j+<a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a9b33fe0ec3ed40965e2df74fad2f8e1e" title="length of size suffix hashed during finalization">COUNT_SIZE</a>-8] = <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#afa931e91496af8c1ebf16950d4f41a11" title="Byte Extraction Function.">get_byte</a>(j % 8, 8 * <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a0291988699cc20a186275d87ba5804af">count</a>);
<a name="l00655"></a>00655             }
<a name="l00656"></a>00656         }
<a name="l00657"></a>00657 
<a name="l00659"></a><a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a5cd2c91c6fc2654e0e04916e3a2a6f0f">00659</a>         <span class="keywordtype">void</span> <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a5cd2c91c6fc2654e0e04916e3a2a6f0f" title="Finalize a Hash.">final_result</a>(<a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a1bc4967fe1c5d91f0377567bccf83949" title="local typedef from Botan library">byte</a> output[<a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#afdba7f212f9eb3bc478d6f63e33570e0" title="length of the resulting digest">OUTPUT_LENGTH</a>])
<a name="l00660"></a>00660         {
<a name="l00661"></a>00661             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a66d62aaaab77f19f052d2536715c6741">buffer</a>[<a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#aac541a215ed5d94d5d8ea06ffe2f3e35">position</a>] = 0x80;
<a name="l00662"></a>00662             <span class="keywordflow">for</span>(<a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a3f10e041c073cb2f56c8ca3fcf4532eb" title="local typedef from Botan library">u32bit</a> j = <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#aac541a215ed5d94d5d8ea06ffe2f3e35">position</a>+1; j != <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a4f2819a15fbb30e09ce797bf7706de8e" title="block of bytes to process in hash function">HASH_BLOCK_SIZE</a>; ++j)
<a name="l00663"></a>00663                 <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a66d62aaaab77f19f052d2536715c6741">buffer</a>[j] = 0;
<a name="l00664"></a>00664             <span class="keywordflow">if</span>(<a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#aac541a215ed5d94d5d8ea06ffe2f3e35">position</a> &gt;= <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a4f2819a15fbb30e09ce797bf7706de8e" title="block of bytes to process in hash function">HASH_BLOCK_SIZE</a> - <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a9b33fe0ec3ed40965e2df74fad2f8e1e" title="length of size suffix hashed during finalization">COUNT_SIZE</a>)
<a name="l00665"></a>00665             {
<a name="l00666"></a>00666                 <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#adedf2be3225d2518364b217c746f90b3" title="SHA-256 Compression Function.">hash</a>(<a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a66d62aaaab77f19f052d2536715c6741">buffer</a>);
<a name="l00667"></a>00667                 memset(<a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a66d62aaaab77f19f052d2536715c6741">buffer</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a66d62aaaab77f19f052d2536715c6741">buffer</a>));
<a name="l00668"></a>00668             }
<a name="l00669"></a>00669             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#afe7afc5a7ef8c9a93dbb496f0786bfa4" title="Write the count bits to the buffer.">write_count</a>(<a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a66d62aaaab77f19f052d2536715c6741">buffer</a> + <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a4f2819a15fbb30e09ce797bf7706de8e" title="block of bytes to process in hash function">HASH_BLOCK_SIZE</a> - <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a9b33fe0ec3ed40965e2df74fad2f8e1e" title="length of size suffix hashed during finalization">COUNT_SIZE</a>);
<a name="l00670"></a>00670 
<a name="l00671"></a>00671             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#adedf2be3225d2518364b217c746f90b3" title="SHA-256 Compression Function.">hash</a>(<a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a66d62aaaab77f19f052d2536715c6741">buffer</a>);
<a name="l00672"></a>00672             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#ae5436ff6858e6dd278984e6617c23e4c" title="Copy out the digest.">copy_out</a>(output);
<a name="l00673"></a>00673             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a177db0679d2e66dedcb7ceff1ca97fe9" title="Clear memory of sensitive data.">clear</a>();
<a name="l00674"></a>00674         }
<a name="l00675"></a>00675 
<a name="l00676"></a>00676     <span class="keyword">public</span>:
<a name="l00678"></a><a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#aa4977f8528ca3b5efee3903fd54880a9">00678</a>         <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#aa4977f8528ca3b5efee3903fd54880a9" title="SHA_256 / MDx_HashFunction Constructor.">SHA256</a>()
<a name="l00679"></a>00679         {
<a name="l00680"></a>00680             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a177db0679d2e66dedcb7ceff1ca97fe9" title="Clear memory of sensitive data.">clear</a>();
<a name="l00681"></a>00681         }
<a name="l00682"></a>00682 
<a name="l00684"></a><a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a177db0679d2e66dedcb7ceff1ca97fe9">00684</a>         <span class="keywordtype">void</span> <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a177db0679d2e66dedcb7ceff1ca97fe9" title="Clear memory of sensitive data.">clear</a>() throw()
<a name="l00685"></a>00685         {
<a name="l00686"></a>00686             memset(<a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a66d62aaaab77f19f052d2536715c6741">buffer</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a66d62aaaab77f19f052d2536715c6741">buffer</a>));
<a name="l00687"></a>00687             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a0291988699cc20a186275d87ba5804af">count</a> = <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#aac541a215ed5d94d5d8ea06ffe2f3e35">position</a> = 0;
<a name="l00688"></a>00688 
<a name="l00689"></a>00689             memset(<a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#afd515411f08f7ed035bef1161909ed40">W</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#afd515411f08f7ed035bef1161909ed40">W</a>));
<a name="l00690"></a>00690             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a17db6bd918e637441419766a6f434fd0">digest</a>[0] = 0x6A09E667;
<a name="l00691"></a>00691             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a17db6bd918e637441419766a6f434fd0">digest</a>[1] = 0xBB67AE85;
<a name="l00692"></a>00692             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a17db6bd918e637441419766a6f434fd0">digest</a>[2] = 0x3C6EF372;
<a name="l00693"></a>00693             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a17db6bd918e637441419766a6f434fd0">digest</a>[3] = 0xA54FF53A;
<a name="l00694"></a>00694             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a17db6bd918e637441419766a6f434fd0">digest</a>[4] = 0x510E527F;
<a name="l00695"></a>00695             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a17db6bd918e637441419766a6f434fd0">digest</a>[5] = 0x9B05688C;
<a name="l00696"></a>00696             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a17db6bd918e637441419766a6f434fd0">digest</a>[6] = 0x1F83D9AB;
<a name="l00697"></a>00697             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a17db6bd918e637441419766a6f434fd0">digest</a>[7] = 0x5BE0CD19;
<a name="l00698"></a>00698         }
<a name="l00699"></a>00699 
<a name="l00701"></a><a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#ad306a1c3c2f0321301e563af37bb17cd">00701</a>         <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html" title="SHA-256 Message Digest implementation class.">SHA256</a>&amp; <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#ad306a1c3c2f0321301e563af37bb17cd" title="Update this SHA256 calculation with new data.">update</a>(<span class="keyword">const</span> <span class="keywordtype">void</span>* input, uint32_t length)
<a name="l00702"></a>00702         {
<a name="l00703"></a>00703             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a6b078fdac553adff9b22d481cc94ab34" title="Update the hash.">add_data</a>(reinterpret_cast&lt;const unsigned char*&gt;(input), length);
<a name="l00704"></a>00704             <span class="keywordflow">return</span> *<span class="keyword">this</span>;
<a name="l00705"></a>00705         }
<a name="l00706"></a>00706 
<a name="l00708"></a><a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#ab69946b6e8a4fc6190dc14d9df9b886d">00708</a>         <span class="keywordtype">void</span> <span class="keyword">final</span>(<a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a1bc4967fe1c5d91f0377567bccf83949" title="local typedef from Botan library">byte</a> output[<a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#afdba7f212f9eb3bc478d6f63e33570e0" title="length of the resulting digest">OUTPUT_LENGTH</a>])
<a name="l00709"></a>00709         {
<a name="l00710"></a>00710             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a5cd2c91c6fc2654e0e04916e3a2a6f0f" title="Finalize a Hash.">final_result</a>(output);
<a name="l00711"></a>00711         }
<a name="l00712"></a>00712 
<a name="l00714"></a><a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a4ebd017b9a9660f9a880d22aaad886b2">00714</a>         std::string <span class="keyword">final</span>()
<a name="l00715"></a>00715         {
<a name="l00716"></a>00716             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a1bc4967fe1c5d91f0377567bccf83949" title="local typedef from Botan library">byte</a> result[<a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#afdba7f212f9eb3bc478d6f63e33570e0" title="length of the resulting digest">OUTPUT_LENGTH</a>];
<a name="l00717"></a>00717             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a5cd2c91c6fc2654e0e04916e3a2a6f0f" title="Finalize a Hash.">final_result</a>(result);
<a name="l00718"></a>00718             <span class="keywordflow">return</span> std::string(reinterpret_cast&lt;char*&gt;(result), <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#afdba7f212f9eb3bc478d6f63e33570e0" title="length of the resulting digest">OUTPUT_LENGTH</a>);
<a name="l00719"></a>00719         }
<a name="l00720"></a>00720 
<a name="l00723"></a><a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a12bc94d3a0700ae7dcc47b15bae1cde8">00723</a>         <span class="keywordtype">bool</span> <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a12bc94d3a0700ae7dcc47b15bae1cde8" title="Returns true if the final SHA256 digest of this object equals the given data.">final_equals</a>(<a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a1bc4967fe1c5d91f0377567bccf83949" title="local typedef from Botan library">byte</a> compare[<a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#afdba7f212f9eb3bc478d6f63e33570e0" title="length of the resulting digest">OUTPUT_LENGTH</a>])
<a name="l00724"></a>00724         {
<a name="l00725"></a>00725             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a1bc4967fe1c5d91f0377567bccf83949" title="local typedef from Botan library">byte</a> result[OUTPUT_LENGTH];
<a name="l00726"></a>00726             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a5cd2c91c6fc2654e0e04916e3a2a6f0f" title="Finalize a Hash.">final_result</a>(result);
<a name="l00727"></a>00727             <span class="keywordflow">return</span> (memcmp(compare, result, OUTPUT_LENGTH) == 0);
<a name="l00728"></a>00728         }
<a name="l00729"></a>00729 
<a name="l00732"></a><a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a7a5d9c0655825e07887b4faf8fcf288f">00732</a>         std::string <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a7a5d9c0655825e07887b4faf8fcf288f" title="Return final SHA256 digest of this object as a string encoded in hexadecimal.">final_hex</a>()
<a name="l00733"></a>00733         {
<a name="l00734"></a>00734             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a1bc4967fe1c5d91f0377567bccf83949" title="local typedef from Botan library">byte</a> result[<a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#afdba7f212f9eb3bc478d6f63e33570e0" title="length of the resulting digest">OUTPUT_LENGTH</a>];
<a name="l00735"></a>00735             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a5cd2c91c6fc2654e0e04916e3a2a6f0f" title="Finalize a Hash.">final_result</a>(result);
<a name="l00736"></a>00736 
<a name="l00737"></a>00737             std::string out(<a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#afdba7f212f9eb3bc478d6f63e33570e0" title="length of the resulting digest">OUTPUT_LENGTH</a>*2, <span class="charliteral">&#39;\0&#39;</span>);
<a name="l00738"></a>00738 
<a name="l00739"></a>00739             <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> xdigits[16] = {
<a name="l00740"></a>00740                 <span class="charliteral">&#39;0&#39;</span>, <span class="charliteral">&#39;1&#39;</span>, <span class="charliteral">&#39;2&#39;</span>, <span class="charliteral">&#39;3&#39;</span>, <span class="charliteral">&#39;4&#39;</span>, <span class="charliteral">&#39;5&#39;</span>, <span class="charliteral">&#39;6&#39;</span>, <span class="charliteral">&#39;7&#39;</span>, <span class="charliteral">&#39;8&#39;</span>, <span class="charliteral">&#39;9&#39;</span>, <span class="charliteral">&#39;A&#39;</span>, <span class="charliteral">&#39;B&#39;</span>, <span class="charliteral">&#39;C&#39;</span>, <span class="charliteral">&#39;D&#39;</span>, <span class="charliteral">&#39;E&#39;</span>, <span class="charliteral">&#39;F&#39;</span>
<a name="l00741"></a>00741             };
<a name="l00742"></a>00742 
<a name="l00743"></a>00743             std::string::iterator oi = out.begin();
<a name="l00744"></a>00744             <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#afdba7f212f9eb3bc478d6f63e33570e0" title="length of the resulting digest">OUTPUT_LENGTH</a>; ++i)
<a name="l00745"></a>00745             {
<a name="l00746"></a>00746                 *oi++ = xdigits[ (result[i] &amp; 0xF0) &gt;&gt; 4 ];
<a name="l00747"></a>00747                 *oi++ = xdigits[ (result[i] &amp; 0x0F) ];
<a name="l00748"></a>00748             }
<a name="l00749"></a>00749 
<a name="l00750"></a>00750             <span class="keywordflow">return</span> out;
<a name="l00751"></a>00751         }
<a name="l00752"></a>00752 
<a name="l00754"></a><a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a669dba4cecf7c605caedf3cd0c5077da">00754</a>         <span class="keyword">static</span> std::string <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a669dba4cecf7c605caedf3cd0c5077da" title="Calculate SHA256 digest of bytes in the given range.">digest_bin</a>(<span class="keyword">const</span> <span class="keywordtype">void</span>* input, uint32_t length)
<a name="l00755"></a>00755         {
<a name="l00756"></a>00756             <span class="keywordflow">return</span> <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#aa4977f8528ca3b5efee3903fd54880a9" title="SHA_256 / MDx_HashFunction Constructor.">SHA256</a>().update(input, length).final();
<a name="l00757"></a>00757         }
<a name="l00758"></a>00758 
<a name="l00760"></a><a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#aaf1c14e4ccbc9f85e09e3631d0292aad">00760</a>         <span class="keyword">static</span> std::string <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a669dba4cecf7c605caedf3cd0c5077da" title="Calculate SHA256 digest of bytes in the given range.">digest_bin</a>(<span class="keyword">const</span> std::string&amp; input)
<a name="l00761"></a>00761         {
<a name="l00762"></a>00762             <span class="keywordflow">return</span> <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a669dba4cecf7c605caedf3cd0c5077da" title="Calculate SHA256 digest of bytes in the given range.">digest_bin</a>(input.data(), input.size());
<a name="l00763"></a>00763         }
<a name="l00764"></a>00764 
<a name="l00767"></a><a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#aaf9f5ee573eec082bccac0b31b12f5af">00767</a>         <span class="keyword">static</span> std::string <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#aaf9f5ee573eec082bccac0b31b12f5af" title="Calculate SHA256 digest of bytes in the given range.">digest_hex</a>(<span class="keyword">const</span> <span class="keywordtype">void</span>* input, uint32_t length)
<a name="l00768"></a>00768         {
<a name="l00769"></a>00769             <span class="keywordflow">return</span> <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#aa4977f8528ca3b5efee3903fd54880a9" title="SHA_256 / MDx_HashFunction Constructor.">SHA256</a>().update(input, length).final_hex();
<a name="l00770"></a>00770         }
<a name="l00771"></a>00771 
<a name="l00774"></a><a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#ac611d7abf2e14b4d109bce9c39caed38">00774</a>         <span class="keyword">static</span> std::string <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#aaf9f5ee573eec082bccac0b31b12f5af" title="Calculate SHA256 digest of bytes in the given range.">digest_hex</a>(<span class="keyword">const</span> std::string&amp; input)
<a name="l00775"></a>00775         {
<a name="l00776"></a>00776             <span class="keywordflow">return</span> <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#aaf9f5ee573eec082bccac0b31b12f5af" title="Calculate SHA256 digest of bytes in the given range.">digest_hex</a>(input.data(), input.size());
<a name="l00777"></a>00777         }
<a name="l00778"></a>00778     };
<a name="l00779"></a>00779 
<a name="l00780"></a>00780 <span class="keyword">protected</span>:
<a name="l00790"></a><a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html">00790</a>     <span class="keyword">class </span><a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html" title="BTreePage is a reference-counted buffer holding one page of the B-tree index.">BTreePage</a>
<a name="l00791"></a>00791     {
<a name="l00792"></a>00792     <span class="keyword">protected</span>:
<a name="l00797"></a><a class="code" href="structstx_1_1CBTreeDB_1_1BTreePage_1_1Impl.html">00797</a>         <span class="keyword">struct </span><a class="code" href="structstx_1_1CBTreeDB_1_1BTreePage_1_1Impl.html" title="Implementation of BTreePage: holds the data buffer and a reference counter.">Impl</a>
<a name="l00798"></a>00798         {
<a name="l00800"></a><a class="code" href="structstx_1_1CBTreeDB_1_1BTreePage_1_1Impl.html#abb26e4f787493419465f06146e48fab4">00800</a>             <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structstx_1_1CBTreeDB_1_1BTreePage_1_1Impl.html#abb26e4f787493419465f06146e48fab4" title="reference counter">refs</a>;
<a name="l00801"></a>00801 
<a name="l00803"></a><a class="code" href="structstx_1_1CBTreeDB_1_1BTreePage_1_1Impl.html#a7e3a29ece9edd3b2ef4e6d43a886465e">00803</a>             <span class="keywordtype">char</span>        <a class="code" href="structstx_1_1CBTreeDB_1_1BTreePage_1_1Impl.html#a7e3a29ece9edd3b2ef4e6d43a886465e" title="data buffer">data</a>[<a class="code" href="classstx_1_1CBTreeDB.html#a924efff56b96b6c5a0397211b0cf8685" title="third template parameter: B-tree page size. Usually 1024 or 2048.">BTreePageSize</a>];
<a name="l00804"></a>00804         };
<a name="l00805"></a>00805 
<a name="l00807"></a><a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#adf205310d6816e4f7c0ddd84a5376663">00807</a>         <span class="keyword">struct </span><a class="code" href="structstx_1_1CBTreeDB_1_1BTreePage_1_1Impl.html" title="Implementation of BTreePage: holds the data buffer and a reference counter.">Impl</a>*    <a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#adf205310d6816e4f7c0ddd84a5376663" title="pointer to reference-counted data buffer object.">m_impl</a>;
<a name="l00808"></a>00808 
<a name="l00809"></a>00809     <span class="keyword">public</span>:
<a name="l00811"></a><a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#a613acef27cd9fdabf095c0caaa939968">00811</a>         <a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#a613acef27cd9fdabf095c0caaa939968" title="Default Constructor: create new invalid page buffer.">BTreePage</a>()
<a name="l00812"></a>00812             : <a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#adf205310d6816e4f7c0ddd84a5376663" title="pointer to reference-counted data buffer object.">m_impl</a>(NULL)
<a name="l00813"></a>00813         {
<a name="l00814"></a>00814         }
<a name="l00815"></a>00815 
<a name="l00817"></a><a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#ae009d878063ceeac314e965206fd4fb0">00817</a>         <a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#a613acef27cd9fdabf095c0caaa939968" title="Default Constructor: create new invalid page buffer.">BTreePage</a>(<span class="keyword">const</span> <a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html" title="BTreePage is a reference-counted buffer holding one page of the B-tree index.">BTreePage</a>&amp; btp)
<a name="l00818"></a>00818             : <a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#adf205310d6816e4f7c0ddd84a5376663" title="pointer to reference-counted data buffer object.">m_impl</a>(btp.<a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#adf205310d6816e4f7c0ddd84a5376663" title="pointer to reference-counted data buffer object.">m_impl</a>)
<a name="l00819"></a>00819         {
<a name="l00820"></a>00820             <span class="keywordflow">if</span> (<a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#adf205310d6816e4f7c0ddd84a5376663" title="pointer to reference-counted data buffer object.">m_impl</a>)
<a name="l00821"></a>00821                 ++<a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#adf205310d6816e4f7c0ddd84a5376663" title="pointer to reference-counted data buffer object.">m_impl</a>-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1BTreePage_1_1Impl.html#abb26e4f787493419465f06146e48fab4" title="reference counter">refs</a>;
<a name="l00822"></a>00822         }
<a name="l00823"></a>00823 
<a name="l00826"></a><a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#a9f0855f678d7b9fbab53fe45e902e192">00826</a>         <a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#a9f0855f678d7b9fbab53fe45e902e192" title="Destructor: decrement reference counter on buffer and possibly deallocate it.">~BTreePage</a>()
<a name="l00827"></a>00827         {
<a name="l00828"></a>00828             <span class="keywordflow">if</span> (<a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#adf205310d6816e4f7c0ddd84a5376663" title="pointer to reference-counted data buffer object.">m_impl</a> &amp;&amp; --<a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#adf205310d6816e4f7c0ddd84a5376663" title="pointer to reference-counted data buffer object.">m_impl</a>-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1BTreePage_1_1Impl.html#abb26e4f787493419465f06146e48fab4" title="reference counter">refs</a> == 0)
<a name="l00829"></a>00829                 <span class="keyword">delete</span> <a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#adf205310d6816e4f7c0ddd84a5376663" title="pointer to reference-counted data buffer object.">m_impl</a>;
<a name="l00830"></a>00830         }
<a name="l00831"></a>00831 
<a name="l00833"></a><a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#a357637ecbd3bc24a170bc6280623bf9d">00833</a>         <a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html" title="BTreePage is a reference-counted buffer holding one page of the B-tree index.">BTreePage</a>&amp; <a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#a357637ecbd3bc24a170bc6280623bf9d" title="Assignment Operator: increment reference counter on buffer.">operator=</a>(<span class="keyword">const</span> <a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html" title="BTreePage is a reference-counted buffer holding one page of the B-tree index.">BTreePage</a>&amp; btp)
<a name="l00834"></a>00834         {
<a name="l00835"></a>00835             <span class="keywordflow">if</span> (<span class="keyword">this</span> != &amp;btp)
<a name="l00836"></a>00836             {
<a name="l00837"></a>00837                 <span class="keywordflow">if</span> (<a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#adf205310d6816e4f7c0ddd84a5376663" title="pointer to reference-counted data buffer object.">m_impl</a> &amp;&amp; --<a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#adf205310d6816e4f7c0ddd84a5376663" title="pointer to reference-counted data buffer object.">m_impl</a>-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1BTreePage_1_1Impl.html#abb26e4f787493419465f06146e48fab4" title="reference counter">refs</a> == 0)
<a name="l00838"></a>00838                     <span class="keyword">delete</span> <a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#adf205310d6816e4f7c0ddd84a5376663" title="pointer to reference-counted data buffer object.">m_impl</a>;
<a name="l00839"></a>00839 
<a name="l00840"></a>00840                 <a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#adf205310d6816e4f7c0ddd84a5376663" title="pointer to reference-counted data buffer object.">m_impl</a> = btp.<a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#adf205310d6816e4f7c0ddd84a5376663" title="pointer to reference-counted data buffer object.">m_impl</a>;
<a name="l00841"></a>00841 
<a name="l00842"></a>00842                 <span class="keywordflow">if</span> (<a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#adf205310d6816e4f7c0ddd84a5376663" title="pointer to reference-counted data buffer object.">m_impl</a>)
<a name="l00843"></a>00843                     ++<a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#adf205310d6816e4f7c0ddd84a5376663" title="pointer to reference-counted data buffer object.">m_impl</a>-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1BTreePage_1_1Impl.html#abb26e4f787493419465f06146e48fab4" title="reference counter">refs</a>;
<a name="l00844"></a>00844             }
<a name="l00845"></a>00845 
<a name="l00846"></a>00846             <span class="keywordflow">return</span> *<span class="keyword">this</span>;
<a name="l00847"></a>00847         }
<a name="l00848"></a>00848 
<a name="l00850"></a><a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#a70fbbb00b9c1edbe5dba2ffd4703dae1">00850</a>         <span class="keywordtype">bool</span> <a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#a70fbbb00b9c1edbe5dba2ffd4703dae1" title="Determine whether the wrapper object contains valid page.">IsValid</a>()<span class="keyword"> const</span>
<a name="l00851"></a>00851 <span class="keyword">        </span>{
<a name="l00852"></a>00852             <span class="keywordflow">return</span> (<a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#adf205310d6816e4f7c0ddd84a5376663" title="pointer to reference-counted data buffer object.">m_impl</a> != NULL);
<a name="l00853"></a>00853         }
<a name="l00854"></a>00854 
<a name="l00856"></a><a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#a97f080d734d971975f292136e546428f">00856</a>         <span class="keywordtype">void</span> <a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#a97f080d734d971975f292136e546428f" title="Release enclosed page and initialize a new page buffer.">Create</a>()
<a name="l00857"></a>00857         {
<a name="l00858"></a>00858             <span class="keywordflow">if</span> (<a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#adf205310d6816e4f7c0ddd84a5376663" title="pointer to reference-counted data buffer object.">m_impl</a> &amp;&amp; --<a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#adf205310d6816e4f7c0ddd84a5376663" title="pointer to reference-counted data buffer object.">m_impl</a>-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1BTreePage_1_1Impl.html#abb26e4f787493419465f06146e48fab4" title="reference counter">refs</a> == 0)
<a name="l00859"></a>00859                 <span class="keyword">delete</span> <a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#adf205310d6816e4f7c0ddd84a5376663" title="pointer to reference-counted data buffer object.">m_impl</a>;
<a name="l00860"></a>00860 
<a name="l00861"></a>00861             <a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#adf205310d6816e4f7c0ddd84a5376663" title="pointer to reference-counted data buffer object.">m_impl</a> = <span class="keyword">new</span> <a class="code" href="structstx_1_1CBTreeDB_1_1BTreePage_1_1Impl.html" title="Implementation of BTreePage: holds the data buffer and a reference counter.">Impl</a>;
<a name="l00862"></a>00862             <a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#adf205310d6816e4f7c0ddd84a5376663" title="pointer to reference-counted data buffer object.">m_impl</a>-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1BTreePage_1_1Impl.html#abb26e4f787493419465f06146e48fab4" title="reference counter">refs</a> = 1;
<a name="l00863"></a>00863         }
<a name="l00864"></a>00864 
<a name="l00866"></a><a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#a1e933680db2ddcac67adf23555454b0b">00866</a>         <span class="keywordtype">char</span>* <a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#a1e933680db2ddcac67adf23555454b0b" title="Accessor: return enclosed buffer pointer.">GetBuffer</a>()
<a name="l00867"></a>00867         {
<a name="l00868"></a>00868             <a class="code" href="stx-cbtreedb_8h.html#ab44bd6c500e8dbe3a232e4c44f28b67e" title="Instead of assert() we use this macro to throw exceptions.">CBTREEDB_ASSERT</a>(<a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#adf205310d6816e4f7c0ddd84a5376663" title="pointer to reference-counted data buffer object.">m_impl</a>);
<a name="l00869"></a>00869             <span class="keywordflow">return</span> <a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#adf205310d6816e4f7c0ddd84a5376663" title="pointer to reference-counted data buffer object.">m_impl</a>-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1BTreePage_1_1Impl.html#a7e3a29ece9edd3b2ef4e6d43a886465e" title="data buffer">data</a>;
<a name="l00870"></a>00870         }
<a name="l00871"></a>00871 
<a name="l00873"></a><a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#ab716b85e97b7ac16b0e2222b50b58534">00873</a>         uint16_t <a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#ab716b85e97b7ac16b0e2222b50b58534" title="Return the enclosed node&amp;#39;s level in the tree.">GetLevel</a>()<span class="keyword"> const</span>
<a name="l00874"></a>00874 <span class="keyword">        </span>{
<a name="l00875"></a>00875             <a class="code" href="stx-cbtreedb_8h.html#ab44bd6c500e8dbe3a232e4c44f28b67e" title="Instead of assert() we use this macro to throw exceptions.">CBTREEDB_ASSERT</a>(<a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#adf205310d6816e4f7c0ddd84a5376663" title="pointer to reference-counted data buffer object.">m_impl</a>);
<a name="l00876"></a>00876             <span class="keywordflow">return</span> <span class="keyword">reinterpret_cast&lt;</span><a class="code" href="structstx_1_1CBTreeDB_1_1InnerNode.html" title="Inner node structure of the B-tree inner pages.">InnerNode</a>*<span class="keyword">&gt;</span>(<a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#adf205310d6816e4f7c0ddd84a5376663" title="pointer to reference-counted data buffer object.">m_impl</a>-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1BTreePage_1_1Impl.html#a7e3a29ece9edd3b2ef4e6d43a886465e" title="data buffer">data</a>)-&gt;level;
<a name="l00877"></a>00877         }
<a name="l00878"></a>00878 
<a name="l00880"></a><a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#a70cb9902a330172c4e08e5035c8c2917">00880</a>         <span class="keywordtype">bool</span> <a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#a70cb9902a330172c4e08e5035c8c2917" title="Returns true if the buffer contains a leaf node.">IsLeafNode</a>()<span class="keyword"> const</span>
<a name="l00881"></a>00881 <span class="keyword">        </span>{
<a name="l00882"></a>00882             <span class="keywordflow">return</span> (<a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#ab716b85e97b7ac16b0e2222b50b58534" title="Return the enclosed node&amp;#39;s level in the tree.">GetLevel</a>() == 0);
<a name="l00883"></a>00883         }
<a name="l00884"></a>00884 
<a name="l00886"></a><a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#adfa632cd49bde968f9064ddb8562d94e">00886</a>         <a class="code" href="structstx_1_1CBTreeDB_1_1InnerNode.html" title="Inner node structure of the B-tree inner pages.">InnerNode</a>* <a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#adfa632cd49bde968f9064ddb8562d94e" title="Return buffer casted as an inner node.">GetAsInnerNode</a>()<span class="keyword"> const</span>
<a name="l00887"></a>00887 <span class="keyword">        </span>{
<a name="l00888"></a>00888             <a class="code" href="stx-cbtreedb_8h.html#ab44bd6c500e8dbe3a232e4c44f28b67e" title="Instead of assert() we use this macro to throw exceptions.">CBTREEDB_ASSERT</a>(<a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#adf205310d6816e4f7c0ddd84a5376663" title="pointer to reference-counted data buffer object.">m_impl</a> &amp;&amp; !<a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#a70cb9902a330172c4e08e5035c8c2917" title="Returns true if the buffer contains a leaf node.">IsLeafNode</a>());
<a name="l00889"></a>00889             <span class="keywordflow">return</span> <span class="keyword">reinterpret_cast&lt;</span><a class="code" href="structstx_1_1CBTreeDB_1_1InnerNode.html" title="Inner node structure of the B-tree inner pages.">InnerNode</a>*<span class="keyword">&gt;</span>(<a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#adf205310d6816e4f7c0ddd84a5376663" title="pointer to reference-counted data buffer object.">m_impl</a>-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1BTreePage_1_1Impl.html#a7e3a29ece9edd3b2ef4e6d43a886465e" title="data buffer">data</a>);
<a name="l00890"></a>00890         }
<a name="l00891"></a>00891 
<a name="l00893"></a><a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#adccee62c9a689ca5cb2dd8353e0726d2">00893</a>         <a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html" title="Leaf node structure of the B-tree leaf pages.">LeafNode</a>* <a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#adccee62c9a689ca5cb2dd8353e0726d2" title="Return buffer casted as a leaf node.">GetAsLeafNode</a>()<span class="keyword"> const</span>
<a name="l00894"></a>00894 <span class="keyword">        </span>{
<a name="l00895"></a>00895             <a class="code" href="stx-cbtreedb_8h.html#ab44bd6c500e8dbe3a232e4c44f28b67e" title="Instead of assert() we use this macro to throw exceptions.">CBTREEDB_ASSERT</a>(<a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#adf205310d6816e4f7c0ddd84a5376663" title="pointer to reference-counted data buffer object.">m_impl</a> &amp;&amp; <a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#a70cb9902a330172c4e08e5035c8c2917" title="Returns true if the buffer contains a leaf node.">IsLeafNode</a>());
<a name="l00896"></a>00896             <span class="keywordflow">return</span> <span class="keyword">reinterpret_cast&lt;</span><a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html" title="Leaf node structure of the B-tree leaf pages.">LeafNode</a>*<span class="keyword">&gt;</span>(<a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#adf205310d6816e4f7c0ddd84a5376663" title="pointer to reference-counted data buffer object.">m_impl</a>-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1BTreePage_1_1Impl.html#a7e3a29ece9edd3b2ef4e6d43a886465e" title="data buffer">data</a>);
<a name="l00897"></a>00897         }
<a name="l00898"></a>00898     };
<a name="l00899"></a>00899 
<a name="l00900"></a>00900 <span class="keyword">protected</span>:
<a name="l00924"></a><a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html">00924</a>     <span class="keyword">class </span><a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html" title="PageCache and PageCacheImpl implement a LRU-strategy cache of B-tree pages used by...">PageCacheImpl</a>
<a name="l00925"></a>00925     {
<a name="l00926"></a>00926     <span class="keyword">protected</span>:
<a name="l00927"></a>00927 
<a name="l00929"></a><a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#aa61ab668cc01a70967d2b48d06ae8042">00929</a>         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>    <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#aa61ab668cc01a70967d2b48d06ae8042" title="reference counter">m_refs</a>;
<a name="l00930"></a>00930 
<a name="l00932"></a><a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a05f9db14ab63c23c66dd285c27bb3830">00932</a>         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>    <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a05f9db14ab63c23c66dd285c27bb3830" title="maximum number of pages in cache">m_maxsize</a>;
<a name="l00933"></a>00933 
<a name="l00935"></a><a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a1f1fb6a254e1828a526766a50976fe40">00935</a>         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>    <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a1f1fb6a254e1828a526766a50976fe40" title="current number of pages in cache">m_size</a>;
<a name="l00936"></a>00936 
<a name="l00937"></a>00937 <span class="preprocessor">#ifdef CBTREEDB_SELF_VERIFY</span>
<a name="l00938"></a>00938 <span class="preprocessor"></span>
<a name="l00943"></a><a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a4653f52d6b2fc7678c2c7d84ae80c020">00943</a>         uint32_t        <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a4653f52d6b2fc7678c2c7d84ae80c020" title="counter to tag pages with a virtual LRU timestamp.">m_lrutime</a>;
<a name="l00944"></a>00944 <span class="preprocessor">#endif</span>
<a name="l00945"></a>00945 <span class="preprocessor"></span>
<a name="l00947"></a><a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html">00947</a>         <span class="keyword">struct </span><a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html" title="Structure for each slot in the cache hash array.">HashCell</a>
<a name="l00948"></a>00948         {
<a name="l00950"></a><a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#a432bdc79bc3f5aeca7008740771e8598">00950</a>             <span class="keyword">struct </span><a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html" title="Structure for each slot in the cache hash array.">HashCell</a>     *<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#a432bdc79bc3f5aeca7008740771e8598" title="pointer forward to next hash cell in bucket">bucket_next</a>;
<a name="l00951"></a>00951 
<a name="l00953"></a><a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#a6d4606e30f353825a81d031472e2ebcb">00953</a>             <span class="keyword">struct </span><a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html" title="Structure for each slot in the cache hash array.">HashCell</a>     *<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#a6d4606e30f353825a81d031472e2ebcb" title="pointer backward to previous hash cell in bucket">bucket_prev</a>;
<a name="l00954"></a>00954 
<a name="l00956"></a><a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#ab5eac48c386b5bbe0ef9dadc148e87ac">00956</a>             <span class="keyword">struct </span><a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html" title="Structure for each slot in the cache hash array.">HashCell</a>     *<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#ab5eac48c386b5bbe0ef9dadc148e87ac" title="pointer forward in LRU double-linked list">list_next</a>;
<a name="l00957"></a>00957 
<a name="l00959"></a><a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#ad2657fa4f52fca64a52ab9632cce72e7">00959</a>             <span class="keyword">struct </span><a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html" title="Structure for each slot in the cache hash array.">HashCell</a>     *<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#ad2657fa4f52fca64a52ab9632cce72e7" title="pointer backward in LRU double-linked list">list_prev</a>;
<a name="l00960"></a>00960 
<a name="l00961"></a>00961 <span class="preprocessor">#ifdef CBTREEDB_SELF_VERIFY</span>
<a name="l00962"></a>00962 <span class="preprocessor"></span>
<a name="l00963"></a><a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#af45d319c1413b303e4ee27f5be97a356">00963</a>             uint32_t    <a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#af45d319c1413b303e4ee27f5be97a356" title="virtual LRU timestamp, just for testing.">lrutime</a>;
<a name="l00964"></a>00964 <span class="preprocessor">#endif</span>
<a name="l00965"></a>00965 <span class="preprocessor"></span>
<a name="l00967"></a><a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#a32b81aebcf3c42a75777810c63adb39f">00967</a>             <span class="keywordtype">void</span>*       <a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#a32b81aebcf3c42a75777810c63adb39f" title="b-tree object identifier of page">btreeid</a>;
<a name="l00968"></a>00968 
<a name="l00970"></a><a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#a50dc4884244b683b06c11f46980f88f5">00970</a>             uint32_t    <a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#a50dc4884244b683b06c11f46980f88f5" title="page identifier withing b-tree">pageid</a>;
<a name="l00971"></a>00971 
<a name="l00973"></a><a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#a56dd6d4d2db6507d8788009e3c0fd586">00973</a>             <a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html" title="BTreePage is a reference-counted buffer holding one page of the B-tree index.">BTreePage</a>   <a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#a56dd6d4d2db6507d8788009e3c0fd586" title="page holder object">page</a>;
<a name="l00974"></a>00974         };
<a name="l00975"></a>00975 
<a name="l00977"></a><a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#aaf204547ceb5104c7e2c52d8ed3ba51c">00977</a>         std::vector&lt;struct HashCell*&gt; <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#aaf204547ceb5104c7e2c52d8ed3ba51c" title="hash cell array holding pointers to active cells">m_hasharray</a>;
<a name="l00978"></a>00978 
<a name="l00983"></a><a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a8303984f028cf8b6e677e31a7d1a024f">00983</a>         <span class="keyword">struct </span><a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html" title="Structure for each slot in the cache hash array.">HashCell</a> <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a8303984f028cf8b6e677e31a7d1a024f" title="sentinel hash cell for LRU double-linked list.">m_sentinel</a>;
<a name="l00984"></a>00984 
<a name="l00986"></a><a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#ace962f2c775c68fa0d7a72d25f3365e5">00986</a>         <span class="keyword">inline</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#ace962f2c775c68fa0d7a72d25f3365e5" title="Simple hash function mapping (btreeid,pageid) -&amp;gt; bucket.">hashfunc</a>(<span class="keywordtype">void</span>* btreeid, uint32_t pageid)
<a name="l00987"></a>00987         {
<a name="l00988"></a>00988             <span class="comment">// since hot pageids are usually ascending, I guess this is a</span>
<a name="l00989"></a>00989             <span class="comment">// pretty good hash function.</span>
<a name="l00990"></a>00990             <span class="keywordflow">return</span> (reinterpret_cast&lt;uintptr_t&gt;(btreeid) + pageid) % <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#aaf204547ceb5104c7e2c52d8ed3ba51c" title="hash cell array holding pointers to active cells">m_hasharray</a>.size();
<a name="l00991"></a>00991         }
<a name="l00992"></a>00992 
<a name="l00993"></a>00993     <span class="keyword">public</span>:
<a name="l00995"></a><a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#ab7a846097add9cc3cb6a0add82d882c9">00995</a>         <span class="keyword">explicit</span> <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#ab7a846097add9cc3cb6a0add82d882c9" title="Create a new page cache containg maxsize pages.">PageCacheImpl</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> maxsize)
<a name="l00996"></a>00996             : <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#aa61ab668cc01a70967d2b48d06ae8042" title="reference counter">m_refs</a>(0), <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a05f9db14ab63c23c66dd285c27bb3830" title="maximum number of pages in cache">m_maxsize</a>(maxsize), <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a1f1fb6a254e1828a526766a50976fe40" title="current number of pages in cache">m_size</a>(0)
<a name="l00997"></a>00997         {
<a name="l00998"></a>00998             <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#aaf204547ceb5104c7e2c52d8ed3ba51c" title="hash cell array holding pointers to active cells">m_hasharray</a>.resize(<a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a05f9db14ab63c23c66dd285c27bb3830" title="maximum number of pages in cache">m_maxsize</a> / 2, NULL);
<a name="l00999"></a>00999 
<a name="l01000"></a>01000             <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a8303984f028cf8b6e677e31a7d1a024f" title="sentinel hash cell for LRU double-linked list.">m_sentinel</a>.<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#ad2657fa4f52fca64a52ab9632cce72e7" title="pointer backward in LRU double-linked list">list_prev</a> = <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a8303984f028cf8b6e677e31a7d1a024f" title="sentinel hash cell for LRU double-linked list.">m_sentinel</a>.<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#ab5eac48c386b5bbe0ef9dadc148e87ac" title="pointer forward in LRU double-linked list">list_next</a> = &amp;<a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a8303984f028cf8b6e677e31a7d1a024f" title="sentinel hash cell for LRU double-linked list.">m_sentinel</a>;
<a name="l01001"></a>01001 <span class="preprocessor">#ifdef CBTREEDB_SELF_VERIFY</span>
<a name="l01002"></a>01002 <span class="preprocessor"></span>            <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a4653f52d6b2fc7678c2c7d84ae80c020" title="counter to tag pages with a virtual LRU timestamp.">m_lrutime</a> = 0;
<a name="l01003"></a>01003             <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a8303984f028cf8b6e677e31a7d1a024f" title="sentinel hash cell for LRU double-linked list.">m_sentinel</a>.<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#af45d319c1413b303e4ee27f5be97a356" title="virtual LRU timestamp, just for testing.">lrutime</a> = 0;
<a name="l01004"></a>01004 <span class="preprocessor">#endif</span>
<a name="l01005"></a>01005 <span class="preprocessor"></span>        }
<a name="l01006"></a>01006 
<a name="l01008"></a><a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a6fda39de4fe5301926e05bd36fcdac81">01008</a>         <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a6fda39de4fe5301926e05bd36fcdac81" title="Removes all cached pages and destroys cache.">~PageCacheImpl</a>()
<a name="l01009"></a>01009         {
<a name="l01010"></a>01010             <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a8112847c7c7860676cc7da642aa782c7" title="Remove all pages from the cache and reset status.">Clear</a>();
<a name="l01011"></a>01011         }
<a name="l01012"></a>01012 
<a name="l01014"></a><a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a202e03ec9d41ef40782ef382dfa37ec2">01014</a>         <span class="keywordtype">void</span> <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a202e03ec9d41ef40782ef382dfa37ec2" title="Increment reference counter by one.">RefInc</a>()
<a name="l01015"></a>01015         {
<a name="l01016"></a>01016             ++<a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#aa61ab668cc01a70967d2b48d06ae8042" title="reference counter">m_refs</a>;
<a name="l01017"></a>01017         }
<a name="l01018"></a>01018 
<a name="l01020"></a><a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a40ca7714265adac0114dc02f48d3130d">01020</a>         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a40ca7714265adac0114dc02f48d3130d" title="Decrement reference counter by one and return it.">RefDec</a>()
<a name="l01021"></a>01021         {
<a name="l01022"></a>01022             <span class="keywordflow">return</span> --<a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#aa61ab668cc01a70967d2b48d06ae8042" title="reference counter">m_refs</a>;
<a name="l01023"></a>01023         }
<a name="l01024"></a>01024 
<a name="l01026"></a><a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a8112847c7c7860676cc7da642aa782c7">01026</a>         <span class="keywordtype">void</span> <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a8112847c7c7860676cc7da642aa782c7" title="Remove all pages from the cache and reset status.">Clear</a>()
<a name="l01027"></a>01027         {
<a name="l01028"></a>01028             <span class="comment">// free up hash cells</span>
<a name="l01029"></a>01029             <span class="keyword">struct </span><a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html" title="Structure for each slot in the cache hash array.">HashCell</a>* hc = <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a8303984f028cf8b6e677e31a7d1a024f" title="sentinel hash cell for LRU double-linked list.">m_sentinel</a>.<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#ab5eac48c386b5bbe0ef9dadc148e87ac" title="pointer forward in LRU double-linked list">list_next</a>;
<a name="l01030"></a>01030             <span class="keywordflow">while</span> (hc != &amp;<a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a8303984f028cf8b6e677e31a7d1a024f" title="sentinel hash cell for LRU double-linked list.">m_sentinel</a>)
<a name="l01031"></a>01031             {
<a name="l01032"></a>01032                 <span class="keyword">struct </span><a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html" title="Structure for each slot in the cache hash array.">HashCell</a>* nc = hc-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#ab5eac48c386b5bbe0ef9dadc148e87ac" title="pointer forward in LRU double-linked list">list_next</a>;
<a name="l01033"></a>01033                 <span class="keyword">delete</span> hc;
<a name="l01034"></a>01034                 hc = nc;
<a name="l01035"></a>01035             }
<a name="l01036"></a>01036 
<a name="l01037"></a>01037             <span class="comment">// zero hash array</span>
<a name="l01038"></a>01038             <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#aaf204547ceb5104c7e2c52d8ed3ba51c" title="hash cell array holding pointers to active cells">m_hasharray</a>.size(); ++i)
<a name="l01039"></a>01039                 <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#aaf204547ceb5104c7e2c52d8ed3ba51c" title="hash cell array holding pointers to active cells">m_hasharray</a>[i] = NULL;
<a name="l01040"></a>01040 
<a name="l01041"></a>01041             <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a8303984f028cf8b6e677e31a7d1a024f" title="sentinel hash cell for LRU double-linked list.">m_sentinel</a>.<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#ad2657fa4f52fca64a52ab9632cce72e7" title="pointer backward in LRU double-linked list">list_prev</a> = <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a8303984f028cf8b6e677e31a7d1a024f" title="sentinel hash cell for LRU double-linked list.">m_sentinel</a>.<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#ab5eac48c386b5bbe0ef9dadc148e87ac" title="pointer forward in LRU double-linked list">list_next</a> = &amp;<a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a8303984f028cf8b6e677e31a7d1a024f" title="sentinel hash cell for LRU double-linked list.">m_sentinel</a>;
<a name="l01042"></a>01042             <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a1f1fb6a254e1828a526766a50976fe40" title="current number of pages in cache">m_size</a> = 0;
<a name="l01043"></a>01043 <span class="preprocessor">#ifdef CBTREEDB_SELF_VERIFY</span>
<a name="l01044"></a>01044 <span class="preprocessor"></span>            <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a8303984f028cf8b6e677e31a7d1a024f" title="sentinel hash cell for LRU double-linked list.">m_sentinel</a>.<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#af45d319c1413b303e4ee27f5be97a356" title="virtual LRU timestamp, just for testing.">lrutime</a> = 0;
<a name="l01045"></a>01045             <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a4653f52d6b2fc7678c2c7d84ae80c020" title="counter to tag pages with a virtual LRU timestamp.">m_lrutime</a> = 0;
<a name="l01046"></a>01046 <span class="preprocessor">#endif</span>
<a name="l01047"></a>01047 <span class="preprocessor"></span>        }
<a name="l01048"></a>01048 
<a name="l01050"></a><a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#addefddb279e03e197f0af71046a82d54">01050</a>         <span class="keywordtype">void</span> <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#addefddb279e03e197f0af71046a82d54" title="Store a page object in a cache cell identified by (btreeid,pageid).">Store</a>(<span class="keywordtype">void</span>* btreeid, uint32_t pageid, <span class="keyword">const</span> <a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html" title="BTreePage is a reference-counted buffer holding one page of the B-tree index.">BTreePage</a>&amp; page)
<a name="l01051"></a>01051         {
<a name="l01052"></a>01052             <span class="comment">// check whether its already in the cache</span>
<a name="l01053"></a>01053 
<a name="l01054"></a>01054             <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> h = <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#ace962f2c775c68fa0d7a72d25f3365e5" title="Simple hash function mapping (btreeid,pageid) -&amp;gt; bucket.">hashfunc</a>(btreeid, pageid);
<a name="l01055"></a>01055 
<a name="l01056"></a>01056             <span class="keyword">struct </span><a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html" title="Structure for each slot in the cache hash array.">HashCell</a>* hc = <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#aaf204547ceb5104c7e2c52d8ed3ba51c" title="hash cell array holding pointers to active cells">m_hasharray</a>[h];
<a name="l01057"></a>01057 
<a name="l01058"></a>01058             <span class="keywordflow">while</span>( hc &amp;&amp; ! (hc-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#a32b81aebcf3c42a75777810c63adb39f" title="b-tree object identifier of page">btreeid</a> == btreeid &amp;&amp; hc-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#a50dc4884244b683b06c11f46980f88f5" title="page identifier withing b-tree">pageid</a> == pageid) )
<a name="l01059"></a>01059             {
<a name="l01060"></a>01060                 <span class="comment">// advance in bucket list</span>
<a name="l01061"></a>01061                 hc = hc-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#a432bdc79bc3f5aeca7008740771e8598" title="pointer forward to next hash cell in bucket">bucket_next</a>;
<a name="l01062"></a>01062             }
<a name="l01063"></a>01063 
<a name="l01064"></a>01064             <span class="keywordflow">if</span> ( hc ) <span class="comment">// found in cache: unlink from LRU list and place in front</span>
<a name="l01065"></a>01065             {
<a name="l01066"></a>01066                 <span class="keywordflow">if</span> (hc != <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a8303984f028cf8b6e677e31a7d1a024f" title="sentinel hash cell for LRU double-linked list.">m_sentinel</a>.<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#ab5eac48c386b5bbe0ef9dadc148e87ac" title="pointer forward in LRU double-linked list">list_next</a>)
<a name="l01067"></a>01067                 {
<a name="l01068"></a>01068                     <span class="comment">// remove cell wherever it is</span>
<a name="l01069"></a>01069                     hc-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#ab5eac48c386b5bbe0ef9dadc148e87ac" title="pointer forward in LRU double-linked list">list_next</a>-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#ad2657fa4f52fca64a52ab9632cce72e7" title="pointer backward in LRU double-linked list">list_prev</a> = hc-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#ad2657fa4f52fca64a52ab9632cce72e7" title="pointer backward in LRU double-linked list">list_prev</a>;
<a name="l01070"></a>01070                     hc-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#ad2657fa4f52fca64a52ab9632cce72e7" title="pointer backward in LRU double-linked list">list_prev</a>-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#ab5eac48c386b5bbe0ef9dadc148e87ac" title="pointer forward in LRU double-linked list">list_next</a> = hc-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#ab5eac48c386b5bbe0ef9dadc148e87ac" title="pointer forward in LRU double-linked list">list_next</a>;
<a name="l01071"></a>01071 
<a name="l01072"></a>01072                     <span class="comment">// place at head</span>
<a name="l01073"></a>01073                     hc-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#ad2657fa4f52fca64a52ab9632cce72e7" title="pointer backward in LRU double-linked list">list_prev</a> = &amp;<a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a8303984f028cf8b6e677e31a7d1a024f" title="sentinel hash cell for LRU double-linked list.">m_sentinel</a>;
<a name="l01074"></a>01074                     hc-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#ab5eac48c386b5bbe0ef9dadc148e87ac" title="pointer forward in LRU double-linked list">list_next</a> = <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a8303984f028cf8b6e677e31a7d1a024f" title="sentinel hash cell for LRU double-linked list.">m_sentinel</a>.<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#ab5eac48c386b5bbe0ef9dadc148e87ac" title="pointer forward in LRU double-linked list">list_next</a>;
<a name="l01075"></a>01075                     <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a8303984f028cf8b6e677e31a7d1a024f" title="sentinel hash cell for LRU double-linked list.">m_sentinel</a>.<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#ab5eac48c386b5bbe0ef9dadc148e87ac" title="pointer forward in LRU double-linked list">list_next</a>-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#ad2657fa4f52fca64a52ab9632cce72e7" title="pointer backward in LRU double-linked list">list_prev</a> = hc;
<a name="l01076"></a>01076                     <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a8303984f028cf8b6e677e31a7d1a024f" title="sentinel hash cell for LRU double-linked list.">m_sentinel</a>.<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#ab5eac48c386b5bbe0ef9dadc148e87ac" title="pointer forward in LRU double-linked list">list_next</a> = hc;
<a name="l01077"></a>01077 
<a name="l01078"></a>01078                     <span class="comment">// copy page, it may have changed</span>
<a name="l01079"></a>01079                     hc-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#a56dd6d4d2db6507d8788009e3c0fd586" title="page holder object">page</a> = page;
<a name="l01080"></a>01080 
<a name="l01081"></a>01081 <span class="preprocessor">#ifdef CBTREEDB_SELF_VERIFY</span>
<a name="l01082"></a>01082 <span class="preprocessor"></span>                    hc-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#af45d319c1413b303e4ee27f5be97a356" title="virtual LRU timestamp, just for testing.">lrutime</a> = ++<a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a4653f52d6b2fc7678c2c7d84ae80c020" title="counter to tag pages with a virtual LRU timestamp.">m_lrutime</a>;
<a name="l01083"></a>01083 <span class="preprocessor">#endif</span>
<a name="l01084"></a>01084 <span class="preprocessor"></span>                }
<a name="l01085"></a>01085                 <span class="comment">// else hc is the head -&gt; do nothing.</span>
<a name="l01086"></a>01086             }
<a name="l01087"></a>01087             <span class="keywordflow">else</span> <span class="comment">// not found in cache.</span>
<a name="l01088"></a>01088             {
<a name="l01089"></a>01089                 <span class="comment">// remove last page in LRU list if necessary</span>
<a name="l01090"></a>01090                 <span class="keywordflow">while</span> (<a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a1f1fb6a254e1828a526766a50976fe40" title="current number of pages in cache">m_size</a> &gt;= <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a05f9db14ab63c23c66dd285c27bb3830" title="maximum number of pages in cache">m_maxsize</a>)
<a name="l01091"></a>01091                 {
<a name="l01092"></a>01092                     <span class="keyword">struct </span><a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html" title="Structure for each slot in the cache hash array.">HashCell</a>* lc = <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a8303984f028cf8b6e677e31a7d1a024f" title="sentinel hash cell for LRU double-linked list.">m_sentinel</a>.<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#ad2657fa4f52fca64a52ab9632cce72e7" title="pointer backward in LRU double-linked list">list_prev</a>;
<a name="l01093"></a>01093 
<a name="l01094"></a>01094                     <a class="code" href="stx-cbtreedb_8h.html#ab44bd6c500e8dbe3a232e4c44f28b67e" title="Instead of assert() we use this macro to throw exceptions.">CBTREEDB_ASSERT</a>( lc != &amp;<a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a8303984f028cf8b6e677e31a7d1a024f" title="sentinel hash cell for LRU double-linked list.">m_sentinel</a> );
<a name="l01095"></a>01095 
<a name="l01096"></a>01096                     <span class="comment">// unlink from bucket list</span>
<a name="l01097"></a>01097                     <span class="keywordflow">if</span> (reinterpret_cast&lt;uintptr_t&gt;(lc-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#a6d4606e30f353825a81d031472e2ebcb" title="pointer backward to previous hash cell in bucket">bucket_prev</a>) &gt; <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#aaf204547ceb5104c7e2c52d8ed3ba51c" title="hash cell array holding pointers to active cells">m_hasharray</a>.size())
<a name="l01098"></a>01098                     {
<a name="l01099"></a>01099                         <span class="keywordflow">if</span> (lc-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#a432bdc79bc3f5aeca7008740771e8598" title="pointer forward to next hash cell in bucket">bucket_next</a>)
<a name="l01100"></a>01100                             lc-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#a432bdc79bc3f5aeca7008740771e8598" title="pointer forward to next hash cell in bucket">bucket_next</a>-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#a6d4606e30f353825a81d031472e2ebcb" title="pointer backward to previous hash cell in bucket">bucket_prev</a> = lc-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#a6d4606e30f353825a81d031472e2ebcb" title="pointer backward to previous hash cell in bucket">bucket_prev</a>;
<a name="l01101"></a>01101 
<a name="l01102"></a>01102                         lc-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#a6d4606e30f353825a81d031472e2ebcb" title="pointer backward to previous hash cell in bucket">bucket_prev</a>-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#a432bdc79bc3f5aeca7008740771e8598" title="pointer forward to next hash cell in bucket">bucket_next</a> = lc-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#a432bdc79bc3f5aeca7008740771e8598" title="pointer forward to next hash cell in bucket">bucket_next</a>;
<a name="l01103"></a>01103                     }
<a name="l01104"></a>01104                     <span class="keywordflow">else</span> <span class="comment">// at first place in bucket list</span>
<a name="l01105"></a>01105                     {
<a name="l01106"></a>01106                         <span class="keywordflow">if</span> (lc-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#a432bdc79bc3f5aeca7008740771e8598" title="pointer forward to next hash cell in bucket">bucket_next</a>)
<a name="l01107"></a>01107                             lc-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#a432bdc79bc3f5aeca7008740771e8598" title="pointer forward to next hash cell in bucket">bucket_next</a>-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#a6d4606e30f353825a81d031472e2ebcb" title="pointer backward to previous hash cell in bucket">bucket_prev</a> = lc-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#a6d4606e30f353825a81d031472e2ebcb" title="pointer backward to previous hash cell in bucket">bucket_prev</a>;
<a name="l01108"></a>01108 
<a name="l01109"></a>01109                         <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#aaf204547ceb5104c7e2c52d8ed3ba51c" title="hash cell array holding pointers to active cells">m_hasharray</a>[ <span class="keyword">reinterpret_cast&lt;</span>uintptr_t<span class="keyword">&gt;</span>(lc-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#a6d4606e30f353825a81d031472e2ebcb" title="pointer backward to previous hash cell in bucket">bucket_prev</a>) ] = lc-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#a432bdc79bc3f5aeca7008740771e8598" title="pointer forward to next hash cell in bucket">bucket_next</a>;
<a name="l01110"></a>01110                     }
<a name="l01111"></a>01111 
<a name="l01112"></a>01112                     <span class="comment">// unlink from LRU list</span>
<a name="l01113"></a>01113                     lc-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#ab5eac48c386b5bbe0ef9dadc148e87ac" title="pointer forward in LRU double-linked list">list_next</a>-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#ad2657fa4f52fca64a52ab9632cce72e7" title="pointer backward in LRU double-linked list">list_prev</a> = lc-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#ad2657fa4f52fca64a52ab9632cce72e7" title="pointer backward in LRU double-linked list">list_prev</a>;
<a name="l01114"></a>01114                     lc-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#ad2657fa4f52fca64a52ab9632cce72e7" title="pointer backward in LRU double-linked list">list_prev</a>-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#ab5eac48c386b5bbe0ef9dadc148e87ac" title="pointer forward in LRU double-linked list">list_next</a> = lc-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#ab5eac48c386b5bbe0ef9dadc148e87ac" title="pointer forward in LRU double-linked list">list_next</a>;
<a name="l01115"></a>01115 
<a name="l01116"></a>01116                     <span class="keyword">delete</span> lc;
<a name="l01117"></a>01117 
<a name="l01118"></a>01118                     --<a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a1f1fb6a254e1828a526766a50976fe40" title="current number of pages in cache">m_size</a>;
<a name="l01119"></a>01119                 }
<a name="l01120"></a>01120 
<a name="l01121"></a>01121                 <span class="comment">// create new hash cell</span>
<a name="l01122"></a>01122                 hc = <span class="keyword">new</span> <a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html" title="Structure for each slot in the cache hash array.">HashCell</a>;
<a name="l01123"></a>01123 
<a name="l01124"></a>01124 <span class="preprocessor">#ifdef CBTREEDB_SELF_VERIFY</span>
<a name="l01125"></a>01125 <span class="preprocessor"></span>                hc-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#af45d319c1413b303e4ee27f5be97a356" title="virtual LRU timestamp, just for testing.">lrutime</a> = ++<a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a4653f52d6b2fc7678c2c7d84ae80c020" title="counter to tag pages with a virtual LRU timestamp.">m_lrutime</a>;
<a name="l01126"></a>01126 <span class="preprocessor">#endif</span>
<a name="l01127"></a>01127 <span class="preprocessor"></span>                hc-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#a32b81aebcf3c42a75777810c63adb39f" title="b-tree object identifier of page">btreeid</a> = btreeid;
<a name="l01128"></a>01128                 hc-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#a50dc4884244b683b06c11f46980f88f5" title="page identifier withing b-tree">pageid</a> = pageid;
<a name="l01129"></a>01129                 hc-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#a56dd6d4d2db6507d8788009e3c0fd586" title="page holder object">page</a> = page;
<a name="l01130"></a>01130 
<a name="l01131"></a>01131                 <span class="comment">// set hash cell as head of LRU list</span>
<a name="l01132"></a>01132                 hc-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#ad2657fa4f52fca64a52ab9632cce72e7" title="pointer backward in LRU double-linked list">list_prev</a> = &amp;<a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a8303984f028cf8b6e677e31a7d1a024f" title="sentinel hash cell for LRU double-linked list.">m_sentinel</a>;
<a name="l01133"></a>01133                 hc-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#ab5eac48c386b5bbe0ef9dadc148e87ac" title="pointer forward in LRU double-linked list">list_next</a> = <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a8303984f028cf8b6e677e31a7d1a024f" title="sentinel hash cell for LRU double-linked list.">m_sentinel</a>.<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#ab5eac48c386b5bbe0ef9dadc148e87ac" title="pointer forward in LRU double-linked list">list_next</a>;
<a name="l01134"></a>01134                 <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a8303984f028cf8b6e677e31a7d1a024f" title="sentinel hash cell for LRU double-linked list.">m_sentinel</a>.<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#ab5eac48c386b5bbe0ef9dadc148e87ac" title="pointer forward in LRU double-linked list">list_next</a>-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#ad2657fa4f52fca64a52ab9632cce72e7" title="pointer backward in LRU double-linked list">list_prev</a> = hc;
<a name="l01135"></a>01135                 <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a8303984f028cf8b6e677e31a7d1a024f" title="sentinel hash cell for LRU double-linked list.">m_sentinel</a>.<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#ab5eac48c386b5bbe0ef9dadc148e87ac" title="pointer forward in LRU double-linked list">list_next</a> = hc;
<a name="l01136"></a>01136 
<a name="l01137"></a>01137                 <span class="comment">// insert new hash cell to correct bucket</span>
<a name="l01138"></a>01138                 hc-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#a6d4606e30f353825a81d031472e2ebcb" title="pointer backward to previous hash cell in bucket">bucket_prev</a> = <span class="keyword">reinterpret_cast&lt;</span><a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html" title="Structure for each slot in the cache hash array.">HashCell</a>*<span class="keyword">&gt;</span>( h );
<a name="l01139"></a>01139                 hc-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#a432bdc79bc3f5aeca7008740771e8598" title="pointer forward to next hash cell in bucket">bucket_next</a> = <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#aaf204547ceb5104c7e2c52d8ed3ba51c" title="hash cell array holding pointers to active cells">m_hasharray</a>[h];
<a name="l01140"></a>01140 
<a name="l01141"></a>01141                 <span class="keywordflow">if</span> (<a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#aaf204547ceb5104c7e2c52d8ed3ba51c" title="hash cell array holding pointers to active cells">m_hasharray</a>[h])
<a name="l01142"></a>01142                     <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#aaf204547ceb5104c7e2c52d8ed3ba51c" title="hash cell array holding pointers to active cells">m_hasharray</a>[h]-&gt;bucket_prev = hc;
<a name="l01143"></a>01143 
<a name="l01144"></a>01144                 <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#aaf204547ceb5104c7e2c52d8ed3ba51c" title="hash cell array holding pointers to active cells">m_hasharray</a>[h] = hc;
<a name="l01145"></a>01145 
<a name="l01146"></a>01146                 ++<a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a1f1fb6a254e1828a526766a50976fe40" title="current number of pages in cache">m_size</a>;
<a name="l01147"></a>01147             }
<a name="l01148"></a>01148 
<a name="l01149"></a>01149 <span class="preprocessor">#ifdef CBTREEDB_SELF_VERIFY</span>
<a name="l01150"></a>01150 <span class="preprocessor"></span>            <a class="code" href="stx-cbtreedb_8h.html#ab44bd6c500e8dbe3a232e4c44f28b67e" title="Instead of assert() we use this macro to throw exceptions.">CBTREEDB_ASSERT</a>( <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a55253391a04d3a208864b32e80dc806c" title="Verify the integrity of the LRU list and hash table.">Verify</a>() );
<a name="l01151"></a>01151 <span class="preprocessor">#endif</span>
<a name="l01152"></a>01152 <span class="preprocessor"></span>        }
<a name="l01153"></a>01153 
<a name="l01156"></a><a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a53df7ae7011153b01a32f1d27d0831ff">01156</a>         <span class="keywordtype">bool</span> <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a53df7ae7011153b01a32f1d27d0831ff" title="Retrieve a cached page identified by (btreeid,pageid).">Retrieve</a>(<span class="keywordtype">void</span>* btreeid, uint32_t pageid, <a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html" title="BTreePage is a reference-counted buffer holding one page of the B-tree index.">BTreePage</a>&amp; outpage)
<a name="l01157"></a>01157         {
<a name="l01158"></a>01158             <span class="comment">// check whether its in the cache</span>
<a name="l01159"></a>01159 
<a name="l01160"></a>01160             <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> h = <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#ace962f2c775c68fa0d7a72d25f3365e5" title="Simple hash function mapping (btreeid,pageid) -&amp;gt; bucket.">hashfunc</a>(btreeid, pageid);
<a name="l01161"></a>01161 
<a name="l01162"></a>01162             <span class="keyword">struct </span><a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html" title="Structure for each slot in the cache hash array.">HashCell</a>* hc = <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#aaf204547ceb5104c7e2c52d8ed3ba51c" title="hash cell array holding pointers to active cells">m_hasharray</a>[h];
<a name="l01163"></a>01163 
<a name="l01164"></a>01164             <span class="keywordflow">while</span>( hc &amp;&amp; ! (hc-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#a32b81aebcf3c42a75777810c63adb39f" title="b-tree object identifier of page">btreeid</a> == btreeid &amp;&amp; hc-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#a50dc4884244b683b06c11f46980f88f5" title="page identifier withing b-tree">pageid</a> == pageid) )
<a name="l01165"></a>01165             {
<a name="l01166"></a>01166                 <span class="comment">// advance in bucket list</span>
<a name="l01167"></a>01167                 hc = hc-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#a432bdc79bc3f5aeca7008740771e8598" title="pointer forward to next hash cell in bucket">bucket_next</a>;
<a name="l01168"></a>01168             }
<a name="l01169"></a>01169 
<a name="l01170"></a>01170             <span class="keywordflow">if</span> ( hc ) <span class="comment">// found in cache: unlink from LRU list and place in front</span>
<a name="l01171"></a>01171             {
<a name="l01172"></a>01172                 <span class="keywordflow">if</span> (hc != <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a8303984f028cf8b6e677e31a7d1a024f" title="sentinel hash cell for LRU double-linked list.">m_sentinel</a>.<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#ab5eac48c386b5bbe0ef9dadc148e87ac" title="pointer forward in LRU double-linked list">list_next</a>)
<a name="l01173"></a>01173                 {
<a name="l01174"></a>01174                     <span class="comment">// remove cell wherever it is</span>
<a name="l01175"></a>01175                     hc-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#ab5eac48c386b5bbe0ef9dadc148e87ac" title="pointer forward in LRU double-linked list">list_next</a>-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#ad2657fa4f52fca64a52ab9632cce72e7" title="pointer backward in LRU double-linked list">list_prev</a> = hc-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#ad2657fa4f52fca64a52ab9632cce72e7" title="pointer backward in LRU double-linked list">list_prev</a>;
<a name="l01176"></a>01176                     hc-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#ad2657fa4f52fca64a52ab9632cce72e7" title="pointer backward in LRU double-linked list">list_prev</a>-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#ab5eac48c386b5bbe0ef9dadc148e87ac" title="pointer forward in LRU double-linked list">list_next</a> = hc-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#ab5eac48c386b5bbe0ef9dadc148e87ac" title="pointer forward in LRU double-linked list">list_next</a>;
<a name="l01177"></a>01177 
<a name="l01178"></a>01178                     <span class="comment">// place at head</span>
<a name="l01179"></a>01179                     hc-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#ad2657fa4f52fca64a52ab9632cce72e7" title="pointer backward in LRU double-linked list">list_prev</a> = &amp;<a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a8303984f028cf8b6e677e31a7d1a024f" title="sentinel hash cell for LRU double-linked list.">m_sentinel</a>;
<a name="l01180"></a>01180                     hc-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#ab5eac48c386b5bbe0ef9dadc148e87ac" title="pointer forward in LRU double-linked list">list_next</a> = <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a8303984f028cf8b6e677e31a7d1a024f" title="sentinel hash cell for LRU double-linked list.">m_sentinel</a>.<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#ab5eac48c386b5bbe0ef9dadc148e87ac" title="pointer forward in LRU double-linked list">list_next</a>;
<a name="l01181"></a>01181                     <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a8303984f028cf8b6e677e31a7d1a024f" title="sentinel hash cell for LRU double-linked list.">m_sentinel</a>.<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#ab5eac48c386b5bbe0ef9dadc148e87ac" title="pointer forward in LRU double-linked list">list_next</a>-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#ad2657fa4f52fca64a52ab9632cce72e7" title="pointer backward in LRU double-linked list">list_prev</a> = hc;
<a name="l01182"></a>01182                     <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a8303984f028cf8b6e677e31a7d1a024f" title="sentinel hash cell for LRU double-linked list.">m_sentinel</a>.<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#ab5eac48c386b5bbe0ef9dadc148e87ac" title="pointer forward in LRU double-linked list">list_next</a> = hc;
<a name="l01183"></a>01183 
<a name="l01184"></a>01184 <span class="preprocessor">#ifdef CBTREEDB_SELF_VERIFY</span>
<a name="l01185"></a>01185 <span class="preprocessor"></span>                    hc-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#af45d319c1413b303e4ee27f5be97a356" title="virtual LRU timestamp, just for testing.">lrutime</a> = ++<a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a4653f52d6b2fc7678c2c7d84ae80c020" title="counter to tag pages with a virtual LRU timestamp.">m_lrutime</a>;
<a name="l01186"></a>01186 <span class="preprocessor">#endif</span>
<a name="l01187"></a>01187 <span class="preprocessor"></span>                }
<a name="l01188"></a>01188                 <span class="comment">// else hc is the head -&gt; do nothing.</span>
<a name="l01189"></a>01189 
<a name="l01190"></a>01190                 outpage = hc-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#a56dd6d4d2db6507d8788009e3c0fd586" title="page holder object">page</a>;
<a name="l01191"></a>01191 
<a name="l01192"></a>01192 <span class="preprocessor">#ifdef CBTREEDB_SELF_VERIFY</span>
<a name="l01193"></a>01193 <span class="preprocessor"></span>                <a class="code" href="stx-cbtreedb_8h.html#ab44bd6c500e8dbe3a232e4c44f28b67e" title="Instead of assert() we use this macro to throw exceptions.">CBTREEDB_ASSERT</a>( <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a55253391a04d3a208864b32e80dc806c" title="Verify the integrity of the LRU list and hash table.">Verify</a>() );
<a name="l01194"></a>01194 <span class="preprocessor">#endif</span>
<a name="l01195"></a>01195 <span class="preprocessor"></span>                <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01196"></a>01196             }
<a name="l01197"></a>01197             <span class="keywordflow">else</span>
<a name="l01198"></a>01198             {
<a name="l01199"></a>01199 <span class="preprocessor">#ifdef CBTREEDB_SELF_VERIFY</span>
<a name="l01200"></a>01200 <span class="preprocessor"></span>                <a class="code" href="stx-cbtreedb_8h.html#ab44bd6c500e8dbe3a232e4c44f28b67e" title="Instead of assert() we use this macro to throw exceptions.">CBTREEDB_ASSERT</a>( <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a55253391a04d3a208864b32e80dc806c" title="Verify the integrity of the LRU list and hash table.">Verify</a>() );
<a name="l01201"></a>01201 <span class="preprocessor">#endif</span>
<a name="l01202"></a>01202 <span class="preprocessor"></span>                <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01203"></a>01203             }
<a name="l01204"></a>01204         }
<a name="l01205"></a>01205 
<a name="l01208"></a><a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a167e40aeaf2d236a0165e50e387579c9">01208</a>         <span class="keywordtype">void</span> <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a167e40aeaf2d236a0165e50e387579c9" title="Change maximum number of pages in cache, note that this does not immediately have...">SetMaxSize</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> maxsize)
<a name="l01209"></a>01209         {
<a name="l01210"></a>01210             <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a05f9db14ab63c23c66dd285c27bb3830" title="maximum number of pages in cache">m_maxsize</a> = maxsize;
<a name="l01211"></a>01211         }
<a name="l01212"></a>01212 
<a name="l01215"></a><a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a8975e78532ec79f191e0b2551b8340d3">01215</a>         std::vector&lt; std::pair&lt;void*, uint32_t&gt; &gt; <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a8975e78532ec79f191e0b2551b8340d3" title="Return a vector listing all currently contained (btreeid,pageid) pairs in LRU order...">GetPagelist</a>()<span class="keyword"> const</span>
<a name="l01216"></a>01216 <span class="keyword">        </span>{
<a name="l01217"></a>01217             std::vector&lt; std::pair&lt;void*, uint32_t&gt; &gt; v;
<a name="l01218"></a>01218 
<a name="l01219"></a>01219             <span class="keyword">struct </span><a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html" title="Structure for each slot in the cache hash array.">HashCell</a>* hc = <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a8303984f028cf8b6e677e31a7d1a024f" title="sentinel hash cell for LRU double-linked list.">m_sentinel</a>.<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#ab5eac48c386b5bbe0ef9dadc148e87ac" title="pointer forward in LRU double-linked list">list_next</a>;
<a name="l01220"></a>01220 
<a name="l01221"></a>01221             <span class="keywordflow">while</span> (hc != &amp;<a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a8303984f028cf8b6e677e31a7d1a024f" title="sentinel hash cell for LRU double-linked list.">m_sentinel</a>)
<a name="l01222"></a>01222             {
<a name="l01223"></a>01223                 v.push_back( std::make_pair(hc-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#a32b81aebcf3c42a75777810c63adb39f" title="b-tree object identifier of page">btreeid</a>, hc-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#a50dc4884244b683b06c11f46980f88f5" title="page identifier withing b-tree">pageid</a>) );
<a name="l01224"></a>01224                 hc = hc-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#ab5eac48c386b5bbe0ef9dadc148e87ac" title="pointer forward in LRU double-linked list">list_next</a>;
<a name="l01225"></a>01225             }
<a name="l01226"></a>01226 
<a name="l01227"></a>01227             <span class="keywordflow">return</span> v;
<a name="l01228"></a>01228         }
<a name="l01229"></a>01229 
<a name="l01231"></a><a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a55253391a04d3a208864b32e80dc806c">01231</a>         <span class="keywordtype">bool</span> <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a55253391a04d3a208864b32e80dc806c" title="Verify the integrity of the LRU list and hash table.">Verify</a>()<span class="keyword"> const</span>
<a name="l01232"></a>01232 <span class="keyword">        </span>{
<a name="l01233"></a>01233             { <span class="comment">// traverse LRU list forwards</span>
<a name="l01234"></a>01234 
<a name="l01235"></a>01235                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> size = 0;
<a name="l01236"></a>01236                 <span class="keyword">struct </span><a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html" title="Structure for each slot in the cache hash array.">HashCell</a>* hc = <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a8303984f028cf8b6e677e31a7d1a024f" title="sentinel hash cell for LRU double-linked list.">m_sentinel</a>.<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#ab5eac48c386b5bbe0ef9dadc148e87ac" title="pointer forward in LRU double-linked list">list_next</a>;
<a name="l01237"></a>01237 
<a name="l01238"></a>01238                 <span class="keywordflow">while</span> (hc != &amp;<a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a8303984f028cf8b6e677e31a7d1a024f" title="sentinel hash cell for LRU double-linked list.">m_sentinel</a>)
<a name="l01239"></a>01239                 {
<a name="l01240"></a>01240                     <span class="keywordflow">if</span> (!(hc-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#ad2657fa4f52fca64a52ab9632cce72e7" title="pointer backward in LRU double-linked list">list_prev</a>-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#ab5eac48c386b5bbe0ef9dadc148e87ac" title="pointer forward in LRU double-linked list">list_next</a> == hc)) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01241"></a>01241                     <span class="keywordflow">if</span> (!(hc-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#ab5eac48c386b5bbe0ef9dadc148e87ac" title="pointer forward in LRU double-linked list">list_next</a>-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#ad2657fa4f52fca64a52ab9632cce72e7" title="pointer backward in LRU double-linked list">list_prev</a> == hc)) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01242"></a>01242 <span class="preprocessor">#ifdef CBTREEDB_SELF_VERIFY</span>
<a name="l01243"></a>01243 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (!(hc-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#af45d319c1413b303e4ee27f5be97a356" title="virtual LRU timestamp, just for testing.">lrutime</a> &gt; hc-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#ab5eac48c386b5bbe0ef9dadc148e87ac" title="pointer forward in LRU double-linked list">list_next</a>-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#af45d319c1413b303e4ee27f5be97a356" title="virtual LRU timestamp, just for testing.">lrutime</a>)) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01244"></a>01244 <span class="preprocessor">#endif</span>
<a name="l01245"></a>01245 <span class="preprocessor"></span>
<a name="l01246"></a>01246                     ++size;
<a name="l01247"></a>01247                     hc = hc-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#ab5eac48c386b5bbe0ef9dadc148e87ac" title="pointer forward in LRU double-linked list">list_next</a>;
<a name="l01248"></a>01248                 }
<a name="l01249"></a>01249 
<a name="l01250"></a>01250                 <span class="keywordflow">if</span> (size != <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a1f1fb6a254e1828a526766a50976fe40" title="current number of pages in cache">m_size</a>) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01251"></a>01251             }
<a name="l01252"></a>01252 
<a name="l01253"></a>01253             { <span class="comment">// traverse LRU list backwards</span>
<a name="l01254"></a>01254 
<a name="l01255"></a>01255                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> size = 0;
<a name="l01256"></a>01256                 <span class="keyword">struct </span><a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html" title="Structure for each slot in the cache hash array.">HashCell</a>* hc = <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a8303984f028cf8b6e677e31a7d1a024f" title="sentinel hash cell for LRU double-linked list.">m_sentinel</a>.<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#ad2657fa4f52fca64a52ab9632cce72e7" title="pointer backward in LRU double-linked list">list_prev</a>;
<a name="l01257"></a>01257 
<a name="l01258"></a>01258                 <span class="keywordflow">while</span> (hc != &amp;<a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a8303984f028cf8b6e677e31a7d1a024f" title="sentinel hash cell for LRU double-linked list.">m_sentinel</a>)
<a name="l01259"></a>01259                 {
<a name="l01260"></a>01260                     <span class="keywordflow">if</span> (!(hc-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#ad2657fa4f52fca64a52ab9632cce72e7" title="pointer backward in LRU double-linked list">list_prev</a>-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#ab5eac48c386b5bbe0ef9dadc148e87ac" title="pointer forward in LRU double-linked list">list_next</a> == hc)) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01261"></a>01261                     <span class="keywordflow">if</span> (!(hc-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#ab5eac48c386b5bbe0ef9dadc148e87ac" title="pointer forward in LRU double-linked list">list_next</a>-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#ad2657fa4f52fca64a52ab9632cce72e7" title="pointer backward in LRU double-linked list">list_prev</a> == hc)) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01262"></a>01262 <span class="preprocessor">#ifdef CBTREEDB_SELF_VERIFY</span>
<a name="l01263"></a>01263 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (!(hc-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#af45d319c1413b303e4ee27f5be97a356" title="virtual LRU timestamp, just for testing.">lrutime</a> &lt; hc-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#ad2657fa4f52fca64a52ab9632cce72e7" title="pointer backward in LRU double-linked list">list_prev</a>-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#af45d319c1413b303e4ee27f5be97a356" title="virtual LRU timestamp, just for testing.">lrutime</a> || hc-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#ad2657fa4f52fca64a52ab9632cce72e7" title="pointer backward in LRU double-linked list">list_prev</a> == &amp;<a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a8303984f028cf8b6e677e31a7d1a024f" title="sentinel hash cell for LRU double-linked list.">m_sentinel</a>)) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01264"></a>01264 <span class="preprocessor">#endif</span>
<a name="l01265"></a>01265 <span class="preprocessor"></span>
<a name="l01266"></a>01266                     ++size;
<a name="l01267"></a>01267                     hc = hc-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#ad2657fa4f52fca64a52ab9632cce72e7" title="pointer backward in LRU double-linked list">list_prev</a>;
<a name="l01268"></a>01268                 }
<a name="l01269"></a>01269 
<a name="l01270"></a>01270                 <span class="keywordflow">if</span> (size != <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a1f1fb6a254e1828a526766a50976fe40" title="current number of pages in cache">m_size</a>) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01271"></a>01271             }
<a name="l01272"></a>01272 
<a name="l01273"></a>01273             { <span class="comment">// check and count hash cells in buckets</span>
<a name="l01274"></a>01274 
<a name="l01275"></a>01275                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> size = 0;
<a name="l01276"></a>01276 
<a name="l01277"></a>01277                 <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> b = 0; b &lt; <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#aaf204547ceb5104c7e2c52d8ed3ba51c" title="hash cell array holding pointers to active cells">m_hasharray</a>.size(); ++b)
<a name="l01278"></a>01278                 {
<a name="l01279"></a>01279                     <span class="keyword">struct </span><a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html" title="Structure for each slot in the cache hash array.">HashCell</a>* hc = <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#aaf204547ceb5104c7e2c52d8ed3ba51c" title="hash cell array holding pointers to active cells">m_hasharray</a>[b];
<a name="l01280"></a>01280 
<a name="l01281"></a>01281                     <span class="keywordflow">if</span> (!hc) <span class="keywordflow">continue</span>;
<a name="l01282"></a>01282 
<a name="l01283"></a>01283                     <span class="keywordflow">if</span> (!(reinterpret_cast&lt;uintptr_t&gt;(hc-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#a6d4606e30f353825a81d031472e2ebcb" title="pointer backward to previous hash cell in bucket">bucket_prev</a>) == b)) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01284"></a>01284 
<a name="l01285"></a>01285                     ++size;
<a name="l01286"></a>01286 
<a name="l01287"></a>01287                     <span class="keywordflow">while</span> (hc-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#a432bdc79bc3f5aeca7008740771e8598" title="pointer forward to next hash cell in bucket">bucket_next</a> != NULL)
<a name="l01288"></a>01288                     {
<a name="l01289"></a>01289                         <span class="keywordflow">if</span> (!(hc-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#a432bdc79bc3f5aeca7008740771e8598" title="pointer forward to next hash cell in bucket">bucket_next</a>-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#a6d4606e30f353825a81d031472e2ebcb" title="pointer backward to previous hash cell in bucket">bucket_prev</a> == hc)) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01290"></a>01290 
<a name="l01291"></a>01291                         hc = hc-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1PageCacheImpl_1_1HashCell.html#a432bdc79bc3f5aeca7008740771e8598" title="pointer forward to next hash cell in bucket">bucket_next</a>;
<a name="l01292"></a>01292 
<a name="l01293"></a>01293                         ++size;
<a name="l01294"></a>01294                     }
<a name="l01295"></a>01295                 }
<a name="l01296"></a>01296 
<a name="l01297"></a>01297                 <span class="keywordflow">if</span> (size != <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a1f1fb6a254e1828a526766a50976fe40" title="current number of pages in cache">m_size</a>) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01298"></a>01298             }
<a name="l01299"></a>01299 
<a name="l01300"></a>01300             <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01301"></a>01301         }
<a name="l01302"></a>01302     };
<a name="l01303"></a>01303 
<a name="l01304"></a>01304 <span class="keyword">public</span>:
<a name="l01328"></a><a class="code" href="classstx_1_1CBTreeDB_1_1PageCache.html">01328</a>     <span class="keyword">class </span><a class="code" href="classstx_1_1CBTreeDB_1_1PageCache.html" title="PageCache and PageCacheImpl implement a LRU-strategy cache of B-tree pages used by...">PageCache</a>
<a name="l01329"></a>01329     {
<a name="l01330"></a>01330     <span class="keyword">protected</span>:
<a name="l01331"></a>01331 
<a name="l01333"></a><a class="code" href="classstx_1_1CBTreeDB_1_1PageCache.html#afb51be0b908255f7a3117ebab301d37b">01333</a>         <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html" title="PageCache and PageCacheImpl implement a LRU-strategy cache of B-tree pages used by...">PageCacheImpl</a>*  <a class="code" href="classstx_1_1CBTreeDB_1_1PageCache.html#afb51be0b908255f7a3117ebab301d37b" title="pointer to implementation class.">m_impl</a>;
<a name="l01334"></a>01334 
<a name="l01335"></a>01335     <span class="keyword">public</span>:
<a name="l01337"></a><a class="code" href="classstx_1_1CBTreeDB_1_1PageCache.html#af83dd319b302a465457cf7480da9cc96">01337</a>         <span class="keyword">explicit</span> <a class="code" href="classstx_1_1CBTreeDB_1_1PageCache.html#af83dd319b302a465457cf7480da9cc96" title="Create a new page cache containg maxsize pages.">PageCache</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> maxpages)
<a name="l01338"></a>01338             : <a class="code" href="classstx_1_1CBTreeDB_1_1PageCache.html#afb51be0b908255f7a3117ebab301d37b" title="pointer to implementation class.">m_impl</a>(new <a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html" title="PageCache and PageCacheImpl implement a LRU-strategy cache of B-tree pages used by...">PageCacheImpl</a>(maxpages))
<a name="l01339"></a>01339         {
<a name="l01340"></a>01340             <a class="code" href="classstx_1_1CBTreeDB_1_1PageCache.html#afb51be0b908255f7a3117ebab301d37b" title="pointer to implementation class.">m_impl</a>-&gt;<a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a202e03ec9d41ef40782ef382dfa37ec2" title="Increment reference counter by one.">RefInc</a>();
<a name="l01341"></a>01341         }
<a name="l01342"></a>01342 
<a name="l01344"></a><a class="code" href="classstx_1_1CBTreeDB_1_1PageCache.html#a7afc669b22f4c56c4ef97ad26ba43191">01344</a>         <a class="code" href="classstx_1_1CBTreeDB_1_1PageCache.html#af83dd319b302a465457cf7480da9cc96" title="Create a new page cache containg maxsize pages.">PageCache</a>(<span class="keyword">const</span> <a class="code" href="classstx_1_1CBTreeDB_1_1PageCache.html" title="PageCache and PageCacheImpl implement a LRU-strategy cache of B-tree pages used by...">PageCache</a>&amp; pc)
<a name="l01345"></a>01345             : <a class="code" href="classstx_1_1CBTreeDB_1_1PageCache.html#afb51be0b908255f7a3117ebab301d37b" title="pointer to implementation class.">m_impl</a>(pc.<a class="code" href="classstx_1_1CBTreeDB_1_1PageCache.html#afb51be0b908255f7a3117ebab301d37b" title="pointer to implementation class.">m_impl</a>)
<a name="l01346"></a>01346         {
<a name="l01347"></a>01347             <a class="code" href="classstx_1_1CBTreeDB_1_1PageCache.html#afb51be0b908255f7a3117ebab301d37b" title="pointer to implementation class.">m_impl</a>-&gt;<a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a202e03ec9d41ef40782ef382dfa37ec2" title="Increment reference counter by one.">RefInc</a>();
<a name="l01348"></a>01348         }
<a name="l01349"></a>01349 
<a name="l01352"></a><a class="code" href="classstx_1_1CBTreeDB_1_1PageCache.html#a055012636f3ec51c14a2fe4f550477ff">01352</a>         <a class="code" href="classstx_1_1CBTreeDB_1_1PageCache.html#a055012636f3ec51c14a2fe4f550477ff" title="Destructor: decrement reference counter on buffer and possibly deallocate it.">~PageCache</a>()
<a name="l01353"></a>01353         {
<a name="l01354"></a>01354             <span class="keywordflow">if</span> (<a class="code" href="classstx_1_1CBTreeDB_1_1PageCache.html#afb51be0b908255f7a3117ebab301d37b" title="pointer to implementation class.">m_impl</a>-&gt;<a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a40ca7714265adac0114dc02f48d3130d" title="Decrement reference counter by one and return it.">RefDec</a>() == 0)
<a name="l01355"></a>01355                 <span class="keyword">delete</span> <a class="code" href="classstx_1_1CBTreeDB_1_1PageCache.html#afb51be0b908255f7a3117ebab301d37b" title="pointer to implementation class.">m_impl</a>;
<a name="l01356"></a>01356         }
<a name="l01357"></a>01357 
<a name="l01359"></a><a class="code" href="classstx_1_1CBTreeDB_1_1PageCache.html#ad4f4e028805c9899fa1eadb89231f1cb">01359</a>         <a class="code" href="classstx_1_1CBTreeDB_1_1PageCache.html" title="PageCache and PageCacheImpl implement a LRU-strategy cache of B-tree pages used by...">PageCache</a>&amp; <a class="code" href="classstx_1_1CBTreeDB_1_1PageCache.html#ad4f4e028805c9899fa1eadb89231f1cb" title="Assignment Operator: increment reference counter on base object.">operator=</a>(<span class="keyword">const</span> <a class="code" href="classstx_1_1CBTreeDB_1_1PageCache.html" title="PageCache and PageCacheImpl implement a LRU-strategy cache of B-tree pages used by...">PageCache</a>&amp; pc)
<a name="l01360"></a>01360         {
<a name="l01361"></a>01361             <span class="keywordflow">if</span> (<span class="keyword">this</span> != &amp;pc)
<a name="l01362"></a>01362             {
<a name="l01363"></a>01363                 <span class="keywordflow">if</span> (<a class="code" href="classstx_1_1CBTreeDB_1_1PageCache.html#afb51be0b908255f7a3117ebab301d37b" title="pointer to implementation class.">m_impl</a>-&gt;<a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a40ca7714265adac0114dc02f48d3130d" title="Decrement reference counter by one and return it.">RefDec</a>() == 0)
<a name="l01364"></a>01364                     <span class="keyword">delete</span> <a class="code" href="classstx_1_1CBTreeDB_1_1PageCache.html#afb51be0b908255f7a3117ebab301d37b" title="pointer to implementation class.">m_impl</a>;
<a name="l01365"></a>01365 
<a name="l01366"></a>01366                 <a class="code" href="classstx_1_1CBTreeDB_1_1PageCache.html#afb51be0b908255f7a3117ebab301d37b" title="pointer to implementation class.">m_impl</a> = pc.<a class="code" href="classstx_1_1CBTreeDB_1_1PageCache.html#afb51be0b908255f7a3117ebab301d37b" title="pointer to implementation class.">m_impl</a>;
<a name="l01367"></a>01367                 <a class="code" href="classstx_1_1CBTreeDB_1_1PageCache.html#afb51be0b908255f7a3117ebab301d37b" title="pointer to implementation class.">m_impl</a>-&gt;<a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a202e03ec9d41ef40782ef382dfa37ec2" title="Increment reference counter by one.">RefInc</a>();
<a name="l01368"></a>01368             }
<a name="l01369"></a>01369 
<a name="l01370"></a>01370             <span class="keywordflow">return</span> *<span class="keyword">this</span>;
<a name="l01371"></a>01371         }
<a name="l01372"></a>01372 
<a name="l01374"></a><a class="code" href="classstx_1_1CBTreeDB_1_1PageCache.html#a04b7f35187137d7c7805b6e4447d80f2">01374</a>         <span class="keywordtype">void</span> <a class="code" href="classstx_1_1CBTreeDB_1_1PageCache.html#a04b7f35187137d7c7805b6e4447d80f2" title="Remove all pages from the cache and reset status.">Clear</a>()
<a name="l01375"></a>01375         {
<a name="l01376"></a>01376             <span class="keywordflow">return</span> <a class="code" href="classstx_1_1CBTreeDB_1_1PageCache.html#afb51be0b908255f7a3117ebab301d37b" title="pointer to implementation class.">m_impl</a>-&gt;<a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a8112847c7c7860676cc7da642aa782c7" title="Remove all pages from the cache and reset status.">Clear</a>();
<a name="l01377"></a>01377         }
<a name="l01378"></a>01378 
<a name="l01380"></a><a class="code" href="classstx_1_1CBTreeDB_1_1PageCache.html#ad412f513c905581f77fee1390bfebb6a">01380</a>         <span class="keywordtype">void</span> <a class="code" href="classstx_1_1CBTreeDB_1_1PageCache.html#ad412f513c905581f77fee1390bfebb6a" title="Store a page object in a cache cell identified by (btreeid,pageid).">Store</a>(<span class="keywordtype">void</span>* btreeid, uint32_t pageid, <span class="keyword">const</span> <a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html" title="BTreePage is a reference-counted buffer holding one page of the B-tree index.">BTreePage</a>&amp; page)
<a name="l01381"></a>01381         {
<a name="l01382"></a>01382             <span class="keywordflow">return</span> <a class="code" href="classstx_1_1CBTreeDB_1_1PageCache.html#afb51be0b908255f7a3117ebab301d37b" title="pointer to implementation class.">m_impl</a>-&gt;<a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#addefddb279e03e197f0af71046a82d54" title="Store a page object in a cache cell identified by (btreeid,pageid).">Store</a>(btreeid, pageid, page);
<a name="l01383"></a>01383         }
<a name="l01384"></a>01384 
<a name="l01387"></a><a class="code" href="classstx_1_1CBTreeDB_1_1PageCache.html#acdcfec9a6183cfbeb3ad3f6342ef9089">01387</a>         <span class="keywordtype">bool</span> <a class="code" href="classstx_1_1CBTreeDB_1_1PageCache.html#acdcfec9a6183cfbeb3ad3f6342ef9089" title="Retrieve a cached page identified by (btreeid,pageid).">Retrieve</a>(<span class="keywordtype">void</span>* btreeid, uint32_t pageid, <a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html" title="BTreePage is a reference-counted buffer holding one page of the B-tree index.">BTreePage</a>&amp; outpage)
<a name="l01388"></a>01388         {
<a name="l01389"></a>01389             <span class="keywordflow">return</span> <a class="code" href="classstx_1_1CBTreeDB_1_1PageCache.html#afb51be0b908255f7a3117ebab301d37b" title="pointer to implementation class.">m_impl</a>-&gt;<a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a53df7ae7011153b01a32f1d27d0831ff" title="Retrieve a cached page identified by (btreeid,pageid).">Retrieve</a>(btreeid, pageid, outpage);
<a name="l01390"></a>01390         }
<a name="l01391"></a>01391 
<a name="l01394"></a><a class="code" href="classstx_1_1CBTreeDB_1_1PageCache.html#a7b0de7c2f451e946a53965dfdafaa6a3">01394</a>         <span class="keywordtype">void</span> <a class="code" href="classstx_1_1CBTreeDB_1_1PageCache.html#a7b0de7c2f451e946a53965dfdafaa6a3" title="Change maximum number of pages in cache, note that this does not immediately have...">SetMaxSize</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> maxsize)
<a name="l01395"></a>01395         {
<a name="l01396"></a>01396             <span class="keywordflow">return</span> <a class="code" href="classstx_1_1CBTreeDB_1_1PageCache.html#afb51be0b908255f7a3117ebab301d37b" title="pointer to implementation class.">m_impl</a>-&gt;<a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a167e40aeaf2d236a0165e50e387579c9" title="Change maximum number of pages in cache, note that this does not immediately have...">SetMaxSize</a>(maxsize);
<a name="l01397"></a>01397         }
<a name="l01398"></a>01398 
<a name="l01401"></a><a class="code" href="classstx_1_1CBTreeDB_1_1PageCache.html#adc845eacc954f120755217af9f7263c7">01401</a>         std::vector&lt; std::pair&lt;void*, uint32_t&gt; &gt; <a class="code" href="classstx_1_1CBTreeDB_1_1PageCache.html#adc845eacc954f120755217af9f7263c7" title="Return a vector listing all currently contained (btreeid,pageid) pairs in LRU order...">GetPagelist</a>()<span class="keyword"> const</span>
<a name="l01402"></a>01402 <span class="keyword">        </span>{
<a name="l01403"></a>01403             <span class="keywordflow">return</span> <a class="code" href="classstx_1_1CBTreeDB_1_1PageCache.html#afb51be0b908255f7a3117ebab301d37b" title="pointer to implementation class.">m_impl</a>-&gt;<a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a8975e78532ec79f191e0b2551b8340d3" title="Return a vector listing all currently contained (btreeid,pageid) pairs in LRU order...">GetPagelist</a>();
<a name="l01404"></a>01404         }
<a name="l01405"></a>01405 
<a name="l01407"></a><a class="code" href="classstx_1_1CBTreeDB_1_1PageCache.html#ad500b7b2502681e438811043d4ae6764">01407</a>         <span class="keywordtype">bool</span> <a class="code" href="classstx_1_1CBTreeDB_1_1PageCache.html#ad500b7b2502681e438811043d4ae6764" title="Verify the integrity of the LRU list and hash table.">Verify</a>()<span class="keyword"> const</span>
<a name="l01408"></a>01408 <span class="keyword">        </span>{
<a name="l01409"></a>01409             <span class="keywordflow">return</span> <a class="code" href="classstx_1_1CBTreeDB_1_1PageCache.html#afb51be0b908255f7a3117ebab301d37b" title="pointer to implementation class.">m_impl</a>-&gt;<a class="code" href="classstx_1_1CBTreeDB_1_1PageCacheImpl.html#a55253391a04d3a208864b32e80dc806c" title="Verify the integrity of the LRU list and hash table.">Verify</a>();
<a name="l01410"></a>01410         }
<a name="l01411"></a>01411     };
<a name="l01412"></a>01412 
<a name="l01413"></a>01413 <span class="keyword">protected</span>:
<a name="l01419"></a><a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html">01419</a>     <span class="keyword">class </span><a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html" title="Implementation class used to read constant B-tree database files.">ReaderImpl</a>
<a name="l01420"></a>01420     {
<a name="l01421"></a>01421     <span class="keyword">protected</span>:
<a name="l01422"></a>01422 
<a name="l01424"></a><a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a4e05b1bc9eda6d66b9716e6325a5c0d2">01424</a>         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>    <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a4e05b1bc9eda6d66b9716e6325a5c0d2" title="reference counter">m_refs</a>;
<a name="l01425"></a>01425 
<a name="l01427"></a><a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a782b6f840494a9a56e2862e718fb7847">01427</a>         <a class="code" href="classstx_1_1CBTreeDB.html#aa8d64c69bfec9eb6728d50ce1668d522" title="second template parameter: key comparison function object type.">key_compare</a>     <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a782b6f840494a9a56e2862e718fb7847" title="key comparison functional">m_key_less</a>;
<a name="l01428"></a>01428 
<a name="l01430"></a><a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a51e63336b13bbe290c9f91bf8c2b7b2f">01430</a>         <span class="keywordtype">char</span>            <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a51e63336b13bbe290c9f91bf8c2b7b2f" title="signature characters to expect file to begin with.">m_signaturestr</a>[8];
<a name="l01431"></a>01431 
<a name="l01433"></a><a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a127dd81bf846ed41baae74aaa14d5e59">01433</a>         std::istream*   <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a127dd81bf846ed41baae74aaa14d5e59" title="file stream object currently opened.">m_istream</a>;
<a name="l01434"></a>01434 
<a name="l01436"></a><a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#acac61213eb7fb4a4f8504de5812bc9cc">01436</a>         <a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html" title="Signature page which heads all cbtreedb files.">SignaturePage</a>   <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#acac61213eb7fb4a4f8504de5812bc9cc" title="signature page read from file">m_signature</a>;
<a name="l01437"></a>01437 
<a name="l01439"></a><a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a1f845e51369f70addfcb5cf16e794df1">01439</a>         <a class="code" href="classstx_1_1CBTreeDB_1_1PageCache.html" title="PageCache and PageCacheImpl implement a LRU-strategy cache of B-tree pages used by...">PageCache</a>*      <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a1f845e51369f70addfcb5cf16e794df1" title="pointer to b-tree page cache to used.">m_pagecache</a>;
<a name="l01440"></a>01440 
<a name="l01442"></a><a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a2134578873943a60ef2f66e91000dd18">01442</a>         <a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html" title="BTreePage is a reference-counted buffer holding one page of the B-tree index.">BTreePage</a> <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a2134578873943a60ef2f66e91000dd18" title="Read one B-tree page from the file (or from cache).">ReadIndexPage</a>(uint32_t pageoffset)
<a name="l01443"></a>01443         {
<a name="l01444"></a>01444             <a class="code" href="stx-cbtreedb_8h.html#aea46b67a1c31f750df77b32d5db56e2f" title="Short macro to throw exceptions if a program logic expression fails.">CBTREEDB_CHECK</a>(pageoffset + <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#acac61213eb7fb4a4f8504de5812bc9cc" title="signature page read from file">m_signature</a>.<a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#ab515a6550576bc2b2664a5c7b9ca3644" title="size of b-tree nodes">btree_pagesize</a> &lt;= <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#acac61213eb7fb4a4f8504de5812bc9cc" title="signature page read from file">m_signature</a>.<a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#a0ae66a64d4404955ee7df3d65c298876" title="b-tree total size in bytes">btree_size</a>,
<a name="l01445"></a>01445                            <span class="stringliteral">&quot;Invalid B-tree page offset to retrieve.&quot;</span>);
<a name="l01446"></a>01446 
<a name="l01447"></a>01447             <a class="code" href="stx-cbtreedb_8h.html#ab44bd6c500e8dbe3a232e4c44f28b67e" title="Instead of assert() we use this macro to throw exceptions.">CBTREEDB_ASSERT</a>(<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a127dd81bf846ed41baae74aaa14d5e59" title="file stream object currently opened.">m_istream</a>);
<a name="l01448"></a>01448 
<a name="l01449"></a>01449             <a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html" title="BTreePage is a reference-counted buffer holding one page of the B-tree index.">BTreePage</a> page;
<a name="l01450"></a>01450 
<a name="l01451"></a>01451             <span class="keywordflow">if</span> (<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a1f845e51369f70addfcb5cf16e794df1" title="pointer to b-tree page cache to used.">m_pagecache</a>)
<a name="l01452"></a>01452             {
<a name="l01453"></a>01453                 <span class="keywordflow">if</span> (<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a1f845e51369f70addfcb5cf16e794df1" title="pointer to b-tree page cache to used.">m_pagecache</a>-&gt;<a class="code" href="classstx_1_1CBTreeDB_1_1PageCache.html#acdcfec9a6183cfbeb3ad3f6342ef9089" title="Retrieve a cached page identified by (btreeid,pageid).">Retrieve</a>(<span class="keyword">this</span>, pageoffset, page))
<a name="l01454"></a>01454                     <span class="keywordflow">return</span> page;
<a name="l01455"></a>01455             }
<a name="l01456"></a>01456 
<a name="l01457"></a>01457             <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a127dd81bf846ed41baae74aaa14d5e59" title="file stream object currently opened.">m_istream</a>-&gt;seekg(<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#acac61213eb7fb4a4f8504de5812bc9cc" title="signature page read from file">m_signature</a>.<a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#a15d319c4ae75a1d16e6c63e28a10dc03" title="b-tree offset in file">btree_offset</a> + pageoffset);
<a name="l01458"></a>01458             <a class="code" href="stx-cbtreedb_8h.html#aea46b67a1c31f750df77b32d5db56e2f" title="Short macro to throw exceptions if a program logic expression fails.">CBTREEDB_CHECK</a>(<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a127dd81bf846ed41baae74aaa14d5e59" title="file stream object currently opened.">m_istream</a>-&gt;good(), <span class="stringliteral">&quot;Could not read B-tree page.&quot;</span>);
<a name="l01459"></a>01459 
<a name="l01460"></a>01460             page.<a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#a97f080d734d971975f292136e546428f" title="Release enclosed page and initialize a new page buffer.">Create</a>();
<a name="l01461"></a>01461 
<a name="l01462"></a>01462             <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a127dd81bf846ed41baae74aaa14d5e59" title="file stream object currently opened.">m_istream</a>-&gt;read(page.<a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#a1e933680db2ddcac67adf23555454b0b" title="Accessor: return enclosed buffer pointer.">GetBuffer</a>(), <a class="code" href="classstx_1_1CBTreeDB.html#a924efff56b96b6c5a0397211b0cf8685" title="third template parameter: B-tree page size. Usually 1024 or 2048.">BTreePageSize</a>);
<a name="l01463"></a>01463             <a class="code" href="stx-cbtreedb_8h.html#aea46b67a1c31f750df77b32d5db56e2f" title="Short macro to throw exceptions if a program logic expression fails.">CBTREEDB_CHECK</a>(<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a127dd81bf846ed41baae74aaa14d5e59" title="file stream object currently opened.">m_istream</a>-&gt;good(), <span class="stringliteral">&quot;Could not read B-tree page.&quot;</span>);
<a name="l01464"></a>01464 
<a name="l01465"></a>01465             <span class="keywordflow">if</span> (<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a1f845e51369f70addfcb5cf16e794df1" title="pointer to b-tree page cache to used.">m_pagecache</a>)
<a name="l01466"></a>01466             {
<a name="l01467"></a>01467                 <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a1f845e51369f70addfcb5cf16e794df1" title="pointer to b-tree page cache to used.">m_pagecache</a>-&gt;<a class="code" href="classstx_1_1CBTreeDB_1_1PageCache.html#ad412f513c905581f77fee1390bfebb6a" title="Store a page object in a cache cell identified by (btreeid,pageid).">Store</a>(<span class="keyword">this</span>, pageoffset, page);
<a name="l01468"></a>01468             }
<a name="l01469"></a>01469 
<a name="l01470"></a>01470             <span class="keywordflow">return</span> page;
<a name="l01471"></a>01471         }
<a name="l01472"></a>01472 
<a name="l01475"></a><a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#aabc9332e31f4c19a508c6330d899c253">01475</a>         <span class="keywordtype">bool</span> <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#aabc9332e31f4c19a508c6330d899c253" title="Read byte range [offset, offset+size) from value data area into the given buffer...">ReadValueRange</a>(uint64_t offset, <span class="keywordtype">void</span>* data, uint32_t size)
<a name="l01476"></a>01476         {
<a name="l01477"></a>01477             <a class="code" href="stx-cbtreedb_8h.html#ab44bd6c500e8dbe3a232e4c44f28b67e" title="Instead of assert() we use this macro to throw exceptions.">CBTREEDB_ASSERT</a>(<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a127dd81bf846ed41baae74aaa14d5e59" title="file stream object currently opened.">m_istream</a>);
<a name="l01478"></a>01478 
<a name="l01479"></a>01479             <span class="keywordflow">if</span> (offset + size &gt; <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#acac61213eb7fb4a4f8504de5812bc9cc" title="signature page read from file">m_signature</a>.<a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#ae7b237b7498fe2cc48844222861de850" title="total size of value data area">value_size</a>) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01480"></a>01480 
<a name="l01481"></a>01481             <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a127dd81bf846ed41baae74aaa14d5e59" title="file stream object currently opened.">m_istream</a>-&gt;seekg(<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#acac61213eb7fb4a4f8504de5812bc9cc" title="signature page read from file">m_signature</a>.<a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#a32547b948043297c36349fa1f72a07f0" title="file offset of value data area">value_offset</a> + offset);
<a name="l01482"></a>01482             <span class="keywordflow">if</span> (<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a127dd81bf846ed41baae74aaa14d5e59" title="file stream object currently opened.">m_istream</a>-&gt;bad()) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01483"></a>01483 
<a name="l01484"></a>01484             <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a127dd81bf846ed41baae74aaa14d5e59" title="file stream object currently opened.">m_istream</a>-&gt;read(reinterpret_cast&lt;char*&gt;(data), size);
<a name="l01485"></a>01485             <span class="keywordflow">if</span> (<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a127dd81bf846ed41baae74aaa14d5e59" title="file stream object currently opened.">m_istream</a>-&gt;bad()) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01486"></a>01486 
<a name="l01487"></a>01487             <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01488"></a>01488         }
<a name="l01489"></a>01489 
<a name="l01491"></a><a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a2e08f1c599309c6801005cf698dac342">01491</a>         <span class="keywordtype">bool</span> <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a2e08f1c599309c6801005cf698dac342" title="Function to test key equality, constructed from m_key_less.">KeyEqual</a>(<span class="keyword">const</span> <a class="code" href="classstx_1_1CBTreeDB.html#a3853858e7d8cc630c832232bc46ed2c0" title="first template parameter: the key type of the B-tree.">key_type</a>&amp; a, <span class="keyword">const</span> <a class="code" href="classstx_1_1CBTreeDB.html#a3853858e7d8cc630c832232bc46ed2c0" title="first template parameter: the key type of the B-tree.">key_type</a>&amp; b)
<a name="l01492"></a>01492         {
<a name="l01493"></a>01493             <span class="keywordflow">return</span> !<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a782b6f840494a9a56e2862e718fb7847" title="key comparison functional">m_key_less</a>(a,b) &amp;&amp; !<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a782b6f840494a9a56e2862e718fb7847" title="key comparison functional">m_key_less</a>(b,a);
<a name="l01494"></a>01494         }
<a name="l01495"></a>01495 
<a name="l01497"></a><a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a7deff86a6ce09bf27b4b21ad894e1e13">01497</a>         <span class="keywordtype">bool</span> <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a7deff86a6ce09bf27b4b21ad894e1e13" title="Function to test key inequality, constructed from m_key_less.">KeyUnequal</a>(<span class="keyword">const</span> <a class="code" href="classstx_1_1CBTreeDB.html#a3853858e7d8cc630c832232bc46ed2c0" title="first template parameter: the key type of the B-tree.">key_type</a>&amp; a, <span class="keyword">const</span> <a class="code" href="classstx_1_1CBTreeDB.html#a3853858e7d8cc630c832232bc46ed2c0" title="first template parameter: the key type of the B-tree.">key_type</a>&amp; b)
<a name="l01498"></a>01498         {
<a name="l01499"></a>01499             <span class="keywordflow">return</span> <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a782b6f840494a9a56e2862e718fb7847" title="key comparison functional">m_key_less</a>(a,b) || <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a782b6f840494a9a56e2862e718fb7847" title="key comparison functional">m_key_less</a>(b,a);
<a name="l01500"></a>01500         }
<a name="l01501"></a>01501 
<a name="l01503"></a>01503         <span class="keyword">template</span> &lt;<span class="keyword">typename</span> NodeType&gt;
<a name="l01504"></a><a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a057accbc2f439812c213176dab755a87">01504</a>         <span class="keywordtype">int</span> <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a057accbc2f439812c213176dab755a87" title="Find the first key slot containing a greater-or-equal key.">BinarySearch</a>(<span class="keyword">const</span> NodeType* node, <a class="code" href="classstx_1_1CBTreeDB.html#a3853858e7d8cc630c832232bc46ed2c0" title="first template parameter: the key type of the B-tree.">key_type</a> key)
<a name="l01505"></a>01505         {
<a name="l01506"></a>01506             <span class="keyword">register</span> <span class="keywordtype">int</span> lo = 0, hi = node-&gt;slots;
<a name="l01507"></a>01507 
<a name="l01508"></a>01508             <span class="keywordflow">while</span> (lo &lt; hi)
<a name="l01509"></a>01509             {
<a name="l01510"></a>01510                 <span class="keyword">register</span> <span class="keywordtype">int</span> mid = (hi + lo) &gt;&gt; 1;
<a name="l01511"></a>01511 
<a name="l01512"></a>01512                 <span class="keywordflow">if</span> (<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a782b6f840494a9a56e2862e718fb7847" title="key comparison functional">m_key_less</a>(node-&gt;keys[mid], key)) {
<a name="l01513"></a>01513                     lo = mid + 1;
<a name="l01514"></a>01514                 }
<a name="l01515"></a>01515                 <span class="keywordflow">else</span> {
<a name="l01516"></a>01516                     hi = mid;
<a name="l01517"></a>01517                 }
<a name="l01518"></a>01518             }
<a name="l01519"></a>01519 
<a name="l01520"></a>01520 <span class="preprocessor">#ifdef CBTREEDB_SELF_VERIFY</span>
<a name="l01521"></a>01521 <span class="preprocessor"></span>            <span class="comment">// verify result using simple linear search</span>
<a name="l01522"></a>01522             {
<a name="l01523"></a>01523                 <span class="keywordtype">int</span> i = 0;
<a name="l01524"></a>01524                 <span class="keywordflow">while</span>(i &lt; node-&gt;slots &amp;&amp; <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a782b6f840494a9a56e2862e718fb7847" title="key comparison functional">m_key_less</a>(node-&gt;keys[i], key))
<a name="l01525"></a>01525                     ++i;
<a name="l01526"></a>01526 
<a name="l01527"></a>01527                 <a class="code" href="stx-cbtreedb_8h.html#ab44bd6c500e8dbe3a232e4c44f28b67e" title="Instead of assert() we use this macro to throw exceptions.">CBTREEDB_ASSERT</a>(i == lo);
<a name="l01528"></a>01528             }
<a name="l01529"></a>01529 <span class="preprocessor">#endif</span>
<a name="l01530"></a>01530 <span class="preprocessor"></span>            <span class="keywordflow">return</span> lo;
<a name="l01531"></a>01531         }
<a name="l01532"></a>01532 
<a name="l01533"></a>01533     <span class="keyword">public</span>:
<a name="l01535"></a><a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#aa3994b781dd70ae6eb7135922e6462aa">01535</a>         <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#aa3994b781dd70ae6eb7135922e6462aa" title="Create new reader, which is initially set to closed state.">ReaderImpl</a>(<span class="keyword">const</span> <a class="code" href="classstx_1_1CBTreeDB.html#aa8d64c69bfec9eb6728d50ce1668d522" title="second template parameter: key comparison function object type.">key_compare</a>&amp; key_less)
<a name="l01536"></a>01536             : <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a4e05b1bc9eda6d66b9716e6325a5c0d2" title="reference counter">m_refs</a>(0), <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a782b6f840494a9a56e2862e718fb7847" title="key comparison functional">m_key_less</a>(key_less), <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a127dd81bf846ed41baae74aaa14d5e59" title="file stream object currently opened.">m_istream</a>(NULL), <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a1f845e51369f70addfcb5cf16e794df1" title="pointer to b-tree page cache to used.">m_pagecache</a>(NULL)
<a name="l01537"></a>01537         {
<a name="l01538"></a>01538             memcpy(<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a51e63336b13bbe290c9f91bf8c2b7b2f" title="signature characters to expect file to begin with.">m_signaturestr</a>, <span class="stringliteral">&quot;cbtreedb&quot;</span>, 8);
<a name="l01539"></a>01539         }
<a name="l01540"></a>01540 
<a name="l01542"></a><a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a098443c5ed8f8e7a62b488e5e39e149c">01542</a>         <span class="keywordtype">void</span> <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a098443c5ed8f8e7a62b488e5e39e149c" title="Increment reference counter by one.">RefInc</a>()
<a name="l01543"></a>01543         {
<a name="l01544"></a>01544             ++<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a4e05b1bc9eda6d66b9716e6325a5c0d2" title="reference counter">m_refs</a>;
<a name="l01545"></a>01545         }
<a name="l01546"></a>01546 
<a name="l01548"></a><a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a8e42bdcc7582888d961da20aedf7474e">01548</a>         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a8e42bdcc7582888d961da20aedf7474e" title="Decrement reference counter by one and return it.">RefDec</a>()
<a name="l01549"></a>01549         {
<a name="l01550"></a>01550             <span class="keywordflow">return</span> --<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a4e05b1bc9eda6d66b9716e6325a5c0d2" title="reference counter">m_refs</a>;
<a name="l01551"></a>01551         }
<a name="l01552"></a>01552 
<a name="l01558"></a><a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#ac8391c872514c45fd8eb57fa5fa431a9">01558</a>         <span class="keywordtype">void</span> <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#ac8391c872514c45fd8eb57fa5fa431a9" title="Change the database signature (first 8 bytes) from &amp;#39;cbtreedb&amp;#39; to a custom...">SetSignature</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* newsignature)
<a name="l01559"></a>01559         {
<a name="l01560"></a>01560             <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0;
<a name="l01561"></a>01561             <span class="keywordflow">for</span>(; i &lt; 8 &amp;&amp; newsignature[i]; ++i)
<a name="l01562"></a>01562                 <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a51e63336b13bbe290c9f91bf8c2b7b2f" title="signature characters to expect file to begin with.">m_signaturestr</a>[i] = newsignature[i];
<a name="l01563"></a>01563 
<a name="l01564"></a>01564             <span class="keywordflow">for</span>(; i &lt; 8; ++i)
<a name="l01565"></a>01565                 <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a51e63336b13bbe290c9f91bf8c2b7b2f" title="signature characters to expect file to begin with.">m_signaturestr</a>[i] = 0;
<a name="l01566"></a>01566         }
<a name="l01567"></a>01567 
<a name="l01578"></a><a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a835dfdb78068c4ba4720a44b60372a7e">01578</a>         <span class="keywordtype">bool</span> <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a835dfdb78068c4ba4720a44b60372a7e" title="Attempt to open a cbtreedb database file.">Open</a>(std::istream&amp; file, std::string* errortext = NULL)
<a name="l01579"></a>01579         {
<a name="l01580"></a>01580             <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a127dd81bf846ed41baae74aaa14d5e59" title="file stream object currently opened.">m_istream</a> = NULL;
<a name="l01581"></a>01581 
<a name="l01582"></a>01582             file.seekg(0, std::ios::beg);
<a name="l01583"></a>01583             <span class="keywordflow">if</span> (file.bad()) {
<a name="l01584"></a>01584                 <span class="keywordflow">if</span> (errortext) *errortext = <span class="stringliteral">&quot;Could not open database.&quot;</span>;
<a name="l01585"></a>01585                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01586"></a>01586             }
<a name="l01587"></a>01587 
<a name="l01588"></a>01588             file.read(reinterpret_cast&lt;char*&gt;(&amp;<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#acac61213eb7fb4a4f8504de5812bc9cc" title="signature page read from file">m_signature</a>), <span class="keyword">sizeof</span>(<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#acac61213eb7fb4a4f8504de5812bc9cc" title="signature page read from file">m_signature</a>));
<a name="l01589"></a>01589             <span class="keywordflow">if</span> (file.bad()) {
<a name="l01590"></a>01590                 <span class="keywordflow">if</span> (errortext) *errortext = <span class="stringliteral">&quot;Could not read signature.&quot;</span>;
<a name="l01591"></a>01591                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01592"></a>01592             }
<a name="l01593"></a>01593 
<a name="l01594"></a>01594             <span class="keywordflow">if</span> (memcmp(<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#acac61213eb7fb4a4f8504de5812bc9cc" title="signature page read from file">m_signature</a>.<a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#ae797c2f1bb21f13ddf4008156424a76c" title="&amp;quot;cbtreedb&amp;quot; or custom string">signature</a>, <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a51e63336b13bbe290c9f91bf8c2b7b2f" title="signature characters to expect file to begin with.">m_signaturestr</a>, 8) != 0) {
<a name="l01595"></a>01595                 <span class="keywordflow">if</span> (errortext) *errortext = <span class="stringliteral">&quot;Could not verify signature.&quot;</span>;
<a name="l01596"></a>01596                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01597"></a>01597             }
<a name="l01598"></a>01598 
<a name="l01599"></a>01599             <span class="keywordflow">if</span> (<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#acac61213eb7fb4a4f8504de5812bc9cc" title="signature page read from file">m_signature</a>.<a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#ad47a6a5d93fff2689f58d8a4c5dd426f" title="0x00010000">version</a> != 0x00010000) {
<a name="l01600"></a>01600                 <span class="keywordflow">if</span> (errortext) *errortext = <span class="stringliteral">&quot;Signature contains unknown version.&quot;</span>;
<a name="l01601"></a>01601                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01602"></a>01602             }
<a name="l01603"></a>01603             
<a name="l01604"></a>01604             <span class="keywordflow">if</span> (<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#acac61213eb7fb4a4f8504de5812bc9cc" title="signature page read from file">m_signature</a>.<a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#a97ef2f19de2402cc23a723e513a37fb5" title="custom id defined by template">app_version_id</a> != <a class="code" href="classstx_1_1CBTreeDB.html#afbb1611aa42b9f5630ca5dc1b8546988" title="fourth template parameter: application-defined 32-bit identifier to mark database...">AppVersionId</a>) {
<a name="l01605"></a>01605                 <span class="keywordflow">if</span> (errortext) *errortext = <span class="stringliteral">&quot;Signature mismatches application version identifier.&quot;</span>;
<a name="l01606"></a>01606                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01607"></a>01607             }
<a name="l01608"></a>01608             
<a name="l01609"></a>01609             uint32_t crc = <a class="code" href="classstx_1_1CBTreeDB_1_1CRC32.html#a9eb10033fa35e3a5db820e5e37111b27" title="Calculate CRC32 digest of bytes in the given range.">CRC32::digest</a>(reinterpret_cast&lt;char*&gt;(&amp;<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#acac61213eb7fb4a4f8504de5812bc9cc" title="signature page read from file">m_signature</a>)+16, <span class="keyword">sizeof</span>(<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#acac61213eb7fb4a4f8504de5812bc9cc" title="signature page read from file">m_signature</a>)-16);
<a name="l01610"></a>01610 
<a name="l01611"></a>01611             <span class="keywordflow">if</span> (<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#acac61213eb7fb4a4f8504de5812bc9cc" title="signature page read from file">m_signature</a>.<a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#a6600a8e6bef01f7ec30af5f4ad2b4823" title="CRC32 of following bytes.">header_crc32</a> != crc) {
<a name="l01612"></a>01612                 <span class="keywordflow">if</span> (errortext) *errortext = <span class="stringliteral">&quot;Header checksum mismatches.&quot;</span>;
<a name="l01613"></a>01613                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01614"></a>01614             }
<a name="l01615"></a>01615 
<a name="l01616"></a>01616             <span class="keywordflow">if</span> (<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#acac61213eb7fb4a4f8504de5812bc9cc" title="signature page read from file">m_signature</a>.<a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#a89ff60cdddd1e47cd625bca380b04aab" title="sizeof(key_type)">key_size</a> != <span class="keyword">sizeof</span>(<a class="code" href="classstx_1_1CBTreeDB.html#a3853858e7d8cc630c832232bc46ed2c0" title="first template parameter: the key type of the B-tree.">key_type</a>)) {
<a name="l01617"></a>01617                 <span class="keywordflow">if</span> (errortext) *errortext  = <span class="stringliteral">&quot;Database not compatible with this reader: key sizes mismatch.&quot;</span>;
<a name="l01618"></a>01618                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01619"></a>01619             }
<a name="l01620"></a>01620 
<a name="l01621"></a>01621             <span class="keywordflow">if</span> (<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#acac61213eb7fb4a4f8504de5812bc9cc" title="signature page read from file">m_signature</a>.<a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#ab515a6550576bc2b2664a5c7b9ca3644" title="size of b-tree nodes">btree_pagesize</a> != <a class="code" href="classstx_1_1CBTreeDB.html#a924efff56b96b6c5a0397211b0cf8685" title="third template parameter: B-tree page size. Usually 1024 or 2048.">BTreePageSize</a>) {
<a name="l01622"></a>01622                 <span class="keywordflow">if</span> (errortext) *errortext  = <span class="stringliteral">&quot;Database not compatible with this reader: page sizes mismatch.&quot;</span>;
<a name="l01623"></a>01623                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01624"></a>01624             }
<a name="l01625"></a>01625 
<a name="l01626"></a>01626             <span class="comment">// test database compatibility with order relation by checking root</span>
<a name="l01627"></a>01627             <span class="comment">// node&#39;s key sequence.</span>
<a name="l01628"></a>01628 
<a name="l01629"></a>01629             <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a127dd81bf846ed41baae74aaa14d5e59" title="file stream object currently opened.">m_istream</a> = &amp;file;
<a name="l01630"></a>01630 
<a name="l01631"></a>01631             <a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html" title="BTreePage is a reference-counted buffer holding one page of the B-tree index.">BTreePage</a> root = <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a2134578873943a60ef2f66e91000dd18" title="Read one B-tree page from the file (or from cache).">ReadIndexPage</a>(0);
<a name="l01632"></a>01632 
<a name="l01633"></a>01633             <span class="keywordflow">if</span> ( root.<a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#a70cb9902a330172c4e08e5035c8c2917" title="Returns true if the buffer contains a leaf node.">IsLeafNode</a>() )
<a name="l01634"></a>01634             {
<a name="l01635"></a>01635                 <a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html" title="Leaf node structure of the B-tree leaf pages.">LeafNode</a>* leaf = root.<a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#adccee62c9a689ca5cb2dd8353e0726d2" title="Return buffer casted as a leaf node.">GetAsLeafNode</a>();
<a name="l01636"></a>01636 
<a name="l01637"></a>01637                 <span class="keywordflow">for</span>(uint16_t s = 0; s &lt; leaf-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#a7355e231680da86d20a036675b9cedc9" title="number of used slots in the arrays.">slots</a> - 1; ++s)
<a name="l01638"></a>01638                 {
<a name="l01639"></a>01639                     <span class="keywordflow">if</span> (!<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a782b6f840494a9a56e2862e718fb7847" title="key comparison functional">m_key_less</a>(leaf-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#a92d237e7bc59ffcfb4530303af043a7f" title="key array of ascending key in this leaf.">keys</a>[s], leaf-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#a92d237e7bc59ffcfb4530303af043a7f" title="key array of ascending key in this leaf.">keys</a>[s+1])) {
<a name="l01640"></a>01640                         <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a127dd81bf846ed41baae74aaa14d5e59" title="file stream object currently opened.">m_istream</a> = NULL;
<a name="l01641"></a>01641                         <span class="keywordflow">if</span> (errortext) *errortext  = <span class="stringliteral">&quot;Database not compatible with this reader: root keys order mismatches.&quot;</span>;
<a name="l01642"></a>01642                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01643"></a>01643                     }
<a name="l01644"></a>01644                 }
<a name="l01645"></a>01645             }
<a name="l01646"></a>01646             <span class="keywordflow">else</span>
<a name="l01647"></a>01647             {
<a name="l01648"></a>01648                 <a class="code" href="structstx_1_1CBTreeDB_1_1InnerNode.html" title="Inner node structure of the B-tree inner pages.">InnerNode</a>* inner = root.<a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#adfa632cd49bde968f9064ddb8562d94e" title="Return buffer casted as an inner node.">GetAsInnerNode</a>();
<a name="l01649"></a>01649 
<a name="l01650"></a>01650                 <span class="keywordflow">for</span>(uint16_t s = 0; s &lt; inner-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1InnerNode.html#a39993c719c0479b1ab32d0b64758ecf0" title="number of used slots in the arrays.">slots</a> - 1; ++s)
<a name="l01651"></a>01651                 {
<a name="l01652"></a>01652                     <span class="keywordflow">if</span> (!<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a782b6f840494a9a56e2862e718fb7847" title="key comparison functional">m_key_less</a>(inner-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1InnerNode.html#ae991d7c99f3ab0820bcd0254ed53fca8" title="key array of ascending keys in this inner node.">keys</a>[s], inner-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1InnerNode.html#ae991d7c99f3ab0820bcd0254ed53fca8" title="key array of ascending keys in this inner node.">keys</a>[s+1])) {
<a name="l01653"></a>01653                         <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a127dd81bf846ed41baae74aaa14d5e59" title="file stream object currently opened.">m_istream</a> = NULL;
<a name="l01654"></a>01654                         <span class="keywordflow">if</span> (errortext) *errortext  = <span class="stringliteral">&quot;Database not compatible with this reader: root keys order mismatches.&quot;</span>;
<a name="l01655"></a>01655                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01656"></a>01656                     }
<a name="l01657"></a>01657                 }
<a name="l01658"></a>01658             }
<a name="l01659"></a>01659 
<a name="l01660"></a>01660             <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01661"></a>01661         }
<a name="l01662"></a>01662 
<a name="l01666"></a><a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a7a215ab363ae9517e629d7c332252fb6">01666</a>         <span class="keywordtype">void</span> <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a7a215ab363ae9517e629d7c332252fb6" title="Close the opened database.">Close</a>()
<a name="l01667"></a>01667         {
<a name="l01668"></a>01668             <span class="keywordflow">if</span> (<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a127dd81bf846ed41baae74aaa14d5e59" title="file stream object currently opened.">m_istream</a>)
<a name="l01669"></a>01669                 <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a127dd81bf846ed41baae74aaa14d5e59" title="file stream object currently opened.">m_istream</a> = NULL;
<a name="l01670"></a>01670         }
<a name="l01671"></a>01671 
<a name="l01673"></a><a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a679f537a80c1985cce214bb76675f223">01673</a>         <span class="keywordtype">void</span> <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a679f537a80c1985cce214bb76675f223" title="Change the currently used page cache object.">SetPageCache</a>(<a class="code" href="classstx_1_1CBTreeDB_1_1PageCache.html" title="PageCache and PageCacheImpl implement a LRU-strategy cache of B-tree pages used by...">PageCache</a>* newpagecache)
<a name="l01674"></a>01674         {
<a name="l01675"></a>01675             <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a1f845e51369f70addfcb5cf16e794df1" title="pointer to b-tree page cache to used.">m_pagecache</a> = newpagecache;
<a name="l01676"></a>01676         }
<a name="l01677"></a>01677 
<a name="l01681"></a><a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#ab40620b926ca9f0a46e82b08d524fc1a">01681</a>         uint32_t <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#ab40620b926ca9f0a46e82b08d524fc1a" title="Returns the number of items in the loaded database.">Size</a>()<span class="keyword"> const</span>
<a name="l01682"></a>01682 <span class="keyword">        </span>{
<a name="l01683"></a>01683             <a class="code" href="stx-cbtreedb_8h.html#aea46b67a1c31f750df77b32d5db56e2f" title="Short macro to throw exceptions if a program logic expression fails.">CBTREEDB_CHECK</a>(<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a127dd81bf846ed41baae74aaa14d5e59" title="file stream object currently opened.">m_istream</a>, <span class="stringliteral">&quot;No database loaded.&quot;</span>);
<a name="l01684"></a>01684 
<a name="l01685"></a>01685             <span class="keywordflow">return</span> <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#acac61213eb7fb4a4f8504de5812bc9cc" title="signature page read from file">m_signature</a>.<a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#a72aa9d25a46e2d8645759e983c2dd207" title="key-value pairs in db">items</a>;
<a name="l01686"></a>01686         }
<a name="l01687"></a>01687 
<a name="l01692"></a><a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#ae464958b91b949125fb940cc58fe7398">01692</a>         <span class="keyword">const</span> <a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html" title="Signature page which heads all cbtreedb files.">SignaturePage</a>&amp; <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#ae464958b91b949125fb940cc58fe7398" title="Returns a const reference to the signature page of the currently loaded database...">GetSignature</a>()<span class="keyword"> const</span>
<a name="l01693"></a>01693 <span class="keyword">        </span>{
<a name="l01694"></a>01694             <span class="keywordflow">return</span> <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#acac61213eb7fb4a4f8504de5812bc9cc" title="signature page read from file">m_signature</a>;
<a name="l01695"></a>01695         }
<a name="l01696"></a>01696 
<a name="l01697"></a>01697     <span class="keyword">protected</span>:
<a name="l01702"></a><a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a6b936a53a3071e4bad0ea8fe9ec4efb4">01702</a>         <span class="keywordtype">bool</span> <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a6b936a53a3071e4bad0ea8fe9ec4efb4" title="Internal function to look down the B-tree and find a key.">FindKey</a>(<span class="keyword">const</span> <a class="code" href="classstx_1_1CBTreeDB.html#a3853858e7d8cc630c832232bc46ed2c0" title="first template parameter: the key type of the B-tree.">key_type</a>&amp; key, uint64_t&amp; outoffset, uint32_t&amp; outsize)
<a name="l01703"></a>01703         {
<a name="l01704"></a>01704             <span class="keywordflow">if</span> (<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#acac61213eb7fb4a4f8504de5812bc9cc" title="signature page read from file">m_signature</a>.<a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#a0ae66a64d4404955ee7df3d65c298876" title="b-tree total size in bytes">btree_size</a> == 0) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01705"></a>01705 
<a name="l01706"></a>01706             <a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html" title="BTreePage is a reference-counted buffer holding one page of the B-tree index.">BTreePage</a> page = <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a2134578873943a60ef2f66e91000dd18" title="Read one B-tree page from the file (or from cache).">ReadIndexPage</a>(0);
<a name="l01707"></a>01707 
<a name="l01708"></a>01708             <span class="keywordtype">bool</span> checklastkey = <span class="keyword">false</span>;
<a name="l01709"></a>01709             <a class="code" href="classstx_1_1CBTreeDB.html#a3853858e7d8cc630c832232bc46ed2c0" title="first template parameter: the key type of the B-tree.">key_type</a> lastkey = <a class="code" href="classstx_1_1CBTreeDB.html#a3853858e7d8cc630c832232bc46ed2c0" title="first template parameter: the key type of the B-tree.">key_type</a>();
<a name="l01710"></a>01710 
<a name="l01711"></a>01711             <span class="keywordflow">while</span>( ! page.<a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#a70cb9902a330172c4e08e5035c8c2917" title="Returns true if the buffer contains a leaf node.">IsLeafNode</a>() )
<a name="l01712"></a>01712             {
<a name="l01713"></a>01713                 <a class="code" href="structstx_1_1CBTreeDB_1_1InnerNode.html" title="Inner node structure of the B-tree inner pages.">InnerNode</a>* inner = page.<a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#adfa632cd49bde968f9064ddb8562d94e" title="Return buffer casted as an inner node.">GetAsInnerNode</a>();
<a name="l01714"></a>01714 
<a name="l01715"></a>01715                 <a class="code" href="stx-cbtreedb_8h.html#aea46b67a1c31f750df77b32d5db56e2f" title="Short macro to throw exceptions if a program logic expression fails.">CBTREEDB_CHECK</a>(!checklastkey || !<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a782b6f840494a9a56e2862e718fb7847" title="key comparison functional">m_key_less</a>(lastkey, inner-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1InnerNode.html#abaa4fd865be345c309841c93e68c9646" title="Returns the currently last key in the node.">LastKey</a>()),
<a name="l01716"></a>01716                                <span class="stringliteral">&quot;BTree corrupt (lastkey does not match).&quot;</span>);
<a name="l01717"></a>01717 
<a name="l01718"></a>01718                 <span class="keywordtype">int</span> slot = <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a057accbc2f439812c213176dab755a87" title="Find the first key slot containing a greater-or-equal key.">BinarySearch</a>(inner, key);
<a name="l01719"></a>01719 
<a name="l01720"></a>01720                 uint32_t next = inner-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1InnerNode.html#aa8a393e3980026418172cb866576d47e" title="base offset of child B-tree nodes enumerated by keys.">childrenoffset</a>;
<a name="l01721"></a>01721                 <span class="keywordflow">if</span> (inner-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1InnerNode.html#a03dfd6173cbf57de4bf30dbe2c1c23bb" title="level of this inner node, always &amp;gt; 0.">level</a> &gt; 1)
<a name="l01722"></a>01722                     next += slot * <span class="keyword">sizeof</span>(<a class="code" href="structstx_1_1CBTreeDB_1_1InnerNode.html" title="Inner node structure of the B-tree inner pages.">InnerNode</a>);
<a name="l01723"></a>01723                 <span class="keywordflow">else</span>
<a name="l01724"></a>01724                     next += slot * <span class="keyword">sizeof</span>(<a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html" title="Leaf node structure of the B-tree leaf pages.">LeafNode</a>);
<a name="l01725"></a>01725 
<a name="l01726"></a>01726                 <span class="keywordtype">int</span> oldlevel = inner-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1InnerNode.html#a03dfd6173cbf57de4bf30dbe2c1c23bb" title="level of this inner node, always &amp;gt; 0.">level</a>;
<a name="l01727"></a>01727 
<a name="l01728"></a>01728                 <span class="keywordflow">if</span> (slot &lt; inner-&gt;slots) {
<a name="l01729"></a>01729                     checklastkey = <span class="keyword">true</span>;
<a name="l01730"></a>01730                     lastkey = inner-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1InnerNode.html#ae991d7c99f3ab0820bcd0254ed53fca8" title="key array of ascending keys in this inner node.">keys</a>[slot];
<a name="l01731"></a>01731                 }
<a name="l01732"></a>01732 
<a name="l01733"></a>01733                 page = <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a2134578873943a60ef2f66e91000dd18" title="Read one B-tree page from the file (or from cache).">ReadIndexPage</a>(next);
<a name="l01734"></a>01734 
<a name="l01735"></a>01735                 <a class="code" href="stx-cbtreedb_8h.html#aea46b67a1c31f750df77b32d5db56e2f" title="Short macro to throw exceptions if a program logic expression fails.">CBTREEDB_CHECK</a>(page.<a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#ab716b85e97b7ac16b0e2222b50b58534" title="Return the enclosed node&amp;#39;s level in the tree.">GetLevel</a>() == oldlevel-1,
<a name="l01736"></a>01736                                <span class="stringliteral">&quot;BTree corrupt (level order mismatch).&quot;</span>);
<a name="l01737"></a>01737             }
<a name="l01738"></a>01738 
<a name="l01739"></a>01739             <a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html" title="Leaf node structure of the B-tree leaf pages.">LeafNode</a>* leaf = page.<a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#adccee62c9a689ca5cb2dd8353e0726d2" title="Return buffer casted as a leaf node.">GetAsLeafNode</a>();
<a name="l01740"></a>01740 
<a name="l01741"></a>01741             <a class="code" href="stx-cbtreedb_8h.html#aea46b67a1c31f750df77b32d5db56e2f" title="Short macro to throw exceptions if a program logic expression fails.">CBTREEDB_CHECK</a>(!checklastkey || <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a2e08f1c599309c6801005cf698dac342" title="Function to test key equality, constructed from m_key_less.">KeyEqual</a>(leaf-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#a88857726917ddbcb3662c7fc14c4cb91" title="Returns the currently last key in the node.">LastKey</a>(), lastkey),
<a name="l01742"></a>01742                            <span class="stringliteral">&quot;BTree corrupt (lastkey in leaf does not match).&quot;</span>);
<a name="l01743"></a>01743 
<a name="l01744"></a>01744             <span class="keywordtype">int</span> slot = <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a057accbc2f439812c213176dab755a87" title="Find the first key slot containing a greater-or-equal key.">BinarySearch</a>(leaf, key);
<a name="l01745"></a>01745 
<a name="l01746"></a>01746             <span class="keywordflow">if</span> (slot &gt;= leaf-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#a7355e231680da86d20a036675b9cedc9" title="number of used slots in the arrays.">slots</a> || <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a7deff86a6ce09bf27b4b21ad894e1e13" title="Function to test key inequality, constructed from m_key_less.">KeyUnequal</a>(leaf-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#a92d237e7bc59ffcfb4530303af043a7f" title="key array of ascending key in this leaf.">keys</a>[slot],  key))
<a name="l01747"></a>01747                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01748"></a>01748 
<a name="l01749"></a>01749             <span class="comment">// Return offset and size via pointers.</span>
<a name="l01750"></a>01750 
<a name="l01751"></a>01751             outoffset = leaf-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#ae16aa36d66c1ec576cdf5885fb7446e8" title="base of value offsets enumerated in array.">baseoffset</a> + leaf-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#a65c94b32f23036adb8e864b440c1c6ae" title="file offset of value data associated with key.">offsets</a>[slot];
<a name="l01752"></a>01752 
<a name="l01753"></a>01753             <span class="comment">// figure out value size of this slot: compute it from the offsets</span>
<a name="l01754"></a>01754             <a class="code" href="stx-cbtreedb_8h.html#aea46b67a1c31f750df77b32d5db56e2f" title="Short macro to throw exceptions if a program logic expression fails.">CBTREEDB_CHECK</a>(leaf-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#a65c94b32f23036adb8e864b440c1c6ae" title="file offset of value data associated with key.">offsets</a>[slot] &lt;= leaf-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#a65c94b32f23036adb8e864b440c1c6ae" title="file offset of value data associated with key.">offsets</a>[slot+1],
<a name="l01755"></a>01755                            <span class="stringliteral">&quot;BTree corrupt (offsets are not ascending).&quot;</span>);
<a name="l01756"></a>01756 
<a name="l01757"></a>01757             outsize = leaf-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#a65c94b32f23036adb8e864b440c1c6ae" title="file offset of value data associated with key.">offsets</a>[slot+1] - leaf-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#a65c94b32f23036adb8e864b440c1c6ae" title="file offset of value data associated with key.">offsets</a>[slot];
<a name="l01758"></a>01758 
<a name="l01759"></a>01759             <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01760"></a>01760         }
<a name="l01761"></a>01761 
<a name="l01762"></a>01762     <span class="keyword">public</span>:
<a name="l01769"></a><a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#af6b4e2ab54b52205bf9d219972aa16b5">01769</a>         <span class="keywordtype">bool</span> <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#af6b4e2ab54b52205bf9d219972aa16b5" title="Check if a key is in the constant database.">Exists</a>(<span class="keyword">const</span> <a class="code" href="classstx_1_1CBTreeDB.html#a3853858e7d8cc630c832232bc46ed2c0" title="first template parameter: the key type of the B-tree.">key_type</a>&amp; key)
<a name="l01770"></a>01770         {
<a name="l01771"></a>01771             <a class="code" href="stx-cbtreedb_8h.html#aea46b67a1c31f750df77b32d5db56e2f" title="Short macro to throw exceptions if a program logic expression fails.">CBTREEDB_CHECK</a>(<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a127dd81bf846ed41baae74aaa14d5e59" title="file stream object currently opened.">m_istream</a>, <span class="stringliteral">&quot;No database loaded.&quot;</span>);
<a name="l01772"></a>01772 
<a name="l01773"></a>01773             uint64_t offset;
<a name="l01774"></a>01774             uint32_t size;
<a name="l01775"></a>01775 
<a name="l01776"></a>01776             <span class="keywordflow">return</span> <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a6b936a53a3071e4bad0ea8fe9ec4efb4" title="Internal function to look down the B-tree and find a key.">FindKey</a>(key, offset, size);
<a name="l01777"></a>01777         }
<a name="l01778"></a>01778 
<a name="l01788"></a><a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a3028a30dca7f22b3bacc598413f2768f">01788</a>         <span class="keywordtype">bool</span> <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a3028a30dca7f22b3bacc598413f2768f" title="Find a key in the constant database.">Lookup</a>(<span class="keyword">const</span> <a class="code" href="classstx_1_1CBTreeDB.html#a3853858e7d8cc630c832232bc46ed2c0" title="first template parameter: the key type of the B-tree.">key_type</a>&amp; key, <span class="keywordtype">void</span>* outvalue, uint32_t maxsize)
<a name="l01789"></a>01789         {
<a name="l01790"></a>01790             <a class="code" href="stx-cbtreedb_8h.html#aea46b67a1c31f750df77b32d5db56e2f" title="Short macro to throw exceptions if a program logic expression fails.">CBTREEDB_CHECK</a>(<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a127dd81bf846ed41baae74aaa14d5e59" title="file stream object currently opened.">m_istream</a>, <span class="stringliteral">&quot;No database loaded.&quot;</span>);
<a name="l01791"></a>01791 
<a name="l01792"></a>01792             uint64_t offset;
<a name="l01793"></a>01793             uint32_t size;
<a name="l01794"></a>01794 
<a name="l01795"></a>01795             <span class="keywordflow">if</span> (!<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a6b936a53a3071e4bad0ea8fe9ec4efb4" title="Internal function to look down the B-tree and find a key.">FindKey</a>(key, offset, size))
<a name="l01796"></a>01796                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01797"></a>01797 
<a name="l01798"></a>01798             uint32_t readsize = size;
<a name="l01799"></a>01799             <span class="keywordflow">if</span> (readsize &gt; maxsize) readsize = maxsize;
<a name="l01800"></a>01800 
<a name="l01801"></a>01801             <span class="keywordflow">return</span> <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#aabc9332e31f4c19a508c6330d899c253" title="Read byte range [offset, offset+size) from value data area into the given buffer...">ReadValueRange</a>(offset, outvalue, readsize);
<a name="l01802"></a>01802         }
<a name="l01803"></a>01803 
<a name="l01812"></a><a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a04fca9039088858adc1431857e23d88b">01812</a>         <span class="keywordtype">bool</span> <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a3028a30dca7f22b3bacc598413f2768f" title="Find a key in the constant database.">Lookup</a>(<span class="keyword">const</span> <a class="code" href="classstx_1_1CBTreeDB.html#a3853858e7d8cc630c832232bc46ed2c0" title="first template parameter: the key type of the B-tree.">key_type</a>&amp; key, std::string&amp; outvalue)
<a name="l01813"></a>01813         {
<a name="l01814"></a>01814             <a class="code" href="stx-cbtreedb_8h.html#aea46b67a1c31f750df77b32d5db56e2f" title="Short macro to throw exceptions if a program logic expression fails.">CBTREEDB_CHECK</a>(<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a127dd81bf846ed41baae74aaa14d5e59" title="file stream object currently opened.">m_istream</a>, <span class="stringliteral">&quot;No database loaded.&quot;</span>);
<a name="l01815"></a>01815 
<a name="l01816"></a>01816             uint64_t offset;
<a name="l01817"></a>01817             uint32_t size;
<a name="l01818"></a>01818 
<a name="l01819"></a>01819             <span class="keywordflow">if</span> (!<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a6b936a53a3071e4bad0ea8fe9ec4efb4" title="Internal function to look down the B-tree and find a key.">FindKey</a>(key, offset, size))
<a name="l01820"></a>01820                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01821"></a>01821 
<a name="l01822"></a>01822             outvalue.resize(size);
<a name="l01823"></a>01823 
<a name="l01824"></a>01824             <span class="keywordflow">return</span> <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#aabc9332e31f4c19a508c6330d899c253" title="Read byte range [offset, offset+size) from value data area into the given buffer...">ReadValueRange</a>(offset, const_cast&lt;char*&gt;(outvalue.data()), size);
<a name="l01825"></a>01825         }
<a name="l01826"></a>01826 
<a name="l01835"></a><a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#ae6ffcc392fbd9ac62ea7e1e93eda4862">01835</a>         std::string <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#ae6ffcc392fbd9ac62ea7e1e93eda4862" title="Find a key in the constant database.">operator[]</a>(<span class="keyword">const</span> <a class="code" href="classstx_1_1CBTreeDB.html#a3853858e7d8cc630c832232bc46ed2c0" title="first template parameter: the key type of the B-tree.">key_type</a>&amp; key)
<a name="l01836"></a>01836         {
<a name="l01837"></a>01837             <a class="code" href="stx-cbtreedb_8h.html#aea46b67a1c31f750df77b32d5db56e2f" title="Short macro to throw exceptions if a program logic expression fails.">CBTREEDB_CHECK</a>(<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a127dd81bf846ed41baae74aaa14d5e59" title="file stream object currently opened.">m_istream</a>, <span class="stringliteral">&quot;No database loaded.&quot;</span>);
<a name="l01838"></a>01838 
<a name="l01839"></a>01839             uint64_t offset;
<a name="l01840"></a>01840             uint32_t size;
<a name="l01841"></a>01841 
<a name="l01842"></a>01842             <span class="keywordflow">if</span> (!<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a6b936a53a3071e4bad0ea8fe9ec4efb4" title="Internal function to look down the B-tree and find a key.">FindKey</a>(key, offset, size))
<a name="l01843"></a>01843                 <span class="keywordflow">return</span> std::string();
<a name="l01844"></a>01844 
<a name="l01845"></a>01845             std::string outvalue;
<a name="l01846"></a>01846             outvalue.resize(size);
<a name="l01847"></a>01847 
<a name="l01848"></a>01848             <span class="keywordflow">if</span> (!<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#aabc9332e31f4c19a508c6330d899c253" title="Read byte range [offset, offset+size) from value data area into the given buffer...">ReadValueRange</a>(offset, const_cast&lt;char*&gt;(outvalue.data()), size))
<a name="l01849"></a>01849                 <span class="keywordflow">return</span> std::string();
<a name="l01850"></a>01850 
<a name="l01851"></a>01851             <span class="keywordflow">return</span> outvalue;
<a name="l01852"></a>01852         }
<a name="l01853"></a>01853         
<a name="l01854"></a>01854     <span class="keyword">protected</span>:
<a name="l01860"></a><a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#ac2f53460507624518c1fe79f0981db9f">01860</a>         <span class="keywordtype">bool</span> <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#ac2f53460507624518c1fe79f0981db9f" title="Internal function to look directly into the B-tree&amp;#39;s leaf pages and find a key...">FindIndex</a>(uint32_t index, <a class="code" href="classstx_1_1CBTreeDB.html#a3853858e7d8cc630c832232bc46ed2c0" title="first template parameter: the key type of the B-tree.">key_type</a>&amp; outkey, uint64_t&amp; outoffset, uint32_t&amp; outsize)
<a name="l01861"></a>01861         {
<a name="l01862"></a>01862             <span class="keywordflow">if</span> (index &gt;= <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#acac61213eb7fb4a4f8504de5812bc9cc" title="signature page read from file">m_signature</a>.<a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#a72aa9d25a46e2d8645759e983c2dd207" title="key-value pairs in db">items</a>) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01863"></a>01863 
<a name="l01864"></a>01864             <span class="comment">// directly compute offset of leaf containing to the key index</span>
<a name="l01865"></a>01865 
<a name="l01866"></a>01866             uint32_t offset = index / <a class="code" href="classstx_1_1CBTreeDB.html#acca9b452de05001486b111a4c415cfcb" title="number of key+offsets in each LeafNode">LeafNodeNumKeys</a> * <a class="code" href="classstx_1_1CBTreeDB.html#a924efff56b96b6c5a0397211b0cf8685" title="third template parameter: B-tree page size. Usually 1024 or 2048.">BTreePageSize</a>;
<a name="l01867"></a>01867             <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> slot = index % <a class="code" href="classstx_1_1CBTreeDB.html#acca9b452de05001486b111a4c415cfcb" title="number of key+offsets in each LeafNode">LeafNodeNumKeys</a>;
<a name="l01868"></a>01868 
<a name="l01869"></a>01869             <a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html" title="BTreePage is a reference-counted buffer holding one page of the B-tree index.">BTreePage</a> page = <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a2134578873943a60ef2f66e91000dd18" title="Read one B-tree page from the file (or from cache).">ReadIndexPage</a>(<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#acac61213eb7fb4a4f8504de5812bc9cc" title="signature page read from file">m_signature</a>.<a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#a26efd4b957baf1edde0aa13981b355f0" title="offset of first leaf in file">btree_firstleaf</a> + offset);
<a name="l01870"></a>01870 
<a name="l01871"></a>01871             <a class="code" href="stx-cbtreedb_8h.html#aea46b67a1c31f750df77b32d5db56e2f" title="Short macro to throw exceptions if a program logic expression fails.">CBTREEDB_CHECK</a>(page.<a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#a70cb9902a330172c4e08e5035c8c2917" title="Returns true if the buffer contains a leaf node.">IsLeafNode</a>(),
<a name="l01872"></a>01872                            <span class="stringliteral">&quot;BTree corrupt (expecting leaf node).&quot;</span>);
<a name="l01873"></a>01873 
<a name="l01874"></a>01874             <a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html" title="Leaf node structure of the B-tree leaf pages.">LeafNode</a>* leaf = page.<a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#adccee62c9a689ca5cb2dd8353e0726d2" title="Return buffer casted as a leaf node.">GetAsLeafNode</a>();
<a name="l01875"></a>01875 
<a name="l01876"></a>01876             <a class="code" href="stx-cbtreedb_8h.html#aea46b67a1c31f750df77b32d5db56e2f" title="Short macro to throw exceptions if a program logic expression fails.">CBTREEDB_CHECK</a>(slot &lt; leaf-&gt;slots,
<a name="l01877"></a>01877                            <span class="stringliteral">&quot;BTree corrupt (index beyond range in leaf node).&quot;</span>);
<a name="l01878"></a>01878 
<a name="l01879"></a>01879             <span class="comment">// copy key and offset</span>
<a name="l01880"></a>01880             outkey = leaf-&gt;keys[slot];
<a name="l01881"></a>01881             outoffset = leaf-&gt;baseoffset + leaf-&gt;offsets[slot];
<a name="l01882"></a>01882 
<a name="l01883"></a>01883             <span class="comment">// figure out value size of this slot: compute it from the offsets</span>
<a name="l01884"></a>01884             <a class="code" href="stx-cbtreedb_8h.html#aea46b67a1c31f750df77b32d5db56e2f" title="Short macro to throw exceptions if a program logic expression fails.">CBTREEDB_CHECK</a>(leaf-&gt;offsets[slot] &lt;= leaf-&gt;offsets[slot+1],
<a name="l01885"></a>01885                            <span class="stringliteral">&quot;BTree corrupt (offsets are not ascending).&quot;</span>);
<a name="l01886"></a>01886 
<a name="l01887"></a>01887             outsize = leaf-&gt;offsets[slot+1] - leaf-&gt;offsets[slot];
<a name="l01888"></a>01888 
<a name="l01889"></a>01889             <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01890"></a>01890         }
<a name="l01891"></a>01891 
<a name="l01892"></a>01892     <span class="keyword">public</span>:
<a name="l01900"></a><a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a0d73ffa78a159c4201fc6c0d98fb1591">01900</a>         uint32_t <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a0d73ffa78a159c4201fc6c0d98fb1591" title="Returns only the key by index.">GetIndex</a>(uint32_t index, <a class="code" href="classstx_1_1CBTreeDB.html#a3853858e7d8cc630c832232bc46ed2c0" title="first template parameter: the key type of the B-tree.">key_type</a>&amp; outkey)
<a name="l01901"></a>01901         {
<a name="l01902"></a>01902             <a class="code" href="stx-cbtreedb_8h.html#aea46b67a1c31f750df77b32d5db56e2f" title="Short macro to throw exceptions if a program logic expression fails.">CBTREEDB_CHECK</a>(<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a127dd81bf846ed41baae74aaa14d5e59" title="file stream object currently opened.">m_istream</a>, <span class="stringliteral">&quot;No database loaded.&quot;</span>);
<a name="l01903"></a>01903 
<a name="l01904"></a>01904             uint64_t offset;
<a name="l01905"></a>01905             uint32_t size;
<a name="l01906"></a>01906 
<a name="l01907"></a>01907             <span class="keywordflow">if</span> (!<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#ac2f53460507624518c1fe79f0981db9f" title="Internal function to look directly into the B-tree&amp;#39;s leaf pages and find a key...">FindIndex</a>(index, outkey, offset, size))
<a name="l01908"></a>01908                 <span class="keywordflow">return</span> 0;
<a name="l01909"></a>01909 
<a name="l01910"></a>01910             <span class="keywordflow">return</span> size;
<a name="l01911"></a>01911         }
<a name="l01912"></a>01912 
<a name="l01923"></a><a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a205d93c3a6d87572891858dbf5c176dc">01923</a>         uint32_t <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a0d73ffa78a159c4201fc6c0d98fb1591" title="Returns only the key by index.">GetIndex</a>(uint32_t index, <a class="code" href="classstx_1_1CBTreeDB.html#a3853858e7d8cc630c832232bc46ed2c0" title="first template parameter: the key type of the B-tree.">key_type</a>&amp; outkey, <span class="keywordtype">void</span>* outvalue, uint32_t maxsize)
<a name="l01924"></a>01924         {
<a name="l01925"></a>01925             <a class="code" href="stx-cbtreedb_8h.html#aea46b67a1c31f750df77b32d5db56e2f" title="Short macro to throw exceptions if a program logic expression fails.">CBTREEDB_CHECK</a>(<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a127dd81bf846ed41baae74aaa14d5e59" title="file stream object currently opened.">m_istream</a>, <span class="stringliteral">&quot;No database loaded.&quot;</span>);
<a name="l01926"></a>01926 
<a name="l01927"></a>01927             uint64_t offset;
<a name="l01928"></a>01928             uint32_t size;
<a name="l01929"></a>01929 
<a name="l01930"></a>01930             <span class="keywordflow">if</span> (!<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#ac2f53460507624518c1fe79f0981db9f" title="Internal function to look directly into the B-tree&amp;#39;s leaf pages and find a key...">FindIndex</a>(index, outkey, offset, size))
<a name="l01931"></a>01931                 <span class="keywordflow">return</span> 0;
<a name="l01932"></a>01932 
<a name="l01933"></a>01933             uint32_t outsize = size;
<a name="l01934"></a>01934             <span class="keywordflow">if</span> (outsize &gt; maxsize) outsize = maxsize;
<a name="l01935"></a>01935 
<a name="l01936"></a>01936             <span class="keywordflow">if</span> (!<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#aabc9332e31f4c19a508c6330d899c253" title="Read byte range [offset, offset+size) from value data area into the given buffer...">ReadValueRange</a>(offset, outvalue, outsize))
<a name="l01937"></a>01937                 <span class="keywordflow">return</span> 0;
<a name="l01938"></a>01938 
<a name="l01939"></a>01939             <span class="keywordflow">return</span> size;
<a name="l01940"></a>01940         }
<a name="l01941"></a>01941 
<a name="l01951"></a><a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a935c7c01e6d63339e6250887b86bd584">01951</a>         uint32_t <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a0d73ffa78a159c4201fc6c0d98fb1591" title="Returns only the key by index.">GetIndex</a>(uint32_t index, <a class="code" href="classstx_1_1CBTreeDB.html#a3853858e7d8cc630c832232bc46ed2c0" title="first template parameter: the key type of the B-tree.">key_type</a>&amp; outkey, std::string&amp; outvalue)
<a name="l01952"></a>01952         {
<a name="l01953"></a>01953             <a class="code" href="stx-cbtreedb_8h.html#aea46b67a1c31f750df77b32d5db56e2f" title="Short macro to throw exceptions if a program logic expression fails.">CBTREEDB_CHECK</a>(<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a127dd81bf846ed41baae74aaa14d5e59" title="file stream object currently opened.">m_istream</a>, <span class="stringliteral">&quot;No database loaded.&quot;</span>);
<a name="l01954"></a>01954 
<a name="l01955"></a>01955             uint64_t offset;
<a name="l01956"></a>01956             uint32_t size;
<a name="l01957"></a>01957 
<a name="l01958"></a>01958             <span class="keywordflow">if</span> (!<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#ac2f53460507624518c1fe79f0981db9f" title="Internal function to look directly into the B-tree&amp;#39;s leaf pages and find a key...">FindIndex</a>(index, outkey, offset, size))
<a name="l01959"></a>01959                 <span class="keywordflow">return</span> 0;
<a name="l01960"></a>01960 
<a name="l01961"></a>01961             outvalue.resize(size);
<a name="l01962"></a>01962 
<a name="l01963"></a>01963             <span class="keywordflow">if</span> (!<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#aabc9332e31f4c19a508c6330d899c253" title="Read byte range [offset, offset+size) from value data area into the given buffer...">ReadValueRange</a>(offset, const_cast&lt;char*&gt;(outvalue.data()), size))
<a name="l01964"></a>01964                 <span class="keywordflow">return</span> 0;
<a name="l01965"></a>01965 
<a name="l01966"></a>01966             <span class="keywordflow">return</span> size;
<a name="l01967"></a>01967         }
<a name="l01968"></a>01968 
<a name="l01974"></a><a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a70676ad9056f4218fd8ed2fd519d09b5">01974</a>         <span class="keywordtype">bool</span> <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a70676ad9056f4218fd8ed2fd519d09b5" title="Verify all aspects of the loaded database.">Verify</a>()
<a name="l01975"></a>01975         {
<a name="l01976"></a>01976             <a class="code" href="stx-cbtreedb_8h.html#aea46b67a1c31f750df77b32d5db56e2f" title="Short macro to throw exceptions if a program logic expression fails.">CBTREEDB_CHECK</a>(<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a127dd81bf846ed41baae74aaa14d5e59" title="file stream object currently opened.">m_istream</a>, <span class="stringliteral">&quot;No database loaded.&quot;</span>);
<a name="l01977"></a>01977 
<a name="l01978"></a>01978             <span class="keywordflow">if</span> (!<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#ae8a66caab78c33fa81ec5eaf19e30dc7" title="Verify B-tree structure in the loaded database.">VerifyBTree</a>()) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01979"></a>01979 
<a name="l01980"></a>01980             <span class="keywordflow">if</span> (!<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a5d6722b69910bb7b1d897025093bca5f" title="Verify the SHA256 checksum of the B-tree pages in the loaded database.">VerifyBTreeChecksum</a>()) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01981"></a>01981 
<a name="l01982"></a>01982             <span class="keywordflow">if</span> (!<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a80c66f52eb8b8ab85a1ad544dec8d0bc" title="Verify the SHA256 checksum of value data area in the loaded database.">VerifyValueChecksum</a>()) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01983"></a>01983 
<a name="l01984"></a>01984             <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01985"></a>01985         }
<a name="l01986"></a>01986 
<a name="l01992"></a><a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#ae8a66caab78c33fa81ec5eaf19e30dc7">01992</a>         <span class="keywordtype">bool</span> <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#ae8a66caab78c33fa81ec5eaf19e30dc7" title="Verify B-tree structure in the loaded database.">VerifyBTree</a>()
<a name="l01993"></a>01993         {
<a name="l01994"></a>01994             <a class="code" href="stx-cbtreedb_8h.html#aea46b67a1c31f750df77b32d5db56e2f" title="Short macro to throw exceptions if a program logic expression fails.">CBTREEDB_CHECK</a>(<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a127dd81bf846ed41baae74aaa14d5e59" title="file stream object currently opened.">m_istream</a>, <span class="stringliteral">&quot;No database loaded.&quot;</span>);
<a name="l01995"></a>01995 
<a name="l01996"></a>01996             <span class="keywordflow">if</span> (<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#acac61213eb7fb4a4f8504de5812bc9cc" title="signature page read from file">m_signature</a>.<a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#a0ae66a64d4404955ee7df3d65c298876" title="b-tree total size in bytes">btree_size</a> == 0) <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01997"></a>01997 
<a name="l01998"></a>01998             <a class="code" href="classstx_1_1CBTreeDB.html#a3853858e7d8cc630c832232bc46ed2c0" title="first template parameter: the key type of the B-tree.">key_type</a> minkey = <a class="code" href="classstx_1_1CBTreeDB.html#a3853858e7d8cc630c832232bc46ed2c0" title="first template parameter: the key type of the B-tree.">key_type</a>(), maxkey = <a class="code" href="classstx_1_1CBTreeDB.html#a3853858e7d8cc630c832232bc46ed2c0" title="first template parameter: the key type of the B-tree.">key_type</a>();
<a name="l01999"></a>01999             uint64_t lastoffset = 0;
<a name="l02000"></a>02000             <span class="keywordflow">return</span> <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#afc8bb442ea5b43b172a3a83595171be6" title="Internal function: Recursively verify B-tree structure.">VerifyBTreeNode</a>(0, &amp;minkey, &amp;maxkey, &amp;lastoffset);
<a name="l02001"></a>02001         }
<a name="l02002"></a>02002 
<a name="l02003"></a>02003     <span class="keyword">protected</span>:
<a name="l02007"></a><a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#afc8bb442ea5b43b172a3a83595171be6">02007</a>         <span class="keywordtype">bool</span> <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#afc8bb442ea5b43b172a3a83595171be6" title="Internal function: Recursively verify B-tree structure.">VerifyBTreeNode</a>(uint32_t offset, <a class="code" href="classstx_1_1CBTreeDB.html#a3853858e7d8cc630c832232bc46ed2c0" title="first template parameter: the key type of the B-tree.">key_type</a>* minkey, <a class="code" href="classstx_1_1CBTreeDB.html#a3853858e7d8cc630c832232bc46ed2c0" title="first template parameter: the key type of the B-tree.">key_type</a>* maxkey, uint64_t* lastoffset)
<a name="l02008"></a>02008         {
<a name="l02009"></a>02009             <a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html" title="BTreePage is a reference-counted buffer holding one page of the B-tree index.">BTreePage</a> page = <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a2134578873943a60ef2f66e91000dd18" title="Read one B-tree page from the file (or from cache).">ReadIndexPage</a>(offset);
<a name="l02010"></a>02010 
<a name="l02011"></a>02011             <span class="keywordflow">if</span> ( page.<a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#a70cb9902a330172c4e08e5035c8c2917" title="Returns true if the buffer contains a leaf node.">IsLeafNode</a>() )
<a name="l02012"></a>02012             {
<a name="l02013"></a>02013                 <a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html" title="Leaf node structure of the B-tree leaf pages.">LeafNode</a>* leaf = page.<a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#adccee62c9a689ca5cb2dd8353e0726d2" title="Return buffer casted as a leaf node.">GetAsLeafNode</a>();
<a name="l02014"></a>02014 
<a name="l02015"></a>02015                 <span class="keywordflow">if</span> (*lastoffset != leaf-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#ae16aa36d66c1ec576cdf5885fb7446e8" title="base of value offsets enumerated in array.">baseoffset</a> + leaf-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#a65c94b32f23036adb8e864b440c1c6ae" title="file offset of value data associated with key.">offsets</a>[0]) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02016"></a>02016 
<a name="l02017"></a>02017                 <span class="keywordflow">for</span>(uint16_t s = 0; s &lt; leaf-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#a7355e231680da86d20a036675b9cedc9" title="number of used slots in the arrays.">slots</a> - 1; ++s)
<a name="l02018"></a>02018                 {
<a name="l02019"></a>02019                     <span class="keywordflow">if</span> (!<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a782b6f840494a9a56e2862e718fb7847" title="key comparison functional">m_key_less</a>(leaf-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#a92d237e7bc59ffcfb4530303af043a7f" title="key array of ascending key in this leaf.">keys</a>[s], leaf-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#a92d237e7bc59ffcfb4530303af043a7f" title="key array of ascending key in this leaf.">keys</a>[s+1])) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02020"></a>02020 
<a name="l02021"></a>02021                     <span class="keywordflow">if</span> (!(leaf-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#a65c94b32f23036adb8e864b440c1c6ae" title="file offset of value data associated with key.">offsets</a>[s] &lt;= leaf-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#a65c94b32f23036adb8e864b440c1c6ae" title="file offset of value data associated with key.">offsets</a>[s+1])) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02022"></a>02022                 }
<a name="l02023"></a>02023 
<a name="l02024"></a>02024                 *minkey = leaf-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#a92d237e7bc59ffcfb4530303af043a7f" title="key array of ascending key in this leaf.">keys</a>[0];
<a name="l02025"></a>02025                 *maxkey = leaf-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#a92d237e7bc59ffcfb4530303af043a7f" title="key array of ascending key in this leaf.">keys</a>[leaf-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#a7355e231680da86d20a036675b9cedc9" title="number of used slots in the arrays.">slots</a> - 1];
<a name="l02026"></a>02026                 *lastoffset = leaf-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#ae16aa36d66c1ec576cdf5885fb7446e8" title="base of value offsets enumerated in array.">baseoffset</a> + leaf-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#a65c94b32f23036adb8e864b440c1c6ae" title="file offset of value data associated with key.">offsets</a>[leaf-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#a7355e231680da86d20a036675b9cedc9" title="number of used slots in the arrays.">slots</a>];
<a name="l02027"></a>02027             }
<a name="l02028"></a>02028             <span class="keywordflow">else</span>
<a name="l02029"></a>02029             {
<a name="l02030"></a>02030                 <a class="code" href="structstx_1_1CBTreeDB_1_1InnerNode.html" title="Inner node structure of the B-tree inner pages.">InnerNode</a>* inner = page.<a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#adfa632cd49bde968f9064ddb8562d94e" title="Return buffer casted as an inner node.">GetAsInnerNode</a>();
<a name="l02031"></a>02031 
<a name="l02032"></a>02032                 <span class="keywordflow">for</span>(uint16_t s = 0; s &lt; inner-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1InnerNode.html#a39993c719c0479b1ab32d0b64758ecf0" title="number of used slots in the arrays.">slots</a> - 1; ++s)
<a name="l02033"></a>02033                 {
<a name="l02034"></a>02034                     <span class="keywordflow">if</span> (!<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a782b6f840494a9a56e2862e718fb7847" title="key comparison functional">m_key_less</a>(inner-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1InnerNode.html#ae991d7c99f3ab0820bcd0254ed53fca8" title="key array of ascending keys in this inner node.">keys</a>[s], inner-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1InnerNode.html#ae991d7c99f3ab0820bcd0254ed53fca8" title="key array of ascending keys in this inner node.">keys</a>[s+1])) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02035"></a>02035                 }
<a name="l02036"></a>02036 
<a name="l02037"></a>02037                 <span class="keywordflow">for</span>(uint16_t s = 0; s &lt;= inner-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1InnerNode.html#a39993c719c0479b1ab32d0b64758ecf0" title="number of used slots in the arrays.">slots</a>; ++s)
<a name="l02038"></a>02038                 {
<a name="l02039"></a>02039                     uint32_t childoffset = inner-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1InnerNode.html#aa8a393e3980026418172cb866576d47e" title="base offset of child B-tree nodes enumerated by keys.">childrenoffset</a>;
<a name="l02040"></a>02040 
<a name="l02041"></a>02041                     <span class="keywordflow">if</span> (inner-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1InnerNode.html#a03dfd6173cbf57de4bf30dbe2c1c23bb" title="level of this inner node, always &amp;gt; 0.">level</a> &gt; 1)
<a name="l02042"></a>02042                         childoffset += s * <span class="keyword">sizeof</span>(<a class="code" href="structstx_1_1CBTreeDB_1_1InnerNode.html" title="Inner node structure of the B-tree inner pages.">InnerNode</a>);
<a name="l02043"></a>02043                     <span class="keywordflow">else</span>
<a name="l02044"></a>02044                         childoffset += s * <span class="keyword">sizeof</span>(<a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html" title="Leaf node structure of the B-tree leaf pages.">LeafNode</a>);
<a name="l02045"></a>02045 
<a name="l02046"></a>02046                     <a class="code" href="classstx_1_1CBTreeDB.html#a3853858e7d8cc630c832232bc46ed2c0" title="first template parameter: the key type of the B-tree.">key_type</a> subminkey = <a class="code" href="classstx_1_1CBTreeDB.html#a3853858e7d8cc630c832232bc46ed2c0" title="first template parameter: the key type of the B-tree.">key_type</a>(), submaxkey = <a class="code" href="classstx_1_1CBTreeDB.html#a3853858e7d8cc630c832232bc46ed2c0" title="first template parameter: the key type of the B-tree.">key_type</a>();
<a name="l02047"></a>02047 
<a name="l02048"></a>02048                     <span class="keywordflow">if</span> (!<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#afc8bb442ea5b43b172a3a83595171be6" title="Internal function: Recursively verify B-tree structure.">VerifyBTreeNode</a>(childoffset, &amp;subminkey, &amp;submaxkey, lastoffset)) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02049"></a>02049 
<a name="l02050"></a>02050                     <span class="keywordflow">if</span> (s == 0)
<a name="l02051"></a>02051                         *minkey = subminkey;
<a name="l02052"></a>02052                     <span class="keywordflow">else</span>
<a name="l02053"></a>02053                         <span class="keywordflow">if</span> (!<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a782b6f840494a9a56e2862e718fb7847" title="key comparison functional">m_key_less</a>(inner-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1InnerNode.html#ae991d7c99f3ab0820bcd0254ed53fca8" title="key array of ascending keys in this inner node.">keys</a>[s-1], subminkey)) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02054"></a>02054 
<a name="l02055"></a>02055                     <span class="keywordflow">if</span> (s == inner-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1InnerNode.html#a39993c719c0479b1ab32d0b64758ecf0" title="number of used slots in the arrays.">slots</a>)
<a name="l02056"></a>02056                         *maxkey = submaxkey;
<a name="l02057"></a>02057                     <span class="keywordflow">else</span>
<a name="l02058"></a>02058                         <span class="keywordflow">if</span> (!<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a2e08f1c599309c6801005cf698dac342" title="Function to test key equality, constructed from m_key_less.">KeyEqual</a>(inner-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1InnerNode.html#ae991d7c99f3ab0820bcd0254ed53fca8" title="key array of ascending keys in this inner node.">keys</a>[s], submaxkey)) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02059"></a>02059                 }
<a name="l02060"></a>02060             }
<a name="l02061"></a>02061 
<a name="l02062"></a>02062             <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02063"></a>02063         }
<a name="l02064"></a>02064 
<a name="l02065"></a>02065     <span class="keyword">public</span>:
<a name="l02072"></a><a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a5d6722b69910bb7b1d897025093bca5f">02072</a>         <span class="keywordtype">bool</span> <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a5d6722b69910bb7b1d897025093bca5f" title="Verify the SHA256 checksum of the B-tree pages in the loaded database.">VerifyBTreeChecksum</a>()
<a name="l02073"></a>02073         {
<a name="l02074"></a>02074             <a class="code" href="stx-cbtreedb_8h.html#aea46b67a1c31f750df77b32d5db56e2f" title="Short macro to throw exceptions if a program logic expression fails.">CBTREEDB_CHECK</a>(<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a127dd81bf846ed41baae74aaa14d5e59" title="file stream object currently opened.">m_istream</a>, <span class="stringliteral">&quot;No database loaded.&quot;</span>);
<a name="l02075"></a>02075 
<a name="l02076"></a>02076             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html" title="SHA-256 Message Digest implementation class.">SHA256</a> sha;
<a name="l02077"></a>02077 
<a name="l02078"></a>02078             <span class="keywordflow">for</span>(uint32_t offset = 0; offset &lt; <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#acac61213eb7fb4a4f8504de5812bc9cc" title="signature page read from file">m_signature</a>.<a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#a0ae66a64d4404955ee7df3d65c298876" title="b-tree total size in bytes">btree_size</a>; offset += <a class="code" href="classstx_1_1CBTreeDB.html#a924efff56b96b6c5a0397211b0cf8685" title="third template parameter: B-tree page size. Usually 1024 or 2048.">BTreePageSize</a>)
<a name="l02079"></a>02079             {
<a name="l02080"></a>02080                 <a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html" title="BTreePage is a reference-counted buffer holding one page of the B-tree index.">BTreePage</a> page = <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a2134578873943a60ef2f66e91000dd18" title="Read one B-tree page from the file (or from cache).">ReadIndexPage</a>(offset);
<a name="l02081"></a>02081 
<a name="l02082"></a>02082                 sha.<a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#ad306a1c3c2f0321301e563af37bb17cd" title="Update this SHA256 calculation with new data.">update</a>(page.<a class="code" href="classstx_1_1CBTreeDB_1_1BTreePage.html#a1e933680db2ddcac67adf23555454b0b" title="Accessor: return enclosed buffer pointer.">GetBuffer</a>(), <a class="code" href="classstx_1_1CBTreeDB.html#a924efff56b96b6c5a0397211b0cf8685" title="third template parameter: B-tree page size. Usually 1024 or 2048.">BTreePageSize</a>);
<a name="l02083"></a>02083             }
<a name="l02084"></a>02084 
<a name="l02085"></a>02085             <span class="keywordflow">return</span> ( sha.<a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a12bc94d3a0700ae7dcc47b15bae1cde8" title="Returns true if the final SHA256 digest of this object equals the given data.">final_equals</a>(<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#acac61213eb7fb4a4f8504de5812bc9cc" title="signature page read from file">m_signature</a>.<a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#a927c832ad13552500beb604ea44ee7ea" title="SHA256 digest of all tree nodes.">btree_sha256</a>) );
<a name="l02086"></a>02086         }
<a name="l02087"></a>02087 
<a name="l02094"></a><a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a80c66f52eb8b8ab85a1ad544dec8d0bc">02094</a>         <span class="keywordtype">bool</span> <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a80c66f52eb8b8ab85a1ad544dec8d0bc" title="Verify the SHA256 checksum of value data area in the loaded database.">VerifyValueChecksum</a>()
<a name="l02095"></a>02095         {
<a name="l02096"></a>02096             <a class="code" href="stx-cbtreedb_8h.html#aea46b67a1c31f750df77b32d5db56e2f" title="Short macro to throw exceptions if a program logic expression fails.">CBTREEDB_CHECK</a>(<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a127dd81bf846ed41baae74aaa14d5e59" title="file stream object currently opened.">m_istream</a>, <span class="stringliteral">&quot;No database loaded.&quot;</span>);
<a name="l02097"></a>02097 
<a name="l02098"></a>02098             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html" title="SHA-256 Message Digest implementation class.">SHA256</a> sha;
<a name="l02099"></a>02099 
<a name="l02100"></a>02100             <span class="keywordtype">char</span> buffer[64*1024];
<a name="l02101"></a>02101 
<a name="l02102"></a>02102             <span class="keywordflow">for</span>(uint64_t offset = 0; offset &lt; <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#acac61213eb7fb4a4f8504de5812bc9cc" title="signature page read from file">m_signature</a>.<a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#ae7b237b7498fe2cc48844222861de850" title="total size of value data area">value_size</a>; offset += <span class="keyword">sizeof</span>(buffer))
<a name="l02103"></a>02103             {
<a name="l02104"></a>02104                 uint64_t remsize = std::min&lt;uint64_t&gt;(<span class="keyword">sizeof</span>(buffer), <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#acac61213eb7fb4a4f8504de5812bc9cc" title="signature page read from file">m_signature</a>.<a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#ae7b237b7498fe2cc48844222861de850" title="total size of value data area">value_size</a> - offset);
<a name="l02105"></a>02105 
<a name="l02106"></a>02106                 <span class="keywordflow">if</span> (!<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#aabc9332e31f4c19a508c6330d899c253" title="Read byte range [offset, offset+size) from value data area into the given buffer...">ReadValueRange</a>(offset, buffer, remsize))
<a name="l02107"></a>02107                     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02108"></a>02108 
<a name="l02109"></a>02109                 sha.<a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#ad306a1c3c2f0321301e563af37bb17cd" title="Update this SHA256 calculation with new data.">update</a>(buffer, remsize);
<a name="l02110"></a>02110             }
<a name="l02111"></a>02111 
<a name="l02112"></a>02112             <span class="keywordflow">return</span>( sha.<a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a12bc94d3a0700ae7dcc47b15bae1cde8" title="Returns true if the final SHA256 digest of this object equals the given data.">final_equals</a>(<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#acac61213eb7fb4a4f8504de5812bc9cc" title="signature page read from file">m_signature</a>.<a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#a6837b8e8b502df1f3c233e7f5c689d2e" title="SHA256 digest of all value data.">value_sha256</a>) );
<a name="l02113"></a>02113         }
<a name="l02114"></a>02114     };
<a name="l02115"></a>02115 
<a name="l02116"></a>02116 <span class="keyword">public</span>:
<a name="l02124"></a><a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html">02124</a>     <span class="keyword">class </span><a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html" title="Class used to read constant B-tree database files.">Reader</a>
<a name="l02125"></a>02125     {
<a name="l02126"></a>02126     <span class="keyword">protected</span>:
<a name="l02127"></a>02127 
<a name="l02129"></a><a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#ae5ae7a7b32b28b68a89fc5e5de478aeb">02129</a>         <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html" title="Implementation class used to read constant B-tree database files.">ReaderImpl</a>*     <a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#ae5ae7a7b32b28b68a89fc5e5de478aeb" title="pointer to implementation class.">m_impl</a>;
<a name="l02130"></a>02130 
<a name="l02131"></a>02131     <span class="keyword">public</span>:
<a name="l02133"></a><a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#ac455d367a7f22fd1e02458cf3f04cea9">02133</a>         <a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#ac455d367a7f22fd1e02458cf3f04cea9" title="Create new reader, which is initially set to closed state.">Reader</a>(<span class="keyword">const</span> <a class="code" href="classstx_1_1CBTreeDB.html#aa8d64c69bfec9eb6728d50ce1668d522" title="second template parameter: key comparison function object type.">key_compare</a>&amp; key_less=<a class="code" href="classstx_1_1CBTreeDB.html#aa8d64c69bfec9eb6728d50ce1668d522" title="second template parameter: key comparison function object type.">key_compare</a>())
<a name="l02134"></a>02134             : <a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#ae5ae7a7b32b28b68a89fc5e5de478aeb" title="pointer to implementation class.">m_impl</a>(new <a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html" title="Implementation class used to read constant B-tree database files.">ReaderImpl</a>(key_less))
<a name="l02135"></a>02135         {
<a name="l02136"></a>02136             <a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#ae5ae7a7b32b28b68a89fc5e5de478aeb" title="pointer to implementation class.">m_impl</a>-&gt;<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a098443c5ed8f8e7a62b488e5e39e149c" title="Increment reference counter by one.">RefInc</a>();
<a name="l02137"></a>02137         }
<a name="l02138"></a>02138 
<a name="l02140"></a><a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#a73f797c830684ac0f6a2b6fcc315057a">02140</a>         <a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#ac455d367a7f22fd1e02458cf3f04cea9" title="Create new reader, which is initially set to closed state.">Reader</a>(<span class="keyword">const</span> <a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html" title="Class used to read constant B-tree database files.">Reader</a>&amp; rd)
<a name="l02141"></a>02141             : <a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#ae5ae7a7b32b28b68a89fc5e5de478aeb" title="pointer to implementation class.">m_impl</a>(rd.<a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#ae5ae7a7b32b28b68a89fc5e5de478aeb" title="pointer to implementation class.">m_impl</a>)
<a name="l02142"></a>02142         {
<a name="l02143"></a>02143             <a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#ae5ae7a7b32b28b68a89fc5e5de478aeb" title="pointer to implementation class.">m_impl</a>-&gt;<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a098443c5ed8f8e7a62b488e5e39e149c" title="Increment reference counter by one.">RefInc</a>();
<a name="l02144"></a>02144         }
<a name="l02145"></a>02145 
<a name="l02148"></a><a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#a49bcd0ae28a6b05fc57fb7b65786e09b">02148</a>         <a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#a49bcd0ae28a6b05fc57fb7b65786e09b" title="Destructor: decrement reference counter on buffer and possibly deallocate it.">~Reader</a>()
<a name="l02149"></a>02149         {
<a name="l02150"></a>02150             <span class="keywordflow">if</span> (<a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#ae5ae7a7b32b28b68a89fc5e5de478aeb" title="pointer to implementation class.">m_impl</a>-&gt;<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a8e42bdcc7582888d961da20aedf7474e" title="Decrement reference counter by one and return it.">RefDec</a>() == 0)
<a name="l02151"></a>02151                 <span class="keyword">delete</span> <a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#ae5ae7a7b32b28b68a89fc5e5de478aeb" title="pointer to implementation class.">m_impl</a>;
<a name="l02152"></a>02152         }
<a name="l02153"></a>02153 
<a name="l02155"></a><a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#ad786b607caf226d1807fbe663f031d3c">02155</a>         <a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html" title="Class used to read constant B-tree database files.">Reader</a>&amp; <a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#ad786b607caf226d1807fbe663f031d3c" title="Assignment Operator: increment reference counter on base object.">operator=</a>(<span class="keyword">const</span> <a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html" title="Class used to read constant B-tree database files.">Reader</a>&amp; rd)
<a name="l02156"></a>02156         {
<a name="l02157"></a>02157             <span class="keywordflow">if</span> (<span class="keyword">this</span> != &amp;rd)
<a name="l02158"></a>02158             {
<a name="l02159"></a>02159                 <span class="keywordflow">if</span> (<a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#ae5ae7a7b32b28b68a89fc5e5de478aeb" title="pointer to implementation class.">m_impl</a>-&gt;<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a8e42bdcc7582888d961da20aedf7474e" title="Decrement reference counter by one and return it.">RefDec</a>() == 0)
<a name="l02160"></a>02160                     <span class="keyword">delete</span> <a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#ae5ae7a7b32b28b68a89fc5e5de478aeb" title="pointer to implementation class.">m_impl</a>;
<a name="l02161"></a>02161 
<a name="l02162"></a>02162                 <a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#ae5ae7a7b32b28b68a89fc5e5de478aeb" title="pointer to implementation class.">m_impl</a> = rd.<a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#ae5ae7a7b32b28b68a89fc5e5de478aeb" title="pointer to implementation class.">m_impl</a>;
<a name="l02163"></a>02163                 <a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#ae5ae7a7b32b28b68a89fc5e5de478aeb" title="pointer to implementation class.">m_impl</a>-&gt;<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a098443c5ed8f8e7a62b488e5e39e149c" title="Increment reference counter by one.">RefInc</a>();
<a name="l02164"></a>02164             }
<a name="l02165"></a>02165 
<a name="l02166"></a>02166             <span class="keywordflow">return</span> *<span class="keyword">this</span>;
<a name="l02167"></a>02167         }
<a name="l02168"></a>02168 
<a name="l02174"></a><a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#a9f5d663788ccb536b535a659a241c3d2">02174</a>         <span class="keywordtype">void</span> <a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#a9f5d663788ccb536b535a659a241c3d2" title="Change the database signature (first 8 bytes) from &amp;#39;cbtreedb&amp;#39; to a custom...">SetSignature</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* newsignature)
<a name="l02175"></a>02175         {
<a name="l02176"></a>02176             <span class="keywordflow">return</span> <a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#ae5ae7a7b32b28b68a89fc5e5de478aeb" title="pointer to implementation class.">m_impl</a>-&gt;<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#ac8391c872514c45fd8eb57fa5fa431a9" title="Change the database signature (first 8 bytes) from &amp;#39;cbtreedb&amp;#39; to a custom...">SetSignature</a>(newsignature);
<a name="l02177"></a>02177         }
<a name="l02178"></a>02178 
<a name="l02189"></a><a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#ad4653b248da59d01ef55890f2004047c">02189</a>         <span class="keywordtype">bool</span> <a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#ad4653b248da59d01ef55890f2004047c" title="Attempt to open a cbtreedb database file.">Open</a>(std::istream&amp; file, std::string* errortext = NULL)
<a name="l02190"></a>02190         {
<a name="l02191"></a>02191             <span class="keywordflow">return</span> <a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#ae5ae7a7b32b28b68a89fc5e5de478aeb" title="pointer to implementation class.">m_impl</a>-&gt;<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a835dfdb78068c4ba4720a44b60372a7e" title="Attempt to open a cbtreedb database file.">Open</a>(file, errortext);
<a name="l02192"></a>02192         }
<a name="l02193"></a>02193 
<a name="l02197"></a><a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#a82fd911672784c71877eab90327a245d">02197</a>         <span class="keywordtype">void</span> <a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#a82fd911672784c71877eab90327a245d" title="Close the opened database.">Close</a>()
<a name="l02198"></a>02198         {
<a name="l02199"></a>02199             <span class="keywordflow">return</span> <a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#ae5ae7a7b32b28b68a89fc5e5de478aeb" title="pointer to implementation class.">m_impl</a>-&gt;<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a7a215ab363ae9517e629d7c332252fb6" title="Close the opened database.">Close</a>();
<a name="l02200"></a>02200         }
<a name="l02201"></a>02201 
<a name="l02203"></a><a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#a8f6b740c7d2eea434bfa2c015343618e">02203</a>         <span class="keywordtype">void</span> <a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#a8f6b740c7d2eea434bfa2c015343618e" title="Change the currently used page cache object.">SetPageCache</a>(<a class="code" href="classstx_1_1CBTreeDB_1_1PageCache.html" title="PageCache and PageCacheImpl implement a LRU-strategy cache of B-tree pages used by...">PageCache</a>* newpagecache)
<a name="l02204"></a>02204         {
<a name="l02205"></a>02205             <span class="keywordflow">return</span> <a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#ae5ae7a7b32b28b68a89fc5e5de478aeb" title="pointer to implementation class.">m_impl</a>-&gt;<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a679f537a80c1985cce214bb76675f223" title="Change the currently used page cache object.">SetPageCache</a>(newpagecache);
<a name="l02206"></a>02206         }
<a name="l02207"></a>02207 
<a name="l02211"></a><a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#afb7c1c6e8e07552caf903012c04971ab">02211</a>         uint32_t <a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#afb7c1c6e8e07552caf903012c04971ab" title="Returns the number of items in the loaded database.">Size</a>()<span class="keyword"> const</span>
<a name="l02212"></a>02212 <span class="keyword">        </span>{
<a name="l02213"></a>02213             <span class="keywordflow">return</span> <a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#ae5ae7a7b32b28b68a89fc5e5de478aeb" title="pointer to implementation class.">m_impl</a>-&gt;<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#ab40620b926ca9f0a46e82b08d524fc1a" title="Returns the number of items in the loaded database.">Size</a>();
<a name="l02214"></a>02214         }
<a name="l02215"></a>02215 
<a name="l02220"></a><a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#a3ee95bb080f214a2f59b3ccc5618591e">02220</a>         <span class="keyword">const</span> <a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html" title="Signature page which heads all cbtreedb files.">SignaturePage</a>&amp; <a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#a3ee95bb080f214a2f59b3ccc5618591e" title="Returns a const reference to the signature page of the currently loaded database...">GetSignature</a>()<span class="keyword"> const</span>
<a name="l02221"></a>02221 <span class="keyword">        </span>{
<a name="l02222"></a>02222             <span class="keywordflow">return</span> <a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#ae5ae7a7b32b28b68a89fc5e5de478aeb" title="pointer to implementation class.">m_impl</a>-&gt;<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#ae464958b91b949125fb940cc58fe7398" title="Returns a const reference to the signature page of the currently loaded database...">GetSignature</a>();
<a name="l02223"></a>02223         }
<a name="l02224"></a>02224 
<a name="l02231"></a><a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#a2da743e3f6302a950f0ce26d01268b80">02231</a>         <span class="keywordtype">bool</span> <a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#a2da743e3f6302a950f0ce26d01268b80" title="Check if a key is in the constant database.">Exists</a>(<span class="keyword">const</span> <a class="code" href="classstx_1_1CBTreeDB.html#a3853858e7d8cc630c832232bc46ed2c0" title="first template parameter: the key type of the B-tree.">key_type</a>&amp; key)
<a name="l02232"></a>02232         {
<a name="l02233"></a>02233             <span class="keywordflow">return</span> <a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#ae5ae7a7b32b28b68a89fc5e5de478aeb" title="pointer to implementation class.">m_impl</a>-&gt;<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#af6b4e2ab54b52205bf9d219972aa16b5" title="Check if a key is in the constant database.">Exists</a>(key);
<a name="l02234"></a>02234         }
<a name="l02235"></a>02235 
<a name="l02245"></a><a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#ac4473a0cdd049876c7f8f98de452841b">02245</a>         <span class="keywordtype">bool</span> <a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#ac4473a0cdd049876c7f8f98de452841b" title="Find a key in the constant database.">Lookup</a>(<span class="keyword">const</span> <a class="code" href="classstx_1_1CBTreeDB.html#a3853858e7d8cc630c832232bc46ed2c0" title="first template parameter: the key type of the B-tree.">key_type</a>&amp; key, <span class="keywordtype">void</span>* outvalue, uint32_t maxsize)
<a name="l02246"></a>02246         {
<a name="l02247"></a>02247             <span class="keywordflow">return</span> <a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#ae5ae7a7b32b28b68a89fc5e5de478aeb" title="pointer to implementation class.">m_impl</a>-&gt;<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a3028a30dca7f22b3bacc598413f2768f" title="Find a key in the constant database.">Lookup</a>(key, outvalue, maxsize);
<a name="l02248"></a>02248         }
<a name="l02249"></a>02249 
<a name="l02258"></a><a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#a97ed8994623c735cb07071371b305cef">02258</a>         <span class="keywordtype">bool</span> <a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#ac4473a0cdd049876c7f8f98de452841b" title="Find a key in the constant database.">Lookup</a>(<span class="keyword">const</span> <a class="code" href="classstx_1_1CBTreeDB.html#a3853858e7d8cc630c832232bc46ed2c0" title="first template parameter: the key type of the B-tree.">key_type</a>&amp; key, std::string&amp; outvalue)
<a name="l02259"></a>02259         {
<a name="l02260"></a>02260             <span class="keywordflow">return</span> <a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#ae5ae7a7b32b28b68a89fc5e5de478aeb" title="pointer to implementation class.">m_impl</a>-&gt;<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a3028a30dca7f22b3bacc598413f2768f" title="Find a key in the constant database.">Lookup</a>(key, outvalue);
<a name="l02261"></a>02261         }
<a name="l02262"></a>02262 
<a name="l02271"></a><a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#ae5c602222ae333d36cfbfd0040261dba">02271</a>         std::string <a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#ae5c602222ae333d36cfbfd0040261dba" title="Find a key in the constant database.">operator[]</a>(<span class="keyword">const</span> <a class="code" href="classstx_1_1CBTreeDB.html#a3853858e7d8cc630c832232bc46ed2c0" title="first template parameter: the key type of the B-tree.">key_type</a>&amp; key)
<a name="l02272"></a>02272         {
<a name="l02273"></a>02273             <span class="keywordflow">return</span> (*<a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#ae5ae7a7b32b28b68a89fc5e5de478aeb" title="pointer to implementation class.">m_impl</a>)[key];
<a name="l02274"></a>02274         }
<a name="l02275"></a>02275 
<a name="l02283"></a><a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#affb374aed822d0552e16c7627a8acdf1">02283</a>         uint32_t <a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#affb374aed822d0552e16c7627a8acdf1" title="Returns only the key by index.">GetIndex</a>(uint32_t index, <a class="code" href="classstx_1_1CBTreeDB.html#a3853858e7d8cc630c832232bc46ed2c0" title="first template parameter: the key type of the B-tree.">key_type</a>&amp; outkey)
<a name="l02284"></a>02284         {
<a name="l02285"></a>02285             <span class="keywordflow">return</span> <a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#ae5ae7a7b32b28b68a89fc5e5de478aeb" title="pointer to implementation class.">m_impl</a>-&gt;<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a0d73ffa78a159c4201fc6c0d98fb1591" title="Returns only the key by index.">GetIndex</a>(index, outkey);
<a name="l02286"></a>02286         }
<a name="l02287"></a>02287 
<a name="l02298"></a><a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#ae8d8b0dfd52c16877e83b740a4c0c4bc">02298</a>         uint32_t <a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#affb374aed822d0552e16c7627a8acdf1" title="Returns only the key by index.">GetIndex</a>(uint32_t index, <a class="code" href="classstx_1_1CBTreeDB.html#a3853858e7d8cc630c832232bc46ed2c0" title="first template parameter: the key type of the B-tree.">key_type</a>&amp; outkey, <span class="keywordtype">void</span>* outvalue, uint32_t maxsize)
<a name="l02299"></a>02299         {
<a name="l02300"></a>02300             <span class="keywordflow">return</span> <a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#ae5ae7a7b32b28b68a89fc5e5de478aeb" title="pointer to implementation class.">m_impl</a>-&gt;<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a0d73ffa78a159c4201fc6c0d98fb1591" title="Returns only the key by index.">GetIndex</a>(index, outkey, outvalue, maxsize);
<a name="l02301"></a>02301         }
<a name="l02302"></a>02302 
<a name="l02312"></a><a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#ac065d5b8e92bce18200610595528c3bb">02312</a>         uint32_t <a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#affb374aed822d0552e16c7627a8acdf1" title="Returns only the key by index.">GetIndex</a>(uint32_t index, <a class="code" href="classstx_1_1CBTreeDB.html#a3853858e7d8cc630c832232bc46ed2c0" title="first template parameter: the key type of the B-tree.">key_type</a>&amp; outkey, std::string&amp; outvalue)
<a name="l02313"></a>02313         {
<a name="l02314"></a>02314             <span class="keywordflow">return</span> <a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#ae5ae7a7b32b28b68a89fc5e5de478aeb" title="pointer to implementation class.">m_impl</a>-&gt;<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a0d73ffa78a159c4201fc6c0d98fb1591" title="Returns only the key by index.">GetIndex</a>(index, outkey, outvalue);
<a name="l02315"></a>02315         }
<a name="l02316"></a>02316 
<a name="l02322"></a><a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#a8cc0d6d965e148c5d317120486e9cb30">02322</a>         <span class="keywordtype">bool</span> <a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#a8cc0d6d965e148c5d317120486e9cb30" title="Verify all aspects of the loaded database.">Verify</a>()
<a name="l02323"></a>02323         {
<a name="l02324"></a>02324             <span class="keywordflow">return</span> <a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#ae5ae7a7b32b28b68a89fc5e5de478aeb" title="pointer to implementation class.">m_impl</a>-&gt;<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a70676ad9056f4218fd8ed2fd519d09b5" title="Verify all aspects of the loaded database.">Verify</a>();
<a name="l02325"></a>02325         }
<a name="l02326"></a>02326 
<a name="l02332"></a><a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#ad37194942b13dfdf7725442382633f54">02332</a>         <span class="keywordtype">bool</span> <a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#ad37194942b13dfdf7725442382633f54" title="Verify B-tree structure in the loaded database.">VerifyBTree</a>()
<a name="l02333"></a>02333         {
<a name="l02334"></a>02334             <span class="keywordflow">return</span> <a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#ae5ae7a7b32b28b68a89fc5e5de478aeb" title="pointer to implementation class.">m_impl</a>-&gt;<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#ae8a66caab78c33fa81ec5eaf19e30dc7" title="Verify B-tree structure in the loaded database.">VerifyBTree</a>();
<a name="l02335"></a>02335         }
<a name="l02336"></a>02336 
<a name="l02343"></a><a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#a23c8ede595bf67515448f1a534937742">02343</a>         <span class="keywordtype">bool</span> <a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#a23c8ede595bf67515448f1a534937742" title="Verify the SHA256 checksum of the B-tree pages in the loaded database.">VerifyBTreeChecksum</a>()
<a name="l02344"></a>02344         {
<a name="l02345"></a>02345             <span class="keywordflow">return</span> <a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#ae5ae7a7b32b28b68a89fc5e5de478aeb" title="pointer to implementation class.">m_impl</a>-&gt;<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a5d6722b69910bb7b1d897025093bca5f" title="Verify the SHA256 checksum of the B-tree pages in the loaded database.">VerifyBTreeChecksum</a>();
<a name="l02346"></a>02346         }
<a name="l02347"></a>02347 
<a name="l02354"></a><a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#ab5abb08af6f4cf88f2b8526ff1fc5733">02354</a>         <span class="keywordtype">bool</span> <a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#ab5abb08af6f4cf88f2b8526ff1fc5733" title="Verify the SHA256 checksum of value data area in the loaded database.">VerifyValueChecksum</a>()
<a name="l02355"></a>02355         {
<a name="l02356"></a>02356             <span class="keywordflow">return</span> <a class="code" href="classstx_1_1CBTreeDB_1_1Reader.html#ae5ae7a7b32b28b68a89fc5e5de478aeb" title="pointer to implementation class.">m_impl</a>-&gt;<a class="code" href="classstx_1_1CBTreeDB_1_1ReaderImpl.html#a80c66f52eb8b8ab85a1ad544dec8d0bc" title="Verify the SHA256 checksum of value data area in the loaded database.">VerifyValueChecksum</a>();
<a name="l02357"></a>02357         }
<a name="l02358"></a>02358     };
<a name="l02359"></a>02359 
<a name="l02360"></a>02360 <span class="keyword">protected</span>:
<a name="l02361"></a>02361 
<a name="l02370"></a><a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html">02370</a>     <span class="keyword">class </span><a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html" title="BTreeBuilder is used to construct an index very similar to a B-tree from an ordered...">BTreeBuilder</a>
<a name="l02371"></a>02371     {
<a name="l02372"></a>02372     <span class="keyword">protected</span>:
<a name="l02373"></a>02373 
<a name="l02375"></a><a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#abc5a72f520aea36cedc81f1d6680e4aa">02375</a>         <a class="code" href="classstx_1_1CBTreeDB.html#aa8d64c69bfec9eb6728d50ce1668d522" title="second template parameter: key comparison function object type.">key_compare</a>     <a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#abc5a72f520aea36cedc81f1d6680e4aa" title="key comparison functional">m_key_less</a>;
<a name="l02376"></a>02376 
<a name="l02378"></a><a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#a6d312058dd8938bc9c5aaaa423fdc4ca">02378</a>         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>    <a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#a6d312058dd8938bc9c5aaaa423fdc4ca" title="total number of items stored in the tree">m_size</a>;
<a name="l02379"></a>02379 
<a name="l02381"></a><a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#a8ce8b78ff1013c69a31759bd1f6aa7ed">02381</a>         std::vector&lt;LeafNode&gt; <a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#a8ce8b78ff1013c69a31759bd1f6aa7ed" title="leaves of the B-tree">m_leaves</a>;
<a name="l02382"></a>02382 
<a name="l02384"></a><a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#a873e81f1935c6fd22e024f8ed6cb5b52">02384</a>         <span class="keyword">typedef</span> std::vector&lt;InnerNode&gt; <a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#a873e81f1935c6fd22e024f8ed6cb5b52" title="typedef of each inner level of the B-tree">innerlevel_type</a>;
<a name="l02385"></a>02385 
<a name="l02388"></a><a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#ad61bca5d7bf3abff9b478f5a4c58bf58">02388</a>         std::vector&lt;innerlevel_type&gt; <a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#ad61bca5d7bf3abff9b478f5a4c58bf58" title="vector holding a list of b-tree inner levels.">m_inners</a>;
<a name="l02389"></a>02389 
<a name="l02390"></a>02390     <span class="keyword">public</span>:
<a name="l02392"></a><a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#ac8e32f16e7d5dc7f96a2051dce2cd093">02392</a>         <a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#ac8e32f16e7d5dc7f96a2051dce2cd093" title="Construct a new empty tree builder.">BTreeBuilder</a>(<span class="keyword">const</span> <a class="code" href="classstx_1_1CBTreeDB.html#aa8d64c69bfec9eb6728d50ce1668d522" title="second template parameter: key comparison function object type.">key_compare</a>&amp; key_less)
<a name="l02393"></a>02393             : <a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#abc5a72f520aea36cedc81f1d6680e4aa" title="key comparison functional">m_key_less</a>(key_less), <a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#a6d312058dd8938bc9c5aaaa423fdc4ca" title="total number of items stored in the tree">m_size</a>(0)
<a name="l02394"></a>02394         {
<a name="l02395"></a>02395         }
<a name="l02396"></a>02396 
<a name="l02397"></a>02397     <span class="keyword">protected</span>:
<a name="l02400"></a><a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#a6b2684d689e58735a8bfaf84d7de02a7">02400</a>         <span class="keywordtype">void</span> <a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#a6b2684d689e58735a8bfaf84d7de02a7" title="Add a key value in an inner node at given level.">AddInner</a>(uint16_t level, <span class="keyword">const</span> <a class="code" href="classstx_1_1CBTreeDB.html#a3853858e7d8cc630c832232bc46ed2c0" title="first template parameter: the key type of the B-tree.">key_type</a>&amp; key)
<a name="l02401"></a>02401         {
<a name="l02402"></a>02402             <span class="keywordflow">if</span> (<a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#ad61bca5d7bf3abff9b478f5a4c58bf58" title="vector holding a list of b-tree inner levels.">m_inners</a>.size() &lt; level)
<a name="l02403"></a>02403             {
<a name="l02404"></a>02404                 <a class="code" href="stx-cbtreedb_8h.html#ab44bd6c500e8dbe3a232e4c44f28b67e" title="Instead of assert() we use this macro to throw exceptions.">CBTREEDB_ASSERT</a>(<a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#ad61bca5d7bf3abff9b478f5a4c58bf58" title="vector holding a list of b-tree inner levels.">m_inners</a>.size()+1 == level);
<a name="l02405"></a>02405 
<a name="l02406"></a>02406                 <span class="comment">// Create vector for this level</span>
<a name="l02407"></a>02407                 <a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#ad61bca5d7bf3abff9b478f5a4c58bf58" title="vector holding a list of b-tree inner levels.">m_inners</a>.push_back(<a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#a873e81f1935c6fd22e024f8ed6cb5b52" title="typedef of each inner level of the B-tree">innerlevel_type</a>());
<a name="l02408"></a>02408             }
<a name="l02409"></a>02409 
<a name="l02410"></a>02410             <span class="keywordflow">if</span> (<a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#ad61bca5d7bf3abff9b478f5a4c58bf58" title="vector holding a list of b-tree inner levels.">m_inners</a>[level-1].size() == 0)
<a name="l02411"></a>02411             {
<a name="l02412"></a>02412                 <span class="comment">// Create first inner node on this level</span>
<a name="l02413"></a>02413                 <a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#ad61bca5d7bf3abff9b478f5a4c58bf58" title="vector holding a list of b-tree inner levels.">m_inners</a>[level-1].push_back(<a class="code" href="structstx_1_1CBTreeDB_1_1InnerNode.html" title="Inner node structure of the B-tree inner pages.">InnerNode</a>(level));
<a name="l02414"></a>02414             }
<a name="l02415"></a>02415 
<a name="l02416"></a>02416             <a class="code" href="structstx_1_1CBTreeDB_1_1InnerNode.html" title="Inner node structure of the B-tree inner pages.">InnerNode</a>* inner = &amp;<a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#ad61bca5d7bf3abff9b478f5a4c58bf58" title="vector holding a list of b-tree inner levels.">m_inners</a>[level-1].back();
<a name="l02417"></a>02417 
<a name="l02418"></a>02418             <a class="code" href="stx-cbtreedb_8h.html#ab44bd6c500e8dbe3a232e4c44f28b67e" title="Instead of assert() we use this macro to throw exceptions.">CBTREEDB_ASSERT</a>(inner-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1InnerNode.html#a39993c719c0479b1ab32d0b64758ecf0" title="number of used slots in the arrays.">slots</a> == 0 || <a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#abc5a72f520aea36cedc81f1d6680e4aa" title="key comparison functional">m_key_less</a>(inner-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1InnerNode.html#abaa4fd865be345c309841c93e68c9646" title="Returns the currently last key in the node.">LastKey</a>(), key));
<a name="l02419"></a>02419 
<a name="l02420"></a>02420             <span class="keywordflow">if</span> (inner-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1InnerNode.html#a4cb8908d7a882ea35a895f9479d6a9ec" title="Returns true if no more keys can be added.">IsFull</a>())
<a name="l02421"></a>02421             {
<a name="l02422"></a>02422                 <a class="code" href="stx-cbtreedb_8h.html#ab44bd6c500e8dbe3a232e4c44f28b67e" title="Instead of assert() we use this macro to throw exceptions.">CBTREEDB_ASSERT</a>(<a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#abc5a72f520aea36cedc81f1d6680e4aa" title="key comparison functional">m_key_less</a>(inner-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1InnerNode.html#abaa4fd865be345c309841c93e68c9646" title="Returns the currently last key in the node.">LastKey</a>(), key));
<a name="l02423"></a>02423 
<a name="l02424"></a>02424                 <span class="comment">// Put last key of leaf key into inner node(s) of higher level</span>
<a name="l02425"></a>02425                 <a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#a6b2684d689e58735a8bfaf84d7de02a7" title="Add a key value in an inner node at given level.">AddInner</a>(inner-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1InnerNode.html#a03dfd6173cbf57de4bf30dbe2c1c23bb" title="level of this inner node, always &amp;gt; 0.">level</a> + 1, key);
<a name="l02426"></a>02426 
<a name="l02427"></a>02427                 <span class="comment">// Create new inner node</span>
<a name="l02428"></a>02428                 <a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#ad61bca5d7bf3abff9b478f5a4c58bf58" title="vector holding a list of b-tree inner levels.">m_inners</a>[level-1].push_back(<a class="code" href="structstx_1_1CBTreeDB_1_1InnerNode.html" title="Inner node structure of the B-tree inner pages.">InnerNode</a>(level));
<a name="l02429"></a>02429                 inner = &amp;<a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#ad61bca5d7bf3abff9b478f5a4c58bf58" title="vector holding a list of b-tree inner levels.">m_inners</a>[level-1].back();
<a name="l02430"></a>02430             }
<a name="l02431"></a>02431             <span class="keywordflow">else</span>
<a name="l02432"></a>02432             {
<a name="l02433"></a>02433                 <span class="comment">// Append Key</span>
<a name="l02434"></a>02434                 inner-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1InnerNode.html#ae991d7c99f3ab0820bcd0254ed53fca8" title="key array of ascending keys in this inner node.">keys</a>[inner-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1InnerNode.html#a39993c719c0479b1ab32d0b64758ecf0" title="number of used slots in the arrays.">slots</a>++] = key;
<a name="l02435"></a>02435             }
<a name="l02436"></a>02436         }
<a name="l02437"></a>02437 
<a name="l02438"></a>02438     <span class="keyword">public</span>:
<a name="l02444"></a><a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#ae6f069858c21620aab5f3420e81f87c4">02444</a>         <span class="keywordtype">void</span> <a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#ae6f069858c21620aab5f3420e81f87c4" title="Insert a new key into the tree together with (offset,size) of the associated data...">Add</a>(<span class="keyword">const</span> <a class="code" href="classstx_1_1CBTreeDB.html#a3853858e7d8cc630c832232bc46ed2c0" title="first template parameter: the key type of the B-tree.">key_type</a>&amp; key, uint64_t offset, uint32_t size)
<a name="l02445"></a>02445         {
<a name="l02446"></a>02446             <span class="keywordflow">if</span> (<a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#a8ce8b78ff1013c69a31759bd1f6aa7ed" title="leaves of the B-tree">m_leaves</a>.size() == 0) {
<a name="l02447"></a>02447                 <span class="comment">// create first leaf node</span>
<a name="l02448"></a>02448                 <a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#a8ce8b78ff1013c69a31759bd1f6aa7ed" title="leaves of the B-tree">m_leaves</a>.push_back(<a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html" title="Leaf node structure of the B-tree leaf pages.">LeafNode</a>());
<a name="l02449"></a>02449             }
<a name="l02450"></a>02450 
<a name="l02451"></a>02451             <a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html" title="Leaf node structure of the B-tree leaf pages.">LeafNode</a>* leaf = &amp;<a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#a8ce8b78ff1013c69a31759bd1f6aa7ed" title="leaves of the B-tree">m_leaves</a>.back();
<a name="l02452"></a>02452 
<a name="l02453"></a>02453             <span class="keywordflow">if</span> (leaf-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#a7355e231680da86d20a036675b9cedc9" title="number of used slots in the arrays.">slots</a> &gt; 0) {
<a name="l02454"></a>02454                 <a class="code" href="stx-cbtreedb_8h.html#ab44bd6c500e8dbe3a232e4c44f28b67e" title="Instead of assert() we use this macro to throw exceptions.">CBTREEDB_ASSERT</a>(<a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#abc5a72f520aea36cedc81f1d6680e4aa" title="key comparison functional">m_key_less</a>(leaf-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#a88857726917ddbcb3662c7fc14c4cb91" title="Returns the currently last key in the node.">LastKey</a>(), key));
<a name="l02455"></a>02455             }
<a name="l02456"></a>02456 
<a name="l02457"></a>02457             <span class="keywordflow">if</span> (leaf-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#ac4ea9a2887d2c31f835e466d79ee66b3" title="Returns true if no more keys can be added.">IsFull</a>())
<a name="l02458"></a>02458             {
<a name="l02459"></a>02459                 <span class="comment">// put last key into inner node(s)</span>
<a name="l02460"></a>02460                 <a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#a6b2684d689e58735a8bfaf84d7de02a7" title="Add a key value in an inner node at given level.">AddInner</a>(1, leaf-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#a88857726917ddbcb3662c7fc14c4cb91" title="Returns the currently last key in the node.">LastKey</a>());
<a name="l02461"></a>02461 
<a name="l02462"></a>02462                 <span class="comment">// create new leaf</span>
<a name="l02463"></a>02463                 <a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#a8ce8b78ff1013c69a31759bd1f6aa7ed" title="leaves of the B-tree">m_leaves</a>.push_back(<a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html" title="Leaf node structure of the B-tree leaf pages.">LeafNode</a>());
<a name="l02464"></a>02464                 leaf = &amp;<a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#a8ce8b78ff1013c69a31759bd1f6aa7ed" title="leaves of the B-tree">m_leaves</a>.back();
<a name="l02465"></a>02465                 leaf-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#ae16aa36d66c1ec576cdf5885fb7446e8" title="base of value offsets enumerated in array.">baseoffset</a> = offset;
<a name="l02466"></a>02466             }
<a name="l02467"></a>02467 
<a name="l02468"></a>02468             <span class="comment">// append key + value items relative offset</span>
<a name="l02469"></a>02469             leaf-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#a92d237e7bc59ffcfb4530303af043a7f" title="key array of ascending key in this leaf.">keys</a>[leaf-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#a7355e231680da86d20a036675b9cedc9" title="number of used slots in the arrays.">slots</a>] = key;
<a name="l02470"></a>02470 
<a name="l02471"></a>02471             <a class="code" href="stx-cbtreedb_8h.html#ab44bd6c500e8dbe3a232e4c44f28b67e" title="Instead of assert() we use this macro to throw exceptions.">CBTREEDB_ASSERT</a>(offset &gt;= leaf-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#ae16aa36d66c1ec576cdf5885fb7446e8" title="base of value offsets enumerated in array.">baseoffset</a>);
<a name="l02472"></a>02472             leaf-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#a65c94b32f23036adb8e864b440c1c6ae" title="file offset of value data associated with key.">offsets</a>[leaf-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#a7355e231680da86d20a036675b9cedc9" title="number of used slots in the arrays.">slots</a>] = offset - leaf-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#ae16aa36d66c1ec576cdf5885fb7446e8" title="base of value offsets enumerated in array.">baseoffset</a>;
<a name="l02473"></a>02473             leaf-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#a65c94b32f23036adb8e864b440c1c6ae" title="file offset of value data associated with key.">offsets</a>[leaf-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#a7355e231680da86d20a036675b9cedc9" title="number of used slots in the arrays.">slots</a>+1] = leaf-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#a65c94b32f23036adb8e864b440c1c6ae" title="file offset of value data associated with key.">offsets</a>[leaf-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#a7355e231680da86d20a036675b9cedc9" title="number of used slots in the arrays.">slots</a>] + size;
<a name="l02474"></a>02474 
<a name="l02475"></a>02475             ++leaf-&gt;<a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html#a7355e231680da86d20a036675b9cedc9" title="number of used slots in the arrays.">slots</a>;
<a name="l02476"></a>02476             ++<a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#a6d312058dd8938bc9c5aaaa423fdc4ca" title="total number of items stored in the tree">m_size</a>;
<a name="l02477"></a>02477         }
<a name="l02478"></a>02478 
<a name="l02480"></a><a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#ad44cf36a5826bebfefbebd975ef0d3d4">02480</a>         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#ad44cf36a5826bebfefbebd975ef0d3d4" title="Returns the number of items added to the tree.">Size</a>()<span class="keyword"> const</span>
<a name="l02481"></a>02481 <span class="keyword">        </span>{
<a name="l02482"></a>02482             <span class="keywordflow">return</span> <a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#a6d312058dd8938bc9c5aaaa423fdc4ca" title="total number of items stored in the tree">m_size</a>;
<a name="l02483"></a>02483         }
<a name="l02484"></a>02484 
<a name="l02486"></a><a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#a655484b99e9a586938c10724dab3caaa">02486</a>         <span class="keyword">const</span> <a class="code" href="classstx_1_1CBTreeDB.html#a3853858e7d8cc630c832232bc46ed2c0" title="first template parameter: the key type of the B-tree.">key_type</a>&amp; <a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#a655484b99e9a586938c10724dab3caaa" title="Return highest key currently inserted in the tree.">GetLastKey</a>()<span class="keyword"> const</span>
<a name="l02487"></a>02487 <span class="keyword">        </span>{
<a name="l02488"></a>02488             <a class="code" href="stx-cbtreedb_8h.html#aea46b67a1c31f750df77b32d5db56e2f" title="Short macro to throw exceptions if a program logic expression fails.">CBTREEDB_CHECK</a>(<a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#a6d312058dd8938bc9c5aaaa423fdc4ca" title="total number of items stored in the tree">m_size</a> &gt; 0, <span class="stringliteral">&quot;No keys inserted in the tree yet&quot;</span>);
<a name="l02489"></a>02489 
<a name="l02490"></a>02490             <span class="keywordflow">return</span> <a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#a8ce8b78ff1013c69a31759bd1f6aa7ed" title="leaves of the B-tree">m_leaves</a>.back().LastKey();
<a name="l02491"></a>02491         }
<a name="l02492"></a>02492 
<a name="l02494"></a><a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#ae19fde8f6d5a9caae3abb4ddefd94452">02494</a>         <span class="keywordtype">void</span> <a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#ae19fde8f6d5a9caae3abb4ddefd94452" title="Return key previously inserted at given index.">GetIndex</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> index, <a class="code" href="classstx_1_1CBTreeDB.html#a3853858e7d8cc630c832232bc46ed2c0" title="first template parameter: the key type of the B-tree.">key_type</a>&amp; outkey, uint32_t&amp; outsize)<span class="keyword"> const</span>
<a name="l02495"></a>02495 <span class="keyword">        </span>{
<a name="l02496"></a>02496             <a class="code" href="stx-cbtreedb_8h.html#aea46b67a1c31f750df77b32d5db56e2f" title="Short macro to throw exceptions if a program logic expression fails.">CBTREEDB_CHECK</a>(index &lt; <a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#a6d312058dd8938bc9c5aaaa423fdc4ca" title="total number of items stored in the tree">m_size</a>, <span class="stringliteral">&quot;Attempting to retrieve out of bounds index.&quot;</span>);
<a name="l02497"></a>02497 
<a name="l02498"></a>02498             <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> leafnum = index / <a class="code" href="classstx_1_1CBTreeDB.html#acca9b452de05001486b111a4c415cfcb" title="number of key+offsets in each LeafNode">LeafNodeNumKeys</a>;
<a name="l02499"></a>02499             <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> slot = index % <a class="code" href="classstx_1_1CBTreeDB.html#acca9b452de05001486b111a4c415cfcb" title="number of key+offsets in each LeafNode">LeafNodeNumKeys</a>;
<a name="l02500"></a>02500 
<a name="l02501"></a>02501             <a class="code" href="stx-cbtreedb_8h.html#ab44bd6c500e8dbe3a232e4c44f28b67e" title="Instead of assert() we use this macro to throw exceptions.">CBTREEDB_ASSERT</a>(leafnum &lt; <a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#a8ce8b78ff1013c69a31759bd1f6aa7ed" title="leaves of the B-tree">m_leaves</a>.size());
<a name="l02502"></a>02502 
<a name="l02503"></a>02503             <span class="keyword">const</span> <a class="code" href="structstx_1_1CBTreeDB_1_1LeafNode.html" title="Leaf node structure of the B-tree leaf pages.">LeafNode</a>* leaf = &amp;<a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#a8ce8b78ff1013c69a31759bd1f6aa7ed" title="leaves of the B-tree">m_leaves</a>[leafnum];
<a name="l02504"></a>02504 
<a name="l02505"></a>02505             <a class="code" href="stx-cbtreedb_8h.html#ab44bd6c500e8dbe3a232e4c44f28b67e" title="Instead of assert() we use this macro to throw exceptions.">CBTREEDB_ASSERT</a>(slot &lt; leaf-&gt;slots);
<a name="l02506"></a>02506 
<a name="l02507"></a>02507             outkey = leaf-&gt;keys[slot];
<a name="l02508"></a>02508             outsize = leaf-&gt;offsets[slot+1] - leaf-&gt;offsets[slot];
<a name="l02509"></a>02509         }
<a name="l02510"></a>02510 
<a name="l02511"></a>02511 <span class="preprocessor">#if 0 // extra debug code for printing the tree</span>
<a name="l02512"></a>02512 <span class="preprocessor"></span>
<a name="l02517"></a>02517         <span class="keywordtype">void</span> Print(std::ostream&amp; os)<span class="keyword"> const</span>
<a name="l02518"></a>02518 <span class="keyword">        </span>{
<a name="l02519"></a>02519             os &lt;&lt; <span class="stringliteral">&quot;Leaves:&quot;</span> &lt;&lt; std::endl;
<a name="l02520"></a>02520             <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#a8ce8b78ff1013c69a31759bd1f6aa7ed" title="leaves of the B-tree">m_leaves</a>.size(); ++i)
<a name="l02521"></a>02521             {
<a name="l02522"></a>02522                 os &lt;&lt; i &lt;&lt; <span class="stringliteral">&quot;:&quot;</span>;
<a name="l02523"></a>02523                 <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = 0; j &lt; <a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#a8ce8b78ff1013c69a31759bd1f6aa7ed" title="leaves of the B-tree">m_leaves</a>[i].slots; ++j)
<a name="l02524"></a>02524                 {
<a name="l02525"></a>02525                     os &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; <a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#a8ce8b78ff1013c69a31759bd1f6aa7ed" title="leaves of the B-tree">m_leaves</a>[i].keys[j];
<a name="l02526"></a>02526                 }
<a name="l02527"></a>02527                 os &lt;&lt; std::endl;
<a name="l02528"></a>02528             }
<a name="l02529"></a>02529 
<a name="l02530"></a>02530             <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> l = 0; l &lt; <a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#ad61bca5d7bf3abff9b478f5a4c58bf58" title="vector holding a list of b-tree inner levels.">m_inners</a>.size(); ++l)
<a name="l02531"></a>02531             {
<a name="l02532"></a>02532                 os &lt;&lt; <span class="stringliteral">&quot;Level &quot;</span> &lt;&lt; (l+1) &lt;&lt; std::endl;
<a name="l02533"></a>02533 
<a name="l02534"></a>02534                 <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#ad61bca5d7bf3abff9b478f5a4c58bf58" title="vector holding a list of b-tree inner levels.">m_inners</a>[l].size(); ++i)
<a name="l02535"></a>02535                 {
<a name="l02536"></a>02536                     os &lt;&lt; i &lt;&lt; <span class="stringliteral">&quot;:&quot;</span>;
<a name="l02537"></a>02537                     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = 0; j &lt; <a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#ad61bca5d7bf3abff9b478f5a4c58bf58" title="vector holding a list of b-tree inner levels.">m_inners</a>[l][i].slots; ++j)
<a name="l02538"></a>02538                     {
<a name="l02539"></a>02539                         os &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; <a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#ad61bca5d7bf3abff9b478f5a4c58bf58" title="vector holding a list of b-tree inner levels.">m_inners</a>[l][i].keys[j];
<a name="l02540"></a>02540                     }
<a name="l02541"></a>02541                     os &lt;&lt; std::endl;
<a name="l02542"></a>02542                 }
<a name="l02543"></a>02543             }
<a name="l02544"></a>02544         }
<a name="l02545"></a>02545 
<a name="l02546"></a>02546 <span class="preprocessor">#endif // extra debug code for printing the tree</span>
<a name="l02547"></a>02547 <span class="preprocessor"></span>
<a name="l02553"></a><a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#a74ef879683b1e7679693bae6acb2980e">02553</a>         <span class="keywordtype">void</span> <a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#a74ef879683b1e7679693bae6acb2980e" title="Write function which outputs the constructed B-tree to a stream.">Write</a>(std::ostream&amp; os, <a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html" title="Signature page which heads all cbtreedb files.">SignaturePage</a>&amp; signature)
<a name="l02554"></a>02554         {
<a name="l02555"></a>02555             signature.<a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#ab515a6550576bc2b2664a5c7b9ca3644" title="size of b-tree nodes">btree_pagesize</a> = <a class="code" href="classstx_1_1CBTreeDB.html#a924efff56b96b6c5a0397211b0cf8685" title="third template parameter: B-tree page size. Usually 1024 or 2048.">BTreePageSize</a>;
<a name="l02556"></a>02556             signature.<a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#ad992a1e376b01b0e1e1f2d47c297404d" title="number of levels in tree">btree_levels</a> = <a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#ad61bca5d7bf3abff9b478f5a4c58bf58" title="vector holding a list of b-tree inner levels.">m_inners</a>.size() + 1;
<a name="l02557"></a>02557             signature.<a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#a2eb180e1d95d991a3eb233e0217b3642" title="number of leaf nodes in tree">btree_leaves</a> = <a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#a8ce8b78ff1013c69a31759bd1f6aa7ed" title="leaves of the B-tree">m_leaves</a>.size();
<a name="l02558"></a>02558 
<a name="l02559"></a>02559             <span class="comment">// Fill in childrenoffset field by precomputing the offsets.</span>
<a name="l02560"></a>02560             {
<a name="l02561"></a>02561                 <span class="comment">// start with offset after the root (inner) node.</span>
<a name="l02562"></a>02562                 uint32_t offset = <span class="keyword">sizeof</span>(<a class="code" href="structstx_1_1CBTreeDB_1_1InnerNode.html" title="Inner node structure of the B-tree inner pages.">InnerNode</a>);
<a name="l02563"></a>02563 
<a name="l02564"></a>02564                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> l = <a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#ad61bca5d7bf3abff9b478f5a4c58bf58" title="vector holding a list of b-tree inner levels.">m_inners</a>.size()-1; l &gt;= 0; --l)
<a name="l02565"></a>02565                 {
<a name="l02566"></a>02566                     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#ad61bca5d7bf3abff9b478f5a4c58bf58" title="vector holding a list of b-tree inner levels.">m_inners</a>[l].size(); ++i)
<a name="l02567"></a>02567                     {
<a name="l02568"></a>02568                         <a class="code" href="structstx_1_1CBTreeDB_1_1InnerNode.html" title="Inner node structure of the B-tree inner pages.">InnerNode</a>&amp; inner = <a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#ad61bca5d7bf3abff9b478f5a4c58bf58" title="vector holding a list of b-tree inner levels.">m_inners</a>[l][i];
<a name="l02569"></a>02569 
<a name="l02570"></a>02570                         inner.<a class="code" href="structstx_1_1CBTreeDB_1_1InnerNode.html#aa8a393e3980026418172cb866576d47e" title="base offset of child B-tree nodes enumerated by keys.">childrenoffset</a> = offset;
<a name="l02571"></a>02571 
<a name="l02572"></a>02572                         <span class="comment">// add all children node sizes to offset.</span>
<a name="l02573"></a>02573                         offset += (inner.<a class="code" href="structstx_1_1CBTreeDB_1_1InnerNode.html#a39993c719c0479b1ab32d0b64758ecf0" title="number of used slots in the arrays.">slots</a> + 1) * <span class="keyword">sizeof</span>(<a class="code" href="structstx_1_1CBTreeDB_1_1InnerNode.html" title="Inner node structure of the B-tree inner pages.">InnerNode</a>);
<a name="l02574"></a>02574                     }
<a name="l02575"></a>02575                 }
<a name="l02576"></a>02576             }
<a name="l02577"></a>02577 
<a name="l02578"></a>02578             <span class="comment">// Write out inner nodes</span>
<a name="l02579"></a>02579 
<a name="l02580"></a>02580             uint64_t writesize = 0;
<a name="l02581"></a>02581             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html" title="SHA-256 Message Digest implementation class.">SHA256</a> sha;
<a name="l02582"></a>02582 
<a name="l02583"></a>02583             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> l = <a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#ad61bca5d7bf3abff9b478f5a4c58bf58" title="vector holding a list of b-tree inner levels.">m_inners</a>.size()-1; l &gt;= 0; --l)
<a name="l02584"></a>02584             {
<a name="l02585"></a>02585                 <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#ad61bca5d7bf3abff9b478f5a4c58bf58" title="vector holding a list of b-tree inner levels.">m_inners</a>[l].size(); ++i)
<a name="l02586"></a>02586                 {
<a name="l02587"></a>02587                     os.write(reinterpret_cast&lt;char*&gt;(&amp;<a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#ad61bca5d7bf3abff9b478f5a4c58bf58" title="vector holding a list of b-tree inner levels.">m_inners</a>[l][i]), <span class="keyword">sizeof</span>(<a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#ad61bca5d7bf3abff9b478f5a4c58bf58" title="vector holding a list of b-tree inner levels.">m_inners</a>[l][i]));
<a name="l02588"></a>02588                     <a class="code" href="stx-cbtreedb_8h.html#aea46b67a1c31f750df77b32d5db56e2f" title="Short macro to throw exceptions if a program logic expression fails.">CBTREEDB_CHECK</a>(os.good(), <span class="stringliteral">&quot;Error writing B-tree inner node page to output stream.&quot;</span>);
<a name="l02589"></a>02589 
<a name="l02590"></a>02590                     sha.<a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#ad306a1c3c2f0321301e563af37bb17cd" title="Update this SHA256 calculation with new data.">update</a>(&amp;<a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#ad61bca5d7bf3abff9b478f5a4c58bf58" title="vector holding a list of b-tree inner levels.">m_inners</a>[l][i], <span class="keyword">sizeof</span>(<a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#ad61bca5d7bf3abff9b478f5a4c58bf58" title="vector holding a list of b-tree inner levels.">m_inners</a>[l][i]));
<a name="l02591"></a>02591 
<a name="l02592"></a>02592                     writesize += <span class="keyword">sizeof</span>(<a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#ad61bca5d7bf3abff9b478f5a4c58bf58" title="vector holding a list of b-tree inner levels.">m_inners</a>[l][i]);
<a name="l02593"></a>02593                 }
<a name="l02594"></a>02594             }
<a name="l02595"></a>02595 
<a name="l02596"></a>02596             <span class="comment">// Write out leaf nodes</span>
<a name="l02597"></a>02597 
<a name="l02598"></a>02598             signature.<a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#a26efd4b957baf1edde0aa13981b355f0" title="offset of first leaf in file">btree_firstleaf</a> = writesize;
<a name="l02599"></a>02599 
<a name="l02600"></a>02600             <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#a8ce8b78ff1013c69a31759bd1f6aa7ed" title="leaves of the B-tree">m_leaves</a>.size(); ++i)
<a name="l02601"></a>02601             {
<a name="l02602"></a>02602                 os.write(reinterpret_cast&lt;char*&gt;(&amp;<a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#a8ce8b78ff1013c69a31759bd1f6aa7ed" title="leaves of the B-tree">m_leaves</a>[i]), <span class="keyword">sizeof</span>(<a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#a8ce8b78ff1013c69a31759bd1f6aa7ed" title="leaves of the B-tree">m_leaves</a>[i]));
<a name="l02603"></a>02603                 <a class="code" href="stx-cbtreedb_8h.html#aea46b67a1c31f750df77b32d5db56e2f" title="Short macro to throw exceptions if a program logic expression fails.">CBTREEDB_CHECK</a>(os.good(), <span class="stringliteral">&quot;Error writing B-tree leaf node page to output stream.&quot;</span>);
<a name="l02604"></a>02604 
<a name="l02605"></a>02605                 sha.<a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#ad306a1c3c2f0321301e563af37bb17cd" title="Update this SHA256 calculation with new data.">update</a>(&amp;<a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#a8ce8b78ff1013c69a31759bd1f6aa7ed" title="leaves of the B-tree">m_leaves</a>[i], <span class="keyword">sizeof</span>(<a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#a8ce8b78ff1013c69a31759bd1f6aa7ed" title="leaves of the B-tree">m_leaves</a>[i]));
<a name="l02606"></a>02606 
<a name="l02607"></a>02607                 writesize += <span class="keyword">sizeof</span>(<a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#a8ce8b78ff1013c69a31759bd1f6aa7ed" title="leaves of the B-tree">m_leaves</a>[i]);
<a name="l02608"></a>02608             }
<a name="l02609"></a>02609 
<a name="l02610"></a>02610             sha.<a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#ab69946b6e8a4fc6190dc14d9df9b886d" title="Return final SHA256 digest of this object in the buffer.">final</a>(signature.<a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#a927c832ad13552500beb604ea44ee7ea" title="SHA256 digest of all tree nodes.">btree_sha256</a>);
<a name="l02611"></a>02611             signature.<a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#a0ae66a64d4404955ee7df3d65c298876" title="b-tree total size in bytes">btree_size</a> = writesize;
<a name="l02612"></a>02612         }
<a name="l02613"></a>02613     };
<a name="l02614"></a>02614 
<a name="l02615"></a>02615 <span class="keyword">public</span>:
<a name="l02625"></a><a class="code" href="classstx_1_1CBTreeDB_1_1Writer.html">02625</a>     <span class="keyword">class </span><a class="code" href="classstx_1_1CBTreeDB_1_1Writer.html" title="Writer is used to construct an constant B-tree database from an unsorted input sequence...">Writer</a>
<a name="l02626"></a>02626     {
<a name="l02627"></a>02627     <span class="keyword">protected</span>:
<a name="l02629"></a><a class="code" href="classstx_1_1CBTreeDB_1_1Writer.html#a152a99f4fc13796bbde9aed00565f336">02629</a>         <span class="keyword">typedef</span> std::map&lt;key_type, std::string, key_compare&gt; <a class="code" href="classstx_1_1CBTreeDB_1_1Writer.html#a152a99f4fc13796bbde9aed00565f336" title="Typedef key -&amp;gt; data mapping.">datamap_type</a>;
<a name="l02630"></a>02630 
<a name="l02632"></a><a class="code" href="classstx_1_1CBTreeDB_1_1Writer.html#a2cae5339f6b32dac496baa8c467e9de0">02632</a>         <a class="code" href="classstx_1_1CBTreeDB_1_1Writer.html#a152a99f4fc13796bbde9aed00565f336" title="Typedef key -&amp;gt; data mapping.">datamap_type</a>    <a class="code" href="classstx_1_1CBTreeDB_1_1Writer.html#a2cae5339f6b32dac496baa8c467e9de0" title="STL map to store all key -&amp;gt; values.">m_datamap</a>;
<a name="l02633"></a>02633 
<a name="l02635"></a><a class="code" href="classstx_1_1CBTreeDB_1_1Writer.html#aa5c29283cd5c14fa8e69b839de665138">02635</a>         <a class="code" href="classstx_1_1CBTreeDB.html#aa8d64c69bfec9eb6728d50ce1668d522" title="second template parameter: key comparison function object type.">key_compare</a>     <a class="code" href="classstx_1_1CBTreeDB_1_1Writer.html#aa5c29283cd5c14fa8e69b839de665138" title="key comparison functional">m_key_less</a>;
<a name="l02636"></a>02636 
<a name="l02638"></a><a class="code" href="classstx_1_1CBTreeDB_1_1Writer.html#adb520e353764f73bb6616b9762d61d17">02638</a>         <span class="keywordtype">char</span>            <a class="code" href="classstx_1_1CBTreeDB_1_1Writer.html#adb520e353764f73bb6616b9762d61d17" title="Signature characters to begin file with.">m_signaturestr</a>[8];
<a name="l02639"></a>02639 
<a name="l02640"></a>02640     <span class="keyword">public</span>:
<a name="l02642"></a><a class="code" href="classstx_1_1CBTreeDB_1_1Writer.html#a8939eab694669fcb540abda165fa64a6">02642</a>         <a class="code" href="classstx_1_1CBTreeDB_1_1Writer.html#a8939eab694669fcb540abda165fa64a6" title="Constructor.">Writer</a>(<span class="keyword">const</span> <a class="code" href="classstx_1_1CBTreeDB.html#aa8d64c69bfec9eb6728d50ce1668d522" title="second template parameter: key comparison function object type.">key_compare</a>&amp; key_less=<a class="code" href="classstx_1_1CBTreeDB.html#aa8d64c69bfec9eb6728d50ce1668d522" title="second template parameter: key comparison function object type.">key_compare</a>())
<a name="l02643"></a>02643             : <a class="code" href="classstx_1_1CBTreeDB_1_1Writer.html#a2cae5339f6b32dac496baa8c467e9de0" title="STL map to store all key -&amp;gt; values.">m_datamap</a>(key_less),
<a name="l02644"></a>02644               <a class="code" href="classstx_1_1CBTreeDB_1_1Writer.html#aa5c29283cd5c14fa8e69b839de665138" title="key comparison functional">m_key_less</a>(key_less)
<a name="l02645"></a>02645         {
<a name="l02646"></a>02646             memcpy(<a class="code" href="classstx_1_1CBTreeDB_1_1Writer.html#adb520e353764f73bb6616b9762d61d17" title="Signature characters to begin file with.">m_signaturestr</a>, <span class="stringliteral">&quot;cbtreedb&quot;</span>, 8);
<a name="l02647"></a>02647         }
<a name="l02648"></a>02648 
<a name="l02650"></a><a class="code" href="classstx_1_1CBTreeDB_1_1Writer.html#a252527861c1a2de285fa16aae309ced9">02650</a>         <span class="keywordtype">void</span> <a class="code" href="classstx_1_1CBTreeDB_1_1Writer.html#a252527861c1a2de285fa16aae309ced9" title="Add a new key -&amp;gt; values mapping to the database.">Add</a>(<span class="keyword">const</span> <a class="code" href="classstx_1_1CBTreeDB.html#a3853858e7d8cc630c832232bc46ed2c0" title="first template parameter: the key type of the B-tree.">key_type</a>&amp; key, <span class="keyword">const</span> <span class="keywordtype">void</span>* data, <span class="keywordtype">size_t</span> size)
<a name="l02651"></a>02651         {
<a name="l02652"></a>02652             <a class="code" href="classstx_1_1CBTreeDB_1_1Writer.html#a2cae5339f6b32dac496baa8c467e9de0" title="STL map to store all key -&amp;gt; values.">m_datamap</a>.insert( <span class="keyword">typename</span> datamap_type::value_type(key, std::string(reinterpret_cast&lt;const char*&gt;(data), size)) );
<a name="l02653"></a>02653         }
<a name="l02654"></a>02654 
<a name="l02656"></a><a class="code" href="classstx_1_1CBTreeDB_1_1Writer.html#a4f1cd8c6c1cac22d378658f98b01b828">02656</a>         <span class="keywordtype">void</span> <a class="code" href="classstx_1_1CBTreeDB_1_1Writer.html#a252527861c1a2de285fa16aae309ced9" title="Add a new key -&amp;gt; values mapping to the database.">Add</a>(<span class="keyword">const</span> <a class="code" href="classstx_1_1CBTreeDB.html#a3853858e7d8cc630c832232bc46ed2c0" title="first template parameter: the key type of the B-tree.">key_type</a>&amp; key, <span class="keyword">const</span> std::string&amp; data)
<a name="l02657"></a>02657         {
<a name="l02658"></a>02658             <a class="code" href="classstx_1_1CBTreeDB_1_1Writer.html#a252527861c1a2de285fa16aae309ced9" title="Add a new key -&amp;gt; values mapping to the database.">Add</a>(key, data.data(), data.size());
<a name="l02659"></a>02659         }
<a name="l02660"></a>02660 
<a name="l02662"></a><a class="code" href="classstx_1_1CBTreeDB_1_1Writer.html#a97ec7f455074d251be3aac37f776c453">02662</a>         <span class="keywordtype">size_t</span> <a class="code" href="classstx_1_1CBTreeDB_1_1Writer.html#a97ec7f455074d251be3aac37f776c453" title="Return number of items inserted into mapping.">Size</a>()<span class="keyword"> const</span>
<a name="l02663"></a>02663 <span class="keyword">        </span>{
<a name="l02664"></a>02664             <span class="keywordflow">return</span> <a class="code" href="classstx_1_1CBTreeDB_1_1Writer.html#a2cae5339f6b32dac496baa8c467e9de0" title="STL map to store all key -&amp;gt; values.">m_datamap</a>.size();
<a name="l02665"></a>02665         }
<a name="l02666"></a>02666 
<a name="l02672"></a><a class="code" href="classstx_1_1CBTreeDB_1_1Writer.html#aa4bd78ca31c2b45e60706f647c92ce47">02672</a>         <span class="keywordtype">void</span> <a class="code" href="classstx_1_1CBTreeDB_1_1Writer.html#aa4bd78ca31c2b45e60706f647c92ce47" title="Change the database signature from &amp;#39;cbtreedb&amp;#39; to a custom string.">SetSignature</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* newsignature)
<a name="l02673"></a>02673         {
<a name="l02674"></a>02674             <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0;
<a name="l02675"></a>02675             <span class="keywordflow">for</span>(; i &lt; 8 &amp;&amp; newsignature[i]; ++i)
<a name="l02676"></a>02676                 <a class="code" href="classstx_1_1CBTreeDB_1_1Writer.html#adb520e353764f73bb6616b9762d61d17" title="Signature characters to begin file with.">m_signaturestr</a>[i] = newsignature[i];
<a name="l02677"></a>02677 
<a name="l02678"></a>02678             <span class="keywordflow">for</span>(; i &lt; 8; ++i)
<a name="l02679"></a>02679                 <a class="code" href="classstx_1_1CBTreeDB_1_1Writer.html#adb520e353764f73bb6616b9762d61d17" title="Signature characters to begin file with.">m_signaturestr</a>[i] = 0;
<a name="l02680"></a>02680         }
<a name="l02681"></a>02681 
<a name="l02684"></a><a class="code" href="classstx_1_1CBTreeDB_1_1Writer.html#acaa7bef55ac4f3d1a363c79f7ebca150">02684</a>         <span class="keywordtype">void</span> <a class="code" href="classstx_1_1CBTreeDB_1_1Writer.html#acaa7bef55ac4f3d1a363c79f7ebca150" title="Write the complete database out to a file.">Write</a>(std::ostream&amp; os)<span class="keyword"> const</span>
<a name="l02685"></a>02685 <span class="keyword">        </span>{
<a name="l02686"></a>02686             os.clear();
<a name="l02687"></a>02687             os.seekp(0, std::ios::beg);
<a name="l02688"></a>02688 
<a name="l02689"></a>02689             <span class="comment">// Write zeroed signature block to be overwritten when the file is</span>
<a name="l02690"></a>02690             <span class="comment">// finialized.</span>
<a name="l02691"></a>02691 
<a name="l02692"></a>02692             <a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html" title="Signature page which heads all cbtreedb files.">SignaturePage</a> signature;
<a name="l02693"></a>02693             memset(&amp;signature, 0, <span class="keyword">sizeof</span>(signature));
<a name="l02694"></a>02694             os.write(reinterpret_cast&lt;char*&gt;(&amp;signature), <span class="keyword">sizeof</span>(signature));
<a name="l02695"></a>02695 
<a name="l02696"></a>02696             <span class="keywordtype">char</span> signature_padding[<a class="code" href="classstx_1_1CBTreeDB.html#af31d6adca51ce73acce0abbb0ac3bd72" title="Fixed signature page size: always equal to the B-tree page.">SignaturePageSize</a> - <span class="keyword">sizeof</span>(<a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html" title="Signature page which heads all cbtreedb files.">SignaturePage</a>)];
<a name="l02697"></a>02697             memset(signature_padding, 0, <a class="code" href="classstx_1_1CBTreeDB.html#af31d6adca51ce73acce0abbb0ac3bd72" title="Fixed signature page size: always equal to the B-tree page.">SignaturePageSize</a> - <span class="keyword">sizeof</span>(<a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html" title="Signature page which heads all cbtreedb files.">SignaturePage</a>));
<a name="l02698"></a>02698             os.write(signature_padding, <a class="code" href="classstx_1_1CBTreeDB.html#af31d6adca51ce73acce0abbb0ac3bd72" title="Fixed signature page size: always equal to the B-tree page.">SignaturePageSize</a> - <span class="keyword">sizeof</span>(<a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html" title="Signature page which heads all cbtreedb files.">SignaturePage</a>));
<a name="l02699"></a>02699 
<a name="l02700"></a>02700             <a class="code" href="stx-cbtreedb_8h.html#aea46b67a1c31f750df77b32d5db56e2f" title="Short macro to throw exceptions if a program logic expression fails.">CBTREEDB_CHECK</a>(os.good(), <span class="stringliteral">&quot;Error writing signature block out output stream.&quot;</span>);
<a name="l02701"></a>02701 
<a name="l02702"></a>02702             <span class="comment">// Prepare signature for data</span>
<a name="l02703"></a>02703 
<a name="l02704"></a>02704             memcpy(signature.<a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#ae797c2f1bb21f13ddf4008156424a76c" title="&amp;quot;cbtreedb&amp;quot; or custom string">signature</a>, <a class="code" href="classstx_1_1CBTreeDB_1_1Writer.html#adb520e353764f73bb6616b9762d61d17" title="Signature characters to begin file with.">m_signaturestr</a>, 8);
<a name="l02705"></a>02705             signature.<a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#ad47a6a5d93fff2689f58d8a4c5dd426f" title="0x00010000">version</a> = 0x00010000;
<a name="l02706"></a>02706             signature.<a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#a97ef2f19de2402cc23a723e513a37fb5" title="custom id defined by template">app_version_id</a> = <a class="code" href="classstx_1_1CBTreeDB.html#afbb1611aa42b9f5630ca5dc1b8546988" title="fourth template parameter: application-defined 32-bit identifier to mark database...">AppVersionId</a>;
<a name="l02707"></a>02707             signature.<a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#a72aa9d25a46e2d8645759e983c2dd207" title="key-value pairs in db">items</a> = <a class="code" href="classstx_1_1CBTreeDB_1_1Writer.html#a2cae5339f6b32dac496baa8c467e9de0" title="STL map to store all key -&amp;gt; values.">m_datamap</a>.size();
<a name="l02708"></a>02708             signature.<a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#a89ff60cdddd1e47cd625bca380b04aab" title="sizeof(key_type)">key_size</a> = <span class="keyword">sizeof</span>(<a class="code" href="classstx_1_1CBTreeDB.html#a3853858e7d8cc630c832232bc46ed2c0" title="first template parameter: the key type of the B-tree.">key_type</a>);
<a name="l02709"></a>02709 
<a name="l02710"></a>02710             <span class="comment">// Construct a and write a constant B-Tree</span>
<a name="l02711"></a>02711 
<a name="l02712"></a>02712             <a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html" title="BTreeBuilder is used to construct an index very similar to a B-tree from an ordered...">BTreeBuilder</a> btree(<a class="code" href="classstx_1_1CBTreeDB_1_1Writer.html#aa5c29283cd5c14fa8e69b839de665138" title="key comparison functional">m_key_less</a>);
<a name="l02713"></a>02713             uint64_t dataoffset = 0;
<a name="l02714"></a>02714 
<a name="l02715"></a>02715             <span class="keywordflow">for</span> (<span class="keyword">typename</span> datamap_type::const_iterator di = <a class="code" href="classstx_1_1CBTreeDB_1_1Writer.html#a2cae5339f6b32dac496baa8c467e9de0" title="STL map to store all key -&amp;gt; values.">m_datamap</a>.begin();
<a name="l02716"></a>02716                  di != <a class="code" href="classstx_1_1CBTreeDB_1_1Writer.html#a2cae5339f6b32dac496baa8c467e9de0" title="STL map to store all key -&amp;gt; values.">m_datamap</a>.end(); ++di)
<a name="l02717"></a>02717             {
<a name="l02718"></a>02718                 btree.<a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#ae6f069858c21620aab5f3420e81f87c4" title="Insert a new key into the tree together with (offset,size) of the associated data...">Add</a>(di-&gt;first, dataoffset, di-&gt;second.size());
<a name="l02719"></a>02719                 dataoffset += di-&gt;second.size();
<a name="l02720"></a>02720             }
<a name="l02721"></a>02721 
<a name="l02722"></a>02722             signature.<a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#a15d319c4ae75a1d16e6c63e28a10dc03" title="b-tree offset in file">btree_offset</a> = <a class="code" href="classstx_1_1CBTreeDB.html#a924efff56b96b6c5a0397211b0cf8685" title="third template parameter: B-tree page size. Usually 1024 or 2048.">BTreePageSize</a>;
<a name="l02723"></a>02723             btree.<a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#a74ef879683b1e7679693bae6acb2980e" title="Write function which outputs the constructed B-tree to a stream.">Write</a>(os, signature);
<a name="l02724"></a>02724 
<a name="l02725"></a>02725             <a class="code" href="stx-cbtreedb_8h.html#aea46b67a1c31f750df77b32d5db56e2f" title="Short macro to throw exceptions if a program logic expression fails.">CBTREEDB_CHECK</a>(os.good(), <span class="stringliteral">&quot;Error writing B-tree pages to output stream.&quot;</span>);
<a name="l02726"></a>02726             <a class="code" href="stx-cbtreedb_8h.html#ab44bd6c500e8dbe3a232e4c44f28b67e" title="Instead of assert() we use this macro to throw exceptions.">CBTREEDB_ASSERT</a>(os.tellp() == std::ostream::pos_type(<a class="code" href="classstx_1_1CBTreeDB.html#af31d6adca51ce73acce0abbb0ac3bd72" title="Fixed signature page size: always equal to the B-tree page.">SignaturePageSize</a> + signature.<a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#a0ae66a64d4404955ee7df3d65c298876" title="b-tree total size in bytes">btree_size</a>));
<a name="l02727"></a>02727 
<a name="l02728"></a>02728             <span class="comment">// Write all value blobs to file</span>
<a name="l02729"></a>02729 
<a name="l02730"></a>02730             <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html" title="SHA-256 Message Digest implementation class.">SHA256</a> sha;
<a name="l02731"></a>02731 
<a name="l02732"></a>02732             <span class="keywordflow">for</span> (<span class="keyword">typename</span> datamap_type::const_iterator di = <a class="code" href="classstx_1_1CBTreeDB_1_1Writer.html#a2cae5339f6b32dac496baa8c467e9de0" title="STL map to store all key -&amp;gt; values.">m_datamap</a>.begin();
<a name="l02733"></a>02733                  di != <a class="code" href="classstx_1_1CBTreeDB_1_1Writer.html#a2cae5339f6b32dac496baa8c467e9de0" title="STL map to store all key -&amp;gt; values.">m_datamap</a>.end(); ++di)
<a name="l02734"></a>02734             {
<a name="l02735"></a>02735                 os.write(di-&gt;second.data(), di-&gt;second.size());
<a name="l02736"></a>02736                 <a class="code" href="stx-cbtreedb_8h.html#aea46b67a1c31f750df77b32d5db56e2f" title="Short macro to throw exceptions if a program logic expression fails.">CBTREEDB_CHECK</a>(os.good(), <span class="stringliteral">&quot;Error writing data block to output stream.&quot;</span>);
<a name="l02737"></a>02737 
<a name="l02738"></a>02738                 sha.update(di-&gt;second.data(), di-&gt;second.size());
<a name="l02739"></a>02739             }
<a name="l02740"></a>02740 
<a name="l02741"></a>02741             <a class="code" href="stx-cbtreedb_8h.html#ab44bd6c500e8dbe3a232e4c44f28b67e" title="Instead of assert() we use this macro to throw exceptions.">CBTREEDB_ASSERT</a>(os.tellp() == std::ostream::pos_type(<a class="code" href="classstx_1_1CBTreeDB.html#af31d6adca51ce73acce0abbb0ac3bd72" title="Fixed signature page size: always equal to the B-tree page.">SignaturePageSize</a> + signature.<a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#a0ae66a64d4404955ee7df3d65c298876" title="b-tree total size in bytes">btree_size</a> + dataoffset));
<a name="l02742"></a>02742 
<a name="l02743"></a>02743             <span class="comment">// Fill in signature page</span>
<a name="l02744"></a>02744 
<a name="l02745"></a>02745             signature.<a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#a32547b948043297c36349fa1f72a07f0" title="file offset of value data area">value_offset</a> = <a class="code" href="classstx_1_1CBTreeDB.html#af31d6adca51ce73acce0abbb0ac3bd72" title="Fixed signature page size: always equal to the B-tree page.">SignaturePageSize</a> + signature.<a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#a0ae66a64d4404955ee7df3d65c298876" title="b-tree total size in bytes">btree_size</a>;
<a name="l02746"></a>02746             signature.<a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#ae7b237b7498fe2cc48844222861de850" title="total size of value data area">value_size</a> = dataoffset;
<a name="l02747"></a>02747             sha.final(signature.<a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#a6837b8e8b502df1f3c233e7f5c689d2e" title="SHA256 digest of all value data.">value_sha256</a>);
<a name="l02748"></a>02748 
<a name="l02749"></a>02749             <span class="comment">// Calculate header checksum</span>
<a name="l02750"></a>02750 
<a name="l02751"></a>02751             signature.<a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#a6600a8e6bef01f7ec30af5f4ad2b4823" title="CRC32 of following bytes.">header_crc32</a> = <a class="code" href="classstx_1_1CBTreeDB_1_1CRC32.html#a9eb10033fa35e3a5db820e5e37111b27" title="Calculate CRC32 digest of bytes in the given range.">CRC32::digest</a>(reinterpret_cast&lt;char*&gt;(&amp;signature)+16, <span class="keyword">sizeof</span>(signature)-16);
<a name="l02752"></a>02752 
<a name="l02753"></a>02753             os.seekp(0, std::ios::beg);
<a name="l02754"></a>02754             <a class="code" href="stx-cbtreedb_8h.html#aea46b67a1c31f750df77b32d5db56e2f" title="Short macro to throw exceptions if a program logic expression fails.">CBTREEDB_CHECK</a>(os.good(), <span class="stringliteral">&quot;Error seeking back to signature page in output stream.&quot;</span>);
<a name="l02755"></a>02755             <a class="code" href="stx-cbtreedb_8h.html#ab44bd6c500e8dbe3a232e4c44f28b67e" title="Instead of assert() we use this macro to throw exceptions.">CBTREEDB_ASSERT</a>(os.tellp() == std::ostream::pos_type(0));
<a name="l02756"></a>02756 
<a name="l02757"></a>02757             os.write(reinterpret_cast&lt;char*&gt;(&amp;signature), <span class="keyword">sizeof</span>(signature));
<a name="l02758"></a>02758             <a class="code" href="stx-cbtreedb_8h.html#aea46b67a1c31f750df77b32d5db56e2f" title="Short macro to throw exceptions if a program logic expression fails.">CBTREEDB_CHECK</a>(os.good(), <span class="stringliteral">&quot;Error writing signature page to output stream.&quot;</span>);
<a name="l02759"></a>02759         }
<a name="l02760"></a>02760     };
<a name="l02761"></a>02761 
<a name="l02762"></a>02762 <span class="keyword">public</span>:
<a name="l02775"></a><a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html">02775</a>     <span class="keyword">class </span><a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html" title="WriterSequential is used to construct a constant B-tree database from an _ordered_...">WriterSequential</a>
<a name="l02776"></a>02776     {
<a name="l02777"></a>02777     <span class="keyword">protected</span>:
<a name="l02779"></a><a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#a0ca8bd694df7758aba25b8e02446c06b">02779</a>         <a class="code" href="classstx_1_1CBTreeDB.html#aa8d64c69bfec9eb6728d50ce1668d522" title="second template parameter: key comparison function object type.">key_compare</a>     <a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#a0ca8bd694df7758aba25b8e02446c06b" title="key comparison functional">m_key_less</a>;
<a name="l02780"></a>02780 
<a name="l02782"></a><a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#aa6134fc3fec0e844936059cdce69cb7a">02782</a>         <a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html" title="BTreeBuilder is used to construct an index very similar to a B-tree from an ordered...">BTreeBuilder</a>    <a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#aa6134fc3fec0e844936059cdce69cb7a" title="phase 1: b-tree object built from sequential predeclared sequence">m_btree</a>;
<a name="l02783"></a>02783 
<a name="l02785"></a><a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#a51b55a42f26f0e9956f809f43ffc0a45">02785</a>         uint64_t        <a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#a51b55a42f26f0e9956f809f43ffc0a45" title="phase 1: value data offset counter for predeclared sequence">m_dataoffset</a>;
<a name="l02786"></a>02786 
<a name="l02788"></a><a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#ab61f4940d4987414b5a93f9887150834">02788</a>         <span class="keywordtype">char</span>            <a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#ab61f4940d4987414b5a93f9887150834" title="signature characters to begin file with">m_signaturestr</a>[8];
<a name="l02789"></a>02789 
<a name="l02791"></a><a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#adeb03bd49fd5ca9a8d6189206451be5f">02791</a>         <a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html" title="Signature page which heads all cbtreedb files.">SignaturePage</a>   <a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#adeb03bd49fd5ca9a8d6189206451be5f" title="signature page of current written file">m_signature</a>;
<a name="l02792"></a>02792 
<a name="l02794"></a><a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#a1e3eb04ed4649ee24e3970edd7e97924">02794</a>         std::ostream*   <a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#a1e3eb04ed4649ee24e3970edd7e97924" title="phase 2: output stream">m_ostream</a>;
<a name="l02795"></a>02795 
<a name="l02797"></a><a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#abb9ad789240ab9f873edad155df33ea4">02797</a>         uint32_t        <a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#abb9ad789240ab9f873edad155df33ea4" title="phase 2: current position in array">m_currpos</a>;
<a name="l02798"></a>02798 
<a name="l02800"></a><a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#abed97e673243f728d0d9a95ed8a66dd5">02800</a>         uint64_t        <a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#abed97e673243f728d0d9a95ed8a66dd5" title="phase 2: current offset in output stream">m_curroffset</a>;
<a name="l02801"></a>02801 
<a name="l02803"></a><a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#ab8e188fcae4e6b127b3f3593eb7e477e">02803</a>         <a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html" title="SHA-256 Message Digest implementation class.">SHA256</a>          <a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#ab8e188fcae4e6b127b3f3593eb7e477e" title="phase 2: running digest of the value area">m_datasha</a>;
<a name="l02804"></a>02804 
<a name="l02805"></a>02805     <span class="keyword">public</span>:
<a name="l02807"></a><a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#a7d0a66e742ec030bd1e925bf9c468721">02807</a>         <a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#a7d0a66e742ec030bd1e925bf9c468721" title="Constructor.">WriterSequential</a>(<span class="keyword">const</span> <a class="code" href="classstx_1_1CBTreeDB.html#aa8d64c69bfec9eb6728d50ce1668d522" title="second template parameter: key comparison function object type.">key_compare</a>&amp; key_less=<a class="code" href="classstx_1_1CBTreeDB.html#aa8d64c69bfec9eb6728d50ce1668d522" title="second template parameter: key comparison function object type.">key_compare</a>())
<a name="l02808"></a>02808             : <a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#a0ca8bd694df7758aba25b8e02446c06b" title="key comparison functional">m_key_less</a>(key_less),
<a name="l02809"></a>02809               <a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#aa6134fc3fec0e844936059cdce69cb7a" title="phase 1: b-tree object built from sequential predeclared sequence">m_btree</a>(key_less),
<a name="l02810"></a>02810               <a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#a51b55a42f26f0e9956f809f43ffc0a45" title="phase 1: value data offset counter for predeclared sequence">m_dataoffset</a>(0),
<a name="l02811"></a>02811               <a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#a1e3eb04ed4649ee24e3970edd7e97924" title="phase 2: output stream">m_ostream</a>(NULL),
<a name="l02812"></a>02812               <a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#abb9ad789240ab9f873edad155df33ea4" title="phase 2: current position in array">m_currpos</a>(-1)
<a name="l02813"></a>02813         {
<a name="l02814"></a>02814             memcpy(<a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#ab61f4940d4987414b5a93f9887150834" title="signature characters to begin file with">m_signaturestr</a>, <span class="stringliteral">&quot;cbtreedb&quot;</span>, 8);
<a name="l02815"></a>02815         }
<a name="l02816"></a>02816 
<a name="l02819"></a><a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#a14a27311aad5fcb1cc9d4fb9351a4093">02819</a>         <span class="keywordtype">void</span> <a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#a14a27311aad5fcb1cc9d4fb9351a4093" title="Add a new key -&amp;gt; value size mapping to the database.">Add</a>(<span class="keyword">const</span> <a class="code" href="classstx_1_1CBTreeDB.html#a3853858e7d8cc630c832232bc46ed2c0" title="first template parameter: the key type of the B-tree.">key_type</a>&amp; key, uint32_t size)
<a name="l02820"></a>02820         {
<a name="l02821"></a>02821             <a class="code" href="stx-cbtreedb_8h.html#aea46b67a1c31f750df77b32d5db56e2f" title="Short macro to throw exceptions if a program logic expression fails.">CBTREEDB_CHECK</a>(<a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#aa6134fc3fec0e844936059cdce69cb7a" title="phase 1: b-tree object built from sequential predeclared sequence">m_btree</a>.<a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#ad44cf36a5826bebfefbebd975ef0d3d4" title="Returns the number of items added to the tree.">Size</a>() == 0 || <a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#a0ca8bd694df7758aba25b8e02446c06b" title="key comparison functional">m_key_less</a>(<a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#aa6134fc3fec0e844936059cdce69cb7a" title="phase 1: b-tree object built from sequential predeclared sequence">m_btree</a>.<a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#a655484b99e9a586938c10724dab3caaa" title="Return highest key currently inserted in the tree.">GetLastKey</a>(), key),
<a name="l02822"></a>02822                            <span class="stringliteral">&quot;Key sequence for Add() must be ascending.&quot;</span>);
<a name="l02823"></a>02823             <a class="code" href="stx-cbtreedb_8h.html#aea46b67a1c31f750df77b32d5db56e2f" title="Short macro to throw exceptions if a program logic expression fails.">CBTREEDB_CHECK</a>(<a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#a1e3eb04ed4649ee24e3970edd7e97924" title="phase 2: output stream">m_ostream</a> == NULL,
<a name="l02824"></a>02824                            <span class="stringliteral">&quot;Cannot declare keys after starting phase 2.&quot;</span>);
<a name="l02825"></a>02825 
<a name="l02826"></a>02826             <a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#aa6134fc3fec0e844936059cdce69cb7a" title="phase 1: b-tree object built from sequential predeclared sequence">m_btree</a>.<a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#ae6f069858c21620aab5f3420e81f87c4" title="Insert a new key into the tree together with (offset,size) of the associated data...">Add</a>(key, <a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#a51b55a42f26f0e9956f809f43ffc0a45" title="phase 1: value data offset counter for predeclared sequence">m_dataoffset</a>, size);
<a name="l02827"></a>02827             <a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#a51b55a42f26f0e9956f809f43ffc0a45" title="phase 1: value data offset counter for predeclared sequence">m_dataoffset</a> += size;
<a name="l02828"></a>02828         }
<a name="l02829"></a>02829 
<a name="l02831"></a><a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#a2dafe7529ba02d3f45fe27a7a543463c">02831</a>         <span class="keywordtype">size_t</span> <a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#a2dafe7529ba02d3f45fe27a7a543463c" title="Return number of pairs inserted into mapping.">Size</a>()<span class="keyword"> const</span>
<a name="l02832"></a>02832 <span class="keyword">        </span>{
<a name="l02833"></a>02833             <span class="keywordflow">return</span> <a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#aa6134fc3fec0e844936059cdce69cb7a" title="phase 1: b-tree object built from sequential predeclared sequence">m_btree</a>.<a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#ad44cf36a5826bebfefbebd975ef0d3d4" title="Returns the number of items added to the tree.">Size</a>();
<a name="l02834"></a>02834         }
<a name="l02835"></a>02835 
<a name="l02841"></a><a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#aa007cbc0d3d5577db53a69032c3a1be9">02841</a>         <span class="keywordtype">void</span> <a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#aa007cbc0d3d5577db53a69032c3a1be9" title="Change the database signature from &amp;#39;cbtreedb&amp;#39; to a custom string.">SetSignature</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* newsignature)
<a name="l02842"></a>02842         {
<a name="l02843"></a>02843             <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0;
<a name="l02844"></a>02844             <span class="keywordflow">for</span>(; i &lt; 8 &amp;&amp; newsignature[i]; ++i)
<a name="l02845"></a>02845                 <a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#ab61f4940d4987414b5a93f9887150834" title="signature characters to begin file with">m_signaturestr</a>[i] = newsignature[i];
<a name="l02846"></a>02846 
<a name="l02847"></a>02847             <span class="keywordflow">for</span>(; i &lt; 8; ++i)
<a name="l02848"></a>02848                 <a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#ab61f4940d4987414b5a93f9887150834" title="signature characters to begin file with">m_signaturestr</a>[i] = 0;
<a name="l02849"></a>02849         }
<a name="l02850"></a>02850 
<a name="l02852"></a><a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#a1d910774d254e00b8230e33347d8dfec">02852</a>         <span class="keywordtype">void</span> <a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#a1d910774d254e00b8230e33347d8dfec" title="Write header and b-tree to file stream. Starts Phase 2.">WriteHeader</a>(std::ostream&amp; os)
<a name="l02853"></a>02853         {
<a name="l02854"></a>02854             <a class="code" href="stx-cbtreedb_8h.html#aea46b67a1c31f750df77b32d5db56e2f" title="Short macro to throw exceptions if a program logic expression fails.">CBTREEDB_CHECK</a>(<a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#a1e3eb04ed4649ee24e3970edd7e97924" title="phase 2: output stream">m_ostream</a> == NULL,
<a name="l02855"></a>02855                            <span class="stringliteral">&quot;Cannot write header again in phase 2.&quot;</span>);
<a name="l02856"></a>02856 
<a name="l02857"></a>02857             os.seekp(0, std::ios::beg);
<a name="l02858"></a>02858 
<a name="l02859"></a>02859             <span class="comment">// write zeroed signature page to be overwritten when the file is</span>
<a name="l02860"></a>02860             <span class="comment">// finialized.</span>
<a name="l02861"></a>02861             memset(&amp;<a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#adeb03bd49fd5ca9a8d6189206451be5f" title="signature page of current written file">m_signature</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#adeb03bd49fd5ca9a8d6189206451be5f" title="signature page of current written file">m_signature</a>));
<a name="l02862"></a>02862             os.write(reinterpret_cast&lt;char*&gt;(&amp;<a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#adeb03bd49fd5ca9a8d6189206451be5f" title="signature page of current written file">m_signature</a>), <span class="keyword">sizeof</span>(<a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#adeb03bd49fd5ca9a8d6189206451be5f" title="signature page of current written file">m_signature</a>));
<a name="l02863"></a>02863 
<a name="l02864"></a>02864             <span class="keywordtype">char</span> signature_padding[<a class="code" href="classstx_1_1CBTreeDB.html#af31d6adca51ce73acce0abbb0ac3bd72" title="Fixed signature page size: always equal to the B-tree page.">SignaturePageSize</a> - <span class="keyword">sizeof</span>(<a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html" title="Signature page which heads all cbtreedb files.">SignaturePage</a>)];
<a name="l02865"></a>02865             memset(signature_padding, 0, <a class="code" href="classstx_1_1CBTreeDB.html#af31d6adca51ce73acce0abbb0ac3bd72" title="Fixed signature page size: always equal to the B-tree page.">SignaturePageSize</a> - <span class="keyword">sizeof</span>(<a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html" title="Signature page which heads all cbtreedb files.">SignaturePage</a>));
<a name="l02866"></a>02866             os.write(signature_padding, <a class="code" href="classstx_1_1CBTreeDB.html#af31d6adca51ce73acce0abbb0ac3bd72" title="Fixed signature page size: always equal to the B-tree page.">SignaturePageSize</a> - <span class="keyword">sizeof</span>(<a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html" title="Signature page which heads all cbtreedb files.">SignaturePage</a>));
<a name="l02867"></a>02867 
<a name="l02868"></a>02868             <a class="code" href="stx-cbtreedb_8h.html#aea46b67a1c31f750df77b32d5db56e2f" title="Short macro to throw exceptions if a program logic expression fails.">CBTREEDB_CHECK</a>(os.good(), <span class="stringliteral">&quot;Error writing signature page to output stream.&quot;</span>);
<a name="l02869"></a>02869 
<a name="l02870"></a>02870             <span class="comment">// prepare signature for data</span>
<a name="l02871"></a>02871 
<a name="l02872"></a>02872             memcpy(<a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#adeb03bd49fd5ca9a8d6189206451be5f" title="signature page of current written file">m_signature</a>.<a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#ae797c2f1bb21f13ddf4008156424a76c" title="&amp;quot;cbtreedb&amp;quot; or custom string">signature</a>, <a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#ab61f4940d4987414b5a93f9887150834" title="signature characters to begin file with">m_signaturestr</a>, 8);
<a name="l02873"></a>02873             <a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#adeb03bd49fd5ca9a8d6189206451be5f" title="signature page of current written file">m_signature</a>.<a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#ad47a6a5d93fff2689f58d8a4c5dd426f" title="0x00010000">version</a> = 0x00010000;
<a name="l02874"></a>02874             <a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#adeb03bd49fd5ca9a8d6189206451be5f" title="signature page of current written file">m_signature</a>.<a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#a97ef2f19de2402cc23a723e513a37fb5" title="custom id defined by template">app_version_id</a> = <a class="code" href="classstx_1_1CBTreeDB.html#afbb1611aa42b9f5630ca5dc1b8546988" title="fourth template parameter: application-defined 32-bit identifier to mark database...">AppVersionId</a>;
<a name="l02875"></a>02875             <a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#adeb03bd49fd5ca9a8d6189206451be5f" title="signature page of current written file">m_signature</a>.<a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#a15d319c4ae75a1d16e6c63e28a10dc03" title="b-tree offset in file">btree_offset</a> = <a class="code" href="classstx_1_1CBTreeDB.html#af31d6adca51ce73acce0abbb0ac3bd72" title="Fixed signature page size: always equal to the B-tree page.">SignaturePageSize</a>;
<a name="l02876"></a>02876             <a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#adeb03bd49fd5ca9a8d6189206451be5f" title="signature page of current written file">m_signature</a>.<a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#a72aa9d25a46e2d8645759e983c2dd207" title="key-value pairs in db">items</a> = <a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#aa6134fc3fec0e844936059cdce69cb7a" title="phase 1: b-tree object built from sequential predeclared sequence">m_btree</a>.<a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#ad44cf36a5826bebfefbebd975ef0d3d4" title="Returns the number of items added to the tree.">Size</a>();
<a name="l02877"></a>02877             <a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#adeb03bd49fd5ca9a8d6189206451be5f" title="signature page of current written file">m_signature</a>.<a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#a89ff60cdddd1e47cd625bca380b04aab" title="sizeof(key_type)">key_size</a> = <span class="keyword">sizeof</span>(<a class="code" href="classstx_1_1CBTreeDB.html#a3853858e7d8cc630c832232bc46ed2c0" title="first template parameter: the key type of the B-tree.">key_type</a>);
<a name="l02878"></a>02878             <a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#adeb03bd49fd5ca9a8d6189206451be5f" title="signature page of current written file">m_signature</a>.<a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#ae7b237b7498fe2cc48844222861de850" title="total size of value data area">value_size</a> = <a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#a51b55a42f26f0e9956f809f43ffc0a45" title="phase 1: value data offset counter for predeclared sequence">m_dataoffset</a>;
<a name="l02879"></a>02879 
<a name="l02880"></a>02880             <span class="comment">// write constant B-tree</span>
<a name="l02881"></a>02881 
<a name="l02882"></a>02882             <a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#aa6134fc3fec0e844936059cdce69cb7a" title="phase 1: b-tree object built from sequential predeclared sequence">m_btree</a>.<a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#a74ef879683b1e7679693bae6acb2980e" title="Write function which outputs the constructed B-tree to a stream.">Write</a>(os, <a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#adeb03bd49fd5ca9a8d6189206451be5f" title="signature page of current written file">m_signature</a>);
<a name="l02883"></a>02883             <a class="code" href="stx-cbtreedb_8h.html#aea46b67a1c31f750df77b32d5db56e2f" title="Short macro to throw exceptions if a program logic expression fails.">CBTREEDB_CHECK</a>(os.good(), <span class="stringliteral">&quot;Error writing B-tree pages to output stream.&quot;</span>);
<a name="l02884"></a>02884             <a class="code" href="stx-cbtreedb_8h.html#ab44bd6c500e8dbe3a232e4c44f28b67e" title="Instead of assert() we use this macro to throw exceptions.">CBTREEDB_ASSERT</a>(os.tellp() == std::ostream::pos_type(<a class="code" href="classstx_1_1CBTreeDB.html#af31d6adca51ce73acce0abbb0ac3bd72" title="Fixed signature page size: always equal to the B-tree page.">SignaturePageSize</a> + <a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#adeb03bd49fd5ca9a8d6189206451be5f" title="signature page of current written file">m_signature</a>.<a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#a0ae66a64d4404955ee7df3d65c298876" title="b-tree total size in bytes">btree_size</a>));
<a name="l02885"></a>02885 
<a name="l02886"></a>02886             <span class="comment">// prepare for writing value area</span>
<a name="l02887"></a>02887 
<a name="l02888"></a>02888             <a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#a1e3eb04ed4649ee24e3970edd7e97924" title="phase 2: output stream">m_ostream</a> = &amp;os;
<a name="l02889"></a>02889             <a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#abb9ad789240ab9f873edad155df33ea4" title="phase 2: current position in array">m_currpos</a> = 0;
<a name="l02890"></a>02890             <a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#abed97e673243f728d0d9a95ed8a66dd5" title="phase 2: current offset in output stream">m_curroffset</a> = 0;
<a name="l02891"></a>02891             <a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#ab8e188fcae4e6b127b3f3593eb7e477e" title="phase 2: running digest of the value area">m_datasha</a>.<a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#a177db0679d2e66dedcb7ceff1ca97fe9" title="Clear memory of sensitive data.">clear</a>();
<a name="l02892"></a>02892         }
<a name="l02893"></a>02893 
<a name="l02896"></a><a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#a1752833c7e6276010cb9c9a310734882">02896</a>         <span class="keywordtype">void</span> <a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#a1752833c7e6276010cb9c9a310734882" title="Sequentially write value blobs to file.">WriteValue</a>(<span class="keyword">const</span> <a class="code" href="classstx_1_1CBTreeDB.html#a3853858e7d8cc630c832232bc46ed2c0" title="first template parameter: the key type of the B-tree.">key_type</a>&amp; key, <span class="keyword">const</span> <span class="keywordtype">void</span>* data, uint32_t size)
<a name="l02897"></a>02897         {
<a name="l02898"></a>02898             <a class="code" href="stx-cbtreedb_8h.html#aea46b67a1c31f750df77b32d5db56e2f" title="Short macro to throw exceptions if a program logic expression fails.">CBTREEDB_CHECK</a>(<a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#a1e3eb04ed4649ee24e3970edd7e97924" title="phase 2: output stream">m_ostream</a> != NULL,
<a name="l02899"></a>02899                            <span class="stringliteral">&quot;Cannot write data, because phase 2 was not started.&quot;</span>);
<a name="l02900"></a>02900 
<a name="l02901"></a>02901             <a class="code" href="stx-cbtreedb_8h.html#aea46b67a1c31f750df77b32d5db56e2f" title="Short macro to throw exceptions if a program logic expression fails.">CBTREEDB_CHECK</a>(<a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#abb9ad789240ab9f873edad155df33ea4" title="phase 2: current position in array">m_currpos</a> &lt; <a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#aa6134fc3fec0e844936059cdce69cb7a" title="phase 1: b-tree object built from sequential predeclared sequence">m_btree</a>.<a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#ad44cf36a5826bebfefbebd975ef0d3d4" title="Returns the number of items added to the tree.">Size</a>(),
<a name="l02902"></a>02902                            <span class="stringliteral">&quot;Invalid key in WriteData() beyond end of predeclaration.&quot;</span>);
<a name="l02903"></a>02903 
<a name="l02904"></a>02904             <a class="code" href="stx-cbtreedb_8h.html#aea46b67a1c31f750df77b32d5db56e2f" title="Short macro to throw exceptions if a program logic expression fails.">CBTREEDB_CHECK</a>(<a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#a1e3eb04ed4649ee24e3970edd7e97924" title="phase 2: output stream">m_ostream</a>-&gt;tellp() == std::ostream::pos_type(<a class="code" href="classstx_1_1CBTreeDB.html#af31d6adca51ce73acce0abbb0ac3bd72" title="Fixed signature page size: always equal to the B-tree page.">SignaturePageSize</a> + <a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#adeb03bd49fd5ca9a8d6189206451be5f" title="signature page of current written file">m_signature</a>.<a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#a0ae66a64d4404955ee7df3d65c298876" title="b-tree total size in bytes">btree_size</a> + <a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#abed97e673243f728d0d9a95ed8a66dd5" title="phase 2: current offset in output stream">m_curroffset</a>),
<a name="l02905"></a>02905                            <span class="stringliteral">&quot;Output stream data position is incorrect.&quot;</span>);
<a name="l02906"></a>02906 
<a name="l02907"></a>02907             <a class="code" href="classstx_1_1CBTreeDB.html#a3853858e7d8cc630c832232bc46ed2c0" title="first template parameter: the key type of the B-tree.">key_type</a> expectedkey;
<a name="l02908"></a>02908             uint32_t expectedsize;
<a name="l02909"></a>02909 
<a name="l02910"></a>02910             <a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#aa6134fc3fec0e844936059cdce69cb7a" title="phase 1: b-tree object built from sequential predeclared sequence">m_btree</a>.<a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#ae19fde8f6d5a9caae3abb4ddefd94452" title="Return key previously inserted at given index.">GetIndex</a>(<a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#abb9ad789240ab9f873edad155df33ea4" title="phase 2: current position in array">m_currpos</a>, expectedkey, expectedsize);
<a name="l02911"></a>02911 
<a name="l02912"></a>02912             <a class="code" href="stx-cbtreedb_8h.html#aea46b67a1c31f750df77b32d5db56e2f" title="Short macro to throw exceptions if a program logic expression fails.">CBTREEDB_CHECK</a>(!<a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#a0ca8bd694df7758aba25b8e02446c06b" title="key comparison functional">m_key_less</a>(key, expectedkey) &amp;&amp; !<a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#a0ca8bd694df7758aba25b8e02446c06b" title="key comparison functional">m_key_less</a>(expectedkey, key), <span class="comment">// test equality</span>
<a name="l02913"></a>02913                            <span class="stringliteral">&quot;Key in WriteData() mismatches predeclared sequence.&quot;</span>);
<a name="l02914"></a>02914 
<a name="l02915"></a>02915             <a class="code" href="stx-cbtreedb_8h.html#aea46b67a1c31f750df77b32d5db56e2f" title="Short macro to throw exceptions if a program logic expression fails.">CBTREEDB_CHECK</a>(size == expectedsize,
<a name="l02916"></a>02916                            <span class="stringliteral">&quot;Value data size in WriteData() mismatches predeclared sequence.&quot;</span>);
<a name="l02917"></a>02917 
<a name="l02918"></a>02918             <a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#a1e3eb04ed4649ee24e3970edd7e97924" title="phase 2: output stream">m_ostream</a>-&gt;write(reinterpret_cast&lt;const char*&gt;(data), size);
<a name="l02919"></a>02919             <a class="code" href="stx-cbtreedb_8h.html#aea46b67a1c31f750df77b32d5db56e2f" title="Short macro to throw exceptions if a program logic expression fails.">CBTREEDB_CHECK</a>(<a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#a1e3eb04ed4649ee24e3970edd7e97924" title="phase 2: output stream">m_ostream</a>-&gt;good(), <span class="stringliteral">&quot;Error writing data blocks to output stream.&quot;</span>);
<a name="l02920"></a>02920 
<a name="l02921"></a>02921             <a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#ab8e188fcae4e6b127b3f3593eb7e477e" title="phase 2: running digest of the value area">m_datasha</a>.<a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#ad306a1c3c2f0321301e563af37bb17cd" title="Update this SHA256 calculation with new data.">update</a>(data, size);
<a name="l02922"></a>02922 
<a name="l02923"></a>02923             ++<a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#abb9ad789240ab9f873edad155df33ea4" title="phase 2: current position in array">m_currpos</a>;
<a name="l02924"></a>02924             <a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#abed97e673243f728d0d9a95ed8a66dd5" title="phase 2: current offset in output stream">m_curroffset</a> += size;
<a name="l02925"></a>02925         }
<a name="l02926"></a>02926 
<a name="l02929"></a><a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#a751ddde018c1ddf297418897b29574c7">02929</a>         <span class="keywordtype">void</span> <a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#a1752833c7e6276010cb9c9a310734882" title="Sequentially write value blobs to file.">WriteValue</a>(<span class="keyword">const</span> <a class="code" href="classstx_1_1CBTreeDB.html#a3853858e7d8cc630c832232bc46ed2c0" title="first template parameter: the key type of the B-tree.">key_type</a>&amp; key, <span class="keyword">const</span> std::string&amp; data)
<a name="l02930"></a>02930         {
<a name="l02931"></a>02931             <span class="keywordflow">return</span> <a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#a1752833c7e6276010cb9c9a310734882" title="Sequentially write value blobs to file.">WriteValue</a>(key, data.data(), data.size());
<a name="l02932"></a>02932         }
<a name="l02933"></a>02933 
<a name="l02935"></a><a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#a2ee0b0fef29c9d1b0f147ab09731d3e0">02935</a>         <span class="keywordtype">void</span> <a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#a2ee0b0fef29c9d1b0f147ab09731d3e0" title="Finalize database file.">WriteFinalize</a>()
<a name="l02936"></a>02936         {
<a name="l02937"></a>02937             <a class="code" href="stx-cbtreedb_8h.html#aea46b67a1c31f750df77b32d5db56e2f" title="Short macro to throw exceptions if a program logic expression fails.">CBTREEDB_CHECK</a>(<a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#a1e3eb04ed4649ee24e3970edd7e97924" title="phase 2: output stream">m_ostream</a> != NULL,
<a name="l02938"></a>02938                            <span class="stringliteral">&quot;Cannot write data, because phase 2 was not started.&quot;</span>);
<a name="l02939"></a>02939 
<a name="l02940"></a>02940             <a class="code" href="stx-cbtreedb_8h.html#aea46b67a1c31f750df77b32d5db56e2f" title="Short macro to throw exceptions if a program logic expression fails.">CBTREEDB_CHECK</a>(<a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#abb9ad789240ab9f873edad155df33ea4" title="phase 2: current position in array">m_currpos</a> == <a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#aa6134fc3fec0e844936059cdce69cb7a" title="phase 1: b-tree object built from sequential predeclared sequence">m_btree</a>.<a class="code" href="classstx_1_1CBTreeDB_1_1BTreeBuilder.html#ad44cf36a5826bebfefbebd975ef0d3d4" title="Returns the number of items added to the tree.">Size</a>(),
<a name="l02941"></a>02941                            <span class="stringliteral">&quot;WriteFinalize() called before end of predeclared sequence.&quot;</span>);
<a name="l02942"></a>02942 
<a name="l02943"></a>02943             <a class="code" href="stx-cbtreedb_8h.html#aea46b67a1c31f750df77b32d5db56e2f" title="Short macro to throw exceptions if a program logic expression fails.">CBTREEDB_CHECK</a>(<a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#a1e3eb04ed4649ee24e3970edd7e97924" title="phase 2: output stream">m_ostream</a>-&gt;tellp() == std::ostream::pos_type(<a class="code" href="classstx_1_1CBTreeDB.html#af31d6adca51ce73acce0abbb0ac3bd72" title="Fixed signature page size: always equal to the B-tree page.">SignaturePageSize</a> + <a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#adeb03bd49fd5ca9a8d6189206451be5f" title="signature page of current written file">m_signature</a>.<a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#a0ae66a64d4404955ee7df3d65c298876" title="b-tree total size in bytes">btree_size</a> + <a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#adeb03bd49fd5ca9a8d6189206451be5f" title="signature page of current written file">m_signature</a>.<a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#ae7b237b7498fe2cc48844222861de850" title="total size of value data area">value_size</a>),
<a name="l02944"></a>02944                            <span class="stringliteral">&quot;Output stream data position is incorrect.&quot;</span>);
<a name="l02945"></a>02945 
<a name="l02946"></a>02946             <span class="comment">// Fill in signature page</span>
<a name="l02947"></a>02947 
<a name="l02948"></a>02948             <a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#adeb03bd49fd5ca9a8d6189206451be5f" title="signature page of current written file">m_signature</a>.<a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#a32547b948043297c36349fa1f72a07f0" title="file offset of value data area">value_offset</a> = <a class="code" href="classstx_1_1CBTreeDB.html#af31d6adca51ce73acce0abbb0ac3bd72" title="Fixed signature page size: always equal to the B-tree page.">SignaturePageSize</a> + <a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#adeb03bd49fd5ca9a8d6189206451be5f" title="signature page of current written file">m_signature</a>.<a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#a0ae66a64d4404955ee7df3d65c298876" title="b-tree total size in bytes">btree_size</a>;
<a name="l02949"></a>02949             <a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#ab8e188fcae4e6b127b3f3593eb7e477e" title="phase 2: running digest of the value area">m_datasha</a>.<a class="code" href="classstx_1_1CBTreeDB_1_1SHA256.html#ab69946b6e8a4fc6190dc14d9df9b886d" title="Return final SHA256 digest of this object in the buffer.">final</a>(<a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#adeb03bd49fd5ca9a8d6189206451be5f" title="signature page of current written file">m_signature</a>.<a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#a6837b8e8b502df1f3c233e7f5c689d2e" title="SHA256 digest of all value data.">value_sha256</a>);
<a name="l02950"></a>02950 
<a name="l02951"></a>02951             <span class="comment">// Calculate header checksum</span>
<a name="l02952"></a>02952 
<a name="l02953"></a>02953             <a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#adeb03bd49fd5ca9a8d6189206451be5f" title="signature page of current written file">m_signature</a>.<a class="code" href="structstx_1_1CBTreeDB_1_1SignaturePage.html#a6600a8e6bef01f7ec30af5f4ad2b4823" title="CRC32 of following bytes.">header_crc32</a> = <a class="code" href="classstx_1_1CBTreeDB_1_1CRC32.html#a9eb10033fa35e3a5db820e5e37111b27" title="Calculate CRC32 digest of bytes in the given range.">CRC32::digest</a>(reinterpret_cast&lt;char*&gt;(&amp;<a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#adeb03bd49fd5ca9a8d6189206451be5f" title="signature page of current written file">m_signature</a>)+16, <span class="keyword">sizeof</span>(<a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#adeb03bd49fd5ca9a8d6189206451be5f" title="signature page of current written file">m_signature</a>)-16);
<a name="l02954"></a>02954 
<a name="l02955"></a>02955             <a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#a1e3eb04ed4649ee24e3970edd7e97924" title="phase 2: output stream">m_ostream</a>-&gt;seekp(0, std::ios::beg);
<a name="l02956"></a>02956             <a class="code" href="stx-cbtreedb_8h.html#aea46b67a1c31f750df77b32d5db56e2f" title="Short macro to throw exceptions if a program logic expression fails.">CBTREEDB_CHECK</a>(<a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#a1e3eb04ed4649ee24e3970edd7e97924" title="phase 2: output stream">m_ostream</a>-&gt;good(), <span class="stringliteral">&quot;Error seeking back to signature page in output stream.&quot;</span>);
<a name="l02957"></a>02957 
<a name="l02958"></a>02958             <a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#a1e3eb04ed4649ee24e3970edd7e97924" title="phase 2: output stream">m_ostream</a>-&gt;write(reinterpret_cast&lt;char*&gt;(&amp;<a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#adeb03bd49fd5ca9a8d6189206451be5f" title="signature page of current written file">m_signature</a>), <span class="keyword">sizeof</span>(<a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#adeb03bd49fd5ca9a8d6189206451be5f" title="signature page of current written file">m_signature</a>));
<a name="l02959"></a>02959             <a class="code" href="stx-cbtreedb_8h.html#aea46b67a1c31f750df77b32d5db56e2f" title="Short macro to throw exceptions if a program logic expression fails.">CBTREEDB_CHECK</a>(<a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#a1e3eb04ed4649ee24e3970edd7e97924" title="phase 2: output stream">m_ostream</a>-&gt;good(), <span class="stringliteral">&quot;Error writing signature page to output stream.&quot;</span>);
<a name="l02960"></a>02960 
<a name="l02961"></a>02961             <a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#a1e3eb04ed4649ee24e3970edd7e97924" title="phase 2: output stream">m_ostream</a>-&gt;flush();
<a name="l02962"></a>02962             <a class="code" href="classstx_1_1CBTreeDB_1_1WriterSequential.html#a1e3eb04ed4649ee24e3970edd7e97924" title="phase 2: output stream">m_ostream</a> = NULL;
<a name="l02963"></a>02963         }
<a name="l02964"></a>02964     };
<a name="l02965"></a>02965 };
<a name="l02966"></a>02966 
<a name="l02967"></a>02967 } <span class="comment">// namespace stx</span>
<a name="l02968"></a>02968 
<a name="l02969"></a>02969 <span class="preprocessor">#endif // _STX_CBTREEDB_H_</span>
</pre></div></div>
<hr class="footer"/><address style="text-align: right;"><small>Generated on Wed Apr 14 13:43:40 2010 for stx-cbtreedb by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
