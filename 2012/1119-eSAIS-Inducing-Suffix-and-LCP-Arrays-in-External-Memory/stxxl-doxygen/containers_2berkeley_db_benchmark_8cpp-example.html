<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Stxxl: containers/berkeley_db_benchmark.cpp</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />

<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">Stxxl
   &#160;<span id="projectnumber">1.4.0</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">containers/berkeley_db_benchmark.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<p>This is a benchmark mentioned in the paper R. Dementiev, L. Kettner, P. Sanders "STXXL: standard template library for XXL data sets" Software: Practice and Experience Volume 38, Issue 6, Pages 589-637, May 2008 DOI: 10.1002/spe.844</p>
<div class="fragment"><pre class="fragment"><span class="comment">/***************************************************************************</span>
<span class="comment"> *  containers/berkeley_db_benchmark.cpp</span>
<span class="comment"> *</span>
<span class="comment"> *  Part of the STXXL. See http://stxxl.sourceforge.net</span>
<span class="comment"> *</span>
<span class="comment"> *  Copyright (C) 2006 Roman Dementiev &lt;dementiev@ira.uka.de&gt;</span>
<span class="comment"> *  Copyright (C) 2009, 2010 Andreas Beckmann &lt;beckmann@cs.uni-frankfurt.de&gt;</span>
<span class="comment"> *</span>
<span class="comment"> *  Distributed under the Boost Software License, Version 1.0.</span>
<span class="comment"> *  (See accompanying file LICENSE_1_0.txt or copy at</span>
<span class="comment"> *  http://www.boost.org/LICENSE_1_0.txt)</span>
<span class="comment"> **************************************************************************/</span>
<span class="comment"></span>
<span class="comment">//! \example containers/berkeley_db_benchmark.cpp</span>
<span class="comment">//! This is a benchmark mentioned in the paper</span>
<span class="comment">//! R. Dementiev, L. Kettner, P. Sanders &quot;STXXL: standard template library for XXL data sets&quot;</span>
<span class="comment">//! Software: Practice and Experience</span>
<span class="comment">//! Volume 38, Issue 6, Pages 589-637, May 2008</span>
<span class="comment">//! DOI: 10.1002/spe.844</span>
<span class="comment"></span>

<span class="preprocessor">#include &lt;stxxl/vector&gt;</span>
<span class="preprocessor">#include &lt;stxxl/map&gt;</span>
<span class="preprocessor">#include &lt;stxxl/timer&gt;</span>
<span class="preprocessor">#include &lt;stxxl/stream&gt;</span>

<span class="comment"></span>
<span class="comment">///// BDB header ////////////</span>
<span class="comment"></span><span class="preprocessor">#include &lt;db_cxx.h&gt;</span>
<span class="comment"></span>
<span class="comment">///////// TPIE headers //////////</span>
<span class="comment"></span><span class="preprocessor">#include &quot;<a class="code" href="app__config_8h.html">app_config.h</a>&quot;</span>
<span class="preprocessor">#include &lt;portability.h&gt;</span>
<span class="preprocessor">#include &lt;ami_btree.h&gt;</span><span class="comment"></span>
<span class="comment">////////////////////////////</span>
<span class="comment"></span>
<span class="preprocessor">#define BDB_BULK_SCAN</span>
<span class="preprocessor"></span>
<span class="preprocessor">#define KEY_SIZE                8</span>
<span class="preprocessor"></span><span class="preprocessor">#define DATA_SIZE               32</span>
<span class="preprocessor"></span>
<span class="preprocessor">#define NODE_BLOCK_SIZE         (32 * 1024)</span>
<span class="preprocessor"></span><span class="preprocessor">#define LEAF_BLOCK_SIZE         (32 * 1024)</span>
<span class="preprocessor"></span>

<span class="preprocessor">#define LEAF_BLOCK_SIZE         (32 * 1024)</span>
<span class="preprocessor"></span>
<span class="preprocessor">#define TOTAL_CACHE_SIZE        (750 * 1024 * 1024)</span>
<span class="preprocessor"></span><span class="comment">//#define TOTAL_CACHE_SIZE      (150 * 1024 * 1024)</span>

<span class="comment">//#define NODE_CACHE_SIZE       (1 * (TOTAL_CACHE_SIZE / 40))</span>
<span class="comment">//#define LEAF_CACHE_SIZE       (39 * (TOTAL_CACHE_SIZE / 40))</span>

<span class="preprocessor">#define NODE_CACHE_SIZE         (64 * 1024 * 1024)</span>
<span class="preprocessor"></span><span class="preprocessor">#define LEAF_CACHE_SIZE         (TOTAL_CACHE_SIZE - NODE_CACHE_SIZE)</span>
<span class="preprocessor"></span>
<span class="preprocessor">#define SORTER_MEM              (TOTAL_CACHE_SIZE - 1024 * 1024 * 2 * 4)</span>
<span class="preprocessor"></span>

<span class="preprocessor">#define SCAN_LIMIT(x)   (x)</span>
<span class="preprocessor"></span>
<span class="comment">//#define BDB_FILE &quot;/data3/bdb_file&quot;</span>
<span class="preprocessor">#define BDB_FILE &quot;/var/tmp/bdb_file&quot;</span>
<span class="preprocessor"></span>

<span class="comment">// BDB settings</span>
u_int32_t <a name="a0"></a><a class="code" href="berkeley__db__benchmark_8cpp.html#add79a36854fad90cf20ccbeb92e43416">pagesize</a> = <a name="a1"></a><a class="code" href="berkeley__db__benchmark_8cpp.html#aadc2475e99048c087cbd1584b288c83b">LEAF_BLOCK_SIZE</a>;
u_int <a name="a2"></a><a class="code" href="berkeley__db__benchmark_8cpp.html#a3d38ece5bbf8e1999eff9561a0138aa3">bulkbufsize</a> = 4 * 1024 * 1024;
u_int <a name="a3"></a><a class="code" href="berkeley__db__benchmark_8cpp.html#a0c18339836c57f015c03739d42020108">logbufsize</a> = 8 * 1024 * 1024;
u_int <a name="a4"></a><a class="code" href="berkeley__db__benchmark_8cpp.html#a1af01435dbcacf8dd94c56f0b4bf8bfe">cachesize</a> = (<a name="a5"></a><a class="code" href="berkeley__db__benchmark_8cpp.html#ae2d095b05f2b520aec97799606d4a23b">TOTAL_CACHE_SIZE</a> &lt; 500 * 1024 * 1024) ? (4 * (<a class="code" href="berkeley__db__benchmark_8cpp.html#ae2d095b05f2b520aec97799606d4a23b">TOTAL_CACHE_SIZE</a> / 5)) : (<a class="code" href="berkeley__db__benchmark_8cpp.html#ae2d095b05f2b520aec97799606d4a23b">TOTAL_CACHE_SIZE</a> - 100 * 1024 * 1024);
u_int <a name="a6"></a><a class="code" href="berkeley__db__benchmark_8cpp.html#a1e1ac24c6aa5d36580c83d3dddab0c36">datasize</a> = <a name="a7"></a><a class="code" href="berkeley__db__benchmark_8cpp.html#af55149bc1f05cf18af067a302e31e3f9">DATA_SIZE</a>;
u_int <a name="a8"></a><a class="code" href="berkeley__db__benchmark_8cpp.html#a563cdccfc652aa06a367826c3c203fb2">keysize</a> = <a name="a9"></a><a class="code" href="berkeley__db__benchmark_8cpp.html#a2d996237e082b78b41771b5aa1a6eae1">KEY_SIZE</a>;
u_int <a name="a10"></a><a class="code" href="berkeley__db__benchmark_8cpp.html#a6a0a0665401a65af4427befef67ab0ef">numitems</a> = 0;

<span class="keyword">const</span> <span class="keywordtype">char</span> * <a name="a11"></a><a class="code" href="berkeley__db__benchmark_8cpp.html#a0ad52c9446da7975c5d485b9ddb4f66f">letters</a> = <span class="stringliteral">&quot;abcdefghijklmnopqrstuvwxuz&quot;</span>;

<span class="keyword">struct </span>my_key
{
    <span class="keywordtype">char</span> keybuf[<a class="code" href="berkeley__db__benchmark_8cpp.html#a2d996237e082b78b41771b5aa1a6eae1">KEY_SIZE</a>];
};


std::ostream &amp; <a name="a12"></a><a class="code" href="group__iolayer.html#ga331bed90111d6e237dffdd02031634b8">operator &lt;&lt; </a>(std::ostream &amp; o, <span class="keyword">const</span> my_key &amp; obj)
{
    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="berkeley__db__benchmark_8cpp.html#a2d996237e082b78b41771b5aa1a6eae1">KEY_SIZE</a>; ++i)
        o &lt;&lt; obj.keybuf[i];

    <span class="keywordflow">return</span> o;
}

<span class="keywordtype">bool</span> <a name="a13"></a><a class="code" href="berkeley__db__benchmark_8cpp.html#ad4c6a7a36c92d018e504a277ed9103d4">operator == </a>(<span class="keyword">const</span> my_key &amp; a, <span class="keyword">const</span> my_key &amp; b)
{
    <span class="keywordflow">return</span> strncmp(a.keybuf, b.keybuf, <a class="code" href="berkeley__db__benchmark_8cpp.html#a2d996237e082b78b41771b5aa1a6eae1">KEY_SIZE</a>) == 0;
}

<span class="keywordtype">bool</span> <a name="a14"></a><a class="code" href="berkeley__db__benchmark_8cpp.html#a4779de26f4b5381539c1a4ca264a13a2">operator != </a>(<span class="keyword">const</span> my_key &amp; a, <span class="keyword">const</span> my_key &amp; b)
{
    <span class="keywordflow">return</span> strncmp(a.keybuf, b.keybuf, <a class="code" href="berkeley__db__benchmark_8cpp.html#a2d996237e082b78b41771b5aa1a6eae1">KEY_SIZE</a>) != 0;
}

<span class="keywordtype">bool</span> <a name="a15"></a><a class="code" href="gen__file_8cpp.html#a5ec113fe35d70394d00253126988aedf">operator &lt; </a>(<span class="keyword">const</span> my_key &amp; a, <span class="keyword">const</span> my_key &amp; b)
{
    <span class="keywordflow">return</span> strncmp(a.keybuf, b.keybuf, <a class="code" href="berkeley__db__benchmark_8cpp.html#a2d996237e082b78b41771b5aa1a6eae1">KEY_SIZE</a>) &lt; 0;
}

<span class="keywordtype">bool</span> <a name="a16"></a><a class="code" href="berkeley__db__benchmark_8cpp.html#af19b406e5b079f4e6e9c9e0d01f0207b">operator &gt; </a>(<span class="keyword">const</span> my_key &amp; a, <span class="keyword">const</span> my_key &amp; b)
{
    <span class="keywordflow">return</span> strncmp(a.keybuf, b.keybuf, <a class="code" href="berkeley__db__benchmark_8cpp.html#a2d996237e082b78b41771b5aa1a6eae1">KEY_SIZE</a>) &gt; 0;
}

<span class="keywordtype">bool</span> <a name="a17"></a><a class="code" href="berkeley__db__benchmark_8cpp.html#a9b7456d22de3174f3a2a0d5be6e59319">operator &lt;= </a>(<span class="keyword">const</span> my_key &amp; a, <span class="keyword">const</span> my_key &amp; b)
{
    <span class="keywordflow">return</span> strncmp(a.keybuf, b.keybuf, <a class="code" href="berkeley__db__benchmark_8cpp.html#a2d996237e082b78b41771b5aa1a6eae1">KEY_SIZE</a>) &lt;= 0;
}

<span class="keywordtype">bool</span> <a name="a18"></a><a class="code" href="berkeley__db__benchmark_8cpp.html#a3a48055524342fe4166a9009e5eac214">operator &gt;= </a>(<span class="keyword">const</span> my_key &amp; a, <span class="keyword">const</span> my_key &amp; b)
{
    <span class="keywordflow">return</span> strncmp(a.keybuf, b.keybuf, <a class="code" href="berkeley__db__benchmark_8cpp.html#a2d996237e082b78b41771b5aa1a6eae1">KEY_SIZE</a>) &gt;= 0;
}


<span class="keyword">struct </span>my_data
{
    <span class="keywordtype">char</span> databuf[<a class="code" href="berkeley__db__benchmark_8cpp.html#af55149bc1f05cf18af067a302e31e3f9">DATA_SIZE</a>];
};

std::ostream &amp; <a class="code" href="group__iolayer.html#ga331bed90111d6e237dffdd02031634b8">operator &lt;&lt; </a>(std::ostream &amp; o, <span class="keyword">const</span> my_data &amp; obj)
{
    o &lt;&lt; <span class="stringliteral">&quot;DATA(size=&quot;</span> &lt;&lt; <span class="keyword">sizeof</span>(obj) &lt;&lt; <span class="stringliteral">&quot;) &quot;</span>;

    <span class="keywordflow">return</span> o;
}

my_key <a name="a19"></a><a class="code" href="berkeley__db__benchmark_8cpp.html#a8b28233ae5d18060c6362006eb904ad0">min_key</a>, <a name="a20"></a><a class="code" href="berkeley__db__benchmark_8cpp.html#a2ba11bcf309bb8295f91239bf5df1f39">max_key</a>;

<span class="keyword">struct </span>comp_type : std::binary_function&lt;my_key, my_key, bool&gt;
{
    <span class="keywordtype">bool</span> operator () (<span class="keyword">const</span> my_key &amp; a, <span class="keyword">const</span> my_key &amp; b)<span class="keyword"> const</span>
<span class="keyword">    </span>{
        <span class="keywordflow">return</span> strncmp(a.keybuf, b.keybuf, <a class="code" href="berkeley__db__benchmark_8cpp.html#a2d996237e082b78b41771b5aa1a6eae1">KEY_SIZE</a>) &lt; 0;
    }
    <span class="keyword">static</span> my_key max_value()
    {
        <span class="keywordflow">return</span> <a class="code" href="berkeley__db__benchmark_8cpp.html#a2ba11bcf309bb8295f91239bf5df1f39">max_key</a>;
    }
    <span class="keyword">static</span> my_key min_value()
    {
        <span class="keywordflow">return</span> <a class="code" href="berkeley__db__benchmark_8cpp.html#a8b28233ae5d18060c6362006eb904ad0">min_key</a>;
    }
};

<span class="comment"></span>
<span class="comment">/// TPIE  declarations</span>
<span class="comment"></span><span class="comment">// Key type.</span>
<span class="keyword">typedef</span> my_key <a name="a21"></a><a class="code" href="berkeley__db__benchmark_8cpp.html#a55bcc85479e14a8295ae0d0d99d98c27" title="TPIE declarations.">bkey_t</a>;

<span class="comment">// Element type for the btree.</span>
<span class="keyword">struct </span>el_t {
    bkey_t key_;
    my_data data_;
    el_t(bkey_t k) : key_(k) { }
    el_t() { }
};
<span class="keyword">struct </span>key_from_el {
    bkey_t operator () (<span class="keyword">const</span> el_t &amp; v)<span class="keyword"> const</span>
<span class="keyword">    </span>{
        <span class="keywordflow">return</span> v.key_;
    }
};


<span class="comment">// Temporary distinction btw UN*X and WIN, since there are some</span>
<span class="comment">// problems with the MMAP collection implementation.</span>
<span class="preprocessor">#ifdef _WIN32</span>
<span class="preprocessor"></span><span class="keyword">typedef</span> AMI_btree&lt;bkey_t, el_t, less&lt;bkey_t&gt;, key_from_el, BTE_COLLECTION_UFS&gt; <a name="a22"></a><a class="code" href="berkeley__db__benchmark_8cpp.html#a6eb9a9d4940e189f690a95cbdbbfdd1a">u_btree_t</a>;
<span class="preprocessor">#else</span>
<span class="preprocessor"></span><span class="keyword">typedef</span> AMI_btree&lt;bkey_t, el_t, less&lt;bkey_t&gt;, key_from_el&gt; <a class="code" href="berkeley__db__benchmark_8cpp.html#a6eb9a9d4940e189f690a95cbdbbfdd1a">u_btree_t</a>;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>

<span class="keywordtype">void</span> <a name="a23"></a><a class="code" href="berkeley__db__benchmark_8cpp.html#a02fd73d861ef2e4aabb38c0c9ff82947">init</a>()
{
    memset(max_key.keybuf, (std::numeric_limits&lt;unsigned char&gt;::max)(), <a class="code" href="berkeley__db__benchmark_8cpp.html#a2d996237e082b78b41771b5aa1a6eae1">KEY_SIZE</a>);
    memset(min_key.keybuf, (std::numeric_limits&lt;unsigned char&gt;::min)(), <a class="code" href="berkeley__db__benchmark_8cpp.html#a2d996237e082b78b41771b5aa1a6eae1">KEY_SIZE</a>);
}

<span class="keyword">typedef</span> <a name="_a24"></a><a class="code" href="classstxxl_1_1map.html" title="External associative container.">stxxl::map&lt;my_key, my_data, comp_type, NODE_BLOCK_SIZE, LEAF_BLOCK_SIZE&gt;</a> <a name="a25"></a><a class="code" href="berkeley__db__benchmark_8cpp.html#a57f189dde181ea13acbec12d32ed2f0f">map_type</a>;

<span class="preprocessor">#define REAL_NODE_BLOCK_SIZE map_type::node_block_type::raw_size</span>
<span class="preprocessor"></span><span class="preprocessor">#define REAL_LEAF_BLOCK_SIZE map_type::leaf_block_type::raw_size</span>
<span class="preprocessor"></span><span class="preprocessor">#define REAL_NODE_MELEMENTS map_type::node_block_type::size</span>
<span class="preprocessor"></span><span class="preprocessor">#define REAL_LEAF_MELEMENTS map_type::leaf_block_type::size</span>
<span class="preprocessor"></span>
<span class="keyword">typedef</span> <a name="_a26"></a><a class="code" href="structstxxl_1_1VECTOR__GENERATOR.html" title="External vector type generator.">stxxl::VECTOR_GENERATOR&lt;std::pair&lt;my_key, my_data&gt;</a>, 1, 1&gt;::result <a name="a27"></a><a class="code" href="berkeley__db__benchmark_8cpp.html#a19f801317ea1e10778f4adf937dc657c">vector_type</a>;
<span class="comment">//typedef stxxl::vector&lt;std::pair&lt;my_key,my_data&gt;,1,stxxl::lru_pager&lt;1&gt;,512*1024&gt;  vector_type;</span>


<span class="comment">//#define KEYPOS        (i % KEY_SIZE)</span>
<span class="comment">//#define VALUE         (myrand() % 26)</span>


<span class="preprocessor">#if 0</span>
<span class="preprocessor"></span><span class="keywordtype">unsigned</span> <a name="a28"></a><a class="code" href="namespacestxxl.html#ad4bd075c2f105fbee7b7efd534a06fc8">ran32State</a> = 0xdeadbeef;
<span class="keyword">inline</span> <span class="keywordtype">unsigned</span> <a name="a29"></a><a class="code" href="berkeley__db__benchmark_8cpp.html#a7d6e735c38ec1406924e6c59947be236">myrand</a>()
{
    <span class="keywordflow">return</span> (ran32State = 1664525 * ran32State + 1013904223);
}
<span class="keyword">inline</span> <span class="keywordtype">void</span> <a name="a30"></a><a class="code" href="berkeley__db__benchmark_8cpp.html#a57ba0fad9060575d3780456eb098df7f">rand_key</a>(<a class="code" href="namespacestxxl.html#ad7f9125156ce2d31af5283aa66568f0d">stxxl::int64</a> pos, my_key &amp; Key)
{
    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="berkeley__db__benchmark_8cpp.html#a2d996237e082b78b41771b5aa1a6eae1">KEY_SIZE</a>; ++i)
        Key.keybuf[i] = letters[<a class="code" href="berkeley__db__benchmark_8cpp.html#a7d6e735c38ec1406924e6c59947be236">myrand</a>() % 26];
}
<span class="preprocessor">#else // a longer pseudo random sequence</span>
<span class="preprocessor"></span><span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">unsigned</span> ran32State = 0xdeadbeef;
<span class="keyword">inline</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">unsigned</span> <a class="code" href="berkeley__db__benchmark_8cpp.html#a7d6e735c38ec1406924e6c59947be236">myrand</a>()
{
    <span class="keywordflow">return</span> (ran32State = (ran32State * 0x5DEECE66DULL + 0xBULL) &amp; 0xFFFFFFFFFFFFULL);
}
<span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="berkeley__db__benchmark_8cpp.html#a57ba0fad9060575d3780456eb098df7f">rand_key</a>(<a class="code" href="namespacestxxl.html#ad7f9125156ce2d31af5283aa66568f0d">stxxl::int64</a> <span class="comment">/*pos*/</span>, my_key &amp; Key)
{
    <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">unsigned</span> r = <a class="code" href="berkeley__db__benchmark_8cpp.html#a7d6e735c38ec1406924e6c59947be236">myrand</a>();
    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="berkeley__db__benchmark_8cpp.html#a2d996237e082b78b41771b5aa1a6eae1">KEY_SIZE</a>; ++i)
    {
        Key.keybuf[i] = letters[r % 26];
        r &gt;&gt;= 5;
    }
}
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
<span class="keywordtype">void</span> <a name="a31"></a><a class="code" href="berkeley__db__benchmark_8cpp.html#a36b2540fbc0169406a90764a334036cf">run_bdb_btree</a>(<a class="code" href="namespacestxxl.html#ad7f9125156ce2d31af5283aa66568f0d">stxxl::int64</a> ops)
{
    <span class="keyword">const</span> <span class="keywordtype">char</span> * filename = <a name="a32"></a><a class="code" href="berkeley__db__benchmark_8cpp.html#abc0e896081b12a0d0cedcd49e6cf4f1e">BDB_FILE</a>;

    my_key key1_storage;
    my_data data1_storage;

    unlink(filename);

    memset(key1_storage.keybuf, <span class="charliteral">&#39;a&#39;</span>, KEY_SIZE);
    memset(data1_storage.databuf, <span class="charliteral">&#39;b&#39;</span>, <a class="code" href="berkeley__db__benchmark_8cpp.html#af55149bc1f05cf18af067a302e31e3f9">DATA_SIZE</a>);


    Db db(NULL, 0);             <span class="comment">// Instantiate the Db object</span>

    <span class="keywordflow">try</span> {
        db.set_errfile(stderr);
        db.set_pagesize(<a class="code" href="berkeley__db__benchmark_8cpp.html#add79a36854fad90cf20ccbeb92e43416">pagesize</a>);
        db.set_cachesize(0, <a class="code" href="berkeley__db__benchmark_8cpp.html#a1af01435dbcacf8dd94c56f0b4bf8bfe">cachesize</a>, 1);

        <span class="comment">// Open the database</span>
        db.open(NULL,           <span class="comment">// Transaction pointer</span>
                filename,       <span class="comment">// Database file name</span>
                NULL,           <span class="comment">// Optional logical database name</span>
                DB_BTREE,       <span class="comment">// Database access method</span>
                DB_CREATE,      <span class="comment">// Open flags</span>
                0);             <span class="comment">// File mode (using defaults)</span>


        <span class="comment">// here we start with the tests</span>
        Dbt key1(key1_storage.keybuf, KEY_SIZE);
        Dbt data1(data1_storage.databuf, <a class="code" href="berkeley__db__benchmark_8cpp.html#af55149bc1f05cf18af067a302e31e3f9">DATA_SIZE</a>);

        <a name="_a33"></a><a class="code" href="classstxxl_1_1timer.html">stxxl::timer</a> Timer;
        <a class="code" href="namespacestxxl.html#ad7f9125156ce2d31af5283aa66568f0d">stxxl::int64</a> n_inserts = ops, n_locates = ops, n_range_queries = ops, n_deletes = ops;
        <a class="code" href="namespacestxxl.html#ad7f9125156ce2d31af5283aa66568f0d">stxxl::int64</a> i;
        <span class="comment">//comp_type cmp_;</span>

        ran32State = 0xdeadbeef;


        DB_BTREE_STAT * dbstat;

        db.stat(NULL, &amp;dbstat, 0);
        <a name="a34"></a><a class="code" href="leda__sm__pq__benchmark_8cpp.html#afec876b95f7d6cc4b0f0bd4c0d7d89a0">STXXL_MSG</a>(<span class="stringliteral">&quot;Records in map: &quot;</span> &lt;&lt; dbstat-&gt;bt_ndata);

        db.get_env()-&gt;memp_stat(NULL, NULL, DB_STAT_CLEAR);

        Timer.<a name="a35"></a><a class="code" href="classstxxl_1_1timer.html#a0ae0e789f391f05c9ad232af88a823ce">start</a>();

        <span class="keywordflow">for</span> (i = 0; i &lt; n_inserts; ++i)
        {
            <span class="comment">//key1_storage.keybuf[KEYPOS] = letters[VALUE];</span>
            <a class="code" href="berkeley__db__benchmark_8cpp.html#a57ba0fad9060575d3780456eb098df7f">rand_key</a>(i, key1_storage);
            db.put(NULL, &amp;key1, &amp;data1, DB_NOOVERWRITE);
        }

        Timer.<a name="a36"></a><a class="code" href="classstxxl_1_1timer.html#ae0e47067a50b26bd88dd891f486d6961">stop</a>();
        db.stat(NULL, &amp;dbstat, 0);
        <a class="code" href="leda__sm__pq__benchmark_8cpp.html#afec876b95f7d6cc4b0f0bd4c0d7d89a0">STXXL_MSG</a>(<span class="stringliteral">&quot;Records in map: &quot;</span> &lt;&lt; dbstat-&gt;bt_ndata);
        <a class="code" href="leda__sm__pq__benchmark_8cpp.html#afec876b95f7d6cc4b0f0bd4c0d7d89a0">STXXL_MSG</a>(<span class="stringliteral">&quot;Insertions elapsed time: &quot;</span> &lt;&lt; (Timer.<a name="a37"></a><a class="code" href="classstxxl_1_1timer.html#a4321c5541a83782e34b4bfac9b0402a9">mseconds</a>() / 1000.) &lt;&lt;
                  <span class="stringliteral">&quot; seconds : &quot;</span> &lt;&lt; (double(n_inserts) / (Timer.<a class="code" href="classstxxl_1_1timer.html#a4321c5541a83782e34b4bfac9b0402a9">mseconds</a>() / 1000.)) &lt;&lt; <span class="stringliteral">&quot; key/data pairs per sec&quot;</span>);

        db.get_env()-&gt;memp_stat_print(DB_STAT_CLEAR);
<span class="comment"></span>
<span class="comment">        /////////////////////////////////////////</span>
<span class="comment"></span>        Timer.<a name="a38"></a><a class="code" href="classstxxl_1_1timer.html#af2f69d7d5d9a3dc863da5cf8fda5eea0">reset</a>();
        Timer.<a class="code" href="classstxxl_1_1timer.html#a0ae0e789f391f05c9ad232af88a823ce">start</a>();


        Dbc * cursorp;
        db.cursor(NULL, &amp;cursorp, 0);

        <span class="keywordflow">for</span> (i = 0; i &lt; n_locates; ++i)
        {
            <span class="comment">//key1_storage.keybuf[KEYPOS] = letters[VALUE];</span>
            <a class="code" href="berkeley__db__benchmark_8cpp.html#a57ba0fad9060575d3780456eb098df7f">rand_key</a>(i, key1_storage);
            Dbt keyx(key1_storage.keybuf, KEY_SIZE);
            Dbt datax(data1_storage.databuf, <a class="code" href="berkeley__db__benchmark_8cpp.html#af55149bc1f05cf18af067a302e31e3f9">DATA_SIZE</a>);

            cursorp-&gt;get(&amp;keyx, &amp;datax, DB_SET_RANGE);
        }

        Timer.<a class="code" href="classstxxl_1_1timer.html#ae0e47067a50b26bd88dd891f486d6961">stop</a>();
        <a class="code" href="leda__sm__pq__benchmark_8cpp.html#afec876b95f7d6cc4b0f0bd4c0d7d89a0">STXXL_MSG</a>(<span class="stringliteral">&quot;Locates elapsed time: &quot;</span> &lt;&lt; (Timer.<a class="code" href="classstxxl_1_1timer.html#a4321c5541a83782e34b4bfac9b0402a9">mseconds</a>() / 1000.) &lt;&lt;
                  <span class="stringliteral">&quot; seconds : &quot;</span> &lt;&lt; (double(ops) / (Timer.<a class="code" href="classstxxl_1_1timer.html#a4321c5541a83782e34b4bfac9b0402a9">mseconds</a>() / 1000.)) &lt;&lt; <span class="stringliteral">&quot; key/data pairs per sec&quot;</span>);

        db.get_env()-&gt;memp_stat_print(DB_STAT_CLEAR);
<span class="comment"></span>
<span class="comment">        ////////////////////////////////////</span>
<span class="comment"></span>        Timer.<a class="code" href="classstxxl_1_1timer.html#af2f69d7d5d9a3dc863da5cf8fda5eea0">reset</a>();

        Timer.<a class="code" href="classstxxl_1_1timer.html#a0ae0e789f391f05c9ad232af88a823ce">start</a>();

        <a class="code" href="namespacestxxl.html#ad7f9125156ce2d31af5283aa66568f0d">stxxl::int64</a> n_scanned = 0;

        <span class="keywordflow">for</span> (i = 0; i &lt; n_range_queries; ++i)
        {
            <span class="comment">//key1_storage.keybuf[KEYPOS] = letters[VALUE];</span>
            <a class="code" href="berkeley__db__benchmark_8cpp.html#a57ba0fad9060575d3780456eb098df7f">rand_key</a>(i, key1_storage);
            my_key last_key = key1_storage;
            <span class="comment">//key1_storage.keybuf[KEYPOS] = letters[VALUE];</span>
            <a class="code" href="berkeley__db__benchmark_8cpp.html#a57ba0fad9060575d3780456eb098df7f">rand_key</a>(i, key1_storage);
            <span class="keywordflow">if</span> (last_key &lt; key1_storage)
                <a name="a39"></a><a class="code" href="namespacestd.html#abc5bd04888275546472a3a5b813fe030">std::swap</a>(last_key, key1_storage);


            Dbt keyx(key1_storage.keybuf, KEY_SIZE);
            Dbt datax(data1_storage.databuf, <a class="code" href="berkeley__db__benchmark_8cpp.html#af55149bc1f05cf18af067a302e31e3f9">DATA_SIZE</a>);

            <span class="keywordflow">if</span> (cursorp-&gt;get(&amp;keyx, &amp;datax, DB_SET_RANGE) == DB_NOTFOUND)
                <span class="keywordflow">continue</span>;


            <span class="keywordflow">while</span> (*((my_key *)keyx.get_data()) &lt;= last_key)
            {
                ++n_scanned;
                <span class="keywordflow">if</span> (cursorp-&gt;get(&amp;keyx, &amp;datax, DB_NEXT) == DB_NOTFOUND)
                    <span class="keywordflow">break</span>;
            }

            <span class="keywordflow">if</span> (n_scanned &gt;= 10 * n_range_queries)
            {
                ++i;
                <span class="keywordflow">break</span>;
            }
        }

        n_range_queries = i;

        Timer.<a class="code" href="classstxxl_1_1timer.html#ae0e47067a50b26bd88dd891f486d6961">stop</a>();
        <span class="keywordflow">if</span> (cursorp != NULL)
            cursorp-&gt;close();


        <a class="code" href="leda__sm__pq__benchmark_8cpp.html#afec876b95f7d6cc4b0f0bd4c0d7d89a0">STXXL_MSG</a>(<span class="stringliteral">&quot;Range query elapsed time: &quot;</span> &lt;&lt; (Timer.<a class="code" href="classstxxl_1_1timer.html#a4321c5541a83782e34b4bfac9b0402a9">mseconds</a>() / 1000.) &lt;&lt;
                  <span class="stringliteral">&quot; seconds : &quot;</span> &lt;&lt; (double(n_scanned) / (Timer.<a class="code" href="classstxxl_1_1timer.html#a4321c5541a83782e34b4bfac9b0402a9">mseconds</a>() / 1000.)) &lt;&lt;
                  <span class="stringliteral">&quot; key/data pairs per sec, #queries &quot;</span> &lt;&lt; n_range_queries &lt;&lt; <span class="stringliteral">&quot; #scanned elements: &quot;</span> &lt;&lt; n_scanned);

        db.get_env()-&gt;memp_stat_print(DB_STAT_CLEAR);
<span class="comment"></span>
<span class="comment">        //////////////////////////////////////</span>
<span class="comment"></span>
        ran32State = 0xdeadbeef;
        memset(key1_storage.keybuf, <span class="charliteral">&#39;a&#39;</span>, KEY_SIZE);

        Timer.<a class="code" href="classstxxl_1_1timer.html#af2f69d7d5d9a3dc863da5cf8fda5eea0">reset</a>();
        Timer.<a class="code" href="classstxxl_1_1timer.html#a0ae0e789f391f05c9ad232af88a823ce">start</a>();

        <span class="keywordflow">for</span> (i = 0; i &lt; n_deletes; ++i)
        {
            <span class="comment">//key1_storage.keybuf[KEYPOS] = letters[VALUE];</span>
            <a class="code" href="berkeley__db__benchmark_8cpp.html#a57ba0fad9060575d3780456eb098df7f">rand_key</a>(i, key1_storage);
            Dbt keyx(key1_storage.keybuf, KEY_SIZE);
            db.del(NULL, &amp;keyx, 0);
        }

        Timer.<a class="code" href="classstxxl_1_1timer.html#ae0e47067a50b26bd88dd891f486d6961">stop</a>();
        db.stat(NULL, &amp;dbstat, 0);
        <a class="code" href="leda__sm__pq__benchmark_8cpp.html#afec876b95f7d6cc4b0f0bd4c0d7d89a0">STXXL_MSG</a>(<span class="stringliteral">&quot;Records in map: &quot;</span> &lt;&lt; dbstat-&gt;bt_ndata);
        <a class="code" href="leda__sm__pq__benchmark_8cpp.html#afec876b95f7d6cc4b0f0bd4c0d7d89a0">STXXL_MSG</a>(<span class="stringliteral">&quot;Erase elapsed time: &quot;</span> &lt;&lt; (Timer.<a class="code" href="classstxxl_1_1timer.html#a4321c5541a83782e34b4bfac9b0402a9">mseconds</a>() / 1000.) &lt;&lt;
                  <span class="stringliteral">&quot; seconds : &quot;</span> &lt;&lt; (double(ops) / (Timer.<a class="code" href="classstxxl_1_1timer.html#a4321c5541a83782e34b4bfac9b0402a9">mseconds</a>() / 1000.)) &lt;&lt; <span class="stringliteral">&quot; key/data pairs per sec&quot;</span>);

        db.get_env()-&gt;memp_stat_print(DB_STAT_CLEAR);

        db.close(0);
    }
    <span class="keywordflow">catch</span> (DbException &amp; e)
    {
        STXXL_ERRMSG(<span class="stringliteral">&quot;DbException happened&quot;</span>);
    }
    <span class="keywordflow">catch</span> (std::exception &amp; e)
    {
        STXXL_ERRMSG(<span class="stringliteral">&quot;std::exception happened&quot;</span>);
    }

    unlink(filename);
}

<span class="keywordtype">void</span> <a name="a40"></a><a class="code" href="berkeley__db__benchmark_8cpp.html#ac744e2997e640dfc51d923d2d5b1ad08">run_stxxl_map</a>(<a class="code" href="namespacestxxl.html#ad7f9125156ce2d31af5283aa66568f0d">stxxl::int64</a> ops)
{
    map_type Map(<a name="a41"></a><a class="code" href="berkeley__db__benchmark_8cpp.html#af8c519765cbd6beaaae87f13a2dab316">NODE_CACHE_SIZE</a>, <a name="a42"></a><a class="code" href="berkeley__db__benchmark_8cpp.html#a954d13cbf831ede2c22efbb0407e951a">LEAF_CACHE_SIZE</a>);
    Map.enable_prefetching();
    <a name="_a43"></a><a class="code" href="classstxxl_1_1stats.html" title="Collects various I/O statistics.">stxxl::stats</a> * Stats = stxxl::stats::get_instance();

    std::pair&lt;my_key, my_data&gt; element;

    memset(element.first.keybuf, <span class="charliteral">&#39;a&#39;</span>, KEY_SIZE);
    memset(element.second.databuf, <span class="charliteral">&#39;b&#39;</span>, <a class="code" href="berkeley__db__benchmark_8cpp.html#af55149bc1f05cf18af067a302e31e3f9">DATA_SIZE</a>);


    <a class="code" href="classstxxl_1_1timer.html">stxxl::timer</a> Timer;
    <a class="code" href="namespacestxxl.html#ad7f9125156ce2d31af5283aa66568f0d">stxxl::int64</a> n_inserts = ops, n_locates = ops, n_range_queries = ops, n_deletes = ops;
    <a class="code" href="namespacestxxl.html#ad7f9125156ce2d31af5283aa66568f0d">stxxl::int64</a> i;
    <span class="comment">//comp_type cmp_;</span>

    ran32State = 0xdeadbeef;

    <span class="comment">//stxxl::random_number32 myrand;</span>

    <a class="code" href="leda__sm__pq__benchmark_8cpp.html#afec876b95f7d6cc4b0f0bd4c0d7d89a0">STXXL_MSG</a>(<span class="stringliteral">&quot;Records in map: &quot;</span> &lt;&lt; Map.size());

    <a name="_a44"></a><a class="code" href="classstxxl_1_1stats__data.html">stxxl::stats_data</a> stats_begin(*Stats);
    Timer.<a class="code" href="classstxxl_1_1timer.html#a0ae0e789f391f05c9ad232af88a823ce">start</a>();

    <span class="keywordflow">for</span> (i = 0; i &lt; n_inserts; ++i)
    {
        <span class="comment">//element.first.keybuf[KEYPOS] = letters[VALUE];</span>
        <a class="code" href="berkeley__db__benchmark_8cpp.html#a57ba0fad9060575d3780456eb098df7f">rand_key</a>(i, element.first);
        Map.insert(element);
    }

    Timer.<a class="code" href="classstxxl_1_1timer.html#ae0e47067a50b26bd88dd891f486d6961">stop</a>();

    <a class="code" href="leda__sm__pq__benchmark_8cpp.html#afec876b95f7d6cc4b0f0bd4c0d7d89a0">STXXL_MSG</a>(<span class="stringliteral">&quot;Records in map: &quot;</span> &lt;&lt; Map.size());
    <a class="code" href="leda__sm__pq__benchmark_8cpp.html#afec876b95f7d6cc4b0f0bd4c0d7d89a0">STXXL_MSG</a>(<span class="stringliteral">&quot;Insertions elapsed time: &quot;</span> &lt;&lt; (Timer.<a class="code" href="classstxxl_1_1timer.html#a4321c5541a83782e34b4bfac9b0402a9">mseconds</a>() / 1000.) &lt;&lt;
              <span class="stringliteral">&quot; seconds : &quot;</span> &lt;&lt; (double(n_inserts) / (Timer.<a class="code" href="classstxxl_1_1timer.html#a4321c5541a83782e34b4bfac9b0402a9">mseconds</a>() / 1000.)) &lt;&lt; <span class="stringliteral">&quot; key/data pairs per sec&quot;</span>);

    std::cout &lt;&lt; (<a class="code" href="classstxxl_1_1stats__data.html">stxxl::stats_data</a>(*Stats) - stats_begin);
<span class="comment"></span>
<span class="comment">    ////////////////////////////////////////////////</span>
<span class="comment"></span>
    <span class="keyword">const</span> map_type &amp; CMap(Map);     <span class="comment">// const map reference</span>

    stats_begin = <a class="code" href="classstxxl_1_1stats__data.html">stxxl::stats_data</a>(*Stats);
    Timer.<a class="code" href="classstxxl_1_1timer.html#af2f69d7d5d9a3dc863da5cf8fda5eea0">reset</a>();
    Timer.<a class="code" href="classstxxl_1_1timer.html#a0ae0e789f391f05c9ad232af88a823ce">start</a>();

    <span class="keywordflow">for</span> (i = 0; i &lt; n_locates; ++i)
    {
        <span class="comment">//element.first.keybuf[KEYPOS] = letters[VALUE];</span>
        <a class="code" href="berkeley__db__benchmark_8cpp.html#a57ba0fad9060575d3780456eb098df7f">rand_key</a>(i, element.first);
        CMap.lower_bound(element.first);
    }

    Timer.<a class="code" href="classstxxl_1_1timer.html#ae0e47067a50b26bd88dd891f486d6961">stop</a>();
    <a class="code" href="leda__sm__pq__benchmark_8cpp.html#afec876b95f7d6cc4b0f0bd4c0d7d89a0">STXXL_MSG</a>(<span class="stringliteral">&quot;Locates elapsed time: &quot;</span> &lt;&lt; (Timer.<a class="code" href="classstxxl_1_1timer.html#a4321c5541a83782e34b4bfac9b0402a9">mseconds</a>() / 1000.) &lt;&lt;
              <span class="stringliteral">&quot; seconds : &quot;</span> &lt;&lt; (double(n_locates) / (Timer.<a class="code" href="classstxxl_1_1timer.html#a4321c5541a83782e34b4bfac9b0402a9">mseconds</a>() / 1000.)) &lt;&lt; <span class="stringliteral">&quot; key/data pairs per sec&quot;</span>);

    std::cout &lt;&lt; (<a class="code" href="classstxxl_1_1stats__data.html">stxxl::stats_data</a>(*Stats) - stats_begin);
<span class="comment"></span>
<span class="comment">    ////////////////////////////////////</span>
<span class="comment"></span>
    stats_begin = <a class="code" href="classstxxl_1_1stats__data.html">stxxl::stats_data</a>(*Stats);
    Timer.<a class="code" href="classstxxl_1_1timer.html#af2f69d7d5d9a3dc863da5cf8fda5eea0">reset</a>();
    Timer.<a class="code" href="classstxxl_1_1timer.html#a0ae0e789f391f05c9ad232af88a823ce">start</a>();

    <a class="code" href="namespacestxxl.html#ad7f9125156ce2d31af5283aa66568f0d">stxxl::int64</a> n_scanned = 0; <span class="comment">//, skipped_qieries = 0;</span>

    <span class="keywordflow">for</span> (i = 0; i &lt; n_range_queries; ++i)
    {
        <span class="comment">//element.first.keybuf[KEYPOS] = letters[VALUE];</span>
        <a class="code" href="berkeley__db__benchmark_8cpp.html#a57ba0fad9060575d3780456eb098df7f">rand_key</a>(i, element.first);
        my_key begin_key = element.first;
        <a name="_a45"></a><a class="code" href="classstxxl_1_1btree_1_1btree__const__iterator.html">map_type::const_iterator</a> begin = CMap.lower_bound(element.first);
        <span class="comment">//element.first.keybuf[KEYPOS] = letters[VALUE];</span>
        <a class="code" href="berkeley__db__benchmark_8cpp.html#a57ba0fad9060575d3780456eb098df7f">rand_key</a>(i, element.first);
        <a class="code" href="classstxxl_1_1btree_1_1btree__const__iterator.html">map_type::const_iterator</a> beyond = CMap.lower_bound(element.first);
        <span class="keywordflow">if</span> (element.first &lt; begin_key)
            <a class="code" href="namespacestd.html#abc5bd04888275546472a3a5b813fe030">std::swap</a>(begin, beyond);

        <span class="keywordflow">while</span> (begin != beyond)
        {
            my_data tmp = begin-&gt;second;
            stxxl::STXXL_UNUSED(tmp);
            ++n_scanned;
            ++begin;
        }
        <span class="keywordflow">if</span> (n_scanned &gt;= 10 * n_range_queries)
        {
            ++i;
            <span class="keywordflow">break</span>;
        }
    }

    n_range_queries = i;

    Timer.<a class="code" href="classstxxl_1_1timer.html#ae0e47067a50b26bd88dd891f486d6961">stop</a>();
    <a class="code" href="leda__sm__pq__benchmark_8cpp.html#afec876b95f7d6cc4b0f0bd4c0d7d89a0">STXXL_MSG</a>(<span class="stringliteral">&quot;Range query elapsed time: &quot;</span> &lt;&lt; (Timer.<a class="code" href="classstxxl_1_1timer.html#a4321c5541a83782e34b4bfac9b0402a9">mseconds</a>() / 1000.) &lt;&lt;
              <span class="stringliteral">&quot; seconds : &quot;</span> &lt;&lt; (double(n_scanned) / (Timer.<a class="code" href="classstxxl_1_1timer.html#a4321c5541a83782e34b4bfac9b0402a9">mseconds</a>() / 1000.)) &lt;&lt;
              <span class="stringliteral">&quot; key/data pairs per sec, #queries &quot;</span> &lt;&lt; n_range_queries &lt;&lt; <span class="stringliteral">&quot; #scanned elements: &quot;</span> &lt;&lt; n_scanned);

    std::cout &lt;&lt; (<a class="code" href="classstxxl_1_1stats__data.html">stxxl::stats_data</a>(*Stats) - stats_begin);
<span class="comment"></span>
<span class="comment">    //////////////////////////////////////</span>
<span class="comment"></span>    ran32State = 0xdeadbeef;
    memset(element.first.keybuf, <span class="charliteral">&#39;a&#39;</span>, KEY_SIZE);
    memset(element.second.databuf, <span class="charliteral">&#39;b&#39;</span>, <a class="code" href="berkeley__db__benchmark_8cpp.html#af55149bc1f05cf18af067a302e31e3f9">DATA_SIZE</a>);

    stats_begin = <a class="code" href="classstxxl_1_1stats__data.html">stxxl::stats_data</a>(*Stats);
    Timer.<a class="code" href="classstxxl_1_1timer.html#af2f69d7d5d9a3dc863da5cf8fda5eea0">reset</a>();
    Timer.<a class="code" href="classstxxl_1_1timer.html#a0ae0e789f391f05c9ad232af88a823ce">start</a>();

    <span class="keywordflow">for</span> (i = 0; i &lt; n_deletes; ++i)
    {
        <span class="comment">//element.first.keybuf[KEYPOS] = letters[VALUE];</span>
        <a class="code" href="berkeley__db__benchmark_8cpp.html#a57ba0fad9060575d3780456eb098df7f">rand_key</a>(i, element.first);
        Map.erase(element.first);
    }

    Timer.<a class="code" href="classstxxl_1_1timer.html#ae0e47067a50b26bd88dd891f486d6961">stop</a>();
    <a class="code" href="leda__sm__pq__benchmark_8cpp.html#afec876b95f7d6cc4b0f0bd4c0d7d89a0">STXXL_MSG</a>(<span class="stringliteral">&quot;Records in map: &quot;</span> &lt;&lt; Map.size());
    <a class="code" href="leda__sm__pq__benchmark_8cpp.html#afec876b95f7d6cc4b0f0bd4c0d7d89a0">STXXL_MSG</a>(<span class="stringliteral">&quot;Erase elapsed time: &quot;</span> &lt;&lt; (Timer.<a class="code" href="classstxxl_1_1timer.html#a4321c5541a83782e34b4bfac9b0402a9">mseconds</a>() / 1000.) &lt;&lt;
              <span class="stringliteral">&quot; seconds : &quot;</span> &lt;&lt; (double(n_deletes) / (Timer.<a class="code" href="classstxxl_1_1timer.html#a4321c5541a83782e34b4bfac9b0402a9">mseconds</a>() / 1000.)) &lt;&lt; <span class="stringliteral">&quot; key/data pairs per sec&quot;</span>);

    std::cout &lt;&lt; (<a class="code" href="classstxxl_1_1stats__data.html">stxxl::stats_data</a>(*Stats) - stats_begin);
}

<span class="keyword">class </span>rand_key_gen
{
    <a class="code" href="namespacestxxl.html#ad7f9125156ce2d31af5283aa66568f0d">stxxl::int64</a> counter;
    my_key &amp; current;
    <a name="_a46"></a><a class="code" href="structstxxl_1_1random__number32.html" title="Fast uniform [0, 2^32) pseudo-random generator with period 2^32, random bits: 32.">stxxl::random_number32</a> <a class="code" href="berkeley__db__benchmark_8cpp.html#a7d6e735c38ec1406924e6c59947be236">myrand</a>;
    rand_key_gen();

<span class="keyword">public</span>:
    <span class="keyword">typedef</span> my_key <a name="a47"></a><a class="code" href="test__push__sort_8cpp.html#ab13c28f7d568dcb8636b7a10c0a609a1">value_type</a>;

    rand_key_gen(<a class="code" href="namespacestxxl.html#ad7f9125156ce2d31af5283aa66568f0d">stxxl::int64</a> el, my_key &amp; cur) :
        counter(el), current(cur)
    {
        <span class="comment">//const stxxl::int64  &amp; i = counter;</span>
        <span class="comment">//current.keybuf[KEYPOS] = letters[VALUE];</span>
        <a class="code" href="berkeley__db__benchmark_8cpp.html#a57ba0fad9060575d3780456eb098df7f">rand_key</a>(counter, current);
    }
    <span class="keyword">const</span> my_key &amp; operator * () { <span class="keywordflow">return</span> current; }
    <span class="keyword">const</span> my_key * operator -&gt; () { <span class="keywordflow">return</span> &amp;current; }

    rand_key_gen &amp; operator ++ ()
    {
        --counter;
        <span class="comment">//const stxxl::int64  &amp; i = counter;</span>
        <span class="comment">//current.keybuf[KEYPOS] = letters[VALUE];</span>
        <a class="code" href="berkeley__db__benchmark_8cpp.html#a57ba0fad9060575d3780456eb098df7f">rand_key</a>(counter, current);
        <span class="keywordflow">return</span> *<span class="keyword">this</span>;
    }
    <span class="keywordtype">bool</span> empty()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> counter == 0; }
};

<span class="keyword">template</span> &lt;<span class="keyword">class</span> InputType&gt;
<span class="keyword">class </span>key2pair
{
    InputType &amp; in;
    std::pair&lt;my_key, my_data&gt; current;
    key2pair();

<span class="keyword">public</span>:
    <span class="keyword">typedef</span> std::pair&lt;my_key, my_data&gt; <a class="code" href="test__push__sort_8cpp.html#ab13c28f7d568dcb8636b7a10c0a609a1">value_type</a>;

    key2pair(InputType &amp; in_) : in(in_)
    {
        <span class="keywordflow">if</span> (!in.empty())
            current.first = *in;
    }
    <span class="keyword">const</span> <a class="code" href="test__push__sort_8cpp.html#ab13c28f7d568dcb8636b7a10c0a609a1">value_type</a> &amp; operator * () { <span class="keywordflow">return</span> current; }
    <span class="keyword">const</span> <a class="code" href="test__push__sort_8cpp.html#ab13c28f7d568dcb8636b7a10c0a609a1">value_type</a> * operator -&gt; () { <span class="keywordflow">return</span> &amp;current; }

    key2pair &amp; operator ++ ()
    {
        ++in;
        <span class="keywordflow">if</span> (!empty())
            current.first = *in;


        <span class="keywordflow">return</span> *<span class="keyword">this</span>;
    }
    <span class="keywordtype">bool</span> empty()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> in.empty(); }
};

<span class="keywordtype">void</span> <a name="a48"></a><a class="code" href="berkeley__db__benchmark_8cpp.html#a631284bbd107ea5a5a598e5433e8ab30">run_stxxl_map_big</a>(<a class="code" href="namespacestxxl.html#ad7f9125156ce2d31af5283aa66568f0d">stxxl::int64</a> n, <span class="keywordtype">unsigned</span> ops)
{
    <a class="code" href="classstxxl_1_1stats.html" title="Collects various I/O statistics.">stxxl::stats</a> * Stats = stxxl::stats::get_instance();

    std::pair&lt;my_key, my_data&gt; element;

    memset(element.first.keybuf, <span class="charliteral">&#39;a&#39;</span>, KEY_SIZE);
    memset(element.second.databuf, <span class="charliteral">&#39;b&#39;</span>, <a class="code" href="berkeley__db__benchmark_8cpp.html#af55149bc1f05cf18af067a302e31e3f9">DATA_SIZE</a>);

    <a class="code" href="classstxxl_1_1timer.html">stxxl::timer</a> Timer;
    <a class="code" href="namespacestxxl.html#ad7f9125156ce2d31af5283aa66568f0d">stxxl::int64</a> n_inserts = ops, n_locates = ops, n_range_queries = ops, n_deletes = ops;
    <a class="code" href="namespacestxxl.html#ad7f9125156ce2d31af5283aa66568f0d">stxxl::int64</a> i;
    <span class="comment">//comp_type cmp_;</span>

    ran32State = 0xdeadbeef;

    <span class="comment">//stxxl::random_number32 myrand;</span>

    Timer.<a class="code" href="classstxxl_1_1timer.html#a0ae0e789f391f05c9ad232af88a823ce">start</a>();

    vector_type SortedSeq(n);
    <span class="keyword">const</span> vector_type &amp; CSortedSeq(SortedSeq);
    {
        rand_key_gen Gen(n, element.first);
        <span class="keyword">typedef</span> <a name="_a49"></a><a class="code" href="classstxxl_1_1stream_1_1sort.html" title="Produces sorted stream from input stream.">stxxl::stream::sort&lt;rand_key_gen, comp_type&gt;</a> sorter_type;
        sorter_type Sorter(Gen, comp_type(), <a name="a50"></a><a class="code" href="berkeley__db__benchmark_8cpp.html#a19182295057b444dd042949c19c3e581">SORTER_MEM</a>);
        <span class="keyword">typedef</span> key2pair&lt;sorter_type&gt; key2pair_type;
        key2pair_type Key2Pair(Sorter);
        <a name="a51"></a><a class="code" href="group__streampack.html#gaf214a1fc62726c3b8e7fb31aa4bfe20e" title="Stores consecutively stream content to an output iterator.">stxxl::stream::materialize</a>(Key2Pair, SortedSeq.begin());
    }


    Timer.<a class="code" href="classstxxl_1_1timer.html#ae0e47067a50b26bd88dd891f486d6961">stop</a>();

    <a class="code" href="leda__sm__pq__benchmark_8cpp.html#afec876b95f7d6cc4b0f0bd4c0d7d89a0">STXXL_MSG</a>(<span class="stringliteral">&quot;Finished sorting input. Elapsed time: &quot;</span> &lt;&lt;
              (Timer.<a class="code" href="classstxxl_1_1timer.html#a4321c5541a83782e34b4bfac9b0402a9">mseconds</a>() / 1000.) &lt;&lt; <span class="stringliteral">&quot; seconds.&quot;</span>);

    <a class="code" href="classstxxl_1_1stats__data.html">stxxl::stats_data</a> stats_begin(*Stats);
    Timer.<a class="code" href="classstxxl_1_1timer.html#af2f69d7d5d9a3dc863da5cf8fda5eea0">reset</a>();
    Timer.<a class="code" href="classstxxl_1_1timer.html#a0ae0e789f391f05c9ad232af88a823ce">start</a>();

    <span class="comment">// bulk construction</span>
    map_type Map(CSortedSeq.begin(),
                 CSortedSeq.end(),
                 <a class="code" href="berkeley__db__benchmark_8cpp.html#af8c519765cbd6beaaae87f13a2dab316">NODE_CACHE_SIZE</a>, <a class="code" href="berkeley__db__benchmark_8cpp.html#a954d13cbf831ede2c22efbb0407e951a">LEAF_CACHE_SIZE</a>, <span class="keyword">true</span>);

    Timer.<a class="code" href="classstxxl_1_1timer.html#ae0e47067a50b26bd88dd891f486d6961">stop</a>();


    <a class="code" href="leda__sm__pq__benchmark_8cpp.html#afec876b95f7d6cc4b0f0bd4c0d7d89a0">STXXL_MSG</a>(<span class="stringliteral">&quot;Records in map: &quot;</span> &lt;&lt; Map.size());
    <a class="code" href="leda__sm__pq__benchmark_8cpp.html#afec876b95f7d6cc4b0f0bd4c0d7d89a0">STXXL_MSG</a>(<span class="stringliteral">&quot;Construction elapsed time: &quot;</span> &lt;&lt; (Timer.<a class="code" href="classstxxl_1_1timer.html#a4321c5541a83782e34b4bfac9b0402a9">mseconds</a>() / 1000.) &lt;&lt;
              <span class="stringliteral">&quot; seconds : &quot;</span> &lt;&lt; (double(n) / (Timer.<a class="code" href="classstxxl_1_1timer.html#a4321c5541a83782e34b4bfac9b0402a9">mseconds</a>() / 1000.)) &lt;&lt; <span class="stringliteral">&quot; key/data pairs per sec&quot;</span>);

    Map.print_statistics(cout);
    Map.reset_statistics();
    std::cout &lt;&lt; (<a class="code" href="classstxxl_1_1stats__data.html">stxxl::stats_data</a>(*Stats) - stats_begin);
<span class="comment"></span>
<span class="comment">    ////////////////////////////////////////</span>
<span class="comment"></span>
    Map.disable_prefetching();

    stats_begin = <a class="code" href="classstxxl_1_1stats__data.html">stxxl::stats_data</a>(*Stats);
    Timer.<a class="code" href="classstxxl_1_1timer.html#af2f69d7d5d9a3dc863da5cf8fda5eea0">reset</a>();
    Timer.<a class="code" href="classstxxl_1_1timer.html#a0ae0e789f391f05c9ad232af88a823ce">start</a>();

    <span class="keywordflow">for</span> (i = 0; i &lt; n_inserts; ++i)
    {
        <span class="comment">//element.first.keybuf[KEYPOS] = letters[VALUE];</span>
        <a class="code" href="berkeley__db__benchmark_8cpp.html#a57ba0fad9060575d3780456eb098df7f">rand_key</a>(i, element.first);
        Map.insert(element);
    }

    Timer.<a class="code" href="classstxxl_1_1timer.html#ae0e47067a50b26bd88dd891f486d6961">stop</a>();

    <a class="code" href="leda__sm__pq__benchmark_8cpp.html#afec876b95f7d6cc4b0f0bd4c0d7d89a0">STXXL_MSG</a>(<span class="stringliteral">&quot;Records in map: &quot;</span> &lt;&lt; Map.size());
    <a class="code" href="leda__sm__pq__benchmark_8cpp.html#afec876b95f7d6cc4b0f0bd4c0d7d89a0">STXXL_MSG</a>(<span class="stringliteral">&quot;Insertions elapsed time: &quot;</span> &lt;&lt; (Timer.<a class="code" href="classstxxl_1_1timer.html#a4321c5541a83782e34b4bfac9b0402a9">mseconds</a>() / 1000.) &lt;&lt;
              <span class="stringliteral">&quot; seconds : &quot;</span> &lt;&lt; (double(n_inserts) / (Timer.<a class="code" href="classstxxl_1_1timer.html#a4321c5541a83782e34b4bfac9b0402a9">mseconds</a>() / 1000.)) &lt;&lt; <span class="stringliteral">&quot; key/data pairs per sec&quot;</span>);

    Map.print_statistics(cout);
    Map.reset_statistics();
    std::cout &lt;&lt; (<a class="code" href="classstxxl_1_1stats__data.html">stxxl::stats_data</a>(*Stats) - stats_begin);
<span class="comment"></span>
<span class="comment">    ////////////////////////////////////</span>
<span class="comment"></span>
    <span class="keyword">const</span> map_type &amp; CMap(Map);     <span class="comment">// const map reference</span>

    Timer.<a class="code" href="classstxxl_1_1timer.html#af2f69d7d5d9a3dc863da5cf8fda5eea0">reset</a>();
    Timer.<a class="code" href="classstxxl_1_1timer.html#a0ae0e789f391f05c9ad232af88a823ce">start</a>();

    <span class="keywordflow">for</span> (i = 0; i &lt; n_locates; ++i)
    {
        <span class="comment">//element.first.keybuf[KEYPOS] = letters[VALUE];</span>
        <a class="code" href="berkeley__db__benchmark_8cpp.html#a57ba0fad9060575d3780456eb098df7f">rand_key</a>(i, element.first);
        CMap.lower_bound(element.first);
    }

    Timer.<a class="code" href="classstxxl_1_1timer.html#ae0e47067a50b26bd88dd891f486d6961">stop</a>();
    <a class="code" href="leda__sm__pq__benchmark_8cpp.html#afec876b95f7d6cc4b0f0bd4c0d7d89a0">STXXL_MSG</a>(<span class="stringliteral">&quot;Locates elapsed time: &quot;</span> &lt;&lt; (Timer.<a class="code" href="classstxxl_1_1timer.html#a4321c5541a83782e34b4bfac9b0402a9">mseconds</a>() / 1000.) &lt;&lt;
              <span class="stringliteral">&quot; seconds : &quot;</span> &lt;&lt; (double(ops) / (Timer.<a class="code" href="classstxxl_1_1timer.html#a4321c5541a83782e34b4bfac9b0402a9">mseconds</a>() / 1000.)) &lt;&lt; <span class="stringliteral">&quot; key/data pairs per sec&quot;</span>);

    Map.print_statistics(cout);
    Map.reset_statistics();
    std::cout &lt;&lt; (<a class="code" href="classstxxl_1_1stats__data.html">stxxl::stats_data</a>(*Stats) - stats_begin);
<span class="comment"></span>
<span class="comment">    ////////////////////////////////////</span>
<span class="comment"></span>
    Map.enable_prefetching();

    stats_begin = <a class="code" href="classstxxl_1_1stats__data.html">stxxl::stats_data</a>(*Stats);
    Timer.<a class="code" href="classstxxl_1_1timer.html#af2f69d7d5d9a3dc863da5cf8fda5eea0">reset</a>();
    Timer.<a class="code" href="classstxxl_1_1timer.html#a0ae0e789f391f05c9ad232af88a823ce">start</a>();

    <a class="code" href="namespacestxxl.html#ad7f9125156ce2d31af5283aa66568f0d">stxxl::int64</a> n_scanned = 0; <span class="comment">//, skipped_qieries = 0;</span>

    <span class="keywordflow">for</span> (i = 0; i &lt; n_range_queries; ++i)
    {
        <span class="comment">//element.first.keybuf[KEYPOS] = letters[VALUE];</span>
        <a class="code" href="berkeley__db__benchmark_8cpp.html#a57ba0fad9060575d3780456eb098df7f">rand_key</a>(i, element.first);
        my_key begin_key = element.first;
        <a class="code" href="classstxxl_1_1btree_1_1btree__const__iterator.html">map_type::const_iterator</a> begin = CMap.lower_bound(element.first);
        <span class="comment">//element.first.keybuf[KEYPOS] = letters[VALUE];</span>
        <a class="code" href="berkeley__db__benchmark_8cpp.html#a57ba0fad9060575d3780456eb098df7f">rand_key</a>(i, element.first);
        <a class="code" href="classstxxl_1_1btree_1_1btree__const__iterator.html">map_type::const_iterator</a> beyond = CMap.lower_bound(element.first);
        <span class="keywordflow">if</span> (element.first &lt; begin_key)
            <a class="code" href="namespacestd.html#abc5bd04888275546472a3a5b813fe030">std::swap</a>(begin, beyond);

        <span class="comment">/*</span>
<span class="comment">           STXXL_MSG(&quot;Looking     &quot;&lt;&lt;element.first&lt;&lt;&quot; scanned: &quot;&lt;&lt;n_scanned);</span>
<span class="comment"></span>
<span class="comment">           if(beyond==CMap.end())</span>
<span class="comment">           {</span>
<span class="comment">                STXXL_MSG(&quot;Upper bound &quot;&lt;&lt;&quot;END&quot;);</span>
<span class="comment">           }</span>
<span class="comment">           else</span>
<span class="comment">           {</span>
<span class="comment">                STXXL_MSG(&quot;Upper bound &quot;&lt;&lt;((element.first&gt;begin_key)?element.first:begin_key));</span>
<span class="comment">           }*/</span>

        <span class="keywordflow">while</span> (begin != beyond)
        {
            ++n_scanned;
            ++begin;
        }

        <span class="keywordflow">if</span> (n_scanned &gt;= <a name="a52"></a><a class="code" href="berkeley__db__benchmark_8cpp.html#a7b0945eaf52f79419e90082b93b3b255">SCAN_LIMIT</a>(n))
        {
            ++i;
            <span class="keywordflow">break</span>;
        }
    }

    n_range_queries = i;

    Timer.<a class="code" href="classstxxl_1_1timer.html#ae0e47067a50b26bd88dd891f486d6961">stop</a>();
    <a class="code" href="leda__sm__pq__benchmark_8cpp.html#afec876b95f7d6cc4b0f0bd4c0d7d89a0">STXXL_MSG</a>(<span class="stringliteral">&quot;Range query elapsed time: &quot;</span> &lt;&lt; (Timer.<a class="code" href="classstxxl_1_1timer.html#a4321c5541a83782e34b4bfac9b0402a9">mseconds</a>() / 1000.) &lt;&lt;
              <span class="stringliteral">&quot; seconds : &quot;</span> &lt;&lt; (double(n_scanned) / (Timer.<a class="code" href="classstxxl_1_1timer.html#a4321c5541a83782e34b4bfac9b0402a9">mseconds</a>() / 1000.)) &lt;&lt;
              <span class="stringliteral">&quot; key/data pairs per sec, #queries &quot;</span> &lt;&lt; n_range_queries &lt;&lt; <span class="stringliteral">&quot; #scanned elements: &quot;</span> &lt;&lt; n_scanned);

    Map.print_statistics(cout);
    Map.reset_statistics();
    std::cout &lt;&lt; (<a class="code" href="classstxxl_1_1stats__data.html">stxxl::stats_data</a>(*Stats) - stats_begin);
<span class="comment"></span>
<span class="comment">    //////////////////////////////////////</span>
<span class="comment"></span>
    ran32State = 0xdeadbeef;
    memset(element.first.keybuf, <span class="charliteral">&#39;a&#39;</span>, KEY_SIZE);
    memset(element.second.databuf, <span class="charliteral">&#39;b&#39;</span>, <a class="code" href="berkeley__db__benchmark_8cpp.html#af55149bc1f05cf18af067a302e31e3f9">DATA_SIZE</a>);

    Map.disable_prefetching();

    stats_begin = <a class="code" href="classstxxl_1_1stats__data.html">stxxl::stats_data</a>(*Stats);
    Timer.<a class="code" href="classstxxl_1_1timer.html#af2f69d7d5d9a3dc863da5cf8fda5eea0">reset</a>();
    Timer.<a class="code" href="classstxxl_1_1timer.html#a0ae0e789f391f05c9ad232af88a823ce">start</a>();

    <span class="keywordflow">for</span> (i = n_deletes; i &gt; 0; --i)
    {
        <span class="comment">//element.first.keybuf[KEYPOS] = letters[VALUE];</span>
        <a class="code" href="berkeley__db__benchmark_8cpp.html#a57ba0fad9060575d3780456eb098df7f">rand_key</a>(i, element.first);
        Map.erase(element.first);
    }

    Timer.<a class="code" href="classstxxl_1_1timer.html#ae0e47067a50b26bd88dd891f486d6961">stop</a>();
    <a class="code" href="leda__sm__pq__benchmark_8cpp.html#afec876b95f7d6cc4b0f0bd4c0d7d89a0">STXXL_MSG</a>(<span class="stringliteral">&quot;Records in map: &quot;</span> &lt;&lt; Map.size());
    <a class="code" href="leda__sm__pq__benchmark_8cpp.html#afec876b95f7d6cc4b0f0bd4c0d7d89a0">STXXL_MSG</a>(<span class="stringliteral">&quot;Erase elapsed time: &quot;</span> &lt;&lt; (Timer.<a class="code" href="classstxxl_1_1timer.html#a4321c5541a83782e34b4bfac9b0402a9">mseconds</a>() / 1000.) &lt;&lt;
              <span class="stringliteral">&quot; seconds : &quot;</span> &lt;&lt; (double(ops) / (Timer.<a class="code" href="classstxxl_1_1timer.html#a4321c5541a83782e34b4bfac9b0402a9">mseconds</a>() / 1000.)) &lt;&lt; <span class="stringliteral">&quot; key/data pairs per sec&quot;</span>);

    Map.print_statistics(cout);
    Map.reset_statistics();
    std::cout &lt;&lt; (<a class="code" href="classstxxl_1_1stats__data.html">stxxl::stats_data</a>(*Stats) - stats_begin);
}
<span class="comment"></span>
<span class="comment">/////////////////////////////////////////////////////////////////////////</span>
<span class="comment"></span>
<span class="keyword">typedef</span> AMI_STREAM&lt;el_t&gt; <a name="a53"></a><a class="code" href="berkeley__db__benchmark_8cpp.html#a047d377ef47eb09c6359526363d1c5bd">stream_t</a>;

<span class="keywordtype">char</span> <a name="a54"></a><a class="code" href="berkeley__db__benchmark_8cpp.html#a2bc054607a1d5d077801e7a89bc1e2e2">dummy</a>;

<span class="keyword">class </span>MyFilter {
<span class="keyword">public</span>:
    <span class="keywordtype">bool</span> operator () (<span class="keyword">const</span> el_t &amp; v)<span class="keyword"> const</span>
<span class="keyword">    </span>{
        dummy += v.key_.keybuf[0];         <span class="comment">// touch element</span>
        <span class="keywordflow">return</span> <span class="keyword">true</span>;
    }
};


<span class="keywordtype">void</span> <a name="a55"></a><a class="code" href="berkeley__db__benchmark_8cpp.html#af66e773714834daa8a07ea5409692742">run_tpie_btree_big</a>(<a class="code" href="namespacestxxl.html#ad7f9125156ce2d31af5283aa66568f0d">stxxl::int64</a> n, <span class="keywordtype">unsigned</span> ops)
{
    el_t element;

    memset(element.key_.keybuf, <span class="charliteral">&#39;a&#39;</span>, KEY_SIZE);
    memset(element.data_.databuf, <span class="charliteral">&#39;b&#39;</span>, <a class="code" href="berkeley__db__benchmark_8cpp.html#af55149bc1f05cf18af067a302e31e3f9">DATA_SIZE</a>);

    <span class="comment">// Log debugging info from the application, but not from the library.</span>
    tpie_log_init(TPIE_LOG_APP_DEBUG);
    MM_manager.set_memory_limit(<a class="code" href="berkeley__db__benchmark_8cpp.html#ae2d095b05f2b520aec97799606d4a23b">TOTAL_CACHE_SIZE</a>);
    MM_manager.enforce_memory_limit();

    stream_t * is = <span class="keyword">new</span> <a class="code" href="berkeley__db__benchmark_8cpp.html#a047d377ef47eb09c6359526363d1c5bd">stream_t</a>;

    <a class="code" href="classstxxl_1_1timer.html">stxxl::timer</a> Timer;
    <a class="code" href="namespacestxxl.html#ad7f9125156ce2d31af5283aa66568f0d">stxxl::int64</a> n_inserts = ops, n_locates = ops, n_range_queries = ops, n_deletes = ops;
    <a class="code" href="namespacestxxl.html#ad7f9125156ce2d31af5283aa66568f0d">stxxl::int64</a> i;
    <span class="comment">//comp_type cmp_;</span>

    ran32State = 0xdeadbeef;

    <span class="comment">//stxxl::random_number32 myrand;</span>

    Timer.<a class="code" href="classstxxl_1_1timer.html#a0ae0e789f391f05c9ad232af88a823ce">start</a>();


    {
        rand_key_gen Gen(n, element.key_);
        <span class="keyword">typedef</span> <a class="code" href="classstxxl_1_1stream_1_1sort.html" title="Produces sorted stream from input stream.">stxxl::stream::sort&lt;rand_key_gen, comp_type&gt;</a> sorter_type;
        sorter_type Sorter(Gen, comp_type(), <a class="code" href="berkeley__db__benchmark_8cpp.html#a19182295057b444dd042949c19c3e581">SORTER_MEM</a>);
        <span class="comment">//typedef key2pair&lt;sorter_type&gt; key2pair_type;</span>
        <span class="comment">//key2pair_type Key2Pair(Sorter);</span>
        <span class="keywordflow">while</span> (!Sorter.empty())
        {
            is-&gt;write_item(*Sorter);
            ++Sorter;
        }
    }

    Timer.<a class="code" href="classstxxl_1_1timer.html#ae0e47067a50b26bd88dd891f486d6961">stop</a>();


    <a class="code" href="leda__sm__pq__benchmark_8cpp.html#afec876b95f7d6cc4b0f0bd4c0d7d89a0">STXXL_MSG</a>(<span class="stringliteral">&quot;Finished sorting input. Elapsed time: &quot;</span> &lt;&lt;
              (Timer.<a class="code" href="classstxxl_1_1timer.html#a4321c5541a83782e34b4bfac9b0402a9">mseconds</a>() / 1000.) &lt;&lt; <span class="stringliteral">&quot; seconds.&quot;</span>);


    Timer.<a class="code" href="classstxxl_1_1timer.html#af2f69d7d5d9a3dc863da5cf8fda5eea0">reset</a>();
    Timer.<a class="code" href="classstxxl_1_1timer.html#a0ae0e789f391f05c9ad232af88a823ce">start</a>();

    <span class="comment">// bulk construction</span>
    u_btree_t * u_btree;
    AMI_btree_params params;
    params.node_block_factor = <a name="a56"></a><a class="code" href="berkeley__db__benchmark_8cpp.html#a6a79b89cd74c19e5fad0114866cfd60f">NODE_BLOCK_SIZE</a> / 4096;
    params.leaf_block_factor = <a class="code" href="berkeley__db__benchmark_8cpp.html#aadc2475e99048c087cbd1584b288c83b">LEAF_BLOCK_SIZE</a> / 4096;
    params.leaf_cache_size = LEAF_CACHE_SIZE / <a class="code" href="berkeley__db__benchmark_8cpp.html#aadc2475e99048c087cbd1584b288c83b">LEAF_BLOCK_SIZE</a>;
    params.node_cache_size = <a class="code" href="berkeley__db__benchmark_8cpp.html#af8c519765cbd6beaaae87f13a2dab316">NODE_CACHE_SIZE</a> / <a class="code" href="berkeley__db__benchmark_8cpp.html#a6a79b89cd74c19e5fad0114866cfd60f">NODE_BLOCK_SIZE</a>;

    u_btree = <span class="keyword">new</span> <a class="code" href="berkeley__db__benchmark_8cpp.html#a6eb9a9d4940e189f690a95cbdbbfdd1a">u_btree_t</a>(params);

    <span class="keyword">using</span> std::cout;
    <span class="keyword">using</span> std::cerr;

    <span class="keywordflow">if</span> (!u_btree-&gt;is_valid()) {
        cerr &lt;&lt; <span class="stringliteral">&quot;Error initializing btree. Aborting.\n&quot;</span>;
        <span class="keyword">delete</span> u_btree;
        exit(1);
    }

    <span class="keywordflow">if</span> (u_btree-&gt;load_sorted(is, 1.0, 1.0) != AMI_ERROR_NO_ERROR)
        cerr &lt;&lt; <span class="stringliteral">&quot;Error during bulk loading.\n&quot;</span>;


    Timer.<a class="code" href="classstxxl_1_1timer.html#ae0e47067a50b26bd88dd891f486d6961">stop</a>();

    <a class="code" href="leda__sm__pq__benchmark_8cpp.html#afec876b95f7d6cc4b0f0bd4c0d7d89a0">STXXL_MSG</a>(<span class="stringliteral">&quot;Records in map: &quot;</span> &lt;&lt; u_btree-&gt;size());
    <a class="code" href="leda__sm__pq__benchmark_8cpp.html#afec876b95f7d6cc4b0f0bd4c0d7d89a0">STXXL_MSG</a>(<span class="stringliteral">&quot;Construction elapsed time: &quot;</span> &lt;&lt; (Timer.<a class="code" href="classstxxl_1_1timer.html#a4321c5541a83782e34b4bfac9b0402a9">mseconds</a>() / 1000.) &lt;&lt;
              <span class="stringliteral">&quot; seconds : &quot;</span> &lt;&lt; (double(n) / (Timer.<a class="code" href="classstxxl_1_1timer.html#a4321c5541a83782e34b4bfac9b0402a9">mseconds</a>() / 1000.)) &lt;&lt; <span class="stringliteral">&quot; key/data pairs per sec&quot;</span>);

<span class="comment"></span>
<span class="comment">    ////////////////////////////////////////</span>
<span class="comment"></span>    Timer.<a class="code" href="classstxxl_1_1timer.html#af2f69d7d5d9a3dc863da5cf8fda5eea0">reset</a>();


    Timer.<a class="code" href="classstxxl_1_1timer.html#a0ae0e789f391f05c9ad232af88a823ce">start</a>();

    <span class="keywordflow">for</span> (i = 0; i &lt; n_inserts; ++i)
    {
        <span class="comment">//element.first.keybuf[KEYPOS] = letters[VALUE];</span>
        <a class="code" href="berkeley__db__benchmark_8cpp.html#a57ba0fad9060575d3780456eb098df7f">rand_key</a>(i, element.key_);
        u_btree-&gt;insert(element);
    }

    Timer.<a class="code" href="classstxxl_1_1timer.html#ae0e47067a50b26bd88dd891f486d6961">stop</a>();

    <a class="code" href="leda__sm__pq__benchmark_8cpp.html#afec876b95f7d6cc4b0f0bd4c0d7d89a0">STXXL_MSG</a>(<span class="stringliteral">&quot;Records in map: &quot;</span> &lt;&lt; u_btree-&gt;size());
    <a class="code" href="leda__sm__pq__benchmark_8cpp.html#afec876b95f7d6cc4b0f0bd4c0d7d89a0">STXXL_MSG</a>(<span class="stringliteral">&quot;Insertions elapsed time: &quot;</span> &lt;&lt; (Timer.<a class="code" href="classstxxl_1_1timer.html#a4321c5541a83782e34b4bfac9b0402a9">mseconds</a>() / 1000.) &lt;&lt;
              <span class="stringliteral">&quot; seconds : &quot;</span> &lt;&lt; (double(n_inserts) / (Timer.<a class="code" href="classstxxl_1_1timer.html#a4321c5541a83782e34b4bfac9b0402a9">mseconds</a>() / 1000.)) &lt;&lt; <span class="stringliteral">&quot; key/data pairs per sec&quot;</span>);

<span class="comment"></span>
<span class="comment">    ////////////////////////////////////////////////</span>
<span class="comment"></span>    Timer.<a class="code" href="classstxxl_1_1timer.html#af2f69d7d5d9a3dc863da5cf8fda5eea0">reset</a>();


    Timer.<a class="code" href="classstxxl_1_1timer.html#a0ae0e789f391f05c9ad232af88a823ce">start</a>();


    el_t result;
    <span class="keywordflow">for</span> (i = 0; i &lt; n_locates; ++i)
    {
        <span class="comment">//element.first.keybuf[KEYPOS] = letters[VALUE];</span>
        <a class="code" href="berkeley__db__benchmark_8cpp.html#a57ba0fad9060575d3780456eb098df7f">rand_key</a>(i, element.key_);
        u_btree-&gt;succ(element.key_, result);
    }

    Timer.<a class="code" href="classstxxl_1_1timer.html#ae0e47067a50b26bd88dd891f486d6961">stop</a>();
    <a class="code" href="leda__sm__pq__benchmark_8cpp.html#afec876b95f7d6cc4b0f0bd4c0d7d89a0">STXXL_MSG</a>(<span class="stringliteral">&quot;Locates elapsed time: &quot;</span> &lt;&lt; (Timer.<a class="code" href="classstxxl_1_1timer.html#a4321c5541a83782e34b4bfac9b0402a9">mseconds</a>() / 1000.) &lt;&lt;
              <span class="stringliteral">&quot; seconds : &quot;</span> &lt;&lt; (double(ops) / (Timer.<a class="code" href="classstxxl_1_1timer.html#a4321c5541a83782e34b4bfac9b0402a9">mseconds</a>() / 1000.)) &lt;&lt; <span class="stringliteral">&quot; key/data pairs per sec&quot;</span>);

<span class="comment"></span>
<span class="comment">    ////////////////////////////////////</span>
<span class="comment"></span>    Timer.<a class="code" href="classstxxl_1_1timer.html#af2f69d7d5d9a3dc863da5cf8fda5eea0">reset</a>();


    Timer.<a class="code" href="classstxxl_1_1timer.html#a0ae0e789f391f05c9ad232af88a823ce">start</a>();

    <a class="code" href="namespacestxxl.html#ad7f9125156ce2d31af5283aa66568f0d">stxxl::int64</a> n_scanned = 0; <span class="comment">//, skipped_qieries = 0;</span>
    MyFilter filter;

    <span class="keywordflow">for</span> (i = 0; i &lt; n_range_queries; ++i)
    {
        <a class="code" href="berkeley__db__benchmark_8cpp.html#a57ba0fad9060575d3780456eb098df7f">rand_key</a>(i, element.key_);
        my_key begin_key = element.key_;
        <a class="code" href="berkeley__db__benchmark_8cpp.html#a57ba0fad9060575d3780456eb098df7f">rand_key</a>(i, element.key_);
        <span class="keywordflow">if</span> (element.key_ &lt; begin_key)
            n_scanned += u_btree-&gt;range_query(element.key_, begin_key, NULL, filter);

        <span class="keywordflow">else</span>
            n_scanned += u_btree-&gt;range_query(begin_key, element.key_, NULL, filter);


        <span class="keywordflow">if</span> (n_scanned &gt;= <a class="code" href="berkeley__db__benchmark_8cpp.html#a7b0945eaf52f79419e90082b93b3b255">SCAN_LIMIT</a>(n))
        {
            ++i;
            <span class="keywordflow">break</span>;
        }
    }

    n_range_queries = i;

    Timer.<a class="code" href="classstxxl_1_1timer.html#ae0e47067a50b26bd88dd891f486d6961">stop</a>();
    <a class="code" href="leda__sm__pq__benchmark_8cpp.html#afec876b95f7d6cc4b0f0bd4c0d7d89a0">STXXL_MSG</a>(<span class="stringliteral">&quot;Range query elapsed time: &quot;</span> &lt;&lt; (Timer.<a class="code" href="classstxxl_1_1timer.html#a4321c5541a83782e34b4bfac9b0402a9">mseconds</a>() / 1000.) &lt;&lt;
              <span class="stringliteral">&quot; seconds : &quot;</span> &lt;&lt; (double(n_scanned) / (Timer.<a class="code" href="classstxxl_1_1timer.html#a4321c5541a83782e34b4bfac9b0402a9">mseconds</a>() / 1000.)) &lt;&lt;
              <span class="stringliteral">&quot; key/data pairs per sec, #queries &quot;</span> &lt;&lt; n_range_queries &lt;&lt; <span class="stringliteral">&quot; #scanned elements: &quot;</span> &lt;&lt; n_scanned);

<span class="comment"></span>
<span class="comment">    //////////////////////////////////////</span>
<span class="comment"></span>    ran32State = 0xdeadbeef;
    memset(element.key_.keybuf, <span class="charliteral">&#39;a&#39;</span>, KEY_SIZE);
    memset(element.data_.databuf, <span class="charliteral">&#39;b&#39;</span>, <a class="code" href="berkeley__db__benchmark_8cpp.html#af55149bc1f05cf18af067a302e31e3f9">DATA_SIZE</a>);

    Timer.<a class="code" href="classstxxl_1_1timer.html#af2f69d7d5d9a3dc863da5cf8fda5eea0">reset</a>();

    Timer.<a class="code" href="classstxxl_1_1timer.html#a0ae0e789f391f05c9ad232af88a823ce">start</a>();

    <span class="keywordflow">for</span> (i = n_deletes; i &gt; 0; --i)
    {
        <span class="comment">//element.first.keybuf[KEYPOS] = letters[VALUE];</span>
        <a class="code" href="berkeley__db__benchmark_8cpp.html#a57ba0fad9060575d3780456eb098df7f">rand_key</a>(i, element.key_);
        u_btree-&gt;erase(element.key_);
    }

    Timer.<a class="code" href="classstxxl_1_1timer.html#ae0e47067a50b26bd88dd891f486d6961">stop</a>();
    <a class="code" href="leda__sm__pq__benchmark_8cpp.html#afec876b95f7d6cc4b0f0bd4c0d7d89a0">STXXL_MSG</a>(<span class="stringliteral">&quot;Records in map: &quot;</span> &lt;&lt; u_btree-&gt;size());
    <a class="code" href="leda__sm__pq__benchmark_8cpp.html#afec876b95f7d6cc4b0f0bd4c0d7d89a0">STXXL_MSG</a>(<span class="stringliteral">&quot;Erase elapsed time: &quot;</span> &lt;&lt; (Timer.<a class="code" href="classstxxl_1_1timer.html#a4321c5541a83782e34b4bfac9b0402a9">mseconds</a>() / 1000.) &lt;&lt;
              <span class="stringliteral">&quot; seconds : &quot;</span> &lt;&lt; (double(ops) / (Timer.<a class="code" href="classstxxl_1_1timer.html#a4321c5541a83782e34b4bfac9b0402a9">mseconds</a>() / 1000.)) &lt;&lt; <span class="stringliteral">&quot; key/data pairs per sec&quot;</span>);
    <span class="keyword">delete</span> u_btree;
    <span class="keyword">delete</span> is;
}

<span class="keywordtype">void</span> <a name="a57"></a><a class="code" href="berkeley__db__benchmark_8cpp.html#abdd4577cdd289ab046d49922eb081c33">run_bdb_btree_big</a>(<a class="code" href="namespacestxxl.html#ad7f9125156ce2d31af5283aa66568f0d">stxxl::int64</a> n, <span class="keywordtype">unsigned</span> ops)
{
    <span class="keyword">const</span> <span class="keywordtype">char</span> * filename = <a class="code" href="berkeley__db__benchmark_8cpp.html#abc0e896081b12a0d0cedcd49e6cf4f1e">BDB_FILE</a>;

    my_key key1_storage;
    my_data data1_storage;

<span class="preprocessor">#ifdef BDB_BULK_SCAN</span>
<span class="preprocessor"></span>    <span class="keywordtype">int</span> * bulk_buffer = <span class="keyword">new</span> <span class="keywordtype">int</span>[<a class="code" href="berkeley__db__benchmark_8cpp.html#a0c18339836c57f015c03739d42020108">logbufsize</a> / <span class="keyword">sizeof</span>(int)];
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
    unlink(filename);

    memset(key1_storage.keybuf, <span class="charliteral">&#39;a&#39;</span>, KEY_SIZE);
    memset(data1_storage.databuf, <span class="charliteral">&#39;b&#39;</span>, <a class="code" href="berkeley__db__benchmark_8cpp.html#af55149bc1f05cf18af067a302e31e3f9">DATA_SIZE</a>);


    Db db(NULL, 0);                   <span class="comment">// Instantiate the Db object</span>

    <span class="keywordflow">try</span> {
        <span class="comment">// here we start with the tests</span>
        Dbt key1(key1_storage.keybuf, KEY_SIZE);
        Dbt data1(data1_storage.databuf, <a class="code" href="berkeley__db__benchmark_8cpp.html#af55149bc1f05cf18af067a302e31e3f9">DATA_SIZE</a>);

        <a class="code" href="classstxxl_1_1timer.html">stxxl::timer</a> Timer;
        <a class="code" href="namespacestxxl.html#ad7f9125156ce2d31af5283aa66568f0d">stxxl::int64</a> n_inserts = ops, n_locates = ops, n_range_queries = ops, n_deletes = ops;
        <a class="code" href="namespacestxxl.html#ad7f9125156ce2d31af5283aa66568f0d">stxxl::int64</a> i;
        <span class="comment">//comp_type cmp_;</span>

        ran32State = 0xdeadbeef;

        Timer.<a class="code" href="classstxxl_1_1timer.html#a0ae0e789f391f05c9ad232af88a823ce">start</a>();

        vector_type SortedSeq(n);
        <span class="comment">//const vector_type &amp; CSortedSeq(SortedSeq);</span>
        {
            rand_key_gen Gen(n, key1_storage);
            <span class="keyword">typedef</span> <a class="code" href="classstxxl_1_1stream_1_1sort.html" title="Produces sorted stream from input stream.">stxxl::stream::sort&lt;rand_key_gen, comp_type&gt;</a> sorter_type;
            sorter_type Sorter(Gen, comp_type(), <a class="code" href="berkeley__db__benchmark_8cpp.html#a19182295057b444dd042949c19c3e581">SORTER_MEM</a>);
            <span class="keyword">typedef</span> key2pair&lt;sorter_type&gt; key2pair_type;
            key2pair_type Key2Pair(Sorter);
            <a class="code" href="group__streampack.html#gaf214a1fc62726c3b8e7fb31aa4bfe20e" title="Stores consecutively stream content to an output iterator.">stxxl::stream::materialize</a>(Key2Pair, SortedSeq.begin());
        }

        Timer.<a class="code" href="classstxxl_1_1timer.html#ae0e47067a50b26bd88dd891f486d6961">stop</a>();

        <a class="code" href="leda__sm__pq__benchmark_8cpp.html#afec876b95f7d6cc4b0f0bd4c0d7d89a0">STXXL_MSG</a>(<span class="stringliteral">&quot;Finished sorting input. Elapsed time: &quot;</span> &lt;&lt; (Timer.<a class="code" href="classstxxl_1_1timer.html#a4321c5541a83782e34b4bfac9b0402a9">mseconds</a>() / 1000.) &lt;&lt; <span class="stringliteral">&quot; seconds.&quot;</span>);

        db.set_errfile(stderr);
        db.set_pagesize(<a class="code" href="berkeley__db__benchmark_8cpp.html#add79a36854fad90cf20ccbeb92e43416">pagesize</a>);
        db.set_cachesize(0, <a class="code" href="berkeley__db__benchmark_8cpp.html#a1af01435dbcacf8dd94c56f0b4bf8bfe">cachesize</a>, 10);

        <a class="code" href="leda__sm__pq__benchmark_8cpp.html#afec876b95f7d6cc4b0f0bd4c0d7d89a0">STXXL_MSG</a>(<span class="stringliteral">&quot;BDB cache size set.&quot;</span>);

        <span class="comment">// Open the database</span>
        db.open(NULL,           <span class="comment">// Transaction pointer</span>
                filename,       <span class="comment">// Database file name</span>
                NULL,           <span class="comment">// Optional logical database name</span>
                DB_BTREE,       <span class="comment">// Database access method</span>
                DB_CREATE,      <span class="comment">// Open flags</span>
                0);             <span class="comment">// File mode (using defaults)</span>

        db.get_env()-&gt;memp_stat(NULL, NULL, DB_STAT_CLEAR);

        Timer.<a class="code" href="classstxxl_1_1timer.html#af2f69d7d5d9a3dc863da5cf8fda5eea0">reset</a>();
        Timer.<a class="code" href="classstxxl_1_1timer.html#a0ae0e789f391f05c9ad232af88a823ce">start</a>();

        <span class="comment">// DBD does not have bulk construction</span>
        <span class="comment">// however inserting in sorted order might help</span>
        <span class="comment">// to improve performance</span>
        <a name="_a58"></a><a class="code" href="classstxxl_1_1const__vector__iterator.html" title="Const external vector iterator, model of ext_random_access_iterator concept.">vector_type::const_iterator</a> cit = SortedSeq.begin();
        <span class="keywordflow">for</span> (i = 0; i &lt; n; ++i, ++cit)
        {
            key1_storage = cit-&gt;first;
            db.put(NULL, &amp;key1, &amp;data1, DB_NOOVERWRITE);
        }

        Timer.<a class="code" href="classstxxl_1_1timer.html#ae0e47067a50b26bd88dd891f486d6961">stop</a>();

        DB_BTREE_STAT * dbstat;
        db.stat(NULL, &amp;dbstat, 0);
        <a class="code" href="leda__sm__pq__benchmark_8cpp.html#afec876b95f7d6cc4b0f0bd4c0d7d89a0">STXXL_MSG</a>(<span class="stringliteral">&quot;Records in map: &quot;</span> &lt;&lt; dbstat-&gt;bt_ndata);
        <a class="code" href="leda__sm__pq__benchmark_8cpp.html#afec876b95f7d6cc4b0f0bd4c0d7d89a0">STXXL_MSG</a>(<span class="stringliteral">&quot;Construction elapsed time: &quot;</span> &lt;&lt; (Timer.<a class="code" href="classstxxl_1_1timer.html#a4321c5541a83782e34b4bfac9b0402a9">mseconds</a>() / 1000.) &lt;&lt;
                  <span class="stringliteral">&quot; seconds : &quot;</span> &lt;&lt; (double(n) / (Timer.<a class="code" href="classstxxl_1_1timer.html#a4321c5541a83782e34b4bfac9b0402a9">mseconds</a>() / 1000.)) &lt;&lt; <span class="stringliteral">&quot; key/data pairs per sec&quot;</span>);

        db.stat_print(0);
        db.get_env()-&gt;memp_stat_print(DB_STAT_CLEAR);<span class="comment"></span>
<span class="comment">        ////////////////////////////////////////</span>
<span class="comment"></span>

        Timer.<a class="code" href="classstxxl_1_1timer.html#af2f69d7d5d9a3dc863da5cf8fda5eea0">reset</a>();
        Timer.<a class="code" href="classstxxl_1_1timer.html#a0ae0e789f391f05c9ad232af88a823ce">start</a>();

        <span class="keywordflow">for</span> (i = 0; i &lt; n_inserts; ++i)
        {
            <span class="comment">//key1_storage.keybuf[KEYPOS] = letters[VALUE];</span>
            <a class="code" href="berkeley__db__benchmark_8cpp.html#a57ba0fad9060575d3780456eb098df7f">rand_key</a>(i, key1_storage);
            db.put(NULL, &amp;key1, &amp;data1, DB_NOOVERWRITE);
        }

        Timer.<a class="code" href="classstxxl_1_1timer.html#ae0e47067a50b26bd88dd891f486d6961">stop</a>();
        db.stat(NULL, &amp;dbstat, 0);
        <a class="code" href="leda__sm__pq__benchmark_8cpp.html#afec876b95f7d6cc4b0f0bd4c0d7d89a0">STXXL_MSG</a>(<span class="stringliteral">&quot;Records in map: &quot;</span> &lt;&lt; dbstat-&gt;bt_ndata);
        <a class="code" href="leda__sm__pq__benchmark_8cpp.html#afec876b95f7d6cc4b0f0bd4c0d7d89a0">STXXL_MSG</a>(<span class="stringliteral">&quot;Insertions elapsed time: &quot;</span> &lt;&lt; (Timer.<a class="code" href="classstxxl_1_1timer.html#a4321c5541a83782e34b4bfac9b0402a9">mseconds</a>() / 1000.) &lt;&lt;
                  <span class="stringliteral">&quot; seconds : &quot;</span> &lt;&lt; (double(n_inserts) / (Timer.<a class="code" href="classstxxl_1_1timer.html#a4321c5541a83782e34b4bfac9b0402a9">mseconds</a>() / 1000.)) &lt;&lt; <span class="stringliteral">&quot; key/data pairs per sec&quot;</span>);

        db.stat_print(0);
        db.get_env()-&gt;memp_stat_print(DB_STAT_CLEAR);
<span class="comment"></span>
<span class="comment">        /////////////////////////////////////////</span>
<span class="comment"></span>        Timer.<a class="code" href="classstxxl_1_1timer.html#af2f69d7d5d9a3dc863da5cf8fda5eea0">reset</a>();
        Timer.<a class="code" href="classstxxl_1_1timer.html#a0ae0e789f391f05c9ad232af88a823ce">start</a>();


        Dbc * cursorp;
        db.cursor(NULL, &amp;cursorp, 0);

        <span class="keywordflow">for</span> (i = 0; i &lt; n_locates; ++i)
        {
            <span class="comment">//key1_storage.keybuf[KEYPOS] = letters[VALUE];</span>
            <a class="code" href="berkeley__db__benchmark_8cpp.html#a57ba0fad9060575d3780456eb098df7f">rand_key</a>(i, key1_storage);
            Dbt keyx(key1_storage.keybuf, KEY_SIZE);
            Dbt datax(data1_storage.databuf, <a class="code" href="berkeley__db__benchmark_8cpp.html#af55149bc1f05cf18af067a302e31e3f9">DATA_SIZE</a>);

            cursorp-&gt;get(&amp;keyx, &amp;datax, DB_SET_RANGE);
        }

        Timer.<a class="code" href="classstxxl_1_1timer.html#ae0e47067a50b26bd88dd891f486d6961">stop</a>();
        <a class="code" href="leda__sm__pq__benchmark_8cpp.html#afec876b95f7d6cc4b0f0bd4c0d7d89a0">STXXL_MSG</a>(<span class="stringliteral">&quot;Locates elapsed time: &quot;</span> &lt;&lt; (Timer.<a class="code" href="classstxxl_1_1timer.html#a4321c5541a83782e34b4bfac9b0402a9">mseconds</a>() / 1000.) &lt;&lt;
                  <span class="stringliteral">&quot; seconds : &quot;</span> &lt;&lt; (double(ops) / (Timer.<a class="code" href="classstxxl_1_1timer.html#a4321c5541a83782e34b4bfac9b0402a9">mseconds</a>() / 1000.)) &lt;&lt; <span class="stringliteral">&quot; key/data pairs per sec&quot;</span>);

        db.stat_print(0);
        db.get_env()-&gt;memp_stat_print(DB_STAT_CLEAR);
<span class="comment"></span>
<span class="comment">        ////////////////////////////////////</span>
<span class="comment"></span>        Timer.<a class="code" href="classstxxl_1_1timer.html#af2f69d7d5d9a3dc863da5cf8fda5eea0">reset</a>();

        Timer.<a class="code" href="classstxxl_1_1timer.html#a0ae0e789f391f05c9ad232af88a823ce">start</a>();

        <a class="code" href="namespacestxxl.html#ad7f9125156ce2d31af5283aa66568f0d">stxxl::int64</a> n_scanned = 0;

        <span class="keywordflow">for</span> (i = 0; i &lt; n_range_queries; ++i)
        {
            <span class="comment">//key1_storage.keybuf[KEYPOS] = letters[VALUE];</span>
            <a class="code" href="berkeley__db__benchmark_8cpp.html#a57ba0fad9060575d3780456eb098df7f">rand_key</a>(i, key1_storage);
            my_key last_key = key1_storage;
            <span class="comment">//key1_storage.keybuf[KEYPOS] = letters[VALUE];</span>
            <a class="code" href="berkeley__db__benchmark_8cpp.html#a57ba0fad9060575d3780456eb098df7f">rand_key</a>(i, key1_storage);
            <span class="keywordflow">if</span> (last_key &lt; key1_storage)
                <a class="code" href="namespacestd.html#abc5bd04888275546472a3a5b813fe030">std::swap</a>(last_key, key1_storage);


            <span class="comment">//STXXL_MSG(&quot;Looking     &quot;&lt;&lt;key1_storage&lt;&lt;&quot; scanned: &quot;&lt;&lt;n_scanned);</span>
            <span class="comment">//STXXL_MSG(&quot;Upper bound &quot;&lt;&lt;last_key);</span>

            Dbt keyx(key1_storage.keybuf, KEY_SIZE);
<span class="preprocessor">#ifdef BDB_BULK_SCAN</span>
<span class="preprocessor"></span>            Dbt datax(bulk_buffer, <a class="code" href="berkeley__db__benchmark_8cpp.html#af55149bc1f05cf18af067a302e31e3f9">DATA_SIZE</a>);
            datax.set_ulen(<a class="code" href="berkeley__db__benchmark_8cpp.html#a0c18339836c57f015c03739d42020108">logbufsize</a>);
            datax.set_flags(DB_DBT_USERMEM);
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>            Dbt datax(data1_storage.databuf, <a class="code" href="berkeley__db__benchmark_8cpp.html#af55149bc1f05cf18af067a302e31e3f9">DATA_SIZE</a>);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>

<span class="preprocessor">#ifdef BDB_BULK_SCAN</span>
<span class="preprocessor"></span>            <span class="keywordflow">if</span> (cursorp-&gt;get(&amp;keyx, &amp;datax, DB_SET_RANGE | DB_MULTIPLE_KEY) == DB_NOTFOUND)
                <span class="keywordflow">continue</span>;


            <span class="keywordflow">do</span>
            {
                DbMultipleKeyDataIterator BulkIterator(datax);
                Dbt key1, data1;
                <span class="keywordflow">while</span> (BulkIterator.next(key1, data1) &amp;&amp;
                       *((my_key *)key1.get_data()) &lt;= last_key)
                {
                    ++n_scanned;
                    <span class="comment">//STXXL_MSG(&quot;Result      &quot;&lt;&lt;*((my_key *)key1.get_data()));</span>
                }
                <span class="keywordflow">if</span> (cursorp-&gt;get(&amp;keyx, &amp;datax, DB_NEXT | DB_MULTIPLE_KEY) == DB_NOTFOUND)
                    <span class="keywordflow">break</span>;


                <span class="keywordflow">if</span> (*((my_key *)keyx.get_data()) &gt; last_key)
                {
                    <span class="keywordflow">break</span>;
                }
            } <span class="keywordflow">while</span> (1);

<span class="preprocessor">#else</span>
<span class="preprocessor"></span>            <span class="keywordflow">if</span> (cursorp-&gt;get(&amp;keyx, &amp;datax, DB_SET_RANGE) == DB_NOTFOUND)
                <span class="keywordflow">continue</span>;

            <span class="keywordflow">while</span> (*((my_key *)keyx.get_data()) &lt;= last_key)
            {
                ++n_scanned;
                <span class="keywordflow">if</span> (cursorp-&gt;get(&amp;keyx, &amp;datax, DB_NEXT) == DB_NOTFOUND)
                    <span class="keywordflow">break</span>;
            }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>

            <span class="keywordflow">if</span> (n_scanned &gt;= <a class="code" href="berkeley__db__benchmark_8cpp.html#a7b0945eaf52f79419e90082b93b3b255">SCAN_LIMIT</a>(n))
            {
                ++i;
                <span class="keywordflow">break</span>;
            }
        }

        n_range_queries = i;

        Timer.<a class="code" href="classstxxl_1_1timer.html#ae0e47067a50b26bd88dd891f486d6961">stop</a>();
        <span class="keywordflow">if</span> (cursorp != NULL)
            cursorp-&gt;close();


        <a class="code" href="leda__sm__pq__benchmark_8cpp.html#afec876b95f7d6cc4b0f0bd4c0d7d89a0">STXXL_MSG</a>(<span class="stringliteral">&quot;Range query elapsed time: &quot;</span> &lt;&lt; (Timer.<a class="code" href="classstxxl_1_1timer.html#a4321c5541a83782e34b4bfac9b0402a9">mseconds</a>() / 1000.) &lt;&lt;
                  <span class="stringliteral">&quot; seconds : &quot;</span> &lt;&lt; (double(n_scanned) / (Timer.<a class="code" href="classstxxl_1_1timer.html#a4321c5541a83782e34b4bfac9b0402a9">mseconds</a>() / 1000.)) &lt;&lt;
                  <span class="stringliteral">&quot; key/data pairs per sec, #queries &quot;</span> &lt;&lt; n_range_queries &lt;&lt; <span class="stringliteral">&quot; #scanned elements: &quot;</span> &lt;&lt; n_scanned);

        db.stat_print(0);
        db.get_env()-&gt;memp_stat_print(DB_STAT_CLEAR);
<span class="comment"></span>
<span class="comment">        //////////////////////////////////////</span>
<span class="comment"></span>
        ran32State = 0xdeadbeef;
        memset(key1_storage.keybuf, <span class="charliteral">&#39;a&#39;</span>, KEY_SIZE);

        Timer.<a class="code" href="classstxxl_1_1timer.html#af2f69d7d5d9a3dc863da5cf8fda5eea0">reset</a>();
        Timer.<a class="code" href="classstxxl_1_1timer.html#a0ae0e789f391f05c9ad232af88a823ce">start</a>();

        <span class="keywordflow">for</span> (i = 0; i &lt; n_deletes; ++i)
        {
            <span class="comment">//key1_storage.keybuf[KEYPOS] = letters[VALUE];</span>
            <a class="code" href="berkeley__db__benchmark_8cpp.html#a57ba0fad9060575d3780456eb098df7f">rand_key</a>(i, key1_storage);
            Dbt keyx(key1_storage.keybuf, KEY_SIZE);
            db.del(NULL, &amp;keyx, 0);
        }

        Timer.<a class="code" href="classstxxl_1_1timer.html#ae0e47067a50b26bd88dd891f486d6961">stop</a>();
        db.stat(NULL, &amp;dbstat, 0);
        <a class="code" href="leda__sm__pq__benchmark_8cpp.html#afec876b95f7d6cc4b0f0bd4c0d7d89a0">STXXL_MSG</a>(<span class="stringliteral">&quot;Records in map: &quot;</span> &lt;&lt; dbstat-&gt;bt_ndata);
        <a class="code" href="leda__sm__pq__benchmark_8cpp.html#afec876b95f7d6cc4b0f0bd4c0d7d89a0">STXXL_MSG</a>(<span class="stringliteral">&quot;Erase elapsed time: &quot;</span> &lt;&lt; (Timer.<a class="code" href="classstxxl_1_1timer.html#a4321c5541a83782e34b4bfac9b0402a9">mseconds</a>() / 1000.) &lt;&lt;
                  <span class="stringliteral">&quot; seconds : &quot;</span> &lt;&lt; (double(ops) / (Timer.<a class="code" href="classstxxl_1_1timer.html#a4321c5541a83782e34b4bfac9b0402a9">mseconds</a>() / 1000.)) &lt;&lt; <span class="stringliteral">&quot; key/data pairs per sec&quot;</span>);

        db.stat_print(0);
        db.get_env()-&gt;memp_stat_print(DB_STAT_CLEAR);

        db.close(0);
    }
    <span class="keywordflow">catch</span> (DbException &amp; e)
    {
        STXXL_ERRMSG(<span class="stringliteral">&quot;DbException happened&quot;</span>);
    }
    <span class="keywordflow">catch</span> (std::exception &amp; e)
    {
        STXXL_ERRMSG(<span class="stringliteral">&quot;std::exception happened&quot;</span>);
    }

    unlink(filename);

<span class="preprocessor">#ifdef BDB_BULK_SCAN</span>
<span class="preprocessor"></span>    <span class="keyword">delete</span>[]  bulk_buffer;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>}


<span class="keywordtype">int</span> <a name="a59"></a><a class="code" href="benchmark__configured__disks_8cpp.html#a0ddf1224851353fc92bfbff6f499fa97">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> * argv[])
{
    <a class="code" href="leda__sm__pq__benchmark_8cpp.html#afec876b95f7d6cc4b0f0bd4c0d7d89a0">STXXL_MSG</a>(<span class="stringliteral">&quot;stxxl::map Real Node block size: &quot;</span> &lt;&lt; <a name="a60"></a><a class="code" href="berkeley__db__benchmark_8cpp.html#aa8e783e8af2ef5572b79c44a66600790">REAL_NODE_BLOCK_SIZE</a> &lt;&lt; <span class="stringliteral">&quot; bytes&quot;</span>);
    <a class="code" href="leda__sm__pq__benchmark_8cpp.html#afec876b95f7d6cc4b0f0bd4c0d7d89a0">STXXL_MSG</a>(<span class="stringliteral">&quot;stxxl::map Real Leaf block size: &quot;</span> &lt;&lt; <a name="a61"></a><a class="code" href="berkeley__db__benchmark_8cpp.html#a1e2ee9048f1a4cbe2e855f36fceeb430">REAL_LEAF_BLOCK_SIZE</a> &lt;&lt; <span class="stringliteral">&quot; bytes&quot;</span>);
    <a class="code" href="leda__sm__pq__benchmark_8cpp.html#afec876b95f7d6cc4b0f0bd4c0d7d89a0">STXXL_MSG</a>(<span class="stringliteral">&quot;stxxl::map Node max elements   : &quot;</span> &lt;&lt; <a name="a62"></a><a class="code" href="berkeley__db__benchmark_8cpp.html#a62304bcc819883f9d62b69dce77adb62">REAL_NODE_MELEMENTS</a>);
    <a class="code" href="leda__sm__pq__benchmark_8cpp.html#afec876b95f7d6cc4b0f0bd4c0d7d89a0">STXXL_MSG</a>(<span class="stringliteral">&quot;stxxl::map Leaf max elements   : &quot;</span> &lt;&lt; <a name="a63"></a><a class="code" href="berkeley__db__benchmark_8cpp.html#adec582409816994dd7b18c88e05c4aa1">REAL_LEAF_MELEMENTS</a>);
<span class="preprocessor">#ifdef STXXL_DIRECT_IO_OFF</span>
<span class="preprocessor"></span>    <a class="code" href="leda__sm__pq__benchmark_8cpp.html#afec876b95f7d6cc4b0f0bd4c0d7d89a0">STXXL_MSG</a>(<span class="stringliteral">&quot;STXXL_DIRECT_IO_OFF is defined&quot;</span>);
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>    <a class="code" href="leda__sm__pq__benchmark_8cpp.html#afec876b95f7d6cc4b0f0bd4c0d7d89a0">STXXL_MSG</a>(<span class="stringliteral">&quot;STXXL_DIRECT_IO_OFF is NOT defined&quot;</span>);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
    <span class="keywordflow">if</span> (argc &lt; 3)
    {
        <a class="code" href="leda__sm__pq__benchmark_8cpp.html#afec876b95f7d6cc4b0f0bd4c0d7d89a0">STXXL_MSG</a>(<span class="stringliteral">&quot;Usage: &quot;</span> &lt;&lt; argv[0] &lt;&lt; <span class="stringliteral">&quot; version #ops&quot;</span>);
        <a class="code" href="leda__sm__pq__benchmark_8cpp.html#afec876b95f7d6cc4b0f0bd4c0d7d89a0">STXXL_MSG</a>(<span class="stringliteral">&quot;\t version = 1: test stxxl map&quot;</span>);
        <a class="code" href="leda__sm__pq__benchmark_8cpp.html#afec876b95f7d6cc4b0f0bd4c0d7d89a0">STXXL_MSG</a>(<span class="stringliteral">&quot;\t version = 2: test Berkeley DB btree&quot;</span>);
        <a class="code" href="leda__sm__pq__benchmark_8cpp.html#afec876b95f7d6cc4b0f0bd4c0d7d89a0">STXXL_MSG</a>(<span class="stringliteral">&quot;\t version = 3: big test stxxl map&quot;</span>);
        <a class="code" href="leda__sm__pq__benchmark_8cpp.html#afec876b95f7d6cc4b0f0bd4c0d7d89a0">STXXL_MSG</a>(<span class="stringliteral">&quot;\t version = 4: big test Berkeley DB btree&quot;</span>);
        <a class="code" href="leda__sm__pq__benchmark_8cpp.html#afec876b95f7d6cc4b0f0bd4c0d7d89a0">STXXL_MSG</a>(<span class="stringliteral">&quot;\t version = 5: big test TPIE btree&quot;</span>);
        <span class="keywordflow">return</span> -1;
    }

    <a class="code" href="berkeley__db__benchmark_8cpp.html#a02fd73d861ef2e4aabb38c0c9ff82947">init</a>();

    <span class="keywordtype">int</span> version = atoi(argv[1]);
    <a class="code" href="namespacestxxl.html#ad7f9125156ce2d31af5283aa66568f0d">stxxl::int64</a> ops = <a name="a64"></a><a class="code" href="namespacestxxl.html#a2aad61808bb84e1a0ab0ab32fc096e91">stxxl::atoint64</a>(argv[2]);

    <a class="code" href="leda__sm__pq__benchmark_8cpp.html#afec876b95f7d6cc4b0f0bd4c0d7d89a0">STXXL_MSG</a>(<span class="stringliteral">&quot;Running version      : &quot;</span> &lt;&lt; version);
    <a class="code" href="leda__sm__pq__benchmark_8cpp.html#afec876b95f7d6cc4b0f0bd4c0d7d89a0">STXXL_MSG</a>(<span class="stringliteral">&quot;Operations to perform: &quot;</span> &lt;&lt; ops);
    <a class="code" href="leda__sm__pq__benchmark_8cpp.html#afec876b95f7d6cc4b0f0bd4c0d7d89a0">STXXL_MSG</a>(<span class="stringliteral">&quot;Btree cache size     : &quot;</span> &lt;&lt; <a class="code" href="berkeley__db__benchmark_8cpp.html#ae2d095b05f2b520aec97799606d4a23b">TOTAL_CACHE_SIZE</a> &lt;&lt; <span class="stringliteral">&quot; bytes&quot;</span>);
    <a class="code" href="leda__sm__pq__benchmark_8cpp.html#afec876b95f7d6cc4b0f0bd4c0d7d89a0">STXXL_MSG</a>(<span class="stringliteral">&quot;Leaf block size      : &quot;</span> &lt;&lt; <a class="code" href="berkeley__db__benchmark_8cpp.html#aadc2475e99048c087cbd1584b288c83b">LEAF_BLOCK_SIZE</a> &lt;&lt; <span class="stringliteral">&quot; bytes&quot;</span>);


    <span class="keywordflow">switch</span> (version)
    {
    <span class="keywordflow">case</span> 1:
        <a class="code" href="berkeley__db__benchmark_8cpp.html#ac744e2997e640dfc51d923d2d5b1ad08">run_stxxl_map</a>(ops);
        <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> 2:
        <a class="code" href="berkeley__db__benchmark_8cpp.html#a36b2540fbc0169406a90764a334036cf">run_bdb_btree</a>(ops);
        <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> 3:
        <a class="code" href="berkeley__db__benchmark_8cpp.html#a631284bbd107ea5a5a598e5433e8ab30">run_stxxl_map_big</a>(ops, 100000);
        <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> 4:
        <a class="code" href="berkeley__db__benchmark_8cpp.html#abdd4577cdd289ab046d49922eb081c33">run_bdb_btree_big</a>(ops, 100000);
        <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> 5:
        <a class="code" href="berkeley__db__benchmark_8cpp.html#af66e773714834daa8a07ea5409692742">run_tpie_btree_big</a>(ops, 100000);
        <span class="keywordflow">break</span>;
    <span class="keywordflow">default</span>:
        <a class="code" href="leda__sm__pq__benchmark_8cpp.html#afec876b95f7d6cc4b0f0bd4c0d7d89a0">STXXL_MSG</a>(<span class="stringliteral">&quot;Unsupported version &quot;</span> &lt;&lt; version);
    }
}
</pre></div> </div><!-- contents -->
</div><!-- contents -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>



<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
