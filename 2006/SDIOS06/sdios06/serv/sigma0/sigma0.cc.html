<?xml version="1.0" encoding="iso-8859-1"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta content="text/html; charset=iso-8859-1" http-equiv="content-type" /><meta name="viewport" content="initial-scale=1"><title>/2006/SDIOS06/sdios06/serv/sigma0/sigma0.cc - panthema.net</title><link rel="stylesheet" type="text/css" href="/css/base.css" /><link rel="stylesheet" type="text/css" href="/css/fonts.css" /><link rel="alternate" type="application/rss+xml" title="panthema.net Weblog Feed RSS 2.0" href="https://panthema.net/xmlfeed/weblog-rss20.xml" /><link rel="alternate" type="application/atom+xml" title="panthema.net Weblog Feed Atom 1.0" href="https://panthema.net/xmlfeed/weblog-atom10.xml" /><script type="text/javascript" src="/js/base.js"></script><script type="text/javascript">/* <!-- */makeIEHover = function() {var lis = document.getElementById('ptnav').getElementsByTagName('li');for (var i = 0; i < lis.length; i++) {lis[i].onmouseover = function() {this.className += ' sfhover';};lis[i].onmouseout = function() {this.className = this.className.replace(new RegExp(' sfhover\b'), '');};}};if (window.attachEvent) window.attachEvent('onload', makeIEHover);/* --> */</script></head><body lang="en"><div class="pttopbar"><div style="float: right"><ul id="ptnav"><li class="top"><a class="ni" href="/timeline/"><i class="icon-book"></i> Weblog</a><ul style="margin-left: -6px; margin-top: 4px" class="nx"><li><a href="/2020/">2020</a></li><li><a href="/2019/">2019</a></li><li><a href="/2018/">2018</a></li><li><a href="/2017/">2017</a></li><li><a href="/2016/">2016</a></li><li><a href="/2015/">2015</a></li><li><a href="/2014/">2014</a></li><li><a href="/2013/">2013</a></li><li><a href="/2012/">2012</a></li><li><a href="/2011/">2011</a></li><li><a href="/2010/">2010</a></li><li><a href="/2009/">2009</a></li><li><a href="/2008/">2008</a></li><li><a href="/2007/">2007</a></li><li><a href="/2006/">2006</a></li><li class="nt"><a href="/2005/">2005</a></li><li class="ns"><a href="/xmlfeed/weblog-rss20.xml">RSS Feed</a></li><li class="nt"><a href="/xmlfeed/weblog-atom10.xml">XML Atom</a></li></ul></li><li class="top"> <a class="ni" href="/tags/"><i class="icon-tags"></i> Tags</a></li><li class="top"> <a class="ni" href="#"><i class="icon-cubes"></i> Projects</a> <ul style="margin-left: -8em; margin-top: 4px;" class="nx"> <li><a href="/2019/1008-COBS-A-Compact-Bit-Sliced-Signature-Index/">COBS</a></li> <li><a href="/2009/cryptote/">CryptoTE</a></li> <li><a href="/2009/digup/">digup</a></li> <li><a href="/2013/disk-filltest/">disk-filltest</a></li> <li><a href="/2012/1119-eSAIS-Inducing-Suffix-and-LCP-Arrays-in-External-Memory/">eSAIS-LCP</a></li> <li><a href="/2007/flex-bison-cpp-example/">Flex Bison C++ Example</a></li> <li><a href="/2013/malloc_count/">malloc_count</a></li> <li><a href="/2016/0114-diploma-thesis/">On Bispanning Graphs</a></li> <li><a href="/2013/pmbw/">Parallel Memory Bandwidth</a></li> <li><a href="/2013/parallel-string-sorting/">Parallel String Sorting</a></li> <li><a href="/2014/sqlplot-tools/">SqlPlotTools</a></li> <li><a href="/2013/sound-of-sorting/">The Sound of Sorting</a></li> <li><a href="/2007/stx-btree/">STX B+ Tree</a></li> <li><a href="/2010/stx-cbtreedb/">STX Constant BTreeDB</a></li> <li><a href="/2010/stx-execpipe/">STX ExecPipe</a></li> <li><a href="/2007/stx-exparser/">STX Expression Parser</a></li> <li><a href="/tags/stxxl.html">STXXL 1.4</a></li> <li><a href="/tags/thrill.html">Thrill - Big Data Framework</a></li> <li class="nt"><a href="/2014/vncrec-rgb/">VNCrec RGB 0.4</a></li> </ul></li><li class="top"> <a class="ni" href="/publications.html"><i class="icon-graduation-cap"></i> Publications</a></li><li class="top"> <a class="ni" href="/search.html"><i class="icon-search"></i> Search</a></li><li class="top"> <a class="ni" href="/subscribe.html"><i class="icon-rss-squared"></i> Subscribe</a></li><li class="top"> <a class="ni" href="/about/"><i class="icon-info-circled"></i> About</a></li></ul></div><div style="padding: 6px"><a href="/">panthema</a>  / <a href="/2006/">2006</a> / <a href="/2006/SDIOS06/">SDIOS06</a> / <a href="/2006/SDIOS06/sdios06/">sdios06</a> / <a href="/2006/SDIOS06/sdios06/serv/">serv</a> / <a href="/2006/SDIOS06/sdios06/serv/sigma0/">sigma0</a> / <a href="/2006/SDIOS06/sdios06/serv/sigma0/sigma0.cc.html">sigma0.cc</a> (<a href="/2006/SDIOS06/sdios06/serv/sigma0/sigma0.cc">Download File</a>)</div></div><div class="ptfullwidth"><pre class="codesnippet" style="font-family: monospace"><tt><span class="comment">/*********************************************************************</span>
<span class="comment"> *                </span>
<span class="comment"> * Copyright (C) 2001-2004,  Karlsruhe University</span>
<span class="comment"> *                </span>
<span class="comment"> * File path:     sigma0.cc</span>
<span class="comment"> * Description:   sigma0 implementation</span>
<span class="comment"> *                </span>
<span class="comment"> * Redistribution and use in source and binary forms, with or without</span>
<span class="comment"> * modification, are permitted provided that the following conditions</span>
<span class="comment"> * are met:</span>
<span class="comment"> * 1. Redistributions of source code must retain the above copyright</span>
<span class="comment"> *    notice, this list of conditions and the following disclaimer.</span>
<span class="comment"> * 2. Redistributions in binary form must reproduce the above copyright</span>
<span class="comment"> *    notice, this list of conditions and the following disclaimer in the</span>
<span class="comment"> *    documentation and/or other materials provided with the distribution.</span>
<span class="comment"> * </span>
<span class="comment"> * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND</span>
<span class="comment"> * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
<span class="comment"> * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
<span class="comment"> * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE</span>
<span class="comment"> * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</span>
<span class="comment"> * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS</span>
<span class="comment"> * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)</span>
<span class="comment"> * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT</span>
<span class="comment"> * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY</span>
<span class="comment"> * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF</span>
<span class="comment"> * SUCH DAMAGE.</span>
<span class="comment"> *                </span>
<span class="comment"> * $Id: sigma0.cc,v 1.18.2.10 2004/03/02 21:52:11 skoglund Exp $</span>
<span class="comment"> *                </span>
<span class="comment"> ********************************************************************/</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">&lt;l4/kip.h&gt;</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">&lt;l4/ipc.h&gt;</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">&lt;l4/misc.h&gt;</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">&lt;l4/kdebug.h&gt;</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">&lt;l4io.h&gt;</span>

<span class="comment">//#define OLD_STYLE_MEMORY_REGIONS</span>

<span class="preproc">#ifndef</span><span class="normal"> NULL</span>
<span class="preproc">#define</span><span class="normal"> </span><span class="function">NULL</span><span class="normal"> </span><span class="symbol">((</span><span class="type">void</span><span class="normal"> </span><span class="symbol">*)</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="preproc">#endif</span>



<span class="comment">/**</span>
<span class="comment"> * Verbose level for sigma0 output.</span>
<span class="comment"> */</span>
<span class="type">int</span><span class="normal"> verbose </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>


<span class="comment">/**</span>
<span class="comment"> * Pointer to sigma0's kernel interface page.</span>
<span class="comment"> */</span>
<span class="normal">L4_KernelInterfacePage_t </span><span class="symbol">*</span><span class="normal"> kip</span><span class="symbol">;</span>


<span class="comment">/**</span>
<span class="comment"> * Minimum page size (log2) supported by architecture/kernel</span>
<span class="comment"> * (initialized from kernel interface page).</span>
<span class="comment"> */</span>
<span class="usertype">L4_Word_t</span><span class="normal"> min_pgsize </span><span class="symbol">=</span><span class="normal"> </span><span class="number">10</span><span class="symbol">;</span>


<span class="comment">/**</span>
<span class="comment"> * Helpers for rounding pages up and down according to min_pgsize</span>
<span class="comment"> */</span>
<span class="usertype">L4_INLINE</span><span class="normal"> </span><span class="usertype">L4_Word_t</span><span class="normal"> </span><span class="function">page_start</span><span class="normal"> </span><span class="symbol">(</span><span class="usertype">L4_Word_t</span><span class="normal"> page</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> page </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="symbol">~((</span><span class="normal">1UL </span><span class="symbol">&lt;&lt;</span><span class="normal"> min_pgsize</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="usertype">L4_INLINE</span><span class="normal"> </span><span class="usertype">L4_Word_t</span><span class="normal"> </span><span class="function">page_end</span><span class="normal"> </span><span class="symbol">(</span><span class="usertype">L4_Word_t</span><span class="normal"> page</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">page </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">1UL </span><span class="symbol">&lt;&lt;</span><span class="normal"> min_pgsize</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="symbol">~((</span><span class="normal">1UL </span><span class="symbol">&lt;&lt;</span><span class="normal"> min_pgsize</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="comment">/*</span>
<span class="comment"> * Some API defined thread IDs.</span>
<span class="comment"> */</span>
<span class="usertype">L4_ThreadId_t</span><span class="normal"> kernel_id</span><span class="symbol">;</span><span class="normal">	</span><span class="comment">// Lowes possible system thread</span>
<span class="usertype">L4_ThreadId_t</span><span class="normal"> sigma0_id</span><span class="symbol">;</span>
<span class="usertype">L4_ThreadId_t</span><span class="normal"> sigma1_id</span><span class="symbol">;</span>
<span class="usertype">L4_ThreadId_t</span><span class="normal"> rootserver_id</span><span class="symbol">;</span>


<span class="type">void</span><span class="normal"> </span><span class="function">init_mempool</span><span class="normal"> </span><span class="symbol">(</span><span class="type">void</span><span class="symbol">);</span>
<span class="type">void</span><span class="normal"> </span><span class="function">dump_mempools</span><span class="normal"> </span><span class="symbol">(</span><span class="type">void</span><span class="symbol">);</span>
<span class="type">bool</span><span class="normal"> </span><span class="function">allocate_page</span><span class="normal"> </span><span class="symbol">(</span><span class="usertype">L4_ThreadId_t</span><span class="normal"> tid</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">L4_Word_t</span><span class="normal"> addr</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">L4_Word_t</span><span class="normal"> log2size</span><span class="symbol">,</span>
<span class="normal">		    L4_MapItem_t </span><span class="symbol">&amp;</span><span class="normal"> map</span><span class="symbol">,</span><span class="normal"> </span><span class="type">bool</span><span class="normal"> only_conventional </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">);</span>
<span class="type">bool</span><span class="normal"> </span><span class="function">allocate_page</span><span class="normal"> </span><span class="symbol">(</span><span class="usertype">L4_ThreadId_t</span><span class="normal"> tid</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">L4_Word_t</span><span class="normal"> log2size</span><span class="symbol">,</span><span class="normal"> L4_MapItem_t </span><span class="symbol">&amp;</span><span class="normal"> map</span><span class="symbol">);</span>


<span class="keyword">extern</span><span class="normal"> </span><span class="string">"C"</span><span class="normal"> </span><span class="function">__attribute__</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">weak</span><span class="symbol">))</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="symbol">*</span>
<span class="function">memcpy</span><span class="normal"> </span><span class="symbol">(</span><span class="type">void</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> dst</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> src</span><span class="symbol">,</span><span class="normal"> </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> len</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">d </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*)</span><span class="normal"> dst</span><span class="symbol">;</span>
<span class="normal">    </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">s </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*)</span><span class="normal"> src</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">len</span><span class="symbol">--</span><span class="normal"> </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">	</span><span class="symbol">*</span><span class="normal">d</span><span class="symbol">++</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">s</span><span class="symbol">++;</span>

<span class="normal">    </span><span class="keyword">return</span><span class="normal"> dst</span><span class="symbol">;</span>
<span class="cbracket">}</span>


<span class="comment">/*</span>
<span class="comment"> * Encoding for label field of message tag.</span>
<span class="comment"> */</span>
<span class="preproc">#define</span><span class="normal"> </span><span class="function">L4_REQUEST_MASK</span><span class="normal">		</span><span class="symbol">(</span><span class="normal"> </span><span class="symbol">~((~</span><span class="normal">0UL</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="symbol">((</span><span class="keyword">sizeof</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">L4_Word_t</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="number">20</span><span class="symbol">)))</span>
<span class="preproc">#define</span><span class="normal"> </span><span class="function">L4_PAGEFAULT</span><span class="normal">		</span><span class="symbol">(-</span><span class="normal">2UL </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">20</span><span class="symbol">)</span>
<span class="preproc">#define</span><span class="normal"> </span><span class="function">L4_SIGMA0_RPC</span><span class="normal">		</span><span class="symbol">(-</span><span class="normal">6UL </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">20</span><span class="symbol">)</span>
<span class="preproc">#define</span><span class="normal"> </span><span class="function">L4_SIGMA0_EXT</span><span class="normal">		</span><span class="symbol">(-</span><span class="normal">1001UL </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">20</span><span class="symbol">)</span>


<span class="comment">/*</span>
<span class="comment"> * Encoding for MR1 of extended sigma0 protocol.</span>
<span class="comment"> */</span>
<span class="preproc">#define</span><span class="normal"> </span><span class="function">L4_S0EXT_VERBOSE</span><span class="normal">	</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">)</span>
<span class="preproc">#define</span><span class="normal"> </span><span class="function">L4_s0EXT_DUMPMEM</span><span class="normal">	</span><span class="symbol">(</span><span class="number">2</span><span class="symbol">)</span>


<span class="comment">/**</span>
<span class="comment"> * Check if thread is a kernel thread.</span>
<span class="comment"> * </span><span class="type">@param</span><span class="comment"> t	thread id to check</span>
<span class="comment"> * </span><span class="type">@return</span><span class="comment"> true if thread is a kernel thread, false otherwise</span>
<span class="comment"> */</span>
<span class="type">bool</span><span class="normal"> </span><span class="function">is_kernel_thread</span><span class="normal"> </span><span class="symbol">(</span><span class="usertype">L4_ThreadId_t</span><span class="normal"> t</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">t</span><span class="symbol">.</span><span class="normal">raw </span><span class="symbol">&lt;</span><span class="normal"> sigma0_id</span><span class="symbol">.</span><span class="normal">raw</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">t</span><span class="symbol">.</span><span class="normal">raw </span><span class="symbol">&gt;=</span><span class="normal"> kernel_id</span><span class="symbol">.</span><span class="normal">raw</span><span class="symbol">);</span>
<span class="cbracket">}</span>


<span class="comment">/**</span>
<span class="comment"> * Do printout if indicated verboseness exceeds or equals current</span>
<span class="comment"> * verbose level.</span>
<span class="comment"> *</span>
<span class="comment"> * </span><span class="type">@param</span><span class="comment"> v		verbose level to match</span>
<span class="comment"> * </span><span class="type">@param</span><span class="comment"> args...	arguments passed on to l4_printf()</span>
<span class="comment"> */</span>
<span class="preproc">#define</span><span class="normal"> </span><span class="function">dprintf</span><span class="symbol">(</span><span class="normal">v</span><span class="symbol">,</span><span class="normal"> args</span><span class="symbol">...)</span><span class="normal">	</span><span class="keyword">do</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">verbose </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">v</span><span class="symbol">))</span><span class="normal"> </span><span class="function">l4_printf</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">args</span><span class="symbol">);</span><span class="normal"> </span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">while</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">)</span>



<span class="comment">/**</span>
<span class="comment"> * Main sigma0 loop.</span>
<span class="comment"> */</span>
<span class="keyword">extern</span><span class="normal"> </span><span class="string">"C"</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="function">sigma0_main</span><span class="normal"> </span><span class="symbol">(</span><span class="type">void</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="usertype">L4_Word_t</span><span class="normal"> api_version</span><span class="symbol">,</span><span class="normal"> api_flags</span><span class="symbol">,</span><span class="normal"> kernelid</span><span class="symbol">;</span>
<span class="normal">    </span><span class="usertype">L4_MsgTag_t</span><span class="normal"> tag</span><span class="symbol">;</span>

<span class="normal">    </span><span class="function">dprintf</span><span class="normal"> </span><span class="symbol">(</span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"s0: This is Sigma0</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>

<span class="normal">    </span><span class="comment">// Get kernel interface page.</span>
<span class="normal">    kip </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">L4_KernelInterfacePage_t </span><span class="symbol">*)</span>
<span class="normal">	</span><span class="function">L4_KernelInterface</span><span class="normal"> </span><span class="symbol">(&amp;</span><span class="normal">api_version</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">api_flags</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">kernelid</span><span class="symbol">);</span>

<span class="normal">    </span><span class="function">dprintf</span><span class="normal"> </span><span class="symbol">(</span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"s0: KIP @ %p (0x%lx, 0x%lx, 0x%lx)</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> </span>
<span class="normal">	     kip</span><span class="symbol">,</span><span class="normal"> api_version</span><span class="symbol">,</span><span class="normal"> api_flags</span><span class="symbol">,</span><span class="normal"> kernelid</span><span class="symbol">);</span>

<span class="normal">    </span><span class="comment">// Calculate API defined thread IDs.</span>
<span class="normal">    kernel_id </span><span class="symbol">=</span><span class="normal"> </span><span class="function">L4_GlobalId</span><span class="normal"> </span><span class="symbol">(</span><span class="function">L4_ThreadIdSystemBase</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">kip</span><span class="symbol">),</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">    sigma0_id </span><span class="symbol">=</span><span class="normal"> </span><span class="function">L4_GlobalId</span><span class="normal"> </span><span class="symbol">(</span><span class="function">L4_ThreadIdUserBase</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">kip</span><span class="symbol">),</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">    sigma1_id </span><span class="symbol">=</span><span class="normal"> </span><span class="function">L4_GlobalId</span><span class="normal"> </span><span class="symbol">(</span><span class="function">L4_ThreadIdUserBase</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">kip</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">    rootserver_id </span><span class="symbol">=</span><span class="normal"> </span><span class="function">L4_GlobalId</span><span class="normal"> </span><span class="symbol">(</span><span class="function">L4_ThreadIdUserBase</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">kip</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="number">2</span><span class="symbol">,</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>

<span class="normal">    </span><span class="function">init_mempool</span><span class="normal"> </span><span class="symbol">();</span>

<span class="normal">    </span><span class="usertype">L4_ThreadId_t</span><span class="normal"> tid</span><span class="symbol">;</span>
<span class="normal">    </span><span class="function">L4_Accept</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">L4_UntypedWordsAcceptor</span><span class="symbol">);</span>

<span class="normal">    tag </span><span class="symbol">=</span><span class="normal"> </span><span class="function">L4_Wait</span><span class="normal"> </span><span class="symbol">(&amp;</span><span class="normal">tid</span><span class="symbol">);</span>

<span class="normal">    </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(;;)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="usertype">L4_Msg_t</span><span class="normal"> msg</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">L4_MapItem_t</span><span class="normal"> map</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">L4_Fpage_t</span><span class="normal"> fpage</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">L4_UntypedWords</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">tag</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">2</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> </span><span class="function">L4_TypedWords</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">tag</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="function">dprintf</span><span class="normal"> </span><span class="symbol">(</span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"s0: malformed request from %p (tag=%p)</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> </span>
<span class="normal">		     </span><span class="symbol">(</span><span class="type">void</span><span class="normal"> </span><span class="symbol">*)</span><span class="normal"> tid</span><span class="symbol">.</span><span class="normal">raw</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">(</span><span class="type">void</span><span class="normal"> </span><span class="symbol">*)</span><span class="normal"> tag</span><span class="symbol">.</span><span class="normal">raw</span><span class="symbol">);</span>
<span class="normal">	    </span><span class="function">L4_KDB_Enter</span><span class="normal"> </span><span class="symbol">(</span><span class="string">"s0: malformed request"</span><span class="symbol">);</span>
<span class="normal">	    tag </span><span class="symbol">=</span><span class="normal"> </span><span class="function">L4_Wait</span><span class="normal"> </span><span class="symbol">(&amp;</span><span class="normal">tid</span><span class="symbol">);</span>
<span class="normal">	    </span><span class="keyword">continue</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span>
<span class="normal">	</span><span class="function">L4_Store</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">tag</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">msg</span><span class="symbol">);</span>

<span class="normal">	</span><span class="function">dprintf</span><span class="normal"> </span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"s0: got msg from %p, (0x%lx, %p, %p)</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> </span>
<span class="normal">		 </span><span class="symbol">(</span><span class="type">void</span><span class="normal"> </span><span class="symbol">*)</span><span class="normal"> tid</span><span class="symbol">.</span><span class="normal">raw</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">(</span><span class="type">long</span><span class="symbol">)</span><span class="normal"> </span><span class="function">L4_Label</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">tag</span><span class="symbol">),</span>
<span class="normal">		 </span><span class="symbol">(</span><span class="type">void</span><span class="normal"> </span><span class="symbol">*)</span><span class="normal"> </span><span class="function">L4_Get</span><span class="normal"> </span><span class="symbol">(&amp;</span><span class="normal">msg</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">),</span><span class="normal"> </span><span class="symbol">(</span><span class="type">void</span><span class="normal"> </span><span class="symbol">*)</span><span class="normal"> </span><span class="function">L4_Get</span><span class="normal"> </span><span class="symbol">(&amp;</span><span class="normal">msg</span><span class="symbol">,</span><span class="normal"> </span><span class="number">1</span><span class="symbol">));</span>

<span class="normal">	</span><span class="comment">/*</span>
<span class="comment">	 * Dispatch IPC according to protocol.</span>
<span class="comment">	 */</span>

<span class="normal">	</span><span class="keyword">switch</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">tag</span><span class="symbol">.</span><span class="normal">raw </span><span class="symbol">&amp;</span><span class="normal"> L4_REQUEST_MASK</span><span class="symbol">)</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> L4_PAGEFAULT</span><span class="symbol">:</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal"> </span><span class="function">allocate_page</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">tid</span><span class="symbol">,</span><span class="normal"> </span><span class="function">L4_Get</span><span class="normal"> </span><span class="symbol">(&amp;</span><span class="normal">msg</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">),</span><span class="normal"> min_pgsize</span><span class="symbol">,</span><span class="normal"> map</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">))</span>
<span class="normal">		</span><span class="function">dprintf</span><span class="normal"> </span><span class="symbol">(</span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"s0: unhandled pagefault from %p @ %p, ip: %p</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">			 </span><span class="symbol">(</span><span class="type">void</span><span class="normal"> </span><span class="symbol">*)</span><span class="normal"> tid</span><span class="symbol">.</span><span class="normal">raw</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">(</span><span class="type">void</span><span class="normal"> </span><span class="symbol">*)</span><span class="normal"> </span><span class="function">L4_Get</span><span class="normal"> </span><span class="symbol">(&amp;</span><span class="normal">msg</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">),</span>
<span class="normal">			 </span><span class="symbol">(</span><span class="type">void</span><span class="normal"> </span><span class="symbol">*)</span><span class="normal"> </span><span class="function">L4_Get</span><span class="normal"> </span><span class="symbol">(&amp;</span><span class="normal">msg</span><span class="symbol">,</span><span class="normal"> </span><span class="number">1</span><span class="symbol">));</span>
<span class="normal">	    </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> L4_SIGMA0_RPC</span><span class="symbol">:</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    fpage</span><span class="symbol">.</span><span class="normal">raw </span><span class="symbol">=</span><span class="normal"> </span><span class="function">L4_Get</span><span class="normal"> </span><span class="symbol">(&amp;</span><span class="normal">msg</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">);</span>
<span class="normal">	    </span><span class="usertype">L4_Word_t</span><span class="normal"> addr </span><span class="symbol">=</span><span class="normal"> </span><span class="function">L4_Address</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">fpage</span><span class="symbol">);</span>
<span class="normal">	    </span><span class="usertype">L4_Word_t</span><span class="normal"> attributes </span><span class="symbol">=</span><span class="normal"> </span><span class="function">L4_Get</span><span class="normal"> </span><span class="symbol">(&amp;</span><span class="normal">msg</span><span class="symbol">,</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>

<span class="normal">	    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">is_kernel_thread</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">tid</span><span class="symbol">))</span>
<span class="normal">	    </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">L4_Size</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">fpage</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">		    </span><span class="comment">// Request recomended kernel memory.</span>
<span class="normal">		    </span><span class="function">L4_KDB_Enter</span><span class="normal"> </span><span class="symbol">(</span><span class="string">"s0: recomended kernel mem"</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">else</span>
<span class="normal">		    </span><span class="comment">// Request kernel memory.</span>
<span class="normal">		    </span><span class="function">L4_KDB_Enter</span><span class="normal"> </span><span class="symbol">(</span><span class="string">"s0: request kernel memory"</span><span class="symbol">);</span>

<span class="normal">		tag </span><span class="symbol">=</span><span class="normal"> </span><span class="function">L4_Wait</span><span class="normal"> </span><span class="symbol">(&amp;</span><span class="normal">tid</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">continue</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	    </span><span class="keyword">else</span>
<span class="normal">	    </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">fpage</span><span class="symbol">.</span><span class="normal">raw </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">10</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="symbol">(~</span><span class="normal">0UL </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">10</span><span class="symbol">))</span>
<span class="normal">		</span><span class="cbracket">{</span>
<span class="normal">		    </span><span class="comment">// Allocate from arbitrary location.</span>
<span class="normal">		    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal"> </span><span class="function">allocate_page</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">tid</span><span class="symbol">,</span><span class="normal"> </span><span class="function">L4_SizeLog2</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">fpage</span><span class="symbol">),</span><span class="normal"> map</span><span class="symbol">))</span>
<span class="normal">			</span><span class="function">dprintf</span><span class="normal"> </span><span class="symbol">(</span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"s0: unable to allocate page of size %p"</span>
<span class="normal">				 </span><span class="string">" to %p</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">(</span><span class="type">void</span><span class="normal"> </span><span class="symbol">*)</span><span class="normal"> </span><span class="function">L4_Size</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">fpage</span><span class="symbol">),</span>
<span class="normal">				 </span><span class="symbol">(</span><span class="type">void</span><span class="normal"> </span><span class="symbol">*)</span><span class="normal"> tid</span><span class="symbol">.</span><span class="normal">raw</span><span class="symbol">);</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">else</span>
<span class="normal">		</span><span class="cbracket">{</span>
<span class="normal">		    </span><span class="comment">// Allocate from specific location.</span>
<span class="normal">		    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal"> </span><span class="function">allocate_page</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">tid</span><span class="symbol">,</span><span class="normal"> addr</span><span class="symbol">,</span><span class="normal"> </span><span class="function">L4_SizeLog2</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">fpage</span><span class="symbol">),</span>
<span class="normal">			    	    	 map</span><span class="symbol">))</span>
<span class="normal">			</span><span class="function">dprintf</span><span class="normal"> </span><span class="symbol">(</span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"s0: unable to allocate page %p of "</span>
<span class="normal">				 </span><span class="string">"size %p to %p</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">(</span><span class="type">void</span><span class="normal"> </span><span class="symbol">*)</span><span class="normal"> addr</span><span class="symbol">,</span>
<span class="normal">				 </span><span class="symbol">(</span><span class="type">void</span><span class="normal"> </span><span class="symbol">*)</span><span class="normal"> </span><span class="function">L4_Size</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">fpage</span><span class="symbol">),</span>
<span class="normal">				 </span><span class="symbol">(</span><span class="type">void</span><span class="normal"> </span><span class="symbol">*)</span><span class="normal"> tid</span><span class="symbol">.</span><span class="normal">raw</span><span class="symbol">);</span>
<span class="normal">		</span><span class="cbracket">}</span>

<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">attributes </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">		</span><span class="cbracket">{</span>
<span class="normal">		    </span><span class="comment">// Set memory attributes before mapping.</span>
<span class="normal">		    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal"> </span><span class="function">L4_Set_PageAttribute</span><span class="normal"> </span><span class="symbol">(</span><span class="function">L4_SndFpage</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">map</span><span class="symbol">),</span><span class="normal"> attributes</span><span class="symbol">))</span>
<span class="normal">		    </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="function">dprintf</span><span class="normal"> </span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"s0: memory control failed (%ld) setting page "</span>
<span class="normal">				 </span><span class="string">"%p with attributes %p"</span><span class="symbol">,</span>
<span class="normal">				 </span><span class="function">L4_ErrorCode</span><span class="symbol">(),</span><span class="normal"> </span>
<span class="normal">				 </span><span class="symbol">(</span><span class="type">void</span><span class="normal"> </span><span class="symbol">*)</span><span class="normal"> </span><span class="function">L4_Address</span><span class="normal"> </span><span class="symbol">(</span><span class="function">L4_SndFpage</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">map</span><span class="symbol">)),</span>
<span class="normal">				 </span><span class="symbol">(</span><span class="type">void</span><span class="normal"> </span><span class="symbol">*)</span><span class="normal"> attributes</span><span class="symbol">);</span>
<span class="normal">			map </span><span class="symbol">=</span><span class="normal"> </span><span class="function">L4_MapItem</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">L4_Nilpage</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">);</span>
<span class="normal">			</span><span class="function">L4_KDB_Enter</span><span class="normal"> </span><span class="symbol">(</span><span class="string">"s0: memory control failed!"</span><span class="symbol">);</span>
<span class="normal">		    </span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	    </span><span class="cbracket">}</span><span class="normal"> </span>
<span class="normal">	    </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> L4_SIGMA0_EXT</span><span class="symbol">:</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="type">bool</span><span class="normal"> reply </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="keyword">switch</span><span class="normal"> </span><span class="symbol">(</span><span class="function">L4_Get</span><span class="normal"> </span><span class="symbol">(&amp;</span><span class="normal">msg</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">))</span>
<span class="normal">	    </span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="keyword">case</span><span class="normal"> L4_S0EXT_VERBOSE</span><span class="symbol">:</span>
<span class="normal">		verbose </span><span class="symbol">=</span><span class="normal"> </span><span class="function">L4_Get</span><span class="normal"> </span><span class="symbol">(&amp;</span><span class="normal">msg</span><span class="symbol">,</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="keyword">case</span><span class="normal"> L4_s0EXT_DUMPMEM</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">dump_mempools</span><span class="normal"> </span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">L4_Get</span><span class="normal"> </span><span class="symbol">(&amp;</span><span class="normal">msg</span><span class="symbol">,</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">		    reply </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="cbracket">}</span>

<span class="normal">	    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal"> reply</span><span class="symbol">)</span>
<span class="normal">		tag </span><span class="symbol">=</span><span class="normal"> </span><span class="function">L4_Wait</span><span class="normal"> </span><span class="symbol">(&amp;</span><span class="normal">tid</span><span class="symbol">);</span>
<span class="normal">	    </span><span class="keyword">else</span>
<span class="normal">	    </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">L4_Set_MsgTag</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">L4_Niltag</span><span class="symbol">);</span>
<span class="normal">		tag </span><span class="symbol">=</span><span class="normal"> </span><span class="function">L4_ReplyWait</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">tid</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">tid</span><span class="symbol">);</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	    </span><span class="keyword">continue</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="label">	default:</span>
<span class="normal">	    </span><span class="function">dprintf</span><span class="normal"> </span><span class="symbol">(</span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"s0: unknown sigma0 reguest from %p, (%p, %p, %p)</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">		     </span><span class="symbol">(</span><span class="type">void</span><span class="normal"> </span><span class="symbol">*)</span><span class="normal"> tid</span><span class="symbol">.</span><span class="normal">raw</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">(</span><span class="type">void</span><span class="normal"> </span><span class="symbol">*)</span><span class="normal"> tag</span><span class="symbol">.</span><span class="normal">raw</span><span class="symbol">,</span>
<span class="normal">		     </span><span class="symbol">(</span><span class="type">void</span><span class="normal"> </span><span class="symbol">*)</span><span class="normal"> </span><span class="function">L4_Get</span><span class="normal"> </span><span class="symbol">(&amp;</span><span class="normal">msg</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">),</span><span class="normal"> </span><span class="symbol">(</span><span class="type">void</span><span class="normal"> </span><span class="symbol">*)</span><span class="normal"> </span><span class="function">L4_Get</span><span class="symbol">(&amp;</span><span class="normal">msg</span><span class="symbol">,</span><span class="normal"> </span><span class="number">1</span><span class="symbol">));</span>
<span class="normal">	    map </span><span class="symbol">=</span><span class="normal"> </span><span class="function">L4_MapItem</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">L4_Nilpage</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">);</span>

<span class="normal">	    tag </span><span class="symbol">=</span><span class="normal"> </span><span class="function">L4_Wait</span><span class="normal"> </span><span class="symbol">(&amp;</span><span class="normal">tid</span><span class="symbol">);</span>
<span class="normal">	    </span><span class="keyword">continue</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="function">L4_Put</span><span class="normal"> </span><span class="symbol">(&amp;</span><span class="normal">msg</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">L4_Word_t </span><span class="symbol">*)</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="number">2</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">map</span><span class="symbol">);</span>
<span class="normal">	</span><span class="function">L4_Load</span><span class="normal"> </span><span class="symbol">(&amp;</span><span class="normal">msg</span><span class="symbol">);</span>
<span class="normal">	tag </span><span class="symbol">=</span><span class="normal"> </span><span class="function">L4_ReplyWait</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">tid</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">tid</span><span class="symbol">);</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="cbracket">}</span>


<span class="comment">/**</span>
<span class="comment"> * Descriptor for a memory region.  A memory region has a start</span>
<span class="comment"> * address, an end address, and an owner.</span>
<span class="comment"> */</span>
<span class="keyword">class</span><span class="normal"> </span><span class="classname">memregion_t</span>
<span class="cbracket">{</span>
<span class="keyword">public</span><span class="symbol">:</span>

<span class="normal">    </span><span class="usertype">L4_Word_t</span><span class="normal">		low</span><span class="symbol">;</span>
<span class="normal">    </span><span class="usertype">L4_Word_t</span><span class="normal">		high</span><span class="symbol">;</span>
<span class="normal">    </span><span class="usertype">L4_ThreadId_t</span><span class="normal">	owner</span><span class="symbol">;</span>

<span class="normal">    </span><span class="usertype">memregion_t</span><span class="normal">		</span><span class="symbol">*</span><span class="normal">prev</span><span class="symbol">;</span>
<span class="normal">    </span><span class="usertype">memregion_t</span><span class="normal">		</span><span class="symbol">*</span><span class="normal">next</span><span class="symbol">;</span>

<span class="normal">    </span><span class="function">memregion_t</span><span class="normal"> </span><span class="symbol">(</span><span class="type">void</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{}</span>
<span class="normal">    </span><span class="function">memregion_t</span><span class="normal"> </span><span class="symbol">(</span><span class="usertype">L4_Word_t</span><span class="normal"> low</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">L4_Word_t</span><span class="normal"> high</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">L4_ThreadId_t</span><span class="normal"> owner</span><span class="symbol">);</span>

<span class="normal">    </span><span class="type">void</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> </span><span class="keyword">operator</span><span class="normal"> </span><span class="keyword">new</span><span class="normal"> </span><span class="symbol">(</span><span class="usertype">L4_Size_t</span><span class="normal"> size</span><span class="symbol">);</span>

<span class="normal">    </span><span class="type">void</span><span class="normal"> </span><span class="function">swap</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">memregion_t </span><span class="symbol">*</span><span class="normal"> n</span><span class="symbol">);</span>
<span class="normal">    </span><span class="type">void</span><span class="normal"> </span><span class="function">remove</span><span class="normal"> </span><span class="symbol">(</span><span class="type">void</span><span class="symbol">);</span>
<span class="normal">    </span><span class="type">bool</span><span class="normal"> </span><span class="function">is_adjacent</span><span class="normal"> </span><span class="symbol">(</span><span class="keyword">const</span><span class="normal"> memregion_t </span><span class="symbol">&amp;</span><span class="normal"> r</span><span class="symbol">);</span>
<span class="normal">    </span><span class="type">bool</span><span class="normal"> </span><span class="function">concatenate</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">memregion_t </span><span class="symbol">*</span><span class="normal"> reg</span><span class="symbol">);</span>

<span class="normal">    </span><span class="type">bool</span><span class="normal"> </span><span class="function">can_allocate</span><span class="normal"> </span><span class="symbol">(</span><span class="usertype">L4_Word_t</span><span class="normal"> addr</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">L4_Word_t</span><span class="normal"> log2size</span><span class="symbol">,</span>
<span class="normal">		       </span><span class="usertype">L4_ThreadId_t</span><span class="normal"> tid </span><span class="symbol">=</span><span class="normal"> L4_anythread</span><span class="symbol">);</span>
<span class="normal">    </span><span class="usertype">L4_Fpage_t</span><span class="normal"> </span><span class="function">allocate</span><span class="normal"> </span><span class="symbol">(</span><span class="usertype">L4_Word_t</span><span class="normal"> addr</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">L4_Word_t</span><span class="normal"> log2size</span><span class="symbol">,</span>
<span class="normal">			 </span><span class="usertype">L4_ThreadId_t</span><span class="normal"> tid </span><span class="symbol">=</span><span class="normal"> L4_anythread</span><span class="symbol">);</span>
<span class="normal">    </span><span class="usertype">L4_Fpage_t</span><span class="normal"> </span><span class="function">allocate</span><span class="normal"> </span><span class="symbol">(</span><span class="usertype">L4_Word_t</span><span class="normal"> log2size</span><span class="symbol">,</span>
<span class="normal">			 </span><span class="usertype">L4_ThreadId_t</span><span class="normal"> tid </span><span class="symbol">=</span><span class="normal"> L4_anythread</span><span class="symbol">);</span>
<span class="cbracket">}</span><span class="normal"> </span><span class="function">__attribute__</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">packed</span><span class="symbol">));</span>


<span class="comment">/**</span>
<span class="comment"> * Opaque class for holding a memregion_t structure.</span>
<span class="comment"> */</span>
<span class="keyword">class</span><span class="normal"> </span><span class="classname">memregion_listent_t</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="usertype">memregion_t</span><span class="normal">	reg</span><span class="symbol">;</span>

<span class="keyword">public</span><span class="symbol">:</span>

<span class="normal">    memregion_t </span><span class="symbol">*</span><span class="normal"> </span><span class="function">memreg</span><span class="normal"> </span><span class="symbol">(</span><span class="type">void</span><span class="symbol">)</span>
<span class="normal">	</span><span class="cbracket">{</span><span class="normal"> </span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">reg</span><span class="symbol">;</span><span class="normal"> </span><span class="cbracket">}</span>

<span class="normal">    memregion_listent_t </span><span class="symbol">*</span><span class="normal"> </span><span class="function">next</span><span class="normal"> </span><span class="symbol">(</span><span class="type">void</span><span class="symbol">)</span>
<span class="normal">	</span><span class="cbracket">{</span><span class="normal"> </span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">memregion_listent_t </span><span class="symbol">**)</span><span class="normal"> </span><span class="keyword">this</span><span class="symbol">;</span><span class="normal"> </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="type">void</span><span class="normal"> </span><span class="function">set_next</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">memregion_listent_t </span><span class="symbol">*</span><span class="normal"> n</span><span class="symbol">)</span>
<span class="normal">	</span><span class="cbracket">{</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">memregion_listent_t </span><span class="symbol">**)</span><span class="normal"> </span><span class="keyword">this</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> n</span><span class="symbol">;</span><span class="normal"> </span><span class="cbracket">}</span>
<span class="cbracket">}</span><span class="normal"> </span><span class="function">__attribute__</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">packed</span><span class="symbol">));</span>


<span class="comment">/**</span>
<span class="comment"> * List of memory regions.</span>
<span class="comment"> */</span>
<span class="keyword">class</span><span class="normal"> </span><span class="classname">memregion_list_t</span>
<span class="cbracket">{</span>
<span class="normal">    memregion_listent_t </span><span class="symbol">*</span><span class="normal"> list</span><span class="symbol">;</span>

<span class="keyword">public</span><span class="symbol">:</span>

<span class="normal">    </span><span class="type">void</span><span class="normal"> </span><span class="function">add</span><span class="normal"> </span><span class="symbol">(</span><span class="usertype">L4_Word_t</span><span class="normal"> addr</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">L4_Word_t</span><span class="normal"> size</span><span class="symbol">);</span>
<span class="normal">    </span><span class="usertype">L4_Word_t</span><span class="normal"> </span><span class="function">contents</span><span class="normal"> </span><span class="symbol">(</span><span class="type">void</span><span class="symbol">);</span>
<span class="normal">    memregion_t </span><span class="symbol">*</span><span class="normal"> </span><span class="function">alloc</span><span class="normal"> </span><span class="symbol">(</span><span class="type">void</span><span class="symbol">);</span>
<span class="normal">    </span><span class="type">void</span><span class="normal"> </span><span class="function">free</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">memregion_t </span><span class="symbol">*</span><span class="normal"> r</span><span class="symbol">);</span>
<span class="cbracket">}</span><span class="symbol">;</span>


<span class="comment">/**</span>
<span class="comment"> * A region pool is set of memory regions.</span>
<span class="comment"> */</span>
<span class="keyword">class</span><span class="normal"> </span><span class="classname">memregion_pool_t</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="usertype">memregion_t</span><span class="normal"> first</span><span class="symbol">;</span>
<span class="normal">    </span><span class="usertype">memregion_t</span><span class="normal"> last</span><span class="symbol">;</span>
<span class="normal">    memregion_t </span><span class="symbol">*</span><span class="normal"> ptr</span><span class="symbol">;</span>

<span class="keyword">public</span><span class="symbol">:</span>

<span class="normal">    </span><span class="type">void</span><span class="normal"> </span><span class="function">init</span><span class="normal"> </span><span class="symbol">(</span><span class="type">void</span><span class="symbol">);</span>
<span class="normal">    </span><span class="type">void</span><span class="normal"> </span><span class="function">dump</span><span class="normal"> </span><span class="symbol">(</span><span class="type">void</span><span class="symbol">);</span>
<span class="normal">    </span><span class="type">void</span><span class="normal"> </span><span class="function">insert</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">memregion_t </span><span class="symbol">*</span><span class="normal"> r</span><span class="symbol">);</span>
<span class="normal">    </span><span class="type">void</span><span class="normal"> </span><span class="function">remove</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">memregion_t </span><span class="symbol">*</span><span class="normal"> r</span><span class="symbol">);</span>
<span class="normal">    </span><span class="type">void</span><span class="normal"> </span><span class="function">insert</span><span class="normal"> </span><span class="symbol">(</span><span class="usertype">L4_Word_t</span><span class="normal"> low</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">L4_Word_t</span><span class="normal"> high</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">L4_ThreadId_t</span><span class="normal"> owner</span><span class="symbol">);</span>
<span class="normal">    </span><span class="type">void</span><span class="normal"> </span><span class="function">remove</span><span class="normal"> </span><span class="symbol">(</span><span class="usertype">L4_Word_t</span><span class="normal"> low</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">L4_Word_t</span><span class="normal"> high</span><span class="symbol">);</span>
<span class="normal">    </span><span class="type">void</span><span class="normal"> </span><span class="function">reset</span><span class="normal"> </span><span class="symbol">(</span><span class="type">void</span><span class="symbol">);</span>
<span class="normal">    memregion_t </span><span class="symbol">*</span><span class="normal"> </span><span class="function">next</span><span class="normal"> </span><span class="symbol">(</span><span class="type">void</span><span class="symbol">);</span>
<span class="cbracket">}</span><span class="symbol">;</span>



<span class="comment">/**</span>
<span class="comment"> * List of free memregion_t structures.</span>
<span class="comment"> */</span>
<span class="usertype">memregion_list_t</span><span class="normal"> memreg_list</span><span class="symbol">;</span>


<span class="comment">/**</span>
<span class="comment"> * Memory regions of conventional memory available for allocation.</span>
<span class="comment"> */</span>
<span class="usertype">memregion_pool_t</span><span class="normal"> conv_memory_pool</span><span class="symbol">;</span>


<span class="comment">/**</span>
<span class="comment"> * Memory regions of non-conventional memory available for allocation.</span>
<span class="comment"> */</span>
<span class="usertype">memregion_pool_t</span><span class="normal"> memory_pool</span><span class="symbol">;</span>


<span class="comment">/**</span>
<span class="comment"> * Memory regions already allocated.</span>
<span class="comment"> */</span>
<span class="usertype">memregion_pool_t</span><span class="normal"> alloc_pool</span><span class="symbol">;</span>





<span class="comment">/* ================================================================</span>
<span class="comment">**</span>
<span class="comment">**			memregion_t</span>
<span class="comment">**</span>
<span class="comment">*/</span>

<span class="normal">memregion_t</span><span class="symbol">::</span><span class="function">memregion_t</span><span class="normal"> </span><span class="symbol">(</span><span class="usertype">L4_Word_t</span><span class="normal"> l</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">L4_Word_t</span><span class="normal"> h</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">L4_ThreadId_t</span><span class="normal"> o</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    low </span><span class="symbol">=</span><span class="normal"> l</span><span class="symbol">;</span>
<span class="normal">    high </span><span class="symbol">=</span><span class="normal"> h</span><span class="symbol">;</span>
<span class="normal">    owner </span><span class="symbol">=</span><span class="normal"> o</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> memregion_t</span><span class="symbol">::</span><span class="keyword">operator</span><span class="normal"> </span><span class="keyword">new</span><span class="normal"> </span><span class="symbol">(</span><span class="usertype">L4_Size_t</span><span class="normal"> size</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">(</span><span class="type">void</span><span class="normal"> </span><span class="symbol">*)</span><span class="normal"> memreg_list</span><span class="symbol">.</span><span class="function">alloc</span><span class="normal"> </span><span class="symbol">();</span>
<span class="cbracket">}</span>


<span class="comment">/**</span>
<span class="comment"> * Swap memregion_t backing store.  The whole memregion_t structure is</span>
<span class="comment"> * copied and pointers for surrounding region structures are relocated</span>
<span class="comment"> * to the new location.</span>
<span class="comment"> *</span>
<span class="comment"> * </span><span class="type">@param</span><span class="comment"> r	location of memregion_t to use instead of current memory</span>
<span class="comment"> */</span>
<span class="type">void</span><span class="normal"> memregion_t</span><span class="symbol">::</span><span class="function">swap</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">memregion_t </span><span class="symbol">*</span><span class="normal"> r</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="symbol">*</span><span class="normal">r </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="keyword">this</span><span class="symbol">;</span>
<span class="normal">    r</span><span class="symbol">-&gt;</span><span class="normal">prev</span><span class="symbol">-&gt;</span><span class="normal">next </span><span class="symbol">=</span><span class="normal"> r</span><span class="symbol">-&gt;</span><span class="normal">next</span><span class="symbol">-&gt;</span><span class="normal">prev </span><span class="symbol">=</span><span class="normal"> r</span><span class="symbol">;</span>
<span class="cbracket">}</span>


<span class="comment">/**</span>
<span class="comment"> * Remove memory region.  Region is first removed from the pool which</span>
<span class="comment"> * it is allocated to before its memory is freed.  Region must not be</span>
<span class="comment"> * accessed after it has been removed.</span>
<span class="comment"> */</span>
<span class="type">void</span><span class="normal"> memregion_t</span><span class="symbol">::</span><span class="function">remove</span><span class="normal"> </span><span class="symbol">(</span><span class="type">void</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    prev</span><span class="symbol">-&gt;</span><span class="normal">next </span><span class="symbol">=</span><span class="normal"> next</span><span class="symbol">;</span>
<span class="normal">    next</span><span class="symbol">-&gt;</span><span class="normal">prev </span><span class="symbol">=</span><span class="normal"> prev</span><span class="symbol">;</span>
<span class="normal">    memreg_list</span><span class="symbol">.</span><span class="function">free</span><span class="normal"> </span><span class="symbol">(</span><span class="keyword">this</span><span class="symbol">);</span>
<span class="cbracket">}</span>


<span class="comment">/**</span>
<span class="comment"> * Check if supplied memory region is adjacent to current one.</span>
<span class="comment"> * </span><span class="type">@param</span><span class="comment"> r	memory region to check against</span>
<span class="comment"> * </span><span class="type">@return</span><span class="comment"> true it memory regions are adjacent, false otherwise</span>
<span class="comment"> */</span>
<span class="type">bool</span><span class="normal"> memregion_t</span><span class="symbol">::</span><span class="function">is_adjacent</span><span class="normal"> </span><span class="symbol">(</span><span class="keyword">const</span><span class="normal"> memregion_t </span><span class="symbol">&amp;</span><span class="normal"> r</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">low </span><span class="symbol">==</span><span class="normal"> r</span><span class="symbol">.</span><span class="normal">high </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> low </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">||</span>
<span class="normal">	</span><span class="symbol">(</span><span class="normal">high </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> r</span><span class="symbol">.</span><span class="normal">low </span><span class="symbol">&amp;&amp;</span><span class="normal"> r</span><span class="symbol">.</span><span class="normal">low </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">);</span>
<span class="cbracket">}</span>


<span class="comment">/**</span>
<span class="comment"> * Concatenate supplied memory region with current one.</span>
<span class="comment"> *</span>
<span class="comment"> * </span><span class="type">@param</span><span class="comment"> r	memory region to concatenate with</span>
<span class="comment"> *</span>
<span class="comment"> * </span><span class="type">@return</span><span class="comment"> true if concatenation was successful, false otherwise</span>
<span class="comment"> */</span>
<span class="type">bool</span><span class="normal"> memregion_t</span><span class="symbol">::</span><span class="function">concatenate</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">memregion_t </span><span class="symbol">*</span><span class="normal"> r</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">owner </span><span class="symbol">!=</span><span class="normal"> r</span><span class="symbol">-&gt;</span><span class="normal">owner</span><span class="symbol">)</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">low </span><span class="symbol">==</span><span class="normal"> r</span><span class="symbol">-&gt;</span><span class="normal">high </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> low </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">	low </span><span class="symbol">=</span><span class="normal"> r</span><span class="symbol">-&gt;</span><span class="normal">low</span><span class="symbol">;</span>
<span class="normal">    </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">high </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> r</span><span class="symbol">-&gt;</span><span class="normal">low </span><span class="symbol">&amp;&amp;</span><span class="normal"> r</span><span class="symbol">-&gt;</span><span class="normal">low </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">	high </span><span class="symbol">=</span><span class="normal"> r</span><span class="symbol">-&gt;</span><span class="normal">high</span><span class="symbol">;</span>
<span class="normal">    </span><span class="keyword">else</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">return</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>
<span class="cbracket">}</span>


<span class="comment">/**</span>
<span class="comment"> * Try allocating part from memory region.  If allocation is</span>
<span class="comment"> * successful, current memregion_t might be deleted or split up into</span>
<span class="comment"> * multiple regions.</span>
<span class="comment"> *</span>
<span class="comment"> * </span><span class="type">@param</span><span class="comment"> log2size	size of region to allocate</span>
<span class="comment"> * </span><span class="type">@param</span><span class="comment"> tid		thread id to use for allocation</span>
<span class="comment"> *</span>
<span class="comment"> * </span><span class="type">@return</span><span class="comment"> fpage for allocated region if successful, nilpage otherwise</span>
<span class="comment"> */</span>
<span class="usertype">L4_Fpage_t</span><span class="normal"> memregion_t</span><span class="symbol">::</span><span class="function">allocate</span><span class="normal"> </span><span class="symbol">(</span><span class="usertype">L4_Word_t</span><span class="normal"> log2size</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">L4_ThreadId_t</span><span class="normal"> tid</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="usertype">L4_Word_t</span><span class="normal"> size </span><span class="symbol">=</span><span class="normal"> 1UL </span><span class="symbol">&lt;&lt;</span><span class="normal"> log2size</span><span class="symbol">;</span>
<span class="normal">    </span><span class="usertype">L4_Fpage_t</span><span class="normal"> ret</span><span class="symbol">;</span>

<span class="normal">    </span><span class="comment">// Low and high address of region within mwmregion when they are</span>
<span class="normal">    </span><span class="comment">// aligned according to log2size.  Note that these values might</span>
<span class="normal">    </span><span class="comment">// overflow and must as such be handled with care.</span>
<span class="normal">    </span><span class="usertype">L4_Word_t</span><span class="normal"> low_a </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">low </span><span class="symbol">+</span><span class="normal"> size </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="symbol">~(</span><span class="normal">size</span><span class="symbol">-</span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">    </span><span class="usertype">L4_Word_t</span><span class="normal"> high_a </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">high </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="symbol">~(</span><span class="normal">size</span><span class="symbol">-</span><span class="number">1</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">low_a </span><span class="symbol">&gt;</span><span class="normal"> high_a			</span><span class="comment">// Low rounded up to above high</span>
<span class="normal">	</span><span class="symbol">||</span><span class="normal"> low </span><span class="symbol">&gt;</span><span class="normal"> low_a			</span><span class="comment">// Low wrapped around</span>
<span class="normal">	</span><span class="symbol">||</span><span class="normal"> high </span><span class="symbol">&lt;</span><span class="normal"> size</span><span class="symbol">-</span><span class="number">1</span><span class="normal">		</span><span class="comment">// High wrapper around</span>
<span class="normal">	</span><span class="symbol">||</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">high_a </span><span class="symbol">-</span><span class="normal"> low_a</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&lt;</span><span class="normal"> size</span><span class="symbol">-</span><span class="number">1</span><span class="normal">	</span><span class="comment">// Not enough space in memregion</span>
<span class="normal">	</span><span class="symbol">||</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">owner </span><span class="symbol">!=</span><span class="normal"> tid </span><span class="symbol">&amp;&amp;</span><span class="normal"> owner </span><span class="symbol">!=</span><span class="normal"> L4_anythread</span><span class="symbol">))</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="comment">// Allocation failed</span>
<span class="normal">	ret </span><span class="symbol">=</span><span class="normal"> L4_Nilpage</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="normal">    </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">low_a </span><span class="symbol">==</span><span class="normal"> low</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="comment">// Allocate from start of region</span>
<span class="normal">	ret </span><span class="symbol">=</span><span class="normal"> </span><span class="function">L4_FpageLog2</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">low</span><span class="symbol">,</span><span class="normal"> log2size</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> L4_FullyAccessible</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">low </span><span class="symbol">+</span><span class="normal"> size </span><span class="symbol">==</span><span class="normal"> high </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span>
<span class="normal">	    </span><span class="function">remove</span><span class="normal"> </span><span class="symbol">();</span>
<span class="normal">	</span><span class="keyword">else</span>
<span class="normal">	    low </span><span class="symbol">+=</span><span class="normal"> size</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="normal">    </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">high_a </span><span class="symbol">==</span><span class="normal"> high</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="comment">// Allocate from end of region</span>
<span class="normal">	ret </span><span class="symbol">=</span><span class="normal"> </span><span class="function">L4_FpageLog2</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">high_a </span><span class="symbol">-</span><span class="normal"> size </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span><span class="normal"> log2size</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> L4_FullyAccessible</span><span class="symbol">;</span>
<span class="normal">	high </span><span class="symbol">-=</span><span class="normal"> size</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="normal">    </span><span class="keyword">else</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="comment">// Allocate from middle of region</span>
<span class="normal">	ret </span><span class="symbol">=</span><span class="normal"> </span><span class="function">L4_FpageLog2</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">low_a</span><span class="symbol">,</span><span class="normal"> log2size</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> L4_FullyAccessible</span><span class="symbol">;</span>
<span class="normal">	memregion_t </span><span class="symbol">*</span><span class="normal"> r </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">new</span><span class="normal"> </span><span class="function">memregion_t</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">low_a </span><span class="symbol">+</span><span class="normal"> size</span><span class="symbol">,</span><span class="normal"> high</span><span class="symbol">,</span><span class="normal"> owner</span><span class="symbol">);</span>
<span class="normal">	r</span><span class="symbol">-&gt;</span><span class="normal">next </span><span class="symbol">=</span><span class="normal"> next</span><span class="symbol">;</span>
<span class="normal">	r</span><span class="symbol">-&gt;</span><span class="normal">prev </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">this</span><span class="symbol">;</span>
<span class="normal">	r</span><span class="symbol">-&gt;</span><span class="normal">next</span><span class="symbol">-&gt;</span><span class="normal">prev </span><span class="symbol">=</span><span class="normal"> next </span><span class="symbol">=</span><span class="normal"> r</span><span class="symbol">;</span>
<span class="normal">	high </span><span class="symbol">=</span><span class="normal"> low_a </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="keyword">return</span><span class="normal"> ret</span><span class="symbol">;</span>
<span class="cbracket">}</span>


<span class="comment">/**</span>
<span class="comment"> * Try allocating part from memory region.  If allocation is</span>
<span class="comment"> * successful, current memregion_t might be deleted or split up into</span>
<span class="comment"> * multiple regions.</span>
<span class="comment"> *</span>
<span class="comment"> * </span><span class="type">@param</span><span class="comment"> addr		location of region to allocate</span>
<span class="comment"> * </span><span class="type">@param</span><span class="comment"> log2size	size of region to allocate</span>
<span class="comment"> * </span><span class="type">@param</span><span class="comment"> tid		thread id to use for allocation</span>
<span class="comment"> *</span>
<span class="comment"> * </span><span class="type">@return</span><span class="comment"> fpage for allocated region if successful, nilpage otherwise</span>
<span class="comment"> */</span>
<span class="usertype">L4_Fpage_t</span><span class="normal"> memregion_t</span><span class="symbol">::</span><span class="function">allocate</span><span class="normal"> </span><span class="symbol">(</span><span class="usertype">L4_Word_t</span><span class="normal"> addr</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">L4_Word_t</span><span class="normal"> log2size</span><span class="symbol">,</span>
<span class="normal">				  </span><span class="usertype">L4_ThreadId_t</span><span class="normal"> tid</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="usertype">L4_Word_t</span><span class="normal"> size </span><span class="symbol">=</span><span class="normal"> 1UL </span><span class="symbol">&lt;&lt;</span><span class="normal"> log2size</span><span class="symbol">;</span>
<span class="normal">    </span><span class="usertype">L4_Fpage_t</span><span class="normal"> ret</span><span class="symbol">;</span>

<span class="normal">    </span><span class="comment">// Low and high address of region within mwmregion when they are</span>
<span class="normal">    </span><span class="comment">// aligned according to log2size.  Note that these values might</span>
<span class="normal">    </span><span class="comment">// overflow and must as such be handled with care.</span>
<span class="normal">    </span><span class="usertype">L4_Word_t</span><span class="normal"> low_a </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">low </span><span class="symbol">+</span><span class="normal"> size </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="symbol">~(</span><span class="normal">size</span><span class="symbol">-</span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">    </span><span class="usertype">L4_Word_t</span><span class="normal"> high_a </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">high </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="symbol">~(</span><span class="normal">size</span><span class="symbol">-</span><span class="number">1</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">addr </span><span class="symbol">&lt;</span><span class="normal"> low_a			</span><span class="comment">// Address range below low</span>
<span class="normal">	</span><span class="symbol">||</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">addr </span><span class="symbol">+</span><span class="normal"> size </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;</span><span class="normal"> high_a	</span><span class="comment">// Address range above high</span>
<span class="normal">	</span><span class="symbol">||</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">high_a </span><span class="symbol">-</span><span class="normal"> low_a</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&lt;</span><span class="normal"> size</span><span class="symbol">-</span><span class="number">1</span><span class="normal">	</span><span class="comment">// Not enough space in memregion</span>
<span class="normal">	</span><span class="symbol">||</span><span class="normal"> low </span><span class="symbol">&gt;</span><span class="normal"> low_a			</span><span class="comment">// Low wrapped around</span>
<span class="normal">	</span><span class="symbol">||</span><span class="normal"> high </span><span class="symbol">&lt;</span><span class="normal"> size</span><span class="symbol">-</span><span class="number">1</span><span class="normal">		</span><span class="comment">// High wrapper around</span>
<span class="normal">	</span><span class="symbol">||</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">owner </span><span class="symbol">!=</span><span class="normal"> tid </span><span class="symbol">&amp;&amp;</span><span class="normal"> owner </span><span class="symbol">!=</span><span class="normal"> L4_anythread</span><span class="symbol">))</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="comment">// Allocation failed</span>
<span class="normal">	ret </span><span class="symbol">=</span><span class="normal"> L4_Nilpage</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="normal">    </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">low_a </span><span class="symbol">==</span><span class="normal"> low </span><span class="symbol">&amp;&amp;</span><span class="normal"> addr </span><span class="symbol">==</span><span class="normal"> low</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="comment">// Allocate from start of region</span>
<span class="normal">	ret </span><span class="symbol">=</span><span class="normal"> </span><span class="function">L4_FpageLog2</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">low</span><span class="symbol">,</span><span class="normal"> log2size</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> L4_FullyAccessible</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">low </span><span class="symbol">+</span><span class="normal"> size </span><span class="symbol">==</span><span class="normal"> high </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span>
<span class="normal">	    </span><span class="function">remove</span><span class="normal"> </span><span class="symbol">();</span>
<span class="normal">	</span><span class="keyword">else</span>
<span class="normal">	    low </span><span class="symbol">+=</span><span class="normal"> size</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="normal">    </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">high_a </span><span class="symbol">==</span><span class="normal"> high </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">addr </span><span class="symbol">+</span><span class="normal"> size </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> high</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="comment">// Allocate from end of region</span>
<span class="normal">	ret </span><span class="symbol">=</span><span class="normal"> </span><span class="function">L4_FpageLog2</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">high_a </span><span class="symbol">-</span><span class="normal"> size </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span><span class="normal"> log2size</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> L4_FullyAccessible</span><span class="symbol">;</span>
<span class="normal">	high </span><span class="symbol">-=</span><span class="normal"> size</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="normal">    </span><span class="keyword">else</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="comment">// Allocate from middle of region</span>
<span class="normal">	ret </span><span class="symbol">=</span><span class="normal"> </span><span class="function">L4_FpageLog2</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">addr</span><span class="symbol">,</span><span class="normal"> log2size</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> L4_FullyAccessible</span><span class="symbol">;</span>
<span class="normal">	memregion_t </span><span class="symbol">*</span><span class="normal"> r </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">new</span><span class="normal"> </span><span class="function">memregion_t</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">addr </span><span class="symbol">+</span><span class="normal"> size</span><span class="symbol">,</span><span class="normal"> high</span><span class="symbol">,</span><span class="normal"> owner</span><span class="symbol">);</span>
<span class="normal">	r</span><span class="symbol">-&gt;</span><span class="normal">next </span><span class="symbol">=</span><span class="normal"> next</span><span class="symbol">;</span>
<span class="normal">	r</span><span class="symbol">-&gt;</span><span class="normal">prev </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">this</span><span class="symbol">;</span>
<span class="normal">	r</span><span class="symbol">-&gt;</span><span class="normal">next</span><span class="symbol">-&gt;</span><span class="normal">prev </span><span class="symbol">=</span><span class="normal"> next </span><span class="symbol">=</span><span class="normal"> r</span><span class="symbol">;</span>
<span class="normal">	high </span><span class="symbol">=</span><span class="normal"> addr </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="keyword">return</span><span class="normal"> ret</span><span class="symbol">;</span>
<span class="cbracket">}</span>


<span class="comment">/**</span>
<span class="comment"> * Check if it is possible to allocate from memory region.</span>
<span class="comment"> *</span>
<span class="comment"> * </span><span class="type">@param</span><span class="comment"> addr		location of region to allocate</span>
<span class="comment"> * </span><span class="type">@param</span><span class="comment"> log2size	size of region to allocate</span>
<span class="comment"> * </span><span class="type">@param</span><span class="comment"> tid		thread id to use for allocation</span>
<span class="comment"> *</span>
<span class="comment"> * </span><span class="type">@return</span><span class="comment"> true if allocation is possible, false otherwise</span>
<span class="comment"> */</span>
<span class="type">bool</span><span class="normal"> memregion_t</span><span class="symbol">::</span><span class="function">can_allocate</span><span class="normal"> </span><span class="symbol">(</span><span class="usertype">L4_Word_t</span><span class="normal"> addr</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">L4_Word_t</span><span class="normal"> log2size</span><span class="symbol">,</span>
<span class="normal">				</span><span class="usertype">L4_ThreadId_t</span><span class="normal"> tid</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="usertype">L4_Word_t</span><span class="normal"> size </span><span class="symbol">=</span><span class="normal"> 1UL </span><span class="symbol">&lt;&lt;</span><span class="normal"> log2size</span><span class="symbol">;</span>

<span class="normal">    </span><span class="comment">// Low and high address of region within mwmregion when they are</span>
<span class="normal">    </span><span class="comment">// aligned according to log2size.  Note that these values might</span>
<span class="normal">    </span><span class="comment">// overflow and must as such be handled with care.</span>
<span class="normal">    </span><span class="usertype">L4_Word_t</span><span class="normal"> low_a </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">low </span><span class="symbol">+</span><span class="normal"> size </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="symbol">~(</span><span class="normal">size</span><span class="symbol">-</span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">    </span><span class="usertype">L4_Word_t</span><span class="normal"> high_a </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">high </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="symbol">~(</span><span class="normal">size</span><span class="symbol">-</span><span class="number">1</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">addr </span><span class="symbol">&lt;</span><span class="normal"> low_a			</span><span class="comment">// Address range below low</span>
<span class="normal">	</span><span class="symbol">||</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">addr </span><span class="symbol">+</span><span class="normal"> size </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;</span><span class="normal"> high_a	</span><span class="comment">// Address range above high</span>
<span class="normal">	</span><span class="symbol">||</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">high_a </span><span class="symbol">-</span><span class="normal"> low_a</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&lt;</span><span class="normal"> size</span><span class="symbol">-</span><span class="number">1</span><span class="normal">	</span><span class="comment">// Not enough space in memregion</span>
<span class="normal">	</span><span class="symbol">||</span><span class="normal"> low </span><span class="symbol">&gt;</span><span class="normal"> low_a			</span><span class="comment">// Low wrapped around</span>
<span class="normal">	</span><span class="symbol">||</span><span class="normal"> high </span><span class="symbol">&lt;</span><span class="normal"> size</span><span class="symbol">-</span><span class="number">1</span><span class="normal">		</span><span class="comment">// High wrapper around</span>
<span class="normal">	</span><span class="symbol">||</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">owner </span><span class="symbol">!=</span><span class="normal"> tid </span><span class="symbol">&amp;&amp;</span><span class="normal"> owner </span><span class="symbol">!=</span><span class="normal"> L4_anythread</span><span class="symbol">))</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="normal">    </span><span class="keyword">else</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>
<span class="cbracket">}</span>



<span class="comment">/* ================================================================</span>
<span class="comment">**</span>
<span class="comment">**			memregion_list_t</span>
<span class="comment">**</span>
<span class="comment">*/</span>


<span class="comment">/**</span>
<span class="comment"> * Add more memory to be used for memregion_t structures.</span>
<span class="comment"> *</span>
<span class="comment"> * </span><span class="type">@param</span><span class="comment"> addr	location of memory to add</span>
<span class="comment"> * </span><span class="type">@param</span><span class="comment"> size	amount of memory to add</span>
<span class="comment"> */</span>
<span class="type">void</span><span class="normal"> memregion_list_t</span><span class="symbol">::</span><span class="function">add</span><span class="normal"> </span><span class="symbol">(</span><span class="usertype">L4_Word_t</span><span class="normal"> addr</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">L4_Word_t</span><span class="normal"> size</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">addr </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="comment">// Avoid inserting a NULL pointer into the list.</span>
<span class="normal">	addr </span><span class="symbol">+=</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">memregion_listent_t</span><span class="symbol">);</span>
<span class="normal">	size </span><span class="symbol">-=</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">memregion_listent_t</span><span class="symbol">);</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    memregion_listent_t </span><span class="symbol">*</span><span class="normal"> m </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">memregion_listent_t </span><span class="symbol">*)</span><span class="normal"> addr</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">L4_Word_t</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">m</span><span class="symbol">+</span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&lt;</span><span class="normal"> addr </span><span class="symbol">+</span><span class="normal"> size</span><span class="symbol">;</span><span class="normal"> m</span><span class="symbol">++)</span>
<span class="normal">	m</span><span class="symbol">-&gt;</span><span class="function">set_next</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">m</span><span class="symbol">+</span><span class="number">1</span><span class="symbol">);</span>

<span class="normal">    m</span><span class="symbol">-&gt;</span><span class="function">set_next</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">list</span><span class="symbol">);</span>
<span class="normal">    list </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">memregion_listent_t </span><span class="symbol">*)</span><span class="normal"> addr</span><span class="symbol">;</span>
<span class="cbracket">}</span>


<span class="comment">/**</span>
<span class="comment"> * </span><span class="type">@return</span><span class="comment"> number of memregion_t structures in pool</span>
<span class="comment"> */</span>
<span class="usertype">L4_Word_t</span><span class="normal"> memregion_list_t</span><span class="symbol">::</span><span class="function">contents</span><span class="normal"> </span><span class="symbol">(</span><span class="type">void</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="usertype">L4_Word_t</span><span class="normal"> n </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">    </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">memregion_listent_t </span><span class="symbol">*</span><span class="normal"> m </span><span class="symbol">=</span><span class="normal"> list</span><span class="symbol">;</span><span class="normal"> m </span><span class="symbol">!=</span><span class="normal"> NULL</span><span class="symbol">;</span><span class="normal"> m </span><span class="symbol">=</span><span class="normal"> m</span><span class="symbol">-&gt;</span><span class="function">next</span><span class="normal"> </span><span class="symbol">())</span>
<span class="normal">	n</span><span class="symbol">++;</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> n</span><span class="symbol">;</span>
<span class="cbracket">}</span>


<span class="comment">/**</span>
<span class="comment"> * Allocate a memregion_t structure.</span>
<span class="comment"> * </span><span class="type">@return</span><span class="comment"> newly allocated structure</span>
<span class="comment"> */</span>
<span class="normal">memregion_t </span><span class="symbol">*</span><span class="normal"> memregion_list_t</span><span class="symbol">::</span><span class="function">alloc</span><span class="normal"> </span><span class="symbol">(</span><span class="type">void</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal"> list</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="comment">// We might need some memory for allocating memory.</span>
<span class="normal">	</span><span class="usertype">memregion_t</span><span class="normal"> tmp</span><span class="symbol">;</span>
<span class="normal">	</span><span class="function">add</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">L4_Word_t</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">tmp</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">tmp</span><span class="symbol">));</span>

<span class="normal">	</span><span class="comment">// Allocate some memory to sigma0.</span>
<span class="normal">	</span><span class="usertype">L4_MapItem_t</span><span class="normal"> dummy</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal"> </span><span class="function">allocate_page</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">sigma0_id</span><span class="symbol">,</span><span class="normal"> min_pgsize</span><span class="symbol">,</span><span class="normal"> dummy</span><span class="symbol">))</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="function">l4_printf</span><span class="normal"> </span><span class="symbol">(</span><span class="string">"s0: Unable to allocate memory.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">	    </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(;;)</span>
<span class="normal">		</span><span class="function">L4_KDB_Enter</span><span class="normal"> </span><span class="symbol">(</span><span class="string">"s0: out of memory"</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="type">bool</span><span class="normal"> was_alloced </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">list </span><span class="symbol">==</span><span class="normal"> NULL</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal"> was_alloced</span><span class="symbol">)</span>
<span class="normal">	    list </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">memregion_listent_t </span><span class="symbol">*)</span><span class="normal"> NULL</span><span class="symbol">;</span>

<span class="normal">	</span><span class="comment">// Add newly allocated memory to pool.</span>
<span class="normal">	</span><span class="function">add</span><span class="normal"> </span><span class="symbol">(</span><span class="function">L4_Address</span><span class="normal"> </span><span class="symbol">(</span><span class="function">L4_SndFpage</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy</span><span class="symbol">)),</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">1UL </span><span class="symbol">&lt;&lt;</span><span class="normal"> min_pgsize</span><span class="symbol">));</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">was_alloced</span><span class="symbol">)</span>
<span class="normal">	    </span><span class="comment">// Swap temorary structure with a newly allocated one.</span>
<span class="normal">	    tmp</span><span class="symbol">.</span><span class="function">swap</span><span class="normal"> </span><span class="symbol">(</span><span class="function">alloc</span><span class="normal"> </span><span class="symbol">());</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="comment">// Remove first item from free list.</span>
<span class="normal">    memregion_listent_t </span><span class="symbol">*</span><span class="normal"> r </span><span class="symbol">=</span><span class="normal"> list</span><span class="symbol">;</span>
<span class="normal">    list </span><span class="symbol">=</span><span class="normal"> r</span><span class="symbol">-&gt;</span><span class="function">next</span><span class="normal"> </span><span class="symbol">();</span>

<span class="normal">    </span><span class="keyword">return</span><span class="normal"> r</span><span class="symbol">-&gt;</span><span class="function">memreg</span><span class="normal"> </span><span class="symbol">();</span>
<span class="cbracket">}</span>


<span class="comment">/**</span>
<span class="comment"> * Free a memregion_t structure.</span>
<span class="comment"> * </span><span class="type">@param</span><span class="comment"> r	memregion structure to free</span>
<span class="comment"> */</span>
<span class="type">void</span><span class="normal"> memregion_list_t</span><span class="symbol">::</span><span class="function">free</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">memregion_t </span><span class="symbol">*</span><span class="normal"> r</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    memregion_listent_t </span><span class="symbol">*</span><span class="normal"> e </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">memregion_listent_t </span><span class="symbol">*)</span><span class="normal"> r</span><span class="symbol">;</span>
<span class="normal">    e</span><span class="symbol">-&gt;</span><span class="function">set_next</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">list</span><span class="symbol">);</span>
<span class="normal">    list </span><span class="symbol">=</span><span class="normal"> e</span><span class="symbol">;</span>
<span class="cbracket">}</span>


<span class="comment">/* ================================================================</span>
<span class="comment">**</span>
<span class="comment">**			memregion_pool_t</span>
<span class="comment">**</span>
<span class="comment">*/</span>


<span class="comment">/**</span>
<span class="comment"> * Initialize the memory pool structure.  Must be done prior to any</span>
<span class="comment"> * insertions into the pool.</span>
<span class="comment"> */</span>
<span class="type">void</span><span class="normal"> memregion_pool_t</span><span class="symbol">::</span><span class="function">init</span><span class="normal"> </span><span class="symbol">(</span><span class="type">void</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    first</span><span class="symbol">.</span><span class="normal">next </span><span class="symbol">=</span><span class="normal"> first</span><span class="symbol">.</span><span class="normal">prev </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">last</span><span class="symbol">;</span>
<span class="normal">    last</span><span class="symbol">.</span><span class="normal">next </span><span class="symbol">=</span><span class="normal"> last</span><span class="symbol">.</span><span class="normal">prev </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">first</span><span class="symbol">;</span>
<span class="normal">    first</span><span class="symbol">.</span><span class="normal">low </span><span class="symbol">=</span><span class="normal"> first</span><span class="symbol">.</span><span class="normal">high </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">    last</span><span class="symbol">.</span><span class="normal">low </span><span class="symbol">=</span><span class="normal"> last</span><span class="symbol">.</span><span class="normal">high </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">~</span><span class="normal">0UL</span><span class="symbol">;</span>
<span class="normal">    first</span><span class="symbol">.</span><span class="normal">owner </span><span class="symbol">=</span><span class="normal"> last</span><span class="symbol">.</span><span class="normal">owner </span><span class="symbol">=</span><span class="normal"> L4_nilthread</span><span class="symbol">;</span>
<span class="normal">    ptr </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">last</span><span class="symbol">;</span>
<span class="cbracket">}</span>


<span class="comment">/**</span>
<span class="comment"> * Insert region into region pool.  Concatenate region with existing</span>
<span class="comment"> * regions if possible.</span>
<span class="comment"> *</span>
<span class="comment"> * </span><span class="type">@param</span><span class="comment"> r	region to insert into pool</span>
<span class="comment"> */</span>
<span class="type">void</span><span class="normal"> memregion_pool_t</span><span class="symbol">::</span><span class="function">insert</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">memregion_t </span><span class="symbol">*</span><span class="normal"> r</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    memregion_t </span><span class="symbol">*</span><span class="normal"> p </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">first</span><span class="symbol">;</span>
<span class="normal">    memregion_t </span><span class="symbol">*</span><span class="normal"> n </span><span class="symbol">=</span><span class="normal"> first</span><span class="symbol">.</span><span class="normal">next</span><span class="symbol">;</span>

<span class="normal">    </span><span class="comment">// Find correct insert location</span>
<span class="normal">    </span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">r</span><span class="symbol">-&gt;</span><span class="normal">low </span><span class="symbol">&gt;</span><span class="normal"> n</span><span class="symbol">-&gt;</span><span class="normal">high</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	p </span><span class="symbol">=</span><span class="normal"> n</span><span class="symbol">;</span>
<span class="normal">	n </span><span class="symbol">=</span><span class="normal"> n</span><span class="symbol">-&gt;</span><span class="normal">next</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">p</span><span class="symbol">-&gt;</span><span class="function">concatenate</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">r</span><span class="symbol">))</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="comment">// Region concatenated previous one</span>
<span class="normal">	memreg_list</span><span class="symbol">.</span><span class="function">free</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">r</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">p</span><span class="symbol">-&gt;</span><span class="function">concatenate</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">n</span><span class="symbol">))</span>
<span class="normal">	    </span><span class="function">remove</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">n</span><span class="symbol">);</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="normal">    </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">n</span><span class="symbol">-&gt;</span><span class="function">concatenate</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">r</span><span class="symbol">))</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="comment">// Region concatenated to next one</span>
<span class="normal">	memreg_list</span><span class="symbol">.</span><span class="function">free</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">r</span><span class="symbol">);</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="normal">    </span><span class="keyword">else</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="comment">// No concatenation possible.  Insert into list</span>
<span class="normal">	r</span><span class="symbol">-&gt;</span><span class="normal">next </span><span class="symbol">=</span><span class="normal"> n</span><span class="symbol">;</span>
<span class="normal">	r</span><span class="symbol">-&gt;</span><span class="normal">prev </span><span class="symbol">=</span><span class="normal"> p</span><span class="symbol">;</span>
<span class="normal">	p</span><span class="symbol">-&gt;</span><span class="normal">next </span><span class="symbol">=</span><span class="normal"> n</span><span class="symbol">-&gt;</span><span class="normal">prev </span><span class="symbol">=</span><span class="normal"> r</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="cbracket">}</span>


<span class="comment">/**</span>
<span class="comment"> * Remove region from region pool.  It is assumed that the region is</span>
<span class="comment"> * indeed contained in the pool.  Region must not be accessed after it</span>
<span class="comment"> * has been removed from pool.</span>
<span class="comment"> */</span>
<span class="type">void</span><span class="normal"> memregion_pool_t</span><span class="symbol">::</span><span class="function">remove</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">memregion_t </span><span class="symbol">*</span><span class="normal"> r</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    r</span><span class="symbol">-&gt;</span><span class="function">remove</span><span class="normal"> </span><span class="symbol">();</span>
<span class="cbracket">}</span>


<span class="comment">/**</span>
<span class="comment"> * Insert specified region into memory pool.  Concatenate with</span>
<span class="comment"> * existing regions if possible.</span>
<span class="comment"> *</span>
<span class="comment"> * </span><span class="type">@param</span><span class="comment"> low		lower limit of memory region</span>
<span class="comment"> * </span><span class="type">@param</span><span class="comment"> high		upper limit of memory region</span>
<span class="comment"> * </span><span class="type">@param</span><span class="comment"> owner		owner of memory region</span>
<span class="comment"> */</span>
<span class="type">void</span><span class="normal"> memregion_pool_t</span><span class="symbol">::</span><span class="function">insert</span><span class="normal"> </span><span class="symbol">(</span><span class="usertype">L4_Word_t</span><span class="normal"> low</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">L4_Word_t</span><span class="normal"> high</span><span class="symbol">,</span>
<span class="normal">			       </span><span class="usertype">L4_ThreadId_t</span><span class="normal"> owner</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="function">insert</span><span class="normal"> </span><span class="symbol">(</span><span class="keyword">new</span><span class="normal"> </span><span class="function">memregion_t</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">low</span><span class="symbol">,</span><span class="normal"> high</span><span class="symbol">,</span><span class="normal"> owner</span><span class="symbol">));</span>
<span class="cbracket">}</span>


<span class="comment">/**</span>
<span class="comment"> * Remove specified region from memory pool.</span>
<span class="comment"> *</span>
<span class="comment"> * </span><span class="type">@param</span><span class="comment"> low		lower limit of memory region to remove</span>
<span class="comment"> * </span><span class="type">@param</span><span class="comment"> high		upper limit of memory region to remove</span>
<span class="comment"> */</span>
<span class="type">void</span><span class="normal"> memregion_pool_t</span><span class="symbol">::</span><span class="function">remove</span><span class="normal"> </span><span class="symbol">(</span><span class="usertype">L4_Word_t</span><span class="normal"> low</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">L4_Word_t</span><span class="normal"> high</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    memregion_t </span><span class="symbol">*</span><span class="normal"> n </span><span class="symbol">=</span><span class="normal"> first</span><span class="symbol">.</span><span class="normal">next</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">low </span><span class="symbol">&gt;</span><span class="normal"> n</span><span class="symbol">-&gt;</span><span class="normal">high</span><span class="symbol">)</span>
<span class="normal">	n </span><span class="symbol">=</span><span class="normal"> n</span><span class="symbol">-&gt;</span><span class="normal">next</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">n </span><span class="symbol">!=</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">last</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">low </span><span class="symbol">&lt;=</span><span class="normal"> n</span><span class="symbol">-&gt;</span><span class="normal">low </span><span class="symbol">&amp;&amp;</span><span class="normal"> high </span><span class="symbol">&gt;=</span><span class="normal"> n</span><span class="symbol">-&gt;</span><span class="normal">high</span><span class="symbol">)</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="comment">// Remove whole region node.</span>
<span class="normal">	    n </span><span class="symbol">=</span><span class="normal"> n</span><span class="symbol">-&gt;</span><span class="normal">next</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="function">remove</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">n</span><span class="symbol">-&gt;</span><span class="normal">prev</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">low </span><span class="symbol">&lt;=</span><span class="normal"> n</span><span class="symbol">-&gt;</span><span class="normal">low </span><span class="symbol">&amp;&amp;</span><span class="normal"> high </span><span class="symbol">&gt;=</span><span class="normal"> n</span><span class="symbol">-&gt;</span><span class="normal">low</span><span class="symbol">)</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="comment">// Only need to modify lower limit.</span>
<span class="normal">	    n</span><span class="symbol">-&gt;</span><span class="normal">low </span><span class="symbol">=</span><span class="normal"> high </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">low </span><span class="symbol">&gt;</span><span class="normal"> n</span><span class="symbol">-&gt;</span><span class="normal">low </span><span class="symbol">&amp;&amp;</span><span class="normal"> low </span><span class="symbol">&lt;=</span><span class="normal"> n</span><span class="symbol">-&gt;</span><span class="normal">high</span><span class="symbol">)</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="comment">// Need to modify upper limit.</span>
<span class="normal">	    </span><span class="usertype">L4_Word_t</span><span class="normal"> old_high </span><span class="symbol">=</span><span class="normal"> n</span><span class="symbol">-&gt;</span><span class="normal">high</span><span class="symbol">;</span>
<span class="normal">	    n</span><span class="symbol">-&gt;</span><span class="normal">high </span><span class="symbol">=</span><span class="normal"> low </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">high </span><span class="symbol">&lt;</span><span class="normal"> old_high</span><span class="symbol">)</span>
<span class="normal">	    </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="comment">// Must split region into two separate regions.</span>
<span class="normal">		</span><span class="function">insert</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">high </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span><span class="normal"> old_high</span><span class="symbol">,</span><span class="normal"> n</span><span class="symbol">-&gt;</span><span class="normal">owner</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	    n </span><span class="symbol">=</span><span class="normal"> n</span><span class="symbol">-&gt;</span><span class="normal">next</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">else</span>
<span class="normal">	    n </span><span class="symbol">=</span><span class="normal"> n</span><span class="symbol">-&gt;</span><span class="normal">next</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="cbracket">}</span>


<span class="comment">/**</span>
<span class="comment"> * Dump contents of memory region pool.</span>
<span class="comment"> */</span>
<span class="type">void</span><span class="normal"> memregion_pool_t</span><span class="symbol">::</span><span class="function">dump</span><span class="normal"> </span><span class="symbol">(</span><span class="type">void</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    memregion_t </span><span class="symbol">*</span><span class="normal"> r</span><span class="symbol">;</span>
<span class="normal">    </span><span class="function">reset</span><span class="normal"> </span><span class="symbol">();</span>
<span class="normal">    </span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">r </span><span class="symbol">=</span><span class="normal"> </span><span class="function">next</span><span class="normal"> </span><span class="symbol">())</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="function">l4_printf</span><span class="normal"> </span><span class="symbol">(</span><span class="string">"s0:  %p-%p   %p %s</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">		</span><span class="symbol">(</span><span class="type">void</span><span class="normal"> </span><span class="symbol">*)</span><span class="normal"> r</span><span class="symbol">-&gt;</span><span class="normal">low</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">(</span><span class="type">void</span><span class="normal"> </span><span class="symbol">*)</span><span class="normal"> r</span><span class="symbol">-&gt;</span><span class="normal">high</span><span class="symbol">,</span>
<span class="normal">		</span><span class="symbol">(</span><span class="type">void</span><span class="normal"> </span><span class="symbol">*)</span><span class="normal"> r</span><span class="symbol">-&gt;</span><span class="normal">owner</span><span class="symbol">.</span><span class="normal">raw</span><span class="symbol">,</span>
<span class="normal">		r</span><span class="symbol">-&gt;</span><span class="normal">owner </span><span class="symbol">==</span><span class="normal"> sigma0_id </span><span class="symbol">?</span><span class="normal"> </span><span class="string">"(sigma0)"</span><span class="normal"> </span><span class="symbol">:</span>
<span class="normal">		r</span><span class="symbol">-&gt;</span><span class="normal">owner </span><span class="symbol">==</span><span class="normal"> sigma1_id </span><span class="symbol">?</span><span class="normal"> </span><span class="string">"(sigma1)"</span><span class="normal"> </span><span class="symbol">:</span>
<span class="normal">		r</span><span class="symbol">-&gt;</span><span class="normal">owner </span><span class="symbol">==</span><span class="normal"> rootserver_id </span><span class="symbol">?</span><span class="normal"> </span><span class="string">"(root server)"</span><span class="normal"> </span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">is_kernel_thread</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">r</span><span class="symbol">-&gt;</span><span class="normal">owner</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">?</span><span class="normal"> </span><span class="string">"(kernel)"</span><span class="normal"> </span><span class="symbol">:</span>
<span class="normal">		r</span><span class="symbol">-&gt;</span><span class="normal">owner </span><span class="symbol">==</span><span class="normal"> L4_anythread </span><span class="symbol">?</span><span class="normal"> </span><span class="string">"(anythread)"</span><span class="normal"> </span><span class="symbol">:</span>
<span class="normal">		</span><span class="string">""</span><span class="symbol">);</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> memregion_pool_t</span><span class="symbol">::</span><span class="function">reset</span><span class="normal"> </span><span class="symbol">(</span><span class="type">void</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    ptr </span><span class="symbol">=</span><span class="normal"> first</span><span class="symbol">.</span><span class="normal">next</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="normal">memregion_t </span><span class="symbol">*</span><span class="normal"> memregion_pool_t</span><span class="symbol">::</span><span class="function">next</span><span class="normal"> </span><span class="symbol">(</span><span class="type">void</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ptr </span><span class="symbol">==</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">last</span><span class="symbol">)</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">memregion_t </span><span class="symbol">*)</span><span class="normal"> NULL</span><span class="symbol">;</span>
<span class="normal">    memregion_t </span><span class="symbol">*</span><span class="normal"> ret </span><span class="symbol">=</span><span class="normal"> ptr</span><span class="symbol">;</span>
<span class="normal">    ptr </span><span class="symbol">=</span><span class="normal"> ptr</span><span class="symbol">-&gt;</span><span class="normal">next</span><span class="symbol">;</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> ret</span><span class="symbol">;</span>
<span class="cbracket">}</span>



<span class="comment">/* ================================================================</span>
<span class="comment">**</span>
<span class="comment">**		Memory region allocation interface</span>
<span class="comment">**</span>
<span class="comment">*/</span>

<span class="keyword">static</span><span class="normal"> </span><span class="usertype">memregion_t</span><span class="normal"> initial_memregs</span><span class="symbol">[</span><span class="number">32</span><span class="symbol">];</span>

<span class="type">void</span><span class="normal"> </span><span class="function">register_memory</span><span class="normal"> </span><span class="symbol">(</span><span class="usertype">L4_Word_t</span><span class="normal"> low</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">L4_Word_t</span><span class="normal"> high</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">L4_ThreadId_t</span><span class="normal"> t</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="comment">// Align to smallest page size.</span>
<span class="normal">    low </span><span class="symbol">=</span><span class="normal"> </span><span class="function">page_start</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">low</span><span class="symbol">);</span>
<span class="normal">    high </span><span class="symbol">=</span><span class="normal"> </span><span class="function">page_end</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">high</span><span class="symbol">);</span>

<span class="normal">    </span><span class="usertype">L4_MapItem_t</span><span class="normal"> map</span><span class="symbol">;</span>
<span class="normal">    </span><span class="usertype">L4_Word_t</span><span class="normal"> addr </span><span class="symbol">=</span><span class="normal"> low</span><span class="symbol">;</span>
<span class="normal">    </span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">addr </span><span class="symbol">&lt;</span><span class="normal"> high</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal"> </span><span class="function">allocate_page</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">t</span><span class="symbol">,</span><span class="normal"> addr</span><span class="symbol">,</span><span class="normal"> min_pgsize</span><span class="symbol">,</span><span class="normal"> map</span><span class="symbol">))</span>
<span class="normal">	    </span><span class="function">dprintf</span><span class="normal"> </span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"s0: alloc &lt;%p,%p&gt; to %p failed.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">		     </span><span class="symbol">(</span><span class="type">void</span><span class="normal"> </span><span class="symbol">*)</span><span class="normal"> low</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">(</span><span class="type">void</span><span class="normal"> </span><span class="symbol">*)</span><span class="normal"> high</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">(</span><span class="type">void</span><span class="normal"> </span><span class="symbol">*)</span><span class="normal"> t</span><span class="symbol">.</span><span class="normal">raw</span><span class="symbol">);</span>
<span class="normal">	addr </span><span class="symbol">+=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">1UL </span><span class="symbol">&lt;&lt;</span><span class="normal"> min_pgsize</span><span class="symbol">);</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">OLD_STYLE_MEMORY_REGIONS</span><span class="symbol">)</span>

<span class="comment">/*</span>
<span class="comment"> * Initialization for old style memory regions.</span>
<span class="comment"> */</span>

<span class="keyword">static</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="function">init_mempool_from_kip</span><span class="normal"> </span><span class="symbol">(</span><span class="type">void</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="comment">// Insert conventional memory.</span>
<span class="normal">    conv_memory_pool</span><span class="symbol">.</span><span class="function">insert</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">kip</span><span class="symbol">-&gt;</span><span class="normal">MainMem</span><span class="symbol">.</span><span class="normal">low</span><span class="symbol">,</span><span class="normal"> kip</span><span class="symbol">-&gt;</span><span class="normal">MainMem</span><span class="symbol">.</span><span class="normal">high </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span>
<span class="normal">			     L4_anythread</span><span class="symbol">);</span>

<span class="normal">    </span><span class="comment">// Insert rest of memory into non-conventional memory pool.</span>
<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">kip</span><span class="symbol">-&gt;</span><span class="normal">MainMem</span><span class="symbol">.</span><span class="normal">low </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">	memory_pool</span><span class="symbol">.</span><span class="function">insert</span><span class="normal"> </span><span class="symbol">(</span><span class="number">0</span><span class="symbol">,</span><span class="normal"> kip</span><span class="symbol">-&gt;</span><span class="normal">MainMem</span><span class="symbol">.</span><span class="normal">low</span><span class="symbol">,</span><span class="normal"> L4_anythread</span><span class="symbol">);</span>
<span class="normal">    memory_pool</span><span class="symbol">.</span><span class="function">insert</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">kip</span><span class="symbol">-&gt;</span><span class="normal">MainMem</span><span class="symbol">.</span><span class="normal">high</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">~</span><span class="normal">0UL</span><span class="symbol">,</span><span class="normal"> L4_anythread</span><span class="symbol">);</span>

<span class="normal">    </span><span class="function">dprintf</span><span class="normal"> </span><span class="symbol">(</span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"s0: KIP: %-16s = [%p - %p]</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"MainMem"</span><span class="symbol">,</span>
<span class="normal">	     </span><span class="symbol">(</span><span class="type">void</span><span class="normal"> </span><span class="symbol">*)</span><span class="normal"> kip</span><span class="symbol">-&gt;</span><span class="normal">MainMem</span><span class="symbol">.</span><span class="normal">low</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">(</span><span class="type">void</span><span class="normal"> </span><span class="symbol">*)</span><span class="normal"> kip</span><span class="symbol">-&gt;</span><span class="normal">MainMem</span><span class="symbol">.</span><span class="normal">high</span><span class="symbol">);</span>

<span class="preproc">#define</span><span class="normal"> </span><span class="function">reserve_memory</span><span class="symbol">(</span><span class="normal">name</span><span class="symbol">,</span><span class="normal"> t</span><span class="symbol">)</span><span class="normal">						</span><span class="symbol">\</span>
<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">kip</span><span class="symbol">-&gt;</span><span class="normal">name</span><span class="symbol">.</span><span class="normal">high</span><span class="symbol">)</span><span class="normal">							</span><span class="symbol">\</span>
<span class="normal">    </span><span class="cbracket">{</span><span class="normal">									</span><span class="symbol">\</span>
<span class="normal">	</span><span class="function">dprintf</span><span class="normal"> </span><span class="symbol">(</span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"s0: KIP: %-16s = [%p - %p]</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> #name</span><span class="symbol">,</span><span class="normal">		</span><span class="symbol">\</span>
<span class="normal">		 </span><span class="symbol">(</span><span class="type">void</span><span class="normal"> </span><span class="symbol">*)</span><span class="normal"> kip</span><span class="symbol">-&gt;</span><span class="normal">name</span><span class="symbol">.</span><span class="normal">low</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">(</span><span class="type">void</span><span class="normal"> </span><span class="symbol">*)</span><span class="normal"> kip</span><span class="symbol">-&gt;</span><span class="normal">name</span><span class="symbol">.</span><span class="normal">high</span><span class="symbol">);</span><span class="normal">	</span><span class="symbol">\</span>
<span class="normal">	</span><span class="function">register_memory</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">kip</span><span class="symbol">-&gt;</span><span class="normal">name</span><span class="symbol">.</span><span class="normal">low</span><span class="symbol">,</span><span class="normal"> kip</span><span class="symbol">-&gt;</span><span class="normal">name</span><span class="symbol">.</span><span class="normal">high</span><span class="symbol">,</span><span class="normal"> t</span><span class="symbol">);</span><span class="normal">		</span><span class="symbol">\</span>
<span class="normal">    </span><span class="cbracket">}</span><span class="normal">									</span><span class="symbol">\</span>
<span class="normal">    </span><span class="keyword">else</span><span class="normal"> 								</span><span class="symbol">\</span>
<span class="normal">	</span><span class="function">dprintf</span><span class="normal"> </span><span class="symbol">(</span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"s0: KIP: %-16s = [uninitialized]</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> #name</span><span class="symbol">)</span>

<span class="preproc">#define</span><span class="normal"> </span><span class="function">alloc_memory</span><span class="symbol">(</span><span class="normal">name</span><span class="symbol">,</span><span class="normal"> idx</span><span class="symbol">,</span><span class="normal"> t</span><span class="symbol">)</span><span class="normal">				</span><span class="symbol">\</span>
<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(((</span><span class="normal">L4_Word_t </span><span class="symbol">*)</span><span class="normal"> kip</span><span class="symbol">)[</span><span class="normal">idx </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">])</span><span class="normal">				</span><span class="symbol">\</span>
<span class="normal">    </span><span class="cbracket">{</span><span class="normal">								</span><span class="symbol">\</span>
<span class="normal">	L4_Word_t </span><span class="symbol">*</span><span class="normal"> desc </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">&amp;((</span><span class="normal">L4_Word_t </span><span class="symbol">*)</span><span class="normal"> kip</span><span class="symbol">)[</span><span class="normal">idx</span><span class="symbol">];</span><span class="normal">		</span><span class="symbol">\</span>
<span class="normal">	</span><span class="function">dprintf</span><span class="normal"> </span><span class="symbol">(</span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"s0: KIP: %-16s = [%p - %p]</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> #name</span><span class="symbol">,</span><span class="normal">	</span><span class="symbol">\</span>
<span class="normal">		 </span><span class="symbol">(</span><span class="type">void</span><span class="normal"> </span><span class="symbol">*)</span><span class="normal"> desc</span><span class="symbol">[</span><span class="number">0</span><span class="symbol">],</span><span class="normal"> </span><span class="symbol">(</span><span class="type">void</span><span class="normal"> </span><span class="symbol">*)</span><span class="normal"> desc</span><span class="symbol">[</span><span class="number">1</span><span class="symbol">]);</span><span class="normal">		</span><span class="symbol">\</span>
<span class="normal">	</span><span class="function">register_memory</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">desc</span><span class="symbol">[</span><span class="number">0</span><span class="symbol">],</span><span class="normal"> desc</span><span class="symbol">[</span><span class="number">1</span><span class="symbol">],</span><span class="normal"> t</span><span class="symbol">);</span><span class="normal">			</span><span class="symbol">\</span>
<span class="normal">    </span><span class="cbracket">}</span><span class="normal">								</span><span class="symbol">\</span>
<span class="normal">    </span><span class="keyword">else</span><span class="normal"> 							</span><span class="symbol">\</span>
<span class="normal">	</span><span class="function">dprintf</span><span class="normal"> </span><span class="symbol">(</span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"s0: KIP: %-16s = [uninitialized]</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> #name</span><span class="symbol">)</span>

<span class="normal">    </span><span class="function">reserve_memory</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">DedicatedMem</span><span class="symbol">[</span><span class="number">0</span><span class="symbol">],</span><span class="normal"> L4_anythread</span><span class="symbol">);</span>
<span class="normal">    </span><span class="function">reserve_memory</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">DedicatedMem</span><span class="symbol">[</span><span class="number">1</span><span class="symbol">],</span><span class="normal"> L4_anythread</span><span class="symbol">);</span>
<span class="normal">    </span><span class="function">reserve_memory</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">DedicatedMem</span><span class="symbol">[</span><span class="number">2</span><span class="symbol">],</span><span class="normal"> L4_anythread</span><span class="symbol">);</span>
<span class="normal">    </span><span class="function">reserve_memory</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">DedicatedMem</span><span class="symbol">[</span><span class="number">3</span><span class="symbol">],</span><span class="normal"> L4_anythread</span><span class="symbol">);</span>
<span class="normal">    </span><span class="function">reserve_memory</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">DedicatedMem</span><span class="symbol">[</span><span class="number">4</span><span class="symbol">],</span><span class="normal"> L4_anythread</span><span class="symbol">);</span>

<span class="normal">    </span><span class="function">reserve_memory</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ReservedMem</span><span class="symbol">[</span><span class="number">0</span><span class="symbol">],</span><span class="normal"> kernel_id</span><span class="symbol">);</span>
<span class="normal">    </span><span class="function">reserve_memory</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ReservedMem</span><span class="symbol">[</span><span class="number">1</span><span class="symbol">],</span><span class="normal"> kernel_id</span><span class="symbol">);</span>

<span class="normal">    </span><span class="function">alloc_memory</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Kdebug</span><span class="symbol">,</span><span class="normal"> </span><span class="number">6</span><span class="symbol">,</span><span class="normal"> kernel_id</span><span class="symbol">);</span>
<span class="normal">    </span><span class="function">alloc_memory</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Sigma0</span><span class="symbol">,</span><span class="normal"> </span><span class="number">10</span><span class="symbol">,</span><span class="normal"> sigma0_id</span><span class="symbol">);</span>
<span class="normal">    </span><span class="function">alloc_memory</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Sigma1</span><span class="symbol">,</span><span class="normal"> </span><span class="number">14</span><span class="symbol">,</span><span class="normal"> sigma1_id</span><span class="symbol">);</span>
<span class="normal">    </span><span class="function">alloc_memory</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">RootServer</span><span class="symbol">,</span><span class="normal"> </span><span class="number">18</span><span class="symbol">,</span><span class="normal"> rootserver_id</span><span class="symbol">);</span>
<span class="cbracket">}</span>
<span class="preproc">#else</span>

<span class="comment">/*</span>
<span class="comment"> * Inialization for new style memory regions.</span>
<span class="comment"> */</span>

<span class="keyword">static</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="function">init_mempool_from_kip</span><span class="normal"> </span><span class="symbol">(</span><span class="type">void</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    L4_MemoryDesc_t </span><span class="symbol">*</span><span class="normal"> md</span><span class="symbol">;</span>

<span class="normal">    </span><span class="comment">// Initialize memory pool with complete physical address space.</span>
<span class="normal">    memory_pool</span><span class="symbol">.</span><span class="function">insert</span><span class="normal"> </span><span class="symbol">(</span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">~</span><span class="normal">0UL</span><span class="symbol">,</span><span class="normal"> L4_anythread</span><span class="symbol">);</span>

<span class="normal">    </span><span class="comment">// Parse through all memory descriptors in kip.</span>
<span class="normal">    </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="usertype">L4_Word_t</span><span class="normal"> n </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">md </span><span class="symbol">=</span><span class="normal"> </span><span class="function">L4_MemoryDesc</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">kip</span><span class="symbol">,</span><span class="normal"> n</span><span class="symbol">));</span><span class="normal"> n</span><span class="symbol">++)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">L4_IsVirtual</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">md</span><span class="symbol">))</span>
<span class="normal">	    </span><span class="keyword">continue</span><span class="symbol">;</span>

<span class="normal">	</span><span class="usertype">L4_Word_t</span><span class="normal"> low </span><span class="symbol">=</span><span class="normal"> </span><span class="function">page_start</span><span class="normal"> </span><span class="symbol">(</span><span class="function">L4_MemoryDescLow</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">md</span><span class="symbol">));</span>
<span class="normal">	</span><span class="usertype">L4_Word_t</span><span class="normal"> high </span><span class="symbol">=</span><span class="normal"> </span><span class="function">page_end</span><span class="normal"> </span><span class="symbol">(</span><span class="function">L4_MemoryDescHigh</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">md</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>

<span class="normal">	conv_memory_pool</span><span class="symbol">.</span><span class="function">remove</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">low</span><span class="symbol">,</span><span class="normal"> high</span><span class="symbol">);</span>
<span class="normal">	memory_pool</span><span class="symbol">.</span><span class="function">remove</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">low</span><span class="symbol">,</span><span class="normal"> high</span><span class="symbol">);</span>
<span class="normal">	alloc_pool</span><span class="symbol">.</span><span class="function">remove</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">low</span><span class="symbol">,</span><span class="normal"> high</span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="function">L4_MemoryDescType</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">md</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="number">0xf</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> L4_BootLoaderSpecificMemoryType </span><span class="symbol">||</span>
<span class="normal">	    </span><span class="symbol">(</span><span class="function">L4_MemoryDescType</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">md</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="number">0xf</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> L4_ArchitectureSpecificMemoryType</span><span class="symbol">)</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="comment">/*</span>
<span class="comment">	     * Boot loader or architecture dependent memory.  Remove</span>
<span class="comment">	     * from conventional memory pool and insert into</span>
<span class="comment">	     * non-conventional memory pool.</span>
<span class="comment">	     */</span>
<span class="normal">	    memory_pool</span><span class="symbol">.</span><span class="function">insert</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">low</span><span class="symbol">,</span><span class="normal"> high</span><span class="symbol">,</span><span class="normal"> L4_anythread</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">else</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="keyword">switch</span><span class="normal"> </span><span class="symbol">(</span><span class="function">L4_MemoryDescType</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">md</span><span class="symbol">))</span>
<span class="normal">	    </span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="keyword">case</span><span class="normal"> L4_UndefinedMemoryType</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="keyword">case</span><span class="normal"> L4_ConventionalMemoryType</span><span class="symbol">:</span>
<span class="normal">		conv_memory_pool</span><span class="symbol">.</span><span class="function">insert</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">low</span><span class="symbol">,</span><span class="normal"> high</span><span class="symbol">,</span><span class="normal"> L4_anythread</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="keyword">case</span><span class="normal"> L4_ReservedMemoryType</span><span class="symbol">:</span>
<span class="normal">		alloc_pool</span><span class="symbol">.</span><span class="function">insert</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">low</span><span class="symbol">,</span><span class="normal"> high</span><span class="symbol">,</span><span class="normal"> kernel_id</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="keyword">case</span><span class="normal"> L4_DedicatedMemoryType</span><span class="symbol">:</span>
<span class="normal">		memory_pool</span><span class="symbol">.</span><span class="function">insert</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">low</span><span class="symbol">,</span><span class="normal"> high</span><span class="symbol">,</span><span class="normal"> L4_anythread</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="keyword">case</span><span class="normal"> L4_SharedMemoryType</span><span class="symbol">:</span>
<span class="normal">		alloc_pool</span><span class="symbol">.</span><span class="function">insert</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">low</span><span class="symbol">,</span><span class="normal"> high</span><span class="symbol">,</span><span class="normal"> L4_anythread</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="label">	    default:</span>
<span class="normal">		</span><span class="function">dprintf</span><span class="normal"> </span><span class="symbol">(</span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"s0: Unknown memory type (0x%x)</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">			 </span><span class="symbol">(</span><span class="type">int</span><span class="symbol">)</span><span class="normal"> </span><span class="function">L4_MemoryDescType</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">md</span><span class="symbol">));</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="preproc">#define</span><span class="normal"> </span><span class="function">alloc_memory</span><span class="symbol">(</span><span class="normal">name</span><span class="symbol">,</span><span class="normal"> idx</span><span class="symbol">,</span><span class="normal"> t</span><span class="symbol">)</span><span class="normal">				</span><span class="symbol">\</span>
<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(((</span><span class="normal">L4_Word_t </span><span class="symbol">*)</span><span class="normal"> kip</span><span class="symbol">)[</span><span class="normal">idx </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">])</span><span class="normal">				</span><span class="symbol">\</span>
<span class="normal">    </span><span class="cbracket">{</span><span class="normal">								</span><span class="symbol">\</span>
<span class="normal">	L4_Word_t </span><span class="symbol">*</span><span class="normal"> desc </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">&amp;((</span><span class="normal">L4_Word_t </span><span class="symbol">*)</span><span class="normal"> kip</span><span class="symbol">)[</span><span class="normal">idx</span><span class="symbol">];</span><span class="normal">		</span><span class="symbol">\</span>
<span class="normal">	</span><span class="function">register_memory</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">desc</span><span class="symbol">[</span><span class="number">0</span><span class="symbol">],</span><span class="normal"> desc</span><span class="symbol">[</span><span class="number">1</span><span class="symbol">],</span><span class="normal"> t</span><span class="symbol">);</span><span class="normal">			</span><span class="symbol">\</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="comment">// Allocate memory to initial servers.</span>
<span class="normal">    </span><span class="function">alloc_memory</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Kdebug</span><span class="symbol">,</span><span class="normal"> </span><span class="number">6</span><span class="symbol">,</span><span class="normal"> kernel_id</span><span class="symbol">);</span>
<span class="normal">    </span><span class="function">alloc_memory</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Sigma0</span><span class="symbol">,</span><span class="normal"> </span><span class="number">10</span><span class="symbol">,</span><span class="normal"> sigma0_id</span><span class="symbol">);</span>
<span class="normal">    </span><span class="function">alloc_memory</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Sigma1</span><span class="symbol">,</span><span class="normal"> </span><span class="number">14</span><span class="symbol">,</span><span class="normal"> sigma1_id</span><span class="symbol">);</span>
<span class="normal">    </span><span class="function">alloc_memory</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">RootServer</span><span class="symbol">,</span><span class="normal"> </span><span class="number">18</span><span class="symbol">,</span><span class="normal"> rootserver_id</span><span class="symbol">);</span>
<span class="cbracket">}</span>
<span class="preproc">#endif</span>


<span class="comment">/**</span>
<span class="comment"> * Initialze the various memory pools.</span>
<span class="comment"> */</span>
<span class="type">void</span><span class="normal"> </span><span class="function">init_mempool</span><span class="normal"> </span><span class="symbol">(</span><span class="type">void</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="usertype">L4_Word_t</span><span class="normal"> psmask </span><span class="symbol">=</span><span class="normal"> </span><span class="function">L4_PageSizeMask</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">kip</span><span class="symbol">);</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">psmask </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="function">l4_printf</span><span class="normal"> </span><span class="symbol">(</span><span class="string">"s0: Page-size mask in KIP is empty!</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(;;)</span>
<span class="normal">	    </span><span class="function">L4_KDB_Enter</span><span class="normal"> </span><span class="symbol">(</span><span class="string">"s0: no page-size mask"</span><span class="symbol">);</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="comment">// Determine minimum page size</span>
<span class="normal">    </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="usertype">L4_Word_t</span><span class="normal"> m </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">1UL </span><span class="symbol">&lt;&lt;</span><span class="normal"> min_pgsize</span><span class="symbol">);</span>
<span class="normal">	 </span><span class="symbol">(</span><span class="normal">m </span><span class="symbol">&amp;</span><span class="normal"> psmask</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">	 m </span><span class="symbol">&lt;&lt;=</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span><span class="normal"> min_pgsize</span><span class="symbol">++)</span>
<span class="normal">	</span><span class="symbol">;</span>

<span class="normal">    </span><span class="comment">// Add some initial memregion_t structures to pool</span>
<span class="normal">    memreg_list</span><span class="symbol">.</span><span class="function">add</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">L4_Word_t</span><span class="symbol">)</span><span class="normal"> initial_memregs</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">initial_memregs</span><span class="symbol">));</span>

<span class="normal">    </span><span class="comment">// Initialize memory pools</span>
<span class="normal">    conv_memory_pool</span><span class="symbol">.</span><span class="function">init</span><span class="normal"> </span><span class="symbol">();</span>
<span class="normal">    memory_pool</span><span class="symbol">.</span><span class="function">init</span><span class="normal"> </span><span class="symbol">();</span>
<span class="normal">    alloc_pool</span><span class="symbol">.</span><span class="function">init</span><span class="normal"> </span><span class="symbol">();</span>

<span class="normal">    </span><span class="function">init_mempool_from_kip</span><span class="normal"> </span><span class="symbol">();</span>
<span class="cbracket">}</span>


<span class="comment">/**</span>
<span class="comment"> * Dump contents of memory pools.</span>
<span class="comment"> */</span>
<span class="type">void</span><span class="normal"> </span><span class="function">dump_mempools</span><span class="normal"> </span><span class="symbol">(</span><span class="type">void</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="function">l4_printf</span><span class="normal"> </span><span class="symbol">(</span><span class="string">"s0: Free memregion structures: %d</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">	    </span><span class="symbol">(</span><span class="type">int</span><span class="symbol">)</span><span class="normal"> memreg_list</span><span class="symbol">.</span><span class="function">contents</span><span class="normal"> </span><span class="symbol">());</span>
<span class="normal">    </span><span class="function">l4_printf</span><span class="normal"> </span><span class="symbol">(</span><span class="string">"s0:</span><span class="specialchar">\n</span><span class="string">s0: Free pool (conventional memory):</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">    conv_memory_pool</span><span class="symbol">.</span><span class="function">dump</span><span class="normal"> </span><span class="symbol">();</span>
<span class="normal">    </span><span class="function">l4_printf</span><span class="normal"> </span><span class="symbol">(</span><span class="string">"s0:</span><span class="specialchar">\n</span><span class="string">s0: Free pool (non-conventional memory):</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">    memory_pool</span><span class="symbol">.</span><span class="function">dump</span><span class="normal"> </span><span class="symbol">();</span>
<span class="normal">    </span><span class="function">l4_printf</span><span class="normal"> </span><span class="symbol">(</span><span class="string">"s0:</span><span class="specialchar">\n</span><span class="string">s0: Alloc pool:</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">    alloc_pool</span><span class="symbol">.</span><span class="function">dump</span><span class="normal"> </span><span class="symbol">();</span>
<span class="cbracket">}</span>


<span class="comment">/**</span>
<span class="comment"> * Allocate a page located at a specific address.  Address need not be</span>
<span class="comment"> * within conventional memory range.</span>
<span class="comment"> *</span>
<span class="comment"> * </span><span class="type">@param</span><span class="comment"> tid		id of thread doing allocation</span>
<span class="comment"> * </span><span class="type">@param</span><span class="comment"> addr		location of page to allocate</span>
<span class="comment"> * </span><span class="type">@param</span><span class="comment"> log2size	size of page to allocate</span>
<span class="comment"> * </span><span class="type">@param</span><span class="comment"> map		genrated map item corresponding to alloced page</span>
<span class="comment"> * </span><span class="type">@param</span><span class="comment"> only_conv	only try to allocation from conventional memory pool</span>
<span class="comment"> *</span>
<span class="comment"> * </span><span class="type">@return</span><span class="comment"> true upon success, false otherwise</span>
<span class="comment"> */</span>
<span class="type">bool</span><span class="normal"> </span><span class="function">allocate_page</span><span class="normal"> </span><span class="symbol">(</span><span class="usertype">L4_ThreadId_t</span><span class="normal"> tid</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">L4_Word_t</span><span class="normal"> addr</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">L4_Word_t</span><span class="normal"> log2size</span><span class="symbol">,</span>
<span class="normal">		    L4_MapItem_t </span><span class="symbol">&amp;</span><span class="normal"> map</span><span class="symbol">,</span><span class="normal"> </span><span class="type">bool</span><span class="normal"> only_conventional</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    memregion_t </span><span class="symbol">*</span><span class="normal"> r</span><span class="symbol">;</span>
<span class="normal">    </span><span class="usertype">L4_Fpage_t</span><span class="normal"> fp</span><span class="symbol">;</span>

<span class="normal">    map </span><span class="symbol">=</span><span class="normal"> </span><span class="function">L4_MapItem</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">L4_Nilpage</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">);</span>

<span class="normal">    </span><span class="function">dprintf</span><span class="normal"> </span><span class="symbol">(</span><span class="number">2</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"s0: allocate_page (tid: 0x%lx, addr: %lx, log2size: %ld)</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">	     </span><span class="symbol">(</span><span class="type">long</span><span class="symbol">)</span><span class="normal"> tid</span><span class="symbol">.</span><span class="normal">raw</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">(</span><span class="type">long</span><span class="symbol">)</span><span class="normal"> addr</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">(</span><span class="type">long</span><span class="symbol">)</span><span class="normal"> log2size</span><span class="symbol">);</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">log2size </span><span class="symbol">&lt;</span><span class="normal"> min_pgsize</span><span class="symbol">)</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>

<span class="normal">    </span><span class="comment">// Make sure that addr is properly aligned.</span>
<span class="normal">    addr </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="symbol">~((</span><span class="normal">1UL </span><span class="symbol">&lt;&lt;</span><span class="normal"> log2size</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">    </span><span class="usertype">L4_Word_t</span><span class="normal"> addr_high </span><span class="symbol">=</span><span class="normal"> addr </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">1UL </span><span class="symbol">&lt;&lt;</span><span class="normal"> log2size</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>

<span class="normal">    memregion_pool_t </span><span class="symbol">*</span><span class="normal"> pools</span><span class="symbol">[]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">conv_memory_pool</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">memory_pool</span><span class="symbol">,</span>
<span class="normal">				   </span><span class="symbol">(</span><span class="normal">memregion_pool_t </span><span class="symbol">*)</span><span class="normal"> NULL </span><span class="cbracket">}</span><span class="symbol">;</span>

<span class="normal">    </span><span class="comment">// Check if we only want to try the conventional memory pool</span>
<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">only_conventional</span><span class="symbol">)</span>
<span class="normal">	pools</span><span class="symbol">[</span><span class="number">1</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">memregion_pool_t </span><span class="symbol">*)</span><span class="normal"> NULL</span><span class="symbol">;</span>

<span class="normal">    </span><span class="comment">// Try allocating from one of the memory pools.</span>
<span class="normal">    </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="usertype">L4_Word_t</span><span class="normal"> i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> pools</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> NULL</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	pools</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]-&gt;</span><span class="function">reset</span><span class="normal"> </span><span class="symbol">();</span>
<span class="normal">	</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">r </span><span class="symbol">=</span><span class="normal"> pools</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]-&gt;</span><span class="function">next</span><span class="normal"> </span><span class="symbol">())</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">r</span><span class="symbol">-&gt;</span><span class="normal">low </span><span class="symbol">&gt;</span><span class="normal"> addr_high </span><span class="symbol">||</span><span class="normal"> r</span><span class="symbol">-&gt;</span><span class="normal">high </span><span class="symbol">&lt;</span><span class="normal"> addr</span><span class="symbol">)</span>
<span class="normal">		</span><span class="keyword">continue</span><span class="symbol">;</span>

<span class="normal">	    fp </span><span class="symbol">=</span><span class="normal"> r</span><span class="symbol">-&gt;</span><span class="function">allocate</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">addr</span><span class="symbol">,</span><span class="normal"> log2size</span><span class="symbol">);</span>
<span class="normal">	    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal"> </span><span class="function">L4_IsNilFpage</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">fp</span><span class="symbol">))</span>
<span class="normal">	    </span><span class="cbracket">{</span>
<span class="normal">		map </span><span class="symbol">=</span><span class="normal"> </span><span class="function">L4_MapItem</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">fp</span><span class="symbol">,</span><span class="normal"> addr</span><span class="symbol">);</span>
<span class="normal">		alloc_pool</span><span class="symbol">.</span><span class="normal">insert </span>
<span class="normal">		    </span><span class="symbol">(</span><span class="keyword">new</span><span class="normal"> </span><span class="function">memregion_t</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">addr</span><span class="symbol">,</span><span class="normal"> addr_high</span><span class="symbol">,</span><span class="normal"> tid</span><span class="symbol">));</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="comment">// Check if memory has already been allocated.</span>
<span class="normal">    alloc_pool</span><span class="symbol">.</span><span class="function">reset</span><span class="normal"> </span><span class="symbol">();</span>
<span class="normal">    </span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">r </span><span class="symbol">=</span><span class="normal"> alloc_pool</span><span class="symbol">.</span><span class="function">next</span><span class="normal"> </span><span class="symbol">())</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">r</span><span class="symbol">-&gt;</span><span class="function">can_allocate</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">addr</span><span class="symbol">,</span><span class="normal"> log2size</span><span class="symbol">,</span><span class="normal"> tid</span><span class="symbol">))</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    map </span><span class="symbol">=</span><span class="normal"> L4_MapItem</span>
<span class="normal">		</span><span class="symbol">(</span><span class="function">L4_FpageLog2</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">addr</span><span class="symbol">,</span><span class="normal"> log2size</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> L4_FullyAccessible</span><span class="symbol">,</span><span class="normal"> addr</span><span class="symbol">);</span>
<span class="normal">	    </span><span class="keyword">return</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="comment">// If all the above failed we have to try the slow way of</span>
<span class="normal">    </span><span class="comment">// allocating parts of memory from different pools.</span>
<span class="normal">    memregion_pool_t </span><span class="symbol">*</span><span class="normal"> allpools</span><span class="symbol">[]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">conv_memory_pool</span><span class="symbol">,</span>
<span class="normal">				      </span><span class="symbol">&amp;</span><span class="normal">alloc_pool</span><span class="symbol">,</span>
<span class="normal">				      </span><span class="symbol">&amp;</span><span class="normal">memory_pool</span><span class="symbol">,</span>
<span class="normal">				      </span><span class="symbol">(</span><span class="normal">memregion_pool_t </span><span class="symbol">*)</span><span class="normal"> NULL </span><span class="cbracket">}</span><span class="symbol">;</span>

<span class="normal">    </span><span class="comment">// Check if we only want to try the conventional memory pool</span>
<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">only_conventional</span><span class="symbol">)</span>
<span class="normal">	allpools</span><span class="symbol">[</span><span class="number">2</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">memregion_pool_t </span><span class="symbol">*)</span><span class="normal"> NULL</span><span class="symbol">;</span>

<span class="normal">    </span><span class="comment">// Loop once for checking followed by once for allocating</span>
<span class="normal">    </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="usertype">L4_Word_t</span><span class="normal"> phase </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> phase </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span><span class="normal"> phase</span><span class="symbol">++)</span>
<span class="normal">    </span><span class="cbracket">{</span>

<span class="normal">	</span><span class="comment">// Use smallest page size as stepping</span>
<span class="normal">	</span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="usertype">L4_Word_t</span><span class="normal"> a </span><span class="symbol">=</span><span class="normal"> addr</span><span class="symbol">;</span><span class="normal"> a </span><span class="symbol">&lt;</span><span class="normal"> addr_high</span><span class="symbol">;</span><span class="normal"> a </span><span class="symbol">+=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">1UL </span><span class="symbol">&lt;&lt;</span><span class="normal"> min_pgsize</span><span class="symbol">))</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="usertype">L4_Word_t</span><span class="normal"> a_end </span><span class="symbol">=</span><span class="normal"> a </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">1UL </span><span class="symbol">&lt;&lt;</span><span class="normal"> min_pgsize</span><span class="symbol">);</span>
<span class="normal">	    </span><span class="type">bool</span><span class="normal"> failed </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>

<span class="normal">	    </span><span class="comment">// Try the different pools</span>
<span class="normal">	    </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="usertype">L4_Word_t</span><span class="normal"> i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> failed </span><span class="symbol">&amp;&amp;</span><span class="normal"> allpools</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> NULL</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">	    </span><span class="cbracket">{</span>
<span class="normal">		allpools</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]-&gt;</span><span class="function">reset</span><span class="normal"> </span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">r </span><span class="symbol">=</span><span class="normal"> allpools</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]-&gt;</span><span class="function">next</span><span class="normal"> </span><span class="symbol">())</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">		</span><span class="cbracket">{</span>
<span class="normal">		    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">r</span><span class="symbol">-&gt;</span><span class="normal">low </span><span class="symbol">&gt;</span><span class="normal"> a_end </span><span class="symbol">||</span><span class="normal"> r</span><span class="symbol">-&gt;</span><span class="normal">high </span><span class="symbol">&lt;</span><span class="normal"> a</span><span class="symbol">)</span>
<span class="normal">			</span><span class="keyword">continue</span><span class="symbol">;</span>

<span class="normal">		    </span><span class="comment">// Test if allocation is possible</span>
<span class="normal">		    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">r</span><span class="symbol">-&gt;</span><span class="function">can_allocate</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">a</span><span class="symbol">,</span><span class="normal"> min_pgsize</span><span class="symbol">,</span><span class="normal"> tid</span><span class="symbol">))</span>
<span class="normal">		    </span><span class="cbracket">{</span>
<span class="normal">			failed </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">phase </span><span class="symbol">==</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> allpools</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">alloc_pool</span><span class="symbol">)</span>
<span class="normal">			</span><span class="cbracket">{</span>
<span class="normal">			    </span><span class="comment">// Allocation phase</span>
<span class="normal">			    r</span><span class="symbol">-&gt;</span><span class="function">allocate</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">a</span><span class="symbol">,</span><span class="normal"> min_pgsize</span><span class="symbol">,</span><span class="normal"> tid</span><span class="symbol">);</span>
<span class="normal">			    alloc_pool</span><span class="symbol">.</span><span class="normal">insert </span>
<span class="normal">				</span><span class="symbol">(</span><span class="keyword">new</span><span class="normal"> </span><span class="function">memregion_t</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">a</span><span class="symbol">,</span><span class="normal"> a_end </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span><span class="normal"> tid</span><span class="symbol">));</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">		    </span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	    </span><span class="cbracket">}</span>

<span class="normal">	    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">failed</span><span class="symbol">)</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    map </span><span class="symbol">=</span><span class="normal"> </span><span class="function">L4_MapItem</span><span class="normal"> </span><span class="symbol">(</span><span class="function">L4_FpageLog2</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">addr</span><span class="symbol">,</span><span class="normal"> log2size</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> L4_FullyAccessible</span><span class="symbol">,</span>
<span class="normal">		      addr</span><span class="symbol">);</span>

<span class="normal">    </span><span class="keyword">return</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>
<span class="cbracket">}</span>


<span class="comment">/**</span>
<span class="comment"> * Allocate a page of conventional memory.  Page may be allocated from</span>
<span class="comment"> * arbitrary address.</span>
<span class="comment"> *</span>
<span class="comment"> * </span><span class="type">@param</span><span class="comment"> tid		id of thread doing allocation</span>
<span class="comment"> * </span><span class="type">@param</span><span class="comment"> log2size	size of page to allocate</span>
<span class="comment"> * </span><span class="type">@param</span><span class="comment"> map		genrated map item corresponding to alloced page</span>
<span class="comment"> *</span>
<span class="comment"> * </span><span class="type">@return</span><span class="comment"> true upon success, false otherwise</span>
<span class="comment"> */</span>
<span class="type">bool</span><span class="normal"> </span><span class="function">allocate_page</span><span class="normal"> </span><span class="symbol">(</span><span class="usertype">L4_ThreadId_t</span><span class="normal"> tid</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">L4_Word_t</span><span class="normal"> log2size</span><span class="symbol">,</span><span class="normal"> L4_MapItem_t </span><span class="symbol">&amp;</span><span class="normal"> map</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    memregion_t </span><span class="symbol">*</span><span class="normal"> r</span><span class="symbol">;</span>
<span class="normal">    </span><span class="usertype">L4_Fpage_t</span><span class="normal"> fp</span><span class="symbol">;</span>

<span class="normal">    map </span><span class="symbol">=</span><span class="normal"> </span><span class="function">L4_MapItem</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">L4_Nilpage</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">);</span>

<span class="normal">    </span><span class="function">dprintf</span><span class="normal"> </span><span class="symbol">(</span><span class="number">2</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"s0: allocate_page (tid: 0x%lx, log2size: %ld)</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">	     </span><span class="symbol">(</span><span class="type">long</span><span class="symbol">)</span><span class="normal"> tid</span><span class="symbol">.</span><span class="normal">raw</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">(</span><span class="type">long</span><span class="symbol">)</span><span class="normal"> log2size</span><span class="symbol">);</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">log2size </span><span class="symbol">&lt;</span><span class="normal"> min_pgsize</span><span class="symbol">)</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>

<span class="normal">    </span><span class="comment">// Try allocating memory from pool of real memory.</span>
<span class="normal">    conv_memory_pool</span><span class="symbol">.</span><span class="function">reset</span><span class="normal"> </span><span class="symbol">();</span>
<span class="normal">    </span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">r </span><span class="symbol">=</span><span class="normal"> conv_memory_pool</span><span class="symbol">.</span><span class="function">next</span><span class="normal"> </span><span class="symbol">())</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	fp </span><span class="symbol">=</span><span class="normal"> r</span><span class="symbol">-&gt;</span><span class="function">allocate</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">log2size</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal"> </span><span class="function">L4_IsNilFpage</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">fp</span><span class="symbol">))</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    map </span><span class="symbol">=</span><span class="normal"> </span><span class="function">L4_MapItem</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">fp</span><span class="symbol">,</span><span class="normal"> </span><span class="function">L4_Address</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">fp</span><span class="symbol">));</span>
<span class="normal">	    alloc_pool</span><span class="symbol">.</span><span class="normal">insert</span>
<span class="normal">		</span><span class="symbol">(</span><span class="keyword">new</span><span class="normal"> </span><span class="function">memregion_t</span><span class="normal"> </span><span class="symbol">(</span><span class="function">L4_Address</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">fp</span><span class="symbol">),</span><span class="normal"> </span><span class="function">L4_Address</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">fp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span>
<span class="normal">				  </span><span class="symbol">(</span><span class="normal">1UL </span><span class="symbol">&lt;&lt;</span><span class="normal"> log2size</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span><span class="normal"> tid</span><span class="symbol">));</span>
<span class="normal">	    </span><span class="keyword">return</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="keyword">return</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="cbracket">}</span>
</tt></pre></div><footer><div style="text-align: right; padding: 8pt; font-size: 13px"><a href="/xmlfeed/weblog-rss20.xml"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAAAPAgMAAAAOp6AcAAAADFBMVEVmZmb/ZgD///+JjnlbTUWmAAAACXBIWXMAAABIAAAASABGyWs+AAAACXZwQWcAAABQAAAADwCexKkxAAAAWUlEQVQYlWNgwAa0VmGAFQyqoSCQ/x8J/CBFMCt0ZdTU/F/7/+1HEkydFpoKVPn+93sUlUujQvP/7UcRTAuNDJ2a//s/imDqtKVZofm/1qGYSZk7sfodGwAAiobBJtffoNAAAAAASUVORK5CYII=" alt="RSS 2.0 Weblog Feed" width="80" height="15"/></a> <a href="/xmlfeed/weblog-atom10.xml"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAAAPAgMAAAAOp6AcAAAADFBMVEVmZmb/ZgD///+JjnlbTUWmAAAAaklEQVQYlWNgwAa0VmGAFQyqoSCQ/x8J/CBFMDV16rTQ/H/7V//69+//v/3/9oMEI6cuAwr+fv/+/b5d///v//0eJBgWOhMo+Gs9UPAdXDBy6lSYyn9wQZCZS0GCYDPXQcykzJ1Y/Y4NAABKvL80wyoMPgAAAABJRU5ErkJggg==" alt="Atom 1.0 Weblog Feed" width="80" height="15"/></a> <a href="http://validator.w3.org/check?uri=referer"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAAAPCAMAAABEF7i9AAAB1FBMVEUHQIgIRY0MN4QNRYoSRYsXUpIYVJQeUpUhWpgjUJMjWpgmU5QnXJkuYZ0uYpwwV5YyZJ4zaKM3ZaA5aaI6aqM6a6E8ZqA8Z6BAbaRBbqdCbaVHd61KSkpKcaZQUFBUf69UgbBVVVVXfq9Yg7NZhbJZh7RagrNeXVxeh7RfjLdgYGBiiLZmZmZnZ2doirhpkbt0m8F3m8B3ncJ5lb55ocR+ocSDgX+Do8eEpMqGhoaHp8iIpMeJjnmJpseKqMeOqsqPsdCQrcyVlZWVsM2Zs9CZtNCfu9ahoaGhuNShudSivNSjtMWjvNSmpqWnpqSrw9qvxNqyxdmyxdyzsK6zs7Ozx9y0xt21yN22tra4y+K80eK/v7/AwMDExMTEy9DH2ejK2+jM2ujN3uvP0dLR0NDR3uvS3uvS3+zU4u3V1dXY2dnY4u7Y4+3b5e/d3d3d5u/d5/De3t7f39/h4uLj4uHj6/Ll7PXm7fTn7/Xo7/Tp7/bq7Ozr6unr8ffw8PDw9vvx9fny+P7z8/Pz9vnz9vv3+fv4+vz5+vz6+vr6+/36/P36///7+/77/Pz7/f37/f78/Pz8/f38/f79/f39/f79/f/9/v79///+/v7+/v////3///+tYR2LAAABKklEQVQ4y2PQoTJg0JlNVYDPQBsyAMTAqaFes8tdsmdPCtA3MDStr3GKKK6myMAprgJ9pcpWs/MlRExYJBvNZLR0sigycHYOV1S7mtjsQJ4gf+HIFPXoWMs6qIGzIRiKZs9GFoEaMRuZhhrYqqJXy8uZYauRxC/VHew7e3YTPAxnI5swG6JxNrKBNjB1EFmIgV0+HA6C8pqqzhXG7BbJJROQIwViMYQ7G2oDQQNn57JyG7kxiCfObrBmS5+BHMuYLkTzMnYDm5WY4lOZZRPKZocxes+aPbuwCFsYohiICLvZsKBAMrDTQ7K/StveU8icTzrOL8JdLpOyWJ49u8Bx9ozw8DY7UYW03hhdxZAOSg2c3jN79rSJs1vSKmfOnpFXNJmynELlvExlAADnaZpLFGEC2wAAAABJRU5ErkJggg==" alt="Valid XHTML 1.1" width="80" height="15"/></a> <a href="http://jigsaw.w3.org/css-validator/check/referer"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAAAPCAMAAABEF7i9AAAB1FBMVEUHQIgIRY0MN4QNRYoSRYsXUpIYVJQeUpUhWpgjUJMjWpgmU5QnXJkuYZ0uYpwwV5YyZJ4zaKM3ZaA5aaI6aqM6a6E8ZqA8Z6BAbaRBbqdCbaVHd61KSkpKcaZQUFBUf69UgbBVVVVXfq9Yg7NZhbJZh7RagrNeXVxeh7RfjLdgYGBiiLZmZmZnZ2doirhpkbt0m8F3m8B3ncJ5lb55ocR+ocSDgX+Do8eEpMqGhoaHp8iIpMeJjnmJpseKqMeOqsqPsdCQrcyVlZWVsM2Zs9CZtNCfu9ahoaGhuNShudSivNSjtMWjvNSmpqWnpqSrw9qvxNqyxdmyxdyzsK6zs7Ozx9y0xt21yN22tra4y+K80eK/v7/AwMDExMTEy9DH2ejK2+jM2ujN3uvP0dLR0NDR3uvS3uvS3+zU4u3V1dXY2dnY4u7Y4+3b5e/d3d3d5u/d5/De3t7f39/h4uLj4uHj6/Ll7PXm7fTn7/Xo7/Tp7/bq7Ozr6unr8ffw8PDw9vvx9fny+P7z8/Pz9vnz9vv3+fv4+vz5+vz6+vr6+/36/P36///7+/77/Pz7/f37/f78/Pz8/f38/f79/f39/f79/f/9/v79///+/v7+/v////3///+tYR2LAAABEUlEQVQ4y2PQoTJg0JlNVYDPQBsyAMTAqaFes8tdsmdPCtA3MDStr3GKKK6myMAprgJ9pcpWs/MlRExYJBvNZLR0sigycHYOV1S7mtjsQJ4gf+HIFPXoWMs6mIEQCsIjwhKoga0qerW8nBm2Gkn8Ut3BvrNnN8HCcDYM2cBIogzs8uFwEJTXVHWuMGa3SC6ZgIgUqCEwdxJr4OxcVm4jNwbxxNkN1mzpM2ajGIjsPGK9PLtZiSk+lVk2oWx2GKP3rNmzC4tQwpDoIIQb2Okh2V+lbe8pZM4nHecX4S6XSVksz55d4Dh7Rnh4m52oQlpvjK5iSAelBk7vmT172sTZLWmVM2fPyCuaTFlOoXJepjIAANlljDGY/l5pAAAAAElFTkSuQmCC" alt="Valid CSS (2.1)" width="80" height="15"/></a><br/>Copyright 2005-2020 <a href="/about/">Timo Bingmann</a> - <a href="/about/impressum.html">Impressum</a></div></footer></body></html>