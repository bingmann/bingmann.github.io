<?xml version="1.0" encoding="iso-8859-1"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta content="text/html; charset=iso-8859-1" http-equiv="content-type" /><title>/2006/SDIOS06/sdios06/lib/SDL/stdlib/SDL_qsort.c - panthema.net</title><link rel="stylesheet" type="text/css" href="/css/base.css" /><link rel="alternate" type="application/rss+xml" title="panthema.net Weblog Feed RSS 2.0" href="http://panthema.net/xmlfeed/weblog-rss20.xml" /><link rel="alternate" type="application/atom+xml" title="panthema.net Weblog Feed Atom 1.0" href="http://panthema.net/xmlfeed/weblog-atom10.xml" /><script type="text/javascript" src="/pt.js"></script><script type="text/javascript">/* <!-- */makeIEHover = function() {var lis = document.getElementById('ptnav').getElementsByTagName('li');for (var i = 0; i < lis.length; i++) {lis[i].onmouseover = function() {this.className += ' sfhover';};lis[i].onmouseout = function() {this.className = this.className.replace(new RegExp(' sfhover\b'), '');};}};if (window.attachEvent) window.attachEvent('onload', makeIEHover);/* --> */</script></head><body style="background-image: url(/img/bgfractal5.jpg)"><div class="pttopbar"><div style="float: right"><ul id="ptnav"><li class="top"><a class="ni" href="/">Weblog</a><ul style="margin-left: -6px; margin-top: 4px" class="nx"><li><a href="/2013/">2013</a></li><li><a href="/2012/">2012</a></li><li><a href="/2011/">2011</a></li><li><a href="/2010/">2010</a></li><li><a href="/2009/">2009</a></li><li><a href="/2008/">2008</a></li><li><a href="/2007/">2007</a></li><li><a href="/2006/">2006</a></li><li class="nt"><a href="/2005/">2005</a></li><li class="ns"><a href="/xmlfeed/weblog-rss20.xml">RSS Feed</a></li><li><a href="/xmlfeed/weblog-atom10.xml">XML Atom</a></li></ul></li><li class="top"><a class="ni" href="/tags/">Tags</a><div style="width: 14em; margin-left: -9em; margin-top: 4px"><a style="font-size: 10pt" href="/tags/algebra.html">algebra</a> <a style="font-size: 16pt" href="/tags/c++.html">c++</a> <a style="font-size: 12pt" href="/tags/code-example.html">code-example</a> <a style="font-size: 14pt" href="/tags/code-snippet.html">code-snippet</a> <a style="font-size: 11pt" href="/tags/coding_tricks.html">coding tricks</a> <a style="font-size: 10pt" href="/tags/compsci.html">compsci</a> <a style="font-size: 10pt" href="/tags/compsci_study_thesis.html">compsci study thesis</a> <a style="font-size: 9pt" href="/tags/crypto-speedtest.html">crypto-speedtest</a> <a style="font-size: 10pt" href="/tags/cryptography.html">cryptography</a> <a style="font-size: 9pt" href="/tags/cryptote.html">cryptote</a> <a style="font-size: 12pt" href="/tags/flex-bison-cpp-example.html">flex-bison-cpp-example</a> <a style="font-size: 13pt" href="/tags/fun.html">fun</a> <a style="font-size: 10pt" href="/tags/graphviz.html">graphviz</a> <a style="font-size: 9pt" href="http://www.hmtg.de">hartmetall</a> <a style="font-size: 9pt" href="/tags/helppc.html">helppc</a> <a style="font-size: 9pt" href="/tags/hifi_selbstbau.html">hifi selbstbau</a> <a style="font-size: 10pt" href="/tags/latex.html">latex</a> <a style="font-size: 10pt" href="/tags/librivox.html">librivox</a> <a style="font-size: 10pt" href="/tags/linux.html">linux</a> <a style="font-size: 10pt" href="/tags/maths.html">maths</a> <a style="font-size: 9pt" href="/tags/music.html">music</a> <a style="font-size: 10pt" href="/tags/netfundamentals.html">netfundamentals</a> <a style="font-size: 11pt" href="/tags/ns-3.html">ns-3</a> <a style="font-size: 9pt" href="/tags/parallel-string-sorting.html">parallel-string-sorting</a> <a style="font-size: 9pt" href="/tags/qtsqlview.html">qtsqlview</a> <a style="font-size: 10pt" href="/tags/research.html">research</a> <a style="font-size: 11pt" href="/tags/sdios06.html">sdios06</a> <a style="font-size: 9pt" href="/tags/sdlfractal.html">sdlfractal</a> <a style="font-size: 11pt" href="/tags/sorting.html">sorting</a> <a style="font-size: 10pt" href="/tags/stringology.html">stringology</a> <a style="font-size: 16pt" href="/tags/stx-btree.html">stx-btree</a> <a style="font-size: 9pt" href="/tags/stx-exparser.html">stx-exparser</a> <a style="font-size: 15pt" href="/tags/talk.html">talk</a> <a style="font-size: 10pt" href="/tags/tutorium.html">tutorium</a> <a style="font-size: 16pt" href="/tags/university.html">university</a> <a style="font-size: 13pt" href="/tags/utilities.html">utilities</a> <a style="font-size: 9pt" href="/tags/webdesign.html">webdesign</a> </div></li><li class="top"><a class="ni" href="#">Projects</a> <ul style="margin-left: -8em; margin-top: 4px" class="nx"> <li><a href="/2009/cryptote/">CryptoTE</a></li> <li><a href="/2009/digup/">digup</a></li> <li><a href="/2013/disk-filltest/">disk-filltest</a></li> <li><a href="/2012/1119-eSAIS-Inducing-Suffix-and-LCP-Arrays-in-External-Memory/">eSAIS-LCP</a></li> <li><a href="/2007/flex-bison-cpp-example/">Flex Bison C++ Example</a></li> <li><a href="/2013/malloc_count/">malloc_count</a></li> <li><a href="/2013/parallel-string-sorting/">parallel-string-sorting</a></li> <li><a href="/2013/pmbw/">Parallel Memory Bandwidth</a></li> <li><a href="/2013/sound-of-sorting/">The Sound of Sorting</a></li> <li><a href="/2007/stx-btree/">STX B+ Tree</a></li> <li><a href="/2010/stx-cbtreedb/">STX Constant BTreeDB</a></li> <li><a href="/2010/stx-execpipe/">STX ExecPipe</a></li> <li class="nt"><a href="/2007/stx-exparser/">STX Expression Parser</a></li> <li class="ns"><a href="/search.html">Search</a></li> </ul></li><li class="top"><a class="ni" href="/about/timo.html">About Me</a></li></ul></div><div style="padding: 6px"><a href="/">panthema</a>  / <a href="/2006/">2006</a> / <a href="/2006/SDIOS06/">SDIOS06</a> / <a href="/2006/SDIOS06/sdios06/">sdios06</a> / <a href="/2006/SDIOS06/sdios06/lib/">lib</a> / <a href="/2006/SDIOS06/sdios06/lib/SDL/">SDL</a> / <a href="/2006/SDIOS06/sdios06/lib/SDL/stdlib/">stdlib</a> / <a href="/2006/SDIOS06/sdios06/lib/SDL/stdlib/SDL_qsort.c.html">SDL_qsort.c</a> (<a href="/2006/SDIOS06/sdios06/lib/SDL/stdlib/SDL_qsort.c">Download File</a>)</div></div><div class="ptfullwidth"><pre class="codesnippet" style="font-family: monospace"><tt><span class="comment">/* qsort.c</span>
<span class="comment"> * (c) 1998 Gareth McCaughan</span>
<span class="comment"> *</span>
<span class="comment"> * This is a drop-in replacement for the C library's |qsort()| routine.</span>
<span class="comment"> *</span>
<span class="comment"> * Features:</span>
<span class="comment"> *   - Median-of-three pivoting (and more)</span>
<span class="comment"> *   - Truncation and final polishing by a single insertion sort</span>
<span class="comment"> *   - Early truncation when no swaps needed in pivoting step</span>
<span class="comment"> *   - Explicit recursion, guaranteed not to overflow</span>
<span class="comment"> *   - A few little wrinkles stolen from the GNU |qsort()|.</span>
<span class="comment"> *   - separate code for non-aligned / aligned / word-size objects</span>
<span class="comment"> *</span>
<span class="comment"> * This code may be reproduced freely provided</span>
<span class="comment"> *   - this file is retained unaltered apart from minor</span>
<span class="comment"> *     changes for portability and efficiency</span>
<span class="comment"> *   - no changes are made to this comment</span>
<span class="comment"> *   - any changes that *are* made are clearly flagged</span>
<span class="comment"> *   - the _ID string below is altered by inserting, after</span>
<span class="comment"> *     the date, the string " altered" followed at your option</span>
<span class="comment"> *     by other material. (Exceptions: you may change the name</span>
<span class="comment"> *     of the exported routine without changing the ID string.</span>
<span class="comment"> *     You may change the values of the macros TRUNC_* and</span>
<span class="comment"> *     PIVOT_THRESHOLD without changing the ID string, provided</span>
<span class="comment"> *     they remain constants with TRUNC_nonaligned, TRUNC_aligned</span>
<span class="comment"> *     and TRUNC_words/WORD_BYTES between 8 and 24, and</span>
<span class="comment"> *     PIVOT_THRESHOLD between 32 and 200.)</span>
<span class="comment"> *</span>
<span class="comment"> * You may use it in anything you like; you may make money</span>
<span class="comment"> * out of it; you may distribute it in object form or as</span>
<span class="comment"> * part of an executable without including source code;</span>
<span class="comment"> * you don't have to credit me. (But it would be nice if</span>
<span class="comment"> * you did.)</span>
<span class="comment"> *</span>
<span class="comment"> * If you find problems with this code, or find ways of</span>
<span class="comment"> * making it significantly faster, please let me know!</span>
<span class="comment"> * My e-mail address, valid as of early 1998 and certainly</span>
<span class="comment"> * OK for at least the next 18 months, is</span>
<span class="comment"> *    </span><span class="url">gjm11@dpmms.cam.ac.uk</span>
<span class="comment"> * Thanks!</span>
<span class="comment"> *</span>
<span class="comment"> * Gareth McCaughan   Peterhouse   Cambridge   1998</span>
<span class="comment"> */</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">"SDL_config.h"</span>

<span class="comment">/*</span>
<span class="comment">#include &lt;assert.h&gt;</span>
<span class="comment">#include &lt;stdlib.h&gt;</span>
<span class="comment">#include &lt;string.h&gt;</span>
<span class="comment">*/</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">"SDL_stdinc.h"</span>

<span class="preproc">#define</span><span class="normal"> </span><span class="function">assert</span><span class="symbol">(</span><span class="normal">X</span><span class="symbol">)</span>
<span class="preproc">#define</span><span class="normal"> </span><span class="usertype">malloc</span><span class="normal">	SDL_malloc</span>
<span class="preproc">#define</span><span class="normal"> </span><span class="usertype">free</span><span class="normal">	SDL_free</span>
<span class="preproc">#define</span><span class="normal"> </span><span class="usertype">memcpy</span><span class="normal">	SDL_memcpy</span>
<span class="preproc">#define</span><span class="normal"> </span><span class="usertype">memmove</span><span class="normal">	SDL_memmove</span>
<span class="preproc">#define</span><span class="normal"> </span><span class="usertype">qsort</span><span class="normal">	SDL_qsort</span>


<span class="preproc">#ifndef</span><span class="normal"> HAVE_QSORT</span>

<span class="keyword">static</span><span class="normal"> </span><span class="type">char</span><span class="normal"> _ID</span><span class="symbol">[]=</span><span class="string">"&lt;qsort.c gjm 1.12 1998-03-19&gt;"</span><span class="symbol">;</span>

<span class="comment">/* How many bytes are there per word? (Must be a power of 2,</span>
<span class="comment"> * and must in fact equal sizeof(int).)</span>
<span class="comment"> */</span>
<span class="preproc">#define</span><span class="normal"> </span><span class="usertype">WORD_BYTES</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="type">int</span><span class="symbol">)</span>

<span class="comment">/* How big does our stack need to be? Answer: one entry per</span>
<span class="comment"> * bit in a |size_t|.</span>
<span class="comment"> */</span>
<span class="preproc">#define</span><span class="normal"> </span><span class="function">STACK_SIZE</span><span class="normal"> </span><span class="symbol">(</span><span class="number">8</span><span class="symbol">*</span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="normal">size_t</span><span class="symbol">))</span>

<span class="comment">/* Different situations have slightly different requirements,</span>
<span class="comment"> * and we make life epsilon easier by using different truncation</span>
<span class="comment"> * points for the three different cases.</span>
<span class="comment"> * So far, I have tuned TRUNC_words and guessed that the same</span>
<span class="comment"> * value might work well for the other two cases. Of course</span>
<span class="comment"> * what works well on my machine might work badly on yours.</span>
<span class="comment"> */</span>
<span class="preproc">#define</span><span class="normal"> TRUNC_nonaligned	</span><span class="number">12</span>
<span class="preproc">#define</span><span class="normal"> TRUNC_aligned		</span><span class="number">12</span>
<span class="preproc">#define</span><span class="normal"> TRUNC_words		</span><span class="number">12</span><span class="symbol">*</span><span class="normal">WORD_BYTES	</span><span class="comment">/* nb different meaning */</span>

<span class="comment">/* We use a simple pivoting algorithm for shortish sub-arrays</span>
<span class="comment"> * and a more complicated one for larger ones. The threshold</span>
<span class="comment"> * is PIVOT_THRESHOLD.</span>
<span class="comment"> */</span>
<span class="preproc">#define</span><span class="normal"> PIVOT_THRESHOLD </span><span class="number">40</span>

<span class="keyword">typedef</span><span class="normal"> </span><span class="keyword">struct</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> first</span><span class="symbol">;</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> last</span><span class="symbol">;</span><span class="normal"> </span><span class="cbracket">}</span><span class="normal"> stack_entry</span><span class="symbol">;</span>
<span class="preproc">#define</span><span class="normal"> pushLeft </span><span class="cbracket">{</span><span class="normal">stack</span><span class="symbol">[</span><span class="normal">stacktop</span><span class="symbol">].</span><span class="normal">first</span><span class="symbol">=</span><span class="normal">ffirst</span><span class="symbol">;</span><span class="normal">stack</span><span class="symbol">[</span><span class="normal">stacktop</span><span class="symbol">++].</span><span class="normal">last</span><span class="symbol">=</span><span class="normal">last</span><span class="symbol">;</span><span class="cbracket">}</span>
<span class="preproc">#define</span><span class="normal"> pushRight </span><span class="cbracket">{</span><span class="normal">stack</span><span class="symbol">[</span><span class="normal">stacktop</span><span class="symbol">].</span><span class="normal">first</span><span class="symbol">=</span><span class="normal">first</span><span class="symbol">;</span><span class="normal">stack</span><span class="symbol">[</span><span class="normal">stacktop</span><span class="symbol">++].</span><span class="normal">last</span><span class="symbol">=</span><span class="normal">llast</span><span class="symbol">;</span><span class="cbracket">}</span>
<span class="preproc">#define</span><span class="normal"> doLeft </span><span class="cbracket">{</span><span class="normal">first</span><span class="symbol">=</span><span class="normal">ffirst</span><span class="symbol">;</span><span class="normal">llast</span><span class="symbol">=</span><span class="normal">last</span><span class="symbol">;</span><span class="keyword">continue</span><span class="symbol">;</span><span class="cbracket">}</span>
<span class="preproc">#define</span><span class="normal"> doRight </span><span class="cbracket">{</span><span class="normal">ffirst</span><span class="symbol">=</span><span class="normal">first</span><span class="symbol">;</span><span class="normal">last</span><span class="symbol">=</span><span class="normal">llast</span><span class="symbol">;</span><span class="keyword">continue</span><span class="symbol">;</span><span class="cbracket">}</span>
<span class="preproc">#define</span><span class="normal"> pop </span><span class="cbracket">{</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(--</span><span class="normal">stacktop</span><span class="symbol">&lt;</span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="keyword">break</span><span class="symbol">;\</span>
<span class="normal">  first</span><span class="symbol">=</span><span class="normal">ffirst</span><span class="symbol">=</span><span class="normal">stack</span><span class="symbol">[</span><span class="normal">stacktop</span><span class="symbol">].</span><span class="normal">first</span><span class="symbol">;\</span>
<span class="normal">  last</span><span class="symbol">=</span><span class="normal">llast</span><span class="symbol">=</span><span class="normal">stack</span><span class="symbol">[</span><span class="normal">stacktop</span><span class="symbol">].</span><span class="normal">last</span><span class="symbol">;\</span>
<span class="normal">  </span><span class="keyword">continue</span><span class="symbol">;</span><span class="cbracket">}</span>

<span class="comment">/* Some comments on the implementation.</span>
<span class="comment"> * 1. When we finish partitioning the array into "low"</span>
<span class="comment"> *    and "high", we forget entirely about short subarrays,</span>
<span class="comment"> *    because they'll be done later by insertion sort.</span>
<span class="comment"> *    Doing lots of little insertion sorts might be a win</span>
<span class="comment"> *    on large datasets for locality-of-reference reasons,</span>
<span class="comment"> *    but it makes the code much nastier and increases</span>
<span class="comment"> *    bookkeeping overhead.</span>
<span class="comment"> * 2. We always save the shorter and get to work on the</span>
<span class="comment"> *    longer. This guarantees that every time we push</span>
<span class="comment"> *    an item onto the stack its size is &lt;= 1/2 of that</span>
<span class="comment"> *    of its parent; so the stack can't need more than</span>
<span class="comment"> *    log_2(max-array-size) entries.</span>
<span class="comment"> * 3. We choose a pivot by looking at the first, last</span>
<span class="comment"> *    and middle elements. We arrange them into order</span>
<span class="comment"> *    because it's easy to do that in conjunction with</span>
<span class="comment"> *    choosing the pivot, and it makes things a little</span>
<span class="comment"> *    easier in the partitioning step. Anyway, the pivot</span>
<span class="comment"> *    is the middle of these three. It's still possible</span>
<span class="comment"> *    to construct datasets where the algorithm takes</span>
<span class="comment"> *    time of order n^2, but it simply never happens in</span>
<span class="comment"> *    practice.</span>
<span class="comment"> * 3' Newsflash: On further investigation I find that</span>
<span class="comment"> *    it's easy to construct datasets where median-of-3</span>
<span class="comment"> *    simply isn't good enough. So on large-ish subarrays</span>
<span class="comment"> *    we do a more sophisticated pivoting: we take three</span>
<span class="comment"> *    sets of 3 elements, find their medians, and then</span>
<span class="comment"> *    take the median of those.</span>
<span class="comment"> * 4. We copy the pivot element to a separate place</span>
<span class="comment"> *    because that way we can always do our comparisons</span>
<span class="comment"> *    directly against a pointer to that separate place,</span>
<span class="comment"> *    and don't have to wonder "did we move the pivot</span>
<span class="comment"> *    element?". This makes the inner loop better.</span>
<span class="comment"> * 5. It's possible to make the pivoting even more</span>
<span class="comment"> *    reliable by looking at more candidates when n</span>
<span class="comment"> *    is larger. (Taking this to its logical conclusion</span>
<span class="comment"> *    results in a variant of quicksort that doesn't</span>
<span class="comment"> *    have that n^2 worst case.) However, the overhead</span>
<span class="comment"> *    from the extra bookkeeping means that it's just</span>
<span class="comment"> *    not worth while.</span>
<span class="comment"> * 6. This is pretty clean and portable code. Here are</span>
<span class="comment"> *    all the potential portability pitfalls and problems</span>
<span class="comment"> *    I know of:</span>
<span class="comment"> *      - In one place (the insertion sort) I construct</span>
<span class="comment"> *        a pointer that points just past the end of the</span>
<span class="comment"> *        supplied array, and assume that (a) it won't</span>
<span class="comment"> *        compare equal to any pointer within the array,</span>
<span class="comment"> *        and (b) it will compare equal to a pointer</span>
<span class="comment"> *        obtained by stepping off the end of the array.</span>
<span class="comment"> *        These might fail on some segmented architectures.</span>
<span class="comment"> *      - I assume that there are 8 bits in a |char| when</span>
<span class="comment"> *        computing the size of stack needed. This would</span>
<span class="comment"> *        fail on machines with 9-bit or 16-bit bytes.</span>
<span class="comment"> *      - I assume that if |((int)base&amp;(sizeof(int)-1))==0|</span>
<span class="comment"> *        and |(size&amp;(sizeof(int)-1))==0| then it's safe to</span>
<span class="comment"> *        get at array elements via |int*|s, and that if</span>
<span class="comment"> *        actually |size==sizeof(int)| as well then it's</span>
<span class="comment"> *        safe to treat the elements as |int|s. This might</span>
<span class="comment"> *        fail on systems that convert pointers to integers</span>
<span class="comment"> *        in non-standard ways.</span>
<span class="comment"> *      - I assume that |8*sizeof(size_t)&lt;=INT_MAX|. This</span>
<span class="comment"> *        would be false on a machine with 8-bit |char|s,</span>
<span class="comment"> *        16-bit |int|s and 4096-bit |size_t|s. :-)</span>
<span class="comment"> */</span>

<span class="comment">/* The recursion logic is the same in each case: */</span>
<span class="preproc">#define</span><span class="normal"> </span><span class="function">Recurse</span><span class="symbol">(</span><span class="normal">Trunc</span><span class="symbol">)</span><span class="normal">				</span><span class="symbol">\</span>
<span class="normal">      </span><span class="cbracket">{</span><span class="normal"> </span><span class="usertype">size_t</span><span class="normal"> l</span><span class="symbol">=</span><span class="normal">last</span><span class="symbol">-</span><span class="normal">ffirst</span><span class="symbol">,</span><span class="normal">r</span><span class="symbol">=</span><span class="normal">llast</span><span class="symbol">-</span><span class="normal">first</span><span class="symbol">;</span><span class="normal">	</span><span class="symbol">\</span>
<span class="normal">        </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">l</span><span class="symbol">&lt;</span><span class="normal">Trunc</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal">				</span><span class="symbol">\</span>
<span class="normal">          </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">r</span><span class="symbol">&gt;=</span><span class="normal">Trunc</span><span class="symbol">)</span><span class="normal"> doRight			</span><span class="symbol">\</span>
<span class="normal">          </span><span class="keyword">else</span><span class="normal"> pop				</span><span class="symbol">\</span>
<span class="normal">        </span><span class="cbracket">}</span><span class="normal">					</span><span class="symbol">\</span>
<span class="normal">        </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">l</span><span class="symbol">&lt;=</span><span class="normal">r</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal"> pushLeft</span><span class="symbol">;</span><span class="normal"> doRight </span><span class="cbracket">}</span><span class="normal">	</span><span class="symbol">\</span>
<span class="normal">        </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">r</span><span class="symbol">&gt;=</span><span class="normal">Trunc</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal"> pushRight</span><span class="symbol">;</span><span class="normal"> doLeft </span><span class="cbracket">}</span><span class="symbol">\</span>
<span class="normal">        </span><span class="keyword">else</span><span class="normal"> doLeft				</span><span class="symbol">\</span>
<span class="normal">      </span><span class="cbracket">}</span>

<span class="comment">/* and so is the pivoting logic: */</span>
<span class="preproc">#define</span><span class="normal"> </span><span class="function">Pivot</span><span class="symbol">(</span><span class="normal">swapper</span><span class="symbol">,</span><span class="normal">sz</span><span class="symbol">)</span><span class="normal">			</span><span class="symbol">\</span>
<span class="normal">  </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">size_t</span><span class="symbol">)(</span><span class="normal">last</span><span class="symbol">-</span><span class="normal">first</span><span class="symbol">)&gt;</span><span class="normal">PIVOT_THRESHOLD</span><span class="symbol">*</span><span class="normal">sz</span><span class="symbol">)</span><span class="normal"> mid</span><span class="symbol">=</span><span class="function">pivot_big</span><span class="symbol">(</span><span class="normal">first</span><span class="symbol">,</span><span class="normal">mid</span><span class="symbol">,</span><span class="normal">last</span><span class="symbol">,</span><span class="normal">sz</span><span class="symbol">,</span><span class="normal">compare</span><span class="symbol">);\</span>
<span class="normal">  </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal">	</span><span class="symbol">\</span>
<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">compare</span><span class="symbol">(</span><span class="normal">first</span><span class="symbol">,</span><span class="normal">mid</span><span class="symbol">)&lt;</span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal">			</span><span class="symbol">\</span>
<span class="normal">      </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">compare</span><span class="symbol">(</span><span class="normal">mid</span><span class="symbol">,</span><span class="normal">last</span><span class="symbol">)&gt;</span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal">		</span><span class="symbol">\</span>
<span class="normal">        </span><span class="function">swapper</span><span class="symbol">(</span><span class="normal">mid</span><span class="symbol">,</span><span class="normal">last</span><span class="symbol">);</span><span class="normal">			</span><span class="symbol">\</span>
<span class="normal">        </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">compare</span><span class="symbol">(</span><span class="normal">first</span><span class="symbol">,</span><span class="normal">mid</span><span class="symbol">)&gt;</span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="function">swapper</span><span class="symbol">(</span><span class="normal">first</span><span class="symbol">,</span><span class="normal">mid</span><span class="symbol">);\</span>
<span class="normal">      </span><span class="cbracket">}</span><span class="normal">						</span><span class="symbol">\</span>
<span class="normal">    </span><span class="cbracket">}</span><span class="normal">						</span><span class="symbol">\</span>
<span class="normal">    </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal">					</span><span class="symbol">\</span>
<span class="normal">      </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">compare</span><span class="symbol">(</span><span class="normal">mid</span><span class="symbol">,</span><span class="normal">last</span><span class="symbol">)&gt;</span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="function">swapper</span><span class="symbol">(</span><span class="normal">first</span><span class="symbol">,</span><span class="normal">last</span><span class="symbol">)\</span>
<span class="normal">      </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal">					</span><span class="symbol">\</span>
<span class="normal">        </span><span class="function">swapper</span><span class="symbol">(</span><span class="normal">first</span><span class="symbol">,</span><span class="normal">mid</span><span class="symbol">);</span><span class="normal">			</span><span class="symbol">\</span>
<span class="normal">        </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">compare</span><span class="symbol">(</span><span class="normal">mid</span><span class="symbol">,</span><span class="normal">last</span><span class="symbol">)&gt;</span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="function">swapper</span><span class="symbol">(</span><span class="normal">mid</span><span class="symbol">,</span><span class="normal">last</span><span class="symbol">);\</span>
<span class="normal">      </span><span class="cbracket">}</span><span class="normal">						</span><span class="symbol">\</span>
<span class="normal">    </span><span class="cbracket">}</span><span class="normal">						</span><span class="symbol">\</span>
<span class="normal">    first</span><span class="symbol">+=</span><span class="normal">sz</span><span class="symbol">;</span><span class="normal"> last</span><span class="symbol">-=</span><span class="normal">sz</span><span class="symbol">;</span><span class="normal">			</span><span class="symbol">\</span>
<span class="normal">  </span><span class="cbracket">}</span>

<span class="preproc">#ifdef</span><span class="normal"> DEBUG_QSORT</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">&lt;stdio.h&gt;</span>
<span class="preproc">#endif</span>

<span class="comment">/* and so is the partitioning logic: */</span>
<span class="preproc">#define</span><span class="normal"> </span><span class="function">Partition</span><span class="symbol">(</span><span class="normal">swapper</span><span class="symbol">,</span><span class="normal">sz</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal">			</span><span class="symbol">\</span>
<span class="normal">  </span><span class="type">int</span><span class="normal"> swapped</span><span class="symbol">=</span><span class="number">0</span><span class="symbol">;</span><span class="normal">				</span><span class="symbol">\</span>
<span class="normal">  </span><span class="keyword">do</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal">						</span><span class="symbol">\</span>
<span class="normal">    </span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="function">compare</span><span class="symbol">(</span><span class="normal">first</span><span class="symbol">,</span><span class="normal">pivot</span><span class="symbol">)&lt;</span><span class="number">0</span><span class="symbol">)</span><span class="normal"> first</span><span class="symbol">+=</span><span class="normal">sz</span><span class="symbol">;</span><span class="normal">	</span><span class="symbol">\</span>
<span class="normal">    </span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="function">compare</span><span class="symbol">(</span><span class="normal">pivot</span><span class="symbol">,</span><span class="normal">last</span><span class="symbol">)&lt;</span><span class="number">0</span><span class="symbol">)</span><span class="normal"> last</span><span class="symbol">-=</span><span class="normal">sz</span><span class="symbol">;</span><span class="normal">	</span><span class="symbol">\</span>
<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">first</span><span class="symbol">&lt;</span><span class="normal">last</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal">				</span><span class="symbol">\</span>
<span class="normal">      </span><span class="function">swapper</span><span class="symbol">(</span><span class="normal">first</span><span class="symbol">,</span><span class="normal">last</span><span class="symbol">);</span><span class="normal"> swapped</span><span class="symbol">=</span><span class="number">1</span><span class="symbol">;</span><span class="normal">		</span><span class="symbol">\</span>
<span class="normal">      first</span><span class="symbol">+=</span><span class="normal">sz</span><span class="symbol">;</span><span class="normal"> last</span><span class="symbol">-=</span><span class="normal">sz</span><span class="symbol">;</span><span class="normal"> </span><span class="cbracket">}</span><span class="normal">			</span><span class="symbol">\</span>
<span class="normal">    </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">first</span><span class="symbol">==</span><span class="normal">last</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal"> first</span><span class="symbol">+=</span><span class="normal">sz</span><span class="symbol">;</span><span class="normal"> last</span><span class="symbol">-=</span><span class="normal">sz</span><span class="symbol">;</span><span class="normal"> </span><span class="keyword">break</span><span class="symbol">;</span><span class="normal"> </span><span class="cbracket">}</span><span class="symbol">\</span>
<span class="normal">  </span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">first</span><span class="symbol">&lt;=</span><span class="normal">last</span><span class="symbol">);</span><span class="normal">			</span><span class="symbol">\</span>
<span class="normal">  </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">swapped</span><span class="symbol">)</span><span class="normal"> pop				</span><span class="symbol">\</span>
<span class="cbracket">}</span>

<span class="comment">/* and so is the pre-insertion-sort operation of putting</span>
<span class="comment"> * the smallest element into place as a sentinel.</span>
<span class="comment"> * Doing this makes the inner loop nicer. I got this</span>
<span class="comment"> * idea from the GNU implementation of qsort().</span>
<span class="comment"> */</span>
<span class="preproc">#define</span><span class="normal"> </span><span class="function">PreInsertion</span><span class="symbol">(</span><span class="normal">swapper</span><span class="symbol">,</span><span class="normal">limit</span><span class="symbol">,</span><span class="normal">sz</span><span class="symbol">)</span><span class="normal">		</span><span class="symbol">\</span>
<span class="normal">  first</span><span class="symbol">=</span><span class="normal">base</span><span class="symbol">;</span><span class="normal">					</span><span class="symbol">\</span>
<span class="normal">  last</span><span class="symbol">=</span><span class="normal">first </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">nmemb</span><span class="symbol">&gt;</span><span class="normal">limit </span><span class="symbol">?</span><span class="normal"> limit </span><span class="symbol">:</span><span class="normal"> nmemb</span><span class="symbol">-</span><span class="number">1</span><span class="symbol">)*</span><span class="normal">sz</span><span class="symbol">;\</span>
<span class="normal">  </span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">last</span><span class="symbol">!=</span><span class="normal">base</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal">				</span><span class="symbol">\</span>
<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">compare</span><span class="symbol">(</span><span class="normal">first</span><span class="symbol">,</span><span class="normal">last</span><span class="symbol">)&gt;</span><span class="number">0</span><span class="symbol">)</span><span class="normal"> first</span><span class="symbol">=</span><span class="normal">last</span><span class="symbol">;</span><span class="normal">	</span><span class="symbol">\</span>
<span class="normal">    last</span><span class="symbol">-=</span><span class="normal">sz</span><span class="symbol">;</span><span class="normal"> </span><span class="cbracket">}</span><span class="normal">					</span><span class="symbol">\</span>
<span class="normal">  </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">first</span><span class="symbol">!=</span><span class="normal">base</span><span class="symbol">)</span><span class="normal"> </span><span class="function">swapper</span><span class="symbol">(</span><span class="normal">first</span><span class="symbol">,(</span><span class="type">char</span><span class="symbol">*)</span><span class="normal">base</span><span class="symbol">);</span>

<span class="comment">/* and so is the insertion sort, in the first two cases: */</span>
<span class="preproc">#define</span><span class="normal"> </span><span class="function">Insertion</span><span class="symbol">(</span><span class="normal">swapper</span><span class="symbol">)</span><span class="normal">			</span><span class="symbol">\</span>
<span class="normal">  last</span><span class="symbol">=((</span><span class="type">char</span><span class="symbol">*)</span><span class="normal">base</span><span class="symbol">)+</span><span class="normal">nmemb</span><span class="symbol">*</span><span class="normal">size</span><span class="symbol">;</span><span class="normal">		</span><span class="symbol">\</span>
<span class="normal">  </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">first</span><span class="symbol">=((</span><span class="type">char</span><span class="symbol">*)</span><span class="normal">base</span><span class="symbol">)+</span><span class="normal">size</span><span class="symbol">;</span><span class="normal">first</span><span class="symbol">!=</span><span class="normal">last</span><span class="symbol">;</span><span class="normal">first</span><span class="symbol">+=</span><span class="normal">size</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal">	</span><span class="symbol">\</span>
<span class="normal">    </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">test</span><span class="symbol">;</span><span class="normal">					</span><span class="symbol">\</span>
<span class="normal">    </span><span class="comment">/* Find the right place for |first|.	\</span>
<span class="comment">     * My apologies for var reuse. */</span><span class="normal">		</span><span class="symbol">\</span>
<span class="normal">    </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">test</span><span class="symbol">=</span><span class="normal">first</span><span class="symbol">-</span><span class="normal">size</span><span class="symbol">;</span><span class="function">compare</span><span class="symbol">(</span><span class="normal">test</span><span class="symbol">,</span><span class="normal">first</span><span class="symbol">)&gt;</span><span class="number">0</span><span class="symbol">;</span><span class="normal">test</span><span class="symbol">-=</span><span class="normal">size</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">;</span><span class="normal">	</span><span class="symbol">\</span>
<span class="normal">    test</span><span class="symbol">+=</span><span class="normal">size</span><span class="symbol">;</span><span class="normal">					</span><span class="symbol">\</span>
<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">test</span><span class="symbol">!=</span><span class="normal">first</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal">				</span><span class="symbol">\</span>
<span class="normal">      </span><span class="comment">/* Shift everything in [test,first)	\</span>
<span class="comment">       * up by one, and place |first|		\</span>
<span class="comment">       * where |test| is. */</span><span class="normal">			</span><span class="symbol">\</span>
<span class="normal">      </span><span class="function">memcpy</span><span class="symbol">(</span><span class="normal">pivot</span><span class="symbol">,</span><span class="normal">first</span><span class="symbol">,</span><span class="normal">size</span><span class="symbol">);</span><span class="normal">			</span><span class="symbol">\</span>
<span class="normal">      </span><span class="function">memmove</span><span class="symbol">(</span><span class="normal">test</span><span class="symbol">+</span><span class="normal">size</span><span class="symbol">,</span><span class="normal">test</span><span class="symbol">,</span><span class="normal">first</span><span class="symbol">-</span><span class="normal">test</span><span class="symbol">);</span><span class="normal">	</span><span class="symbol">\</span>
<span class="normal">      </span><span class="function">memcpy</span><span class="symbol">(</span><span class="normal">test</span><span class="symbol">,</span><span class="normal">pivot</span><span class="symbol">,</span><span class="normal">size</span><span class="symbol">);</span><span class="normal">			</span><span class="symbol">\</span>
<span class="normal">    </span><span class="cbracket">}</span><span class="normal">						</span><span class="symbol">\</span>
<span class="normal">  </span><span class="cbracket">}</span>

<span class="preproc">#define</span><span class="normal"> </span><span class="function">SWAP_nonaligned</span><span class="symbol">(</span><span class="normal">a</span><span class="symbol">,</span><span class="normal">b</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">  </span><span class="keyword">register</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">aa</span><span class="symbol">=(</span><span class="normal">a</span><span class="symbol">),*</span><span class="normal">bb</span><span class="symbol">=(</span><span class="normal">b</span><span class="symbol">);</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">  </span><span class="keyword">register</span><span class="normal"> </span><span class="usertype">size_t</span><span class="normal"> sz</span><span class="symbol">=</span><span class="normal">size</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">  </span><span class="keyword">do</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal"> </span><span class="keyword">register</span><span class="normal"> </span><span class="type">char</span><span class="normal"> t</span><span class="symbol">=*</span><span class="normal">aa</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">aa</span><span class="symbol">++=*</span><span class="normal">bb</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">bb</span><span class="symbol">++=</span><span class="normal">t</span><span class="symbol">;</span><span class="normal"> </span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(--</span><span class="normal">sz</span><span class="symbol">);</span><span class="normal"> </span><span class="cbracket">}</span>

<span class="preproc">#define</span><span class="normal"> </span><span class="function">SWAP_aligned</span><span class="symbol">(</span><span class="normal">a</span><span class="symbol">,</span><span class="normal">b</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">  </span><span class="keyword">register</span><span class="normal"> </span><span class="type">int</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">aa</span><span class="symbol">=(</span><span class="type">int</span><span class="symbol">*)(</span><span class="normal">a</span><span class="symbol">),*</span><span class="normal">bb</span><span class="symbol">=(</span><span class="type">int</span><span class="symbol">*)(</span><span class="normal">b</span><span class="symbol">);</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">  </span><span class="keyword">register</span><span class="normal"> </span><span class="usertype">size_t</span><span class="normal"> sz</span><span class="symbol">=</span><span class="normal">size</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">  </span><span class="keyword">do</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal"> </span><span class="keyword">register</span><span class="normal"> </span><span class="type">int</span><span class="normal"> t</span><span class="symbol">=*</span><span class="normal">aa</span><span class="symbol">;*</span><span class="normal">aa</span><span class="symbol">++=*</span><span class="normal">bb</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">bb</span><span class="symbol">++=</span><span class="normal">t</span><span class="symbol">;</span><span class="normal"> </span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">sz</span><span class="symbol">-=</span><span class="normal">WORD_BYTES</span><span class="symbol">);</span><span class="normal"> </span><span class="cbracket">}</span>

<span class="preproc">#define</span><span class="normal"> </span><span class="function">SWAP_words</span><span class="symbol">(</span><span class="normal">a</span><span class="symbol">,</span><span class="normal">b</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">  </span><span class="keyword">register</span><span class="normal"> </span><span class="type">int</span><span class="normal"> t</span><span class="symbol">=*((</span><span class="type">int</span><span class="symbol">*)</span><span class="normal">a</span><span class="symbol">);</span><span class="normal"> </span><span class="symbol">*((</span><span class="type">int</span><span class="symbol">*)</span><span class="normal">a</span><span class="symbol">)=*((</span><span class="type">int</span><span class="symbol">*)</span><span class="normal">b</span><span class="symbol">);</span><span class="normal"> </span><span class="symbol">*((</span><span class="type">int</span><span class="symbol">*)</span><span class="normal">b</span><span class="symbol">)=</span><span class="normal">t</span><span class="symbol">;</span><span class="normal"> </span><span class="cbracket">}</span>

<span class="comment">/* ---------------------------------------------------------------------- */</span>

<span class="keyword">static</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> </span><span class="function">pivot_big</span><span class="symbol">(</span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">first</span><span class="symbol">,</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">mid</span><span class="symbol">,</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">last</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">size_t</span><span class="normal"> size</span><span class="symbol">,</span>
<span class="normal">                        </span><span class="type">int</span><span class="normal"> </span><span class="function">compare</span><span class="symbol">(</span><span class="keyword">const</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="symbol">*,</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="symbol">*))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">  </span><span class="usertype">size_t</span><span class="normal"> d</span><span class="symbol">=(((</span><span class="normal">last</span><span class="symbol">-</span><span class="normal">first</span><span class="symbol">)/</span><span class="normal">size</span><span class="symbol">)&gt;&gt;</span><span class="number">3</span><span class="symbol">)*</span><span class="normal">size</span><span class="symbol">;</span>
<span class="normal">  </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">m1</span><span class="symbol">,*</span><span class="normal">m2</span><span class="symbol">,*</span><span class="normal">m3</span><span class="symbol">;</span>
<span class="normal">  </span><span class="cbracket">{</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">a</span><span class="symbol">=</span><span class="normal">first</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">b</span><span class="symbol">=</span><span class="normal">first</span><span class="symbol">+</span><span class="normal">d</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">c</span><span class="symbol">=</span><span class="normal">first</span><span class="symbol">+</span><span class="number">2</span><span class="symbol">*</span><span class="normal">d</span><span class="symbol">;</span>
<span class="preproc">#ifdef</span><span class="normal"> DEBUG_QSORT</span>
<span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="string">"&lt; %d %d %d</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,*(</span><span class="type">int</span><span class="symbol">*)</span><span class="normal">a</span><span class="symbol">,*(</span><span class="type">int</span><span class="symbol">*)</span><span class="normal">b</span><span class="symbol">,*(</span><span class="type">int</span><span class="symbol">*)</span><span class="normal">c</span><span class="symbol">);</span>
<span class="preproc">#endif</span>
<span class="normal">    m1 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">compare</span><span class="symbol">(</span><span class="normal">a</span><span class="symbol">,</span><span class="normal">b</span><span class="symbol">)&lt;</span><span class="number">0</span><span class="normal"> </span><span class="symbol">?</span>
<span class="normal">           </span><span class="symbol">(</span><span class="function">compare</span><span class="symbol">(</span><span class="normal">b</span><span class="symbol">,</span><span class="normal">c</span><span class="symbol">)&lt;</span><span class="number">0</span><span class="normal"> </span><span class="symbol">?</span><span class="normal"> b </span><span class="symbol">:</span><span class="normal"> </span><span class="symbol">(</span><span class="function">compare</span><span class="symbol">(</span><span class="normal">a</span><span class="symbol">,</span><span class="normal">c</span><span class="symbol">)&lt;</span><span class="number">0</span><span class="normal"> </span><span class="symbol">?</span><span class="normal"> c </span><span class="symbol">:</span><span class="normal"> a</span><span class="symbol">))</span>
<span class="normal">         </span><span class="symbol">:</span><span class="normal"> </span><span class="symbol">(</span><span class="function">compare</span><span class="symbol">(</span><span class="normal">a</span><span class="symbol">,</span><span class="normal">c</span><span class="symbol">)&lt;</span><span class="number">0</span><span class="normal"> </span><span class="symbol">?</span><span class="normal"> a </span><span class="symbol">:</span><span class="normal"> </span><span class="symbol">(</span><span class="function">compare</span><span class="symbol">(</span><span class="normal">b</span><span class="symbol">,</span><span class="normal">c</span><span class="symbol">)&lt;</span><span class="number">0</span><span class="normal"> </span><span class="symbol">?</span><span class="normal"> c </span><span class="symbol">:</span><span class="normal"> b</span><span class="symbol">));</span>
<span class="normal">  </span><span class="cbracket">}</span>
<span class="normal">  </span><span class="cbracket">{</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">a</span><span class="symbol">=</span><span class="normal">mid</span><span class="symbol">-</span><span class="normal">d</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">b</span><span class="symbol">=</span><span class="normal">mid</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">c</span><span class="symbol">=</span><span class="normal">mid</span><span class="symbol">+</span><span class="normal">d</span><span class="symbol">;</span>
<span class="preproc">#ifdef</span><span class="normal"> DEBUG_QSORT</span>
<span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="string">". %d %d %d</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,*(</span><span class="type">int</span><span class="symbol">*)</span><span class="normal">a</span><span class="symbol">,*(</span><span class="type">int</span><span class="symbol">*)</span><span class="normal">b</span><span class="symbol">,*(</span><span class="type">int</span><span class="symbol">*)</span><span class="normal">c</span><span class="symbol">);</span>
<span class="preproc">#endif</span>
<span class="normal">    m2 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">compare</span><span class="symbol">(</span><span class="normal">a</span><span class="symbol">,</span><span class="normal">b</span><span class="symbol">)&lt;</span><span class="number">0</span><span class="normal"> </span><span class="symbol">?</span>
<span class="normal">           </span><span class="symbol">(</span><span class="function">compare</span><span class="symbol">(</span><span class="normal">b</span><span class="symbol">,</span><span class="normal">c</span><span class="symbol">)&lt;</span><span class="number">0</span><span class="normal"> </span><span class="symbol">?</span><span class="normal"> b </span><span class="symbol">:</span><span class="normal"> </span><span class="symbol">(</span><span class="function">compare</span><span class="symbol">(</span><span class="normal">a</span><span class="symbol">,</span><span class="normal">c</span><span class="symbol">)&lt;</span><span class="number">0</span><span class="normal"> </span><span class="symbol">?</span><span class="normal"> c </span><span class="symbol">:</span><span class="normal"> a</span><span class="symbol">))</span>
<span class="normal">         </span><span class="symbol">:</span><span class="normal"> </span><span class="symbol">(</span><span class="function">compare</span><span class="symbol">(</span><span class="normal">a</span><span class="symbol">,</span><span class="normal">c</span><span class="symbol">)&lt;</span><span class="number">0</span><span class="normal"> </span><span class="symbol">?</span><span class="normal"> a </span><span class="symbol">:</span><span class="normal"> </span><span class="symbol">(</span><span class="function">compare</span><span class="symbol">(</span><span class="normal">b</span><span class="symbol">,</span><span class="normal">c</span><span class="symbol">)&lt;</span><span class="number">0</span><span class="normal"> </span><span class="symbol">?</span><span class="normal"> c </span><span class="symbol">:</span><span class="normal"> b</span><span class="symbol">));</span>
<span class="normal">  </span><span class="cbracket">}</span>
<span class="normal">  </span><span class="cbracket">{</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">a</span><span class="symbol">=</span><span class="normal">last</span><span class="symbol">-</span><span class="number">2</span><span class="symbol">*</span><span class="normal">d</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">b</span><span class="symbol">=</span><span class="normal">last</span><span class="symbol">-</span><span class="normal">d</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">c</span><span class="symbol">=</span><span class="normal">last</span><span class="symbol">;</span>
<span class="preproc">#ifdef</span><span class="normal"> DEBUG_QSORT</span>
<span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="string">"&gt; %d %d %d</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,*(</span><span class="type">int</span><span class="symbol">*)</span><span class="normal">a</span><span class="symbol">,*(</span><span class="type">int</span><span class="symbol">*)</span><span class="normal">b</span><span class="symbol">,*(</span><span class="type">int</span><span class="symbol">*)</span><span class="normal">c</span><span class="symbol">);</span>
<span class="preproc">#endif</span>
<span class="normal">    m3 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">compare</span><span class="symbol">(</span><span class="normal">a</span><span class="symbol">,</span><span class="normal">b</span><span class="symbol">)&lt;</span><span class="number">0</span><span class="normal"> </span><span class="symbol">?</span>
<span class="normal">           </span><span class="symbol">(</span><span class="function">compare</span><span class="symbol">(</span><span class="normal">b</span><span class="symbol">,</span><span class="normal">c</span><span class="symbol">)&lt;</span><span class="number">0</span><span class="normal"> </span><span class="symbol">?</span><span class="normal"> b </span><span class="symbol">:</span><span class="normal"> </span><span class="symbol">(</span><span class="function">compare</span><span class="symbol">(</span><span class="normal">a</span><span class="symbol">,</span><span class="normal">c</span><span class="symbol">)&lt;</span><span class="number">0</span><span class="normal"> </span><span class="symbol">?</span><span class="normal"> c </span><span class="symbol">:</span><span class="normal"> a</span><span class="symbol">))</span>
<span class="normal">         </span><span class="symbol">:</span><span class="normal"> </span><span class="symbol">(</span><span class="function">compare</span><span class="symbol">(</span><span class="normal">a</span><span class="symbol">,</span><span class="normal">c</span><span class="symbol">)&lt;</span><span class="number">0</span><span class="normal"> </span><span class="symbol">?</span><span class="normal"> a </span><span class="symbol">:</span><span class="normal"> </span><span class="symbol">(</span><span class="function">compare</span><span class="symbol">(</span><span class="normal">b</span><span class="symbol">,</span><span class="normal">c</span><span class="symbol">)&lt;</span><span class="number">0</span><span class="normal"> </span><span class="symbol">?</span><span class="normal"> c </span><span class="symbol">:</span><span class="normal"> b</span><span class="symbol">));</span>
<span class="normal">  </span><span class="cbracket">}</span>
<span class="preproc">#ifdef</span><span class="normal"> DEBUG_QSORT</span>
<span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="string">"-&gt; %d %d %d</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,*(</span><span class="type">int</span><span class="symbol">*)</span><span class="normal">m1</span><span class="symbol">,*(</span><span class="type">int</span><span class="symbol">*)</span><span class="normal">m2</span><span class="symbol">,*(</span><span class="type">int</span><span class="symbol">*)</span><span class="normal">m3</span><span class="symbol">);</span>
<span class="preproc">#endif</span>
<span class="normal">  </span><span class="keyword">return</span><span class="normal"> </span><span class="function">compare</span><span class="symbol">(</span><span class="normal">m1</span><span class="symbol">,</span><span class="normal">m2</span><span class="symbol">)&lt;</span><span class="number">0</span><span class="normal"> </span><span class="symbol">?</span>
<span class="normal">           </span><span class="symbol">(</span><span class="function">compare</span><span class="symbol">(</span><span class="normal">m2</span><span class="symbol">,</span><span class="normal">m3</span><span class="symbol">)&lt;</span><span class="number">0</span><span class="normal"> </span><span class="symbol">?</span><span class="normal"> m2 </span><span class="symbol">:</span><span class="normal"> </span><span class="symbol">(</span><span class="function">compare</span><span class="symbol">(</span><span class="normal">m1</span><span class="symbol">,</span><span class="normal">m3</span><span class="symbol">)&lt;</span><span class="number">0</span><span class="normal"> </span><span class="symbol">?</span><span class="normal"> m3 </span><span class="symbol">:</span><span class="normal"> m1</span><span class="symbol">))</span>
<span class="normal">         </span><span class="symbol">:</span><span class="normal"> </span><span class="symbol">(</span><span class="function">compare</span><span class="symbol">(</span><span class="normal">m1</span><span class="symbol">,</span><span class="normal">m3</span><span class="symbol">)&lt;</span><span class="number">0</span><span class="normal"> </span><span class="symbol">?</span><span class="normal"> m1 </span><span class="symbol">:</span><span class="normal"> </span><span class="symbol">(</span><span class="function">compare</span><span class="symbol">(</span><span class="normal">m2</span><span class="symbol">,</span><span class="normal">m3</span><span class="symbol">)&lt;</span><span class="number">0</span><span class="normal"> </span><span class="symbol">?</span><span class="normal"> m3 </span><span class="symbol">:</span><span class="normal"> m2</span><span class="symbol">));</span>
<span class="cbracket">}</span>

<span class="comment">/* ---------------------------------------------------------------------- */</span>

<span class="keyword">static</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="function">qsort_nonaligned</span><span class="symbol">(</span><span class="type">void</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">base</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">size_t</span><span class="normal"> nmemb</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">size_t</span><span class="normal"> size</span><span class="symbol">,</span>
<span class="normal">           </span><span class="type">int</span><span class="normal"> </span><span class="symbol">(*</span><span class="normal">compare</span><span class="symbol">)(</span><span class="keyword">const</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="symbol">*,</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="symbol">*))</span><span class="normal"> </span><span class="cbracket">{</span>

<span class="normal">  </span><span class="usertype">stack_entry</span><span class="normal"> stack</span><span class="symbol">[</span><span class="normal">STACK_SIZE</span><span class="symbol">];</span>
<span class="normal">  </span><span class="type">int</span><span class="normal"> stacktop</span><span class="symbol">=</span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">  </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">first</span><span class="symbol">,*</span><span class="normal">last</span><span class="symbol">;</span>
<span class="normal">  </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">pivot</span><span class="symbol">=</span><span class="function">malloc</span><span class="symbol">(</span><span class="normal">size</span><span class="symbol">);</span>
<span class="normal">  </span><span class="usertype">size_t</span><span class="normal"> trunc</span><span class="symbol">=</span><span class="normal">TRUNC_nonaligned</span><span class="symbol">*</span><span class="normal">size</span><span class="symbol">;</span>
<span class="normal">  </span><span class="function">assert</span><span class="symbol">(</span><span class="normal">pivot</span><span class="symbol">!=</span><span class="number">0</span><span class="symbol">);</span>

<span class="normal">  first</span><span class="symbol">=(</span><span class="type">char</span><span class="symbol">*)</span><span class="normal">base</span><span class="symbol">;</span><span class="normal"> last</span><span class="symbol">=</span><span class="normal">first</span><span class="symbol">+(</span><span class="normal">nmemb</span><span class="symbol">-</span><span class="number">1</span><span class="symbol">)*</span><span class="normal">size</span><span class="symbol">;</span>

<span class="normal">  </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">size_t</span><span class="symbol">)(</span><span class="normal">last</span><span class="symbol">-</span><span class="normal">first</span><span class="symbol">)&gt;</span><span class="normal">trunc</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">    </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">ffirst</span><span class="symbol">=</span><span class="normal">first</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">llast</span><span class="symbol">=</span><span class="normal">last</span><span class="symbol">;</span>
<span class="normal">    </span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="comment">/* Select pivot */</span>
<span class="normal">      </span><span class="cbracket">{</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> mid</span><span class="symbol">=</span><span class="normal">first</span><span class="symbol">+</span><span class="normal">size</span><span class="symbol">*((</span><span class="normal">last</span><span class="symbol">-</span><span class="normal">first</span><span class="symbol">)/</span><span class="normal">size </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">        </span><span class="function">Pivot</span><span class="symbol">(</span><span class="normal">SWAP_nonaligned</span><span class="symbol">,</span><span class="normal">size</span><span class="symbol">);</span>
<span class="normal">        </span><span class="function">memcpy</span><span class="symbol">(</span><span class="normal">pivot</span><span class="symbol">,</span><span class="normal">mid</span><span class="symbol">,</span><span class="normal">size</span><span class="symbol">);</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="comment">/* Partition. */</span>
<span class="normal">      </span><span class="function">Partition</span><span class="symbol">(</span><span class="normal">SWAP_nonaligned</span><span class="symbol">,</span><span class="normal">size</span><span class="symbol">);</span>
<span class="normal">      </span><span class="comment">/* Prepare to recurse/iterate. */</span>
<span class="normal">      </span><span class="function">Recurse</span><span class="symbol">(</span><span class="normal">trunc</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="normal">  </span><span class="cbracket">}</span>
<span class="normal">  </span><span class="function">PreInsertion</span><span class="symbol">(</span><span class="normal">SWAP_nonaligned</span><span class="symbol">,</span><span class="normal">TRUNC_nonaligned</span><span class="symbol">,</span><span class="normal">size</span><span class="symbol">);</span>
<span class="normal">  </span><span class="function">Insertion</span><span class="symbol">(</span><span class="normal">SWAP_nonaligned</span><span class="symbol">);</span>
<span class="normal">  </span><span class="function">free</span><span class="symbol">(</span><span class="normal">pivot</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="keyword">static</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="function">qsort_aligned</span><span class="symbol">(</span><span class="type">void</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">base</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">size_t</span><span class="normal"> nmemb</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">size_t</span><span class="normal"> size</span><span class="symbol">,</span>
<span class="normal">           </span><span class="type">int</span><span class="normal"> </span><span class="symbol">(*</span><span class="normal">compare</span><span class="symbol">)(</span><span class="keyword">const</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="symbol">*,</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="symbol">*))</span><span class="normal"> </span><span class="cbracket">{</span>

<span class="normal">  </span><span class="usertype">stack_entry</span><span class="normal"> stack</span><span class="symbol">[</span><span class="normal">STACK_SIZE</span><span class="symbol">];</span>
<span class="normal">  </span><span class="type">int</span><span class="normal"> stacktop</span><span class="symbol">=</span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">  </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">first</span><span class="symbol">,*</span><span class="normal">last</span><span class="symbol">;</span>
<span class="normal">  </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">pivot</span><span class="symbol">=</span><span class="function">malloc</span><span class="symbol">(</span><span class="normal">size</span><span class="symbol">);</span>
<span class="normal">  </span><span class="usertype">size_t</span><span class="normal"> trunc</span><span class="symbol">=</span><span class="normal">TRUNC_aligned</span><span class="symbol">*</span><span class="normal">size</span><span class="symbol">;</span>
<span class="normal">  </span><span class="function">assert</span><span class="symbol">(</span><span class="normal">pivot</span><span class="symbol">!=</span><span class="number">0</span><span class="symbol">);</span>

<span class="normal">  first</span><span class="symbol">=(</span><span class="type">char</span><span class="symbol">*)</span><span class="normal">base</span><span class="symbol">;</span><span class="normal"> last</span><span class="symbol">=</span><span class="normal">first</span><span class="symbol">+(</span><span class="normal">nmemb</span><span class="symbol">-</span><span class="number">1</span><span class="symbol">)*</span><span class="normal">size</span><span class="symbol">;</span>

<span class="normal">  </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">size_t</span><span class="symbol">)(</span><span class="normal">last</span><span class="symbol">-</span><span class="normal">first</span><span class="symbol">)&gt;</span><span class="normal">trunc</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">    </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">ffirst</span><span class="symbol">=</span><span class="normal">first</span><span class="symbol">,*</span><span class="normal">llast</span><span class="symbol">=</span><span class="normal">last</span><span class="symbol">;</span>
<span class="normal">    </span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="comment">/* Select pivot */</span>
<span class="normal">      </span><span class="cbracket">{</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> mid</span><span class="symbol">=</span><span class="normal">first</span><span class="symbol">+</span><span class="normal">size</span><span class="symbol">*((</span><span class="normal">last</span><span class="symbol">-</span><span class="normal">first</span><span class="symbol">)/</span><span class="normal">size </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">        </span><span class="function">Pivot</span><span class="symbol">(</span><span class="normal">SWAP_aligned</span><span class="symbol">,</span><span class="normal">size</span><span class="symbol">);</span>
<span class="normal">        </span><span class="function">memcpy</span><span class="symbol">(</span><span class="normal">pivot</span><span class="symbol">,</span><span class="normal">mid</span><span class="symbol">,</span><span class="normal">size</span><span class="symbol">);</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="comment">/* Partition. */</span>
<span class="normal">      </span><span class="function">Partition</span><span class="symbol">(</span><span class="normal">SWAP_aligned</span><span class="symbol">,</span><span class="normal">size</span><span class="symbol">);</span>
<span class="normal">      </span><span class="comment">/* Prepare to recurse/iterate. */</span>
<span class="normal">      </span><span class="function">Recurse</span><span class="symbol">(</span><span class="normal">trunc</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="normal">  </span><span class="cbracket">}</span>
<span class="normal">  </span><span class="function">PreInsertion</span><span class="symbol">(</span><span class="normal">SWAP_aligned</span><span class="symbol">,</span><span class="normal">TRUNC_aligned</span><span class="symbol">,</span><span class="normal">size</span><span class="symbol">);</span>
<span class="normal">  </span><span class="function">Insertion</span><span class="symbol">(</span><span class="normal">SWAP_aligned</span><span class="symbol">);</span>
<span class="normal">  </span><span class="function">free</span><span class="symbol">(</span><span class="normal">pivot</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="keyword">static</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="function">qsort_words</span><span class="symbol">(</span><span class="type">void</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">base</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">size_t</span><span class="normal"> nmemb</span><span class="symbol">,</span>
<span class="normal">           </span><span class="type">int</span><span class="normal"> </span><span class="symbol">(*</span><span class="normal">compare</span><span class="symbol">)(</span><span class="keyword">const</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="symbol">*,</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="symbol">*))</span><span class="normal"> </span><span class="cbracket">{</span>

<span class="normal">  </span><span class="usertype">stack_entry</span><span class="normal"> stack</span><span class="symbol">[</span><span class="normal">STACK_SIZE</span><span class="symbol">];</span>
<span class="normal">  </span><span class="type">int</span><span class="normal"> stacktop</span><span class="symbol">=</span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">  </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">first</span><span class="symbol">,*</span><span class="normal">last</span><span class="symbol">;</span>
<span class="normal">  </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">pivot</span><span class="symbol">=</span><span class="function">malloc</span><span class="symbol">(</span><span class="normal">WORD_BYTES</span><span class="symbol">);</span>
<span class="normal">  </span><span class="function">assert</span><span class="symbol">(</span><span class="normal">pivot</span><span class="symbol">!=</span><span class="number">0</span><span class="symbol">);</span>

<span class="normal">  first</span><span class="symbol">=(</span><span class="type">char</span><span class="symbol">*)</span><span class="normal">base</span><span class="symbol">;</span><span class="normal"> last</span><span class="symbol">=</span><span class="normal">first</span><span class="symbol">+(</span><span class="normal">nmemb</span><span class="symbol">-</span><span class="number">1</span><span class="symbol">)*</span><span class="normal">WORD_BYTES</span><span class="symbol">;</span>

<span class="normal">  </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">last</span><span class="symbol">-</span><span class="normal">first</span><span class="symbol">&gt;</span><span class="normal">TRUNC_words</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">    </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">ffirst</span><span class="symbol">=</span><span class="normal">first</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">llast</span><span class="symbol">=</span><span class="normal">last</span><span class="symbol">;</span>
<span class="normal">    </span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="preproc">#ifdef</span><span class="normal"> DEBUG_QSORT</span>
<span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="string">"Doing %d:%d: "</span><span class="symbol">,</span>
<span class="normal">        </span><span class="symbol">(</span><span class="normal">first</span><span class="symbol">-(</span><span class="type">char</span><span class="symbol">*)</span><span class="normal">base</span><span class="symbol">)/</span><span class="normal">WORD_BYTES</span><span class="symbol">,</span>
<span class="normal">        </span><span class="symbol">(</span><span class="normal">last</span><span class="symbol">-(</span><span class="type">char</span><span class="symbol">*)</span><span class="normal">base</span><span class="symbol">)/</span><span class="normal">WORD_BYTES</span><span class="symbol">);</span>
<span class="preproc">#endif</span>
<span class="normal">      </span><span class="comment">/* Select pivot */</span>
<span class="normal">      </span><span class="cbracket">{</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> mid</span><span class="symbol">=</span><span class="normal">first</span><span class="symbol">+</span><span class="normal">WORD_BYTES</span><span class="symbol">*((</span><span class="normal">last</span><span class="symbol">-</span><span class="normal">first</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">/</span><span class="normal"> </span><span class="symbol">(</span><span class="number">2</span><span class="symbol">*</span><span class="normal">WORD_BYTES</span><span class="symbol">));</span>
<span class="normal">        </span><span class="function">Pivot</span><span class="symbol">(</span><span class="normal">SWAP_words</span><span class="symbol">,</span><span class="normal">WORD_BYTES</span><span class="symbol">);</span>
<span class="normal">        </span><span class="symbol">*(</span><span class="type">int</span><span class="symbol">*)</span><span class="normal">pivot</span><span class="symbol">=*(</span><span class="type">int</span><span class="symbol">*)</span><span class="normal">mid</span><span class="symbol">;</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="preproc">#ifdef</span><span class="normal"> DEBUG_QSORT</span>
<span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="string">"pivot=%d</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,*(</span><span class="type">int</span><span class="symbol">*)</span><span class="normal">pivot</span><span class="symbol">);</span>
<span class="preproc">#endif</span>
<span class="normal">      </span><span class="comment">/* Partition. */</span>
<span class="normal">      </span><span class="function">Partition</span><span class="symbol">(</span><span class="normal">SWAP_words</span><span class="symbol">,</span><span class="normal">WORD_BYTES</span><span class="symbol">);</span>
<span class="normal">      </span><span class="comment">/* Prepare to recurse/iterate. */</span>
<span class="normal">      </span><span class="function">Recurse</span><span class="symbol">(</span><span class="normal">TRUNC_words</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="normal">  </span><span class="cbracket">}</span>
<span class="normal">  </span><span class="function">PreInsertion</span><span class="symbol">(</span><span class="normal">SWAP_words</span><span class="symbol">,(</span><span class="normal">TRUNC_words</span><span class="symbol">/</span><span class="normal">WORD_BYTES</span><span class="symbol">),</span><span class="normal">WORD_BYTES</span><span class="symbol">);</span>
<span class="normal">  </span><span class="comment">/* Now do insertion sort. */</span>
<span class="normal">  last</span><span class="symbol">=((</span><span class="type">char</span><span class="symbol">*)</span><span class="normal">base</span><span class="symbol">)+</span><span class="normal">nmemb</span><span class="symbol">*</span><span class="normal">WORD_BYTES</span><span class="symbol">;</span>
<span class="normal">  </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">first</span><span class="symbol">=((</span><span class="type">char</span><span class="symbol">*)</span><span class="normal">base</span><span class="symbol">)+</span><span class="normal">WORD_BYTES</span><span class="symbol">;</span><span class="normal">first</span><span class="symbol">!=</span><span class="normal">last</span><span class="symbol">;</span><span class="normal">first</span><span class="symbol">+=</span><span class="normal">WORD_BYTES</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">    </span><span class="comment">/* Find the right place for |first|. My apologies for var reuse */</span>
<span class="normal">    </span><span class="type">int</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">pl</span><span class="symbol">=(</span><span class="type">int</span><span class="symbol">*)(</span><span class="normal">first</span><span class="symbol">-</span><span class="normal">WORD_BYTES</span><span class="symbol">),*</span><span class="normal">pr</span><span class="symbol">=(</span><span class="type">int</span><span class="symbol">*)</span><span class="normal">first</span><span class="symbol">;</span>
<span class="normal">    </span><span class="symbol">*(</span><span class="type">int</span><span class="symbol">*)</span><span class="normal">pivot</span><span class="symbol">=*(</span><span class="type">int</span><span class="symbol">*)</span><span class="normal">first</span><span class="symbol">;</span>
<span class="normal">    </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(;</span><span class="function">compare</span><span class="symbol">(</span><span class="normal">pl</span><span class="symbol">,</span><span class="normal">pivot</span><span class="symbol">)&gt;</span><span class="number">0</span><span class="symbol">;</span><span class="normal">pr</span><span class="symbol">=</span><span class="normal">pl</span><span class="symbol">,--</span><span class="normal">pl</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="symbol">*</span><span class="normal">pr</span><span class="symbol">=*</span><span class="normal">pl</span><span class="symbol">;</span><span class="normal"> </span><span class="cbracket">}</span>
<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pr</span><span class="symbol">!=(</span><span class="type">int</span><span class="symbol">*)</span><span class="normal">first</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">pr</span><span class="symbol">=*(</span><span class="type">int</span><span class="symbol">*)</span><span class="normal">pivot</span><span class="symbol">;</span>
<span class="normal">  </span><span class="cbracket">}</span>
<span class="normal">  </span><span class="function">free</span><span class="symbol">(</span><span class="normal">pivot</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="comment">/* ---------------------------------------------------------------------- */</span>

<span class="type">void</span><span class="normal"> </span><span class="function">qsort</span><span class="symbol">(</span><span class="type">void</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">base</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">size_t</span><span class="normal"> nmemb</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">size_t</span><span class="normal"> size</span><span class="symbol">,</span>
<span class="normal">           </span><span class="type">int</span><span class="normal"> </span><span class="symbol">(*</span><span class="normal">compare</span><span class="symbol">)(</span><span class="keyword">const</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="symbol">*,</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="symbol">*))</span><span class="normal"> </span><span class="cbracket">{</span>

<span class="normal">  </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">nmemb</span><span class="symbol">&lt;=</span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="keyword">return</span><span class="symbol">;</span>
<span class="normal">  </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(((</span><span class="normal">uintptr_t</span><span class="symbol">)</span><span class="normal">base</span><span class="symbol">|</span><span class="normal">size</span><span class="symbol">)&amp;(</span><span class="normal">WORD_BYTES</span><span class="symbol">-</span><span class="number">1</span><span class="symbol">))</span>
<span class="normal">    </span><span class="function">qsort_nonaligned</span><span class="symbol">(</span><span class="normal">base</span><span class="symbol">,</span><span class="normal">nmemb</span><span class="symbol">,</span><span class="normal">size</span><span class="symbol">,</span><span class="normal">compare</span><span class="symbol">);</span>
<span class="normal">  </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">size</span><span class="symbol">!=</span><span class="normal">WORD_BYTES</span><span class="symbol">)</span>
<span class="normal">    </span><span class="function">qsort_aligned</span><span class="symbol">(</span><span class="normal">base</span><span class="symbol">,</span><span class="normal">nmemb</span><span class="symbol">,</span><span class="normal">size</span><span class="symbol">,</span><span class="normal">compare</span><span class="symbol">);</span>
<span class="normal">  </span><span class="keyword">else</span>
<span class="normal">    </span><span class="function">qsort_words</span><span class="symbol">(</span><span class="normal">base</span><span class="symbol">,</span><span class="normal">nmemb</span><span class="symbol">,</span><span class="normal">compare</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="preproc">#endif</span><span class="normal"> </span><span class="comment">/* !HAVE_QSORT */</span>
</tt></pre></div><div style="text-align: left; padding: 8pt"><a href="/xmlfeed/weblog-rss20.xml"><img src="/img/xmlfeed-rss20.png" alt="RSS 2.0 Weblog Feed" height="15" width="80" /></a> <a href="/xmlfeed/weblog-atom10.xml"><img src="/img/xmlfeed-atom10.png" alt="Atom 1.0 Weblog Feed" height="15" width="80" /></a> <a href="http://validator.w3.org/check?uri=referer"><img src="/img/w3c-xhtml10.png" alt="Valid XHTML 1.1" height="15" width="80" /></a> <a href="http://jigsaw.w3.org/css-validator/check/referer"><img src="/img/w3c-css.png" alt="Valid CSS (2.1)" height="15" width="80" /></a></div></body></html>