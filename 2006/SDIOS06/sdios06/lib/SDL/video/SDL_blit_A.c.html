<?xml version="1.0" encoding="iso-8859-1"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta content="text/html; charset=iso-8859-1" http-equiv="content-type" /><meta name="viewport" content="initial-scale=1"><title>/2006/SDIOS06/sdios06/lib/SDL/video/SDL_blit_A.c - panthema.net</title><link rel="stylesheet" type="text/css" href="/css/base.css" /><link rel="stylesheet" type="text/css" href="/css/fonts.css" /><link rel="alternate" type="application/rss+xml" title="panthema.net Weblog Feed RSS 2.0" href="http://panthema.net/xmlfeed/weblog-rss20.xml" /><link rel="alternate" type="application/atom+xml" title="panthema.net Weblog Feed Atom 1.0" href="http://panthema.net/xmlfeed/weblog-atom10.xml" /><script type="text/javascript" src="/js/base.js"></script><script type="text/javascript">/* <!-- */makeIEHover = function() {var lis = document.getElementById('ptnav').getElementsByTagName('li');for (var i = 0; i < lis.length; i++) {lis[i].onmouseover = function() {this.className += ' sfhover';};lis[i].onmouseout = function() {this.className = this.className.replace(new RegExp(' sfhover\b'), '');};}};if (window.attachEvent) window.attachEvent('onload', makeIEHover);/* --> */</script></head><body style="background-image: url(/img/bgfractal4.jpg)" lang="en"><div class="pttopbar"><div style="float: right"><ul id="ptnav"><li class="top"><a class="ni" href="/"><i class="icon-book"></i> Weblog</a><ul style="margin-left: -6px; margin-top: 4px" class="nx"><li><a href="/2020/">2020</a></li><li><a href="/2019/">2019</a></li><li><a href="/2018/">2018</a></li><li><a href="/2017/">2017</a></li><li><a href="/2016/">2016</a></li><li><a href="/2015/">2015</a></li><li><a href="/2014/">2014</a></li><li><a href="/2013/">2013</a></li><li><a href="/2012/">2012</a></li><li><a href="/2011/">2011</a></li><li><a href="/2010/">2010</a></li><li><a href="/2009/">2009</a></li><li><a href="/2008/">2008</a></li><li><a href="/2007/">2007</a></li><li><a href="/2006/">2006</a></li><li class="nt"><a href="/2005/">2005</a></li><li class="ns"><a href="/xmlfeed/weblog-rss20.xml">RSS Feed</a></li><li class="nt"><a href="/xmlfeed/weblog-atom10.xml">XML Atom</a></li><li class="ns"><a href="/search.html">Search</a></li></ul></li><li class="top"><a class="ni" href="/tags/"><i class="icon-tags"></i> Tags</a><div style="width: 14em; margin-left: -9em; margin-top: 4px"><a style="font-size: 10pt" href="/tags/algebra.html">algebra</a> <a style="font-size: 10pt" href="/tags/blinken-algorithms.html">blinken-algorithms</a> <a style="font-size: 16pt" href="/tags/c++.html">c++</a> <a style="font-size: 12pt" href="/tags/code-example.html">code-example</a> <a style="font-size: 14pt" href="/tags/code-snippet.html">code-snippet</a> <a style="font-size: 11pt" href="/tags/coding_tricks.html">coding tricks</a> <a style="font-size: 10pt" href="/tags/compsci.html">compsci</a> <a style="font-size: 10pt" href="/tags/compsci_study_thesis.html">compsci study thesis</a> <a style="font-size: 9pt" href="/tags/crypto-speedtest.html">crypto-speedtest</a> <a style="font-size: 10pt" href="/tags/cryptography.html">cryptography</a> <a style="font-size: 9pt" href="/tags/cryptote.html">cryptote</a> <a style="font-size: 11pt" href="/tags/dissertation.html">dissertation</a> <a style="font-size: 10pt" href="/tags/electronics.html">electronics</a> <a style="font-size: 12pt" href="/tags/flex-bison-cpp-example.html">flex-bison-cpp-example</a> <a style="font-size: 16pt" href="/tags/frontpage.html">frontpage</a> <a style="font-size: 15pt" href="/tags/fun.html">fun</a> <a style="font-size: 10pt" href="/tags/graphviz.html">graphviz</a> <a style="font-size: 9pt" href="http://www.hmtg.de">hartmetall</a> <a style="font-size: 9pt" href="/tags/helppc.html">helppc</a> <a style="font-size: 9pt" href="/tags/hifi_selbstbau.html">hifi selbstbau</a> <a style="font-size: 10pt" href="/tags/latex.html">latex</a> <a style="font-size: 10pt" href="/tags/LEDs.html">LEDs</a> <a style="font-size: 10pt" href="/tags/librivox.html">librivox</a> <a style="font-size: 10pt" href="/tags/linux.html">linux</a> <a style="font-size: 9pt" href="/tags/market.html">market</a> <a style="font-size: 9pt" href="/tags/massive-sorting.html">massive-sorting</a> <a style="font-size: 11pt" href="/tags/maths.html">maths</a> <a style="font-size: 9pt" href="/tags/music.html">music</a> <a style="font-size: 10pt" href="/tags/netfundamentals.html">netfundamentals</a> <a style="font-size: 11pt" href="/tags/ns-3.html">ns-3</a> <a style="font-size: 10pt" href="/tags/parallel-string-sorting.html">parallel-string-sorting</a> <a style="font-size: 14pt" href="/tags/parsing.html">parsing</a> <a style="font-size: 9pt" href="/tags/qtsqlview.html">qtsqlview</a> <a style="font-size: 14pt" href="/tags/research.html">research</a> <a style="font-size: 11pt" href="/tags/sdios06.html">sdios06</a> <a style="font-size: 9pt" href="/tags/sdlfractal.html">sdlfractal</a> <a style="font-size: 16pt" href="/tags/sorting.html">sorting</a> <a style="font-size: 13pt" href="/tags/sound_of_sorting.html">sound of sorting</a> <a style="font-size: 10pt" href="/tags/stringology.html">stringology</a> <a style="font-size: 16pt" href="/tags/stx-btree.html">stx-btree</a> <a style="font-size: 16pt" href="/tags/stxxl.html">stxxl</a> <a style="font-size: 16pt" href="/tags/talk.html">talk</a> <a style="font-size: 15pt" href="/tags/thrill.html">thrill</a> <a style="font-size: 10pt" href="/tags/tutorium.html">tutorium</a> <a style="font-size: 16pt" href="/tags/university.html">university</a> <a style="font-size: 14pt" href="/tags/utilities.html">utilities</a> <a style="font-size: 10pt" href="/tags/vncrec.html">vncrec</a> <a style="font-size: 9pt" href="/tags/webdesign.html">webdesign</a> </div></li><li class="top"> <a class="ni" href="#"><i class="icon-cubes"></i> Projects</a> <ul style="margin-left: -8em; margin-top: 4px;" class="nx"> <li><a href="/2019/1008-COBS-A-Compact-Bit-Sliced-Signature-Index/">COBS</a></li> <li><a href="/2009/cryptote/">CryptoTE</a></li> <li><a href="/2009/digup/">digup</a></li> <li><a href="/2013/disk-filltest/">disk-filltest</a></li> <li><a href="/2012/1119-eSAIS-Inducing-Suffix-and-LCP-Arrays-in-External-Memory/">eSAIS-LCP</a></li> <li><a href="/2007/flex-bison-cpp-example/">Flex Bison C++ Example</a></li> <li><a href="/2013/malloc_count/">malloc_count</a></li> <li><a href="/2016/0114-diploma-thesis/">On Bispanning Graphs</a></li> <li><a href="/2013/pmbw/">Parallel Memory Bandwidth</a></li> <li><a href="/2013/parallel-string-sorting/">Parallel String Sorting</a></li> <li><a href="/2014/sqlplot-tools/">SqlPlotTools</a></li> <li><a href="/2013/sound-of-sorting/">The Sound of Sorting</a></li> <li><a href="/2007/stx-btree/">STX B+ Tree</a></li> <li><a href="/2010/stx-cbtreedb/">STX Constant BTreeDB</a></li> <li><a href="/2010/stx-execpipe/">STX ExecPipe</a></li> <li><a href="/2007/stx-exparser/">STX Expression Parser</a></li> <li><a href="/tags/stxxl.html">STXXL 1.4</a></li> <li><a href="/tags/thrill.html">Thrill - Big Data Framework</a></li> <li class="nt"><a href="/2014/vncrec-rgb/">VNCrec RGB 0.4</a></li> <li class="ns"><a href="/search.html">Search</a></li> </ul></li><li class="top"> <a class="ni" href="/publications.html"><i class="icon-graduation-cap"></i> Publications</a></li><li class="top"> <a class="ni" href="/about/"><i class="icon-info-circled"></i> About</a> <ul style="margin-left: -6em; margin-top: 4px" class="nx"> <li><a href="/about/">Timo Bingmann</a></li> <li><a href="/about/impressum.html">Impressum</a></li> </ul></li><li class="top"> <a class="ni" href="/subscribe.html"><i class="icon-rss-squared"></i> Subscribe</a></li></ul></div><div style="padding: 6px"><a href="/">panthema</a>  / <a href="/2006/">2006</a> / <a href="/2006/SDIOS06/">SDIOS06</a> / <a href="/2006/SDIOS06/sdios06/">sdios06</a> / <a href="/2006/SDIOS06/sdios06/lib/">lib</a> / <a href="/2006/SDIOS06/sdios06/lib/SDL/">SDL</a> / <a href="/2006/SDIOS06/sdios06/lib/SDL/video/">video</a> / <a href="/2006/SDIOS06/sdios06/lib/SDL/video/SDL_blit_A.c.html">SDL_blit_A.c</a> (<a href="/2006/SDIOS06/sdios06/lib/SDL/video/SDL_blit_A.c">Download File</a>)</div></div><div class="ptfullwidth"><pre class="codesnippet" style="font-family: monospace"><tt><span class="comment">/*</span>
<span class="comment">    SDL - Simple DirectMedia Layer</span>
<span class="comment">    Copyright (C) 1997-2006 Sam Lantinga</span>

<span class="comment">    This library is free software; you can redistribute it and/or</span>
<span class="comment">    modify it under the terms of the GNU Lesser General Public</span>
<span class="comment">    License as published by the Free Software Foundation; either</span>
<span class="comment">    version 2.1 of the License, or (at your option) any later version.</span>

<span class="comment">    This library is distributed in the hope that it will be useful,</span>
<span class="comment">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="comment">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="comment">    Lesser General Public License for more details.</span>

<span class="comment">    You should have received a copy of the GNU Lesser General Public</span>
<span class="comment">    License along with this library; if not, write to the Free Software</span>
<span class="comment">    Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA</span>

<span class="comment">    Sam Lantinga</span>
<span class="comment">    </span><span class="url">slouken@libsdl.org</span>
<span class="comment">*/</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">"SDL_config.h"</span>

<span class="preproc">#include</span><span class="normal"> </span><span class="string">"SDL_video.h"</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">"SDL_blit.h"</span>

<span class="preproc">#if</span><span class="normal"> SDL_ASSEMBLY_ROUTINES</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">__GNUC__</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="function">defined</span><span class="symbol">(</span><span class="normal">__i386__</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">__x86_64__</span><span class="symbol">))</span>
<span class="preproc">#define</span><span class="normal"> MMX_ASMBLIT </span><span class="number">1</span>
<span class="preproc">#define</span><span class="normal"> GCC_ASMBLIT </span><span class="number">1</span>
<span class="preproc">#elif</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">_MSC_VER</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">_MSC_VER </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">1200</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">_M_IX86</span><span class="symbol">)</span>
<span class="preproc">#define</span><span class="normal"> MMX_ASMBLIT </span><span class="number">1</span>
<span class="preproc">#define</span><span class="normal"> MSVC_ASMBLIT </span><span class="number">1</span>
<span class="preproc">#endif</span>
<span class="preproc">#endif</span><span class="normal"> </span><span class="comment">/* SDL_ASSEMBLY_ROUTINES */</span>

<span class="comment">/* Function to check the CPU flags */</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">"SDL_cpuinfo.h"</span>
<span class="preproc">#if</span><span class="normal"> GCC_ASMBLIT</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">"mmx.h"</span>
<span class="preproc">#elif</span><span class="normal"> MSVC_ASMBLIT</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">&lt;mmintrin.h&gt;</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">&lt;mm3dnow.h&gt;</span>
<span class="preproc">#endif</span>

<span class="comment">/* Functions to perform alpha blended blitting */</span>

<span class="comment">/* N-&gt;1 blending with per-surface alpha */</span>
<span class="keyword">static</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="function">BlitNto1SurfaceAlpha</span><span class="symbol">(</span><span class="usertype">SDL_BlitInfo</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">info</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> width </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_width</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> height </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_height</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">Uint8</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">src </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">s_pixels</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> srcskip </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">s_skip</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">Uint8</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dst </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_pixels</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> dstskip </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_skip</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">Uint8</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">palmap </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">table</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">SDL_PixelFormat</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">srcfmt </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">src</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">SDL_PixelFormat</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dstfmt </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">dst</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> srcbpp </span><span class="symbol">=</span><span class="normal"> srcfmt</span><span class="symbol">-&gt;</span><span class="normal">BytesPerPixel</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">const</span><span class="normal"> </span><span class="type">unsigned</span><span class="normal"> A </span><span class="symbol">=</span><span class="normal"> srcfmt</span><span class="symbol">-&gt;</span><span class="normal">alpha</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal"> height</span><span class="symbol">--</span><span class="normal"> </span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="function">DUFFS_LOOP4</span><span class="symbol">(</span>
<span class="normal">	    </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="usertype">Uint32</span><span class="normal"> Pixel</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">unsigned</span><span class="normal"> sR</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">unsigned</span><span class="normal"> sG</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">unsigned</span><span class="normal"> sB</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">unsigned</span><span class="normal"> dR</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">unsigned</span><span class="normal"> dG</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">unsigned</span><span class="normal"> dB</span><span class="symbol">;</span>
<span class="normal">		</span><span class="function">DISEMBLE_RGB</span><span class="symbol">(</span><span class="normal">src</span><span class="symbol">,</span><span class="normal"> srcbpp</span><span class="symbol">,</span><span class="normal"> srcfmt</span><span class="symbol">,</span><span class="normal"> Pixel</span><span class="symbol">,</span><span class="normal"> sR</span><span class="symbol">,</span><span class="normal"> sG</span><span class="symbol">,</span><span class="normal"> sB</span><span class="symbol">);</span>
<span class="normal">		dR </span><span class="symbol">=</span><span class="normal"> dstfmt</span><span class="symbol">-&gt;</span><span class="normal">palette</span><span class="symbol">-&gt;</span><span class="normal">colors</span><span class="symbol">[*</span><span class="normal">dst</span><span class="symbol">].</span><span class="normal">r</span><span class="symbol">;</span>
<span class="normal">		dG </span><span class="symbol">=</span><span class="normal"> dstfmt</span><span class="symbol">-&gt;</span><span class="normal">palette</span><span class="symbol">-&gt;</span><span class="normal">colors</span><span class="symbol">[*</span><span class="normal">dst</span><span class="symbol">].</span><span class="normal">g</span><span class="symbol">;</span>
<span class="normal">		dB </span><span class="symbol">=</span><span class="normal"> dstfmt</span><span class="symbol">-&gt;</span><span class="normal">palette</span><span class="symbol">-&gt;</span><span class="normal">colors</span><span class="symbol">[*</span><span class="normal">dst</span><span class="symbol">].</span><span class="normal">b</span><span class="symbol">;</span>
<span class="normal">		</span><span class="function">ALPHA_BLEND</span><span class="symbol">(</span><span class="normal">sR</span><span class="symbol">,</span><span class="normal"> sG</span><span class="symbol">,</span><span class="normal"> sB</span><span class="symbol">,</span><span class="normal"> A</span><span class="symbol">,</span><span class="normal"> dR</span><span class="symbol">,</span><span class="normal"> dG</span><span class="symbol">,</span><span class="normal"> dB</span><span class="symbol">);</span>
<span class="normal">		dR </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">;</span>
<span class="normal">		dG </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">;</span>
<span class="normal">		dB </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">;</span>
<span class="normal">		</span><span class="comment">/* Pack RGB into 8bit pixel */</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal"> palmap </span><span class="symbol">==</span><span class="normal"> NULL </span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		    </span><span class="symbol">*</span><span class="normal">dst </span><span class="symbol">=((</span><span class="normal">dR</span><span class="symbol">&gt;&gt;</span><span class="number">5</span><span class="symbol">)&lt;&lt;(</span><span class="number">3</span><span class="symbol">+</span><span class="number">2</span><span class="symbol">))|</span>
<span class="normal">			  </span><span class="symbol">((</span><span class="normal">dG</span><span class="symbol">&gt;&gt;</span><span class="number">5</span><span class="symbol">)&lt;&lt;(</span><span class="number">2</span><span class="symbol">))|</span>
<span class="normal">			  </span><span class="symbol">((</span><span class="normal">dB</span><span class="symbol">&gt;&gt;</span><span class="number">6</span><span class="symbol">)&lt;&lt;(</span><span class="number">0</span><span class="symbol">));</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		    </span><span class="symbol">*</span><span class="normal">dst </span><span class="symbol">=</span><span class="normal"> palmap</span><span class="symbol">[((</span><span class="normal">dR</span><span class="symbol">&gt;&gt;</span><span class="number">5</span><span class="symbol">)&lt;&lt;(</span><span class="number">3</span><span class="symbol">+</span><span class="number">2</span><span class="symbol">))|</span>
<span class="normal">				  </span><span class="symbol">((</span><span class="normal">dG</span><span class="symbol">&gt;&gt;</span><span class="number">5</span><span class="symbol">)&lt;&lt;(</span><span class="number">2</span><span class="symbol">))</span><span class="normal">  </span><span class="symbol">|</span>
<span class="normal">				  </span><span class="symbol">((</span><span class="normal">dB</span><span class="symbol">&gt;&gt;</span><span class="number">6</span><span class="symbol">)&lt;&lt;(</span><span class="number">0</span><span class="symbol">))];</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		dst</span><span class="symbol">++;</span>
<span class="normal">		src </span><span class="symbol">+=</span><span class="normal"> srcbpp</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="cbracket">}</span><span class="symbol">,</span>
<span class="normal">	    width</span><span class="symbol">);</span>
<span class="normal">	    src </span><span class="symbol">+=</span><span class="normal"> srcskip</span><span class="symbol">;</span>
<span class="normal">	    dst </span><span class="symbol">+=</span><span class="normal"> dstskip</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="comment">/* N-&gt;1 blending with pixel alpha */</span>
<span class="keyword">static</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="function">BlitNto1PixelAlpha</span><span class="symbol">(</span><span class="usertype">SDL_BlitInfo</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">info</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> width </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_width</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> height </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_height</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">Uint8</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">src </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">s_pixels</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> srcskip </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">s_skip</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">Uint8</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dst </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_pixels</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> dstskip </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_skip</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">Uint8</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">palmap </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">table</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">SDL_PixelFormat</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">srcfmt </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">src</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">SDL_PixelFormat</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dstfmt </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">dst</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> srcbpp </span><span class="symbol">=</span><span class="normal"> srcfmt</span><span class="symbol">-&gt;</span><span class="normal">BytesPerPixel</span><span class="symbol">;</span>

<span class="normal">	</span><span class="comment">/* </span><span class="todo">FIXME:</span><span class="comment"> fix alpha bit field expansion here too? */</span>
<span class="normal">	</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal"> height</span><span class="symbol">--</span><span class="normal"> </span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="function">DUFFS_LOOP4</span><span class="symbol">(</span>
<span class="normal">	    </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="usertype">Uint32</span><span class="normal"> Pixel</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">unsigned</span><span class="normal"> sR</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">unsigned</span><span class="normal"> sG</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">unsigned</span><span class="normal"> sB</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">unsigned</span><span class="normal"> sA</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">unsigned</span><span class="normal"> dR</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">unsigned</span><span class="normal"> dG</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">unsigned</span><span class="normal"> dB</span><span class="symbol">;</span>
<span class="normal">		</span><span class="function">DISEMBLE_RGBA</span><span class="symbol">(</span><span class="normal">src</span><span class="symbol">,</span><span class="normal">srcbpp</span><span class="symbol">,</span><span class="normal">srcfmt</span><span class="symbol">,</span><span class="normal">Pixel</span><span class="symbol">,</span><span class="normal">sR</span><span class="symbol">,</span><span class="normal">sG</span><span class="symbol">,</span><span class="normal">sB</span><span class="symbol">,</span><span class="normal">sA</span><span class="symbol">);</span>
<span class="normal">		dR </span><span class="symbol">=</span><span class="normal"> dstfmt</span><span class="symbol">-&gt;</span><span class="normal">palette</span><span class="symbol">-&gt;</span><span class="normal">colors</span><span class="symbol">[*</span><span class="normal">dst</span><span class="symbol">].</span><span class="normal">r</span><span class="symbol">;</span>
<span class="normal">		dG </span><span class="symbol">=</span><span class="normal"> dstfmt</span><span class="symbol">-&gt;</span><span class="normal">palette</span><span class="symbol">-&gt;</span><span class="normal">colors</span><span class="symbol">[*</span><span class="normal">dst</span><span class="symbol">].</span><span class="normal">g</span><span class="symbol">;</span>
<span class="normal">		dB </span><span class="symbol">=</span><span class="normal"> dstfmt</span><span class="symbol">-&gt;</span><span class="normal">palette</span><span class="symbol">-&gt;</span><span class="normal">colors</span><span class="symbol">[*</span><span class="normal">dst</span><span class="symbol">].</span><span class="normal">b</span><span class="symbol">;</span>
<span class="normal">		</span><span class="function">ALPHA_BLEND</span><span class="symbol">(</span><span class="normal">sR</span><span class="symbol">,</span><span class="normal"> sG</span><span class="symbol">,</span><span class="normal"> sB</span><span class="symbol">,</span><span class="normal"> sA</span><span class="symbol">,</span><span class="normal"> dR</span><span class="symbol">,</span><span class="normal"> dG</span><span class="symbol">,</span><span class="normal"> dB</span><span class="symbol">);</span>
<span class="normal">		dR </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">;</span>
<span class="normal">		dG </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">;</span>
<span class="normal">		dB </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">;</span>
<span class="normal">		</span><span class="comment">/* Pack RGB into 8bit pixel */</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal"> palmap </span><span class="symbol">==</span><span class="normal"> NULL </span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		    </span><span class="symbol">*</span><span class="normal">dst </span><span class="symbol">=((</span><span class="normal">dR</span><span class="symbol">&gt;&gt;</span><span class="number">5</span><span class="symbol">)&lt;&lt;(</span><span class="number">3</span><span class="symbol">+</span><span class="number">2</span><span class="symbol">))|</span>
<span class="normal">			  </span><span class="symbol">((</span><span class="normal">dG</span><span class="symbol">&gt;&gt;</span><span class="number">5</span><span class="symbol">)&lt;&lt;(</span><span class="number">2</span><span class="symbol">))|</span>
<span class="normal">			  </span><span class="symbol">((</span><span class="normal">dB</span><span class="symbol">&gt;&gt;</span><span class="number">6</span><span class="symbol">)&lt;&lt;(</span><span class="number">0</span><span class="symbol">));</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		    </span><span class="symbol">*</span><span class="normal">dst </span><span class="symbol">=</span><span class="normal"> palmap</span><span class="symbol">[((</span><span class="normal">dR</span><span class="symbol">&gt;&gt;</span><span class="number">5</span><span class="symbol">)&lt;&lt;(</span><span class="number">3</span><span class="symbol">+</span><span class="number">2</span><span class="symbol">))|</span>
<span class="normal">				  </span><span class="symbol">((</span><span class="normal">dG</span><span class="symbol">&gt;&gt;</span><span class="number">5</span><span class="symbol">)&lt;&lt;(</span><span class="number">2</span><span class="symbol">))</span><span class="normal">  </span><span class="symbol">|</span>
<span class="normal">				  </span><span class="symbol">((</span><span class="normal">dB</span><span class="symbol">&gt;&gt;</span><span class="number">6</span><span class="symbol">)&lt;&lt;(</span><span class="number">0</span><span class="symbol">))</span><span class="normal">  </span><span class="symbol">];</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		dst</span><span class="symbol">++;</span>
<span class="normal">		src </span><span class="symbol">+=</span><span class="normal"> srcbpp</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="cbracket">}</span><span class="symbol">,</span>
<span class="normal">	    width</span><span class="symbol">);</span>
<span class="normal">	    src </span><span class="symbol">+=</span><span class="normal"> srcskip</span><span class="symbol">;</span>
<span class="normal">	    dst </span><span class="symbol">+=</span><span class="normal"> dstskip</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="comment">/* colorkeyed N-&gt;1 blending with per-surface alpha */</span>
<span class="keyword">static</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="function">BlitNto1SurfaceAlphaKey</span><span class="symbol">(</span><span class="usertype">SDL_BlitInfo</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">info</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> width </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_width</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> height </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_height</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">Uint8</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">src </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">s_pixels</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> srcskip </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">s_skip</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">Uint8</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dst </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_pixels</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> dstskip </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_skip</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">Uint8</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">palmap </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">table</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">SDL_PixelFormat</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">srcfmt </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">src</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">SDL_PixelFormat</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dstfmt </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">dst</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> srcbpp </span><span class="symbol">=</span><span class="normal"> srcfmt</span><span class="symbol">-&gt;</span><span class="normal">BytesPerPixel</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">Uint32</span><span class="normal"> ckey </span><span class="symbol">=</span><span class="normal"> srcfmt</span><span class="symbol">-&gt;</span><span class="normal">colorkey</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">const</span><span class="normal"> </span><span class="type">int</span><span class="normal"> A </span><span class="symbol">=</span><span class="normal"> srcfmt</span><span class="symbol">-&gt;</span><span class="normal">alpha</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal"> height</span><span class="symbol">--</span><span class="normal"> </span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="function">DUFFS_LOOP</span><span class="symbol">(</span>
<span class="normal">	    </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="usertype">Uint32</span><span class="normal"> Pixel</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">unsigned</span><span class="normal"> sR</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">unsigned</span><span class="normal"> sG</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">unsigned</span><span class="normal"> sB</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">unsigned</span><span class="normal"> dR</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">unsigned</span><span class="normal"> dG</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">unsigned</span><span class="normal"> dB</span><span class="symbol">;</span>
<span class="normal">		</span><span class="function">DISEMBLE_RGB</span><span class="symbol">(</span><span class="normal">src</span><span class="symbol">,</span><span class="normal"> srcbpp</span><span class="symbol">,</span><span class="normal"> srcfmt</span><span class="symbol">,</span><span class="normal"> Pixel</span><span class="symbol">,</span><span class="normal"> sR</span><span class="symbol">,</span><span class="normal"> sG</span><span class="symbol">,</span><span class="normal"> sB</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal"> Pixel </span><span class="symbol">!=</span><span class="normal"> ckey </span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		    dR </span><span class="symbol">=</span><span class="normal"> dstfmt</span><span class="symbol">-&gt;</span><span class="normal">palette</span><span class="symbol">-&gt;</span><span class="normal">colors</span><span class="symbol">[*</span><span class="normal">dst</span><span class="symbol">].</span><span class="normal">r</span><span class="symbol">;</span>
<span class="normal">		    dG </span><span class="symbol">=</span><span class="normal"> dstfmt</span><span class="symbol">-&gt;</span><span class="normal">palette</span><span class="symbol">-&gt;</span><span class="normal">colors</span><span class="symbol">[*</span><span class="normal">dst</span><span class="symbol">].</span><span class="normal">g</span><span class="symbol">;</span>
<span class="normal">		    dB </span><span class="symbol">=</span><span class="normal"> dstfmt</span><span class="symbol">-&gt;</span><span class="normal">palette</span><span class="symbol">-&gt;</span><span class="normal">colors</span><span class="symbol">[*</span><span class="normal">dst</span><span class="symbol">].</span><span class="normal">b</span><span class="symbol">;</span>
<span class="normal">		    </span><span class="function">ALPHA_BLEND</span><span class="symbol">(</span><span class="normal">sR</span><span class="symbol">,</span><span class="normal"> sG</span><span class="symbol">,</span><span class="normal"> sB</span><span class="symbol">,</span><span class="normal"> A</span><span class="symbol">,</span><span class="normal"> dR</span><span class="symbol">,</span><span class="normal"> dG</span><span class="symbol">,</span><span class="normal"> dB</span><span class="symbol">);</span>
<span class="normal">		    dR </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">;</span>
<span class="normal">		    dG </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">;</span>
<span class="normal">		    dB </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">;</span>
<span class="normal">		    </span><span class="comment">/* Pack RGB into 8bit pixel */</span>
<span class="normal">		    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal"> palmap </span><span class="symbol">==</span><span class="normal"> NULL </span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="symbol">*</span><span class="normal">dst </span><span class="symbol">=((</span><span class="normal">dR</span><span class="symbol">&gt;&gt;</span><span class="number">5</span><span class="symbol">)&lt;&lt;(</span><span class="number">3</span><span class="symbol">+</span><span class="number">2</span><span class="symbol">))|</span>
<span class="normal">			      </span><span class="symbol">((</span><span class="normal">dG</span><span class="symbol">&gt;&gt;</span><span class="number">5</span><span class="symbol">)&lt;&lt;(</span><span class="number">2</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">|</span>
<span class="normal">			      </span><span class="symbol">((</span><span class="normal">dB</span><span class="symbol">&gt;&gt;</span><span class="number">6</span><span class="symbol">)&lt;&lt;(</span><span class="number">0</span><span class="symbol">));</span>
<span class="normal">		    </span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="symbol">*</span><span class="normal">dst </span><span class="symbol">=</span><span class="normal"> palmap</span><span class="symbol">[((</span><span class="normal">dR</span><span class="symbol">&gt;&gt;</span><span class="number">5</span><span class="symbol">)&lt;&lt;(</span><span class="number">3</span><span class="symbol">+</span><span class="number">2</span><span class="symbol">))|</span>
<span class="normal">				      </span><span class="symbol">((</span><span class="normal">dG</span><span class="symbol">&gt;&gt;</span><span class="number">5</span><span class="symbol">)&lt;&lt;(</span><span class="number">2</span><span class="symbol">))</span><span class="normal">  </span><span class="symbol">|</span>
<span class="normal">				      </span><span class="symbol">((</span><span class="normal">dB</span><span class="symbol">&gt;&gt;</span><span class="number">6</span><span class="symbol">)&lt;&lt;(</span><span class="number">0</span><span class="symbol">))</span><span class="normal">  </span><span class="symbol">];</span>
<span class="normal">		    </span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		dst</span><span class="symbol">++;</span>
<span class="normal">		src </span><span class="symbol">+=</span><span class="normal"> srcbpp</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="cbracket">}</span><span class="symbol">,</span>
<span class="normal">	    width</span><span class="symbol">);</span>
<span class="normal">	    src </span><span class="symbol">+=</span><span class="normal"> srcskip</span><span class="symbol">;</span>
<span class="normal">	    dst </span><span class="symbol">+=</span><span class="normal"> dstskip</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="preproc">#if</span><span class="normal"> GCC_ASMBLIT</span>
<span class="comment">/* fast RGB888-&gt;(A)RGB888 blending with surface alpha=128 special case */</span>
<span class="keyword">static</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="function">BlitRGBtoRGBSurfaceAlpha128MMX</span><span class="symbol">(</span><span class="usertype">SDL_BlitInfo</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">info</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> width </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_width</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> height </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_height</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">Uint32</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">srcp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint32 </span><span class="symbol">*)</span><span class="normal">info</span><span class="symbol">-&gt;</span><span class="normal">s_pixels</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> srcskip </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">s_skip </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">Uint32</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dstp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint32 </span><span class="symbol">*)</span><span class="normal">info</span><span class="symbol">-&gt;</span><span class="normal">d_pixels</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> dstskip </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_skip </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">Uint32</span><span class="normal"> dalpha </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">dst</span><span class="symbol">-&gt;</span><span class="normal">Amask</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">Uint8</span><span class="normal"> load</span><span class="symbol">[</span><span class="number">8</span><span class="symbol">];</span>

<span class="normal">	</span><span class="symbol">*(</span><span class="normal">Uint64 </span><span class="symbol">*)</span><span class="normal">load </span><span class="symbol">=</span><span class="normal"> 0x00fefefe00fefefeULL</span><span class="symbol">;</span><span class="comment">/* alpha128 mask */</span>
<span class="normal">	</span><span class="function">movq_m2r</span><span class="symbol">(*</span><span class="normal">load</span><span class="symbol">,</span><span class="normal"> mm4</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* alpha128 mask -&gt; mm4 */</span>
<span class="normal">	</span><span class="symbol">*(</span><span class="normal">Uint64 </span><span class="symbol">*)</span><span class="normal">load </span><span class="symbol">=</span><span class="normal"> 0x0001010100010101ULL</span><span class="symbol">;</span><span class="comment">/* !alpha128 mask */</span>
<span class="normal">	</span><span class="function">movq_m2r</span><span class="symbol">(*</span><span class="normal">load</span><span class="symbol">,</span><span class="normal"> mm3</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* !alpha128 mask -&gt; mm3 */</span>
<span class="normal">	</span><span class="function">movd_m2r</span><span class="symbol">(</span><span class="normal">dalpha</span><span class="symbol">,</span><span class="normal"> mm7</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* dst alpha mask */</span>
<span class="normal">	</span><span class="function">punpckldq_r2r</span><span class="symbol">(</span><span class="normal">mm7</span><span class="symbol">,</span><span class="normal"> mm7</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* dst alpha mask | dst alpha mask -&gt; mm7 */</span>
<span class="normal">	</span><span class="keyword">while</span><span class="symbol">(</span><span class="normal">height</span><span class="symbol">--)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">DUFFS_LOOP_DOUBLE2</span><span class="symbol">(</span>
<span class="normal">		</span><span class="cbracket">{</span>
<span class="normal">			</span><span class="usertype">Uint32</span><span class="normal"> s </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">srcp</span><span class="symbol">++;</span>
<span class="normal">			</span><span class="usertype">Uint32</span><span class="normal"> d </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dstp</span><span class="symbol">;</span>
<span class="normal">			</span><span class="symbol">*</span><span class="normal">dstp</span><span class="symbol">++</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">((((</span><span class="normal">s </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x00fefefe</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">d </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x00fefefe</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span>
<span class="normal">				   </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">s </span><span class="symbol">&amp;</span><span class="normal"> d </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x00010101</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">|</span><span class="normal"> dalpha</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="symbol">,</span><span class="cbracket">{</span>
<span class="normal">			</span><span class="function">movq_m2r</span><span class="symbol">((*</span><span class="normal">dstp</span><span class="symbol">),</span><span class="normal"> mm2</span><span class="symbol">);</span><span class="comment">/* 2 x dst -&gt; mm2(ARGBARGB) */</span>
<span class="normal">			</span><span class="function">movq_r2r</span><span class="symbol">(</span><span class="normal">mm2</span><span class="symbol">,</span><span class="normal"> mm6</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* 2 x dst -&gt; mm6(ARGBARGB) */</span>

<span class="normal">			</span><span class="function">movq_m2r</span><span class="symbol">((*</span><span class="normal">srcp</span><span class="symbol">),</span><span class="normal"> mm1</span><span class="symbol">);</span><span class="comment">/* 2 x src -&gt; mm1(ARGBARGB) */</span>
<span class="normal">			</span><span class="function">movq_r2r</span><span class="symbol">(</span><span class="normal">mm1</span><span class="symbol">,</span><span class="normal"> mm5</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* 2 x src -&gt; mm5(ARGBARGB) */</span>

<span class="normal">			</span><span class="function">pand_r2r</span><span class="symbol">(</span><span class="normal">mm4</span><span class="symbol">,</span><span class="normal"> mm6</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* dst &amp; mask -&gt; mm6 */</span>
<span class="normal">			</span><span class="function">pand_r2r</span><span class="symbol">(</span><span class="normal">mm4</span><span class="symbol">,</span><span class="normal"> mm5</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* src &amp; mask -&gt; mm5 */</span>
<span class="normal">			</span><span class="function">paddd_r2r</span><span class="symbol">(</span><span class="normal">mm6</span><span class="symbol">,</span><span class="normal"> mm5</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* mm6 + mm5 -&gt; mm5 */</span>
<span class="normal">			</span><span class="function">pand_r2r</span><span class="symbol">(</span><span class="normal">mm1</span><span class="symbol">,</span><span class="normal"> mm2</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* src &amp; dst -&gt; mm2 */</span>
<span class="normal">			</span><span class="function">psrld_i2r</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> mm5</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* mm5 &gt;&gt; 1 -&gt; mm5 */</span>
<span class="normal">			</span><span class="function">pand_r2r</span><span class="symbol">(</span><span class="normal">mm3</span><span class="symbol">,</span><span class="normal"> mm2</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* mm2 &amp; !mask -&gt; mm2 */</span>
<span class="normal">			</span><span class="function">paddd_r2r</span><span class="symbol">(</span><span class="normal">mm5</span><span class="symbol">,</span><span class="normal"> mm2</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* mm5 + mm2 -&gt; mm2 */</span>
<span class="normal">			</span>
<span class="normal">			</span><span class="function">por_r2r</span><span class="symbol">(</span><span class="normal">mm7</span><span class="symbol">,</span><span class="normal"> mm2</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* mm7(full alpha) | mm2 -&gt; mm2 */</span>
<span class="normal">			</span><span class="function">movq_r2m</span><span class="symbol">(</span><span class="normal">mm2</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">(*</span><span class="normal">dstp</span><span class="symbol">));</span><span class="comment">/* mm2 -&gt; 2 x dst pixels */</span>
<span class="normal">			dstp </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">			srcp </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="symbol">,</span><span class="normal"> width</span><span class="symbol">);</span>
<span class="normal">		srcp </span><span class="symbol">+=</span><span class="normal"> srcskip</span><span class="symbol">;</span>
<span class="normal">		dstp </span><span class="symbol">+=</span><span class="normal"> dstskip</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="function">emms</span><span class="symbol">();</span>
<span class="cbracket">}</span>

<span class="comment">/* fast RGB888-&gt;(A)RGB888 blending with surface alpha */</span>
<span class="keyword">static</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="function">BlitRGBtoRGBSurfaceAlphaMMX</span><span class="symbol">(</span><span class="usertype">SDL_BlitInfo</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">info</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">	SDL_PixelFormat</span><span class="symbol">*</span><span class="normal"> df </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">dst</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">unsigned</span><span class="normal"> alpha </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">src</span><span class="symbol">-&gt;</span><span class="normal">alpha</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">alpha </span><span class="symbol">==</span><span class="normal"> </span><span class="number">128</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">df</span><span class="symbol">-&gt;</span><span class="normal">Rmask </span><span class="symbol">|</span><span class="normal"> df</span><span class="symbol">-&gt;</span><span class="normal">Gmask </span><span class="symbol">|</span><span class="normal"> df</span><span class="symbol">-&gt;</span><span class="normal">Bmask</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0x00FFFFFF</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="comment">/* only call a128 version when R,G,B occupy lower bits */</span>
<span class="normal">		</span><span class="function">BlitRGBtoRGBSurfaceAlpha128MMX</span><span class="symbol">(</span><span class="normal">info</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> width </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_width</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> height </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_height</span><span class="symbol">;</span>
<span class="normal">		</span><span class="usertype">Uint32</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">srcp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint32 </span><span class="symbol">*)</span><span class="normal">info</span><span class="symbol">-&gt;</span><span class="normal">s_pixels</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> srcskip </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">s_skip </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">		</span><span class="usertype">Uint32</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dstp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint32 </span><span class="symbol">*)</span><span class="normal">info</span><span class="symbol">-&gt;</span><span class="normal">d_pixels</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> dstskip </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_skip </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>

<span class="normal">		</span><span class="function">pxor_r2r</span><span class="symbol">(</span><span class="normal">mm5</span><span class="symbol">,</span><span class="normal"> mm5</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* 0 -&gt; mm5 */</span>
<span class="normal">		</span><span class="comment">/* form the alpha mult */</span>
<span class="normal">		</span><span class="function">movd_m2r</span><span class="symbol">(</span><span class="normal">alpha</span><span class="symbol">,</span><span class="normal"> mm4</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* 0000000A -&gt; mm4 */</span>
<span class="normal">		</span><span class="function">punpcklwd_r2r</span><span class="symbol">(</span><span class="normal">mm4</span><span class="symbol">,</span><span class="normal"> mm4</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* 00000A0A -&gt; mm4 */</span>
<span class="normal">		</span><span class="function">punpckldq_r2r</span><span class="symbol">(</span><span class="normal">mm4</span><span class="symbol">,</span><span class="normal"> mm4</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* 0A0A0A0A -&gt; mm4 */</span>
<span class="normal">		alpha </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="number">0xff</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> df</span><span class="symbol">-&gt;</span><span class="normal">Rshift</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">|</span><span class="normal"> </span><span class="symbol">(</span><span class="number">0xff</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> df</span><span class="symbol">-&gt;</span><span class="normal">Gshift</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">|</span><span class="normal"> </span><span class="symbol">(</span><span class="number">0xff</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> df</span><span class="symbol">-&gt;</span><span class="normal">Bshift</span><span class="symbol">);</span>
<span class="normal">		</span><span class="function">movd_m2r</span><span class="symbol">(</span><span class="normal">alpha</span><span class="symbol">,</span><span class="normal"> mm0</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* 00000FFF -&gt; mm0 */</span>
<span class="normal">		</span><span class="function">punpcklbw_r2r</span><span class="symbol">(</span><span class="normal">mm0</span><span class="symbol">,</span><span class="normal"> mm0</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* 00FFFFFF -&gt; mm0 */</span>
<span class="normal">		</span><span class="function">pand_r2r</span><span class="symbol">(</span><span class="normal">mm0</span><span class="symbol">,</span><span class="normal"> mm4</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* 0A0A0A0A -&gt; mm4, minus 1 chan */</span>
<span class="normal">			</span><span class="comment">/* at this point mm4 can be 000A0A0A or 0A0A0A00 or another combo */</span>
<span class="normal">		</span><span class="function">movd_m2r</span><span class="symbol">(</span><span class="normal">df</span><span class="symbol">-&gt;</span><span class="normal">Amask</span><span class="symbol">,</span><span class="normal"> mm7</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* dst alpha mask */</span>
<span class="normal">		</span><span class="function">punpckldq_r2r</span><span class="symbol">(</span><span class="normal">mm7</span><span class="symbol">,</span><span class="normal"> mm7</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* dst alpha mask | dst alpha mask -&gt; mm7 */</span>
<span class="normal">		</span>
<span class="normal">		</span><span class="keyword">while</span><span class="symbol">(</span><span class="normal">height</span><span class="symbol">--)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="function">DUFFS_LOOP_DOUBLE2</span><span class="symbol">(</span><span class="cbracket">{</span>
<span class="normal">				</span><span class="comment">/* One Pixel Blend */</span>
<span class="normal">				</span><span class="function">movd_m2r</span><span class="symbol">((*</span><span class="normal">srcp</span><span class="symbol">),</span><span class="normal"> mm1</span><span class="symbol">);</span><span class="comment">/* src(ARGB) -&gt; mm1 (0000ARGB)*/</span>
<span class="normal">				</span><span class="function">movd_m2r</span><span class="symbol">((*</span><span class="normal">dstp</span><span class="symbol">),</span><span class="normal"> mm2</span><span class="symbol">);</span><span class="comment">/* dst(ARGB) -&gt; mm2 (0000ARGB)*/</span>
<span class="normal">				</span><span class="function">punpcklbw_r2r</span><span class="symbol">(</span><span class="normal">mm5</span><span class="symbol">,</span><span class="normal"> mm1</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* 0A0R0G0B -&gt; mm1(src) */</span>
<span class="normal">				</span><span class="function">punpcklbw_r2r</span><span class="symbol">(</span><span class="normal">mm5</span><span class="symbol">,</span><span class="normal"> mm2</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* 0A0R0G0B -&gt; mm2(dst) */</span>

<span class="normal">				</span><span class="function">psubw_r2r</span><span class="symbol">(</span><span class="normal">mm2</span><span class="symbol">,</span><span class="normal"> mm1</span><span class="symbol">);</span><span class="comment">/* src - dst -&gt; mm1 */</span>
<span class="normal">				</span><span class="function">pmullw_r2r</span><span class="symbol">(</span><span class="normal">mm4</span><span class="symbol">,</span><span class="normal"> mm1</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* mm1 * alpha -&gt; mm1 */</span>
<span class="normal">				</span><span class="function">psrlw_i2r</span><span class="symbol">(</span><span class="number">8</span><span class="symbol">,</span><span class="normal"> mm1</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* mm1 &gt;&gt; 8 -&gt; mm1 */</span>
<span class="normal">				</span><span class="function">paddb_r2r</span><span class="symbol">(</span><span class="normal">mm1</span><span class="symbol">,</span><span class="normal"> mm2</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* mm1 + mm2(dst) -&gt; mm2 */</span>

<span class="normal">				</span><span class="function">packuswb_r2r</span><span class="symbol">(</span><span class="normal">mm5</span><span class="symbol">,</span><span class="normal"> mm2</span><span class="symbol">);</span><span class="normal">  </span><span class="comment">/* ARGBARGB -&gt; mm2 */</span>
<span class="normal">				</span><span class="function">por_r2r</span><span class="symbol">(</span><span class="normal">mm7</span><span class="symbol">,</span><span class="normal"> mm2</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* mm7(full alpha) | mm2 -&gt; mm2 */</span>
<span class="normal">				</span><span class="function">movd_r2m</span><span class="symbol">(</span><span class="normal">mm2</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dstp</span><span class="symbol">);</span><span class="comment">/* mm2 -&gt; pixel */</span>
<span class="normal">				</span><span class="symbol">++</span><span class="normal">srcp</span><span class="symbol">;</span>
<span class="normal">				</span><span class="symbol">++</span><span class="normal">dstp</span><span class="symbol">;</span>
<span class="normal">			</span><span class="cbracket">}</span><span class="symbol">,</span><span class="cbracket">{</span>
<span class="normal">				</span><span class="comment">/* Two Pixels Blend */</span>
<span class="normal">				</span><span class="function">movq_m2r</span><span class="symbol">((*</span><span class="normal">srcp</span><span class="symbol">),</span><span class="normal"> mm0</span><span class="symbol">);</span><span class="comment">/* 2 x src -&gt; mm0(ARGBARGB)*/</span>
<span class="normal">				</span><span class="function">movq_m2r</span><span class="symbol">((*</span><span class="normal">dstp</span><span class="symbol">),</span><span class="normal"> mm2</span><span class="symbol">);</span><span class="comment">/* 2 x dst -&gt; mm2(ARGBARGB) */</span>
<span class="normal">				</span><span class="function">movq_r2r</span><span class="symbol">(</span><span class="normal">mm0</span><span class="symbol">,</span><span class="normal"> mm1</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* 2 x src -&gt; mm1(ARGBARGB) */</span>
<span class="normal">				</span><span class="function">movq_r2r</span><span class="symbol">(</span><span class="normal">mm2</span><span class="symbol">,</span><span class="normal"> mm6</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* 2 x dst -&gt; mm6(ARGBARGB) */</span>

<span class="normal">				</span><span class="function">punpcklbw_r2r</span><span class="symbol">(</span><span class="normal">mm5</span><span class="symbol">,</span><span class="normal"> mm0</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* low - 0A0R0G0B -&gt; mm0(src1) */</span>
<span class="normal">				</span><span class="function">punpckhbw_r2r</span><span class="symbol">(</span><span class="normal">mm5</span><span class="symbol">,</span><span class="normal"> mm1</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* high - 0A0R0G0B -&gt; mm1(src2) */</span>
<span class="normal">				</span><span class="function">punpcklbw_r2r</span><span class="symbol">(</span><span class="normal">mm5</span><span class="symbol">,</span><span class="normal"> mm2</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* low - 0A0R0G0B -&gt; mm2(dst1) */</span>
<span class="normal">				</span><span class="function">punpckhbw_r2r</span><span class="symbol">(</span><span class="normal">mm5</span><span class="symbol">,</span><span class="normal"> mm6</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* high - 0A0R0G0B -&gt; mm6(dst2) */</span>

<span class="normal">				</span><span class="function">psubw_r2r</span><span class="symbol">(</span><span class="normal">mm2</span><span class="symbol">,</span><span class="normal"> mm0</span><span class="symbol">);</span><span class="comment">/* src1 - dst1 -&gt; mm0 */</span>
<span class="normal">				</span><span class="function">pmullw_r2r</span><span class="symbol">(</span><span class="normal">mm4</span><span class="symbol">,</span><span class="normal"> mm0</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* mm0 * alpha -&gt; mm0 */</span>
<span class="normal">				</span><span class="function">psrlw_i2r</span><span class="symbol">(</span><span class="number">8</span><span class="symbol">,</span><span class="normal"> mm0</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* mm0 &gt;&gt; 8 -&gt; mm1 */</span>
<span class="normal">				</span><span class="function">paddb_r2r</span><span class="symbol">(</span><span class="normal">mm0</span><span class="symbol">,</span><span class="normal"> mm2</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* mm0 + mm2(dst1) -&gt; mm2 */</span>

<span class="normal">				</span><span class="function">psubw_r2r</span><span class="symbol">(</span><span class="normal">mm6</span><span class="symbol">,</span><span class="normal"> mm1</span><span class="symbol">);</span><span class="comment">/* src2 - dst2 -&gt; mm1 */</span>
<span class="normal">				</span><span class="function">pmullw_r2r</span><span class="symbol">(</span><span class="normal">mm4</span><span class="symbol">,</span><span class="normal"> mm1</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* mm1 * alpha -&gt; mm1 */</span>
<span class="normal">				</span><span class="function">psrlw_i2r</span><span class="symbol">(</span><span class="number">8</span><span class="symbol">,</span><span class="normal"> mm1</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* mm1 &gt;&gt; 8 -&gt; mm1 */</span>
<span class="normal">				</span><span class="function">paddb_r2r</span><span class="symbol">(</span><span class="normal">mm1</span><span class="symbol">,</span><span class="normal"> mm6</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* mm1 + mm6(dst2) -&gt; mm6 */</span>

<span class="normal">				</span><span class="function">packuswb_r2r</span><span class="symbol">(</span><span class="normal">mm6</span><span class="symbol">,</span><span class="normal"> mm2</span><span class="symbol">);</span><span class="normal">  </span><span class="comment">/* ARGBARGB -&gt; mm2 */</span>
<span class="normal">				</span><span class="function">por_r2r</span><span class="symbol">(</span><span class="normal">mm7</span><span class="symbol">,</span><span class="normal"> mm2</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* mm7(dst alpha) | mm2 -&gt; mm2 */</span>
<span class="normal">				</span>
<span class="normal">				</span><span class="function">movq_r2m</span><span class="symbol">(</span><span class="normal">mm2</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dstp</span><span class="symbol">);</span><span class="comment">/* mm2 -&gt; 2 x pixel */</span>

<span class="normal">  				srcp </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">  				dstp </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">  			</span><span class="cbracket">}</span><span class="symbol">,</span><span class="normal"> width</span><span class="symbol">);</span>
<span class="normal">			srcp </span><span class="symbol">+=</span><span class="normal"> srcskip</span><span class="symbol">;</span>
<span class="normal">			dstp </span><span class="symbol">+=</span><span class="normal"> dstskip</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="function">emms</span><span class="symbol">();</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="comment">/* fast ARGB888-&gt;(A)RGB888 blending with pixel alpha */</span>
<span class="keyword">static</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="function">BlitRGBtoRGBPixelAlphaMMX</span><span class="symbol">(</span><span class="usertype">SDL_BlitInfo</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">info</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> width </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_width</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> height </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_height</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">Uint32</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">srcp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint32 </span><span class="symbol">*)</span><span class="normal">info</span><span class="symbol">-&gt;</span><span class="normal">s_pixels</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> srcskip </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">s_skip </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">Uint32</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dstp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint32 </span><span class="symbol">*)</span><span class="normal">info</span><span class="symbol">-&gt;</span><span class="normal">d_pixels</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> dstskip </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_skip </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">	SDL_PixelFormat</span><span class="symbol">*</span><span class="normal"> sf </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">src</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">Uint32</span><span class="normal"> amask </span><span class="symbol">=</span><span class="normal"> sf</span><span class="symbol">-&gt;</span><span class="normal">Amask</span><span class="symbol">;</span>

<span class="normal">	</span><span class="function">pxor_r2r</span><span class="symbol">(</span><span class="normal">mm6</span><span class="symbol">,</span><span class="normal"> mm6</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* 0 -&gt; mm6 */</span>
<span class="normal">	</span><span class="comment">/* form multiplication mask */</span>
<span class="normal">	</span><span class="function">movd_m2r</span><span class="symbol">(</span><span class="normal">sf</span><span class="symbol">-&gt;</span><span class="normal">Amask</span><span class="symbol">,</span><span class="normal"> mm7</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* 0000F000 -&gt; mm7 */</span>
<span class="normal">	</span><span class="function">punpcklbw_r2r</span><span class="symbol">(</span><span class="normal">mm7</span><span class="symbol">,</span><span class="normal"> mm7</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* FF000000 -&gt; mm7 */</span>
<span class="normal">	</span><span class="function">pcmpeqb_r2r</span><span class="symbol">(</span><span class="normal">mm0</span><span class="symbol">,</span><span class="normal"> mm0</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* FFFFFFFF -&gt; mm0 */</span>
<span class="normal">	</span><span class="function">movq_r2r</span><span class="symbol">(</span><span class="normal">mm0</span><span class="symbol">,</span><span class="normal"> mm3</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* FFFFFFFF -&gt; mm3 (for later) */</span>
<span class="normal">	</span><span class="function">pxor_r2r</span><span class="symbol">(</span><span class="normal">mm0</span><span class="symbol">,</span><span class="normal"> mm7</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* 00FFFFFF -&gt; mm7 (mult mask) */</span>
<span class="normal">	</span><span class="comment">/* form channel masks */</span>
<span class="normal">	</span><span class="function">movq_r2r</span><span class="symbol">(</span><span class="normal">mm7</span><span class="symbol">,</span><span class="normal"> mm0</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* 00FFFFFF -&gt; mm0 */</span>
<span class="normal">	</span><span class="function">packsswb_r2r</span><span class="symbol">(</span><span class="normal">mm6</span><span class="symbol">,</span><span class="normal"> mm0</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* 00000FFF -&gt; mm0 (channel mask) */</span>
<span class="normal">	</span><span class="function">packsswb_r2r</span><span class="symbol">(</span><span class="normal">mm6</span><span class="symbol">,</span><span class="normal"> mm3</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* 0000FFFF -&gt; mm3 */</span>
<span class="normal">	</span><span class="function">pxor_r2r</span><span class="symbol">(</span><span class="normal">mm0</span><span class="symbol">,</span><span class="normal"> mm3</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* 0000F000 -&gt; mm3 (~channel mask) */</span>
<span class="normal">	</span><span class="comment">/* get alpha channel shift */</span>
<span class="normal">	</span><span class="function">movd_m2r</span><span class="symbol">(</span><span class="normal">sf</span><span class="symbol">-&gt;</span><span class="normal">Ashift</span><span class="symbol">,</span><span class="normal"> mm5</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* Ashift -&gt; mm5 */</span>

<span class="normal">	</span><span class="keyword">while</span><span class="symbol">(</span><span class="normal">height</span><span class="symbol">--)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="function">DUFFS_LOOP4</span><span class="symbol">(</span><span class="cbracket">{</span>
<span class="normal">		</span><span class="usertype">Uint32</span><span class="normal"> alpha </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">srcp </span><span class="symbol">&amp;</span><span class="normal"> amask</span><span class="symbol">;</span>
<span class="normal">		</span><span class="comment">/* </span><span class="todo">FIXME:</span><span class="comment"> Here we special-case opaque alpha since the</span>
<span class="comment">			compositioning used (&gt;&gt;8 instead of /255) doesn't handle</span>
<span class="comment">			it correctly. Also special-case alpha=0 for speed?</span>
<span class="comment">			Benchmark this! */</span>
<span class="normal">		</span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">alpha </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="comment">/* do nothing */</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">alpha </span><span class="symbol">==</span><span class="normal"> amask</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="comment">/* opaque alpha -- copy RGB, keep dst alpha */</span>
<span class="normal">			</span><span class="comment">/* using MMX here to free up regular registers for other things */</span>
<span class="normal">			</span><span class="function">movd_m2r</span><span class="symbol">((*</span><span class="normal">srcp</span><span class="symbol">),</span><span class="normal"> mm1</span><span class="symbol">);</span><span class="comment">/* src(ARGB) -&gt; mm1 (0000ARGB)*/</span>
<span class="normal">			</span><span class="function">movd_m2r</span><span class="symbol">((*</span><span class="normal">dstp</span><span class="symbol">),</span><span class="normal"> mm2</span><span class="symbol">);</span><span class="comment">/* dst(ARGB) -&gt; mm2 (0000ARGB)*/</span>
<span class="normal">			</span><span class="function">pand_r2r</span><span class="symbol">(</span><span class="normal">mm0</span><span class="symbol">,</span><span class="normal"> mm1</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* src &amp; chanmask -&gt; mm1 */</span>
<span class="normal">			</span><span class="function">pand_r2r</span><span class="symbol">(</span><span class="normal">mm3</span><span class="symbol">,</span><span class="normal"> mm2</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* dst &amp; ~chanmask -&gt; mm2 */</span>
<span class="normal">			</span><span class="function">por_r2r</span><span class="symbol">(</span><span class="normal">mm1</span><span class="symbol">,</span><span class="normal"> mm2</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* src | dst -&gt; mm2 */</span>
<span class="normal">			</span><span class="function">movd_r2m</span><span class="symbol">(</span><span class="normal">mm2</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">(*</span><span class="normal">dstp</span><span class="symbol">));</span><span class="normal"> </span><span class="comment">/* mm2 -&gt; dst */</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="function">movd_m2r</span><span class="symbol">((*</span><span class="normal">srcp</span><span class="symbol">),</span><span class="normal"> mm1</span><span class="symbol">);</span><span class="comment">/* src(ARGB) -&gt; mm1 (0000ARGB)*/</span>
<span class="normal">			</span><span class="function">punpcklbw_r2r</span><span class="symbol">(</span><span class="normal">mm6</span><span class="symbol">,</span><span class="normal"> mm1</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* 0A0R0G0B -&gt; mm1 */</span>

<span class="normal">			</span><span class="function">movd_m2r</span><span class="symbol">((*</span><span class="normal">dstp</span><span class="symbol">),</span><span class="normal"> mm2</span><span class="symbol">);</span><span class="comment">/* dst(ARGB) -&gt; mm2 (0000ARGB)*/</span>
<span class="normal">			</span><span class="function">punpcklbw_r2r</span><span class="symbol">(</span><span class="normal">mm6</span><span class="symbol">,</span><span class="normal"> mm2</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* 0A0R0G0B -&gt; mm2 */</span>

<span class="normal">			</span><span class="usertype">__asm__</span><span class="normal"> </span><span class="function">__volatile__</span><span class="normal"> </span><span class="symbol">(</span>
<span class="normal">				</span><span class="string">"movd %0, %%mm4"</span>
<span class="normal">				</span><span class="symbol">:</span><span class="normal"> </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"r"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">alpha</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* 0000A000 -&gt; mm4 */</span>
<span class="normal">			</span><span class="function">psrld_r2r</span><span class="symbol">(</span><span class="normal">mm5</span><span class="symbol">,</span><span class="normal"> mm4</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* mm4 &gt;&gt; mm5 -&gt; mm4 (0000000A) */</span>
<span class="normal">			</span><span class="function">punpcklwd_r2r</span><span class="symbol">(</span><span class="normal">mm4</span><span class="symbol">,</span><span class="normal"> mm4</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* 00000A0A -&gt; mm4 */</span>
<span class="normal">			</span><span class="function">punpcklwd_r2r</span><span class="symbol">(</span><span class="normal">mm4</span><span class="symbol">,</span><span class="normal"> mm4</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* 0A0A0A0A -&gt; mm4 */</span>
<span class="normal">			</span><span class="function">pand_r2r</span><span class="symbol">(</span><span class="normal">mm7</span><span class="symbol">,</span><span class="normal"> mm4</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* 000A0A0A -&gt; mm4, preserve dst alpha on add */</span>

<span class="normal">			</span><span class="comment">/* blend */</span><span class="normal">		    </span>
<span class="normal">			</span><span class="function">psubw_r2r</span><span class="symbol">(</span><span class="normal">mm2</span><span class="symbol">,</span><span class="normal"> mm1</span><span class="symbol">);</span><span class="comment">/* src - dst -&gt; mm1 */</span>
<span class="normal">			</span><span class="function">pmullw_r2r</span><span class="symbol">(</span><span class="normal">mm4</span><span class="symbol">,</span><span class="normal"> mm1</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* mm1 * alpha -&gt; mm1 */</span>
<span class="normal">			</span><span class="function">psrlw_i2r</span><span class="symbol">(</span><span class="number">8</span><span class="symbol">,</span><span class="normal"> mm1</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* mm1 &gt;&gt; 8 -&gt; mm1(000R0G0B) */</span>
<span class="normal">			</span><span class="function">paddb_r2r</span><span class="symbol">(</span><span class="normal">mm1</span><span class="symbol">,</span><span class="normal"> mm2</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* mm1 + mm2(dst) -&gt; mm2 */</span>
<span class="normal">			</span>
<span class="normal">			</span><span class="function">packuswb_r2r</span><span class="symbol">(</span><span class="normal">mm6</span><span class="symbol">,</span><span class="normal"> mm2</span><span class="symbol">);</span><span class="normal">  </span><span class="comment">/* 0000ARGB -&gt; mm2 */</span>
<span class="normal">			</span><span class="function">movd_r2m</span><span class="symbol">(</span><span class="normal">mm2</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dstp</span><span class="symbol">);</span><span class="comment">/* mm2 -&gt; dst */</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="symbol">++</span><span class="normal">srcp</span><span class="symbol">;</span>
<span class="normal">		</span><span class="symbol">++</span><span class="normal">dstp</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="cbracket">}</span><span class="symbol">,</span><span class="normal"> width</span><span class="symbol">);</span>
<span class="normal">	    srcp </span><span class="symbol">+=</span><span class="normal"> srcskip</span><span class="symbol">;</span>
<span class="normal">	    dstp </span><span class="symbol">+=</span><span class="normal"> dstskip</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="function">emms</span><span class="symbol">();</span>
<span class="cbracket">}</span>
<span class="comment">/* End GCC_ASMBLIT */</span>

<span class="preproc">#elif</span><span class="normal"> MSVC_ASMBLIT</span>
<span class="comment">/* fast RGB888-&gt;(A)RGB888 blending with surface alpha=128 special case */</span>
<span class="keyword">static</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="function">BlitRGBtoRGBSurfaceAlpha128MMX</span><span class="symbol">(</span><span class="usertype">SDL_BlitInfo</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">info</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> width </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_width</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> height </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_height</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">Uint32</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">srcp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint32 </span><span class="symbol">*)</span><span class="normal">info</span><span class="symbol">-&gt;</span><span class="normal">s_pixels</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> srcskip </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">s_skip </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">Uint32</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dstp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint32 </span><span class="symbol">*)</span><span class="normal">info</span><span class="symbol">-&gt;</span><span class="normal">d_pixels</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> dstskip </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_skip </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">Uint32</span><span class="normal"> dalpha </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">dst</span><span class="symbol">-&gt;</span><span class="normal">Amask</span><span class="symbol">;</span>

<span class="normal">	</span><span class="usertype">__m64</span><span class="normal"> src1</span><span class="symbol">,</span><span class="normal"> src2</span><span class="symbol">,</span><span class="normal"> dst1</span><span class="symbol">,</span><span class="normal"> dst2</span><span class="symbol">,</span><span class="normal"> lmask</span><span class="symbol">,</span><span class="normal"> hmask</span><span class="symbol">,</span><span class="normal"> dsta</span><span class="symbol">;</span>
<span class="normal">	</span>
<span class="normal">	hmask </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_set_pi32</span><span class="symbol">(</span><span class="number">0x00fefefe</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x00fefefe</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* alpha128 mask -&gt; hmask */</span>
<span class="normal">	lmask </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_set_pi32</span><span class="symbol">(</span><span class="number">0x00010101</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x00010101</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* !alpha128 mask -&gt; lmask */</span>
<span class="normal">	dsta </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_set_pi32</span><span class="symbol">(</span><span class="normal">dalpha</span><span class="symbol">,</span><span class="normal"> dalpha</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* dst alpha mask -&gt; dsta */</span>

<span class="normal">	</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">height</span><span class="symbol">--)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> n </span><span class="symbol">=</span><span class="normal"> width</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal"> n </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="usertype">Uint32</span><span class="normal"> s </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">srcp</span><span class="symbol">++;</span>
<span class="normal">			</span><span class="usertype">Uint32</span><span class="normal"> d </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dstp</span><span class="symbol">;</span>
<span class="normal">			</span><span class="symbol">*</span><span class="normal">dstp</span><span class="symbol">++</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">((((</span><span class="normal">s </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x00fefefe</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">d </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x00fefefe</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span>
<span class="normal">				   </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">s </span><span class="symbol">&amp;</span><span class="normal"> d </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x00010101</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">|</span><span class="normal"> dalpha</span><span class="symbol">;</span>
<span class="normal">			n</span><span class="symbol">--;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span>
<span class="normal">		</span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">n </span><span class="symbol">&gt;&gt;=</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span><span class="normal"> n </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">--</span><span class="normal">n</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			dst1 </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">__m64</span><span class="symbol">*)</span><span class="normal">dstp</span><span class="symbol">;</span><span class="normal"> </span><span class="comment">/* 2 x dst -&gt; dst1(ARGBARGB) */</span>
<span class="normal">			dst2 </span><span class="symbol">=</span><span class="normal"> dst1</span><span class="symbol">;</span><span class="normal">   </span><span class="comment">/* 2 x dst -&gt; dst2(ARGBARGB) */</span>

<span class="normal">			src1 </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">__m64</span><span class="symbol">*)</span><span class="normal">srcp</span><span class="symbol">;</span><span class="normal"> </span><span class="comment">/* 2 x src -&gt; src1(ARGBARGB) */</span>
<span class="normal">			src2 </span><span class="symbol">=</span><span class="normal"> src1</span><span class="symbol">;</span><span class="normal"> </span><span class="comment">/* 2 x src -&gt; src2(ARGBARGB) */</span>

<span class="normal">			dst2 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_and_si64</span><span class="symbol">(</span><span class="normal">dst2</span><span class="symbol">,</span><span class="normal"> hmask</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* dst &amp; mask -&gt; dst2 */</span>
<span class="normal">			src2 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_and_si64</span><span class="symbol">(</span><span class="normal">src2</span><span class="symbol">,</span><span class="normal"> hmask</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* src &amp; mask -&gt; src2 */</span>
<span class="normal">			src2 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_add_pi32</span><span class="symbol">(</span><span class="normal">src2</span><span class="symbol">,</span><span class="normal"> dst2</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* dst2 + src2 -&gt; src2 */</span>
<span class="normal">			src2 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_srli_pi32</span><span class="symbol">(</span><span class="normal">src2</span><span class="symbol">,</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* src2 &gt;&gt; 1 -&gt; src2 */</span>

<span class="normal">			dst1 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_and_si64</span><span class="symbol">(</span><span class="normal">dst1</span><span class="symbol">,</span><span class="normal"> src1</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* src &amp; dst -&gt; dst1 */</span>
<span class="normal">			dst1 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_and_si64</span><span class="symbol">(</span><span class="normal">dst1</span><span class="symbol">,</span><span class="normal"> lmask</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* dst1 &amp; !mask -&gt; dst1 */</span>
<span class="normal">			dst1 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_add_pi32</span><span class="symbol">(</span><span class="normal">dst1</span><span class="symbol">,</span><span class="normal"> src2</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* src2 + dst1 -&gt; dst1 */</span>
<span class="normal">			dst1 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_or_si64</span><span class="symbol">(</span><span class="normal">dst1</span><span class="symbol">,</span><span class="normal"> dsta</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* dsta(full alpha) | dst1 -&gt; dst1 */</span>
<span class="normal">			</span>
<span class="normal">			</span><span class="symbol">*(</span><span class="normal">__m64</span><span class="symbol">*)</span><span class="normal">dstp </span><span class="symbol">=</span><span class="normal"> dst1</span><span class="symbol">;</span><span class="normal"> </span><span class="comment">/* dst1 -&gt; 2 x dst pixels */</span>
<span class="normal">			dstp </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">			srcp </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span>
<span class="normal">		srcp </span><span class="symbol">+=</span><span class="normal"> srcskip</span><span class="symbol">;</span>
<span class="normal">		dstp </span><span class="symbol">+=</span><span class="normal"> dstskip</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="function">_mm_empty</span><span class="symbol">();</span>
<span class="cbracket">}</span>

<span class="comment">/* fast RGB888-&gt;(A)RGB888 blending with surface alpha */</span>
<span class="keyword">static</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="function">BlitRGBtoRGBSurfaceAlphaMMX</span><span class="symbol">(</span><span class="usertype">SDL_BlitInfo</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">info</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">	SDL_PixelFormat</span><span class="symbol">*</span><span class="normal"> df </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">dst</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">Uint32</span><span class="normal"> chanmask </span><span class="symbol">=</span><span class="normal"> df</span><span class="symbol">-&gt;</span><span class="normal">Rmask </span><span class="symbol">|</span><span class="normal"> df</span><span class="symbol">-&gt;</span><span class="normal">Gmask </span><span class="symbol">|</span><span class="normal"> df</span><span class="symbol">-&gt;</span><span class="normal">Bmask</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">unsigned</span><span class="normal"> alpha </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">src</span><span class="symbol">-&gt;</span><span class="normal">alpha</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">alpha </span><span class="symbol">==</span><span class="normal"> </span><span class="number">128</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">df</span><span class="symbol">-&gt;</span><span class="normal">Rmask </span><span class="symbol">|</span><span class="normal"> df</span><span class="symbol">-&gt;</span><span class="normal">Gmask </span><span class="symbol">|</span><span class="normal"> df</span><span class="symbol">-&gt;</span><span class="normal">Bmask</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0x00FFFFFF</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="comment">/* only call a128 version when R,G,B occupy lower bits */</span>
<span class="normal">		</span><span class="function">BlitRGBtoRGBSurfaceAlpha128MMX</span><span class="symbol">(</span><span class="normal">info</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> width </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_width</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> height </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_height</span><span class="symbol">;</span>
<span class="normal">		</span><span class="usertype">Uint32</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">srcp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint32 </span><span class="symbol">*)</span><span class="normal">info</span><span class="symbol">-&gt;</span><span class="normal">s_pixels</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> srcskip </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">s_skip </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">		</span><span class="usertype">Uint32</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dstp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint32 </span><span class="symbol">*)</span><span class="normal">info</span><span class="symbol">-&gt;</span><span class="normal">d_pixels</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> dstskip </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_skip </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">		</span><span class="usertype">Uint32</span><span class="normal"> dalpha </span><span class="symbol">=</span><span class="normal"> df</span><span class="symbol">-&gt;</span><span class="normal">Amask</span><span class="symbol">;</span>
<span class="normal">		</span><span class="usertype">Uint32</span><span class="normal"> amult</span><span class="symbol">;</span>

<span class="normal">		</span><span class="usertype">__m64</span><span class="normal"> src1</span><span class="symbol">,</span><span class="normal"> src2</span><span class="symbol">,</span><span class="normal"> dst1</span><span class="symbol">,</span><span class="normal"> dst2</span><span class="symbol">,</span><span class="normal"> mm_alpha</span><span class="symbol">,</span><span class="normal"> mm_zero</span><span class="symbol">,</span><span class="normal"> dsta</span><span class="symbol">;</span>
<span class="normal">		</span>
<span class="normal">		mm_zero </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_setzero_si64</span><span class="symbol">();</span><span class="normal"> </span><span class="comment">/* 0 -&gt; mm_zero */</span>
<span class="normal">		</span><span class="comment">/* form the alpha mult */</span>
<span class="normal">		amult </span><span class="symbol">=</span><span class="normal"> alpha </span><span class="symbol">|</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">alpha </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">);</span>
<span class="normal">		amult </span><span class="symbol">=</span><span class="normal"> amult </span><span class="symbol">|</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">amult </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">16</span><span class="symbol">);</span>
<span class="normal">		chanmask </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="number">0xff</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> df</span><span class="symbol">-&gt;</span><span class="normal">Rshift</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">|</span><span class="normal"> </span><span class="symbol">(</span><span class="number">0xff</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> df</span><span class="symbol">-&gt;</span><span class="normal">Gshift</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">|</span><span class="normal"> </span><span class="symbol">(</span><span class="number">0xff</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> df</span><span class="symbol">-&gt;</span><span class="normal">Bshift</span><span class="symbol">);</span>
<span class="normal">		mm_alpha </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_set_pi32</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">,</span><span class="normal"> amult </span><span class="symbol">&amp;</span><span class="normal"> chanmask</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* 0000AAAA -&gt; mm_alpha, minus 1 chan */</span>
<span class="normal">		mm_alpha </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_unpacklo_pi8</span><span class="symbol">(</span><span class="normal">mm_alpha</span><span class="symbol">,</span><span class="normal"> mm_zero</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* 0A0A0A0A -&gt; mm_alpha, minus 1 chan */</span>
<span class="normal">			</span><span class="comment">/* at this point mm_alpha can be 000A0A0A or 0A0A0A00 or another combo */</span>
<span class="normal">		dsta </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_set_pi32</span><span class="symbol">(</span><span class="normal">dalpha</span><span class="symbol">,</span><span class="normal"> dalpha</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* dst alpha mask -&gt; dsta */</span>
<span class="normal">		</span>
<span class="normal">		</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">height</span><span class="symbol">--)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> n </span><span class="symbol">=</span><span class="normal"> width</span><span class="symbol">;</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">n </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="comment">/* One Pixel Blend */</span>
<span class="normal">				src2 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_cvtsi32_si64</span><span class="symbol">(*</span><span class="normal">srcp</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* src(ARGB) -&gt; src2 (0000ARGB)*/</span>
<span class="normal">				src2 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_unpacklo_pi8</span><span class="symbol">(</span><span class="normal">src2</span><span class="symbol">,</span><span class="normal"> mm_zero</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* 0A0R0G0B -&gt; src2 */</span>

<span class="normal">				dst1 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_cvtsi32_si64</span><span class="symbol">(*</span><span class="normal">dstp</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* dst(ARGB) -&gt; dst1 (0000ARGB)*/</span>
<span class="normal">				dst1 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_unpacklo_pi8</span><span class="symbol">(</span><span class="normal">dst1</span><span class="symbol">,</span><span class="normal"> mm_zero</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* 0A0R0G0B -&gt; dst1 */</span>

<span class="normal">				src2 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_sub_pi16</span><span class="symbol">(</span><span class="normal">src2</span><span class="symbol">,</span><span class="normal"> dst1</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* src2 - dst2 -&gt; src2 */</span>
<span class="normal">				src2 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_mullo_pi16</span><span class="symbol">(</span><span class="normal">src2</span><span class="symbol">,</span><span class="normal"> mm_alpha</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* src2 * alpha -&gt; src2 */</span>
<span class="normal">				src2 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_srli_pi16</span><span class="symbol">(</span><span class="normal">src2</span><span class="symbol">,</span><span class="normal"> </span><span class="number">8</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* src2 &gt;&gt; 8 -&gt; src2 */</span>
<span class="normal">				dst1 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_add_pi8</span><span class="symbol">(</span><span class="normal">src2</span><span class="symbol">,</span><span class="normal"> dst1</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* src2 + dst1 -&gt; dst1 */</span>
<span class="normal">				</span>
<span class="normal">				dst1 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_packs_pu16</span><span class="symbol">(</span><span class="normal">dst1</span><span class="symbol">,</span><span class="normal"> mm_zero</span><span class="symbol">);</span><span class="normal">  </span><span class="comment">/* 0000ARGB -&gt; dst1 */</span>
<span class="normal">				dst1 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_or_si64</span><span class="symbol">(</span><span class="normal">dst1</span><span class="symbol">,</span><span class="normal"> dsta</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* dsta | dst1 -&gt; dst1 */</span>
<span class="normal">				</span><span class="symbol">*</span><span class="normal">dstp </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_cvtsi64_si32</span><span class="symbol">(</span><span class="normal">dst1</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* dst1 -&gt; pixel */</span>

<span class="normal">				</span><span class="symbol">++</span><span class="normal">srcp</span><span class="symbol">;</span>
<span class="normal">				</span><span class="symbol">++</span><span class="normal">dstp</span><span class="symbol">;</span>
<span class="normal">				</span>
<span class="normal">				n</span><span class="symbol">--;</span>
<span class="normal">			</span><span class="cbracket">}</span>

<span class="normal">			</span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">n </span><span class="symbol">&gt;&gt;=</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span><span class="normal"> n </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">--</span><span class="normal">n</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="comment">/* Two Pixels Blend */</span>
<span class="normal">				src1 </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">__m64</span><span class="symbol">*)</span><span class="normal">srcp</span><span class="symbol">;</span><span class="normal"> </span><span class="comment">/* 2 x src -&gt; src1(ARGBARGB)*/</span>
<span class="normal">				src2 </span><span class="symbol">=</span><span class="normal"> src1</span><span class="symbol">;</span><span class="normal"> </span><span class="comment">/* 2 x src -&gt; src2(ARGBARGB) */</span>
<span class="normal">				src1 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_unpacklo_pi8</span><span class="symbol">(</span><span class="normal">src1</span><span class="symbol">,</span><span class="normal"> mm_zero</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* low - 0A0R0G0B -&gt; src1 */</span>
<span class="normal">				src2 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_unpackhi_pi8</span><span class="symbol">(</span><span class="normal">src2</span><span class="symbol">,</span><span class="normal"> mm_zero</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* high - 0A0R0G0B -&gt; src2 */</span>

<span class="normal">				dst1 </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">__m64</span><span class="symbol">*)</span><span class="normal">dstp</span><span class="symbol">;</span><span class="comment">/* 2 x dst -&gt; dst1(ARGBARGB) */</span>
<span class="normal">				dst2 </span><span class="symbol">=</span><span class="normal"> dst1</span><span class="symbol">;</span><span class="normal"> </span><span class="comment">/* 2 x dst -&gt; dst2(ARGBARGB) */</span>
<span class="normal">				dst1 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_unpacklo_pi8</span><span class="symbol">(</span><span class="normal">dst1</span><span class="symbol">,</span><span class="normal"> mm_zero</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* low - 0A0R0G0B -&gt; dst1 */</span>
<span class="normal">				dst2 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_unpackhi_pi8</span><span class="symbol">(</span><span class="normal">dst2</span><span class="symbol">,</span><span class="normal"> mm_zero</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* high - 0A0R0G0B -&gt; dst2 */</span>

<span class="normal">				src1 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_sub_pi16</span><span class="symbol">(</span><span class="normal">src1</span><span class="symbol">,</span><span class="normal"> dst1</span><span class="symbol">);</span><span class="comment">/* src1 - dst1 -&gt; src1 */</span>
<span class="normal">				src1 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_mullo_pi16</span><span class="symbol">(</span><span class="normal">src1</span><span class="symbol">,</span><span class="normal"> mm_alpha</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* src1 * alpha -&gt; src1 */</span>
<span class="normal">				src1 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_srli_pi16</span><span class="symbol">(</span><span class="normal">src1</span><span class="symbol">,</span><span class="normal"> </span><span class="number">8</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* src1 &gt;&gt; 8 -&gt; src1 */</span>
<span class="normal">				dst1 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_add_pi8</span><span class="symbol">(</span><span class="normal">src1</span><span class="symbol">,</span><span class="normal"> dst1</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* src1 + dst1(dst1) -&gt; dst1 */</span>

<span class="normal">				src2 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_sub_pi16</span><span class="symbol">(</span><span class="normal">src2</span><span class="symbol">,</span><span class="normal"> dst2</span><span class="symbol">);</span><span class="comment">/* src2 - dst2 -&gt; src2 */</span>
<span class="normal">				src2 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_mullo_pi16</span><span class="symbol">(</span><span class="normal">src2</span><span class="symbol">,</span><span class="normal"> mm_alpha</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* src2 * alpha -&gt; src2 */</span>
<span class="normal">				src2 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_srli_pi16</span><span class="symbol">(</span><span class="normal">src2</span><span class="symbol">,</span><span class="normal"> </span><span class="number">8</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* src2 &gt;&gt; 8 -&gt; src2 */</span>
<span class="normal">				dst2 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_add_pi8</span><span class="symbol">(</span><span class="normal">src2</span><span class="symbol">,</span><span class="normal"> dst2</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* src2 + dst2(dst2) -&gt; dst2 */</span>
<span class="normal">				</span>
<span class="normal">				dst1 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_packs_pu16</span><span class="symbol">(</span><span class="normal">dst1</span><span class="symbol">,</span><span class="normal"> dst2</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* 0A0R0G0B(res1), 0A0R0G0B(res2) -&gt; dst1(ARGBARGB) */</span>
<span class="normal">				dst1 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_or_si64</span><span class="symbol">(</span><span class="normal">dst1</span><span class="symbol">,</span><span class="normal"> dsta</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* dsta | dst1 -&gt; dst1 */</span>

<span class="normal">				</span><span class="symbol">*(</span><span class="normal">__m64</span><span class="symbol">*)</span><span class="normal">dstp </span><span class="symbol">=</span><span class="normal"> dst1</span><span class="symbol">;</span><span class="normal"> </span><span class="comment">/* dst1 -&gt; 2 x pixel */</span>

<span class="normal">				srcp </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">				dstp </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">			srcp </span><span class="symbol">+=</span><span class="normal"> srcskip</span><span class="symbol">;</span>
<span class="normal">			dstp </span><span class="symbol">+=</span><span class="normal"> dstskip</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="function">_mm_empty</span><span class="symbol">();</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="comment">/* fast ARGB888-&gt;(A)RGB888 blending with pixel alpha */</span>
<span class="keyword">static</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="function">BlitRGBtoRGBPixelAlphaMMX</span><span class="symbol">(</span><span class="usertype">SDL_BlitInfo</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">info</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> width </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_width</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> height </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_height</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">Uint32</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">srcp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint32 </span><span class="symbol">*)</span><span class="normal">info</span><span class="symbol">-&gt;</span><span class="normal">s_pixels</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> srcskip </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">s_skip </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">Uint32</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dstp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint32 </span><span class="symbol">*)</span><span class="normal">info</span><span class="symbol">-&gt;</span><span class="normal">d_pixels</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> dstskip </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_skip </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">	SDL_PixelFormat</span><span class="symbol">*</span><span class="normal"> sf </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">src</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">Uint32</span><span class="normal"> chanmask </span><span class="symbol">=</span><span class="normal"> sf</span><span class="symbol">-&gt;</span><span class="normal">Rmask </span><span class="symbol">|</span><span class="normal"> sf</span><span class="symbol">-&gt;</span><span class="normal">Gmask </span><span class="symbol">|</span><span class="normal"> sf</span><span class="symbol">-&gt;</span><span class="normal">Bmask</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">Uint32</span><span class="normal"> amask </span><span class="symbol">=</span><span class="normal"> sf</span><span class="symbol">-&gt;</span><span class="normal">Amask</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">Uint32</span><span class="normal"> ashift </span><span class="symbol">=</span><span class="normal"> sf</span><span class="symbol">-&gt;</span><span class="normal">Ashift</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">Uint64</span><span class="normal"> multmask</span><span class="symbol">;</span>

<span class="normal">	</span><span class="usertype">__m64</span><span class="normal"> src1</span><span class="symbol">,</span><span class="normal"> dst1</span><span class="symbol">,</span><span class="normal"> mm_alpha</span><span class="symbol">,</span><span class="normal"> mm_zero</span><span class="symbol">,</span><span class="normal"> dmask</span><span class="symbol">;</span>

<span class="normal">	mm_zero </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_setzero_si64</span><span class="symbol">();</span><span class="normal"> </span><span class="comment">/* 0 -&gt; mm_zero */</span>
<span class="normal">	multmask </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">~(</span><span class="normal">0xFFFFi64 </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ashift </span><span class="symbol">*</span><span class="normal"> </span><span class="number">2</span><span class="symbol">));</span>
<span class="normal">	dmask </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">__m64</span><span class="symbol">*)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">multmask</span><span class="symbol">;</span><span class="normal"> </span><span class="comment">/* dst alpha mask -&gt; dmask */</span>

<span class="normal">	</span><span class="keyword">while</span><span class="symbol">(</span><span class="normal">height</span><span class="symbol">--)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">DUFFS_LOOP4</span><span class="symbol">(</span><span class="cbracket">{</span>
<span class="normal">		</span><span class="usertype">Uint32</span><span class="normal"> alpha </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">srcp </span><span class="symbol">&amp;</span><span class="normal"> amask</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">alpha </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="comment">/* do nothing */</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">alpha </span><span class="symbol">==</span><span class="normal"> amask</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="comment">/* opaque alpha -- copy RGB, keep dst alpha */</span>
<span class="normal">			</span><span class="symbol">*</span><span class="normal">dstp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(*</span><span class="normal">srcp </span><span class="symbol">&amp;</span><span class="normal"> chanmask</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">|</span><span class="normal"> </span><span class="symbol">(*</span><span class="normal">dstp </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="symbol">~</span><span class="normal">chanmask</span><span class="symbol">);</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			src1 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_cvtsi32_si64</span><span class="symbol">(*</span><span class="normal">srcp</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* src(ARGB) -&gt; src1 (0000ARGB)*/</span>
<span class="normal">			src1 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_unpacklo_pi8</span><span class="symbol">(</span><span class="normal">src1</span><span class="symbol">,</span><span class="normal"> mm_zero</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* 0A0R0G0B -&gt; src1 */</span>

<span class="normal">			dst1 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_cvtsi32_si64</span><span class="symbol">(*</span><span class="normal">dstp</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* dst(ARGB) -&gt; dst1 (0000ARGB)*/</span>
<span class="normal">			dst1 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_unpacklo_pi8</span><span class="symbol">(</span><span class="normal">dst1</span><span class="symbol">,</span><span class="normal"> mm_zero</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* 0A0R0G0B -&gt; dst1 */</span>

<span class="normal">			mm_alpha </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_cvtsi32_si64</span><span class="symbol">(</span><span class="normal">alpha</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* alpha -&gt; mm_alpha (0000000A) */</span>
<span class="normal">			mm_alpha </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_srli_si64</span><span class="symbol">(</span><span class="normal">mm_alpha</span><span class="symbol">,</span><span class="normal"> ashift</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* mm_alpha &gt;&gt; ashift -&gt; mm_alpha(0000000A) */</span>
<span class="normal">			mm_alpha </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_unpacklo_pi16</span><span class="symbol">(</span><span class="normal">mm_alpha</span><span class="symbol">,</span><span class="normal"> mm_alpha</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* 00000A0A -&gt; mm_alpha */</span>
<span class="normal">			mm_alpha </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_unpacklo_pi32</span><span class="symbol">(</span><span class="normal">mm_alpha</span><span class="symbol">,</span><span class="normal"> mm_alpha</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* 0A0A0A0A -&gt; mm_alpha */</span>
<span class="normal">			mm_alpha </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_and_si64</span><span class="symbol">(</span><span class="normal">mm_alpha</span><span class="symbol">,</span><span class="normal"> dmask</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* 000A0A0A -&gt; mm_alpha, preserve dst alpha on add */</span>

<span class="normal">			</span><span class="comment">/* blend */</span><span class="normal">		    </span>
<span class="normal">			src1 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_sub_pi16</span><span class="symbol">(</span><span class="normal">src1</span><span class="symbol">,</span><span class="normal"> dst1</span><span class="symbol">);</span><span class="comment">/* src1 - dst1 -&gt; src1 */</span>
<span class="normal">			src1 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_mullo_pi16</span><span class="symbol">(</span><span class="normal">src1</span><span class="symbol">,</span><span class="normal"> mm_alpha</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* (src1 - dst1) * alpha -&gt; src1 */</span>
<span class="normal">			src1 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_srli_pi16</span><span class="symbol">(</span><span class="normal">src1</span><span class="symbol">,</span><span class="normal"> </span><span class="number">8</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* src1 &gt;&gt; 8 -&gt; src1(000R0G0B) */</span>
<span class="normal">			dst1 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_add_pi8</span><span class="symbol">(</span><span class="normal">src1</span><span class="symbol">,</span><span class="normal"> dst1</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* src1 + dst1 -&gt; dst1(0A0R0G0B) */</span>
<span class="normal">			dst1 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_packs_pu16</span><span class="symbol">(</span><span class="normal">dst1</span><span class="symbol">,</span><span class="normal"> mm_zero</span><span class="symbol">);</span><span class="normal">  </span><span class="comment">/* 0000ARGB -&gt; dst1 */</span>
<span class="normal">			</span>
<span class="normal">			</span><span class="symbol">*</span><span class="normal">dstp </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_cvtsi64_si32</span><span class="symbol">(</span><span class="normal">dst1</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* dst1 -&gt; pixel */</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="symbol">++</span><span class="normal">srcp</span><span class="symbol">;</span>
<span class="normal">		</span><span class="symbol">++</span><span class="normal">dstp</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="cbracket">}</span><span class="symbol">,</span><span class="normal"> width</span><span class="symbol">);</span>
<span class="normal">	    srcp </span><span class="symbol">+=</span><span class="normal"> srcskip</span><span class="symbol">;</span>
<span class="normal">	    dstp </span><span class="symbol">+=</span><span class="normal"> dstskip</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="function">_mm_empty</span><span class="symbol">();</span>
<span class="cbracket">}</span>
<span class="comment">/* End MSVC_ASMBLIT */</span>

<span class="preproc">#endif</span><span class="normal"> </span><span class="comment">/* GCC_ASMBLIT, MSVC_ASMBLIT */</span>

<span class="preproc">#if</span><span class="normal"> SDL_ALTIVEC_BLITTERS</span>
<span class="preproc">#if</span><span class="normal"> __MWERKS__</span>
<span class="preproc">#pragma</span><span class="normal"> altivec_model on</span>
<span class="preproc">#endif</span>
<span class="preproc">#if</span><span class="normal"> HAVE_ALTIVEC_H</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">&lt;altivec.h&gt;</span>
<span class="preproc">#endif</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">&lt;assert.h&gt;</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">defined</span><span class="symbol">(</span><span class="normal">__MACOSX__</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">__GNUC__ </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">4</span><span class="symbol">))</span>
<span class="preproc">    #define</span><span class="normal"> </span><span class="function">VECUINT8_LITERAL</span><span class="symbol">(</span><span class="normal">a</span><span class="symbol">,</span><span class="normal">b</span><span class="symbol">,</span><span class="normal">c</span><span class="symbol">,</span><span class="normal">d</span><span class="symbol">,</span><span class="normal">e</span><span class="symbol">,</span><span class="normal">f</span><span class="symbol">,</span><span class="normal">g</span><span class="symbol">,</span><span class="normal">h</span><span class="symbol">,</span><span class="normal">i</span><span class="symbol">,</span><span class="normal">j</span><span class="symbol">,</span><span class="normal">k</span><span class="symbol">,</span><span class="normal">l</span><span class="symbol">,</span><span class="normal">m</span><span class="symbol">,</span><span class="normal">n</span><span class="symbol">,</span><span class="normal">o</span><span class="symbol">,</span><span class="normal">p</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">        </span><span class="symbol">(</span><span class="normal">vector </span><span class="usertype">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">(</span><span class="normal"> a</span><span class="symbol">,</span><span class="normal">b</span><span class="symbol">,</span><span class="normal">c</span><span class="symbol">,</span><span class="normal">d</span><span class="symbol">,</span><span class="normal">e</span><span class="symbol">,</span><span class="normal">f</span><span class="symbol">,</span><span class="normal">g</span><span class="symbol">,</span><span class="normal">h</span><span class="symbol">,</span><span class="normal">i</span><span class="symbol">,</span><span class="normal">j</span><span class="symbol">,</span><span class="normal">k</span><span class="symbol">,</span><span class="normal">l</span><span class="symbol">,</span><span class="normal">m</span><span class="symbol">,</span><span class="normal">n</span><span class="symbol">,</span><span class="normal">o</span><span class="symbol">,</span><span class="normal">p </span><span class="symbol">)</span>
<span class="preproc">    #define</span><span class="normal"> </span><span class="function">VECUINT16_LITERAL</span><span class="symbol">(</span><span class="normal">a</span><span class="symbol">,</span><span class="normal">b</span><span class="symbol">,</span><span class="normal">c</span><span class="symbol">,</span><span class="normal">d</span><span class="symbol">,</span><span class="normal">e</span><span class="symbol">,</span><span class="normal">f</span><span class="symbol">,</span><span class="normal">g</span><span class="symbol">,</span><span class="normal">h</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">        </span><span class="symbol">(</span><span class="normal">vector </span><span class="usertype">unsigned</span><span class="normal"> </span><span class="type">short</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">(</span><span class="normal"> a</span><span class="symbol">,</span><span class="normal">b</span><span class="symbol">,</span><span class="normal">c</span><span class="symbol">,</span><span class="normal">d</span><span class="symbol">,</span><span class="normal">e</span><span class="symbol">,</span><span class="normal">f</span><span class="symbol">,</span><span class="normal">g</span><span class="symbol">,</span><span class="normal">h </span><span class="symbol">)</span>
<span class="preproc">#else</span>
<span class="preproc">    #define</span><span class="normal"> </span><span class="function">VECUINT8_LITERAL</span><span class="symbol">(</span><span class="normal">a</span><span class="symbol">,</span><span class="normal">b</span><span class="symbol">,</span><span class="normal">c</span><span class="symbol">,</span><span class="normal">d</span><span class="symbol">,</span><span class="normal">e</span><span class="symbol">,</span><span class="normal">f</span><span class="symbol">,</span><span class="normal">g</span><span class="symbol">,</span><span class="normal">h</span><span class="symbol">,</span><span class="normal">i</span><span class="symbol">,</span><span class="normal">j</span><span class="symbol">,</span><span class="normal">k</span><span class="symbol">,</span><span class="normal">l</span><span class="symbol">,</span><span class="normal">m</span><span class="symbol">,</span><span class="normal">n</span><span class="symbol">,</span><span class="normal">o</span><span class="symbol">,</span><span class="normal">p</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">        </span><span class="symbol">(</span><span class="normal">vector </span><span class="usertype">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal"> a</span><span class="symbol">,</span><span class="normal">b</span><span class="symbol">,</span><span class="normal">c</span><span class="symbol">,</span><span class="normal">d</span><span class="symbol">,</span><span class="normal">e</span><span class="symbol">,</span><span class="normal">f</span><span class="symbol">,</span><span class="normal">g</span><span class="symbol">,</span><span class="normal">h</span><span class="symbol">,</span><span class="normal">i</span><span class="symbol">,</span><span class="normal">j</span><span class="symbol">,</span><span class="normal">k</span><span class="symbol">,</span><span class="normal">l</span><span class="symbol">,</span><span class="normal">m</span><span class="symbol">,</span><span class="normal">n</span><span class="symbol">,</span><span class="normal">o</span><span class="symbol">,</span><span class="normal">p </span><span class="cbracket">}</span>
<span class="preproc">    #define</span><span class="normal"> </span><span class="function">VECUINT16_LITERAL</span><span class="symbol">(</span><span class="normal">a</span><span class="symbol">,</span><span class="normal">b</span><span class="symbol">,</span><span class="normal">c</span><span class="symbol">,</span><span class="normal">d</span><span class="symbol">,</span><span class="normal">e</span><span class="symbol">,</span><span class="normal">f</span><span class="symbol">,</span><span class="normal">g</span><span class="symbol">,</span><span class="normal">h</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">        </span><span class="symbol">(</span><span class="normal">vector </span><span class="usertype">unsigned</span><span class="normal"> </span><span class="type">short</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal"> a</span><span class="symbol">,</span><span class="normal">b</span><span class="symbol">,</span><span class="normal">c</span><span class="symbol">,</span><span class="normal">d</span><span class="symbol">,</span><span class="normal">e</span><span class="symbol">,</span><span class="normal">f</span><span class="symbol">,</span><span class="normal">g</span><span class="symbol">,</span><span class="normal">h </span><span class="cbracket">}</span>
<span class="preproc">#endif</span>

<span class="preproc">#define</span><span class="normal"> </span><span class="function">UNALIGNED_PTR</span><span class="symbol">(</span><span class="normal">x</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">(((</span><span class="normal">size_t</span><span class="symbol">)</span><span class="normal"> x</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x0000000F</span><span class="symbol">)</span>
<span class="preproc">#define</span><span class="normal"> </span><span class="function">VECPRINT</span><span class="symbol">(</span><span class="normal">msg</span><span class="symbol">,</span><span class="normal"> v</span><span class="symbol">)</span><span class="normal"> </span><span class="keyword">do</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> tmpvec </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vector </span><span class="usertype">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="symbol">)(</span><span class="normal">v</span><span class="symbol">);</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">    </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">vp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> </span><span class="symbol">*)&amp;</span><span class="normal">tmpvec</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">    </span><span class="function">printf</span><span class="symbol">(</span><span class="string">"%s = %08X %08X %08X %08X</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> msg</span><span class="symbol">,</span><span class="normal"> vp</span><span class="symbol">[</span><span class="number">0</span><span class="symbol">],</span><span class="normal"> vp</span><span class="symbol">[</span><span class="number">1</span><span class="symbol">],</span><span class="normal"> vp</span><span class="symbol">[</span><span class="number">2</span><span class="symbol">],</span><span class="normal"> vp</span><span class="symbol">[</span><span class="number">3</span><span class="symbol">]);</span><span class="normal"> </span><span class="symbol">\</span>
<span class="cbracket">}</span><span class="normal"> </span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="number">0</span><span class="symbol">)</span>

<span class="comment">/* the permuation vector that takes the high bytes out of all the appropriate shorts </span>
<span class="comment">    (vector unsigned char)(</span>
<span class="comment">        0x00, 0x10, 0x02, 0x12,</span>
<span class="comment">        0x04, 0x14, 0x06, 0x16,</span>
<span class="comment">        0x08, 0x18, 0x0A, 0x1A,</span>
<span class="comment">        0x0C, 0x1C, 0x0E, 0x1E );</span>
<span class="comment">*/</span>
<span class="preproc">#define</span><span class="normal"> </span><span class="function">VEC_MERGE_PERMUTE</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">(</span><span class="function">vec_add</span><span class="symbol">(</span><span class="function">vec_lvsl</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="symbol">*)</span><span class="normal">NULL</span><span class="symbol">),</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vector </span><span class="usertype">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="symbol">)</span><span class="function">vec_splat_u16</span><span class="symbol">(</span><span class="number">0x0F</span><span class="symbol">)))</span>
<span class="preproc">#define</span><span class="normal"> </span><span class="function">VEC_U32_24</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">(</span><span class="function">vec_add</span><span class="symbol">(</span><span class="function">vec_splat_u32</span><span class="symbol">(</span><span class="number">12</span><span class="symbol">),</span><span class="normal"> </span><span class="function">vec_splat_u32</span><span class="symbol">(</span><span class="number">12</span><span class="symbol">)))</span>
<span class="preproc">#define</span><span class="normal"> </span><span class="function">VEC_ALPHA_MASK</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">vector </span><span class="usertype">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="symbol">)</span><span class="function">vec_sl</span><span class="symbol">((</span><span class="normal">vector </span><span class="usertype">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="symbol">)</span><span class="function">vec_splat_s8</span><span class="symbol">(-</span><span class="number">1</span><span class="symbol">),</span><span class="normal"> </span><span class="function">VEC_U32_24</span><span class="symbol">()))</span>
<span class="preproc">#define</span><span class="normal"> </span><span class="function">VEC_ALIGNER</span><span class="symbol">(</span><span class="normal">src</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">((</span><span class="function">UNALIGNED_PTR</span><span class="symbol">(</span><span class="normal">src</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">    </span><span class="symbol">?</span><span class="normal"> </span><span class="function">vec_lvsl</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">,</span><span class="normal"> src</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">    </span><span class="symbol">:</span><span class="normal"> </span><span class="function">vec_add</span><span class="symbol">(</span><span class="function">vec_lvsl</span><span class="symbol">(</span><span class="number">8</span><span class="symbol">,</span><span class="normal"> src</span><span class="symbol">),</span><span class="normal"> </span><span class="function">vec_splat_u8</span><span class="symbol">(</span><span class="number">8</span><span class="symbol">)))</span>

<span class="normal">   </span>
<span class="preproc">#define</span><span class="normal"> </span><span class="function">VEC_MULTIPLY_ALPHA</span><span class="symbol">(</span><span class="normal">vs</span><span class="symbol">,</span><span class="normal"> vd</span><span class="symbol">,</span><span class="normal"> valpha</span><span class="symbol">,</span><span class="normal"> mergePermute</span><span class="symbol">,</span><span class="normal"> v1_16</span><span class="symbol">,</span><span class="normal"> v8_16</span><span class="symbol">)</span><span class="normal"> </span><span class="keyword">do</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">    </span><span class="comment">/* vtemp1 contains source AAGGAAGGAAGGAAGG */</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">short</span><span class="normal"> vtemp1 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_mule</span><span class="symbol">(</span><span class="normal">vs</span><span class="symbol">,</span><span class="normal"> valpha</span><span class="symbol">);</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">    </span><span class="comment">/* vtemp2 contains source RRBBRRBBRRBBRRBB */</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">short</span><span class="normal"> vtemp2 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_mulo</span><span class="symbol">(</span><span class="normal">vs</span><span class="symbol">,</span><span class="normal"> valpha</span><span class="symbol">);</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">    </span><span class="comment">/* valpha2 is 255-alpha */</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> valpha2 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_nor</span><span class="symbol">(</span><span class="normal">valpha</span><span class="symbol">,</span><span class="normal"> valpha</span><span class="symbol">);</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">    </span><span class="comment">/* vtemp3 contains dest AAGGAAGGAAGGAAGG */</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">short</span><span class="normal"> vtemp3 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_mule</span><span class="symbol">(</span><span class="normal">vd</span><span class="symbol">,</span><span class="normal"> valpha2</span><span class="symbol">);</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">    </span><span class="comment">/* vtemp4 contains dest RRBBRRBBRRBBRRBB */</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">short</span><span class="normal"> vtemp4 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_mulo</span><span class="symbol">(</span><span class="normal">vd</span><span class="symbol">,</span><span class="normal"> valpha2</span><span class="symbol">);</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">    </span><span class="comment">/* add source and dest */</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">    vtemp1 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_add</span><span class="symbol">(</span><span class="normal">vtemp1</span><span class="symbol">,</span><span class="normal"> vtemp3</span><span class="symbol">);</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">    vtemp2 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_add</span><span class="symbol">(</span><span class="normal">vtemp2</span><span class="symbol">,</span><span class="normal"> vtemp4</span><span class="symbol">);</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">    </span><span class="comment">/* vtemp1 = (vtemp1 + 1) + ((vtemp1 + 1) &gt;&gt; 8) */</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">    vtemp1 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_add</span><span class="symbol">(</span><span class="normal">vtemp1</span><span class="symbol">,</span><span class="normal"> v1_16</span><span class="symbol">);</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">    vtemp3 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_sr</span><span class="symbol">(</span><span class="normal">vtemp1</span><span class="symbol">,</span><span class="normal"> v8_16</span><span class="symbol">);</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">    vtemp1 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_add</span><span class="symbol">(</span><span class="normal">vtemp1</span><span class="symbol">,</span><span class="normal"> vtemp3</span><span class="symbol">);</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">    </span><span class="comment">/* vtemp2 = (vtemp2 + 1) + ((vtemp2 + 1) &gt;&gt; 8) */</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">    vtemp2 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_add</span><span class="symbol">(</span><span class="normal">vtemp2</span><span class="symbol">,</span><span class="normal"> v1_16</span><span class="symbol">);</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">    vtemp4 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_sr</span><span class="symbol">(</span><span class="normal">vtemp2</span><span class="symbol">,</span><span class="normal"> v8_16</span><span class="symbol">);</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">    vtemp2 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_add</span><span class="symbol">(</span><span class="normal">vtemp2</span><span class="symbol">,</span><span class="normal"> vtemp4</span><span class="symbol">);</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">    </span><span class="comment">/* (&gt;&gt;8) and get ARGBARGBARGBARGB */</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">    vd </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vector </span><span class="usertype">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="symbol">)</span><span class="function">vec_perm</span><span class="symbol">(</span><span class="normal">vtemp1</span><span class="symbol">,</span><span class="normal"> vtemp2</span><span class="symbol">,</span><span class="normal"> mergePermute</span><span class="symbol">);</span><span class="normal"> </span><span class="symbol">\</span>
<span class="cbracket">}</span><span class="normal"> </span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="number">0</span><span class="symbol">)</span>
<span class="normal"> </span>
<span class="comment">/* Calculate the permute vector used for 32-&gt;32 swizzling */</span>
<span class="keyword">static</span><span class="normal"> vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="function">calc_swizzle32</span><span class="symbol">(</span><span class="keyword">const</span><span class="normal"> </span><span class="usertype">SDL_PixelFormat</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">srcfmt</span><span class="symbol">,</span>
<span class="normal">                                  </span><span class="keyword">const</span><span class="normal"> </span><span class="usertype">SDL_PixelFormat</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dstfmt</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="comment">/*</span>
<span class="comment">     * We have to assume that the bits that aren't used by other</span>
<span class="comment">     *  colors is alpha, and it's one complete byte, since some formats</span>
<span class="comment">     *  leave alpha with a zero mask, but we should still swizzle the bits.</span>
<span class="comment">     */</span>
<span class="normal">    </span><span class="comment">/* ARGB */</span>
<span class="normal">    </span><span class="keyword">const</span><span class="normal"> </span><span class="keyword">static</span><span class="normal"> </span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">SDL_PixelFormat</span><span class="normal"> default_pixel_format </span><span class="symbol">=</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">        NULL</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span>
<span class="normal">        </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span>
<span class="normal">        </span><span class="number">16</span><span class="symbol">,</span><span class="normal"> </span><span class="number">8</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="number">24</span><span class="symbol">,</span>
<span class="normal">        </span><span class="number">0x00FF0000</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x0000FF00</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x000000FF</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0xFF000000</span><span class="symbol">,</span>
<span class="normal">        </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="cbracket">}</span><span class="symbol">;</span>
<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">srcfmt</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">        srcfmt </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">default_pixel_format</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">dstfmt</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">        dstfmt </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">default_pixel_format</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="normal">    </span><span class="keyword">const</span><span class="normal"> vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> plus </span><span class="symbol">=</span><span class="normal"> VECUINT8_LITERAL</span>
<span class="normal">                                            </span><span class="symbol">(</span><span class="normal"> </span><span class="number">0x00</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x00</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x00</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x00</span><span class="symbol">,</span>
<span class="normal">                                              </span><span class="number">0x04</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x04</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x04</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x04</span><span class="symbol">,</span>
<span class="normal">                                              </span><span class="number">0x08</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x08</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x08</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x08</span><span class="symbol">,</span>
<span class="normal">                                              </span><span class="number">0x0C</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x0C</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x0C</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x0C</span><span class="normal"> </span><span class="symbol">);</span>
<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> vswiz</span><span class="symbol">;</span>
<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> srcvec</span><span class="symbol">;</span>
<span class="preproc">#define</span><span class="normal"> </span><span class="function">RESHIFT</span><span class="symbol">(</span><span class="normal">X</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">(</span><span class="number">3</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">X</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">3</span><span class="symbol">))</span>
<span class="normal">    </span><span class="usertype">Uint32</span><span class="normal"> rmask </span><span class="symbol">=</span><span class="normal"> </span><span class="function">RESHIFT</span><span class="symbol">(</span><span class="normal">srcfmt</span><span class="symbol">-&gt;</span><span class="normal">Rshift</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dstfmt</span><span class="symbol">-&gt;</span><span class="normal">Rshift</span><span class="symbol">);</span>
<span class="normal">    </span><span class="usertype">Uint32</span><span class="normal"> gmask </span><span class="symbol">=</span><span class="normal"> </span><span class="function">RESHIFT</span><span class="symbol">(</span><span class="normal">srcfmt</span><span class="symbol">-&gt;</span><span class="normal">Gshift</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dstfmt</span><span class="symbol">-&gt;</span><span class="normal">Gshift</span><span class="symbol">);</span>
<span class="normal">    </span><span class="usertype">Uint32</span><span class="normal"> bmask </span><span class="symbol">=</span><span class="normal"> </span><span class="function">RESHIFT</span><span class="symbol">(</span><span class="normal">srcfmt</span><span class="symbol">-&gt;</span><span class="normal">Bshift</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dstfmt</span><span class="symbol">-&gt;</span><span class="normal">Bshift</span><span class="symbol">);</span>
<span class="normal">    </span><span class="usertype">Uint32</span><span class="normal"> amask</span><span class="symbol">;</span>
<span class="normal">    </span><span class="comment">/* Use zero for alpha if either surface doesn't have alpha */</span>
<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dstfmt</span><span class="symbol">-&gt;</span><span class="normal">Amask</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">        amask </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">srcfmt</span><span class="symbol">-&gt;</span><span class="normal">Amask</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">?</span><span class="normal"> </span><span class="function">RESHIFT</span><span class="symbol">(</span><span class="normal">srcfmt</span><span class="symbol">-&gt;</span><span class="normal">Ashift</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">:</span><span class="normal"> </span><span class="number">0x10</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dstfmt</span><span class="symbol">-&gt;</span><span class="normal">Ashift</span><span class="symbol">);</span>
<span class="normal">    </span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">        amask </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0x10101010</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">dstfmt</span><span class="symbol">-&gt;</span><span class="normal">Rmask </span><span class="symbol">|</span><span class="normal"> dstfmt</span><span class="symbol">-&gt;</span><span class="normal">Gmask </span><span class="symbol">|</span><span class="normal"> dstfmt</span><span class="symbol">-&gt;</span><span class="normal">Bmask</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">^</span><span class="normal"> </span><span class="number">0xFFFFFFFF</span><span class="symbol">);</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="preproc">#undef</span><span class="normal"> RESHIFT  </span>
<span class="normal">    </span><span class="symbol">((</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> </span><span class="symbol">*)(</span><span class="type">char</span><span class="symbol">*)&amp;</span><span class="normal">srcvec</span><span class="symbol">)[</span><span class="number">0</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">rmask </span><span class="symbol">|</span><span class="normal"> gmask </span><span class="symbol">|</span><span class="normal"> bmask </span><span class="symbol">|</span><span class="normal"> amask</span><span class="symbol">);</span>
<span class="normal">    vswiz </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_add</span><span class="symbol">(</span><span class="normal">plus</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vector </span><span class="usertype">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="symbol">)</span><span class="function">vec_splat</span><span class="symbol">(</span><span class="normal">srcvec</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">));</span>
<span class="normal">    </span><span class="keyword">return</span><span class="symbol">(</span><span class="normal">vswiz</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="keyword">static</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="function">Blit32to565PixelAlphaAltivec</span><span class="symbol">(</span><span class="usertype">SDL_BlitInfo</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">info</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="type">int</span><span class="normal"> height </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_height</span><span class="symbol">;</span>
<span class="normal">    </span><span class="usertype">Uint8</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">src </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint8 </span><span class="symbol">*)</span><span class="normal">info</span><span class="symbol">-&gt;</span><span class="normal">s_pixels</span><span class="symbol">;</span>
<span class="normal">    </span><span class="type">int</span><span class="normal"> srcskip </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">s_skip</span><span class="symbol">;</span>
<span class="normal">    </span><span class="usertype">Uint8</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dst </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint8 </span><span class="symbol">*)</span><span class="normal">info</span><span class="symbol">-&gt;</span><span class="normal">d_pixels</span><span class="symbol">;</span>
<span class="normal">    </span><span class="type">int</span><span class="normal"> dstskip </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_skip</span><span class="symbol">;</span>
<span class="normal">    </span><span class="usertype">SDL_PixelFormat</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">srcfmt </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">src</span><span class="symbol">;</span>

<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> v0 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_splat_u8</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">);</span>
<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">short</span><span class="normal"> v8_16 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_splat_u16</span><span class="symbol">(</span><span class="number">8</span><span class="symbol">);</span>
<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">short</span><span class="normal"> v1_16 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_splat_u16</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">short</span><span class="normal"> v2_16 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_splat_u16</span><span class="symbol">(</span><span class="number">2</span><span class="symbol">);</span>
<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">short</span><span class="normal"> v3_16 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_splat_u16</span><span class="symbol">(</span><span class="number">3</span><span class="symbol">);</span>
<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> v8_32 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_splat_u32</span><span class="symbol">(</span><span class="number">8</span><span class="symbol">);</span>
<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> v16_32 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_add</span><span class="symbol">(</span><span class="normal">v8_32</span><span class="symbol">,</span><span class="normal"> v8_32</span><span class="symbol">);</span>
<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">short</span><span class="normal"> v3f </span><span class="symbol">=</span><span class="normal"> </span><span class="function">VECUINT16_LITERAL</span><span class="symbol">(</span>
<span class="normal">        </span><span class="number">0x003f</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x003f</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x003f</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x003f</span><span class="symbol">,</span>
<span class="normal">        </span><span class="number">0x003f</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x003f</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x003f</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x003f</span><span class="symbol">);</span>
<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">short</span><span class="normal"> vfc </span><span class="symbol">=</span><span class="normal"> </span><span class="function">VECUINT16_LITERAL</span><span class="symbol">(</span>
<span class="normal">        </span><span class="number">0x00fc</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x00fc</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x00fc</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x00fc</span><span class="symbol">,</span>
<span class="normal">        </span><span class="number">0x00fc</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x00fc</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x00fc</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x00fc</span><span class="symbol">);</span>

<span class="normal">    </span><span class="comment">/* </span>
<span class="comment">        0x10 - 0x1f is the alpha</span>
<span class="comment">        0x00 - 0x0e evens are the red</span>
<span class="comment">        0x01 - 0x0f odds are zero</span>
<span class="comment">    */</span>
<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> vredalpha1 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">VECUINT8_LITERAL</span><span class="symbol">(</span>
<span class="normal">        </span><span class="number">0x10</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x00</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x01</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x01</span><span class="symbol">,</span>
<span class="normal">        </span><span class="number">0x10</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x02</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x01</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x01</span><span class="symbol">,</span>
<span class="normal">        </span><span class="number">0x10</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x04</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x01</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x01</span><span class="symbol">,</span>
<span class="normal">        </span><span class="number">0x10</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x06</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x01</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x01</span>
<span class="normal">    </span><span class="symbol">);</span>
<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> vredalpha2 </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vector </span><span class="usertype">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="symbol">)(</span>
<span class="normal">        </span><span class="function">vec_add</span><span class="symbol">((</span><span class="normal">vector </span><span class="usertype">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="symbol">)</span><span class="normal">vredalpha1</span><span class="symbol">,</span><span class="normal"> </span><span class="function">vec_sl</span><span class="symbol">(</span><span class="normal">v8_32</span><span class="symbol">,</span><span class="normal"> v16_32</span><span class="symbol">))</span>
<span class="normal">    </span><span class="symbol">);</span>
<span class="normal">    </span><span class="comment">/*</span>
<span class="comment">        0x00 - 0x0f is ARxx ARxx ARxx ARxx</span>
<span class="comment">        0x11 - 0x0f odds are blue</span>
<span class="comment">    */</span>
<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> vblue1 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">VECUINT8_LITERAL</span><span class="symbol">(</span>
<span class="normal">        </span><span class="number">0x00</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x01</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x02</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x11</span><span class="symbol">,</span>
<span class="normal">        </span><span class="number">0x04</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x05</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x06</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x13</span><span class="symbol">,</span>
<span class="normal">        </span><span class="number">0x08</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x09</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x0a</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x15</span><span class="symbol">,</span>
<span class="normal">        </span><span class="number">0x0c</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x0d</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x0e</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x17</span>
<span class="normal">    </span><span class="symbol">);</span>
<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> vblue2 </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vector </span><span class="usertype">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="symbol">)(</span>
<span class="normal">        </span><span class="function">vec_add</span><span class="symbol">((</span><span class="normal">vector </span><span class="usertype">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="symbol">)</span><span class="normal">vblue1</span><span class="symbol">,</span><span class="normal"> v8_32</span><span class="symbol">)</span>
<span class="normal">    </span><span class="symbol">);</span>
<span class="normal">    </span><span class="comment">/*</span>
<span class="comment">        0x00 - 0x0f is ARxB ARxB ARxB ARxB</span>
<span class="comment">        0x10 - 0x0e evens are green</span>
<span class="comment">    */</span>
<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> vgreen1 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">VECUINT8_LITERAL</span><span class="symbol">(</span>
<span class="normal">        </span><span class="number">0x00</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x01</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x10</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x03</span><span class="symbol">,</span>
<span class="normal">        </span><span class="number">0x04</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x05</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x12</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x07</span><span class="symbol">,</span>
<span class="normal">        </span><span class="number">0x08</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x09</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x14</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x0b</span><span class="symbol">,</span>
<span class="normal">        </span><span class="number">0x0c</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x0d</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x16</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x0f</span>
<span class="normal">    </span><span class="symbol">);</span>
<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> vgreen2 </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vector </span><span class="usertype">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="symbol">)(</span>
<span class="normal">        </span><span class="function">vec_add</span><span class="symbol">((</span><span class="normal">vector </span><span class="usertype">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="symbol">)</span><span class="normal">vgreen1</span><span class="symbol">,</span><span class="normal"> </span><span class="function">vec_sl</span><span class="symbol">(</span><span class="normal">v8_32</span><span class="symbol">,</span><span class="normal"> v8_32</span><span class="symbol">))</span>
<span class="normal">    </span><span class="symbol">);</span>
<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> vgmerge </span><span class="symbol">=</span><span class="normal"> </span><span class="function">VECUINT8_LITERAL</span><span class="symbol">(</span>
<span class="normal">        </span><span class="number">0x00</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x02</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x00</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x06</span><span class="symbol">,</span>
<span class="normal">        </span><span class="number">0x00</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x0a</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x00</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x0e</span><span class="symbol">,</span>
<span class="normal">        </span><span class="number">0x00</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x12</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x00</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x16</span><span class="symbol">,</span>
<span class="normal">        </span><span class="number">0x00</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x1a</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x00</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x1e</span><span class="symbol">);</span>
<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> mergePermute </span><span class="symbol">=</span><span class="normal"> </span><span class="function">VEC_MERGE_PERMUTE</span><span class="symbol">();</span>
<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> vpermute </span><span class="symbol">=</span><span class="normal"> </span><span class="function">calc_swizzle32</span><span class="symbol">(</span><span class="normal">srcfmt</span><span class="symbol">,</span><span class="normal"> NULL</span><span class="symbol">);</span>
<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> valphaPermute </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_and</span><span class="symbol">(</span><span class="function">vec_lvsl</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="normal"> </span><span class="symbol">*)</span><span class="normal">NULL</span><span class="symbol">),</span><span class="normal"> </span><span class="function">vec_splat_u8</span><span class="symbol">(</span><span class="number">0xC</span><span class="symbol">));</span>

<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">short</span><span class="normal"> vf800 </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vector </span><span class="usertype">unsigned</span><span class="normal"> </span><span class="type">short</span><span class="symbol">)</span><span class="function">vec_splat_u8</span><span class="symbol">(-</span><span class="number">7</span><span class="symbol">);</span>
<span class="normal">    vf800 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_sl</span><span class="symbol">(</span><span class="normal">vf800</span><span class="symbol">,</span><span class="normal"> </span><span class="function">vec_splat_u16</span><span class="symbol">(</span><span class="number">8</span><span class="symbol">));</span>

<span class="normal">    </span><span class="keyword">while</span><span class="symbol">(</span><span class="normal">height</span><span class="symbol">--)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">        </span><span class="type">int</span><span class="normal"> extrawidth</span><span class="symbol">;</span>
<span class="normal">        vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> valigner</span><span class="symbol">;</span>
<span class="normal">        vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> vsrc</span><span class="symbol">;</span>
<span class="normal">        vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> voverflow</span><span class="symbol">;</span>
<span class="normal">        </span><span class="type">int</span><span class="normal"> width </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_width</span><span class="symbol">;</span>

<span class="preproc">#define</span><span class="normal"> </span><span class="function">ONE_PIXEL_BLEND</span><span class="symbol">(</span><span class="normal">condition</span><span class="symbol">,</span><span class="normal"> widthvar</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">        </span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">condition</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">            </span><span class="usertype">Uint32</span><span class="normal"> Pixel</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">            </span><span class="type">unsigned</span><span class="normal"> sR</span><span class="symbol">,</span><span class="normal"> sG</span><span class="symbol">,</span><span class="normal"> sB</span><span class="symbol">,</span><span class="normal"> dR</span><span class="symbol">,</span><span class="normal"> dG</span><span class="symbol">,</span><span class="normal"> dB</span><span class="symbol">,</span><span class="normal"> sA</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">            </span><span class="function">DISEMBLE_RGBA</span><span class="symbol">(</span><span class="normal">src</span><span class="symbol">,</span><span class="normal"> </span><span class="number">4</span><span class="symbol">,</span><span class="normal"> srcfmt</span><span class="symbol">,</span><span class="normal"> Pixel</span><span class="symbol">,</span><span class="normal"> sR</span><span class="symbol">,</span><span class="normal"> sG</span><span class="symbol">,</span><span class="normal"> sB</span><span class="symbol">,</span><span class="normal"> sA</span><span class="symbol">);</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">            </span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">sA</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">                </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">short</span><span class="normal"> dstpixel </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*((</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">short</span><span class="normal"> </span><span class="symbol">*)</span><span class="normal">dst</span><span class="symbol">);</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">                dR </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dstpixel </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xf8</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">                dG </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dstpixel </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">3</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xfc</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">                dB </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dstpixel </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">3</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xf8</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">                </span><span class="function">ACCURATE_ALPHA_BLEND</span><span class="symbol">(</span><span class="normal">sR</span><span class="symbol">,</span><span class="normal"> sG</span><span class="symbol">,</span><span class="normal"> sB</span><span class="symbol">,</span><span class="normal"> sA</span><span class="symbol">,</span><span class="normal"> dR</span><span class="symbol">,</span><span class="normal"> dG</span><span class="symbol">,</span><span class="normal"> dB</span><span class="symbol">);</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">                </span><span class="symbol">*((</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">short</span><span class="normal"> </span><span class="symbol">*)</span><span class="normal">dst</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">                    </span><span class="symbol">((</span><span class="normal">dR </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xf8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">|</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">dG </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xfc</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">3</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">|</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dB </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">3</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">                </span><span class="symbol">);</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">            </span><span class="cbracket">}</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">            src </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">4</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">            dst </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">            widthvar</span><span class="symbol">--;</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">        </span><span class="cbracket">}</span>
<span class="normal">        </span><span class="function">ONE_PIXEL_BLEND</span><span class="symbol">((</span><span class="function">UNALIGNED_PTR</span><span class="symbol">(</span><span class="normal">dst</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width</span><span class="symbol">),</span><span class="normal"> width</span><span class="symbol">);</span>
<span class="normal">        extrawidth </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width </span><span class="symbol">%</span><span class="normal"> </span><span class="number">8</span><span class="symbol">);</span>
<span class="normal">        valigner </span><span class="symbol">=</span><span class="normal"> </span><span class="function">VEC_ALIGNER</span><span class="symbol">(</span><span class="normal">src</span><span class="symbol">);</span>
<span class="normal">        vsrc </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vector </span><span class="usertype">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="symbol">)</span><span class="function">vec_ld</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">,</span><span class="normal"> src</span><span class="symbol">);</span>
<span class="normal">        width </span><span class="symbol">-=</span><span class="normal"> extrawidth</span><span class="symbol">;</span>
<span class="normal">        </span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">            vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> valpha</span><span class="symbol">;</span>
<span class="normal">            vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> vsrc1</span><span class="symbol">,</span><span class="normal"> vsrc2</span><span class="symbol">;</span>
<span class="normal">            vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> vdst1</span><span class="symbol">,</span><span class="normal"> vdst2</span><span class="symbol">;</span>
<span class="normal">            vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">short</span><span class="normal"> vR</span><span class="symbol">,</span><span class="normal"> vG</span><span class="symbol">,</span><span class="normal"> vB</span><span class="symbol">;</span>
<span class="normal">            vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">short</span><span class="normal"> vpixel</span><span class="symbol">,</span><span class="normal"> vrpixel</span><span class="symbol">,</span><span class="normal"> vgpixel</span><span class="symbol">,</span><span class="normal"> vbpixel</span><span class="symbol">;</span>

<span class="normal">            </span><span class="comment">/* Load 8 pixels from src as ARGB */</span>
<span class="normal">            voverflow </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vector </span><span class="usertype">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="symbol">)</span><span class="function">vec_ld</span><span class="symbol">(</span><span class="number">15</span><span class="symbol">,</span><span class="normal"> src</span><span class="symbol">);</span>
<span class="normal">            vsrc </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_perm</span><span class="symbol">(</span><span class="normal">vsrc</span><span class="symbol">,</span><span class="normal"> voverflow</span><span class="symbol">,</span><span class="normal"> valigner</span><span class="symbol">);</span>
<span class="normal">            vsrc1 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_perm</span><span class="symbol">(</span><span class="normal">vsrc</span><span class="symbol">,</span><span class="normal"> vsrc</span><span class="symbol">,</span><span class="normal"> vpermute</span><span class="symbol">);</span>
<span class="normal">            src </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">16</span><span class="symbol">;</span>
<span class="normal">            vsrc </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vector </span><span class="usertype">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="symbol">)</span><span class="function">vec_ld</span><span class="symbol">(</span><span class="number">15</span><span class="symbol">,</span><span class="normal"> src</span><span class="symbol">);</span>
<span class="normal">            voverflow </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_perm</span><span class="symbol">(</span><span class="normal">voverflow</span><span class="symbol">,</span><span class="normal"> vsrc</span><span class="symbol">,</span><span class="normal"> valigner</span><span class="symbol">);</span>
<span class="normal">            vsrc2 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_perm</span><span class="symbol">(</span><span class="normal">voverflow</span><span class="symbol">,</span><span class="normal"> voverflow</span><span class="symbol">,</span><span class="normal"> vpermute</span><span class="symbol">);</span>
<span class="normal">            src </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">16</span><span class="symbol">;</span>

<span class="normal">            </span><span class="comment">/* Load 8 pixels from dst as XRGB */</span>
<span class="normal">            voverflow </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_ld</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">,</span><span class="normal"> dst</span><span class="symbol">);</span>
<span class="normal">            vR </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_and</span><span class="symbol">((</span><span class="normal">vector </span><span class="usertype">unsigned</span><span class="normal"> </span><span class="type">short</span><span class="symbol">)</span><span class="normal">voverflow</span><span class="symbol">,</span><span class="normal"> vf800</span><span class="symbol">);</span>
<span class="normal">            vB </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_sl</span><span class="symbol">((</span><span class="normal">vector </span><span class="usertype">unsigned</span><span class="normal"> </span><span class="type">short</span><span class="symbol">)</span><span class="normal">voverflow</span><span class="symbol">,</span><span class="normal"> v3_16</span><span class="symbol">);</span>
<span class="normal">            vG </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_sl</span><span class="symbol">(</span><span class="normal">vB</span><span class="symbol">,</span><span class="normal"> v2_16</span><span class="symbol">);</span>
<span class="normal">            vdst1 </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vector </span><span class="usertype">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="symbol">)</span><span class="function">vec_perm</span><span class="symbol">((</span><span class="normal">vector </span><span class="usertype">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="symbol">)</span><span class="normal">vR</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vector </span><span class="usertype">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="symbol">)</span><span class="normal">vR</span><span class="symbol">,</span><span class="normal"> vredalpha1</span><span class="symbol">);</span>
<span class="normal">            vdst1 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_perm</span><span class="symbol">(</span><span class="normal">vdst1</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vector </span><span class="usertype">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="symbol">)</span><span class="normal">vB</span><span class="symbol">,</span><span class="normal"> vblue1</span><span class="symbol">);</span>
<span class="normal">            vdst1 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_perm</span><span class="symbol">(</span><span class="normal">vdst1</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vector </span><span class="usertype">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="symbol">)</span><span class="normal">vG</span><span class="symbol">,</span><span class="normal"> vgreen1</span><span class="symbol">);</span>
<span class="normal">            vdst2 </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vector </span><span class="usertype">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="symbol">)</span><span class="function">vec_perm</span><span class="symbol">((</span><span class="normal">vector </span><span class="usertype">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="symbol">)</span><span class="normal">vR</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vector </span><span class="usertype">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="symbol">)</span><span class="normal">vR</span><span class="symbol">,</span><span class="normal"> vredalpha2</span><span class="symbol">);</span>
<span class="normal">            vdst2 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_perm</span><span class="symbol">(</span><span class="normal">vdst2</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vector </span><span class="usertype">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="symbol">)</span><span class="normal">vB</span><span class="symbol">,</span><span class="normal"> vblue2</span><span class="symbol">);</span>
<span class="normal">            vdst2 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_perm</span><span class="symbol">(</span><span class="normal">vdst2</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vector </span><span class="usertype">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="symbol">)</span><span class="normal">vG</span><span class="symbol">,</span><span class="normal"> vgreen2</span><span class="symbol">);</span>

<span class="normal">            </span><span class="comment">/* Alpha blend 8 pixels as ARGB */</span>
<span class="normal">            valpha </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_perm</span><span class="symbol">(</span><span class="normal">vsrc1</span><span class="symbol">,</span><span class="normal"> v0</span><span class="symbol">,</span><span class="normal"> valphaPermute</span><span class="symbol">);</span>
<span class="normal">            </span><span class="function">VEC_MULTIPLY_ALPHA</span><span class="symbol">(</span><span class="normal">vsrc1</span><span class="symbol">,</span><span class="normal"> vdst1</span><span class="symbol">,</span><span class="normal"> valpha</span><span class="symbol">,</span><span class="normal"> mergePermute</span><span class="symbol">,</span><span class="normal"> v1_16</span><span class="symbol">,</span><span class="normal"> v8_16</span><span class="symbol">);</span>
<span class="normal">            valpha </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_perm</span><span class="symbol">(</span><span class="normal">vsrc2</span><span class="symbol">,</span><span class="normal"> v0</span><span class="symbol">,</span><span class="normal"> valphaPermute</span><span class="symbol">);</span>
<span class="normal">            </span><span class="function">VEC_MULTIPLY_ALPHA</span><span class="symbol">(</span><span class="normal">vsrc2</span><span class="symbol">,</span><span class="normal"> vdst2</span><span class="symbol">,</span><span class="normal"> valpha</span><span class="symbol">,</span><span class="normal"> mergePermute</span><span class="symbol">,</span><span class="normal"> v1_16</span><span class="symbol">,</span><span class="normal"> v8_16</span><span class="symbol">);</span>

<span class="normal">            </span><span class="comment">/* Convert 8 pixels to 565 */</span>
<span class="normal">            vpixel </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vector </span><span class="usertype">unsigned</span><span class="normal"> </span><span class="type">short</span><span class="symbol">)</span><span class="function">vec_packpx</span><span class="symbol">((</span><span class="normal">vector </span><span class="usertype">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="symbol">)</span><span class="normal">vdst1</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vector </span><span class="usertype">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="symbol">)</span><span class="normal">vdst2</span><span class="symbol">);</span>
<span class="normal">            vgpixel </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vector </span><span class="usertype">unsigned</span><span class="normal"> </span><span class="type">short</span><span class="symbol">)</span><span class="function">vec_perm</span><span class="symbol">(</span><span class="normal">vdst1</span><span class="symbol">,</span><span class="normal"> vdst2</span><span class="symbol">,</span><span class="normal"> vgmerge</span><span class="symbol">);</span>
<span class="normal">            vgpixel </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_and</span><span class="symbol">(</span><span class="normal">vgpixel</span><span class="symbol">,</span><span class="normal"> vfc</span><span class="symbol">);</span>
<span class="normal">            vgpixel </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_sl</span><span class="symbol">(</span><span class="normal">vgpixel</span><span class="symbol">,</span><span class="normal"> v3_16</span><span class="symbol">);</span>
<span class="normal">            vrpixel </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_sl</span><span class="symbol">(</span><span class="normal">vpixel</span><span class="symbol">,</span><span class="normal"> v1_16</span><span class="symbol">);</span>
<span class="normal">            vrpixel </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_and</span><span class="symbol">(</span><span class="normal">vrpixel</span><span class="symbol">,</span><span class="normal"> vf800</span><span class="symbol">);</span>
<span class="normal">            vbpixel </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_and</span><span class="symbol">(</span><span class="normal">vpixel</span><span class="symbol">,</span><span class="normal"> v3f</span><span class="symbol">);</span>
<span class="normal">            vdst1 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_or</span><span class="symbol">((</span><span class="normal">vector </span><span class="usertype">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="symbol">)</span><span class="normal">vrpixel</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vector </span><span class="usertype">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="symbol">)</span><span class="normal">vgpixel</span><span class="symbol">);</span>
<span class="normal">            vdst1 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_or</span><span class="symbol">(</span><span class="normal">vdst1</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vector </span><span class="usertype">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="symbol">)</span><span class="normal">vbpixel</span><span class="symbol">);</span>
<span class="normal">            </span>
<span class="normal">            </span><span class="comment">/* Store 8 pixels */</span>
<span class="normal">            </span><span class="function">vec_st</span><span class="symbol">(</span><span class="normal">vdst1</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> dst</span><span class="symbol">);</span>

<span class="normal">            width </span><span class="symbol">-=</span><span class="normal"> </span><span class="number">8</span><span class="symbol">;</span>
<span class="normal">            dst </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">16</span><span class="symbol">;</span>
<span class="normal">        </span><span class="cbracket">}</span>
<span class="normal">        </span><span class="function">ONE_PIXEL_BLEND</span><span class="symbol">((</span><span class="normal">extrawidth</span><span class="symbol">),</span><span class="normal"> extrawidth</span><span class="symbol">);</span>
<span class="preproc">#undef</span><span class="normal"> ONE_PIXEL_BLEND</span>
<span class="normal">        src </span><span class="symbol">+=</span><span class="normal"> srcskip</span><span class="symbol">;</span>
<span class="normal">        dst </span><span class="symbol">+=</span><span class="normal"> dstskip</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="keyword">static</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="function">Blit32to32SurfaceAlphaKeyAltivec</span><span class="symbol">(</span><span class="usertype">SDL_BlitInfo</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">info</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="type">unsigned</span><span class="normal"> alpha </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">src</span><span class="symbol">-&gt;</span><span class="normal">alpha</span><span class="symbol">;</span>
<span class="normal">    </span><span class="type">int</span><span class="normal"> height </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_height</span><span class="symbol">;</span>
<span class="normal">    </span><span class="usertype">Uint32</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">srcp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint32 </span><span class="symbol">*)</span><span class="normal">info</span><span class="symbol">-&gt;</span><span class="normal">s_pixels</span><span class="symbol">;</span>
<span class="normal">    </span><span class="type">int</span><span class="normal"> srcskip </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">s_skip </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">    </span><span class="usertype">Uint32</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dstp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint32 </span><span class="symbol">*)</span><span class="normal">info</span><span class="symbol">-&gt;</span><span class="normal">d_pixels</span><span class="symbol">;</span>
<span class="normal">    </span><span class="type">int</span><span class="normal"> dstskip </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_skip </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">    </span><span class="usertype">SDL_PixelFormat</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">srcfmt </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">src</span><span class="symbol">;</span>
<span class="normal">    </span><span class="usertype">SDL_PixelFormat</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dstfmt </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">dst</span><span class="symbol">;</span>
<span class="normal">    </span><span class="type">unsigned</span><span class="normal"> sA </span><span class="symbol">=</span><span class="normal"> srcfmt</span><span class="symbol">-&gt;</span><span class="normal">alpha</span><span class="symbol">;</span>
<span class="normal">    </span><span class="type">unsigned</span><span class="normal"> dA </span><span class="symbol">=</span><span class="normal"> dstfmt</span><span class="symbol">-&gt;</span><span class="normal">Amask </span><span class="symbol">?</span><span class="normal"> SDL_ALPHA_OPAQUE </span><span class="symbol">:</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">    </span><span class="usertype">Uint32</span><span class="normal"> rgbmask </span><span class="symbol">=</span><span class="normal"> srcfmt</span><span class="symbol">-&gt;</span><span class="normal">Rmask </span><span class="symbol">|</span><span class="normal"> srcfmt</span><span class="symbol">-&gt;</span><span class="normal">Gmask </span><span class="symbol">|</span><span class="normal"> srcfmt</span><span class="symbol">-&gt;</span><span class="normal">Bmask</span><span class="symbol">;</span>
<span class="normal">    </span><span class="usertype">Uint32</span><span class="normal"> ckey </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">src</span><span class="symbol">-&gt;</span><span class="normal">colorkey</span><span class="symbol">;</span>
<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> mergePermute</span><span class="symbol">;</span>
<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> vsrcPermute</span><span class="symbol">;</span>
<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> vdstPermute</span><span class="symbol">;</span>
<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> vsdstPermute</span><span class="symbol">;</span>
<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> valpha</span><span class="symbol">;</span>
<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> valphamask</span><span class="symbol">;</span>
<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> vbits</span><span class="symbol">;</span>
<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> v0</span><span class="symbol">;</span>
<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">short</span><span class="normal"> v1</span><span class="symbol">;</span>
<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">short</span><span class="normal"> v8</span><span class="symbol">;</span>
<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> vckey</span><span class="symbol">;</span>
<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> vrgbmask</span><span class="symbol">;</span>

<span class="normal">    mergePermute </span><span class="symbol">=</span><span class="normal"> </span><span class="function">VEC_MERGE_PERMUTE</span><span class="symbol">();</span>
<span class="normal">    v0 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_splat_u8</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">);</span>
<span class="normal">    v1 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_splat_u16</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">    v8 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_splat_u16</span><span class="symbol">(</span><span class="number">8</span><span class="symbol">);</span>

<span class="normal">    </span><span class="comment">/* set the alpha to 255 on the destination surf */</span>
<span class="normal">    valphamask </span><span class="symbol">=</span><span class="normal"> </span><span class="function">VEC_ALPHA_MASK</span><span class="symbol">();</span>

<span class="normal">    vsrcPermute </span><span class="symbol">=</span><span class="normal"> </span><span class="function">calc_swizzle32</span><span class="symbol">(</span><span class="normal">srcfmt</span><span class="symbol">,</span><span class="normal"> NULL</span><span class="symbol">);</span>
<span class="normal">    vdstPermute </span><span class="symbol">=</span><span class="normal"> </span><span class="function">calc_swizzle32</span><span class="symbol">(</span><span class="normal">NULL</span><span class="symbol">,</span><span class="normal"> dstfmt</span><span class="symbol">);</span>
<span class="normal">    vsdstPermute </span><span class="symbol">=</span><span class="normal"> </span><span class="function">calc_swizzle32</span><span class="symbol">(</span><span class="normal">dstfmt</span><span class="symbol">,</span><span class="normal"> NULL</span><span class="symbol">);</span>

<span class="normal">    </span><span class="comment">/* set a vector full of alpha and 255-alpha */</span>
<span class="normal">    </span><span class="symbol">((</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*)&amp;</span><span class="normal">valpha</span><span class="symbol">)[</span><span class="number">0</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> alpha</span><span class="symbol">;</span>
<span class="normal">    valpha </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_splat</span><span class="symbol">(</span><span class="normal">valpha</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">);</span>
<span class="normal">    vbits </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vector </span><span class="usertype">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="symbol">)</span><span class="function">vec_splat_s8</span><span class="symbol">(-</span><span class="number">1</span><span class="symbol">);</span>

<span class="normal">    ckey </span><span class="symbol">&amp;=</span><span class="normal"> rgbmask</span><span class="symbol">;</span>
<span class="normal">    </span><span class="symbol">((</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> </span><span class="symbol">*)(</span><span class="type">char</span><span class="symbol">*)&amp;</span><span class="normal">vckey</span><span class="symbol">)[</span><span class="number">0</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> ckey</span><span class="symbol">;</span>
<span class="normal">    vckey </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_splat</span><span class="symbol">(</span><span class="normal">vckey</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">);</span>
<span class="normal">    </span><span class="symbol">((</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> </span><span class="symbol">*)(</span><span class="type">char</span><span class="symbol">*)&amp;</span><span class="normal">vrgbmask</span><span class="symbol">)[</span><span class="number">0</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> rgbmask</span><span class="symbol">;</span>
<span class="normal">    vrgbmask </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_splat</span><span class="symbol">(</span><span class="normal">vrgbmask</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">);</span>

<span class="normal">    </span><span class="keyword">while</span><span class="symbol">(</span><span class="normal">height</span><span class="symbol">--)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">        </span><span class="type">int</span><span class="normal"> width </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_width</span><span class="symbol">;</span>
<span class="preproc">#define</span><span class="normal"> </span><span class="function">ONE_PIXEL_BLEND</span><span class="symbol">(</span><span class="normal">condition</span><span class="symbol">,</span><span class="normal"> widthvar</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">        </span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">condition</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">            </span><span class="usertype">Uint32</span><span class="normal"> Pixel</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">            </span><span class="type">unsigned</span><span class="normal"> sR</span><span class="symbol">,</span><span class="normal"> sG</span><span class="symbol">,</span><span class="normal"> sB</span><span class="symbol">,</span><span class="normal"> dR</span><span class="symbol">,</span><span class="normal"> dG</span><span class="symbol">,</span><span class="normal"> dB</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">            </span><span class="function">RETRIEVE_RGB_PIXEL</span><span class="symbol">(((</span><span class="normal">Uint8 </span><span class="symbol">*)</span><span class="normal">srcp</span><span class="symbol">),</span><span class="normal"> </span><span class="number">4</span><span class="symbol">,</span><span class="normal"> Pixel</span><span class="symbol">);</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">            </span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">sA </span><span class="symbol">&amp;&amp;</span><span class="normal"> Pixel </span><span class="symbol">!=</span><span class="normal"> ckey</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">                </span><span class="function">RGB_FROM_PIXEL</span><span class="symbol">(</span><span class="normal">Pixel</span><span class="symbol">,</span><span class="normal"> srcfmt</span><span class="symbol">,</span><span class="normal"> sR</span><span class="symbol">,</span><span class="normal"> sG</span><span class="symbol">,</span><span class="normal"> sB</span><span class="symbol">);</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">                </span><span class="function">DISEMBLE_RGB</span><span class="symbol">(((</span><span class="normal">Uint8 </span><span class="symbol">*)</span><span class="normal">dstp</span><span class="symbol">),</span><span class="normal"> </span><span class="number">4</span><span class="symbol">,</span><span class="normal"> dstfmt</span><span class="symbol">,</span><span class="normal"> Pixel</span><span class="symbol">,</span><span class="normal"> dR</span><span class="symbol">,</span><span class="normal"> dG</span><span class="symbol">,</span><span class="normal"> dB</span><span class="symbol">);</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">                </span><span class="function">ACCURATE_ALPHA_BLEND</span><span class="symbol">(</span><span class="normal">sR</span><span class="symbol">,</span><span class="normal"> sG</span><span class="symbol">,</span><span class="normal"> sB</span><span class="symbol">,</span><span class="normal"> sA</span><span class="symbol">,</span><span class="normal"> dR</span><span class="symbol">,</span><span class="normal"> dG</span><span class="symbol">,</span><span class="normal"> dB</span><span class="symbol">);</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">                </span><span class="function">ASSEMBLE_RGBA</span><span class="symbol">(((</span><span class="normal">Uint8 </span><span class="symbol">*)</span><span class="normal">dstp</span><span class="symbol">),</span><span class="normal"> </span><span class="number">4</span><span class="symbol">,</span><span class="normal"> dstfmt</span><span class="symbol">,</span><span class="normal"> dR</span><span class="symbol">,</span><span class="normal"> dG</span><span class="symbol">,</span><span class="normal"> dB</span><span class="symbol">,</span><span class="normal"> dA</span><span class="symbol">);</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">            </span><span class="cbracket">}</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">            dstp</span><span class="symbol">++;</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">            srcp</span><span class="symbol">++;</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">            widthvar</span><span class="symbol">--;</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">        </span><span class="cbracket">}</span>
<span class="normal">        </span><span class="function">ONE_PIXEL_BLEND</span><span class="symbol">((</span><span class="function">UNALIGNED_PTR</span><span class="symbol">(</span><span class="normal">dstp</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width</span><span class="symbol">),</span><span class="normal"> width</span><span class="symbol">);</span>
<span class="normal">        </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="type">int</span><span class="normal"> extrawidth </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width </span><span class="symbol">%</span><span class="normal"> </span><span class="number">4</span><span class="symbol">);</span>
<span class="normal">            vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> valigner </span><span class="symbol">=</span><span class="normal"> </span><span class="function">VEC_ALIGNER</span><span class="symbol">(</span><span class="normal">srcp</span><span class="symbol">);</span>
<span class="normal">            vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> vs </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vector </span><span class="usertype">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="symbol">)</span><span class="function">vec_ld</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">,</span><span class="normal"> srcp</span><span class="symbol">);</span>
<span class="normal">            width </span><span class="symbol">-=</span><span class="normal"> extrawidth</span><span class="symbol">;</span>
<span class="normal">            </span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">                vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> vsel</span><span class="symbol">;</span>
<span class="normal">                vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> voverflow</span><span class="symbol">;</span>
<span class="normal">                vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> vd</span><span class="symbol">;</span>
<span class="normal">                vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> vd_orig</span><span class="symbol">;</span>

<span class="normal">                </span><span class="comment">/* s = *srcp */</span>
<span class="normal">                voverflow </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vector </span><span class="usertype">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="symbol">)</span><span class="function">vec_ld</span><span class="symbol">(</span><span class="number">15</span><span class="symbol">,</span><span class="normal"> srcp</span><span class="symbol">);</span>
<span class="normal">                vs </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_perm</span><span class="symbol">(</span><span class="normal">vs</span><span class="symbol">,</span><span class="normal"> voverflow</span><span class="symbol">,</span><span class="normal"> valigner</span><span class="symbol">);</span>
<span class="normal">                </span>
<span class="normal">                </span><span class="comment">/* vsel is set for items that match the key */</span>
<span class="normal">                vsel </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vector </span><span class="usertype">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="symbol">)</span><span class="function">vec_and</span><span class="symbol">((</span><span class="normal">vector </span><span class="usertype">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="symbol">)</span><span class="normal">vs</span><span class="symbol">,</span><span class="normal"> vrgbmask</span><span class="symbol">);</span>
<span class="normal">                vsel </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vector </span><span class="usertype">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="symbol">)</span><span class="function">vec_cmpeq</span><span class="symbol">((</span><span class="normal">vector </span><span class="usertype">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="symbol">)</span><span class="normal">vsel</span><span class="symbol">,</span><span class="normal"> vckey</span><span class="symbol">);</span>

<span class="normal">                </span><span class="comment">/* permute to source format */</span>
<span class="normal">                vs </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_perm</span><span class="symbol">(</span><span class="normal">vs</span><span class="symbol">,</span><span class="normal"> valpha</span><span class="symbol">,</span><span class="normal"> vsrcPermute</span><span class="symbol">);</span>

<span class="normal">                </span><span class="comment">/* d = *dstp */</span>
<span class="normal">                vd </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vector </span><span class="usertype">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="symbol">)</span><span class="function">vec_ld</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">,</span><span class="normal"> dstp</span><span class="symbol">);</span>
<span class="normal">                vd_orig </span><span class="symbol">=</span><span class="normal"> vd </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_perm</span><span class="symbol">(</span><span class="normal">vd</span><span class="symbol">,</span><span class="normal"> v0</span><span class="symbol">,</span><span class="normal"> vsdstPermute</span><span class="symbol">);</span>

<span class="normal">                </span><span class="function">VEC_MULTIPLY_ALPHA</span><span class="symbol">(</span><span class="normal">vs</span><span class="symbol">,</span><span class="normal"> vd</span><span class="symbol">,</span><span class="normal"> valpha</span><span class="symbol">,</span><span class="normal"> mergePermute</span><span class="symbol">,</span><span class="normal"> v1</span><span class="symbol">,</span><span class="normal"> v8</span><span class="symbol">);</span>

<span class="normal">                </span><span class="comment">/* set the alpha channel to full on */</span>
<span class="normal">                vd </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_or</span><span class="symbol">(</span><span class="normal">vd</span><span class="symbol">,</span><span class="normal"> valphamask</span><span class="symbol">);</span>

<span class="normal">                </span><span class="comment">/* mask out color key */</span>
<span class="normal">                vd </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_sel</span><span class="symbol">(</span><span class="normal">vd</span><span class="symbol">,</span><span class="normal"> vd_orig</span><span class="symbol">,</span><span class="normal"> vsel</span><span class="symbol">);</span>
<span class="normal">                </span>
<span class="normal">                </span><span class="comment">/* permute to dest format */</span>
<span class="normal">                vd </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_perm</span><span class="symbol">(</span><span class="normal">vd</span><span class="symbol">,</span><span class="normal"> vbits</span><span class="symbol">,</span><span class="normal"> vdstPermute</span><span class="symbol">);</span>

<span class="normal">                </span><span class="comment">/* *dstp = res */</span>
<span class="normal">                </span><span class="function">vec_st</span><span class="symbol">((</span><span class="normal">vector </span><span class="usertype">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="symbol">)</span><span class="normal">vd</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> dstp</span><span class="symbol">);</span>
<span class="normal">                </span>
<span class="normal">                srcp </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">4</span><span class="symbol">;</span>
<span class="normal">                dstp </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">4</span><span class="symbol">;</span>
<span class="normal">                width </span><span class="symbol">-=</span><span class="normal"> </span><span class="number">4</span><span class="symbol">;</span>
<span class="normal">                vs </span><span class="symbol">=</span><span class="normal"> voverflow</span><span class="symbol">;</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="function">ONE_PIXEL_BLEND</span><span class="symbol">((</span><span class="normal">extrawidth</span><span class="symbol">),</span><span class="normal"> extrawidth</span><span class="symbol">);</span>
<span class="normal">        </span><span class="cbracket">}</span>
<span class="preproc">#undef</span><span class="normal"> ONE_PIXEL_BLEND</span>
<span class="normal"> </span>
<span class="normal">        srcp </span><span class="symbol">+=</span><span class="normal"> srcskip</span><span class="symbol">;</span>
<span class="normal">        dstp </span><span class="symbol">+=</span><span class="normal"> dstskip</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="cbracket">}</span>


<span class="keyword">static</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="function">Blit32to32PixelAlphaAltivec</span><span class="symbol">(</span><span class="usertype">SDL_BlitInfo</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">info</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="type">int</span><span class="normal"> width </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_width</span><span class="symbol">;</span>
<span class="normal">    </span><span class="type">int</span><span class="normal"> height </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_height</span><span class="symbol">;</span>
<span class="normal">    </span><span class="usertype">Uint32</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">srcp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint32 </span><span class="symbol">*)</span><span class="normal">info</span><span class="symbol">-&gt;</span><span class="normal">s_pixels</span><span class="symbol">;</span>
<span class="normal">    </span><span class="type">int</span><span class="normal"> srcskip </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">s_skip </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">    </span><span class="usertype">Uint32</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dstp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint32 </span><span class="symbol">*)</span><span class="normal">info</span><span class="symbol">-&gt;</span><span class="normal">d_pixels</span><span class="symbol">;</span>
<span class="normal">    </span><span class="type">int</span><span class="normal"> dstskip </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_skip </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">    </span><span class="usertype">SDL_PixelFormat</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">srcfmt </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">src</span><span class="symbol">;</span>
<span class="normal">    </span><span class="usertype">SDL_PixelFormat</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dstfmt </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">dst</span><span class="symbol">;</span>
<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> mergePermute</span><span class="symbol">;</span>
<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> valphaPermute</span><span class="symbol">;</span>
<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> vsrcPermute</span><span class="symbol">;</span>
<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> vdstPermute</span><span class="symbol">;</span>
<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> vsdstPermute</span><span class="symbol">;</span>
<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> valphamask</span><span class="symbol">;</span>
<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> vpixelmask</span><span class="symbol">;</span>
<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> v0</span><span class="symbol">;</span>
<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">short</span><span class="normal"> v1</span><span class="symbol">;</span>
<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">short</span><span class="normal"> v8</span><span class="symbol">;</span>

<span class="normal">    v0 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_splat_u8</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">);</span>
<span class="normal">    v1 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_splat_u16</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">    v8 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_splat_u16</span><span class="symbol">(</span><span class="number">8</span><span class="symbol">);</span>
<span class="normal">    mergePermute </span><span class="symbol">=</span><span class="normal"> </span><span class="function">VEC_MERGE_PERMUTE</span><span class="symbol">();</span>
<span class="normal">    valphamask </span><span class="symbol">=</span><span class="normal"> </span><span class="function">VEC_ALPHA_MASK</span><span class="symbol">();</span>
<span class="normal">    valphaPermute </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_and</span><span class="symbol">(</span><span class="function">vec_lvsl</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="normal"> </span><span class="symbol">*)</span><span class="normal">NULL</span><span class="symbol">),</span><span class="normal"> </span><span class="function">vec_splat_u8</span><span class="symbol">(</span><span class="number">0xC</span><span class="symbol">));</span>
<span class="normal">    vpixelmask </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_nor</span><span class="symbol">(</span><span class="normal">valphamask</span><span class="symbol">,</span><span class="normal"> v0</span><span class="symbol">);</span>
<span class="normal">    vsrcPermute </span><span class="symbol">=</span><span class="normal"> </span><span class="function">calc_swizzle32</span><span class="symbol">(</span><span class="normal">srcfmt</span><span class="symbol">,</span><span class="normal"> NULL</span><span class="symbol">);</span>
<span class="normal">    vdstPermute </span><span class="symbol">=</span><span class="normal"> </span><span class="function">calc_swizzle32</span><span class="symbol">(</span><span class="normal">NULL</span><span class="symbol">,</span><span class="normal"> dstfmt</span><span class="symbol">);</span>
<span class="normal">    vsdstPermute </span><span class="symbol">=</span><span class="normal"> </span><span class="function">calc_swizzle32</span><span class="symbol">(</span><span class="normal">dstfmt</span><span class="symbol">,</span><span class="normal"> NULL</span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal"> height</span><span class="symbol">--</span><span class="normal"> </span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">        width </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_width</span><span class="symbol">;</span>
<span class="preproc">#define</span><span class="normal"> </span><span class="function">ONE_PIXEL_BLEND</span><span class="symbol">(</span><span class="normal">condition</span><span class="symbol">,</span><span class="normal"> widthvar</span><span class="symbol">)</span><span class="normal"> </span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">condition</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">            </span><span class="usertype">Uint32</span><span class="normal"> Pixel</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">            </span><span class="type">unsigned</span><span class="normal"> sR</span><span class="symbol">,</span><span class="normal"> sG</span><span class="symbol">,</span><span class="normal"> sB</span><span class="symbol">,</span><span class="normal"> dR</span><span class="symbol">,</span><span class="normal"> dG</span><span class="symbol">,</span><span class="normal"> dB</span><span class="symbol">,</span><span class="normal"> sA</span><span class="symbol">,</span><span class="normal"> dA</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">            </span><span class="function">DISEMBLE_RGBA</span><span class="symbol">((</span><span class="normal">Uint8 </span><span class="symbol">*)</span><span class="normal">srcp</span><span class="symbol">,</span><span class="normal"> </span><span class="number">4</span><span class="symbol">,</span><span class="normal"> srcfmt</span><span class="symbol">,</span><span class="normal"> Pixel</span><span class="symbol">,</span><span class="normal"> sR</span><span class="symbol">,</span><span class="normal"> sG</span><span class="symbol">,</span><span class="normal"> sB</span><span class="symbol">,</span><span class="normal"> sA</span><span class="symbol">);</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">            </span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">sA</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">              </span><span class="function">DISEMBLE_RGBA</span><span class="symbol">((</span><span class="normal">Uint8 </span><span class="symbol">*)</span><span class="normal">dstp</span><span class="symbol">,</span><span class="normal"> </span><span class="number">4</span><span class="symbol">,</span><span class="normal"> dstfmt</span><span class="symbol">,</span><span class="normal"> Pixel</span><span class="symbol">,</span><span class="normal"> dR</span><span class="symbol">,</span><span class="normal"> dG</span><span class="symbol">,</span><span class="normal"> dB</span><span class="symbol">,</span><span class="normal"> dA</span><span class="symbol">);</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">              </span><span class="function">ACCURATE_ALPHA_BLEND</span><span class="symbol">(</span><span class="normal">sR</span><span class="symbol">,</span><span class="normal"> sG</span><span class="symbol">,</span><span class="normal"> sB</span><span class="symbol">,</span><span class="normal"> sA</span><span class="symbol">,</span><span class="normal"> dR</span><span class="symbol">,</span><span class="normal"> dG</span><span class="symbol">,</span><span class="normal"> dB</span><span class="symbol">);</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">              </span><span class="function">ASSEMBLE_RGBA</span><span class="symbol">((</span><span class="normal">Uint8 </span><span class="symbol">*)</span><span class="normal">dstp</span><span class="symbol">,</span><span class="normal"> </span><span class="number">4</span><span class="symbol">,</span><span class="normal"> dstfmt</span><span class="symbol">,</span><span class="normal"> dR</span><span class="symbol">,</span><span class="normal"> dG</span><span class="symbol">,</span><span class="normal"> dB</span><span class="symbol">,</span><span class="normal"> dA</span><span class="symbol">);</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">            </span><span class="cbracket">}</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">            </span><span class="symbol">++</span><span class="normal">srcp</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">            </span><span class="symbol">++</span><span class="normal">dstp</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">            widthvar</span><span class="symbol">--;</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">        </span><span class="cbracket">}</span>
<span class="normal">        </span><span class="function">ONE_PIXEL_BLEND</span><span class="symbol">((</span><span class="function">UNALIGNED_PTR</span><span class="symbol">(</span><span class="normal">dstp</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width</span><span class="symbol">),</span><span class="normal"> width</span><span class="symbol">);</span>
<span class="normal">        </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="comment">/* vsrcPermute */</span>
<span class="normal">            </span><span class="comment">/* vdstPermute */</span>
<span class="normal">            </span><span class="type">int</span><span class="normal"> extrawidth </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width </span><span class="symbol">%</span><span class="normal"> </span><span class="number">4</span><span class="symbol">);</span>
<span class="normal">            vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> valigner </span><span class="symbol">=</span><span class="normal"> </span><span class="function">VEC_ALIGNER</span><span class="symbol">(</span><span class="normal">srcp</span><span class="symbol">);</span>
<span class="normal">            vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> vs </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vector </span><span class="usertype">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="symbol">)</span><span class="function">vec_ld</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">,</span><span class="normal"> srcp</span><span class="symbol">);</span>
<span class="normal">            width </span><span class="symbol">-=</span><span class="normal"> extrawidth</span><span class="symbol">;</span>
<span class="normal">            </span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">                vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> voverflow</span><span class="symbol">;</span>
<span class="normal">                vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> vd</span><span class="symbol">;</span>
<span class="normal">                vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> valpha</span><span class="symbol">;</span>
<span class="normal">                vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> vdstalpha</span><span class="symbol">;</span>
<span class="normal">                </span><span class="comment">/* s = *srcp */</span>
<span class="normal">                voverflow </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vector </span><span class="usertype">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="symbol">)</span><span class="function">vec_ld</span><span class="symbol">(</span><span class="number">15</span><span class="symbol">,</span><span class="normal"> srcp</span><span class="symbol">);</span>
<span class="normal">                vs </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_perm</span><span class="symbol">(</span><span class="normal">vs</span><span class="symbol">,</span><span class="normal"> voverflow</span><span class="symbol">,</span><span class="normal"> valigner</span><span class="symbol">);</span>
<span class="normal">                vs </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_perm</span><span class="symbol">(</span><span class="normal">vs</span><span class="symbol">,</span><span class="normal"> v0</span><span class="symbol">,</span><span class="normal"> vsrcPermute</span><span class="symbol">);</span>

<span class="normal">                valpha </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_perm</span><span class="symbol">(</span><span class="normal">vs</span><span class="symbol">,</span><span class="normal"> v0</span><span class="symbol">,</span><span class="normal"> valphaPermute</span><span class="symbol">);</span>
<span class="normal">                </span>
<span class="normal">                </span><span class="comment">/* d = *dstp */</span>
<span class="normal">                vd </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vector </span><span class="usertype">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="symbol">)</span><span class="function">vec_ld</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">,</span><span class="normal"> dstp</span><span class="symbol">);</span>
<span class="normal">                vd </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_perm</span><span class="symbol">(</span><span class="normal">vd</span><span class="symbol">,</span><span class="normal"> v0</span><span class="symbol">,</span><span class="normal"> vsdstPermute</span><span class="symbol">);</span>
<span class="normal">                vdstalpha </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_and</span><span class="symbol">(</span><span class="normal">vd</span><span class="symbol">,</span><span class="normal"> valphamask</span><span class="symbol">);</span>

<span class="normal">                </span><span class="function">VEC_MULTIPLY_ALPHA</span><span class="symbol">(</span><span class="normal">vs</span><span class="symbol">,</span><span class="normal"> vd</span><span class="symbol">,</span><span class="normal"> valpha</span><span class="symbol">,</span><span class="normal"> mergePermute</span><span class="symbol">,</span><span class="normal"> v1</span><span class="symbol">,</span><span class="normal"> v8</span><span class="symbol">);</span>

<span class="normal">                </span><span class="comment">/* set the alpha to the dest alpha */</span>
<span class="normal">                vd </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_and</span><span class="symbol">(</span><span class="normal">vd</span><span class="symbol">,</span><span class="normal"> vpixelmask</span><span class="symbol">);</span>
<span class="normal">                vd </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_or</span><span class="symbol">(</span><span class="normal">vd</span><span class="symbol">,</span><span class="normal"> vdstalpha</span><span class="symbol">);</span>
<span class="normal">                vd </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_perm</span><span class="symbol">(</span><span class="normal">vd</span><span class="symbol">,</span><span class="normal"> v0</span><span class="symbol">,</span><span class="normal"> vdstPermute</span><span class="symbol">);</span>

<span class="normal">                </span><span class="comment">/* *dstp = res */</span>
<span class="normal">                </span><span class="function">vec_st</span><span class="symbol">((</span><span class="normal">vector </span><span class="usertype">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="symbol">)</span><span class="normal">vd</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> dstp</span><span class="symbol">);</span>
<span class="normal">                </span>
<span class="normal">                srcp </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">4</span><span class="symbol">;</span>
<span class="normal">                dstp </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">4</span><span class="symbol">;</span>
<span class="normal">                width </span><span class="symbol">-=</span><span class="normal"> </span><span class="number">4</span><span class="symbol">;</span>
<span class="normal">                vs </span><span class="symbol">=</span><span class="normal"> voverflow</span><span class="symbol">;</span>

<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="function">ONE_PIXEL_BLEND</span><span class="symbol">((</span><span class="normal">extrawidth</span><span class="symbol">),</span><span class="normal"> extrawidth</span><span class="symbol">);</span>
<span class="normal">        </span><span class="cbracket">}</span>
<span class="normal">	    srcp </span><span class="symbol">+=</span><span class="normal"> srcskip</span><span class="symbol">;</span>
<span class="normal">	    dstp </span><span class="symbol">+=</span><span class="normal"> dstskip</span><span class="symbol">;</span>
<span class="preproc">#undef</span><span class="normal"> ONE_PIXEL_BLEND</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="comment">/* fast ARGB888-&gt;(A)RGB888 blending with pixel alpha */</span>
<span class="keyword">static</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="function">BlitRGBtoRGBPixelAlphaAltivec</span><span class="symbol">(</span><span class="usertype">SDL_BlitInfo</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">info</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> width </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_width</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> height </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_height</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">Uint32</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">srcp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint32 </span><span class="symbol">*)</span><span class="normal">info</span><span class="symbol">-&gt;</span><span class="normal">s_pixels</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> srcskip </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">s_skip </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">Uint32</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dstp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint32 </span><span class="symbol">*)</span><span class="normal">info</span><span class="symbol">-&gt;</span><span class="normal">d_pixels</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> dstskip </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_skip </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> mergePermute</span><span class="symbol">;</span>
<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> valphaPermute</span><span class="symbol">;</span>
<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> valphamask</span><span class="symbol">;</span>
<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> vpixelmask</span><span class="symbol">;</span>
<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> v0</span><span class="symbol">;</span>
<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">short</span><span class="normal"> v1</span><span class="symbol">;</span>
<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">short</span><span class="normal"> v8</span><span class="symbol">;</span>
<span class="normal">    v0 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_splat_u8</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">);</span>
<span class="normal">    v1 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_splat_u16</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">    v8 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_splat_u16</span><span class="symbol">(</span><span class="number">8</span><span class="symbol">);</span>
<span class="normal">    mergePermute </span><span class="symbol">=</span><span class="normal"> </span><span class="function">VEC_MERGE_PERMUTE</span><span class="symbol">();</span>
<span class="normal">    valphamask </span><span class="symbol">=</span><span class="normal"> </span><span class="function">VEC_ALPHA_MASK</span><span class="symbol">();</span>
<span class="normal">    valphaPermute </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_and</span><span class="symbol">(</span><span class="function">vec_lvsl</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="normal"> </span><span class="symbol">*)</span><span class="normal">NULL</span><span class="symbol">),</span><span class="normal"> </span><span class="function">vec_splat_u8</span><span class="symbol">(</span><span class="number">0xC</span><span class="symbol">));</span>
<span class="normal">    </span>
<span class="normal"> </span>
<span class="normal">    vpixelmask </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_nor</span><span class="symbol">(</span><span class="normal">valphamask</span><span class="symbol">,</span><span class="normal"> v0</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">while</span><span class="symbol">(</span><span class="normal">height</span><span class="symbol">--)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">        width </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_width</span><span class="symbol">;</span>
<span class="preproc">#define</span><span class="normal"> </span><span class="function">ONE_PIXEL_BLEND</span><span class="symbol">(</span><span class="normal">condition</span><span class="symbol">,</span><span class="normal"> widthvar</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">        </span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">condition</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">            </span><span class="usertype">Uint32</span><span class="normal"> dalpha</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">            </span><span class="usertype">Uint32</span><span class="normal"> d</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">            </span><span class="usertype">Uint32</span><span class="normal"> s1</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">            </span><span class="usertype">Uint32</span><span class="normal"> d1</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">            </span><span class="usertype">Uint32</span><span class="normal"> s </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">srcp</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">            </span><span class="usertype">Uint32</span><span class="normal"> alpha </span><span class="symbol">=</span><span class="normal"> s </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">24</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">            </span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">alpha</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">              </span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">alpha </span><span class="symbol">==</span><span class="normal"> SDL_ALPHA_OPAQUE</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">                </span><span class="symbol">*</span><span class="normal">dstp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">s </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x00ffffff</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">|</span><span class="normal"> </span><span class="symbol">(*</span><span class="normal">dstp </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff000000</span><span class="symbol">);</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">              </span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">                d </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dstp</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">                dalpha </span><span class="symbol">=</span><span class="normal"> d </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff000000</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">                s1 </span><span class="symbol">=</span><span class="normal"> s </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff00ff</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">                d1 </span><span class="symbol">=</span><span class="normal"> d </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff00ff</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">                d1 </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">d1 </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">s1 </span><span class="symbol">-</span><span class="normal"> d1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> alpha </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff00ff</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">                s </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="number">0xff00</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">                d </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="number">0xff00</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">                d </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">d </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">s </span><span class="symbol">-</span><span class="normal"> d</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> alpha </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff00</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">                </span><span class="symbol">*</span><span class="normal">dstp </span><span class="symbol">=</span><span class="normal"> d1 </span><span class="symbol">|</span><span class="normal"> d </span><span class="symbol">|</span><span class="normal"> dalpha</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">              </span><span class="cbracket">}</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">            </span><span class="cbracket">}</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">            </span><span class="symbol">++</span><span class="normal">srcp</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">            </span><span class="symbol">++</span><span class="normal">dstp</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">            widthvar</span><span class="symbol">--;</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">        </span><span class="function">ONE_PIXEL_BLEND</span><span class="symbol">((</span><span class="function">UNALIGNED_PTR</span><span class="symbol">(</span><span class="normal">dstp</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width</span><span class="symbol">),</span><span class="normal"> width</span><span class="symbol">);</span>
<span class="normal">        </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="type">int</span><span class="normal"> extrawidth </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width </span><span class="symbol">%</span><span class="normal"> </span><span class="number">4</span><span class="symbol">);</span>
<span class="normal">            vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> valigner </span><span class="symbol">=</span><span class="normal"> </span><span class="function">VEC_ALIGNER</span><span class="symbol">(</span><span class="normal">srcp</span><span class="symbol">);</span>
<span class="normal">            vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> vs </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vector </span><span class="usertype">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="symbol">)</span><span class="function">vec_ld</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">,</span><span class="normal"> srcp</span><span class="symbol">);</span>
<span class="normal">            width </span><span class="symbol">-=</span><span class="normal"> extrawidth</span><span class="symbol">;</span>
<span class="normal">            </span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">                vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> voverflow</span><span class="symbol">;</span>
<span class="normal">                vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> vd</span><span class="symbol">;</span>
<span class="normal">                vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> valpha</span><span class="symbol">;</span>
<span class="normal">                vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> vdstalpha</span><span class="symbol">;</span>
<span class="normal">                </span><span class="comment">/* s = *srcp */</span>
<span class="normal">                voverflow </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vector </span><span class="usertype">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="symbol">)</span><span class="function">vec_ld</span><span class="symbol">(</span><span class="number">15</span><span class="symbol">,</span><span class="normal"> srcp</span><span class="symbol">);</span>
<span class="normal">                vs </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_perm</span><span class="symbol">(</span><span class="normal">vs</span><span class="symbol">,</span><span class="normal"> voverflow</span><span class="symbol">,</span><span class="normal"> valigner</span><span class="symbol">);</span>

<span class="normal">                valpha </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_perm</span><span class="symbol">(</span><span class="normal">vs</span><span class="symbol">,</span><span class="normal"> v0</span><span class="symbol">,</span><span class="normal"> valphaPermute</span><span class="symbol">);</span>
<span class="normal">                </span>
<span class="normal">                </span><span class="comment">/* d = *dstp */</span>
<span class="normal">                vd </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vector </span><span class="usertype">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="symbol">)</span><span class="function">vec_ld</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">,</span><span class="normal"> dstp</span><span class="symbol">);</span>
<span class="normal">                vdstalpha </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_and</span><span class="symbol">(</span><span class="normal">vd</span><span class="symbol">,</span><span class="normal"> valphamask</span><span class="symbol">);</span>

<span class="normal">                </span><span class="function">VEC_MULTIPLY_ALPHA</span><span class="symbol">(</span><span class="normal">vs</span><span class="symbol">,</span><span class="normal"> vd</span><span class="symbol">,</span><span class="normal"> valpha</span><span class="symbol">,</span><span class="normal"> mergePermute</span><span class="symbol">,</span><span class="normal"> v1</span><span class="symbol">,</span><span class="normal"> v8</span><span class="symbol">);</span>

<span class="normal">                </span><span class="comment">/* set the alpha to the dest alpha */</span>
<span class="normal">                vd </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_and</span><span class="symbol">(</span><span class="normal">vd</span><span class="symbol">,</span><span class="normal"> vpixelmask</span><span class="symbol">);</span>
<span class="normal">                vd </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_or</span><span class="symbol">(</span><span class="normal">vd</span><span class="symbol">,</span><span class="normal"> vdstalpha</span><span class="symbol">);</span>

<span class="normal">                </span><span class="comment">/* *dstp = res */</span>
<span class="normal">                </span><span class="function">vec_st</span><span class="symbol">((</span><span class="normal">vector </span><span class="usertype">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="symbol">)</span><span class="normal">vd</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> dstp</span><span class="symbol">);</span>
<span class="normal">                </span>
<span class="normal">                srcp </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">4</span><span class="symbol">;</span>
<span class="normal">                dstp </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">4</span><span class="symbol">;</span>
<span class="normal">                width </span><span class="symbol">-=</span><span class="normal"> </span><span class="number">4</span><span class="symbol">;</span>
<span class="normal">                vs </span><span class="symbol">=</span><span class="normal"> voverflow</span><span class="symbol">;</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="function">ONE_PIXEL_BLEND</span><span class="symbol">((</span><span class="normal">extrawidth</span><span class="symbol">),</span><span class="normal"> extrawidth</span><span class="symbol">);</span>
<span class="normal">        </span><span class="cbracket">}</span>
<span class="normal">	    srcp </span><span class="symbol">+=</span><span class="normal"> srcskip</span><span class="symbol">;</span>
<span class="normal">	    dstp </span><span class="symbol">+=</span><span class="normal"> dstskip</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="preproc">#undef</span><span class="normal"> ONE_PIXEL_BLEND</span>
<span class="cbracket">}</span>

<span class="keyword">static</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="function">Blit32to32SurfaceAlphaAltivec</span><span class="symbol">(</span><span class="usertype">SDL_BlitInfo</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">info</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="comment">/* XXX : 6 */</span>
<span class="normal">	</span><span class="type">unsigned</span><span class="normal"> alpha </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">src</span><span class="symbol">-&gt;</span><span class="normal">alpha</span><span class="symbol">;</span>
<span class="normal">    </span><span class="type">int</span><span class="normal"> height </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_height</span><span class="symbol">;</span>
<span class="normal">    </span><span class="usertype">Uint32</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">srcp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint32 </span><span class="symbol">*)</span><span class="normal">info</span><span class="symbol">-&gt;</span><span class="normal">s_pixels</span><span class="symbol">;</span>
<span class="normal">    </span><span class="type">int</span><span class="normal"> srcskip </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">s_skip </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">    </span><span class="usertype">Uint32</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dstp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint32 </span><span class="symbol">*)</span><span class="normal">info</span><span class="symbol">-&gt;</span><span class="normal">d_pixels</span><span class="symbol">;</span>
<span class="normal">    </span><span class="type">int</span><span class="normal"> dstskip </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_skip </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">    </span><span class="usertype">SDL_PixelFormat</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">srcfmt </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">src</span><span class="symbol">;</span>
<span class="normal">    </span><span class="usertype">SDL_PixelFormat</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dstfmt </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">dst</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">unsigned</span><span class="normal"> sA </span><span class="symbol">=</span><span class="normal"> srcfmt</span><span class="symbol">-&gt;</span><span class="normal">alpha</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">unsigned</span><span class="normal"> dA </span><span class="symbol">=</span><span class="normal"> dstfmt</span><span class="symbol">-&gt;</span><span class="normal">Amask </span><span class="symbol">?</span><span class="normal"> SDL_ALPHA_OPAQUE </span><span class="symbol">:</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> mergePermute</span><span class="symbol">;</span>
<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> vsrcPermute</span><span class="symbol">;</span>
<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> vdstPermute</span><span class="symbol">;</span>
<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> vsdstPermute</span><span class="symbol">;</span>
<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> valpha</span><span class="symbol">;</span>
<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> valphamask</span><span class="symbol">;</span>
<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> vbits</span><span class="symbol">;</span>
<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">short</span><span class="normal"> v1</span><span class="symbol">;</span>
<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">short</span><span class="normal"> v8</span><span class="symbol">;</span>

<span class="normal">    mergePermute </span><span class="symbol">=</span><span class="normal"> </span><span class="function">VEC_MERGE_PERMUTE</span><span class="symbol">();</span>
<span class="normal">    v1 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_splat_u16</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">    v8 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_splat_u16</span><span class="symbol">(</span><span class="number">8</span><span class="symbol">);</span>

<span class="normal">    </span><span class="comment">/* set the alpha to 255 on the destination surf */</span>
<span class="normal">    valphamask </span><span class="symbol">=</span><span class="normal"> </span><span class="function">VEC_ALPHA_MASK</span><span class="symbol">();</span>

<span class="normal">    vsrcPermute </span><span class="symbol">=</span><span class="normal"> </span><span class="function">calc_swizzle32</span><span class="symbol">(</span><span class="normal">srcfmt</span><span class="symbol">,</span><span class="normal"> NULL</span><span class="symbol">);</span>
<span class="normal">    vdstPermute </span><span class="symbol">=</span><span class="normal"> </span><span class="function">calc_swizzle32</span><span class="symbol">(</span><span class="normal">NULL</span><span class="symbol">,</span><span class="normal"> dstfmt</span><span class="symbol">);</span>
<span class="normal">    vsdstPermute </span><span class="symbol">=</span><span class="normal"> </span><span class="function">calc_swizzle32</span><span class="symbol">(</span><span class="normal">dstfmt</span><span class="symbol">,</span><span class="normal"> NULL</span><span class="symbol">);</span>

<span class="normal">    </span><span class="comment">/* set a vector full of alpha and 255-alpha */</span>
<span class="normal">    </span><span class="symbol">((</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*)&amp;</span><span class="normal">valpha</span><span class="symbol">)[</span><span class="number">0</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> alpha</span><span class="symbol">;</span>
<span class="normal">    valpha </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_splat</span><span class="symbol">(</span><span class="normal">valpha</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">);</span>
<span class="normal">    vbits </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vector </span><span class="usertype">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="symbol">)</span><span class="function">vec_splat_s8</span><span class="symbol">(-</span><span class="number">1</span><span class="symbol">);</span>

<span class="normal">    </span><span class="keyword">while</span><span class="symbol">(</span><span class="normal">height</span><span class="symbol">--)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">        </span><span class="type">int</span><span class="normal"> width </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_width</span><span class="symbol">;</span>
<span class="preproc">#define</span><span class="normal"> </span><span class="function">ONE_PIXEL_BLEND</span><span class="symbol">(</span><span class="normal">condition</span><span class="symbol">,</span><span class="normal"> widthvar</span><span class="symbol">)</span><span class="normal"> </span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">condition</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">            </span><span class="usertype">Uint32</span><span class="normal"> Pixel</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">            </span><span class="type">unsigned</span><span class="normal"> sR</span><span class="symbol">,</span><span class="normal"> sG</span><span class="symbol">,</span><span class="normal"> sB</span><span class="symbol">,</span><span class="normal"> dR</span><span class="symbol">,</span><span class="normal"> dG</span><span class="symbol">,</span><span class="normal"> dB</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">            </span><span class="function">DISEMBLE_RGB</span><span class="symbol">(((</span><span class="normal">Uint8 </span><span class="symbol">*)</span><span class="normal">srcp</span><span class="symbol">),</span><span class="normal"> </span><span class="number">4</span><span class="symbol">,</span><span class="normal"> srcfmt</span><span class="symbol">,</span><span class="normal"> Pixel</span><span class="symbol">,</span><span class="normal"> sR</span><span class="symbol">,</span><span class="normal"> sG</span><span class="symbol">,</span><span class="normal"> sB</span><span class="symbol">);</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">            </span><span class="function">DISEMBLE_RGB</span><span class="symbol">(((</span><span class="normal">Uint8 </span><span class="symbol">*)</span><span class="normal">dstp</span><span class="symbol">),</span><span class="normal"> </span><span class="number">4</span><span class="symbol">,</span><span class="normal"> dstfmt</span><span class="symbol">,</span><span class="normal"> Pixel</span><span class="symbol">,</span><span class="normal"> dR</span><span class="symbol">,</span><span class="normal"> dG</span><span class="symbol">,</span><span class="normal"> dB</span><span class="symbol">);</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">            </span><span class="function">ACCURATE_ALPHA_BLEND</span><span class="symbol">(</span><span class="normal">sR</span><span class="symbol">,</span><span class="normal"> sG</span><span class="symbol">,</span><span class="normal"> sB</span><span class="symbol">,</span><span class="normal"> sA</span><span class="symbol">,</span><span class="normal"> dR</span><span class="symbol">,</span><span class="normal"> dG</span><span class="symbol">,</span><span class="normal"> dB</span><span class="symbol">);</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">            </span><span class="function">ASSEMBLE_RGBA</span><span class="symbol">(((</span><span class="normal">Uint8 </span><span class="symbol">*)</span><span class="normal">dstp</span><span class="symbol">),</span><span class="normal"> </span><span class="number">4</span><span class="symbol">,</span><span class="normal"> dstfmt</span><span class="symbol">,</span><span class="normal"> dR</span><span class="symbol">,</span><span class="normal"> dG</span><span class="symbol">,</span><span class="normal"> dB</span><span class="symbol">,</span><span class="normal"> dA</span><span class="symbol">);</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">            </span><span class="symbol">++</span><span class="normal">srcp</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">            </span><span class="symbol">++</span><span class="normal">dstp</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">            widthvar</span><span class="symbol">--;</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">        </span><span class="cbracket">}</span>
<span class="normal">        </span><span class="function">ONE_PIXEL_BLEND</span><span class="symbol">((</span><span class="function">UNALIGNED_PTR</span><span class="symbol">(</span><span class="normal">dstp</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width</span><span class="symbol">),</span><span class="normal"> width</span><span class="symbol">);</span>
<span class="normal">        </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="type">int</span><span class="normal"> extrawidth </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width </span><span class="symbol">%</span><span class="normal"> </span><span class="number">4</span><span class="symbol">);</span>
<span class="normal">            vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> valigner </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_lvsl</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">,</span><span class="normal"> srcp</span><span class="symbol">);</span>
<span class="normal">            vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> vs </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vector </span><span class="usertype">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="symbol">)</span><span class="function">vec_ld</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">,</span><span class="normal"> srcp</span><span class="symbol">);</span>
<span class="normal">            width </span><span class="symbol">-=</span><span class="normal"> extrawidth</span><span class="symbol">;</span>
<span class="normal">            </span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">                vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> voverflow</span><span class="symbol">;</span>
<span class="normal">                vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> vd</span><span class="symbol">;</span>

<span class="normal">                </span><span class="comment">/* s = *srcp */</span>
<span class="normal">                voverflow </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vector </span><span class="usertype">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="symbol">)</span><span class="function">vec_ld</span><span class="symbol">(</span><span class="number">15</span><span class="symbol">,</span><span class="normal"> srcp</span><span class="symbol">);</span>
<span class="normal">                vs </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_perm</span><span class="symbol">(</span><span class="normal">vs</span><span class="symbol">,</span><span class="normal"> voverflow</span><span class="symbol">,</span><span class="normal"> valigner</span><span class="symbol">);</span>
<span class="normal">                vs </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_perm</span><span class="symbol">(</span><span class="normal">vs</span><span class="symbol">,</span><span class="normal"> valpha</span><span class="symbol">,</span><span class="normal"> vsrcPermute</span><span class="symbol">);</span>
<span class="normal">                </span>
<span class="normal">                </span><span class="comment">/* d = *dstp */</span>
<span class="normal">                vd </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vector </span><span class="usertype">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="symbol">)</span><span class="function">vec_ld</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">,</span><span class="normal"> dstp</span><span class="symbol">);</span>
<span class="normal">                vd </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_perm</span><span class="symbol">(</span><span class="normal">vd</span><span class="symbol">,</span><span class="normal"> vd</span><span class="symbol">,</span><span class="normal"> vsdstPermute</span><span class="symbol">);</span>

<span class="normal">                </span><span class="function">VEC_MULTIPLY_ALPHA</span><span class="symbol">(</span><span class="normal">vs</span><span class="symbol">,</span><span class="normal"> vd</span><span class="symbol">,</span><span class="normal"> valpha</span><span class="symbol">,</span><span class="normal"> mergePermute</span><span class="symbol">,</span><span class="normal"> v1</span><span class="symbol">,</span><span class="normal"> v8</span><span class="symbol">);</span>

<span class="normal">                </span><span class="comment">/* set the alpha channel to full on */</span>
<span class="normal">                vd </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_or</span><span class="symbol">(</span><span class="normal">vd</span><span class="symbol">,</span><span class="normal"> valphamask</span><span class="symbol">);</span>
<span class="normal">                vd </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_perm</span><span class="symbol">(</span><span class="normal">vd</span><span class="symbol">,</span><span class="normal"> vbits</span><span class="symbol">,</span><span class="normal"> vdstPermute</span><span class="symbol">);</span>

<span class="normal">                </span><span class="comment">/* *dstp = res */</span>
<span class="normal">                </span><span class="function">vec_st</span><span class="symbol">((</span><span class="normal">vector </span><span class="usertype">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="symbol">)</span><span class="normal">vd</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> dstp</span><span class="symbol">);</span>
<span class="normal">                </span>
<span class="normal">                srcp </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">4</span><span class="symbol">;</span>
<span class="normal">                dstp </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">4</span><span class="symbol">;</span>
<span class="normal">                width </span><span class="symbol">-=</span><span class="normal"> </span><span class="number">4</span><span class="symbol">;</span>
<span class="normal">                vs </span><span class="symbol">=</span><span class="normal"> voverflow</span><span class="symbol">;</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="function">ONE_PIXEL_BLEND</span><span class="symbol">((</span><span class="normal">extrawidth</span><span class="symbol">),</span><span class="normal"> extrawidth</span><span class="symbol">);</span>
<span class="normal">        </span><span class="cbracket">}</span>
<span class="preproc">#undef</span><span class="normal"> ONE_PIXEL_BLEND</span>
<span class="normal"> </span>
<span class="normal">        srcp </span><span class="symbol">+=</span><span class="normal"> srcskip</span><span class="symbol">;</span>
<span class="normal">        dstp </span><span class="symbol">+=</span><span class="normal"> dstskip</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="cbracket">}</span>


<span class="comment">/* fast RGB888-&gt;(A)RGB888 blending */</span>
<span class="keyword">static</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="function">BlitRGBtoRGBSurfaceAlphaAltivec</span><span class="symbol">(</span><span class="usertype">SDL_BlitInfo</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">info</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">	</span><span class="type">unsigned</span><span class="normal"> alpha </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">src</span><span class="symbol">-&gt;</span><span class="normal">alpha</span><span class="symbol">;</span>
<span class="normal">    </span><span class="type">int</span><span class="normal"> height </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_height</span><span class="symbol">;</span>
<span class="normal">    </span><span class="usertype">Uint32</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">srcp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint32 </span><span class="symbol">*)</span><span class="normal">info</span><span class="symbol">-&gt;</span><span class="normal">s_pixels</span><span class="symbol">;</span>
<span class="normal">    </span><span class="type">int</span><span class="normal"> srcskip </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">s_skip </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">    </span><span class="usertype">Uint32</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dstp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint32 </span><span class="symbol">*)</span><span class="normal">info</span><span class="symbol">-&gt;</span><span class="normal">d_pixels</span><span class="symbol">;</span>
<span class="normal">    </span><span class="type">int</span><span class="normal"> dstskip </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_skip </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> mergePermute</span><span class="symbol">;</span>
<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> valpha</span><span class="symbol">;</span>
<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> valphamask</span><span class="symbol">;</span>
<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">short</span><span class="normal"> v1</span><span class="symbol">;</span>
<span class="normal">    vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">short</span><span class="normal"> v8</span><span class="symbol">;</span>

<span class="normal">    mergePermute </span><span class="symbol">=</span><span class="normal"> </span><span class="function">VEC_MERGE_PERMUTE</span><span class="symbol">();</span>
<span class="normal">    v1 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_splat_u16</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">    v8 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_splat_u16</span><span class="symbol">(</span><span class="number">8</span><span class="symbol">);</span>

<span class="normal">    </span><span class="comment">/* set the alpha to 255 on the destination surf */</span>
<span class="normal">    valphamask </span><span class="symbol">=</span><span class="normal"> </span><span class="function">VEC_ALPHA_MASK</span><span class="symbol">();</span>

<span class="normal">    </span><span class="comment">/* set a vector full of alpha and 255-alpha */</span>
<span class="normal">    </span><span class="symbol">((</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*)&amp;</span><span class="normal">valpha</span><span class="symbol">)[</span><span class="number">0</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> alpha</span><span class="symbol">;</span>
<span class="normal">    valpha </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_splat</span><span class="symbol">(</span><span class="normal">valpha</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">);</span>

<span class="normal">    </span><span class="keyword">while</span><span class="symbol">(</span><span class="normal">height</span><span class="symbol">--)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">        </span><span class="type">int</span><span class="normal"> width </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_width</span><span class="symbol">;</span>
<span class="preproc">#define</span><span class="normal"> </span><span class="function">ONE_PIXEL_BLEND</span><span class="symbol">(</span><span class="normal">condition</span><span class="symbol">,</span><span class="normal"> widthvar</span><span class="symbol">)</span><span class="normal"> </span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">condition</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">            </span><span class="usertype">Uint32</span><span class="normal"> s </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">srcp</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">            </span><span class="usertype">Uint32</span><span class="normal"> d </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dstp</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">            </span><span class="usertype">Uint32</span><span class="normal"> s1 </span><span class="symbol">=</span><span class="normal"> s </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff00ff</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">            </span><span class="usertype">Uint32</span><span class="normal"> d1 </span><span class="symbol">=</span><span class="normal"> d </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff00ff</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">            d1 </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">d1 </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">s1 </span><span class="symbol">-</span><span class="normal"> d1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> alpha </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">                 </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff00ff</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">            s </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="number">0xff00</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">            d </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="number">0xff00</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">            d </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">d </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">s </span><span class="symbol">-</span><span class="normal"> d</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> alpha </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff00</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">            </span><span class="symbol">*</span><span class="normal">dstp </span><span class="symbol">=</span><span class="normal"> d1 </span><span class="symbol">|</span><span class="normal"> d </span><span class="symbol">|</span><span class="normal"> </span><span class="number">0xff000000</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">            </span><span class="symbol">++</span><span class="normal">srcp</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">            </span><span class="symbol">++</span><span class="normal">dstp</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">            widthvar</span><span class="symbol">--;</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">        </span><span class="cbracket">}</span>
<span class="normal">        </span><span class="function">ONE_PIXEL_BLEND</span><span class="symbol">((</span><span class="function">UNALIGNED_PTR</span><span class="symbol">(</span><span class="normal">dstp</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width</span><span class="symbol">),</span><span class="normal"> width</span><span class="symbol">);</span>
<span class="normal">        </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="type">int</span><span class="normal"> extrawidth </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width </span><span class="symbol">%</span><span class="normal"> </span><span class="number">4</span><span class="symbol">);</span>
<span class="normal">            vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> valigner </span><span class="symbol">=</span><span class="normal"> </span><span class="function">VEC_ALIGNER</span><span class="symbol">(</span><span class="normal">srcp</span><span class="symbol">);</span>
<span class="normal">            vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> vs </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vector </span><span class="usertype">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="symbol">)</span><span class="function">vec_ld</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">,</span><span class="normal"> srcp</span><span class="symbol">);</span>
<span class="normal">            width </span><span class="symbol">-=</span><span class="normal"> extrawidth</span><span class="symbol">;</span>
<span class="normal">            </span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">                vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> voverflow</span><span class="symbol">;</span>
<span class="normal">                vector </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> vd</span><span class="symbol">;</span>

<span class="normal">                </span><span class="comment">/* s = *srcp */</span>
<span class="normal">                voverflow </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vector </span><span class="usertype">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="symbol">)</span><span class="function">vec_ld</span><span class="symbol">(</span><span class="number">15</span><span class="symbol">,</span><span class="normal"> srcp</span><span class="symbol">);</span>
<span class="normal">                vs </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_perm</span><span class="symbol">(</span><span class="normal">vs</span><span class="symbol">,</span><span class="normal"> voverflow</span><span class="symbol">,</span><span class="normal"> valigner</span><span class="symbol">);</span>
<span class="normal">                </span>
<span class="normal">                </span><span class="comment">/* d = *dstp */</span>
<span class="normal">                vd </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vector </span><span class="usertype">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="symbol">)</span><span class="function">vec_ld</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">,</span><span class="normal"> dstp</span><span class="symbol">);</span>

<span class="normal">                </span><span class="function">VEC_MULTIPLY_ALPHA</span><span class="symbol">(</span><span class="normal">vs</span><span class="symbol">,</span><span class="normal"> vd</span><span class="symbol">,</span><span class="normal"> valpha</span><span class="symbol">,</span><span class="normal"> mergePermute</span><span class="symbol">,</span><span class="normal"> v1</span><span class="symbol">,</span><span class="normal"> v8</span><span class="symbol">);</span>

<span class="normal">                </span><span class="comment">/* set the alpha channel to full on */</span>
<span class="normal">                vd </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vec_or</span><span class="symbol">(</span><span class="normal">vd</span><span class="symbol">,</span><span class="normal"> valphamask</span><span class="symbol">);</span>

<span class="normal">                </span><span class="comment">/* *dstp = res */</span>
<span class="normal">                </span><span class="function">vec_st</span><span class="symbol">((</span><span class="normal">vector </span><span class="usertype">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="symbol">)</span><span class="normal">vd</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> dstp</span><span class="symbol">);</span>
<span class="normal">                </span>
<span class="normal">                srcp </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">4</span><span class="symbol">;</span>
<span class="normal">                dstp </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">4</span><span class="symbol">;</span>
<span class="normal">                width </span><span class="symbol">-=</span><span class="normal"> </span><span class="number">4</span><span class="symbol">;</span>
<span class="normal">                vs </span><span class="symbol">=</span><span class="normal"> voverflow</span><span class="symbol">;</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="function">ONE_PIXEL_BLEND</span><span class="symbol">((</span><span class="normal">extrawidth</span><span class="symbol">),</span><span class="normal"> extrawidth</span><span class="symbol">);</span>
<span class="normal">        </span><span class="cbracket">}</span>
<span class="preproc">#undef</span><span class="normal"> ONE_PIXEL_BLEND</span>
<span class="normal"> </span>
<span class="normal">        srcp </span><span class="symbol">+=</span><span class="normal"> srcskip</span><span class="symbol">;</span>
<span class="normal">        dstp </span><span class="symbol">+=</span><span class="normal"> dstskip</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="cbracket">}</span>
<span class="preproc">#if</span><span class="normal"> __MWERKS__</span>
<span class="preproc">#pragma</span><span class="normal"> altivec_model off</span>
<span class="preproc">#endif</span>
<span class="preproc">#endif</span><span class="normal"> </span><span class="comment">/* SDL_ALTIVEC_BLITTERS */</span>

<span class="comment">/* fast RGB888-&gt;(A)RGB888 blending with surface alpha=128 special case */</span>
<span class="keyword">static</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="function">BlitRGBtoRGBSurfaceAlpha128</span><span class="symbol">(</span><span class="usertype">SDL_BlitInfo</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">info</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> width </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_width</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> height </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_height</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">Uint32</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">srcp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint32 </span><span class="symbol">*)</span><span class="normal">info</span><span class="symbol">-&gt;</span><span class="normal">s_pixels</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> srcskip </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">s_skip </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">Uint32</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dstp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint32 </span><span class="symbol">*)</span><span class="normal">info</span><span class="symbol">-&gt;</span><span class="normal">d_pixels</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> dstskip </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_skip </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">while</span><span class="symbol">(</span><span class="normal">height</span><span class="symbol">--)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="function">DUFFS_LOOP4</span><span class="symbol">(</span><span class="cbracket">{</span>
<span class="normal">		    </span><span class="usertype">Uint32</span><span class="normal"> s </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">srcp</span><span class="symbol">++;</span>
<span class="normal">		    </span><span class="usertype">Uint32</span><span class="normal"> d </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dstp</span><span class="symbol">;</span>
<span class="normal">		    </span><span class="symbol">*</span><span class="normal">dstp</span><span class="symbol">++</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">((((</span><span class="normal">s </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x00fefefe</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">d </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x00fefefe</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span>
<span class="normal">			       </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">s </span><span class="symbol">&amp;</span><span class="normal"> d </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x00010101</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">|</span><span class="normal"> </span><span class="number">0xff000000</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="cbracket">}</span><span class="symbol">,</span><span class="normal"> width</span><span class="symbol">);</span>
<span class="normal">	    srcp </span><span class="symbol">+=</span><span class="normal"> srcskip</span><span class="symbol">;</span>
<span class="normal">	    dstp </span><span class="symbol">+=</span><span class="normal"> dstskip</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="comment">/* fast RGB888-&gt;(A)RGB888 blending with surface alpha */</span>
<span class="keyword">static</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="function">BlitRGBtoRGBSurfaceAlpha</span><span class="symbol">(</span><span class="usertype">SDL_BlitInfo</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">info</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">	</span><span class="type">unsigned</span><span class="normal"> alpha </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">src</span><span class="symbol">-&gt;</span><span class="normal">alpha</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">alpha </span><span class="symbol">==</span><span class="normal"> </span><span class="number">128</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">BlitRGBtoRGBSurfaceAlpha128</span><span class="symbol">(</span><span class="normal">info</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> width </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_width</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> height </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_height</span><span class="symbol">;</span>
<span class="normal">		</span><span class="usertype">Uint32</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">srcp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint32 </span><span class="symbol">*)</span><span class="normal">info</span><span class="symbol">-&gt;</span><span class="normal">s_pixels</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> srcskip </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">s_skip </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">		</span><span class="usertype">Uint32</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dstp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint32 </span><span class="symbol">*)</span><span class="normal">info</span><span class="symbol">-&gt;</span><span class="normal">d_pixels</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> dstskip </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_skip </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">		</span><span class="usertype">Uint32</span><span class="normal"> s</span><span class="symbol">;</span>
<span class="normal">		</span><span class="usertype">Uint32</span><span class="normal"> d</span><span class="symbol">;</span>
<span class="normal">		</span><span class="usertype">Uint32</span><span class="normal"> s1</span><span class="symbol">;</span>
<span class="normal">		</span><span class="usertype">Uint32</span><span class="normal"> d1</span><span class="symbol">;</span>

<span class="normal">		</span><span class="keyword">while</span><span class="symbol">(</span><span class="normal">height</span><span class="symbol">--)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="function">DUFFS_LOOP_DOUBLE2</span><span class="symbol">(</span><span class="cbracket">{</span>
<span class="normal">				</span><span class="comment">/* One Pixel Blend */</span>
<span class="normal">				s </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">srcp</span><span class="symbol">;</span>
<span class="normal">				d </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dstp</span><span class="symbol">;</span>
<span class="normal">				s1 </span><span class="symbol">=</span><span class="normal"> s </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff00ff</span><span class="symbol">;</span>
<span class="normal">				d1 </span><span class="symbol">=</span><span class="normal"> d </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff00ff</span><span class="symbol">;</span>
<span class="normal">				d1 </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">d1 </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">s1 </span><span class="symbol">-</span><span class="normal"> d1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> alpha </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">))</span>
<span class="normal">				     </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff00ff</span><span class="symbol">;</span>
<span class="normal">				s </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="number">0xff00</span><span class="symbol">;</span>
<span class="normal">				d </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="number">0xff00</span><span class="symbol">;</span>
<span class="normal">				d </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">d </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">s </span><span class="symbol">-</span><span class="normal"> d</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> alpha </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff00</span><span class="symbol">;</span>
<span class="normal">				</span><span class="symbol">*</span><span class="normal">dstp </span><span class="symbol">=</span><span class="normal"> d1 </span><span class="symbol">|</span><span class="normal"> d </span><span class="symbol">|</span><span class="normal"> </span><span class="number">0xff000000</span><span class="symbol">;</span>
<span class="normal">				</span><span class="symbol">++</span><span class="normal">srcp</span><span class="symbol">;</span>
<span class="normal">				</span><span class="symbol">++</span><span class="normal">dstp</span><span class="symbol">;</span>
<span class="normal">			</span><span class="cbracket">}</span><span class="symbol">,</span><span class="cbracket">{</span>
<span class="normal">			        </span><span class="comment">/* Two Pixels Blend */</span>
<span class="normal">				s </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">srcp</span><span class="symbol">;</span>
<span class="normal">				d </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dstp</span><span class="symbol">;</span>
<span class="normal">				s1 </span><span class="symbol">=</span><span class="normal"> s </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff00ff</span><span class="symbol">;</span>
<span class="normal">				d1 </span><span class="symbol">=</span><span class="normal"> d </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff00ff</span><span class="symbol">;</span>
<span class="normal">				d1 </span><span class="symbol">+=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">s1 </span><span class="symbol">-</span><span class="normal"> d1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> alpha </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">;</span>
<span class="normal">				d1 </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="number">0xff00ff</span><span class="symbol">;</span>
<span class="normal">				     </span>
<span class="normal">				s </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">s </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff00</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">|</span><span class="normal"> </span>
<span class="normal">					</span><span class="symbol">((</span><span class="normal">srcp</span><span class="symbol">[</span><span class="number">1</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff00</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">);</span>
<span class="normal">				d </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">d </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff00</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">|</span>
<span class="normal">					</span><span class="symbol">((</span><span class="normal">dstp</span><span class="symbol">[</span><span class="number">1</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff00</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">);</span>
<span class="normal">				d </span><span class="symbol">+=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">s </span><span class="symbol">-</span><span class="normal"> d</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> alpha </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">;</span>
<span class="normal">				d </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="number">0x00ff00ff</span><span class="symbol">;</span>
<span class="normal">				</span>
<span class="normal">				</span><span class="symbol">*</span><span class="normal">dstp</span><span class="symbol">++</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> d1 </span><span class="symbol">|</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">d </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff00</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">|</span><span class="normal"> </span><span class="number">0xff000000</span><span class="symbol">;</span>
<span class="normal">				</span><span class="symbol">++</span><span class="normal">srcp</span><span class="symbol">;</span>
<span class="normal">				</span>
<span class="normal">			        s1 </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">srcp</span><span class="symbol">;</span>
<span class="normal">				d1 </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dstp</span><span class="symbol">;</span>
<span class="normal">				s1 </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="number">0xff00ff</span><span class="symbol">;</span>
<span class="normal">				d1 </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="number">0xff00ff</span><span class="symbol">;</span>
<span class="normal">				d1 </span><span class="symbol">+=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">s1 </span><span class="symbol">-</span><span class="normal"> d1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> alpha </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">;</span>
<span class="normal">				d1 </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="number">0xff00ff</span><span class="symbol">;</span>
<span class="normal">				</span>
<span class="normal">				</span><span class="symbol">*</span><span class="normal">dstp </span><span class="symbol">=</span><span class="normal"> d1 </span><span class="symbol">|</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">d </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff00</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">|</span><span class="normal"> </span><span class="number">0xff000000</span><span class="symbol">;</span>
<span class="normal">				</span><span class="symbol">++</span><span class="normal">srcp</span><span class="symbol">;</span>
<span class="normal">				</span><span class="symbol">++</span><span class="normal">dstp</span><span class="symbol">;</span>
<span class="normal">			</span><span class="cbracket">}</span><span class="symbol">,</span><span class="normal"> width</span><span class="symbol">);</span>
<span class="normal">			srcp </span><span class="symbol">+=</span><span class="normal"> srcskip</span><span class="symbol">;</span>
<span class="normal">			dstp </span><span class="symbol">+=</span><span class="normal"> dstskip</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="comment">/* fast ARGB888-&gt;(A)RGB888 blending with pixel alpha */</span>
<span class="keyword">static</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="function">BlitRGBtoRGBPixelAlpha</span><span class="symbol">(</span><span class="usertype">SDL_BlitInfo</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">info</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> width </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_width</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> height </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_height</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">Uint32</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">srcp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint32 </span><span class="symbol">*)</span><span class="normal">info</span><span class="symbol">-&gt;</span><span class="normal">s_pixels</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> srcskip </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">s_skip </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">Uint32</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dstp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint32 </span><span class="symbol">*)</span><span class="normal">info</span><span class="symbol">-&gt;</span><span class="normal">d_pixels</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> dstskip </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_skip </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">while</span><span class="symbol">(</span><span class="normal">height</span><span class="symbol">--)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="function">DUFFS_LOOP4</span><span class="symbol">(</span><span class="cbracket">{</span>
<span class="normal">		</span><span class="usertype">Uint32</span><span class="normal"> dalpha</span><span class="symbol">;</span>
<span class="normal">		</span><span class="usertype">Uint32</span><span class="normal"> d</span><span class="symbol">;</span>
<span class="normal">		</span><span class="usertype">Uint32</span><span class="normal"> s1</span><span class="symbol">;</span>
<span class="normal">		</span><span class="usertype">Uint32</span><span class="normal"> d1</span><span class="symbol">;</span>
<span class="normal">		</span><span class="usertype">Uint32</span><span class="normal"> s </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">srcp</span><span class="symbol">;</span>
<span class="normal">		</span><span class="usertype">Uint32</span><span class="normal"> alpha </span><span class="symbol">=</span><span class="normal"> s </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">24</span><span class="symbol">;</span>
<span class="normal">		</span><span class="comment">/* </span><span class="todo">FIXME:</span><span class="comment"> Here we special-case opaque alpha since the</span>
<span class="comment">		   compositioning used (&gt;&gt;8 instead of /255) doesn't handle</span>
<span class="comment">		   it correctly. Also special-case alpha=0 for speed?</span>
<span class="comment">		   Benchmark this! */</span>
<span class="normal">		</span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">alpha</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal">   </span>
<span class="normal">		  </span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">alpha </span><span class="symbol">==</span><span class="normal"> SDL_ALPHA_OPAQUE</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		    </span><span class="symbol">*</span><span class="normal">dstp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">s </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x00ffffff</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">|</span><span class="normal"> </span><span class="symbol">(*</span><span class="normal">dstp </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff000000</span><span class="symbol">);</span>
<span class="normal">		  </span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		    </span><span class="comment">/*</span>
<span class="comment">		     * take out the middle component (green), and process</span>
<span class="comment">		     * the other two in parallel. One multiply less.</span>
<span class="comment">		     */</span>
<span class="normal">		    d </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dstp</span><span class="symbol">;</span>
<span class="normal">		    dalpha </span><span class="symbol">=</span><span class="normal"> d </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff000000</span><span class="symbol">;</span>
<span class="normal">		    s1 </span><span class="symbol">=</span><span class="normal"> s </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff00ff</span><span class="symbol">;</span>
<span class="normal">		    d1 </span><span class="symbol">=</span><span class="normal"> d </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff00ff</span><span class="symbol">;</span>
<span class="normal">		    d1 </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">d1 </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">s1 </span><span class="symbol">-</span><span class="normal"> d1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> alpha </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff00ff</span><span class="symbol">;</span>
<span class="normal">		    s </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="number">0xff00</span><span class="symbol">;</span>
<span class="normal">		    d </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="number">0xff00</span><span class="symbol">;</span>
<span class="normal">		    d </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">d </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">s </span><span class="symbol">-</span><span class="normal"> d</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> alpha </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff00</span><span class="symbol">;</span>
<span class="normal">		    </span><span class="symbol">*</span><span class="normal">dstp </span><span class="symbol">=</span><span class="normal"> d1 </span><span class="symbol">|</span><span class="normal"> d </span><span class="symbol">|</span><span class="normal"> dalpha</span><span class="symbol">;</span>
<span class="normal">		  </span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="symbol">++</span><span class="normal">srcp</span><span class="symbol">;</span>
<span class="normal">		</span><span class="symbol">++</span><span class="normal">dstp</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="cbracket">}</span><span class="symbol">,</span><span class="normal"> width</span><span class="symbol">);</span>
<span class="normal">	    srcp </span><span class="symbol">+=</span><span class="normal"> srcskip</span><span class="symbol">;</span>
<span class="normal">	    dstp </span><span class="symbol">+=</span><span class="normal"> dstskip</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="preproc">#if</span><span class="normal"> GCC_ASMBLIT</span>
<span class="comment">/* fast (as in MMX with prefetch) ARGB888-&gt;(A)RGB888 blending with pixel alpha */</span>
<span class="normal">inline </span><span class="keyword">static</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="function">BlitRGBtoRGBPixelAlphaMMX3DNOW</span><span class="symbol">(</span><span class="usertype">SDL_BlitInfo</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">info</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> width </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_width</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> height </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_height</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">Uint32</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">srcp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint32 </span><span class="symbol">*)</span><span class="normal">info</span><span class="symbol">-&gt;</span><span class="normal">s_pixels</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> srcskip </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">s_skip </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">Uint32</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dstp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint32 </span><span class="symbol">*)</span><span class="normal">info</span><span class="symbol">-&gt;</span><span class="normal">d_pixels</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> dstskip </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_skip </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">	SDL_PixelFormat</span><span class="symbol">*</span><span class="normal"> sf </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">src</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">Uint32</span><span class="normal"> amask </span><span class="symbol">=</span><span class="normal"> sf</span><span class="symbol">-&gt;</span><span class="normal">Amask</span><span class="symbol">;</span>

<span class="normal">	</span><span class="function">__asm__</span><span class="normal"> </span><span class="symbol">(</span>
<span class="normal">	</span><span class="comment">/* make mm6 all zeros. */</span>
<span class="normal">	</span><span class="string">"pxor       %%mm6, %%mm6</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">	</span>
<span class="normal">	</span><span class="comment">/* Make a mask to preserve the alpha. */</span>
<span class="normal">	</span><span class="string">"movd      %0, %%mm7</span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal">           </span><span class="comment">/* 0000F000 -&gt; mm7 */</span>
<span class="normal">	</span><span class="string">"punpcklbw %%mm7, %%mm7</span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal">        </span><span class="comment">/* FF000000 -&gt; mm7 */</span>
<span class="normal">	</span><span class="string">"pcmpeqb   %%mm4, %%mm4</span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal">        </span><span class="comment">/* FFFFFFFF -&gt; mm4 */</span>
<span class="normal">	</span><span class="string">"movq      %%mm4, %%mm3</span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal">        </span><span class="comment">/* FFFFFFFF -&gt; mm3 (for later) */</span>
<span class="normal">	</span><span class="string">"pxor      %%mm4, %%mm7</span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal">        </span><span class="comment">/* 00FFFFFF -&gt; mm7 (mult mask) */</span>

<span class="normal">	</span><span class="comment">/* form channel masks */</span>
<span class="normal">	</span><span class="string">"movq      %%mm7, %%mm4</span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal">        </span><span class="comment">/* 00FFFFFF -&gt; mm4 */</span>
<span class="normal">	</span><span class="string">"packsswb  %%mm6, %%mm4</span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal">        </span><span class="comment">/* 00000FFF -&gt; mm4 (channel mask) */</span>
<span class="normal">	</span><span class="string">"packsswb  %%mm6, %%mm3</span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal">        </span><span class="comment">/* 0000FFFF -&gt; mm3 */</span>
<span class="normal">	</span><span class="string">"pxor      %%mm4, %%mm3</span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal">        </span><span class="comment">/* 0000F000 -&gt; mm3 (~channel mask) */</span>
<span class="normal">	</span>
<span class="normal">	</span><span class="comment">/* get alpha channel shift */</span>
<span class="normal">	</span><span class="string">"movd      %1, %%mm5</span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">/* Ashift -&gt; mm5 */</span>

<span class="normal">	  </span><span class="symbol">:</span><span class="normal"> </span><span class="comment">/* nothing */</span><span class="normal"> </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"m"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">sf</span><span class="symbol">-&gt;</span><span class="normal">Amask</span><span class="symbol">),</span><span class="normal"> </span><span class="string">"m"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">sf</span><span class="symbol">-&gt;</span><span class="normal">Ashift</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">while</span><span class="symbol">(</span><span class="normal">height</span><span class="symbol">--)</span><span class="normal"> </span><span class="cbracket">{</span>

<span class="normal">	    </span><span class="function">DUFFS_LOOP4</span><span class="symbol">(</span><span class="cbracket">{</span>
<span class="normal">		</span><span class="usertype">Uint32</span><span class="normal"> alpha</span><span class="symbol">;</span>

<span class="normal">		</span><span class="function">__asm__</span><span class="normal"> </span><span class="symbol">(</span>
<span class="normal">		</span><span class="string">"prefetch 64(%0)</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">		</span><span class="string">"prefetch 64(%1)</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">			</span><span class="symbol">:</span><span class="normal"> </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"r"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">srcp</span><span class="symbol">),</span><span class="normal"> </span><span class="string">"r"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dstp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">);</span>

<span class="normal">		alpha </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">srcp </span><span class="symbol">&amp;</span><span class="normal"> amask</span><span class="symbol">;</span>
<span class="normal">		</span><span class="comment">/* </span><span class="todo">FIXME:</span><span class="comment"> Here we special-case opaque alpha since the</span>
<span class="comment">		   compositioning used (&gt;&gt;8 instead of /255) doesn't handle</span>
<span class="comment">		   it correctly. Also special-case alpha=0 for speed?</span>
<span class="comment">		   Benchmark this! */</span>
<span class="normal">		</span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">alpha </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		    </span><span class="comment">/* do nothing */</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">alpha </span><span class="symbol">==</span><span class="normal"> amask</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="comment">/* opaque alpha -- copy RGB, keep dst alpha */</span>
<span class="normal">		    </span><span class="comment">/* using MMX here to free up regular registers for other things */</span>
<span class="normal">			    </span><span class="function">__asm__</span><span class="normal"> </span><span class="symbol">(</span>
<span class="normal">		    </span><span class="string">"movd      (%0),  %%mm0</span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">/* src(ARGB) -&gt; mm0 (0000ARGB)*/</span>
<span class="normal">		    </span><span class="string">"movd      (%1),  %%mm1</span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">/* dst(ARGB) -&gt; mm1 (0000ARGB)*/</span>
<span class="normal">		    </span><span class="string">"pand      %%mm4, %%mm0</span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">/* src &amp; chanmask -&gt; mm0 */</span>
<span class="normal">		    </span><span class="string">"pand      %%mm3, %%mm1</span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">/* dst &amp; ~chanmask -&gt; mm2 */</span>
<span class="normal">		    </span><span class="string">"por       %%mm0, %%mm1</span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">/* src | dst -&gt; mm1 */</span>
<span class="normal">		    </span><span class="string">"movd      %%mm1, (%1) </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">/* mm1 -&gt; dst */</span>

<span class="normal">		     </span><span class="symbol">:</span><span class="normal"> </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"r"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">srcp</span><span class="symbol">),</span><span class="normal"> </span><span class="string">"r"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dstp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">);</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span>

<span class="normal">		</span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			    </span><span class="function">__asm__</span><span class="normal"> </span><span class="symbol">(</span>
<span class="normal">		    </span><span class="comment">/* load in the source, and dst. */</span>
<span class="normal">		    </span><span class="string">"movd      (%0), %%mm0</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">		    </span><span class="comment">/* mm0(s) = 0 0 0 0 | As Rs Gs Bs */</span>
<span class="normal">		    </span><span class="string">"movd      (%1), %%mm1</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">		    </span><span class="comment">/* mm1(d) = 0 0 0 0 | Ad Rd Gd Bd */</span>

<span class="normal">		    </span><span class="comment">/* Move the src alpha into mm2 */</span>

<span class="normal">		    </span><span class="comment">/* if supporting pshufw */</span>
<span class="normal">		    </span><span class="comment">/*"pshufw     $0x55, %%mm0, %%mm2\n" */</span><span class="normal"> </span><span class="comment">/* mm2 = 0 As 0 As |  0 As  0  As */</span>
<span class="normal">		    </span><span class="comment">/*"psrlw     $8, %%mm2\n" */</span>
<span class="normal">		    </span>
<span class="normal">		    </span><span class="comment">/* else: */</span>
<span class="normal">		    </span><span class="string">"movd       %2,    %%mm2</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">		    </span><span class="string">"psrld      %%mm5, %%mm2</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">                </span><span class="comment">/* mm2 = 0 0 0 0 | 0  0  0  As */</span>
<span class="normal">		    </span><span class="string">"punpcklwd	%%mm2, %%mm2</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">	            </span><span class="comment">/* mm2 = 0 0 0 0 |  0 As  0  As */</span>
<span class="normal">		    </span><span class="string">"punpckldq	%%mm2, %%mm2</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">             </span><span class="comment">/* mm2 = 0 As 0 As |  0 As  0  As */</span>
<span class="normal">		    </span><span class="string">"pand       %%mm7, %%mm2</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">              </span><span class="comment">/* to preserve dest alpha */</span>

<span class="normal">		    </span><span class="comment">/* move the colors into words. */</span>
<span class="normal">		    </span><span class="string">"punpcklbw %%mm6, %%mm0</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">		    </span><span class="comment">/* mm0 = 0 As 0 Rs | 0 Gs 0 Bs */</span>
<span class="normal">		    </span><span class="string">"punpcklbw %%mm6, %%mm1</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">              </span><span class="comment">/* mm0 = 0 Ad 0 Rd | 0 Gd 0 Bd */</span>

<span class="normal">		    </span><span class="comment">/* src - dst */</span>
<span class="normal">		    </span><span class="string">"psubw    %%mm1, %%mm0</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">		    </span><span class="comment">/* mm0 = As-Ad Rs-Rd | Gs-Gd  Bs-Bd */</span>

<span class="normal">		    </span><span class="comment">/* A * (src-dst) */</span>
<span class="normal">		    </span><span class="string">"pmullw    %%mm2, %%mm0</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">		    </span><span class="comment">/* mm0 = 0*As-d As*Rs-d | As*Gs-d  As*Bs-d */</span>
<span class="normal">		    </span><span class="string">"psrlw     $8,    %%mm0</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">		    </span><span class="comment">/* mm0 = 0&gt;&gt;8 Rc&gt;&gt;8 | Gc&gt;&gt;8  Bc&gt;&gt;8 */</span>
<span class="normal">		    </span><span class="string">"paddb     %%mm1, %%mm0</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">		    </span><span class="comment">/* mm0 = 0+Ad Rc+Rd | Gc+Gd  Bc+Bd */</span>

<span class="normal">		    </span><span class="string">"packuswb  %%mm0, %%mm0</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">              </span><span class="comment">/* mm0 =             | Ac Rc Gc Bc */</span>
<span class="normal">		    </span>
<span class="normal">		    </span><span class="string">"movd      %%mm0, (%1)</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">               </span><span class="comment">/* result in mm0 */</span>

<span class="normal">		     </span><span class="symbol">:</span><span class="normal"> </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"r"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">srcp</span><span class="symbol">),</span><span class="normal"> </span><span class="string">"r"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dstp</span><span class="symbol">),</span><span class="normal"> </span><span class="string">"r"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">alpha</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">);</span>

<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="symbol">++</span><span class="normal">srcp</span><span class="symbol">;</span>
<span class="normal">		</span><span class="symbol">++</span><span class="normal">dstp</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="cbracket">}</span><span class="symbol">,</span><span class="normal"> width</span><span class="symbol">);</span>
<span class="normal">	    srcp </span><span class="symbol">+=</span><span class="normal"> srcskip</span><span class="symbol">;</span>
<span class="normal">	    dstp </span><span class="symbol">+=</span><span class="normal"> dstskip</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="function">__asm__</span><span class="normal"> </span><span class="symbol">(</span>
<span class="normal">	</span><span class="string">"emms</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">		</span><span class="symbol">:</span><span class="normal">   </span><span class="symbol">);</span>
<span class="cbracket">}</span>
<span class="comment">/* End GCC_ASMBLIT*/</span>

<span class="preproc">#elif</span><span class="normal"> MSVC_ASMBLIT</span>
<span class="comment">/* fast (as in MMX with prefetch) ARGB888-&gt;(A)RGB888 blending with pixel alpha */</span>
<span class="keyword">static</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="function">BlitRGBtoRGBPixelAlphaMMX3DNOW</span><span class="symbol">(</span><span class="usertype">SDL_BlitInfo</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">info</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> width </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_width</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> height </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_height</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">Uint32</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">srcp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint32 </span><span class="symbol">*)</span><span class="normal">info</span><span class="symbol">-&gt;</span><span class="normal">s_pixels</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> srcskip </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">s_skip </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">Uint32</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dstp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint32 </span><span class="symbol">*)</span><span class="normal">info</span><span class="symbol">-&gt;</span><span class="normal">d_pixels</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> dstskip </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_skip </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">	SDL_PixelFormat</span><span class="symbol">*</span><span class="normal"> sf </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">src</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">Uint32</span><span class="normal"> chanmask </span><span class="symbol">=</span><span class="normal"> sf</span><span class="symbol">-&gt;</span><span class="normal">Rmask </span><span class="symbol">|</span><span class="normal"> sf</span><span class="symbol">-&gt;</span><span class="normal">Gmask </span><span class="symbol">|</span><span class="normal"> sf</span><span class="symbol">-&gt;</span><span class="normal">Bmask</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">Uint32</span><span class="normal"> amask </span><span class="symbol">=</span><span class="normal"> sf</span><span class="symbol">-&gt;</span><span class="normal">Amask</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">Uint32</span><span class="normal"> ashift </span><span class="symbol">=</span><span class="normal"> sf</span><span class="symbol">-&gt;</span><span class="normal">Ashift</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">Uint64</span><span class="normal"> multmask</span><span class="symbol">;</span>
<span class="normal">	</span>
<span class="normal">	</span><span class="usertype">__m64</span><span class="normal"> src1</span><span class="symbol">,</span><span class="normal"> dst1</span><span class="symbol">,</span><span class="normal"> mm_alpha</span><span class="symbol">,</span><span class="normal"> mm_zero</span><span class="symbol">,</span><span class="normal"> dmask</span><span class="symbol">;</span>

<span class="normal">	mm_zero </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_setzero_si64</span><span class="symbol">();</span><span class="normal"> </span><span class="comment">/* 0 -&gt; mm_zero */</span>
<span class="normal">	multmask </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">~(</span><span class="normal">0xFFFFi64 </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ashift </span><span class="symbol">*</span><span class="normal"> </span><span class="number">2</span><span class="symbol">));</span>
<span class="normal">	dmask </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">__m64</span><span class="symbol">*)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">multmask</span><span class="symbol">;</span><span class="normal"> </span><span class="comment">/* dst alpha mask -&gt; dmask */</span>

<span class="normal">	</span><span class="keyword">while</span><span class="symbol">(</span><span class="normal">height</span><span class="symbol">--)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="function">DUFFS_LOOP4</span><span class="symbol">(</span><span class="cbracket">{</span>
<span class="normal">		</span><span class="usertype">Uint32</span><span class="normal"> alpha</span><span class="symbol">;</span>

<span class="normal">		</span><span class="function">_m_prefetch</span><span class="symbol">(</span><span class="normal">srcp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">16</span><span class="symbol">);</span>
<span class="normal">		</span><span class="function">_m_prefetch</span><span class="symbol">(</span><span class="normal">dstp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">16</span><span class="symbol">);</span>

<span class="normal">		alpha </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">srcp </span><span class="symbol">&amp;</span><span class="normal"> amask</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">alpha </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="comment">/* do nothing */</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">alpha </span><span class="symbol">==</span><span class="normal"> amask</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="comment">/* copy RGB, keep dst alpha */</span>
<span class="normal">			</span><span class="symbol">*</span><span class="normal">dstp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(*</span><span class="normal">srcp </span><span class="symbol">&amp;</span><span class="normal"> chanmask</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">|</span><span class="normal"> </span><span class="symbol">(*</span><span class="normal">dstp </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="symbol">~</span><span class="normal">chanmask</span><span class="symbol">);</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			src1 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_cvtsi32_si64</span><span class="symbol">(*</span><span class="normal">srcp</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* src(ARGB) -&gt; src1 (0000ARGB)*/</span>
<span class="normal">			src1 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_unpacklo_pi8</span><span class="symbol">(</span><span class="normal">src1</span><span class="symbol">,</span><span class="normal"> mm_zero</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* 0A0R0G0B -&gt; src1 */</span>

<span class="normal">			dst1 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_cvtsi32_si64</span><span class="symbol">(*</span><span class="normal">dstp</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* dst(ARGB) -&gt; dst1 (0000ARGB)*/</span>
<span class="normal">			dst1 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_unpacklo_pi8</span><span class="symbol">(</span><span class="normal">dst1</span><span class="symbol">,</span><span class="normal"> mm_zero</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* 0A0R0G0B -&gt; dst1 */</span>

<span class="normal">			mm_alpha </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_cvtsi32_si64</span><span class="symbol">(</span><span class="normal">alpha</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* alpha -&gt; mm_alpha (0000000A) */</span>
<span class="normal">			mm_alpha </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_srli_si64</span><span class="symbol">(</span><span class="normal">mm_alpha</span><span class="symbol">,</span><span class="normal"> ashift</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* mm_alpha &gt;&gt; ashift -&gt; mm_alpha(0000000A) */</span>
<span class="normal">			mm_alpha </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_unpacklo_pi16</span><span class="symbol">(</span><span class="normal">mm_alpha</span><span class="symbol">,</span><span class="normal"> mm_alpha</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* 00000A0A -&gt; mm_alpha */</span>
<span class="normal">			mm_alpha </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_unpacklo_pi32</span><span class="symbol">(</span><span class="normal">mm_alpha</span><span class="symbol">,</span><span class="normal"> mm_alpha</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* 0A0A0A0A -&gt; mm_alpha */</span>
<span class="normal">			mm_alpha </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_and_si64</span><span class="symbol">(</span><span class="normal">mm_alpha</span><span class="symbol">,</span><span class="normal"> dmask</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* 000A0A0A -&gt; mm_alpha, preserve dst alpha on add */</span>

<span class="normal">			</span><span class="comment">/* blend */</span><span class="normal">		    </span>
<span class="normal">			src1 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_sub_pi16</span><span class="symbol">(</span><span class="normal">src1</span><span class="symbol">,</span><span class="normal"> dst1</span><span class="symbol">);</span><span class="comment">/* src - dst -&gt; src1 */</span>
<span class="normal">			src1 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_mullo_pi16</span><span class="symbol">(</span><span class="normal">src1</span><span class="symbol">,</span><span class="normal"> mm_alpha</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* (src - dst) * alpha -&gt; src1 */</span>
<span class="normal">			src1 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_srli_pi16</span><span class="symbol">(</span><span class="normal">src1</span><span class="symbol">,</span><span class="normal"> </span><span class="number">8</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* src1 &gt;&gt; 8 -&gt; src1(000R0G0B) */</span>
<span class="normal">			dst1 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_add_pi8</span><span class="symbol">(</span><span class="normal">src1</span><span class="symbol">,</span><span class="normal"> dst1</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* src1 + dst1(dst) -&gt; dst1(0A0R0G0B) */</span>
<span class="normal">			dst1 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_packs_pu16</span><span class="symbol">(</span><span class="normal">dst1</span><span class="symbol">,</span><span class="normal"> mm_zero</span><span class="symbol">);</span><span class="normal">  </span><span class="comment">/* 0000ARGB -&gt; dst1 */</span>
<span class="normal">			</span>
<span class="normal">			</span><span class="symbol">*</span><span class="normal">dstp </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_cvtsi64_si32</span><span class="symbol">(</span><span class="normal">dst1</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* dst1 -&gt; pixel */</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="symbol">++</span><span class="normal">srcp</span><span class="symbol">;</span>
<span class="normal">		</span><span class="symbol">++</span><span class="normal">dstp</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="cbracket">}</span><span class="symbol">,</span><span class="normal"> width</span><span class="symbol">);</span>
<span class="normal">	    srcp </span><span class="symbol">+=</span><span class="normal"> srcskip</span><span class="symbol">;</span>
<span class="normal">	    dstp </span><span class="symbol">+=</span><span class="normal"> dstskip</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="function">_mm_empty</span><span class="symbol">();</span>
<span class="cbracket">}</span>
<span class="comment">/* End MSVC_ASMBLIT */</span>

<span class="preproc">#endif</span><span class="normal"> </span><span class="comment">/* GCC_ASMBLIT, MSVC_ASMBLIT */</span>

<span class="comment">/* 16bpp special case for per-surface alpha=50%: blend 2 pixels in parallel */</span>

<span class="comment">/* blend a single 16 bit pixel at 50% */</span>
<span class="preproc">#define</span><span class="normal"> </span><span class="function">BLEND16_50</span><span class="symbol">(</span><span class="normal">d</span><span class="symbol">,</span><span class="normal"> s</span><span class="symbol">,</span><span class="normal"> mask</span><span class="symbol">)</span><span class="normal">						</span><span class="symbol">\</span>
<span class="normal">	</span><span class="symbol">((((</span><span class="normal">s </span><span class="symbol">&amp;</span><span class="normal"> mask</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">d </span><span class="symbol">&amp;</span><span class="normal"> mask</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">s </span><span class="symbol">&amp;</span><span class="normal"> d </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="symbol">(~</span><span class="normal">mask </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xffff</span><span class="symbol">)))</span>

<span class="comment">/* blend two 16 bit pixels at 50% */</span>
<span class="preproc">#define</span><span class="normal"> </span><span class="function">BLEND2x16_50</span><span class="symbol">(</span><span class="normal">d</span><span class="symbol">,</span><span class="normal"> s</span><span class="symbol">,</span><span class="normal"> mask</span><span class="symbol">)</span><span class="normal">					     </span><span class="symbol">\</span>
<span class="normal">	</span><span class="symbol">(((</span><span class="normal">s </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">mask </span><span class="symbol">|</span><span class="normal"> mask </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">16</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">d </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">mask </span><span class="symbol">|</span><span class="normal"> mask </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">16</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">	 </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">s </span><span class="symbol">&amp;</span><span class="normal"> d </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="symbol">(~(</span><span class="normal">mask </span><span class="symbol">|</span><span class="normal"> mask </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">16</span><span class="symbol">))))</span>

<span class="keyword">static</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="function">Blit16to16SurfaceAlpha128</span><span class="symbol">(</span><span class="usertype">SDL_BlitInfo</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">info</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">Uint16</span><span class="normal"> mask</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> width </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_width</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> height </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_height</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">Uint16</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">srcp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint16 </span><span class="symbol">*)</span><span class="normal">info</span><span class="symbol">-&gt;</span><span class="normal">s_pixels</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> srcskip </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">s_skip </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">Uint16</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dstp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint16 </span><span class="symbol">*)</span><span class="normal">info</span><span class="symbol">-&gt;</span><span class="normal">d_pixels</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> dstskip </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_skip </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">while</span><span class="symbol">(</span><span class="normal">height</span><span class="symbol">--)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">if</span><span class="symbol">(((</span><span class="normal">uintptr_t</span><span class="symbol">)</span><span class="normal">srcp </span><span class="symbol">^</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">uintptr_t</span><span class="symbol">)</span><span class="normal">dstp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="comment">/*</span>
<span class="comment">			 * Source and destination not aligned, pipeline it.</span>
<span class="comment">			 * This is mostly a win for big blits but no loss for</span>
<span class="comment">			 * small ones</span>
<span class="comment">			 */</span>
<span class="normal">			</span><span class="usertype">Uint32</span><span class="normal"> prev_sw</span><span class="symbol">;</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> w </span><span class="symbol">=</span><span class="normal"> width</span><span class="symbol">;</span>

<span class="normal">			</span><span class="comment">/* handle odd destination */</span>
<span class="normal">			</span><span class="keyword">if</span><span class="symbol">((</span><span class="normal">uintptr_t</span><span class="symbol">)</span><span class="normal">dstp </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="usertype">Uint16</span><span class="normal"> d </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dstp</span><span class="symbol">,</span><span class="normal"> s </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">srcp</span><span class="symbol">;</span>
<span class="normal">				</span><span class="symbol">*</span><span class="normal">dstp </span><span class="symbol">=</span><span class="normal"> </span><span class="function">BLEND16_50</span><span class="symbol">(</span><span class="normal">d</span><span class="symbol">,</span><span class="normal"> s</span><span class="symbol">,</span><span class="normal"> mask</span><span class="symbol">);</span>
<span class="normal">				dstp</span><span class="symbol">++;</span>
<span class="normal">				srcp</span><span class="symbol">++;</span>
<span class="normal">				w</span><span class="symbol">--;</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">			srcp</span><span class="symbol">++;</span><span class="normal">	</span><span class="comment">/* srcp is now 32-bit aligned */</span>

<span class="normal">			</span><span class="comment">/* bootstrap pipeline with first halfword */</span>
<span class="normal">			prev_sw </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">Uint32 </span><span class="symbol">*)</span><span class="normal">srcp</span><span class="symbol">)[-</span><span class="number">1</span><span class="symbol">];</span>

<span class="normal">			</span><span class="keyword">while</span><span class="symbol">(</span><span class="normal">w </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="usertype">Uint32</span><span class="normal"> sw</span><span class="symbol">,</span><span class="normal"> dw</span><span class="symbol">,</span><span class="normal"> s</span><span class="symbol">;</span>
<span class="normal">				sw </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">Uint32 </span><span class="symbol">*)</span><span class="normal">srcp</span><span class="symbol">;</span>
<span class="normal">				dw </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">Uint32 </span><span class="symbol">*)</span><span class="normal">dstp</span><span class="symbol">;</span>
<span class="preproc">#if</span><span class="normal"> SDL_BYTEORDER </span><span class="symbol">==</span><span class="normal"> SDL_BIG_ENDIAN</span>
<span class="normal">				s </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">prev_sw </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">16</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">sw </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">16</span><span class="symbol">);</span>
<span class="preproc">#else</span>
<span class="normal">				s </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">prev_sw </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">16</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">sw </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">16</span><span class="symbol">);</span>
<span class="preproc">#endif</span>
<span class="normal">				prev_sw </span><span class="symbol">=</span><span class="normal"> sw</span><span class="symbol">;</span>
<span class="normal">				</span><span class="symbol">*(</span><span class="normal">Uint32 </span><span class="symbol">*)</span><span class="normal">dstp </span><span class="symbol">=</span><span class="normal"> </span><span class="function">BLEND2x16_50</span><span class="symbol">(</span><span class="normal">dw</span><span class="symbol">,</span><span class="normal"> s</span><span class="symbol">,</span><span class="normal"> mask</span><span class="symbol">);</span>
<span class="normal">				dstp </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">				srcp </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">				w </span><span class="symbol">-=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">			</span><span class="cbracket">}</span>

<span class="normal">			</span><span class="comment">/* final pixel if any */</span>
<span class="normal">			</span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">w</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="usertype">Uint16</span><span class="normal"> d </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dstp</span><span class="symbol">,</span><span class="normal"> s</span><span class="symbol">;</span>
<span class="preproc">#if</span><span class="normal"> SDL_BYTEORDER </span><span class="symbol">==</span><span class="normal"> SDL_BIG_ENDIAN</span>
<span class="normal">				s </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint16</span><span class="symbol">)</span><span class="normal">prev_sw</span><span class="symbol">;</span>
<span class="preproc">#else</span>
<span class="normal">				s </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint16</span><span class="symbol">)(</span><span class="normal">prev_sw </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">16</span><span class="symbol">);</span>
<span class="preproc">#endif</span>
<span class="normal">				</span><span class="symbol">*</span><span class="normal">dstp </span><span class="symbol">=</span><span class="normal"> </span><span class="function">BLEND16_50</span><span class="symbol">(</span><span class="normal">d</span><span class="symbol">,</span><span class="normal"> s</span><span class="symbol">,</span><span class="normal"> mask</span><span class="symbol">);</span>
<span class="normal">				srcp</span><span class="symbol">++;</span>
<span class="normal">				dstp</span><span class="symbol">++;</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">			srcp </span><span class="symbol">+=</span><span class="normal"> srcskip </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">			dstp </span><span class="symbol">+=</span><span class="normal"> dstskip</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="comment">/* source and destination are aligned */</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> w </span><span class="symbol">=</span><span class="normal"> width</span><span class="symbol">;</span>

<span class="normal">			</span><span class="comment">/* first odd pixel? */</span>
<span class="normal">			</span><span class="keyword">if</span><span class="symbol">((</span><span class="normal">uintptr_t</span><span class="symbol">)</span><span class="normal">srcp </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="usertype">Uint16</span><span class="normal"> d </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dstp</span><span class="symbol">,</span><span class="normal"> s </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">srcp</span><span class="symbol">;</span>
<span class="normal">				</span><span class="symbol">*</span><span class="normal">dstp </span><span class="symbol">=</span><span class="normal"> </span><span class="function">BLEND16_50</span><span class="symbol">(</span><span class="normal">d</span><span class="symbol">,</span><span class="normal"> s</span><span class="symbol">,</span><span class="normal"> mask</span><span class="symbol">);</span>
<span class="normal">				srcp</span><span class="symbol">++;</span>
<span class="normal">				dstp</span><span class="symbol">++;</span>
<span class="normal">				w</span><span class="symbol">--;</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">			</span><span class="comment">/* srcp and dstp are now 32-bit aligned */</span>

<span class="normal">			</span><span class="keyword">while</span><span class="symbol">(</span><span class="normal">w </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="usertype">Uint32</span><span class="normal"> sw </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">Uint32 </span><span class="symbol">*)</span><span class="normal">srcp</span><span class="symbol">;</span>
<span class="normal">				</span><span class="usertype">Uint32</span><span class="normal"> dw </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">Uint32 </span><span class="symbol">*)</span><span class="normal">dstp</span><span class="symbol">;</span>
<span class="normal">				</span><span class="symbol">*(</span><span class="normal">Uint32 </span><span class="symbol">*)</span><span class="normal">dstp </span><span class="symbol">=</span><span class="normal"> </span><span class="function">BLEND2x16_50</span><span class="symbol">(</span><span class="normal">dw</span><span class="symbol">,</span><span class="normal"> sw</span><span class="symbol">,</span><span class="normal"> mask</span><span class="symbol">);</span>
<span class="normal">				srcp </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">				dstp </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">				w </span><span class="symbol">-=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">			</span><span class="cbracket">}</span>

<span class="normal">			</span><span class="comment">/* last odd pixel? */</span>
<span class="normal">			</span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">w</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="usertype">Uint16</span><span class="normal"> d </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dstp</span><span class="symbol">,</span><span class="normal"> s </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">srcp</span><span class="symbol">;</span>
<span class="normal">				</span><span class="symbol">*</span><span class="normal">dstp </span><span class="symbol">=</span><span class="normal"> </span><span class="function">BLEND16_50</span><span class="symbol">(</span><span class="normal">d</span><span class="symbol">,</span><span class="normal"> s</span><span class="symbol">,</span><span class="normal"> mask</span><span class="symbol">);</span>
<span class="normal">				srcp</span><span class="symbol">++;</span>
<span class="normal">				dstp</span><span class="symbol">++;</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">			srcp </span><span class="symbol">+=</span><span class="normal"> srcskip</span><span class="symbol">;</span>
<span class="normal">			dstp </span><span class="symbol">+=</span><span class="normal"> dstskip</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="preproc">#if</span><span class="normal"> GCC_ASMBLIT</span>
<span class="comment">/* fast RGB565-&gt;RGB565 blending with surface alpha */</span>
<span class="keyword">static</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="function">Blit565to565SurfaceAlphaMMX</span><span class="symbol">(</span><span class="usertype">SDL_BlitInfo</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">info</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">	</span><span class="type">unsigned</span><span class="normal"> alpha </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">src</span><span class="symbol">-&gt;</span><span class="normal">alpha</span><span class="symbol">;</span><span class="normal"> </span><span class="comment">/* downscale alpha to 5 bits */</span>
<span class="normal">	</span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">alpha </span><span class="symbol">==</span><span class="normal"> </span><span class="number">128</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">Blit16to16SurfaceAlpha128</span><span class="symbol">(</span><span class="normal">info</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0xf7de</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> width </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_width</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> height </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_height</span><span class="symbol">;</span>
<span class="normal">		</span><span class="usertype">Uint16</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">srcp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint16 </span><span class="symbol">*)</span><span class="normal">info</span><span class="symbol">-&gt;</span><span class="normal">s_pixels</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> srcskip </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">s_skip </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">		</span><span class="usertype">Uint16</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dstp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint16 </span><span class="symbol">*)</span><span class="normal">info</span><span class="symbol">-&gt;</span><span class="normal">d_pixels</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> dstskip </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_skip </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">		</span><span class="usertype">Uint32</span><span class="normal"> s</span><span class="symbol">,</span><span class="normal"> d</span><span class="symbol">;</span>
<span class="normal">		</span><span class="usertype">Uint8</span><span class="normal"> load</span><span class="symbol">[</span><span class="number">8</span><span class="symbol">];</span>
<span class="normal">	  </span>
<span class="normal">		alpha </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="symbol">~(</span><span class="number">1</span><span class="symbol">+</span><span class="number">2</span><span class="symbol">+</span><span class="number">4</span><span class="symbol">);</span><span class="normal">		</span><span class="comment">/* cut alpha to get the exact same behaviour */</span>
<span class="normal">		</span><span class="symbol">*(</span><span class="normal">Uint64 </span><span class="symbol">*)</span><span class="normal">load </span><span class="symbol">=</span><span class="normal"> alpha</span><span class="symbol">;</span>
<span class="normal">		alpha </span><span class="symbol">&gt;&gt;=</span><span class="normal"> </span><span class="number">3</span><span class="symbol">;</span><span class="normal">		</span><span class="comment">/* downscale alpha to 5 bits */</span>

<span class="normal">		</span><span class="function">movq_m2r</span><span class="symbol">(*</span><span class="normal">load</span><span class="symbol">,</span><span class="normal"> mm0</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* alpha(0000000A) -&gt; mm0 */</span>
<span class="normal">		</span><span class="function">punpcklwd_r2r</span><span class="symbol">(</span><span class="normal">mm0</span><span class="symbol">,</span><span class="normal"> mm0</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* 00000A0A -&gt; mm0 */</span>
<span class="normal">		</span><span class="function">punpcklwd_r2r</span><span class="symbol">(</span><span class="normal">mm0</span><span class="symbol">,</span><span class="normal"> mm0</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* 0A0A0A0A -&gt; mm0 */</span>
<span class="normal">		</span><span class="comment">/* position alpha to allow for mullo and mulhi on diff channels</span>
<span class="comment">		   to reduce the number of operations */</span>
<span class="normal">		</span><span class="function">psllq_i2r</span><span class="symbol">(</span><span class="number">3</span><span class="symbol">,</span><span class="normal"> mm0</span><span class="symbol">);</span>
<span class="normal">	  </span>
<span class="normal">		</span><span class="comment">/* Setup the 565 color channel masks */</span>
<span class="normal">		</span><span class="symbol">*(</span><span class="normal">Uint64 </span><span class="symbol">*)</span><span class="normal">load </span><span class="symbol">=</span><span class="normal"> 0x07E007E007E007E0ULL</span><span class="symbol">;</span>
<span class="normal">		</span><span class="function">movq_m2r</span><span class="symbol">(*</span><span class="normal">load</span><span class="symbol">,</span><span class="normal"> mm4</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* MASKGREEN -&gt; mm4 */</span>
<span class="normal">		</span><span class="symbol">*(</span><span class="normal">Uint64 </span><span class="symbol">*)</span><span class="normal">load </span><span class="symbol">=</span><span class="normal"> 0x001F001F001F001FULL</span><span class="symbol">;</span>
<span class="normal">		</span><span class="function">movq_m2r</span><span class="symbol">(*</span><span class="normal">load</span><span class="symbol">,</span><span class="normal"> mm7</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* MASKBLUE -&gt; mm7 */</span>
<span class="normal">		</span><span class="keyword">while</span><span class="symbol">(</span><span class="normal">height</span><span class="symbol">--)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="function">DUFFS_LOOP_QUATRO2</span><span class="symbol">(</span>
<span class="normal">			</span><span class="cbracket">{</span>
<span class="normal">				s </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">srcp</span><span class="symbol">++;</span>
<span class="normal">				d </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dstp</span><span class="symbol">;</span>
<span class="normal">				</span><span class="comment">/*</span>
<span class="comment">				 * shift out the middle component (green) to</span>
<span class="comment">				 * the high 16 bits, and process all three RGB</span>
<span class="comment">				 * components at the same time.</span>
<span class="comment">				 */</span>
<span class="normal">				s </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">s </span><span class="symbol">|</span><span class="normal"> s </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">16</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x07e0f81f</span><span class="symbol">;</span>
<span class="normal">				d </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">d </span><span class="symbol">|</span><span class="normal"> d </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">16</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x07e0f81f</span><span class="symbol">;</span>
<span class="normal">				d </span><span class="symbol">+=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">s </span><span class="symbol">-</span><span class="normal"> d</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> alpha </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">5</span><span class="symbol">;</span>
<span class="normal">				d </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="number">0x07e0f81f</span><span class="symbol">;</span>
<span class="normal">				</span><span class="symbol">*</span><span class="normal">dstp</span><span class="symbol">++</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> d </span><span class="symbol">|</span><span class="normal"> d </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">16</span><span class="symbol">;</span>
<span class="normal">			</span><span class="cbracket">}</span><span class="symbol">,</span><span class="cbracket">{</span>
<span class="normal">				s </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">srcp</span><span class="symbol">++;</span>
<span class="normal">				d </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dstp</span><span class="symbol">;</span>
<span class="normal">				</span><span class="comment">/*</span>
<span class="comment">				 * shift out the middle component (green) to</span>
<span class="comment">				 * the high 16 bits, and process all three RGB</span>
<span class="comment">				 * components at the same time.</span>
<span class="comment">				 */</span>
<span class="normal">				s </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">s </span><span class="symbol">|</span><span class="normal"> s </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">16</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x07e0f81f</span><span class="symbol">;</span>
<span class="normal">				d </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">d </span><span class="symbol">|</span><span class="normal"> d </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">16</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x07e0f81f</span><span class="symbol">;</span>
<span class="normal">				d </span><span class="symbol">+=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">s </span><span class="symbol">-</span><span class="normal"> d</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> alpha </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">5</span><span class="symbol">;</span>
<span class="normal">				d </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="number">0x07e0f81f</span><span class="symbol">;</span>
<span class="normal">				</span><span class="symbol">*</span><span class="normal">dstp</span><span class="symbol">++</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> d </span><span class="symbol">|</span><span class="normal"> d </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">16</span><span class="symbol">;</span>
<span class="normal">				s </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">srcp</span><span class="symbol">++;</span>
<span class="normal">				d </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dstp</span><span class="symbol">;</span>
<span class="normal">				</span><span class="comment">/*</span>
<span class="comment">				 * shift out the middle component (green) to</span>
<span class="comment">				 * the high 16 bits, and process all three RGB</span>
<span class="comment">				 * components at the same time.</span>
<span class="comment">				 */</span>
<span class="normal">				s </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">s </span><span class="symbol">|</span><span class="normal"> s </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">16</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x07e0f81f</span><span class="symbol">;</span>
<span class="normal">				d </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">d </span><span class="symbol">|</span><span class="normal"> d </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">16</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x07e0f81f</span><span class="symbol">;</span>
<span class="normal">				d </span><span class="symbol">+=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">s </span><span class="symbol">-</span><span class="normal"> d</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> alpha </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">5</span><span class="symbol">;</span>
<span class="normal">				d </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="number">0x07e0f81f</span><span class="symbol">;</span>
<span class="normal">				</span><span class="symbol">*</span><span class="normal">dstp</span><span class="symbol">++</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> d </span><span class="symbol">|</span><span class="normal"> d </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">16</span><span class="symbol">;</span>
<span class="normal">			</span><span class="cbracket">}</span><span class="symbol">,</span><span class="cbracket">{</span>
<span class="normal">				</span><span class="function">movq_m2r</span><span class="symbol">((*</span><span class="normal">srcp</span><span class="symbol">),</span><span class="normal"> mm2</span><span class="symbol">);</span><span class="comment">/* 4 src pixels -&gt; mm2 */</span>
<span class="normal">				</span><span class="function">movq_m2r</span><span class="symbol">((*</span><span class="normal">dstp</span><span class="symbol">),</span><span class="normal"> mm3</span><span class="symbol">);</span><span class="comment">/* 4 dst pixels -&gt; mm3 */</span>

<span class="normal">				</span><span class="comment">/* red -- does not need a mask since the right shift clears</span>
<span class="comment">				   the uninteresting bits */</span>
<span class="normal">				</span><span class="function">movq_r2r</span><span class="symbol">(</span><span class="normal">mm2</span><span class="symbol">,</span><span class="normal"> mm5</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* src -&gt; mm5 */</span>
<span class="normal">				</span><span class="function">movq_r2r</span><span class="symbol">(</span><span class="normal">mm3</span><span class="symbol">,</span><span class="normal"> mm6</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* dst -&gt; mm6 */</span>
<span class="normal">				</span><span class="function">psrlw_i2r</span><span class="symbol">(</span><span class="number">11</span><span class="symbol">,</span><span class="normal"> mm5</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* mm5 &gt;&gt; 11 -&gt; mm5 [000r 000r 000r 000r] */</span>
<span class="normal">				</span><span class="function">psrlw_i2r</span><span class="symbol">(</span><span class="number">11</span><span class="symbol">,</span><span class="normal"> mm6</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* mm6 &gt;&gt; 11 -&gt; mm6 [000r 000r 000r 000r] */</span>

<span class="normal">				</span><span class="comment">/* blend */</span>
<span class="normal">				</span><span class="function">psubw_r2r</span><span class="symbol">(</span><span class="normal">mm6</span><span class="symbol">,</span><span class="normal"> mm5</span><span class="symbol">);</span><span class="comment">/* src - dst -&gt; mm5 */</span>
<span class="normal">				</span><span class="function">pmullw_r2r</span><span class="symbol">(</span><span class="normal">mm0</span><span class="symbol">,</span><span class="normal"> mm5</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* mm5 * alpha -&gt; mm5 */</span>
<span class="normal">				</span><span class="comment">/* alpha used is actually 11 bits</span>
<span class="comment">				   11 + 5 = 16 bits, so the sign bits are lost */</span>
<span class="normal">				</span><span class="function">psrlw_i2r</span><span class="symbol">(</span><span class="number">11</span><span class="symbol">,</span><span class="normal"> mm5</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* mm5 &gt;&gt; 11 -&gt; mm5 */</span>
<span class="normal">				</span><span class="function">paddw_r2r</span><span class="symbol">(</span><span class="normal">mm5</span><span class="symbol">,</span><span class="normal"> mm6</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* mm5 + mm6(dst) -&gt; mm6 */</span>
<span class="normal">				</span><span class="function">psllw_i2r</span><span class="symbol">(</span><span class="number">11</span><span class="symbol">,</span><span class="normal"> mm6</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* mm6 &lt;&lt; 11 -&gt; mm6 */</span>

<span class="normal">				</span><span class="function">movq_r2r</span><span class="symbol">(</span><span class="normal">mm6</span><span class="symbol">,</span><span class="normal"> mm1</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* save new reds in dsts */</span>

<span class="normal">				</span><span class="comment">/* green -- process the bits in place */</span>
<span class="normal">				</span><span class="function">movq_r2r</span><span class="symbol">(</span><span class="normal">mm2</span><span class="symbol">,</span><span class="normal"> mm5</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* src -&gt; mm5 */</span>
<span class="normal">				</span><span class="function">movq_r2r</span><span class="symbol">(</span><span class="normal">mm3</span><span class="symbol">,</span><span class="normal"> mm6</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* dst -&gt; mm6 */</span>
<span class="normal">				</span><span class="function">pand_r2r</span><span class="symbol">(</span><span class="normal">mm4</span><span class="symbol">,</span><span class="normal"> mm5</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* src &amp; MASKGREEN -&gt; mm5 */</span>
<span class="normal">				</span><span class="function">pand_r2r</span><span class="symbol">(</span><span class="normal">mm4</span><span class="symbol">,</span><span class="normal"> mm6</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* dst &amp; MASKGREEN -&gt; mm6 */</span>

<span class="normal">				</span><span class="comment">/* blend */</span>
<span class="normal">				</span><span class="function">psubw_r2r</span><span class="symbol">(</span><span class="normal">mm6</span><span class="symbol">,</span><span class="normal"> mm5</span><span class="symbol">);</span><span class="comment">/* src - dst -&gt; mm5 */</span>
<span class="normal">				</span><span class="function">pmulhw_r2r</span><span class="symbol">(</span><span class="normal">mm0</span><span class="symbol">,</span><span class="normal"> mm5</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* mm5 * alpha -&gt; mm5 */</span>
<span class="normal">				</span><span class="comment">/* 11 + 11 - 16 = 6 bits, so all the lower uninteresting</span>
<span class="comment">				   bits are gone and the sign bits present */</span>
<span class="normal">				</span><span class="function">psllw_i2r</span><span class="symbol">(</span><span class="number">5</span><span class="symbol">,</span><span class="normal"> mm5</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* mm5 &lt;&lt; 5 -&gt; mm5 */</span>
<span class="normal">				</span><span class="function">paddw_r2r</span><span class="symbol">(</span><span class="normal">mm5</span><span class="symbol">,</span><span class="normal"> mm6</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* mm5 + mm6(dst) -&gt; mm6 */</span>

<span class="normal">				</span><span class="function">por_r2r</span><span class="symbol">(</span><span class="normal">mm6</span><span class="symbol">,</span><span class="normal"> mm1</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* save new greens in dsts */</span>

<span class="normal">				</span><span class="comment">/* blue */</span>
<span class="normal">				</span><span class="function">movq_r2r</span><span class="symbol">(</span><span class="normal">mm2</span><span class="symbol">,</span><span class="normal"> mm5</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* src -&gt; mm5 */</span>
<span class="normal">				</span><span class="function">movq_r2r</span><span class="symbol">(</span><span class="normal">mm3</span><span class="symbol">,</span><span class="normal"> mm6</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* dst -&gt; mm6 */</span>
<span class="normal">				</span><span class="function">pand_r2r</span><span class="symbol">(</span><span class="normal">mm7</span><span class="symbol">,</span><span class="normal"> mm5</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* src &amp; MASKBLUE -&gt; mm5[000b 000b 000b 000b] */</span>
<span class="normal">				</span><span class="function">pand_r2r</span><span class="symbol">(</span><span class="normal">mm7</span><span class="symbol">,</span><span class="normal"> mm6</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* dst &amp; MASKBLUE -&gt; mm6[000b 000b 000b 000b] */</span>

<span class="normal">				</span><span class="comment">/* blend */</span>
<span class="normal">				</span><span class="function">psubw_r2r</span><span class="symbol">(</span><span class="normal">mm6</span><span class="symbol">,</span><span class="normal"> mm5</span><span class="symbol">);</span><span class="comment">/* src - dst -&gt; mm5 */</span>
<span class="normal">				</span><span class="function">pmullw_r2r</span><span class="symbol">(</span><span class="normal">mm0</span><span class="symbol">,</span><span class="normal"> mm5</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* mm5 * alpha -&gt; mm5 */</span>
<span class="normal">				</span><span class="comment">/* 11 + 5 = 16 bits, so the sign bits are lost and</span>
<span class="comment">				   the interesting bits will need to be MASKed */</span>
<span class="normal">				</span><span class="function">psrlw_i2r</span><span class="symbol">(</span><span class="number">11</span><span class="symbol">,</span><span class="normal"> mm5</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* mm5 &gt;&gt; 11 -&gt; mm5 */</span>
<span class="normal">				</span><span class="function">paddw_r2r</span><span class="symbol">(</span><span class="normal">mm5</span><span class="symbol">,</span><span class="normal"> mm6</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* mm5 + mm6(dst) -&gt; mm6 */</span>
<span class="normal">				</span><span class="function">pand_r2r</span><span class="symbol">(</span><span class="normal">mm7</span><span class="symbol">,</span><span class="normal"> mm6</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* mm6 &amp; MASKBLUE -&gt; mm6[000b 000b 000b 000b] */</span>

<span class="normal">				</span><span class="function">por_r2r</span><span class="symbol">(</span><span class="normal">mm6</span><span class="symbol">,</span><span class="normal"> mm1</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* save new blues in dsts */</span>

<span class="normal">				</span><span class="function">movq_r2m</span><span class="symbol">(</span><span class="normal">mm1</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dstp</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* mm1 -&gt; 4 dst pixels */</span>

<span class="normal">				srcp </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">4</span><span class="symbol">;</span>
<span class="normal">				dstp </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">4</span><span class="symbol">;</span>
<span class="normal">			</span><span class="cbracket">}</span><span class="symbol">,</span><span class="normal"> width</span><span class="symbol">);</span><span class="normal">			</span>
<span class="normal">			srcp </span><span class="symbol">+=</span><span class="normal"> srcskip</span><span class="symbol">;</span>
<span class="normal">			dstp </span><span class="symbol">+=</span><span class="normal"> dstskip</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="function">emms</span><span class="symbol">();</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="comment">/* fast RGB555-&gt;RGB555 blending with surface alpha */</span>
<span class="keyword">static</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="function">Blit555to555SurfaceAlphaMMX</span><span class="symbol">(</span><span class="usertype">SDL_BlitInfo</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">info</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">	</span><span class="type">unsigned</span><span class="normal"> alpha </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">src</span><span class="symbol">-&gt;</span><span class="normal">alpha</span><span class="symbol">;</span><span class="normal"> </span><span class="comment">/* downscale alpha to 5 bits */</span>
<span class="normal">	</span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">alpha </span><span class="symbol">==</span><span class="normal"> </span><span class="number">128</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">Blit16to16SurfaceAlpha128</span><span class="symbol">(</span><span class="normal">info</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0xfbde</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> width </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_width</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> height </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_height</span><span class="symbol">;</span>
<span class="normal">		</span><span class="usertype">Uint16</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">srcp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint16 </span><span class="symbol">*)</span><span class="normal">info</span><span class="symbol">-&gt;</span><span class="normal">s_pixels</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> srcskip </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">s_skip </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">		</span><span class="usertype">Uint16</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dstp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint16 </span><span class="symbol">*)</span><span class="normal">info</span><span class="symbol">-&gt;</span><span class="normal">d_pixels</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> dstskip </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_skip </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">		</span><span class="usertype">Uint32</span><span class="normal"> s</span><span class="symbol">,</span><span class="normal"> d</span><span class="symbol">;</span>
<span class="normal">		</span><span class="usertype">Uint8</span><span class="normal"> load</span><span class="symbol">[</span><span class="number">8</span><span class="symbol">];</span>
<span class="normal">	  </span>
<span class="normal">		alpha </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="symbol">~(</span><span class="number">1</span><span class="symbol">+</span><span class="number">2</span><span class="symbol">+</span><span class="number">4</span><span class="symbol">);</span><span class="normal">		</span><span class="comment">/* cut alpha to get the exact same behaviour */</span>
<span class="normal">		</span><span class="symbol">*(</span><span class="normal">Uint64 </span><span class="symbol">*)</span><span class="normal">load </span><span class="symbol">=</span><span class="normal"> alpha</span><span class="symbol">;</span>
<span class="normal">		alpha </span><span class="symbol">&gt;&gt;=</span><span class="normal"> </span><span class="number">3</span><span class="symbol">;</span><span class="normal">		</span><span class="comment">/* downscale alpha to 5 bits */</span>

<span class="normal">		</span><span class="function">movq_m2r</span><span class="symbol">(*</span><span class="normal">load</span><span class="symbol">,</span><span class="normal"> mm0</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* alpha(0000000A) -&gt; mm0 */</span>
<span class="normal">		</span><span class="function">punpcklwd_r2r</span><span class="symbol">(</span><span class="normal">mm0</span><span class="symbol">,</span><span class="normal"> mm0</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* 00000A0A -&gt; mm0 */</span>
<span class="normal">		</span><span class="function">punpcklwd_r2r</span><span class="symbol">(</span><span class="normal">mm0</span><span class="symbol">,</span><span class="normal"> mm0</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* 0A0A0A0A -&gt; mm0 */</span>
<span class="normal">		</span><span class="comment">/* position alpha to allow for mullo and mulhi on diff channels</span>
<span class="comment">		   to reduce the number of operations */</span>
<span class="normal">		</span><span class="function">psllq_i2r</span><span class="symbol">(</span><span class="number">3</span><span class="symbol">,</span><span class="normal"> mm0</span><span class="symbol">);</span>

<span class="normal">		</span><span class="comment">/* Setup the 555 color channel masks */</span>
<span class="normal">		</span><span class="symbol">*(</span><span class="normal">Uint64 </span><span class="symbol">*)</span><span class="normal">load </span><span class="symbol">=</span><span class="normal"> 0x03E003E003E003E0ULL</span><span class="symbol">;</span>
<span class="normal">		</span><span class="function">movq_m2r</span><span class="symbol">(*</span><span class="normal">load</span><span class="symbol">,</span><span class="normal"> mm4</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* MASKGREEN -&gt; mm4 */</span>
<span class="normal">		</span><span class="symbol">*(</span><span class="normal">Uint64 </span><span class="symbol">*)</span><span class="normal">load </span><span class="symbol">=</span><span class="normal"> 0x001F001F001F001FULL</span><span class="symbol">;</span>
<span class="normal">		</span><span class="function">movq_m2r</span><span class="symbol">(*</span><span class="normal">load</span><span class="symbol">,</span><span class="normal"> mm7</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* MASKBLUE -&gt; mm7 */</span>
<span class="normal">		</span><span class="keyword">while</span><span class="symbol">(</span><span class="normal">height</span><span class="symbol">--)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="function">DUFFS_LOOP_QUATRO2</span><span class="symbol">(</span>
<span class="normal">			</span><span class="cbracket">{</span>
<span class="normal">				s </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">srcp</span><span class="symbol">++;</span>
<span class="normal">				d </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dstp</span><span class="symbol">;</span>
<span class="normal">				</span><span class="comment">/*</span>
<span class="comment">				 * shift out the middle component (green) to</span>
<span class="comment">				 * the high 16 bits, and process all three RGB</span>
<span class="comment">				 * components at the same time.</span>
<span class="comment">				 */</span>
<span class="normal">				s </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">s </span><span class="symbol">|</span><span class="normal"> s </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">16</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x03e07c1f</span><span class="symbol">;</span>
<span class="normal">				d </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">d </span><span class="symbol">|</span><span class="normal"> d </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">16</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x03e07c1f</span><span class="symbol">;</span>
<span class="normal">				d </span><span class="symbol">+=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">s </span><span class="symbol">-</span><span class="normal"> d</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> alpha </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">5</span><span class="symbol">;</span>
<span class="normal">				d </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="number">0x03e07c1f</span><span class="symbol">;</span>
<span class="normal">				</span><span class="symbol">*</span><span class="normal">dstp</span><span class="symbol">++</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> d </span><span class="symbol">|</span><span class="normal"> d </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">16</span><span class="symbol">;</span>
<span class="normal">			</span><span class="cbracket">}</span><span class="symbol">,</span><span class="cbracket">{</span>
<span class="normal">				s </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">srcp</span><span class="symbol">++;</span>
<span class="normal">				d </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dstp</span><span class="symbol">;</span>
<span class="normal">				</span><span class="comment">/*</span>
<span class="comment">				 * shift out the middle component (green) to</span>
<span class="comment">				 * the high 16 bits, and process all three RGB</span>
<span class="comment">				 * components at the same time.</span>
<span class="comment">				 */</span>
<span class="normal">				s </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">s </span><span class="symbol">|</span><span class="normal"> s </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">16</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x03e07c1f</span><span class="symbol">;</span>
<span class="normal">				d </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">d </span><span class="symbol">|</span><span class="normal"> d </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">16</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x03e07c1f</span><span class="symbol">;</span>
<span class="normal">				d </span><span class="symbol">+=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">s </span><span class="symbol">-</span><span class="normal"> d</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> alpha </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">5</span><span class="symbol">;</span>
<span class="normal">				d </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="number">0x03e07c1f</span><span class="symbol">;</span>
<span class="normal">				</span><span class="symbol">*</span><span class="normal">dstp</span><span class="symbol">++</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> d </span><span class="symbol">|</span><span class="normal"> d </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">16</span><span class="symbol">;</span>
<span class="normal">			        s </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">srcp</span><span class="symbol">++;</span>
<span class="normal">				d </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dstp</span><span class="symbol">;</span>
<span class="normal">				</span><span class="comment">/*</span>
<span class="comment">				 * shift out the middle component (green) to</span>
<span class="comment">				 * the high 16 bits, and process all three RGB</span>
<span class="comment">				 * components at the same time.</span>
<span class="comment">				 */</span>
<span class="normal">				s </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">s </span><span class="symbol">|</span><span class="normal"> s </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">16</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x03e07c1f</span><span class="symbol">;</span>
<span class="normal">				d </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">d </span><span class="symbol">|</span><span class="normal"> d </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">16</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x03e07c1f</span><span class="symbol">;</span>
<span class="normal">				d </span><span class="symbol">+=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">s </span><span class="symbol">-</span><span class="normal"> d</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> alpha </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">5</span><span class="symbol">;</span>
<span class="normal">				d </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="number">0x03e07c1f</span><span class="symbol">;</span>
<span class="normal">				</span><span class="symbol">*</span><span class="normal">dstp</span><span class="symbol">++</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> d </span><span class="symbol">|</span><span class="normal"> d </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">16</span><span class="symbol">;</span>
<span class="normal">			</span><span class="cbracket">}</span><span class="symbol">,</span><span class="cbracket">{</span>
<span class="normal">				</span><span class="function">movq_m2r</span><span class="symbol">((*</span><span class="normal">srcp</span><span class="symbol">),</span><span class="normal"> mm2</span><span class="symbol">);</span><span class="comment">/* 4 src pixels -&gt; mm2 */</span>
<span class="normal">				</span><span class="function">movq_m2r</span><span class="symbol">((*</span><span class="normal">dstp</span><span class="symbol">),</span><span class="normal"> mm3</span><span class="symbol">);</span><span class="comment">/* 4 dst pixels -&gt; mm3 */</span>

<span class="normal">				</span><span class="comment">/* red -- process the bits in place */</span>
<span class="normal">				</span><span class="function">psllq_i2r</span><span class="symbol">(</span><span class="number">5</span><span class="symbol">,</span><span class="normal"> mm4</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* turn MASKGREEN into MASKRED */</span>
<span class="normal">					</span><span class="comment">/* by reusing the GREEN mask we free up another mmx</span>
<span class="comment">					   register to accumulate the result */</span>

<span class="normal">				</span><span class="function">movq_r2r</span><span class="symbol">(</span><span class="normal">mm2</span><span class="symbol">,</span><span class="normal"> mm5</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* src -&gt; mm5 */</span>
<span class="normal">				</span><span class="function">movq_r2r</span><span class="symbol">(</span><span class="normal">mm3</span><span class="symbol">,</span><span class="normal"> mm6</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* dst -&gt; mm6 */</span>
<span class="normal">				</span><span class="function">pand_r2r</span><span class="symbol">(</span><span class="normal">mm4</span><span class="symbol">,</span><span class="normal"> mm5</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* src &amp; MASKRED -&gt; mm5 */</span>
<span class="normal">				</span><span class="function">pand_r2r</span><span class="symbol">(</span><span class="normal">mm4</span><span class="symbol">,</span><span class="normal"> mm6</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* dst &amp; MASKRED -&gt; mm6 */</span>

<span class="normal">				</span><span class="comment">/* blend */</span>
<span class="normal">				</span><span class="function">psubw_r2r</span><span class="symbol">(</span><span class="normal">mm6</span><span class="symbol">,</span><span class="normal"> mm5</span><span class="symbol">);</span><span class="comment">/* src - dst -&gt; mm5 */</span>
<span class="normal">				</span><span class="function">pmulhw_r2r</span><span class="symbol">(</span><span class="normal">mm0</span><span class="symbol">,</span><span class="normal"> mm5</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* mm5 * alpha -&gt; mm5 */</span>
<span class="normal">				</span><span class="comment">/* 11 + 15 - 16 = 10 bits, uninteresting bits will be</span>
<span class="comment">				   cleared by a MASK below */</span>
<span class="normal">				</span><span class="function">psllw_i2r</span><span class="symbol">(</span><span class="number">5</span><span class="symbol">,</span><span class="normal"> mm5</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* mm5 &lt;&lt; 5 -&gt; mm5 */</span>
<span class="normal">				</span><span class="function">paddw_r2r</span><span class="symbol">(</span><span class="normal">mm5</span><span class="symbol">,</span><span class="normal"> mm6</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* mm5 + mm6(dst) -&gt; mm6 */</span>
<span class="normal">				</span><span class="function">pand_r2r</span><span class="symbol">(</span><span class="normal">mm4</span><span class="symbol">,</span><span class="normal"> mm6</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* mm6 &amp; MASKRED -&gt; mm6 */</span>

<span class="normal">				</span><span class="function">psrlq_i2r</span><span class="symbol">(</span><span class="number">5</span><span class="symbol">,</span><span class="normal"> mm4</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* turn MASKRED back into MASKGREEN */</span>

<span class="normal">				</span><span class="function">movq_r2r</span><span class="symbol">(</span><span class="normal">mm6</span><span class="symbol">,</span><span class="normal"> mm1</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* save new reds in dsts */</span>

<span class="normal">				</span><span class="comment">/* green -- process the bits in place */</span>
<span class="normal">				</span><span class="function">movq_r2r</span><span class="symbol">(</span><span class="normal">mm2</span><span class="symbol">,</span><span class="normal"> mm5</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* src -&gt; mm5 */</span>
<span class="normal">				</span><span class="function">movq_r2r</span><span class="symbol">(</span><span class="normal">mm3</span><span class="symbol">,</span><span class="normal"> mm6</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* dst -&gt; mm6 */</span>
<span class="normal">				</span><span class="function">pand_r2r</span><span class="symbol">(</span><span class="normal">mm4</span><span class="symbol">,</span><span class="normal"> mm5</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* src &amp; MASKGREEN -&gt; mm5 */</span>
<span class="normal">				</span><span class="function">pand_r2r</span><span class="symbol">(</span><span class="normal">mm4</span><span class="symbol">,</span><span class="normal"> mm6</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* dst &amp; MASKGREEN -&gt; mm6 */</span>

<span class="normal">				</span><span class="comment">/* blend */</span>
<span class="normal">				</span><span class="function">psubw_r2r</span><span class="symbol">(</span><span class="normal">mm6</span><span class="symbol">,</span><span class="normal"> mm5</span><span class="symbol">);</span><span class="comment">/* src - dst -&gt; mm5 */</span>
<span class="normal">				</span><span class="function">pmulhw_r2r</span><span class="symbol">(</span><span class="normal">mm0</span><span class="symbol">,</span><span class="normal"> mm5</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* mm5 * alpha -&gt; mm5 */</span>
<span class="normal">				</span><span class="comment">/* 11 + 10 - 16 = 5 bits,  so all the lower uninteresting</span>
<span class="comment">				   bits are gone and the sign bits present */</span>
<span class="normal">				</span><span class="function">psllw_i2r</span><span class="symbol">(</span><span class="number">5</span><span class="symbol">,</span><span class="normal"> mm5</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* mm5 &lt;&lt; 5 -&gt; mm5 */</span>
<span class="normal">				</span><span class="function">paddw_r2r</span><span class="symbol">(</span><span class="normal">mm5</span><span class="symbol">,</span><span class="normal"> mm6</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* mm5 + mm6(dst) -&gt; mm6 */</span>

<span class="normal">				</span><span class="function">por_r2r</span><span class="symbol">(</span><span class="normal">mm6</span><span class="symbol">,</span><span class="normal"> mm1</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* save new greens in dsts */</span>

<span class="normal">				</span><span class="comment">/* blue */</span>
<span class="normal">				</span><span class="function">movq_r2r</span><span class="symbol">(</span><span class="normal">mm2</span><span class="symbol">,</span><span class="normal"> mm5</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* src -&gt; mm5 */</span>
<span class="normal">				</span><span class="function">movq_r2r</span><span class="symbol">(</span><span class="normal">mm3</span><span class="symbol">,</span><span class="normal"> mm6</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* dst -&gt; mm6 */</span>
<span class="normal">				</span><span class="function">pand_r2r</span><span class="symbol">(</span><span class="normal">mm7</span><span class="symbol">,</span><span class="normal"> mm5</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* src &amp; MASKBLUE -&gt; mm5[000b 000b 000b 000b] */</span>
<span class="normal">				</span><span class="function">pand_r2r</span><span class="symbol">(</span><span class="normal">mm7</span><span class="symbol">,</span><span class="normal"> mm6</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* dst &amp; MASKBLUE -&gt; mm6[000b 000b 000b 000b] */</span>

<span class="normal">				</span><span class="comment">/* blend */</span>
<span class="normal">				</span><span class="function">psubw_r2r</span><span class="symbol">(</span><span class="normal">mm6</span><span class="symbol">,</span><span class="normal"> mm5</span><span class="symbol">);</span><span class="comment">/* src - dst -&gt; mm5 */</span>
<span class="normal">				</span><span class="function">pmullw_r2r</span><span class="symbol">(</span><span class="normal">mm0</span><span class="symbol">,</span><span class="normal"> mm5</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* mm5 * alpha -&gt; mm5 */</span>
<span class="normal">				</span><span class="comment">/* 11 + 5 = 16 bits, so the sign bits are lost and</span>
<span class="comment">				   the interesting bits will need to be MASKed */</span>
<span class="normal">				</span><span class="function">psrlw_i2r</span><span class="symbol">(</span><span class="number">11</span><span class="symbol">,</span><span class="normal"> mm5</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* mm5 &gt;&gt; 11 -&gt; mm5 */</span>
<span class="normal">				</span><span class="function">paddw_r2r</span><span class="symbol">(</span><span class="normal">mm5</span><span class="symbol">,</span><span class="normal"> mm6</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* mm5 + mm6(dst) -&gt; mm6 */</span>
<span class="normal">				</span><span class="function">pand_r2r</span><span class="symbol">(</span><span class="normal">mm7</span><span class="symbol">,</span><span class="normal"> mm6</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* mm6 &amp; MASKBLUE -&gt; mm6[000b 000b 000b 000b] */</span>

<span class="normal">				</span><span class="function">por_r2r</span><span class="symbol">(</span><span class="normal">mm6</span><span class="symbol">,</span><span class="normal"> mm1</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* save new blues in dsts */</span>

<span class="normal">				</span><span class="function">movq_r2m</span><span class="symbol">(</span><span class="normal">mm1</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dstp</span><span class="symbol">);</span><span class="comment">/* mm1 -&gt; 4 dst pixels */</span>

<span class="normal">				srcp </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">4</span><span class="symbol">;</span>
<span class="normal">				dstp </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">4</span><span class="symbol">;</span>
<span class="normal">			</span><span class="cbracket">}</span><span class="symbol">,</span><span class="normal"> width</span><span class="symbol">);</span><span class="normal">			</span>
<span class="normal">			srcp </span><span class="symbol">+=</span><span class="normal"> srcskip</span><span class="symbol">;</span>
<span class="normal">			dstp </span><span class="symbol">+=</span><span class="normal"> dstskip</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="function">emms</span><span class="symbol">();</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>
<span class="comment">/* End GCC_ASMBLIT */</span>

<span class="preproc">#elif</span><span class="normal"> MSVC_ASMBLIT</span>
<span class="comment">/* fast RGB565-&gt;RGB565 blending with surface alpha */</span>
<span class="keyword">static</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="function">Blit565to565SurfaceAlphaMMX</span><span class="symbol">(</span><span class="usertype">SDL_BlitInfo</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">info</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">	</span><span class="type">unsigned</span><span class="normal"> alpha </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">src</span><span class="symbol">-&gt;</span><span class="normal">alpha</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">alpha </span><span class="symbol">==</span><span class="normal"> </span><span class="number">128</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">Blit16to16SurfaceAlpha128</span><span class="symbol">(</span><span class="normal">info</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0xf7de</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> width </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_width</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> height </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_height</span><span class="symbol">;</span>
<span class="normal">		</span><span class="usertype">Uint16</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">srcp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint16 </span><span class="symbol">*)</span><span class="normal">info</span><span class="symbol">-&gt;</span><span class="normal">s_pixels</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> srcskip </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">s_skip </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">		</span><span class="usertype">Uint16</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dstp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint16 </span><span class="symbol">*)</span><span class="normal">info</span><span class="symbol">-&gt;</span><span class="normal">d_pixels</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> dstskip </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_skip </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">		</span><span class="usertype">Uint32</span><span class="normal"> s</span><span class="symbol">,</span><span class="normal"> d</span><span class="symbol">;</span>
<span class="normal">	  </span>
<span class="normal">		</span><span class="usertype">__m64</span><span class="normal"> src1</span><span class="symbol">,</span><span class="normal"> dst1</span><span class="symbol">,</span><span class="normal"> src2</span><span class="symbol">,</span><span class="normal"> dst2</span><span class="symbol">,</span><span class="normal"> gmask</span><span class="symbol">,</span><span class="normal"> bmask</span><span class="symbol">,</span><span class="normal"> mm_res</span><span class="symbol">,</span><span class="normal"> mm_alpha</span><span class="symbol">;</span>

<span class="normal">		alpha </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="symbol">~(</span><span class="number">1</span><span class="symbol">+</span><span class="number">2</span><span class="symbol">+</span><span class="number">4</span><span class="symbol">);</span><span class="normal">		</span><span class="comment">/* cut alpha to get the exact same behaviour */</span>
<span class="normal">		mm_alpha </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_set_pi32</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">,</span><span class="normal"> alpha</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* 0000000A -&gt; mm_alpha */</span>
<span class="normal">		alpha </span><span class="symbol">&gt;&gt;=</span><span class="normal"> </span><span class="number">3</span><span class="symbol">;</span><span class="normal">		</span><span class="comment">/* downscale alpha to 5 bits */</span>

<span class="normal">		mm_alpha </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_unpacklo_pi16</span><span class="symbol">(</span><span class="normal">mm_alpha</span><span class="symbol">,</span><span class="normal"> mm_alpha</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* 00000A0A -&gt; mm_alpha */</span>
<span class="normal">		mm_alpha </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_unpacklo_pi32</span><span class="symbol">(</span><span class="normal">mm_alpha</span><span class="symbol">,</span><span class="normal"> mm_alpha</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* 0A0A0A0A -&gt; mm_alpha */</span>
<span class="normal">		</span><span class="comment">/* position alpha to allow for mullo and mulhi on diff channels</span>
<span class="comment">		   to reduce the number of operations */</span>
<span class="normal">		mm_alpha </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_slli_si64</span><span class="symbol">(</span><span class="normal">mm_alpha</span><span class="symbol">,</span><span class="normal"> </span><span class="number">3</span><span class="symbol">);</span>
<span class="normal">	  </span>
<span class="normal">		</span><span class="comment">/* Setup the 565 color channel masks */</span>
<span class="normal">		gmask </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_set_pi32</span><span class="symbol">(</span><span class="number">0x07E007E0</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x07E007E0</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* MASKGREEN -&gt; gmask */</span>
<span class="normal">		bmask </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_set_pi32</span><span class="symbol">(</span><span class="number">0x001F001F</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x001F001F</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* MASKBLUE -&gt; bmask */</span>
<span class="normal">		</span>
<span class="normal">		</span><span class="keyword">while</span><span class="symbol">(</span><span class="normal">height</span><span class="symbol">--)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="function">DUFFS_LOOP_QUATRO2</span><span class="symbol">(</span>
<span class="normal">			</span><span class="cbracket">{</span>
<span class="normal">				s </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">srcp</span><span class="symbol">++;</span>
<span class="normal">				d </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dstp</span><span class="symbol">;</span>
<span class="normal">				</span><span class="comment">/*</span>
<span class="comment">				 * shift out the middle component (green) to</span>
<span class="comment">				 * the high 16 bits, and process all three RGB</span>
<span class="comment">				 * components at the same time.</span>
<span class="comment">				 */</span>
<span class="normal">				s </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">s </span><span class="symbol">|</span><span class="normal"> s </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">16</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x07e0f81f</span><span class="symbol">;</span>
<span class="normal">				d </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">d </span><span class="symbol">|</span><span class="normal"> d </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">16</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x07e0f81f</span><span class="symbol">;</span>
<span class="normal">				d </span><span class="symbol">+=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">s </span><span class="symbol">-</span><span class="normal"> d</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> alpha </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">5</span><span class="symbol">;</span>
<span class="normal">				d </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="number">0x07e0f81f</span><span class="symbol">;</span>
<span class="normal">				</span><span class="symbol">*</span><span class="normal">dstp</span><span class="symbol">++</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint16</span><span class="symbol">)(</span><span class="normal">d </span><span class="symbol">|</span><span class="normal"> d </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">16</span><span class="symbol">);</span>
<span class="normal">			</span><span class="cbracket">}</span><span class="symbol">,</span><span class="cbracket">{</span>
<span class="normal">				s </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">srcp</span><span class="symbol">++;</span>
<span class="normal">				d </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dstp</span><span class="symbol">;</span>
<span class="normal">				</span><span class="comment">/*</span>
<span class="comment">				 * shift out the middle component (green) to</span>
<span class="comment">				 * the high 16 bits, and process all three RGB</span>
<span class="comment">				 * components at the same time.</span>
<span class="comment">				 */</span>
<span class="normal">				s </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">s </span><span class="symbol">|</span><span class="normal"> s </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">16</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x07e0f81f</span><span class="symbol">;</span>
<span class="normal">				d </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">d </span><span class="symbol">|</span><span class="normal"> d </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">16</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x07e0f81f</span><span class="symbol">;</span>
<span class="normal">				d </span><span class="symbol">+=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">s </span><span class="symbol">-</span><span class="normal"> d</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> alpha </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">5</span><span class="symbol">;</span>
<span class="normal">				d </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="number">0x07e0f81f</span><span class="symbol">;</span>
<span class="normal">				</span><span class="symbol">*</span><span class="normal">dstp</span><span class="symbol">++</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint16</span><span class="symbol">)(</span><span class="normal">d </span><span class="symbol">|</span><span class="normal"> d </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">16</span><span class="symbol">);</span>
<span class="normal">				s </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">srcp</span><span class="symbol">++;</span>
<span class="normal">				d </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dstp</span><span class="symbol">;</span>
<span class="normal">				</span><span class="comment">/*</span>
<span class="comment">				 * shift out the middle component (green) to</span>
<span class="comment">				 * the high 16 bits, and process all three RGB</span>
<span class="comment">				 * components at the same time.</span>
<span class="comment">				 */</span>
<span class="normal">				s </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">s </span><span class="symbol">|</span><span class="normal"> s </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">16</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x07e0f81f</span><span class="symbol">;</span>
<span class="normal">				d </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">d </span><span class="symbol">|</span><span class="normal"> d </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">16</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x07e0f81f</span><span class="symbol">;</span>
<span class="normal">				d </span><span class="symbol">+=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">s </span><span class="symbol">-</span><span class="normal"> d</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> alpha </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">5</span><span class="symbol">;</span>
<span class="normal">				d </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="number">0x07e0f81f</span><span class="symbol">;</span>
<span class="normal">				</span><span class="symbol">*</span><span class="normal">dstp</span><span class="symbol">++</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint16</span><span class="symbol">)(</span><span class="normal">d </span><span class="symbol">|</span><span class="normal"> d </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">16</span><span class="symbol">);</span>
<span class="normal">			</span><span class="cbracket">}</span><span class="symbol">,</span><span class="cbracket">{</span>
<span class="normal">				src1 </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">__m64</span><span class="symbol">*)</span><span class="normal">srcp</span><span class="symbol">;</span><span class="normal"> </span><span class="comment">/* 4 src pixels -&gt; src1 */</span>
<span class="normal">				dst1 </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">__m64</span><span class="symbol">*)</span><span class="normal">dstp</span><span class="symbol">;</span><span class="normal"> </span><span class="comment">/* 4 dst pixels -&gt; dst1 */</span>

<span class="normal">				</span><span class="comment">/* red */</span>
<span class="normal">				src2 </span><span class="symbol">=</span><span class="normal"> src1</span><span class="symbol">;</span>
<span class="normal">				src2 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_srli_pi16</span><span class="symbol">(</span><span class="normal">src2</span><span class="symbol">,</span><span class="normal"> </span><span class="number">11</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* src2 &gt;&gt; 11 -&gt; src2 [000r 000r 000r 000r] */</span>

<span class="normal">				dst2 </span><span class="symbol">=</span><span class="normal"> dst1</span><span class="symbol">;</span>
<span class="normal">				dst2 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_srli_pi16</span><span class="symbol">(</span><span class="normal">dst2</span><span class="symbol">,</span><span class="normal"> </span><span class="number">11</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* dst2 &gt;&gt; 11 -&gt; dst2 [000r 000r 000r 000r] */</span>

<span class="normal">				</span><span class="comment">/* blend */</span>
<span class="normal">				src2 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_sub_pi16</span><span class="symbol">(</span><span class="normal">src2</span><span class="symbol">,</span><span class="normal"> dst2</span><span class="symbol">);</span><span class="comment">/* src - dst -&gt; src2 */</span>
<span class="normal">				src2 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_mullo_pi16</span><span class="symbol">(</span><span class="normal">src2</span><span class="symbol">,</span><span class="normal"> mm_alpha</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* src2 * alpha -&gt; src2 */</span>
<span class="normal">				src2 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_srli_pi16</span><span class="symbol">(</span><span class="normal">src2</span><span class="symbol">,</span><span class="normal"> </span><span class="number">11</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* src2 &gt;&gt; 11 -&gt; src2 */</span>
<span class="normal">				dst2 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_add_pi16</span><span class="symbol">(</span><span class="normal">src2</span><span class="symbol">,</span><span class="normal"> dst2</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* src2 + dst2 -&gt; dst2 */</span>
<span class="normal">				dst2 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_slli_pi16</span><span class="symbol">(</span><span class="normal">dst2</span><span class="symbol">,</span><span class="normal"> </span><span class="number">11</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* dst2 &lt;&lt; 11 -&gt; dst2 */</span>

<span class="normal">				mm_res </span><span class="symbol">=</span><span class="normal"> dst2</span><span class="symbol">;</span><span class="normal"> </span><span class="comment">/* RED -&gt; mm_res */</span>

<span class="normal">				</span><span class="comment">/* green -- process the bits in place */</span>
<span class="normal">				src2 </span><span class="symbol">=</span><span class="normal"> src1</span><span class="symbol">;</span>
<span class="normal">				src2 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_and_si64</span><span class="symbol">(</span><span class="normal">src2</span><span class="symbol">,</span><span class="normal"> gmask</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* src &amp; MASKGREEN -&gt; src2 */</span>

<span class="normal">				dst2 </span><span class="symbol">=</span><span class="normal"> dst1</span><span class="symbol">;</span>
<span class="normal">				dst2 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_and_si64</span><span class="symbol">(</span><span class="normal">dst2</span><span class="symbol">,</span><span class="normal"> gmask</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* dst &amp; MASKGREEN -&gt; dst2 */</span>

<span class="normal">				</span><span class="comment">/* blend */</span>
<span class="normal">				src2 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_sub_pi16</span><span class="symbol">(</span><span class="normal">src2</span><span class="symbol">,</span><span class="normal"> dst2</span><span class="symbol">);</span><span class="comment">/* src - dst -&gt; src2 */</span>
<span class="normal">				src2 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_mulhi_pi16</span><span class="symbol">(</span><span class="normal">src2</span><span class="symbol">,</span><span class="normal"> mm_alpha</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* src2 * alpha -&gt; src2 */</span>
<span class="normal">				src2 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_slli_pi16</span><span class="symbol">(</span><span class="normal">src2</span><span class="symbol">,</span><span class="normal"> </span><span class="number">5</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* src2 &lt;&lt; 5 -&gt; src2 */</span>
<span class="normal">				dst2 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_add_pi16</span><span class="symbol">(</span><span class="normal">src2</span><span class="symbol">,</span><span class="normal"> dst2</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* src2 + dst2 -&gt; dst2 */</span>

<span class="normal">				mm_res </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_or_si64</span><span class="symbol">(</span><span class="normal">mm_res</span><span class="symbol">,</span><span class="normal"> dst2</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* RED | GREEN -&gt; mm_res */</span>

<span class="normal">				</span><span class="comment">/* blue */</span>
<span class="normal">				src2 </span><span class="symbol">=</span><span class="normal"> src1</span><span class="symbol">;</span>
<span class="normal">				src2 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_and_si64</span><span class="symbol">(</span><span class="normal">src2</span><span class="symbol">,</span><span class="normal"> bmask</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* src &amp; MASKBLUE -&gt; src2[000b 000b 000b 000b] */</span>

<span class="normal">				dst2 </span><span class="symbol">=</span><span class="normal"> dst1</span><span class="symbol">;</span>
<span class="normal">				dst2 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_and_si64</span><span class="symbol">(</span><span class="normal">dst2</span><span class="symbol">,</span><span class="normal"> bmask</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* dst &amp; MASKBLUE -&gt; dst2[000b 000b 000b 000b] */</span>

<span class="normal">				</span><span class="comment">/* blend */</span>
<span class="normal">				src2 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_sub_pi16</span><span class="symbol">(</span><span class="normal">src2</span><span class="symbol">,</span><span class="normal"> dst2</span><span class="symbol">);</span><span class="comment">/* src - dst -&gt; src2 */</span>
<span class="normal">				src2 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_mullo_pi16</span><span class="symbol">(</span><span class="normal">src2</span><span class="symbol">,</span><span class="normal"> mm_alpha</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* src2 * alpha -&gt; src2 */</span>
<span class="normal">				src2 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_srli_pi16</span><span class="symbol">(</span><span class="normal">src2</span><span class="symbol">,</span><span class="normal"> </span><span class="number">11</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* src2 &gt;&gt; 11 -&gt; src2 */</span>
<span class="normal">				dst2 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_add_pi16</span><span class="symbol">(</span><span class="normal">src2</span><span class="symbol">,</span><span class="normal"> dst2</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* src2 + dst2 -&gt; dst2 */</span>
<span class="normal">				dst2 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_and_si64</span><span class="symbol">(</span><span class="normal">dst2</span><span class="symbol">,</span><span class="normal"> bmask</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* dst2 &amp; MASKBLUE -&gt; dst2 */</span>

<span class="normal">				mm_res </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_or_si64</span><span class="symbol">(</span><span class="normal">mm_res</span><span class="symbol">,</span><span class="normal"> dst2</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* RED | GREEN | BLUE -&gt; mm_res */</span>

<span class="normal">				</span><span class="symbol">*(</span><span class="normal">__m64</span><span class="symbol">*)</span><span class="normal">dstp </span><span class="symbol">=</span><span class="normal"> mm_res</span><span class="symbol">;</span><span class="normal"> </span><span class="comment">/* mm_res -&gt; 4 dst pixels */</span>

<span class="normal">				srcp </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">4</span><span class="symbol">;</span>
<span class="normal">				dstp </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">4</span><span class="symbol">;</span>
<span class="normal">			</span><span class="cbracket">}</span><span class="symbol">,</span><span class="normal"> width</span><span class="symbol">);</span><span class="normal">			</span>
<span class="normal">			srcp </span><span class="symbol">+=</span><span class="normal"> srcskip</span><span class="symbol">;</span>
<span class="normal">			dstp </span><span class="symbol">+=</span><span class="normal"> dstskip</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="function">_mm_empty</span><span class="symbol">();</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="comment">/* fast RGB555-&gt;RGB555 blending with surface alpha */</span>
<span class="keyword">static</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="function">Blit555to555SurfaceAlphaMMX</span><span class="symbol">(</span><span class="usertype">SDL_BlitInfo</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">info</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">	</span><span class="type">unsigned</span><span class="normal"> alpha </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">src</span><span class="symbol">-&gt;</span><span class="normal">alpha</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">alpha </span><span class="symbol">==</span><span class="normal"> </span><span class="number">128</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">Blit16to16SurfaceAlpha128</span><span class="symbol">(</span><span class="normal">info</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0xfbde</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> width </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_width</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> height </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_height</span><span class="symbol">;</span>
<span class="normal">		</span><span class="usertype">Uint16</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">srcp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint16 </span><span class="symbol">*)</span><span class="normal">info</span><span class="symbol">-&gt;</span><span class="normal">s_pixels</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> srcskip </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">s_skip </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">		</span><span class="usertype">Uint16</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dstp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint16 </span><span class="symbol">*)</span><span class="normal">info</span><span class="symbol">-&gt;</span><span class="normal">d_pixels</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> dstskip </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_skip </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">		</span><span class="usertype">Uint32</span><span class="normal"> s</span><span class="symbol">,</span><span class="normal"> d</span><span class="symbol">;</span>
<span class="normal">	  </span>
<span class="normal">		</span><span class="usertype">__m64</span><span class="normal"> src1</span><span class="symbol">,</span><span class="normal"> dst1</span><span class="symbol">,</span><span class="normal"> src2</span><span class="symbol">,</span><span class="normal"> dst2</span><span class="symbol">,</span><span class="normal"> rmask</span><span class="symbol">,</span><span class="normal"> gmask</span><span class="symbol">,</span><span class="normal"> bmask</span><span class="symbol">,</span><span class="normal"> mm_res</span><span class="symbol">,</span><span class="normal"> mm_alpha</span><span class="symbol">;</span>

<span class="normal">		alpha </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="symbol">~(</span><span class="number">1</span><span class="symbol">+</span><span class="number">2</span><span class="symbol">+</span><span class="number">4</span><span class="symbol">);</span><span class="normal">		</span><span class="comment">/* cut alpha to get the exact same behaviour */</span>
<span class="normal">		mm_alpha </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_set_pi32</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">,</span><span class="normal"> alpha</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* 0000000A -&gt; mm_alpha */</span>
<span class="normal">		alpha </span><span class="symbol">&gt;&gt;=</span><span class="normal"> </span><span class="number">3</span><span class="symbol">;</span><span class="normal">		</span><span class="comment">/* downscale alpha to 5 bits */</span>

<span class="normal">		mm_alpha </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_unpacklo_pi16</span><span class="symbol">(</span><span class="normal">mm_alpha</span><span class="symbol">,</span><span class="normal"> mm_alpha</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* 00000A0A -&gt; mm_alpha */</span>
<span class="normal">		mm_alpha </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_unpacklo_pi32</span><span class="symbol">(</span><span class="normal">mm_alpha</span><span class="symbol">,</span><span class="normal"> mm_alpha</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* 0A0A0A0A -&gt; mm_alpha */</span>
<span class="normal">		</span><span class="comment">/* position alpha to allow for mullo and mulhi on diff channels</span>
<span class="comment">		   to reduce the number of operations */</span>
<span class="normal">		mm_alpha </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_slli_si64</span><span class="symbol">(</span><span class="normal">mm_alpha</span><span class="symbol">,</span><span class="normal"> </span><span class="number">3</span><span class="symbol">);</span>
<span class="normal">	  </span>
<span class="normal">		</span><span class="comment">/* Setup the 555 color channel masks */</span>
<span class="normal">		rmask </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_set_pi32</span><span class="symbol">(</span><span class="number">0x7C007C00</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x7C007C00</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* MASKRED -&gt; rmask */</span>
<span class="normal">		gmask </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_set_pi32</span><span class="symbol">(</span><span class="number">0x03E003E0</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x03E003E0</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* MASKGREEN -&gt; gmask */</span>
<span class="normal">		bmask </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_set_pi32</span><span class="symbol">(</span><span class="number">0x001F001F</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x001F001F</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* MASKBLUE -&gt; bmask */</span>

<span class="normal">		</span><span class="keyword">while</span><span class="symbol">(</span><span class="normal">height</span><span class="symbol">--)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="function">DUFFS_LOOP_QUATRO2</span><span class="symbol">(</span>
<span class="normal">			</span><span class="cbracket">{</span>
<span class="normal">				s </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">srcp</span><span class="symbol">++;</span>
<span class="normal">				d </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dstp</span><span class="symbol">;</span>
<span class="normal">				</span><span class="comment">/*</span>
<span class="comment">				 * shift out the middle component (green) to</span>
<span class="comment">				 * the high 16 bits, and process all three RGB</span>
<span class="comment">				 * components at the same time.</span>
<span class="comment">				 */</span>
<span class="normal">				s </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">s </span><span class="symbol">|</span><span class="normal"> s </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">16</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x03e07c1f</span><span class="symbol">;</span>
<span class="normal">				d </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">d </span><span class="symbol">|</span><span class="normal"> d </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">16</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x03e07c1f</span><span class="symbol">;</span>
<span class="normal">				d </span><span class="symbol">+=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">s </span><span class="symbol">-</span><span class="normal"> d</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> alpha </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">5</span><span class="symbol">;</span>
<span class="normal">				d </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="number">0x03e07c1f</span><span class="symbol">;</span>
<span class="normal">				</span><span class="symbol">*</span><span class="normal">dstp</span><span class="symbol">++</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint16</span><span class="symbol">)(</span><span class="normal">d </span><span class="symbol">|</span><span class="normal"> d </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">16</span><span class="symbol">);</span>
<span class="normal">			</span><span class="cbracket">}</span><span class="symbol">,</span><span class="cbracket">{</span>
<span class="normal">				s </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">srcp</span><span class="symbol">++;</span>
<span class="normal">				d </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dstp</span><span class="symbol">;</span>
<span class="normal">				</span><span class="comment">/*</span>
<span class="comment">				 * shift out the middle component (green) to</span>
<span class="comment">				 * the high 16 bits, and process all three RGB</span>
<span class="comment">				 * components at the same time.</span>
<span class="comment">				 */</span>
<span class="normal">				s </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">s </span><span class="symbol">|</span><span class="normal"> s </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">16</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x03e07c1f</span><span class="symbol">;</span>
<span class="normal">				d </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">d </span><span class="symbol">|</span><span class="normal"> d </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">16</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x03e07c1f</span><span class="symbol">;</span>
<span class="normal">				d </span><span class="symbol">+=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">s </span><span class="symbol">-</span><span class="normal"> d</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> alpha </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">5</span><span class="symbol">;</span>
<span class="normal">				d </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="number">0x03e07c1f</span><span class="symbol">;</span>
<span class="normal">				</span><span class="symbol">*</span><span class="normal">dstp</span><span class="symbol">++</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint16</span><span class="symbol">)(</span><span class="normal">d </span><span class="symbol">|</span><span class="normal"> d </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">16</span><span class="symbol">);</span>
<span class="normal">			        s </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">srcp</span><span class="symbol">++;</span>
<span class="normal">				d </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dstp</span><span class="symbol">;</span>
<span class="normal">				</span><span class="comment">/*</span>
<span class="comment">				 * shift out the middle component (green) to</span>
<span class="comment">				 * the high 16 bits, and process all three RGB</span>
<span class="comment">				 * components at the same time.</span>
<span class="comment">				 */</span>
<span class="normal">				s </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">s </span><span class="symbol">|</span><span class="normal"> s </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">16</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x03e07c1f</span><span class="symbol">;</span>
<span class="normal">				d </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">d </span><span class="symbol">|</span><span class="normal"> d </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">16</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x03e07c1f</span><span class="symbol">;</span>
<span class="normal">				d </span><span class="symbol">+=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">s </span><span class="symbol">-</span><span class="normal"> d</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> alpha </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">5</span><span class="symbol">;</span>
<span class="normal">				d </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="number">0x03e07c1f</span><span class="symbol">;</span>
<span class="normal">				</span><span class="symbol">*</span><span class="normal">dstp</span><span class="symbol">++</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint16</span><span class="symbol">)(</span><span class="normal">d </span><span class="symbol">|</span><span class="normal"> d </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">16</span><span class="symbol">);</span>
<span class="normal">			</span><span class="cbracket">}</span><span class="symbol">,</span><span class="cbracket">{</span>
<span class="normal">				src1 </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">__m64</span><span class="symbol">*)</span><span class="normal">srcp</span><span class="symbol">;</span><span class="normal"> </span><span class="comment">/* 4 src pixels -&gt; src1 */</span>
<span class="normal">				dst1 </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">__m64</span><span class="symbol">*)</span><span class="normal">dstp</span><span class="symbol">;</span><span class="normal"> </span><span class="comment">/* 4 dst pixels -&gt; dst1 */</span>

<span class="normal">				</span><span class="comment">/* red -- process the bits in place */</span>
<span class="normal">				src2 </span><span class="symbol">=</span><span class="normal"> src1</span><span class="symbol">;</span>
<span class="normal">				src2 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_and_si64</span><span class="symbol">(</span><span class="normal">src2</span><span class="symbol">,</span><span class="normal"> rmask</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* src &amp; MASKRED -&gt; src2 */</span>

<span class="normal">				dst2 </span><span class="symbol">=</span><span class="normal"> dst1</span><span class="symbol">;</span>
<span class="normal">				dst2 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_and_si64</span><span class="symbol">(</span><span class="normal">dst2</span><span class="symbol">,</span><span class="normal"> rmask</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* dst &amp; MASKRED -&gt; dst2 */</span>

<span class="normal">				</span><span class="comment">/* blend */</span>
<span class="normal">				src2 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_sub_pi16</span><span class="symbol">(</span><span class="normal">src2</span><span class="symbol">,</span><span class="normal"> dst2</span><span class="symbol">);</span><span class="comment">/* src - dst -&gt; src2 */</span>
<span class="normal">				src2 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_mulhi_pi16</span><span class="symbol">(</span><span class="normal">src2</span><span class="symbol">,</span><span class="normal"> mm_alpha</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* src2 * alpha -&gt; src2 */</span>
<span class="normal">				src2 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_slli_pi16</span><span class="symbol">(</span><span class="normal">src2</span><span class="symbol">,</span><span class="normal"> </span><span class="number">5</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* src2 &lt;&lt; 5 -&gt; src2 */</span>
<span class="normal">				dst2 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_add_pi16</span><span class="symbol">(</span><span class="normal">src2</span><span class="symbol">,</span><span class="normal"> dst2</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* src2 + dst2 -&gt; dst2 */</span>
<span class="normal">				dst2 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_and_si64</span><span class="symbol">(</span><span class="normal">dst2</span><span class="symbol">,</span><span class="normal"> rmask</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* dst2 &amp; MASKRED -&gt; dst2 */</span>

<span class="normal">				mm_res </span><span class="symbol">=</span><span class="normal"> dst2</span><span class="symbol">;</span><span class="normal"> </span><span class="comment">/* RED -&gt; mm_res */</span>
<span class="normal">				</span>
<span class="normal">				</span><span class="comment">/* green -- process the bits in place */</span>
<span class="normal">				src2 </span><span class="symbol">=</span><span class="normal"> src1</span><span class="symbol">;</span>
<span class="normal">				src2 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_and_si64</span><span class="symbol">(</span><span class="normal">src2</span><span class="symbol">,</span><span class="normal"> gmask</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* src &amp; MASKGREEN -&gt; src2 */</span>

<span class="normal">				dst2 </span><span class="symbol">=</span><span class="normal"> dst1</span><span class="symbol">;</span>
<span class="normal">				dst2 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_and_si64</span><span class="symbol">(</span><span class="normal">dst2</span><span class="symbol">,</span><span class="normal"> gmask</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* dst &amp; MASKGREEN -&gt; dst2 */</span>

<span class="normal">				</span><span class="comment">/* blend */</span>
<span class="normal">				src2 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_sub_pi16</span><span class="symbol">(</span><span class="normal">src2</span><span class="symbol">,</span><span class="normal"> dst2</span><span class="symbol">);</span><span class="comment">/* src - dst -&gt; src2 */</span>
<span class="normal">				src2 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_mulhi_pi16</span><span class="symbol">(</span><span class="normal">src2</span><span class="symbol">,</span><span class="normal"> mm_alpha</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* src2 * alpha -&gt; src2 */</span>
<span class="normal">				src2 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_slli_pi16</span><span class="symbol">(</span><span class="normal">src2</span><span class="symbol">,</span><span class="normal"> </span><span class="number">5</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* src2 &lt;&lt; 5 -&gt; src2 */</span>
<span class="normal">				dst2 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_add_pi16</span><span class="symbol">(</span><span class="normal">src2</span><span class="symbol">,</span><span class="normal"> dst2</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* src2 + dst2 -&gt; dst2 */</span>

<span class="normal">				mm_res </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_or_si64</span><span class="symbol">(</span><span class="normal">mm_res</span><span class="symbol">,</span><span class="normal"> dst2</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* RED | GREEN -&gt; mm_res */</span>

<span class="normal">				</span><span class="comment">/* blue */</span>
<span class="normal">				src2 </span><span class="symbol">=</span><span class="normal"> src1</span><span class="symbol">;</span><span class="normal"> </span><span class="comment">/* src -&gt; src2 */</span>
<span class="normal">				src2 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_and_si64</span><span class="symbol">(</span><span class="normal">src2</span><span class="symbol">,</span><span class="normal"> bmask</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* src &amp; MASKBLUE -&gt; src2[000b 000b 000b 000b] */</span>

<span class="normal">				dst2 </span><span class="symbol">=</span><span class="normal"> dst1</span><span class="symbol">;</span><span class="normal"> </span><span class="comment">/* dst -&gt; dst2 */</span>
<span class="normal">				dst2 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_and_si64</span><span class="symbol">(</span><span class="normal">dst2</span><span class="symbol">,</span><span class="normal"> bmask</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* dst &amp; MASKBLUE -&gt; dst2[000b 000b 000b 000b] */</span>

<span class="normal">				</span><span class="comment">/* blend */</span>
<span class="normal">				src2 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_sub_pi16</span><span class="symbol">(</span><span class="normal">src2</span><span class="symbol">,</span><span class="normal"> dst2</span><span class="symbol">);</span><span class="comment">/* src - dst -&gt; src2 */</span>
<span class="normal">				src2 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_mullo_pi16</span><span class="symbol">(</span><span class="normal">src2</span><span class="symbol">,</span><span class="normal"> mm_alpha</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* src2 * alpha -&gt; src2 */</span>
<span class="normal">				src2 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_srli_pi16</span><span class="symbol">(</span><span class="normal">src2</span><span class="symbol">,</span><span class="normal"> </span><span class="number">11</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* src2 &gt;&gt; 11 -&gt; src2 */</span>
<span class="normal">				dst2 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_add_pi16</span><span class="symbol">(</span><span class="normal">src2</span><span class="symbol">,</span><span class="normal"> dst2</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* src2 + dst2 -&gt; dst2 */</span>
<span class="normal">				dst2 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_and_si64</span><span class="symbol">(</span><span class="normal">dst2</span><span class="symbol">,</span><span class="normal"> bmask</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* dst2 &amp; MASKBLUE -&gt; dst2 */</span>

<span class="normal">				mm_res </span><span class="symbol">=</span><span class="normal"> </span><span class="function">_mm_or_si64</span><span class="symbol">(</span><span class="normal">mm_res</span><span class="symbol">,</span><span class="normal"> dst2</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* RED | GREEN | BLUE -&gt; mm_res */</span>

<span class="normal">				</span><span class="symbol">*(</span><span class="normal">__m64</span><span class="symbol">*)</span><span class="normal">dstp </span><span class="symbol">=</span><span class="normal"> mm_res</span><span class="symbol">;</span><span class="normal"> </span><span class="comment">/* mm_res -&gt; 4 dst pixels */</span>

<span class="normal">				srcp </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">4</span><span class="symbol">;</span>
<span class="normal">				dstp </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">4</span><span class="symbol">;</span>
<span class="normal">			</span><span class="cbracket">}</span><span class="symbol">,</span><span class="normal"> width</span><span class="symbol">);</span><span class="normal">			</span>
<span class="normal">			srcp </span><span class="symbol">+=</span><span class="normal"> srcskip</span><span class="symbol">;</span>
<span class="normal">			dstp </span><span class="symbol">+=</span><span class="normal"> dstskip</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="function">_mm_empty</span><span class="symbol">();</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>
<span class="preproc">#endif</span><span class="normal"> </span><span class="comment">/* GCC_ASMBLIT, MSVC_ASMBLIT */</span>

<span class="comment">/* fast RGB565-&gt;RGB565 blending with surface alpha */</span>
<span class="keyword">static</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="function">Blit565to565SurfaceAlpha</span><span class="symbol">(</span><span class="usertype">SDL_BlitInfo</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">info</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">	</span><span class="type">unsigned</span><span class="normal"> alpha </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">src</span><span class="symbol">-&gt;</span><span class="normal">alpha</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">alpha </span><span class="symbol">==</span><span class="normal"> </span><span class="number">128</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">Blit16to16SurfaceAlpha128</span><span class="symbol">(</span><span class="normal">info</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0xf7de</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> width </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_width</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> height </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_height</span><span class="symbol">;</span>
<span class="normal">		</span><span class="usertype">Uint16</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">srcp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint16 </span><span class="symbol">*)</span><span class="normal">info</span><span class="symbol">-&gt;</span><span class="normal">s_pixels</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> srcskip </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">s_skip </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">		</span><span class="usertype">Uint16</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dstp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint16 </span><span class="symbol">*)</span><span class="normal">info</span><span class="symbol">-&gt;</span><span class="normal">d_pixels</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> dstskip </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_skip </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">		alpha </span><span class="symbol">&gt;&gt;=</span><span class="normal"> </span><span class="number">3</span><span class="symbol">;</span><span class="normal">	</span><span class="comment">/* downscale alpha to 5 bits */</span>

<span class="normal">		</span><span class="keyword">while</span><span class="symbol">(</span><span class="normal">height</span><span class="symbol">--)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="function">DUFFS_LOOP4</span><span class="symbol">(</span><span class="cbracket">{</span>
<span class="normal">				</span><span class="usertype">Uint32</span><span class="normal"> s </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">srcp</span><span class="symbol">++;</span>
<span class="normal">				</span><span class="usertype">Uint32</span><span class="normal"> d </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dstp</span><span class="symbol">;</span>
<span class="normal">				</span><span class="comment">/*</span>
<span class="comment">				 * shift out the middle component (green) to</span>
<span class="comment">				 * the high 16 bits, and process all three RGB</span>
<span class="comment">				 * components at the same time.</span>
<span class="comment">				 */</span>
<span class="normal">				s </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">s </span><span class="symbol">|</span><span class="normal"> s </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">16</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x07e0f81f</span><span class="symbol">;</span>
<span class="normal">				d </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">d </span><span class="symbol">|</span><span class="normal"> d </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">16</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x07e0f81f</span><span class="symbol">;</span>
<span class="normal">				d </span><span class="symbol">+=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">s </span><span class="symbol">-</span><span class="normal"> d</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> alpha </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">5</span><span class="symbol">;</span>
<span class="normal">				d </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="number">0x07e0f81f</span><span class="symbol">;</span>
<span class="normal">				</span><span class="symbol">*</span><span class="normal">dstp</span><span class="symbol">++</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint16</span><span class="symbol">)(</span><span class="normal">d </span><span class="symbol">|</span><span class="normal"> d </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">16</span><span class="symbol">);</span>
<span class="normal">			</span><span class="cbracket">}</span><span class="symbol">,</span><span class="normal"> width</span><span class="symbol">);</span>
<span class="normal">			srcp </span><span class="symbol">+=</span><span class="normal"> srcskip</span><span class="symbol">;</span>
<span class="normal">			dstp </span><span class="symbol">+=</span><span class="normal"> dstskip</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="comment">/* fast RGB555-&gt;RGB555 blending with surface alpha */</span>
<span class="keyword">static</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="function">Blit555to555SurfaceAlpha</span><span class="symbol">(</span><span class="usertype">SDL_BlitInfo</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">info</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">	</span><span class="type">unsigned</span><span class="normal"> alpha </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">src</span><span class="symbol">-&gt;</span><span class="normal">alpha</span><span class="symbol">;</span><span class="normal"> </span><span class="comment">/* downscale alpha to 5 bits */</span>
<span class="normal">	</span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">alpha </span><span class="symbol">==</span><span class="normal"> </span><span class="number">128</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">Blit16to16SurfaceAlpha128</span><span class="symbol">(</span><span class="normal">info</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0xfbde</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> width </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_width</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> height </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_height</span><span class="symbol">;</span>
<span class="normal">		</span><span class="usertype">Uint16</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">srcp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint16 </span><span class="symbol">*)</span><span class="normal">info</span><span class="symbol">-&gt;</span><span class="normal">s_pixels</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> srcskip </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">s_skip </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">		</span><span class="usertype">Uint16</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dstp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint16 </span><span class="symbol">*)</span><span class="normal">info</span><span class="symbol">-&gt;</span><span class="normal">d_pixels</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> dstskip </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_skip </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">		alpha </span><span class="symbol">&gt;&gt;=</span><span class="normal"> </span><span class="number">3</span><span class="symbol">;</span><span class="normal">		</span><span class="comment">/* downscale alpha to 5 bits */</span>

<span class="normal">		</span><span class="keyword">while</span><span class="symbol">(</span><span class="normal">height</span><span class="symbol">--)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="function">DUFFS_LOOP4</span><span class="symbol">(</span><span class="cbracket">{</span>
<span class="normal">				</span><span class="usertype">Uint32</span><span class="normal"> s </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">srcp</span><span class="symbol">++;</span>
<span class="normal">				</span><span class="usertype">Uint32</span><span class="normal"> d </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dstp</span><span class="symbol">;</span>
<span class="normal">				</span><span class="comment">/*</span>
<span class="comment">				 * shift out the middle component (green) to</span>
<span class="comment">				 * the high 16 bits, and process all three RGB</span>
<span class="comment">				 * components at the same time.</span>
<span class="comment">				 */</span>
<span class="normal">				s </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">s </span><span class="symbol">|</span><span class="normal"> s </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">16</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x03e07c1f</span><span class="symbol">;</span>
<span class="normal">				d </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">d </span><span class="symbol">|</span><span class="normal"> d </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">16</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x03e07c1f</span><span class="symbol">;</span>
<span class="normal">				d </span><span class="symbol">+=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">s </span><span class="symbol">-</span><span class="normal"> d</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> alpha </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">5</span><span class="symbol">;</span>
<span class="normal">				d </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="number">0x03e07c1f</span><span class="symbol">;</span>
<span class="normal">				</span><span class="symbol">*</span><span class="normal">dstp</span><span class="symbol">++</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint16</span><span class="symbol">)(</span><span class="normal">d </span><span class="symbol">|</span><span class="normal"> d </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">16</span><span class="symbol">);</span>
<span class="normal">			</span><span class="cbracket">}</span><span class="symbol">,</span><span class="normal"> width</span><span class="symbol">);</span>
<span class="normal">			srcp </span><span class="symbol">+=</span><span class="normal"> srcskip</span><span class="symbol">;</span>
<span class="normal">			dstp </span><span class="symbol">+=</span><span class="normal"> dstskip</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="comment">/* fast ARGB8888-&gt;RGB565 blending with pixel alpha */</span>
<span class="keyword">static</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="function">BlitARGBto565PixelAlpha</span><span class="symbol">(</span><span class="usertype">SDL_BlitInfo</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">info</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> width </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_width</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> height </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_height</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">Uint32</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">srcp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint32 </span><span class="symbol">*)</span><span class="normal">info</span><span class="symbol">-&gt;</span><span class="normal">s_pixels</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> srcskip </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">s_skip </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">Uint16</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dstp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint16 </span><span class="symbol">*)</span><span class="normal">info</span><span class="symbol">-&gt;</span><span class="normal">d_pixels</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> dstskip </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_skip </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">while</span><span class="symbol">(</span><span class="normal">height</span><span class="symbol">--)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="function">DUFFS_LOOP4</span><span class="symbol">(</span><span class="cbracket">{</span>
<span class="normal">		</span><span class="usertype">Uint32</span><span class="normal"> s </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">srcp</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">unsigned</span><span class="normal"> alpha </span><span class="symbol">=</span><span class="normal"> s </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">27</span><span class="symbol">;</span><span class="normal"> </span><span class="comment">/* downscale alpha to 5 bits */</span>
<span class="normal">		</span><span class="comment">/* </span><span class="todo">FIXME:</span><span class="comment"> Here we special-case opaque alpha since the</span>
<span class="comment">		   compositioning used (&gt;&gt;8 instead of /255) doesn't handle</span>
<span class="comment">		   it correctly. Also special-case alpha=0 for speed?</span>
<span class="comment">		   Benchmark this! */</span>
<span class="normal">		</span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">alpha</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal">   </span>
<span class="normal">		  </span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">alpha </span><span class="symbol">==</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">SDL_ALPHA_OPAQUE </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">3</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		    </span><span class="symbol">*</span><span class="normal">dstp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint16</span><span class="symbol">)((</span><span class="normal">s </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">8</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xf800</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">s </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">5</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x7e0</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">s </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">3</span><span class="normal">  </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x1f</span><span class="symbol">));</span>
<span class="normal">		  </span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		    </span><span class="usertype">Uint32</span><span class="normal"> d </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dstp</span><span class="symbol">;</span>
<span class="normal">		    </span><span class="comment">/*</span>
<span class="comment">		     * convert source and destination to G0RAB65565</span>
<span class="comment">		     * and blend all components at the same time</span>
<span class="comment">		     */</span>
<span class="normal">		    s </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">s </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xfc00</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">11</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">s </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">8</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xf800</span><span class="symbol">)</span>
<span class="normal">		      </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">s </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">3</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x1f</span><span class="symbol">);</span>
<span class="normal">		    d </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">d </span><span class="symbol">|</span><span class="normal"> d </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">16</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x07e0f81f</span><span class="symbol">;</span>
<span class="normal">		    d </span><span class="symbol">+=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">s </span><span class="symbol">-</span><span class="normal"> d</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> alpha </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">5</span><span class="symbol">;</span>
<span class="normal">		    d </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="number">0x07e0f81f</span><span class="symbol">;</span>
<span class="normal">		    </span><span class="symbol">*</span><span class="normal">dstp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint16</span><span class="symbol">)(</span><span class="normal">d </span><span class="symbol">|</span><span class="normal"> d </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">16</span><span class="symbol">);</span>
<span class="normal">		  </span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		srcp</span><span class="symbol">++;</span>
<span class="normal">		dstp</span><span class="symbol">++;</span>
<span class="normal">	    </span><span class="cbracket">}</span><span class="symbol">,</span><span class="normal"> width</span><span class="symbol">);</span>
<span class="normal">	    srcp </span><span class="symbol">+=</span><span class="normal"> srcskip</span><span class="symbol">;</span>
<span class="normal">	    dstp </span><span class="symbol">+=</span><span class="normal"> dstskip</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="comment">/* fast ARGB8888-&gt;RGB555 blending with pixel alpha */</span>
<span class="keyword">static</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="function">BlitARGBto555PixelAlpha</span><span class="symbol">(</span><span class="usertype">SDL_BlitInfo</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">info</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> width </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_width</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> height </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_height</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">Uint32</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">srcp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint32 </span><span class="symbol">*)</span><span class="normal">info</span><span class="symbol">-&gt;</span><span class="normal">s_pixels</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> srcskip </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">s_skip </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">Uint16</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dstp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint16 </span><span class="symbol">*)</span><span class="normal">info</span><span class="symbol">-&gt;</span><span class="normal">d_pixels</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> dstskip </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_skip </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">while</span><span class="symbol">(</span><span class="normal">height</span><span class="symbol">--)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="function">DUFFS_LOOP4</span><span class="symbol">(</span><span class="cbracket">{</span>
<span class="normal">		</span><span class="type">unsigned</span><span class="normal"> alpha</span><span class="symbol">;</span>
<span class="normal">		</span><span class="usertype">Uint32</span><span class="normal"> s </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">srcp</span><span class="symbol">;</span>
<span class="normal">		alpha </span><span class="symbol">=</span><span class="normal"> s </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">27</span><span class="symbol">;</span><span class="normal"> </span><span class="comment">/* downscale alpha to 5 bits */</span>
<span class="normal">		</span><span class="comment">/* </span><span class="todo">FIXME:</span><span class="comment"> Here we special-case opaque alpha since the</span>
<span class="comment">		   compositioning used (&gt;&gt;8 instead of /255) doesn't handle</span>
<span class="comment">		   it correctly. Also special-case alpha=0 for speed?</span>
<span class="comment">		   Benchmark this! */</span>
<span class="normal">		</span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">alpha</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal">   </span>
<span class="normal">		  </span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">alpha </span><span class="symbol">==</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">SDL_ALPHA_OPAQUE </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">3</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		    </span><span class="symbol">*</span><span class="normal">dstp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint16</span><span class="symbol">)((</span><span class="normal">s </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">9</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x7c00</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">s </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">6</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x3e0</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">s </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">3</span><span class="normal">  </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x1f</span><span class="symbol">));</span>
<span class="normal">		  </span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		    </span><span class="usertype">Uint32</span><span class="normal"> d </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dstp</span><span class="symbol">;</span>
<span class="normal">		    </span><span class="comment">/*</span>
<span class="comment">		     * convert source and destination to G0RAB65565</span>
<span class="comment">		     * and blend all components at the same time</span>
<span class="comment">		     */</span>
<span class="normal">		    s </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">s </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xf800</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">10</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">s </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">9</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x7c00</span><span class="symbol">)</span>
<span class="normal">		      </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">s </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">3</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x1f</span><span class="symbol">);</span>
<span class="normal">		    d </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">d </span><span class="symbol">|</span><span class="normal"> d </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">16</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x03e07c1f</span><span class="symbol">;</span>
<span class="normal">		    d </span><span class="symbol">+=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">s </span><span class="symbol">-</span><span class="normal"> d</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> alpha </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">5</span><span class="symbol">;</span>
<span class="normal">		    d </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="number">0x03e07c1f</span><span class="symbol">;</span>
<span class="normal">		    </span><span class="symbol">*</span><span class="normal">dstp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint16</span><span class="symbol">)(</span><span class="normal">d </span><span class="symbol">|</span><span class="normal"> d </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">16</span><span class="symbol">);</span>
<span class="normal">		  </span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		srcp</span><span class="symbol">++;</span>
<span class="normal">		dstp</span><span class="symbol">++;</span>
<span class="normal">	    </span><span class="cbracket">}</span><span class="symbol">,</span><span class="normal"> width</span><span class="symbol">);</span>
<span class="normal">	    srcp </span><span class="symbol">+=</span><span class="normal"> srcskip</span><span class="symbol">;</span>
<span class="normal">	    dstp </span><span class="symbol">+=</span><span class="normal"> dstskip</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="comment">/* General (slow) N-&gt;N blending with per-surface alpha */</span>
<span class="keyword">static</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="function">BlitNtoNSurfaceAlpha</span><span class="symbol">(</span><span class="usertype">SDL_BlitInfo</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">info</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> width </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_width</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> height </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_height</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">Uint8</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">src </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">s_pixels</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> srcskip </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">s_skip</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">Uint8</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dst </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_pixels</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> dstskip </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_skip</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">SDL_PixelFormat</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">srcfmt </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">src</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">SDL_PixelFormat</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dstfmt </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">dst</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> srcbpp </span><span class="symbol">=</span><span class="normal"> srcfmt</span><span class="symbol">-&gt;</span><span class="normal">BytesPerPixel</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> dstbpp </span><span class="symbol">=</span><span class="normal"> dstfmt</span><span class="symbol">-&gt;</span><span class="normal">BytesPerPixel</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">unsigned</span><span class="normal"> sA </span><span class="symbol">=</span><span class="normal"> srcfmt</span><span class="symbol">-&gt;</span><span class="normal">alpha</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">unsigned</span><span class="normal"> dA </span><span class="symbol">=</span><span class="normal"> dstfmt</span><span class="symbol">-&gt;</span><span class="normal">Amask </span><span class="symbol">?</span><span class="normal"> SDL_ALPHA_OPAQUE </span><span class="symbol">:</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">sA</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	  </span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal"> height</span><span class="symbol">--</span><span class="normal"> </span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="function">DUFFS_LOOP4</span><span class="symbol">(</span>
<span class="normal">	    </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="usertype">Uint32</span><span class="normal"> Pixel</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">unsigned</span><span class="normal"> sR</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">unsigned</span><span class="normal"> sG</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">unsigned</span><span class="normal"> sB</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">unsigned</span><span class="normal"> dR</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">unsigned</span><span class="normal"> dG</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">unsigned</span><span class="normal"> dB</span><span class="symbol">;</span>
<span class="normal">		</span><span class="function">DISEMBLE_RGB</span><span class="symbol">(</span><span class="normal">src</span><span class="symbol">,</span><span class="normal"> srcbpp</span><span class="symbol">,</span><span class="normal"> srcfmt</span><span class="symbol">,</span><span class="normal"> Pixel</span><span class="symbol">,</span><span class="normal"> sR</span><span class="symbol">,</span><span class="normal"> sG</span><span class="symbol">,</span><span class="normal"> sB</span><span class="symbol">);</span>
<span class="normal">		</span><span class="function">DISEMBLE_RGB</span><span class="symbol">(</span><span class="normal">dst</span><span class="symbol">,</span><span class="normal"> dstbpp</span><span class="symbol">,</span><span class="normal"> dstfmt</span><span class="symbol">,</span><span class="normal"> Pixel</span><span class="symbol">,</span><span class="normal"> dR</span><span class="symbol">,</span><span class="normal"> dG</span><span class="symbol">,</span><span class="normal"> dB</span><span class="symbol">);</span>
<span class="normal">		</span><span class="function">ALPHA_BLEND</span><span class="symbol">(</span><span class="normal">sR</span><span class="symbol">,</span><span class="normal"> sG</span><span class="symbol">,</span><span class="normal"> sB</span><span class="symbol">,</span><span class="normal"> sA</span><span class="symbol">,</span><span class="normal"> dR</span><span class="symbol">,</span><span class="normal"> dG</span><span class="symbol">,</span><span class="normal"> dB</span><span class="symbol">);</span>
<span class="normal">		</span><span class="function">ASSEMBLE_RGBA</span><span class="symbol">(</span><span class="normal">dst</span><span class="symbol">,</span><span class="normal"> dstbpp</span><span class="symbol">,</span><span class="normal"> dstfmt</span><span class="symbol">,</span><span class="normal"> dR</span><span class="symbol">,</span><span class="normal"> dG</span><span class="symbol">,</span><span class="normal"> dB</span><span class="symbol">,</span><span class="normal"> dA</span><span class="symbol">);</span>
<span class="normal">		src </span><span class="symbol">+=</span><span class="normal"> srcbpp</span><span class="symbol">;</span>
<span class="normal">		dst </span><span class="symbol">+=</span><span class="normal"> dstbpp</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="cbracket">}</span><span class="symbol">,</span>
<span class="normal">	    width</span><span class="symbol">);</span>
<span class="normal">	    src </span><span class="symbol">+=</span><span class="normal"> srcskip</span><span class="symbol">;</span>
<span class="normal">	    dst </span><span class="symbol">+=</span><span class="normal"> dstskip</span><span class="symbol">;</span>
<span class="normal">	  </span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="comment">/* General (slow) colorkeyed N-&gt;N blending with per-surface alpha */</span>
<span class="keyword">static</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="function">BlitNtoNSurfaceAlphaKey</span><span class="symbol">(</span><span class="usertype">SDL_BlitInfo</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">info</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> width </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_width</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> height </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_height</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">Uint8</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">src </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">s_pixels</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> srcskip </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">s_skip</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">Uint8</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dst </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_pixels</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> dstskip </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_skip</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">SDL_PixelFormat</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">srcfmt </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">src</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">SDL_PixelFormat</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dstfmt </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">dst</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">Uint32</span><span class="normal"> ckey </span><span class="symbol">=</span><span class="normal"> srcfmt</span><span class="symbol">-&gt;</span><span class="normal">colorkey</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> srcbpp </span><span class="symbol">=</span><span class="normal"> srcfmt</span><span class="symbol">-&gt;</span><span class="normal">BytesPerPixel</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> dstbpp </span><span class="symbol">=</span><span class="normal"> dstfmt</span><span class="symbol">-&gt;</span><span class="normal">BytesPerPixel</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">unsigned</span><span class="normal"> sA </span><span class="symbol">=</span><span class="normal"> srcfmt</span><span class="symbol">-&gt;</span><span class="normal">alpha</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">unsigned</span><span class="normal"> dA </span><span class="symbol">=</span><span class="normal"> dstfmt</span><span class="symbol">-&gt;</span><span class="normal">Amask </span><span class="symbol">?</span><span class="normal"> SDL_ALPHA_OPAQUE </span><span class="symbol">:</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal"> height</span><span class="symbol">--</span><span class="normal"> </span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="function">DUFFS_LOOP4</span><span class="symbol">(</span>
<span class="normal">	    </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="usertype">Uint32</span><span class="normal"> Pixel</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">unsigned</span><span class="normal"> sR</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">unsigned</span><span class="normal"> sG</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">unsigned</span><span class="normal"> sB</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">unsigned</span><span class="normal"> dR</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">unsigned</span><span class="normal"> dG</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">unsigned</span><span class="normal"> dB</span><span class="symbol">;</span>
<span class="normal">		</span><span class="function">RETRIEVE_RGB_PIXEL</span><span class="symbol">(</span><span class="normal">src</span><span class="symbol">,</span><span class="normal"> srcbpp</span><span class="symbol">,</span><span class="normal"> Pixel</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">sA </span><span class="symbol">&amp;&amp;</span><span class="normal"> Pixel </span><span class="symbol">!=</span><span class="normal"> ckey</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		    </span><span class="function">RGB_FROM_PIXEL</span><span class="symbol">(</span><span class="normal">Pixel</span><span class="symbol">,</span><span class="normal"> srcfmt</span><span class="symbol">,</span><span class="normal"> sR</span><span class="symbol">,</span><span class="normal"> sG</span><span class="symbol">,</span><span class="normal"> sB</span><span class="symbol">);</span>
<span class="normal">		    </span><span class="function">DISEMBLE_RGB</span><span class="symbol">(</span><span class="normal">dst</span><span class="symbol">,</span><span class="normal"> dstbpp</span><span class="symbol">,</span><span class="normal"> dstfmt</span><span class="symbol">,</span><span class="normal"> Pixel</span><span class="symbol">,</span><span class="normal"> dR</span><span class="symbol">,</span><span class="normal"> dG</span><span class="symbol">,</span><span class="normal"> dB</span><span class="symbol">);</span>
<span class="normal">		    </span><span class="function">ALPHA_BLEND</span><span class="symbol">(</span><span class="normal">sR</span><span class="symbol">,</span><span class="normal"> sG</span><span class="symbol">,</span><span class="normal"> sB</span><span class="symbol">,</span><span class="normal"> sA</span><span class="symbol">,</span><span class="normal"> dR</span><span class="symbol">,</span><span class="normal"> dG</span><span class="symbol">,</span><span class="normal"> dB</span><span class="symbol">);</span>
<span class="normal">		    </span><span class="function">ASSEMBLE_RGBA</span><span class="symbol">(</span><span class="normal">dst</span><span class="symbol">,</span><span class="normal"> dstbpp</span><span class="symbol">,</span><span class="normal"> dstfmt</span><span class="symbol">,</span><span class="normal"> dR</span><span class="symbol">,</span><span class="normal"> dG</span><span class="symbol">,</span><span class="normal"> dB</span><span class="symbol">,</span><span class="normal"> dA</span><span class="symbol">);</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		src </span><span class="symbol">+=</span><span class="normal"> srcbpp</span><span class="symbol">;</span>
<span class="normal">		dst </span><span class="symbol">+=</span><span class="normal"> dstbpp</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="cbracket">}</span><span class="symbol">,</span>
<span class="normal">	    width</span><span class="symbol">);</span>
<span class="normal">	    src </span><span class="symbol">+=</span><span class="normal"> srcskip</span><span class="symbol">;</span>
<span class="normal">	    dst </span><span class="symbol">+=</span><span class="normal"> dstskip</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="comment">/* General (slow) N-&gt;N blending with pixel alpha */</span>
<span class="keyword">static</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="function">BlitNtoNPixelAlpha</span><span class="symbol">(</span><span class="usertype">SDL_BlitInfo</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">info</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> width </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_width</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> height </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_height</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">Uint8</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">src </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">s_pixels</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> srcskip </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">s_skip</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">Uint8</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dst </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_pixels</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> dstskip </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">d_skip</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">SDL_PixelFormat</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">srcfmt </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">src</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">SDL_PixelFormat</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">dstfmt </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">-&gt;</span><span class="normal">dst</span><span class="symbol">;</span>

<span class="normal">	</span><span class="type">int</span><span class="normal">  srcbpp</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal">  dstbpp</span><span class="symbol">;</span>

<span class="normal">	</span><span class="comment">/* Set up some basic variables */</span>
<span class="normal">	srcbpp </span><span class="symbol">=</span><span class="normal"> srcfmt</span><span class="symbol">-&gt;</span><span class="normal">BytesPerPixel</span><span class="symbol">;</span>
<span class="normal">	dstbpp </span><span class="symbol">=</span><span class="normal"> dstfmt</span><span class="symbol">-&gt;</span><span class="normal">BytesPerPixel</span><span class="symbol">;</span>

<span class="normal">	</span><span class="comment">/* </span><span class="todo">FIXME:</span><span class="comment"> for 8bpp source alpha, this doesn't get opaque values</span>
<span class="comment">	   quite right. for &lt;8bpp source alpha, it gets them very wrong</span>
<span class="comment">	   (check all macros!)</span>
<span class="comment">	   It is unclear whether there is a good general solution that doesn't</span>
<span class="comment">	   need a branch (or a divide). */</span>
<span class="normal">	</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal"> height</span><span class="symbol">--</span><span class="normal"> </span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="function">DUFFS_LOOP4</span><span class="symbol">(</span>
<span class="normal">	    </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="usertype">Uint32</span><span class="normal"> Pixel</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">unsigned</span><span class="normal"> sR</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">unsigned</span><span class="normal"> sG</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">unsigned</span><span class="normal"> sB</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">unsigned</span><span class="normal"> dR</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">unsigned</span><span class="normal"> dG</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">unsigned</span><span class="normal"> dB</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">unsigned</span><span class="normal"> sA</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">unsigned</span><span class="normal"> dA</span><span class="symbol">;</span>
<span class="normal">		</span><span class="function">DISEMBLE_RGBA</span><span class="symbol">(</span><span class="normal">src</span><span class="symbol">,</span><span class="normal"> srcbpp</span><span class="symbol">,</span><span class="normal"> srcfmt</span><span class="symbol">,</span><span class="normal"> Pixel</span><span class="symbol">,</span><span class="normal"> sR</span><span class="symbol">,</span><span class="normal"> sG</span><span class="symbol">,</span><span class="normal"> sB</span><span class="symbol">,</span><span class="normal"> sA</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">sA</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		  </span><span class="function">DISEMBLE_RGBA</span><span class="symbol">(</span><span class="normal">dst</span><span class="symbol">,</span><span class="normal"> dstbpp</span><span class="symbol">,</span><span class="normal"> dstfmt</span><span class="symbol">,</span><span class="normal"> Pixel</span><span class="symbol">,</span><span class="normal"> dR</span><span class="symbol">,</span><span class="normal"> dG</span><span class="symbol">,</span><span class="normal"> dB</span><span class="symbol">,</span><span class="normal"> dA</span><span class="symbol">);</span>
<span class="normal">		  </span><span class="function">ALPHA_BLEND</span><span class="symbol">(</span><span class="normal">sR</span><span class="symbol">,</span><span class="normal"> sG</span><span class="symbol">,</span><span class="normal"> sB</span><span class="symbol">,</span><span class="normal"> sA</span><span class="symbol">,</span><span class="normal"> dR</span><span class="symbol">,</span><span class="normal"> dG</span><span class="symbol">,</span><span class="normal"> dB</span><span class="symbol">);</span>
<span class="normal">		  </span><span class="function">ASSEMBLE_RGBA</span><span class="symbol">(</span><span class="normal">dst</span><span class="symbol">,</span><span class="normal"> dstbpp</span><span class="symbol">,</span><span class="normal"> dstfmt</span><span class="symbol">,</span><span class="normal"> dR</span><span class="symbol">,</span><span class="normal"> dG</span><span class="symbol">,</span><span class="normal"> dB</span><span class="symbol">,</span><span class="normal"> dA</span><span class="symbol">);</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		src </span><span class="symbol">+=</span><span class="normal"> srcbpp</span><span class="symbol">;</span>
<span class="normal">		dst </span><span class="symbol">+=</span><span class="normal"> dstbpp</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="cbracket">}</span><span class="symbol">,</span>
<span class="normal">	    width</span><span class="symbol">);</span>
<span class="normal">	    src </span><span class="symbol">+=</span><span class="normal"> srcskip</span><span class="symbol">;</span>
<span class="normal">	    dst </span><span class="symbol">+=</span><span class="normal"> dstskip</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>


<span class="usertype">SDL_loblit</span><span class="normal"> </span><span class="function">SDL_CalculateAlphaBlit</span><span class="symbol">(</span><span class="usertype">SDL_Surface</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">surface</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> blit_index</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="usertype">SDL_PixelFormat</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">sf </span><span class="symbol">=</span><span class="normal"> surface</span><span class="symbol">-&gt;</span><span class="normal">format</span><span class="symbol">;</span>
<span class="normal">    </span><span class="usertype">SDL_PixelFormat</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">df </span><span class="symbol">=</span><span class="normal"> surface</span><span class="symbol">-&gt;</span><span class="normal">map</span><span class="symbol">-&gt;</span><span class="normal">dst</span><span class="symbol">-&gt;</span><span class="normal">format</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">sf</span><span class="symbol">-&gt;</span><span class="normal">Amask </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="symbol">((</span><span class="normal">surface</span><span class="symbol">-&gt;</span><span class="normal">flags </span><span class="symbol">&amp;</span><span class="normal"> SDL_SRCCOLORKEY</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> SDL_SRCCOLORKEY</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">df</span><span class="symbol">-&gt;</span><span class="normal">BytesPerPixel </span><span class="symbol">==</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> BlitNto1SurfaceAlphaKey</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="keyword">else</span>
<span class="preproc">#if</span><span class="normal"> SDL_ALTIVEC_BLITTERS</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">sf</span><span class="symbol">-&gt;</span><span class="normal">BytesPerPixel </span><span class="symbol">==</span><span class="normal"> </span><span class="number">4</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> df</span><span class="symbol">-&gt;</span><span class="normal">BytesPerPixel </span><span class="symbol">==</span><span class="normal"> </span><span class="number">4</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span>
<span class="normal">	    </span><span class="symbol">!(</span><span class="normal">surface</span><span class="symbol">-&gt;</span><span class="normal">map</span><span class="symbol">-&gt;</span><span class="normal">dst</span><span class="symbol">-&gt;</span><span class="normal">flags </span><span class="symbol">&amp;</span><span class="normal"> SDL_HWSURFACE</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="function">SDL_HasAltiVec</span><span class="symbol">())</span>
<span class="normal">            </span><span class="keyword">return</span><span class="normal"> Blit32to32SurfaceAlphaKeyAltivec</span><span class="symbol">;</span>
<span class="normal">        </span><span class="keyword">else</span>
<span class="preproc">#endif</span>
<span class="normal">            </span><span class="keyword">return</span><span class="normal"> BlitNtoNSurfaceAlphaKey</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="comment">/* Per-surface alpha blits */</span>
<span class="normal">	    </span><span class="keyword">switch</span><span class="symbol">(</span><span class="normal">df</span><span class="symbol">-&gt;</span><span class="normal">BytesPerPixel</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="keyword">case</span><span class="normal"> </span><span class="number">1</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> BlitNto1SurfaceAlpha</span><span class="symbol">;</span>

<span class="normal">	    </span><span class="keyword">case</span><span class="normal"> </span><span class="number">2</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">surface</span><span class="symbol">-&gt;</span><span class="normal">map</span><span class="symbol">-&gt;</span><span class="normal">identity</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		    </span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">df</span><span class="symbol">-&gt;</span><span class="normal">Gmask </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0x7e0</span><span class="symbol">)</span>
<span class="normal">		    </span><span class="cbracket">{</span>
<span class="preproc">#if</span><span class="normal"> MMX_ASMBLIT</span>
<span class="normal">		</span><span class="keyword">if</span><span class="symbol">(</span><span class="function">SDL_HasMMX</span><span class="symbol">())</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> Blit565to565SurfaceAlphaMMX</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">else</span>
<span class="preproc">#endif</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> Blit565to565SurfaceAlpha</span><span class="symbol">;</span>
<span class="normal">		    </span><span class="cbracket">}</span>
<span class="normal">		    </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">df</span><span class="symbol">-&gt;</span><span class="normal">Gmask </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0x3e0</span><span class="symbol">)</span>
<span class="normal">		    </span><span class="cbracket">{</span>
<span class="preproc">#if</span><span class="normal"> MMX_ASMBLIT</span>
<span class="normal">		</span><span class="keyword">if</span><span class="symbol">(</span><span class="function">SDL_HasMMX</span><span class="symbol">())</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> Blit555to555SurfaceAlphaMMX</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">else</span>
<span class="preproc">#endif</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> Blit555to555SurfaceAlpha</span><span class="symbol">;</span>
<span class="normal">		    </span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> BlitNtoNSurfaceAlpha</span><span class="symbol">;</span>

<span class="normal">	    </span><span class="keyword">case</span><span class="normal"> </span><span class="number">4</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">sf</span><span class="symbol">-&gt;</span><span class="normal">Rmask </span><span class="symbol">==</span><span class="normal"> df</span><span class="symbol">-&gt;</span><span class="normal">Rmask</span>
<span class="normal">		   </span><span class="symbol">&amp;&amp;</span><span class="normal"> sf</span><span class="symbol">-&gt;</span><span class="normal">Gmask </span><span class="symbol">==</span><span class="normal"> df</span><span class="symbol">-&gt;</span><span class="normal">Gmask</span>
<span class="normal">		   </span><span class="symbol">&amp;&amp;</span><span class="normal"> sf</span><span class="symbol">-&gt;</span><span class="normal">Bmask </span><span class="symbol">==</span><span class="normal"> df</span><span class="symbol">-&gt;</span><span class="normal">Bmask</span>
<span class="normal">		   </span><span class="symbol">&amp;&amp;</span><span class="normal"> sf</span><span class="symbol">-&gt;</span><span class="normal">BytesPerPixel </span><span class="symbol">==</span><span class="normal"> </span><span class="number">4</span><span class="symbol">)</span>
<span class="normal">		</span><span class="cbracket">{</span>
<span class="preproc">#if</span><span class="normal"> MMX_ASMBLIT</span>
<span class="normal">			</span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">sf</span><span class="symbol">-&gt;</span><span class="normal">Rshift </span><span class="symbol">%</span><span class="normal"> </span><span class="number">8</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span>
<span class="normal">			   </span><span class="symbol">&amp;&amp;</span><span class="normal"> sf</span><span class="symbol">-&gt;</span><span class="normal">Gshift </span><span class="symbol">%</span><span class="normal"> </span><span class="number">8</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span>
<span class="normal">			   </span><span class="symbol">&amp;&amp;</span><span class="normal"> sf</span><span class="symbol">-&gt;</span><span class="normal">Bshift </span><span class="symbol">%</span><span class="normal"> </span><span class="number">8</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span>
<span class="normal">			   </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="function">SDL_HasMMX</span><span class="symbol">())</span>
<span class="normal">			    </span><span class="keyword">return</span><span class="normal"> BlitRGBtoRGBSurfaceAlphaMMX</span><span class="symbol">;</span>
<span class="preproc">#endif</span>
<span class="normal">			</span><span class="keyword">if</span><span class="symbol">((</span><span class="normal">sf</span><span class="symbol">-&gt;</span><span class="normal">Rmask </span><span class="symbol">|</span><span class="normal"> sf</span><span class="symbol">-&gt;</span><span class="normal">Gmask </span><span class="symbol">|</span><span class="normal"> sf</span><span class="symbol">-&gt;</span><span class="normal">Bmask</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0xffffff</span><span class="symbol">)</span>
<span class="normal">			</span><span class="cbracket">{</span>
<span class="preproc">#if</span><span class="normal"> SDL_ALTIVEC_BLITTERS</span>
<span class="normal">				</span><span class="keyword">if</span><span class="symbol">(!(</span><span class="normal">surface</span><span class="symbol">-&gt;</span><span class="normal">map</span><span class="symbol">-&gt;</span><span class="normal">dst</span><span class="symbol">-&gt;</span><span class="normal">flags </span><span class="symbol">&amp;</span><span class="normal"> SDL_HWSURFACE</span><span class="symbol">)</span>
<span class="normal">					</span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="function">SDL_HasAltiVec</span><span class="symbol">())</span>
<span class="normal">					</span><span class="keyword">return</span><span class="normal"> BlitRGBtoRGBSurfaceAlphaAltivec</span><span class="symbol">;</span>
<span class="preproc">#endif</span>
<span class="normal">				</span><span class="keyword">return</span><span class="normal"> BlitRGBtoRGBSurfaceAlpha</span><span class="symbol">;</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="preproc">#if</span><span class="normal"> SDL_ALTIVEC_BLITTERS</span>
<span class="normal">		</span><span class="keyword">if</span><span class="symbol">((</span><span class="normal">sf</span><span class="symbol">-&gt;</span><span class="normal">BytesPerPixel </span><span class="symbol">==</span><span class="normal"> </span><span class="number">4</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span>
<span class="normal">		   </span><span class="symbol">!(</span><span class="normal">surface</span><span class="symbol">-&gt;</span><span class="normal">map</span><span class="symbol">-&gt;</span><span class="normal">dst</span><span class="symbol">-&gt;</span><span class="normal">flags </span><span class="symbol">&amp;</span><span class="normal"> SDL_HWSURFACE</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="function">SDL_HasAltiVec</span><span class="symbol">())</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> Blit32to32SurfaceAlphaAltivec</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">else</span>
<span class="preproc">#endif</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> BlitNtoNSurfaceAlpha</span><span class="symbol">;</span>

<span class="normal">	    </span><span class="keyword">case</span><span class="normal"> </span><span class="number">3</span><span class="symbol">:</span>
<span class="label">	    default:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> BlitNtoNSurfaceAlpha</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">    </span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="comment">/* Per-pixel alpha blits */</span>
<span class="normal">	</span><span class="keyword">switch</span><span class="symbol">(</span><span class="normal">df</span><span class="symbol">-&gt;</span><span class="normal">BytesPerPixel</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> </span><span class="number">1</span><span class="symbol">:</span>
<span class="normal">	    </span><span class="keyword">return</span><span class="normal"> BlitNto1PixelAlpha</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> </span><span class="number">2</span><span class="symbol">:</span>
<span class="preproc">#if</span><span class="normal"> SDL_ALTIVEC_BLITTERS</span>
<span class="normal">	</span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">sf</span><span class="symbol">-&gt;</span><span class="normal">BytesPerPixel </span><span class="symbol">==</span><span class="normal"> </span><span class="number">4</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">!(</span><span class="normal">surface</span><span class="symbol">-&gt;</span><span class="normal">map</span><span class="symbol">-&gt;</span><span class="normal">dst</span><span class="symbol">-&gt;</span><span class="normal">flags </span><span class="symbol">&amp;</span><span class="normal"> SDL_HWSURFACE</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span>
<span class="normal">           df</span><span class="symbol">-&gt;</span><span class="normal">Gmask </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0x7e0</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span>
<span class="normal">	   df</span><span class="symbol">-&gt;</span><span class="normal">Bmask </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0x1f</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="function">SDL_HasAltiVec</span><span class="symbol">())</span>
<span class="normal">            </span><span class="keyword">return</span><span class="normal"> Blit32to565PixelAlphaAltivec</span><span class="symbol">;</span>
<span class="normal">        </span><span class="keyword">else</span>
<span class="preproc">#endif</span>
<span class="normal">	    </span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">sf</span><span class="symbol">-&gt;</span><span class="normal">BytesPerPixel </span><span class="symbol">==</span><span class="normal"> </span><span class="number">4</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> sf</span><span class="symbol">-&gt;</span><span class="normal">Amask </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0xff000000</span>
<span class="normal">	       </span><span class="symbol">&amp;&amp;</span><span class="normal"> sf</span><span class="symbol">-&gt;</span><span class="normal">Gmask </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0xff00</span>
<span class="normal">	       </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">sf</span><span class="symbol">-&gt;</span><span class="normal">Rmask </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0xff</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> df</span><span class="symbol">-&gt;</span><span class="normal">Rmask </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0x1f</span><span class="symbol">)</span>
<span class="normal">		   </span><span class="symbol">||</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">sf</span><span class="symbol">-&gt;</span><span class="normal">Bmask </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0xff</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> df</span><span class="symbol">-&gt;</span><span class="normal">Bmask </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0x1f</span><span class="symbol">)))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">df</span><span class="symbol">-&gt;</span><span class="normal">Gmask </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0x7e0</span><span class="symbol">)</span>
<span class="normal">		    </span><span class="keyword">return</span><span class="normal"> BlitARGBto565PixelAlpha</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">df</span><span class="symbol">-&gt;</span><span class="normal">Gmask </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0x3e0</span><span class="symbol">)</span>
<span class="normal">		    </span><span class="keyword">return</span><span class="normal"> BlitARGBto555PixelAlpha</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	    </span><span class="keyword">return</span><span class="normal"> BlitNtoNPixelAlpha</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> </span><span class="number">4</span><span class="symbol">:</span>
<span class="normal">	    </span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">sf</span><span class="symbol">-&gt;</span><span class="normal">Rmask </span><span class="symbol">==</span><span class="normal"> df</span><span class="symbol">-&gt;</span><span class="normal">Rmask</span>
<span class="normal">	       </span><span class="symbol">&amp;&amp;</span><span class="normal"> sf</span><span class="symbol">-&gt;</span><span class="normal">Gmask </span><span class="symbol">==</span><span class="normal"> df</span><span class="symbol">-&gt;</span><span class="normal">Gmask</span>
<span class="normal">	       </span><span class="symbol">&amp;&amp;</span><span class="normal"> sf</span><span class="symbol">-&gt;</span><span class="normal">Bmask </span><span class="symbol">==</span><span class="normal"> df</span><span class="symbol">-&gt;</span><span class="normal">Bmask</span>
<span class="normal">	       </span><span class="symbol">&amp;&amp;</span><span class="normal"> sf</span><span class="symbol">-&gt;</span><span class="normal">BytesPerPixel </span><span class="symbol">==</span><span class="normal"> </span><span class="number">4</span><span class="symbol">)</span>
<span class="normal">	    </span><span class="cbracket">{</span>
<span class="preproc">#if</span><span class="normal"> MMX_ASMBLIT</span>
<span class="normal">		</span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">sf</span><span class="symbol">-&gt;</span><span class="normal">Rshift </span><span class="symbol">%</span><span class="normal"> </span><span class="number">8</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span>
<span class="normal">		   </span><span class="symbol">&amp;&amp;</span><span class="normal"> sf</span><span class="symbol">-&gt;</span><span class="normal">Gshift </span><span class="symbol">%</span><span class="normal"> </span><span class="number">8</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span>
<span class="normal">		   </span><span class="symbol">&amp;&amp;</span><span class="normal"> sf</span><span class="symbol">-&gt;</span><span class="normal">Bshift </span><span class="symbol">%</span><span class="normal"> </span><span class="number">8</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span>
<span class="normal">		   </span><span class="symbol">&amp;&amp;</span><span class="normal"> sf</span><span class="symbol">-&gt;</span><span class="normal">Ashift </span><span class="symbol">%</span><span class="normal"> </span><span class="number">8</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span>
<span class="normal">		   </span><span class="symbol">&amp;&amp;</span><span class="normal"> sf</span><span class="symbol">-&gt;</span><span class="normal">Aloss </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">		</span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">if</span><span class="symbol">(</span><span class="function">SDL_Has3DNow</span><span class="symbol">())</span>
<span class="normal">				</span><span class="keyword">return</span><span class="normal"> BlitRGBtoRGBPixelAlphaMMX3DNOW</span><span class="symbol">;</span>
<span class="normal">			</span><span class="keyword">if</span><span class="symbol">(</span><span class="function">SDL_HasMMX</span><span class="symbol">())</span>
<span class="normal">				</span><span class="keyword">return</span><span class="normal"> BlitRGBtoRGBPixelAlphaMMX</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="preproc">#endif</span>
<span class="normal">		</span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">sf</span><span class="symbol">-&gt;</span><span class="normal">Amask </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0xff000000</span><span class="symbol">)</span>
<span class="normal">		</span><span class="cbracket">{</span>
<span class="preproc">#if</span><span class="normal"> SDL_ALTIVEC_BLITTERS</span>
<span class="normal">			</span><span class="keyword">if</span><span class="symbol">(!(</span><span class="normal">surface</span><span class="symbol">-&gt;</span><span class="normal">map</span><span class="symbol">-&gt;</span><span class="normal">dst</span><span class="symbol">-&gt;</span><span class="normal">flags </span><span class="symbol">&amp;</span><span class="normal"> SDL_HWSURFACE</span><span class="symbol">)</span>
<span class="normal">				</span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="function">SDL_HasAltiVec</span><span class="symbol">())</span>
<span class="normal">				</span><span class="keyword">return</span><span class="normal"> BlitRGBtoRGBPixelAlphaAltivec</span><span class="symbol">;</span>
<span class="preproc">#endif</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> BlitRGBtoRGBPixelAlpha</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="preproc">#if</span><span class="normal"> SDL_ALTIVEC_BLITTERS</span>
<span class="normal">	    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">sf</span><span class="symbol">-&gt;</span><span class="normal">Amask </span><span class="symbol">&amp;&amp;</span><span class="normal"> sf</span><span class="symbol">-&gt;</span><span class="normal">BytesPerPixel </span><span class="symbol">==</span><span class="normal"> </span><span class="number">4</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span>
<span class="normal">	        </span><span class="symbol">!(</span><span class="normal">surface</span><span class="symbol">-&gt;</span><span class="normal">map</span><span class="symbol">-&gt;</span><span class="normal">dst</span><span class="symbol">-&gt;</span><span class="normal">flags </span><span class="symbol">&amp;</span><span class="normal"> SDL_HWSURFACE</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="function">SDL_HasAltiVec</span><span class="symbol">())</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> Blit32to32PixelAlphaAltivec</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="keyword">else</span>
<span class="preproc">#endif</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> BlitNtoNPixelAlpha</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> </span><span class="number">3</span><span class="symbol">:</span>
<span class="label">	default:</span>
<span class="normal">	    </span><span class="keyword">return</span><span class="normal"> BlitNtoNPixelAlpha</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="cbracket">}</span>

</tt></pre></div><footer><div style="text-align: right; padding: 8pt; font-size: 13px"><a href="/xmlfeed/weblog-rss20.xml"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAAAPAgMAAAAOp6AcAAAADFBMVEVmZmb/ZgD///+JjnlbTUWmAAAACXBIWXMAAABIAAAASABGyWs+AAAACXZwQWcAAABQAAAADwCexKkxAAAAWUlEQVQYlWNgwAa0VmGAFQyqoSCQ/x8J/CBFMCt0ZdTU/F/7/+1HEkydFpoKVPn+93sUlUujQvP/7UcRTAuNDJ2a//s/imDqtKVZofm/1qGYSZk7sfodGwAAiobBJtffoNAAAAAASUVORK5CYII=" alt="RSS 2.0 Weblog Feed" width="80" height="15"/></a> <a href="/xmlfeed/weblog-atom10.xml"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAAAPAgMAAAAOp6AcAAAADFBMVEVmZmb/ZgD///+JjnlbTUWmAAAAaklEQVQYlWNgwAa0VmGAFQyqoSCQ/x8J/CBFMDV16rTQ/H/7V//69+//v/3/9oMEI6cuAwr+fv/+/b5d///v//0eJBgWOhMo+Gs9UPAdXDBy6lSYyn9wQZCZS0GCYDPXQcykzJ1Y/Y4NAABKvL80wyoMPgAAAABJRU5ErkJggg==" alt="Atom 1.0 Weblog Feed" width="80" height="15"/></a> <a href="http://validator.w3.org/check?uri=referer"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAAAPCAMAAABEF7i9AAAB1FBMVEUHQIgIRY0MN4QNRYoSRYsXUpIYVJQeUpUhWpgjUJMjWpgmU5QnXJkuYZ0uYpwwV5YyZJ4zaKM3ZaA5aaI6aqM6a6E8ZqA8Z6BAbaRBbqdCbaVHd61KSkpKcaZQUFBUf69UgbBVVVVXfq9Yg7NZhbJZh7RagrNeXVxeh7RfjLdgYGBiiLZmZmZnZ2doirhpkbt0m8F3m8B3ncJ5lb55ocR+ocSDgX+Do8eEpMqGhoaHp8iIpMeJjnmJpseKqMeOqsqPsdCQrcyVlZWVsM2Zs9CZtNCfu9ahoaGhuNShudSivNSjtMWjvNSmpqWnpqSrw9qvxNqyxdmyxdyzsK6zs7Ozx9y0xt21yN22tra4y+K80eK/v7/AwMDExMTEy9DH2ejK2+jM2ujN3uvP0dLR0NDR3uvS3uvS3+zU4u3V1dXY2dnY4u7Y4+3b5e/d3d3d5u/d5/De3t7f39/h4uLj4uHj6/Ll7PXm7fTn7/Xo7/Tp7/bq7Ozr6unr8ffw8PDw9vvx9fny+P7z8/Pz9vnz9vv3+fv4+vz5+vz6+vr6+/36/P36///7+/77/Pz7/f37/f78/Pz8/f38/f79/f39/f79/f/9/v79///+/v7+/v////3///+tYR2LAAABKklEQVQ4y2PQoTJg0JlNVYDPQBsyAMTAqaFes8tdsmdPCtA3MDStr3GKKK6myMAprgJ9pcpWs/MlRExYJBvNZLR0sigycHYOV1S7mtjsQJ4gf+HIFPXoWMs6qIGzIRiKZs9GFoEaMRuZhhrYqqJXy8uZYauRxC/VHew7e3YTPAxnI5swG6JxNrKBNjB1EFmIgV0+HA6C8pqqzhXG7BbJJROQIwViMYQ7G2oDQQNn57JyG7kxiCfObrBmS5+BHMuYLkTzMnYDm5WY4lOZZRPKZocxes+aPbuwCFsYohiICLvZsKBAMrDTQ7K/StveU8icTzrOL8JdLpOyWJ49u8Bx9ozw8DY7UYW03hhdxZAOSg2c3jN79rSJs1vSKmfOnpFXNJmynELlvExlAADnaZpLFGEC2wAAAABJRU5ErkJggg==" alt="Valid XHTML 1.1" width="80" height="15"/></a> <a href="http://jigsaw.w3.org/css-validator/check/referer"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAAAPCAMAAABEF7i9AAAB1FBMVEUHQIgIRY0MN4QNRYoSRYsXUpIYVJQeUpUhWpgjUJMjWpgmU5QnXJkuYZ0uYpwwV5YyZJ4zaKM3ZaA5aaI6aqM6a6E8ZqA8Z6BAbaRBbqdCbaVHd61KSkpKcaZQUFBUf69UgbBVVVVXfq9Yg7NZhbJZh7RagrNeXVxeh7RfjLdgYGBiiLZmZmZnZ2doirhpkbt0m8F3m8B3ncJ5lb55ocR+ocSDgX+Do8eEpMqGhoaHp8iIpMeJjnmJpseKqMeOqsqPsdCQrcyVlZWVsM2Zs9CZtNCfu9ahoaGhuNShudSivNSjtMWjvNSmpqWnpqSrw9qvxNqyxdmyxdyzsK6zs7Ozx9y0xt21yN22tra4y+K80eK/v7/AwMDExMTEy9DH2ejK2+jM2ujN3uvP0dLR0NDR3uvS3uvS3+zU4u3V1dXY2dnY4u7Y4+3b5e/d3d3d5u/d5/De3t7f39/h4uLj4uHj6/Ll7PXm7fTn7/Xo7/Tp7/bq7Ozr6unr8ffw8PDw9vvx9fny+P7z8/Pz9vnz9vv3+fv4+vz5+vz6+vr6+/36/P36///7+/77/Pz7/f37/f78/Pz8/f38/f79/f39/f79/f/9/v79///+/v7+/v////3///+tYR2LAAABEUlEQVQ4y2PQoTJg0JlNVYDPQBsyAMTAqaFes8tdsmdPCtA3MDStr3GKKK6myMAprgJ9pcpWs/MlRExYJBvNZLR0sigycHYOV1S7mtjsQJ4gf+HIFPXoWMs6mIEQCsIjwhKoga0qerW8nBm2Gkn8Ut3BvrNnN8HCcDYM2cBIogzs8uFwEJTXVHWuMGa3SC6ZgIgUqCEwdxJr4OxcVm4jNwbxxNkN1mzpM2ajGIjsPGK9PLtZiSk+lVk2oWx2GKP3rNmzC4tQwpDoIIQb2Okh2V+lbe8pZM4nHecX4S6XSVksz55d4Dh7Rnh4m52oQlpvjK5iSAelBk7vmT172sTZLWmVM2fPyCuaTFlOoXJepjIAANlljDGY/l5pAAAAAElFTkSuQmCC" alt="Valid CSS (2.1)" width="80" height="15"/></a><br/>Copyright 2005-2020 <a href="/about/">Timo Bingmann</a> - <a href="/about/impressum.html">Impressum</a></div></footer></body></html>