<?xml version="1.0" encoding="iso-8859-1"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta content="text/html; charset=iso-8859-1" http-equiv="content-type" /><meta name="viewport" content="initial-scale=1"><title>/2006/SDIOS06/sdios06/lib/SDL/video/SDL_yuv_mmx.c - panthema.net</title><link rel="stylesheet" type="text/css" href="/css/base.css" /><link rel="stylesheet" type="text/css" href="/css/fonts.css" /><link rel="alternate" type="application/rss+xml" title="panthema.net Weblog Feed RSS 2.0" href="https://panthema.net/xmlfeed/weblog-rss20.xml" /><link rel="alternate" type="application/atom+xml" title="panthema.net Weblog Feed Atom 1.0" href="https://panthema.net/xmlfeed/weblog-atom10.xml" /><script type="text/javascript" src="/js/base.js"></script><script type="text/javascript">/* <!-- */makeIEHover = function() {var lis = document.getElementById('ptnav').getElementsByTagName('li');for (var i = 0; i < lis.length; i++) {lis[i].onmouseover = function() {this.className += ' sfhover';};lis[i].onmouseout = function() {this.className = this.className.replace(new RegExp(' sfhover\b'), '');};}};if (window.attachEvent) window.attachEvent('onload', makeIEHover);/* --> */</script></head><body lang="en"><div class="pttopbar"><div style="float: right"><ul id="ptnav"><li class="top"><a class="ni" href="/timeline/"><i class="icon-book"></i> Weblog</a><ul style="margin-left: -6px; margin-top: 4px" class="nx"><li><a href="/2020/">2020</a></li><li><a href="/2019/">2019</a></li><li><a href="/2018/">2018</a></li><li><a href="/2017/">2017</a></li><li><a href="/2016/">2016</a></li><li><a href="/2015/">2015</a></li><li><a href="/2014/">2014</a></li><li><a href="/2013/">2013</a></li><li><a href="/2012/">2012</a></li><li><a href="/2011/">2011</a></li><li><a href="/2010/">2010</a></li><li><a href="/2009/">2009</a></li><li><a href="/2008/">2008</a></li><li><a href="/2007/">2007</a></li><li><a href="/2006/">2006</a></li><li class="nt"><a href="/2005/">2005</a></li><li class="ns"><a href="/xmlfeed/weblog-rss20.xml">RSS Feed</a></li><li class="nt"><a href="/xmlfeed/weblog-atom10.xml">XML Atom</a></li></ul></li><li class="top"> <a class="ni" href="/tags/"><i class="icon-tags"></i> Tags</a></li><li class="top"> <a class="ni" href="#"><i class="icon-cubes"></i> Projects</a> <ul style="margin-left: -8em; margin-top: 4px;" class="nx"> <li><a href="/2019/1008-COBS-A-Compact-Bit-Sliced-Signature-Index/">COBS</a></li> <li><a href="/2009/cryptote/">CryptoTE</a></li> <li><a href="/2009/digup/">digup</a></li> <li><a href="/2013/disk-filltest/">disk-filltest</a></li> <li><a href="/2012/1119-eSAIS-Inducing-Suffix-and-LCP-Arrays-in-External-Memory/">eSAIS-LCP</a></li> <li><a href="/2007/flex-bison-cpp-example/">Flex Bison C++ Example</a></li> <li><a href="/2013/malloc_count/">malloc_count</a></li> <li><a href="/2016/0114-diploma-thesis/">On Bispanning Graphs</a></li> <li><a href="/2013/pmbw/">Parallel Memory Bandwidth</a></li> <li><a href="/2013/parallel-string-sorting/">Parallel String Sorting</a></li> <li><a href="/2014/sqlplot-tools/">SqlPlotTools</a></li> <li><a href="/2013/sound-of-sorting/">The Sound of Sorting</a></li> <li><a href="/2007/stx-btree/">STX B+ Tree</a></li> <li><a href="/2010/stx-cbtreedb/">STX Constant BTreeDB</a></li> <li><a href="/2010/stx-execpipe/">STX ExecPipe</a></li> <li><a href="/2007/stx-exparser/">STX Expression Parser</a></li> <li><a href="/tags/stxxl.html">STXXL 1.4</a></li> <li><a href="/tags/thrill.html">Thrill - Big Data Framework</a></li> <li class="nt"><a href="/2014/vncrec-rgb/">VNCrec RGB 0.4</a></li> </ul></li><li class="top"> <a class="ni" href="/publications.html"><i class="icon-graduation-cap"></i> Publications</a></li><li class="top"> <a class="ni" href="/search.html"><i class="icon-search"></i> Search</a></li><li class="top"> <a class="ni" href="/subscribe.html"><i class="icon-rss-squared"></i> Subscribe</a></li><li class="top"> <a class="ni" href="/about/"><i class="icon-info-circled"></i> About</a></li></ul></div><div style="padding: 6px"><a href="/">panthema</a>  / <a href="/2006/">2006</a> / <a href="/2006/SDIOS06/">SDIOS06</a> / <a href="/2006/SDIOS06/sdios06/">sdios06</a> / <a href="/2006/SDIOS06/sdios06/lib/">lib</a> / <a href="/2006/SDIOS06/sdios06/lib/SDL/">SDL</a> / <a href="/2006/SDIOS06/sdios06/lib/SDL/video/">video</a> / <a href="/2006/SDIOS06/sdios06/lib/SDL/video/SDL_yuv_mmx.c.html">SDL_yuv_mmx.c</a> (<a href="/2006/SDIOS06/sdios06/lib/SDL/video/SDL_yuv_mmx.c">Download File</a>)</div></div><div class="ptfullwidth"><pre class="codesnippet" style="font-family: monospace"><tt><span class="comment">/*</span>
<span class="comment">    SDL - Simple DirectMedia Layer</span>
<span class="comment">    Copyright (C) 1997-2006 Sam Lantinga</span>

<span class="comment">    This library is free software; you can redistribute it and/or</span>
<span class="comment">    modify it under the terms of the GNU Lesser General Public</span>
<span class="comment">    License as published by the Free Software Foundation; either</span>
<span class="comment">    version 2.1 of the License, or (at your option) any later version.</span>

<span class="comment">    This library is distributed in the hope that it will be useful,</span>
<span class="comment">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="comment">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="comment">    Lesser General Public License for more details.</span>

<span class="comment">    You should have received a copy of the GNU Lesser General Public</span>
<span class="comment">    License along with this library; if not, write to the Free Software</span>
<span class="comment">    Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA</span>

<span class="comment">    Sam Lantinga</span>
<span class="comment">    </span><span class="url">slouken@libsdl.org</span>
<span class="comment">*/</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">"SDL_config.h"</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="number">0</span><span class="normal"> </span><span class="comment">/* </span><span class="todo">FIXME:</span><span class="comment"> This code needs to be rewritten to reference the static data using relocatable addresses (e.g. </span><span class="url">http://www.gentoo.org/proj/en/hardened/pic-fix-guide.xml</span><span class="comment"> or </span><span class="url">http://nasm.sourceforge.net/doc/html/nasmdoc8.html</span><span class="comment">#section-8.2) This code currently breaks on systems with readonly text segments (hardened Linux / Intel Mac) */</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">__GNUC__</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">__i386__</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> SDL_ASSEMBLY_ROUTINES</span>

<span class="preproc">#include</span><span class="normal"> </span><span class="string">"SDL_stdinc.h"</span>

<span class="preproc">#define</span><span class="normal"> </span><span class="function">ASM_ARRAY</span><span class="symbol">(</span><span class="normal">x</span><span class="symbol">)</span><span class="normal"> x</span><span class="symbol">[]</span><span class="normal"> </span><span class="function">__asm__</span><span class="symbol">(</span><span class="string">"_"</span><span class="normal"> #x</span><span class="symbol">)</span><span class="normal"> </span><span class="function">__attribute__</span><span class="symbol">((</span><span class="normal">used</span><span class="symbol">))</span>
<span class="normal"> </span>
<span class="keyword">static</span><span class="normal"> </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal">  </span><span class="function">ASM_ARRAY</span><span class="symbol">(</span><span class="normal">MMX_0080w</span><span class="symbol">)</span><span class="normal">    </span><span class="symbol">=</span><span class="normal"> </span><span class="cbracket">{</span><span class="number">0x00800080</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x00800080</span><span class="cbracket">}</span><span class="symbol">;</span>
<span class="keyword">static</span><span class="normal"> </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal">  </span><span class="function">ASM_ARRAY</span><span class="symbol">(</span><span class="normal">MMX_00FFw</span><span class="symbol">)</span><span class="normal">    </span><span class="symbol">=</span><span class="normal"> </span><span class="cbracket">{</span><span class="number">0x00ff00ff</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x00ff00ff</span><span class="cbracket">}</span><span class="symbol">;</span>
<span class="keyword">static</span><span class="normal"> </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal">  </span><span class="function">ASM_ARRAY</span><span class="symbol">(</span><span class="normal">MMX_FF00w</span><span class="symbol">)</span><span class="normal">    </span><span class="symbol">=</span><span class="normal"> </span><span class="cbracket">{</span><span class="number">0xff00ff00</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0xff00ff00</span><span class="cbracket">}</span><span class="symbol">;</span>

<span class="keyword">static</span><span class="normal"> </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">short</span><span class="normal"> </span><span class="function">ASM_ARRAY</span><span class="symbol">(</span><span class="normal">MMX_Ycoeff</span><span class="symbol">)</span><span class="normal">  </span><span class="symbol">=</span><span class="normal"> </span><span class="cbracket">{</span><span class="number">0x004a</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x004a</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x004a</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x004a</span><span class="cbracket">}</span><span class="symbol">;</span>

<span class="keyword">static</span><span class="normal"> </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">short</span><span class="normal"> </span><span class="function">ASM_ARRAY</span><span class="symbol">(</span><span class="normal">MMX_UbluRGB</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="cbracket">{</span><span class="number">0x0072</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x0072</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x0072</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x0072</span><span class="cbracket">}</span><span class="symbol">;</span>
<span class="keyword">static</span><span class="normal"> </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">short</span><span class="normal"> </span><span class="function">ASM_ARRAY</span><span class="symbol">(</span><span class="normal">MMX_VredRGB</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="cbracket">{</span><span class="number">0x0059</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x0059</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x0059</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x0059</span><span class="cbracket">}</span><span class="symbol">;</span>
<span class="keyword">static</span><span class="normal"> </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">short</span><span class="normal"> </span><span class="function">ASM_ARRAY</span><span class="symbol">(</span><span class="normal">MMX_UgrnRGB</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="cbracket">{</span><span class="number">0xffea</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0xffea</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0xffea</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0xffea</span><span class="cbracket">}</span><span class="symbol">;</span>
<span class="keyword">static</span><span class="normal"> </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">short</span><span class="normal"> </span><span class="function">ASM_ARRAY</span><span class="symbol">(</span><span class="normal">MMX_VgrnRGB</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="cbracket">{</span><span class="number">0xffd2</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0xffd2</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0xffd2</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0xffd2</span><span class="cbracket">}</span><span class="symbol">;</span>

<span class="keyword">static</span><span class="normal"> </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">short</span><span class="normal"> </span><span class="function">ASM_ARRAY</span><span class="symbol">(</span><span class="normal">MMX_Ublu5x5</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="cbracket">{</span><span class="number">0x0081</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x0081</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x0081</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x0081</span><span class="cbracket">}</span><span class="symbol">;</span>
<span class="keyword">static</span><span class="normal"> </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">short</span><span class="normal"> </span><span class="function">ASM_ARRAY</span><span class="symbol">(</span><span class="normal">MMX_Vred5x5</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="cbracket">{</span><span class="number">0x0066</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x0066</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x0066</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x0066</span><span class="cbracket">}</span><span class="symbol">;</span>
<span class="keyword">static</span><span class="normal"> </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">short</span><span class="normal"> </span><span class="function">ASM_ARRAY</span><span class="symbol">(</span><span class="normal">MMX_Ugrn555</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="cbracket">{</span><span class="number">0xffe7</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0xffe7</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0xffe7</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0xffe7</span><span class="cbracket">}</span><span class="symbol">;</span>
<span class="keyword">static</span><span class="normal"> </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">short</span><span class="normal"> </span><span class="function">ASM_ARRAY</span><span class="symbol">(</span><span class="normal">MMX_Vgrn555</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="cbracket">{</span><span class="number">0xffcc</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0xffcc</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0xffcc</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0xffcc</span><span class="cbracket">}</span><span class="symbol">;</span>
<span class="keyword">static</span><span class="normal"> </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">short</span><span class="normal"> </span><span class="function">ASM_ARRAY</span><span class="symbol">(</span><span class="normal">MMX_Ugrn565</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="cbracket">{</span><span class="number">0xffe8</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0xffe8</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0xffe8</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0xffe8</span><span class="cbracket">}</span><span class="symbol">;</span>
<span class="keyword">static</span><span class="normal"> </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">short</span><span class="normal"> </span><span class="function">ASM_ARRAY</span><span class="symbol">(</span><span class="normal">MMX_Vgrn565</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="cbracket">{</span><span class="number">0xffcd</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0xffcd</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0xffcd</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0xffcd</span><span class="cbracket">}</span><span class="symbol">;</span>

<span class="keyword">static</span><span class="normal"> </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">short</span><span class="normal"> </span><span class="function">ASM_ARRAY</span><span class="symbol">(</span><span class="normal">MMX_red555</span><span class="symbol">)</span><span class="normal">  </span><span class="symbol">=</span><span class="normal"> </span><span class="cbracket">{</span><span class="number">0x7c00</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x7c00</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x7c00</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x7c00</span><span class="cbracket">}</span><span class="symbol">;</span>
<span class="keyword">static</span><span class="normal"> </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">short</span><span class="normal"> </span><span class="function">ASM_ARRAY</span><span class="symbol">(</span><span class="normal">MMX_red565</span><span class="symbol">)</span><span class="normal">  </span><span class="symbol">=</span><span class="normal"> </span><span class="cbracket">{</span><span class="number">0xf800</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0xf800</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0xf800</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0xf800</span><span class="cbracket">}</span><span class="symbol">;</span>
<span class="keyword">static</span><span class="normal"> </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">short</span><span class="normal"> </span><span class="function">ASM_ARRAY</span><span class="symbol">(</span><span class="normal">MMX_grn555</span><span class="symbol">)</span><span class="normal">  </span><span class="symbol">=</span><span class="normal"> </span><span class="cbracket">{</span><span class="number">0x03e0</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x03e0</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x03e0</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x03e0</span><span class="cbracket">}</span><span class="symbol">;</span>
<span class="keyword">static</span><span class="normal"> </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">short</span><span class="normal"> </span><span class="function">ASM_ARRAY</span><span class="symbol">(</span><span class="normal">MMX_grn565</span><span class="symbol">)</span><span class="normal">  </span><span class="symbol">=</span><span class="normal"> </span><span class="cbracket">{</span><span class="number">0x07e0</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x07e0</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x07e0</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x07e0</span><span class="cbracket">}</span><span class="symbol">;</span>
<span class="keyword">static</span><span class="normal"> </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">short</span><span class="normal"> </span><span class="function">ASM_ARRAY</span><span class="symbol">(</span><span class="normal">MMX_blu5x5</span><span class="symbol">)</span><span class="normal">  </span><span class="symbol">=</span><span class="normal"> </span><span class="cbracket">{</span><span class="number">0x001f</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x001f</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x001f</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x001f</span><span class="cbracket">}</span><span class="symbol">;</span>

<span class="comment">/**</span>
<span class="comment">   This MMX assembler is my first assembler/MMX program ever.</span>
<span class="comment">   Thus it maybe buggy.</span>
<span class="comment">   Send patches to:</span>
<span class="comment">   </span><span class="url">mvogt@rhrk.uni-kl.de</span>

<span class="comment">   After it worked fine I have "obfuscated" the code a bit to have</span>
<span class="comment">   more parallism in the MMX units. This means I moved</span>
<span class="comment">   initilisation around and delayed other instruction.</span>
<span class="comment">   Performance measurement did not show that this brought any advantage</span>
<span class="comment">   but in theory it _should_ be faster this way.</span>

<span class="comment">   The overall performanve gain to the C based dither was 30%-40%.</span>
<span class="comment">   The MMX routine calculates 256bit=8RGB values in each cycle</span>
<span class="comment">   (4 for row1 &amp; 4 for row2)</span>

<span class="comment">   The red/green/blue.. coefficents are taken from the mpeg_play </span>
<span class="comment">   player. They look nice, but I dont know if you can have</span>
<span class="comment">   better values, to avoid integer rounding errors.</span>
<span class="comment">   </span>

<span class="comment">   IMPORTANT:</span>
<span class="comment">   ==========</span>

<span class="comment">   It is a requirement that the cr/cb/lum are 8 byte aligned and</span>
<span class="comment">   the out are 16byte aligned or you will/may get segfaults</span>

<span class="comment">*/</span>

<span class="type">void</span><span class="normal"> </span><span class="function">ColorRGBDitherYV12MMX1X</span><span class="symbol">(</span><span class="normal"> </span><span class="type">int</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">colortab</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">Uint32</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">rgb_2_pix</span><span class="symbol">,</span>
<span class="normal">                              </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">lum</span><span class="symbol">,</span><span class="normal"> </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">cr</span><span class="symbol">,</span>
<span class="normal">                              </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">cb</span><span class="symbol">,</span><span class="normal"> </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">out</span><span class="symbol">,</span>
<span class="normal">                              </span><span class="type">int</span><span class="normal"> rows</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> cols</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> mod </span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="usertype">Uint32</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">row1</span><span class="symbol">;</span>
<span class="normal">    </span><span class="usertype">Uint32</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">row2</span><span class="symbol">;</span>

<span class="normal">    </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="symbol">*</span><span class="normal"> y </span><span class="symbol">=</span><span class="normal"> lum </span><span class="symbol">+</span><span class="normal">cols</span><span class="symbol">*</span><span class="normal">rows</span><span class="symbol">;</span><span class="normal">    </span><span class="comment">// Pointer to the end</span>
<span class="normal">    </span><span class="type">int</span><span class="normal"> x</span><span class="symbol">=</span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">    row1 </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint32 </span><span class="symbol">*)</span><span class="normal">out</span><span class="symbol">;</span><span class="normal">                 </span><span class="comment">// 32 bit target</span>
<span class="normal">    row2 </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint32 </span><span class="symbol">*)</span><span class="normal">out</span><span class="symbol">+</span><span class="normal">cols</span><span class="symbol">+</span><span class="normal">mod</span><span class="symbol">;</span><span class="normal">        </span><span class="comment">// start of second row </span>
<span class="normal">    mod </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">mod</span><span class="symbol">+</span><span class="normal">cols</span><span class="symbol">+</span><span class="normal">mod</span><span class="symbol">)*</span><span class="number">4</span><span class="symbol">;</span><span class="normal">               </span><span class="comment">// increment for row1 in byte</span>

<span class="normal">    </span><span class="usertype">__asm__</span><span class="normal"> </span><span class="function">__volatile__</span><span class="normal"> </span><span class="symbol">(</span>
<span class="comment">/* We don't really care about PIC - the code should be rewritten to use</span>
<span class="comment">   relative addressing for the static tables, so right now we take the</span>
<span class="comment">   COW hit on the pages this code resides. Big deal.</span>
<span class="comment">   This spill is just to reduce register pressure in the PIC case. */</span>
<span class="normal">		 </span><span class="string">"pushl %%ebx</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">		 </span><span class="string">"movl %0, %%ebx</span><span class="specialchar">\n</span><span class="string">"</span>

<span class="normal">	         </span><span class="string">".align 8</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">		 </span><span class="string">"1:</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">		</span>
<span class="normal">		 </span><span class="comment">// create Cr (result in mm1)</span>
<span class="normal">		 </span><span class="string">"movd (%%ebx), %%mm1</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">   </span><span class="comment">//         0  0  0  0  v3 v2 v1 v0</span>
<span class="normal">		 </span><span class="string">"pxor %%mm7,%%mm7</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">      </span><span class="comment">//         00 00 00 00 00 00 00 00</span>
<span class="normal">		 </span><span class="string">"movd (%2), %%mm2</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">           </span><span class="comment">//    0  0  0  0 l3 l2 l1 l0</span>
<span class="normal">		 </span><span class="string">"punpcklbw %%mm7,%%mm1</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">//         0  v3 0  v2 00 v1 00 v0</span>
<span class="normal">		 </span><span class="string">"punpckldq %%mm1,%%mm1</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">//         00 v1 00 v0 00 v1 00 v0</span>
<span class="normal">		 </span><span class="string">"psubw _MMX_0080w,%%mm1</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">  </span><span class="comment">// mm1-128:r1 r1 r0 r0 r1 r1 r0 r0 </span>

<span class="normal">		 </span><span class="comment">// create Cr_g (result in mm0)</span>
<span class="normal">		 </span><span class="string">"movq %%mm1,%%mm0</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">           </span><span class="comment">// r1 r1 r0 r0 r1 r1 r0 r0</span>
<span class="normal">		 </span><span class="string">"pmullw _MMX_VgrnRGB,%%mm0</span><span class="specialchar">\n</span><span class="string">"</span><span class="comment">// red*-46dec=0.7136*64</span>
<span class="normal">		 </span><span class="string">"pmullw _MMX_VredRGB,%%mm1</span><span class="specialchar">\n</span><span class="string">"</span><span class="comment">// red*89dec=1.4013*64</span>
<span class="normal">		 </span><span class="string">"psraw  $6, %%mm0</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">           </span><span class="comment">// red=red/64</span>
<span class="normal">		 </span><span class="string">"psraw  $6, %%mm1</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">           </span><span class="comment">// red=red/64</span>
<span class="normal">		 </span>
<span class="normal">		 </span><span class="comment">// create L1 L2 (result in mm2,mm4)</span>
<span class="normal">		 </span><span class="comment">// L2=lum+cols</span>
<span class="normal">		 </span><span class="string">"movq (%2,%4),%%mm3</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">         </span><span class="comment">//    0  0  0  0 L3 L2 L1 L0</span>
<span class="normal">		 </span><span class="string">"punpckldq %%mm3,%%mm2</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">      </span><span class="comment">//   L3 L2 L1 L0 l3 l2 l1 l0</span>
<span class="normal">		 </span><span class="string">"movq %%mm2,%%mm4</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">           </span><span class="comment">//   L3 L2 L1 L0 l3 l2 l1 l0</span>
<span class="normal">		 </span><span class="string">"pand _MMX_FF00w,%%mm2</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">      </span><span class="comment">//   L3 0  L1  0 l3  0 l1  0</span>
<span class="normal">		 </span><span class="string">"pand _MMX_00FFw,%%mm4</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">      </span><span class="comment">//   0  L2  0 L0  0 l2  0 l0</span>
<span class="normal">		 </span><span class="string">"psrlw $8,%%mm2</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">             </span><span class="comment">//   0  L3  0 L1  0 l3  0 l1</span>

<span class="normal">		 </span><span class="comment">// create R (result in mm6)</span>
<span class="normal">		 </span><span class="string">"movq %%mm2,%%mm5</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">           </span><span class="comment">//   0 L3  0 L1  0 l3  0 l1</span>
<span class="normal">		 </span><span class="string">"movq %%mm4,%%mm6</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">           </span><span class="comment">//   0 L2  0 L0  0 l2  0 l0</span>
<span class="normal">		 </span><span class="string">"paddsw  %%mm1, %%mm5</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">       </span><span class="comment">// lum1+red:x R3 x R1 x r3 x r1</span>
<span class="normal">		 </span><span class="string">"paddsw  %%mm1, %%mm6</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">       </span><span class="comment">// lum1+red:x R2 x R0 x r2 x r0</span>
<span class="normal">		 </span><span class="string">"packuswb %%mm5,%%mm5</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">       </span><span class="comment">//  R3 R1 r3 r1 R3 R1 r3 r1</span>
<span class="normal">		 </span><span class="string">"packuswb %%mm6,%%mm6</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">       </span><span class="comment">//  R2 R0 r2 r0 R2 R0 r2 r0</span>
<span class="normal">		 </span><span class="string">"pxor %%mm7,%%mm7</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">      </span><span class="comment">//         00 00 00 00 00 00 00 00</span>
<span class="normal">		 </span><span class="string">"punpcklbw %%mm5,%%mm6</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">      </span><span class="comment">//  R3 R2 R1 R0 r3 r2 r1 r0</span>

<span class="normal">		 </span><span class="comment">// create Cb (result in mm1)</span>
<span class="normal">		 </span><span class="string">"movd (%1), %%mm1</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">      </span><span class="comment">//         0  0  0  0  u3 u2 u1 u0</span>
<span class="normal">		 </span><span class="string">"punpcklbw %%mm7,%%mm1</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">//         0  u3 0  u2 00 u1 00 u0</span>
<span class="normal">		 </span><span class="string">"punpckldq %%mm1,%%mm1</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">//         00 u1 00 u0 00 u1 00 u0</span>
<span class="normal">		 </span><span class="string">"psubw _MMX_0080w,%%mm1</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">  </span><span class="comment">// mm1-128:u1 u1 u0 u0 u1 u1 u0 u0 </span>
<span class="normal">		 </span><span class="comment">// create Cb_g (result in mm5)</span>
<span class="normal">		 </span><span class="string">"movq %%mm1,%%mm5</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">            </span><span class="comment">// u1 u1 u0 u0 u1 u1 u0 u0</span>
<span class="normal">		 </span><span class="string">"pmullw _MMX_UgrnRGB,%%mm5</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">    </span><span class="comment">// blue*-109dec=1.7129*64</span>
<span class="normal">		 </span><span class="string">"pmullw _MMX_UbluRGB,%%mm1</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">    </span><span class="comment">// blue*114dec=1.78125*64</span>
<span class="normal">		 </span><span class="string">"psraw  $6, %%mm5</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">            </span><span class="comment">// blue=red/64</span>
<span class="normal">		 </span><span class="string">"psraw  $6, %%mm1</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">            </span><span class="comment">// blue=blue/64</span>

<span class="normal">		 </span><span class="comment">// create G (result in mm7)</span>
<span class="normal">		 </span><span class="string">"movq %%mm2,%%mm3</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">      </span><span class="comment">//   0  L3  0 L1  0 l3  0 l1</span>
<span class="normal">		 </span><span class="string">"movq %%mm4,%%mm7</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">      </span><span class="comment">//   0  L2  0 L0  0 l2  0 l1</span>
<span class="normal">		 </span><span class="string">"paddsw  %%mm5, %%mm3</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">  </span><span class="comment">// lum1+Cb_g:x G3t x G1t x g3t x g1t</span>
<span class="normal">		 </span><span class="string">"paddsw  %%mm5, %%mm7</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">  </span><span class="comment">// lum1+Cb_g:x G2t x G0t x g2t x g0t</span>
<span class="normal">		 </span><span class="string">"paddsw  %%mm0, %%mm3</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">  </span><span class="comment">// lum1+Cr_g:x G3  x G1  x g3  x g1</span>
<span class="normal">		 </span><span class="string">"paddsw  %%mm0, %%mm7</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">  </span><span class="comment">// lum1+blue:x G2  x G0  x g2  x g0</span>
<span class="normal">		 </span><span class="string">"packuswb %%mm3,%%mm3</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">  </span><span class="comment">// G3 G1 g3 g1 G3 G1 g3 g1</span>
<span class="normal">		 </span><span class="string">"packuswb %%mm7,%%mm7</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">  </span><span class="comment">// G2 G0 g2 g0 G2 G0 g2 g0</span>
<span class="normal">		 </span><span class="string">"punpcklbw %%mm3,%%mm7</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// G3 G2 G1 G0 g3 g2 g1 g0</span>
<span class="normal">		 </span>
<span class="normal">		 </span><span class="comment">// create B (result in mm5)</span>
<span class="normal">		 </span><span class="string">"movq %%mm2,%%mm3</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">         </span><span class="comment">//   0  L3  0 L1  0 l3  0 l1</span>
<span class="normal">		 </span><span class="string">"movq %%mm4,%%mm5</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">         </span><span class="comment">//   0  L2  0 L0  0 l2  0 l1</span>
<span class="normal">		 </span><span class="string">"paddsw  %%mm1, %%mm3</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">     </span><span class="comment">// lum1+blue:x B3 x B1 x b3 x b1</span>
<span class="normal">		 </span><span class="string">"paddsw  %%mm1, %%mm5</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">     </span><span class="comment">// lum1+blue:x B2 x B0 x b2 x b0</span>
<span class="normal">		 </span><span class="string">"packuswb %%mm3,%%mm3</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">     </span><span class="comment">// B3 B1 b3 b1 B3 B1 b3 b1</span>
<span class="normal">		 </span><span class="string">"packuswb %%mm5,%%mm5</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">     </span><span class="comment">// B2 B0 b2 b0 B2 B0 b2 b0</span>
<span class="normal">		 </span><span class="string">"punpcklbw %%mm3,%%mm5</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">    </span><span class="comment">// B3 B2 B1 B0 b3 b2 b1 b0</span>

<span class="normal">		 </span><span class="comment">// fill destination row1 (needed are mm6=Rr,mm7=Gg,mm5=Bb)</span>

<span class="normal">		 </span><span class="string">"pxor %%mm2,%%mm2</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">           </span><span class="comment">//  0  0  0  0  0  0  0  0</span>
<span class="normal">		 </span><span class="string">"pxor %%mm4,%%mm4</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">           </span><span class="comment">//  0  0  0  0  0  0  0  0</span>
<span class="normal">		 </span><span class="string">"movq %%mm6,%%mm1</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">           </span><span class="comment">// R3 R2 R1 R0 r3 r2 r1 r0</span>
<span class="normal">		 </span><span class="string">"movq %%mm5,%%mm3</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">           </span><span class="comment">// B3 B2 B1 B0 b3 b2 b1 b0</span>
<span class="normal">		 </span><span class="comment">// process lower lum</span>
<span class="normal">		 </span><span class="string">"punpcklbw %%mm4,%%mm1</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">      </span><span class="comment">//  0 r3  0 r2  0 r1  0 r0</span>
<span class="normal">		 </span><span class="string">"punpcklbw %%mm4,%%mm3</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">      </span><span class="comment">//  0 b3  0 b2  0 b1  0 b0</span>
<span class="normal">		 </span><span class="string">"movq %%mm1,%%mm2</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">           </span><span class="comment">//  0 r3  0 r2  0 r1  0 r0</span>
<span class="normal">		 </span><span class="string">"movq %%mm3,%%mm0</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">           </span><span class="comment">//  0 b3  0 b2  0 b1  0 b0</span>
<span class="normal">		 </span><span class="string">"punpcklwd %%mm1,%%mm3</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">      </span><span class="comment">//  0 r1  0 b1  0 r0  0 b0</span>
<span class="normal">		 </span><span class="string">"punpckhwd %%mm2,%%mm0</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">      </span><span class="comment">//  0 r3  0 b3  0 r2  0 b2</span>

<span class="normal">		 </span><span class="string">"pxor %%mm2,%%mm2</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">           </span><span class="comment">//  0  0  0  0  0  0  0  0</span>
<span class="normal">		 </span><span class="string">"movq %%mm7,%%mm1</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">           </span><span class="comment">// G3 G2 G1 G0 g3 g2 g1 g0</span>
<span class="normal">		 </span><span class="string">"punpcklbw %%mm1,%%mm2</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">      </span><span class="comment">// g3  0 g2  0 g1  0 g0  0</span>
<span class="normal">		 </span><span class="string">"punpcklwd %%mm4,%%mm2</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">      </span><span class="comment">//  0  0 g1  0  0  0 g0  0 </span>
<span class="normal">		 </span><span class="string">"por  %%mm3, %%mm2</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">          </span><span class="comment">//  0 r1 g1 b1  0 r0 g0 b0</span>
<span class="normal">		 </span><span class="string">"movq   %%mm2,(%3)</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">          </span><span class="comment">// wrote out ! row1</span>

<span class="normal">		 </span><span class="string">"pxor %%mm2,%%mm2</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">           </span><span class="comment">//  0  0  0  0  0  0  0  0</span>
<span class="normal">		 </span><span class="string">"punpcklbw %%mm1,%%mm4</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">      </span><span class="comment">// g3  0 g2  0 g1  0 g0  0</span>
<span class="normal">		 </span><span class="string">"punpckhwd %%mm2,%%mm4</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">      </span><span class="comment">//  0  0 g3  0  0  0 g2  0 </span>
<span class="normal">		 </span><span class="string">"por  %%mm0, %%mm4</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">          </span><span class="comment">//  0 r3 g3 b3  0 r2 g2 b2</span>
<span class="normal">		 </span><span class="string">"movq   %%mm4,8(%3)</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">         </span><span class="comment">// wrote out ! row1</span>
<span class="normal">		 </span>
<span class="normal">		 </span><span class="comment">// fill destination row2 (needed are mm6=Rr,mm7=Gg,mm5=Bb)</span>
<span class="normal">		 </span><span class="comment">// this can be done "destructive"</span>
<span class="normal">		 </span><span class="string">"pxor %%mm2,%%mm2</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">           </span><span class="comment">//  0  0  0  0  0  0  0  0</span>
<span class="normal">		 </span><span class="string">"punpckhbw %%mm2,%%mm6</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">      </span><span class="comment">//  0 R3  0 R2  0 R1  0 R0</span>
<span class="normal">		 </span><span class="string">"punpckhbw %%mm1,%%mm5</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">      </span><span class="comment">// G3 B3 G2 B2 G1 B1 G0 B0</span>
<span class="normal">		 </span><span class="string">"movq %%mm5,%%mm1</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">           </span><span class="comment">// G3 B3 G2 B2 G1 B1 G0 B0</span>
<span class="normal">		 </span><span class="string">"punpcklwd %%mm6,%%mm1</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">      </span><span class="comment">//  0 R1 G1 B1  0 R0 G0 B0</span>
<span class="normal">		 </span><span class="string">"movq   %%mm1,(%5)</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">          </span><span class="comment">// wrote out ! row2</span>
<span class="normal">		 </span><span class="string">"punpckhwd %%mm6,%%mm5</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">      </span><span class="comment">//  0 R3 G3 B3  0 R2 G2 B2</span>
<span class="normal">		 </span><span class="string">"movq   %%mm5,8(%5)</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">         </span><span class="comment">// wrote out ! row2</span>
<span class="normal">		 </span>
<span class="normal">		 </span><span class="string">"addl  $4,%2</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">            </span><span class="comment">// lum+4</span>
<span class="normal">		 </span><span class="string">"leal  16(%3),%3</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">        </span><span class="comment">// row1+16</span>
<span class="normal">		 </span><span class="string">"leal  16(%5),%5</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">        </span><span class="comment">// row2+16</span>
<span class="normal">		 </span><span class="string">"addl  $2, %%ebx</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">        </span><span class="comment">// cr+2</span>
<span class="normal">		 </span><span class="string">"addl  $2, %1</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">           </span><span class="comment">// cb+2</span>

<span class="normal">		 </span><span class="string">"addl  $4,%6</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">            </span><span class="comment">// x+4</span>
<span class="normal">		 </span><span class="string">"cmpl  %4,%6</span><span class="specialchar">\n</span><span class="string">"</span>

<span class="normal">		 </span><span class="string">"jl    1b</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">		 </span><span class="string">"addl           %4,     %2</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// lum += cols </span>
<span class="normal">		 </span><span class="string">"addl           %8,     %3</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// row1+= mod</span>
<span class="normal">		 </span><span class="string">"addl           %8,     %5</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// row2+= mod</span>
<span class="normal">		 </span><span class="string">"movl           $0,     %6</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// x=0</span>
<span class="normal">		 </span><span class="string">"cmpl           %7,     %2</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">		 </span><span class="string">"jl             1b</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">		 </span><span class="string">"emms</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">		 </span><span class="string">"popl %%ebx</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">		 </span><span class="symbol">:</span>
<span class="normal">		 </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"m"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">cr</span><span class="symbol">),</span><span class="normal"> </span><span class="string">"r"</span><span class="symbol">(</span><span class="normal">cb</span><span class="symbol">),</span><span class="string">"r"</span><span class="symbol">(</span><span class="normal">lum</span><span class="symbol">),</span>
<span class="normal">		 </span><span class="string">"r"</span><span class="symbol">(</span><span class="normal">row1</span><span class="symbol">),</span><span class="string">"r"</span><span class="symbol">(</span><span class="normal">cols</span><span class="symbol">),</span><span class="string">"r"</span><span class="symbol">(</span><span class="normal">row2</span><span class="symbol">),</span><span class="string">"m"</span><span class="symbol">(</span><span class="normal">x</span><span class="symbol">),</span><span class="string">"m"</span><span class="symbol">(</span><span class="normal">y</span><span class="symbol">),</span><span class="string">"m"</span><span class="symbol">(</span><span class="normal">mod</span><span class="symbol">));</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> </span><span class="function">Color565DitherYV12MMX1X</span><span class="symbol">(</span><span class="normal"> </span><span class="type">int</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">colortab</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">Uint32</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">rgb_2_pix</span><span class="symbol">,</span>
<span class="normal">                             </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">lum</span><span class="symbol">,</span><span class="normal"> </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">cr</span><span class="symbol">,</span>
<span class="normal">                             </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">cb</span><span class="symbol">,</span><span class="normal"> </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">out</span><span class="symbol">,</span>
<span class="normal">                             </span><span class="type">int</span><span class="normal"> rows</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> cols</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> mod </span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="usertype">Uint16</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">row1</span><span class="symbol">;</span>
<span class="normal">    </span><span class="usertype">Uint16</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">row2</span><span class="symbol">;</span>

<span class="normal">    </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="symbol">*</span><span class="normal"> y </span><span class="symbol">=</span><span class="normal"> lum </span><span class="symbol">+</span><span class="normal">cols</span><span class="symbol">*</span><span class="normal">rows</span><span class="symbol">;</span><span class="normal">    </span><span class="comment">/* Pointer to the end */</span>
<span class="normal">    </span><span class="type">int</span><span class="normal"> x</span><span class="symbol">=</span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">    row1 </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint16 </span><span class="symbol">*)</span><span class="normal">out</span><span class="symbol">;</span><span class="normal">                 </span><span class="comment">/* 16 bit target */</span>
<span class="normal">    row2 </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Uint16 </span><span class="symbol">*)</span><span class="normal">out</span><span class="symbol">+</span><span class="normal">cols</span><span class="symbol">+</span><span class="normal">mod</span><span class="symbol">;</span><span class="normal">        </span><span class="comment">/* start of second row  */</span>
<span class="normal">    mod </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">mod</span><span class="symbol">+</span><span class="normal">cols</span><span class="symbol">+</span><span class="normal">mod</span><span class="symbol">)*</span><span class="number">2</span><span class="symbol">;</span><span class="normal">               </span><span class="comment">/* increment for row1 in byte */</span>


<span class="normal">      </span><span class="usertype">__asm__</span><span class="normal"> </span><span class="function">__volatile__</span><span class="symbol">(</span>
<span class="normal">         </span><span class="string">"pushl %%ebx</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">	 </span><span class="string">"movl %0, %%ebx</span><span class="specialchar">\n</span><span class="string">"</span>

<span class="normal">         </span><span class="string">".align 8</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">         </span><span class="string">"1:</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">         </span><span class="string">"movd           (%1),                   %%mm0</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// 4 Cb         0  0  0  0 u3 u2 u1 u0</span>
<span class="normal">         </span><span class="string">"pxor           %%mm7,                  %%mm7</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">         </span><span class="string">"movd           (%%ebx),                %%mm1</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// 4 Cr                0  0  0  0 v3 v2 v1 v0</span>
<span class="normal">         </span><span class="string">"punpcklbw      %%mm7,                  %%mm0</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// 4 W cb   0 u3  0 u2  0 u1  0 u0</span>
<span class="normal">         </span><span class="string">"punpcklbw      %%mm7,                  %%mm1</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// 4 W cr   0 v3  0 v2  0 v1  0 v0</span>
<span class="normal">         </span><span class="string">"psubw          _MMX_0080w,             %%mm0</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">         </span><span class="string">"psubw          _MMX_0080w,             %%mm1</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">         </span><span class="string">"movq           %%mm0,                  %%mm2</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// Cb                   0 u3  0 u2  0 u1  0 u0</span>
<span class="normal">         </span><span class="string">"movq           %%mm1,                  %%mm3</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// Cr</span>
<span class="normal">         </span><span class="string">"pmullw         _MMX_Ugrn565,           %%mm2</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// Cb2green 0 R3  0 R2  0 R1  0 R0</span>
<span class="normal">         </span><span class="string">"movq           (%2),                   %%mm6</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// L1      l7 L6 L5 L4 L3 L2 L1 L0</span>
<span class="normal">         </span><span class="string">"pmullw         _MMX_Ublu5x5,           %%mm0</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// Cb2blue</span>
<span class="normal">         </span><span class="string">"pand           _MMX_00FFw,             %%mm6</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// L1      00 L6 00 L4 00 L2 00 L0</span>
<span class="normal">         </span><span class="string">"pmullw         _MMX_Vgrn565,           %%mm3</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// Cr2green</span>
<span class="normal">         </span><span class="string">"movq           (%2),                   %%mm7</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// L2</span>
<span class="normal">         </span><span class="string">"pmullw         _MMX_Vred5x5,           %%mm1</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// Cr2red</span>
<span class="normal">         </span><span class="string">"psrlw          $8,                     %%mm7</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">        </span><span class="comment">// L2           00 L7 00 L5 00 L3 00 L1</span>
<span class="normal">         </span><span class="string">"pmullw         _MMX_Ycoeff,            %%mm6</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// lum1</span>
<span class="normal">         </span><span class="string">"paddw          %%mm3,                  %%mm2</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// Cb2green + Cr2green == green</span>
<span class="normal">         </span><span class="string">"pmullw         _MMX_Ycoeff,            %%mm7</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// lum2</span>

<span class="normal">         </span><span class="string">"movq           %%mm6,                  %%mm4</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// lum1</span>
<span class="normal">         </span><span class="string">"paddw          %%mm0,                  %%mm6</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// lum1 +blue 00 B6 00 B4 00 B2 00 B0</span>
<span class="normal">         </span><span class="string">"movq           %%mm4,                  %%mm5</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// lum1</span>
<span class="normal">         </span><span class="string">"paddw          %%mm1,                  %%mm4</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// lum1 +red  00 R6 00 R4 00 R2 00 R0</span>
<span class="normal">         </span><span class="string">"paddw          %%mm2,                  %%mm5</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// lum1 +green 00 G6 00 G4 00 G2 00 G0</span>
<span class="normal">         </span><span class="string">"psraw          $6,                     %%mm4</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// R1 0 .. 64</span>
<span class="normal">         </span><span class="string">"movq           %%mm7,                  %%mm3</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// lum2                       00 L7 00 L5 00 L3 00 L1</span>
<span class="normal">         </span><span class="string">"psraw          $6,                     %%mm5</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// G1  - .. +</span>
<span class="normal">         </span><span class="string">"paddw          %%mm0,                  %%mm7</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// Lum2 +blue 00 B7 00 B5 00 B3 00 B1</span>
<span class="normal">         </span><span class="string">"psraw          $6,                     %%mm6</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// B1         0 .. 64</span>
<span class="normal">         </span><span class="string">"packuswb       %%mm4,                  %%mm4</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// R1 R1</span>
<span class="normal">         </span><span class="string">"packuswb       %%mm5,                  %%mm5</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// G1 G1</span>
<span class="normal">         </span><span class="string">"packuswb       %%mm6,                  %%mm6</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// B1 B1</span>
<span class="normal">         </span><span class="string">"punpcklbw      %%mm4,                  %%mm4</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">         </span><span class="string">"punpcklbw      %%mm5,                  %%mm5</span><span class="specialchar">\n</span><span class="string">"</span>

<span class="normal">         </span><span class="string">"pand           _MMX_red565,            %%mm4</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">         </span><span class="string">"psllw          $3,                     %%mm5</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// GREEN       1</span>
<span class="normal">         </span><span class="string">"punpcklbw      %%mm6,                  %%mm6</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">         </span><span class="string">"pand           _MMX_grn565,            %%mm5</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">         </span><span class="string">"pand           _MMX_red565,            %%mm6</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">         </span><span class="string">"por            %%mm5,                  %%mm4</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">//</span>
<span class="normal">         </span><span class="string">"psrlw          $11,                    %%mm6</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// BLUE        1</span>
<span class="normal">         </span><span class="string">"movq           %%mm3,                  %%mm5</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// lum2</span>
<span class="normal">         </span><span class="string">"paddw          %%mm1,                  %%mm3</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// lum2 +red      00 R7 00 R5 00 R3 00 R1</span>
<span class="normal">         </span><span class="string">"paddw          %%mm2,                  %%mm5</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// lum2 +green 00 G7 00 G5 00 G3 00 G1</span>
<span class="normal">         </span><span class="string">"psraw          $6,                     %%mm3</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// R2</span>
<span class="normal">         </span><span class="string">"por            %%mm6,                  %%mm4</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// MM4</span>
<span class="normal">         </span><span class="string">"psraw          $6,                     %%mm5</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// G2</span>
<span class="normal">         </span><span class="string">"movq           (%2, %4),               %%mm6</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// L3 load lum2</span>
<span class="normal">         </span><span class="string">"psraw          $6,                     %%mm7</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">         </span><span class="string">"packuswb       %%mm3,                  %%mm3</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">         </span><span class="string">"packuswb       %%mm5,                  %%mm5</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">         </span><span class="string">"packuswb       %%mm7,                  %%mm7</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">         </span><span class="string">"pand           _MMX_00FFw,             %%mm6</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// L3</span>
<span class="normal">         </span><span class="string">"punpcklbw      %%mm3,                  %%mm3</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">         </span><span class="string">"punpcklbw      %%mm5,                  %%mm5</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">         </span><span class="string">"pmullw         _MMX_Ycoeff,            %%mm6</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// lum3</span>
<span class="normal">         </span><span class="string">"punpcklbw      %%mm7,                  %%mm7</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">         </span><span class="string">"psllw          $3,                     %%mm5</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// GREEN 2</span>
<span class="normal">         </span><span class="string">"pand           _MMX_red565,            %%mm7</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">         </span><span class="string">"pand           _MMX_red565,            %%mm3</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">         </span><span class="string">"psrlw          $11,                    %%mm7</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// BLUE  2</span>
<span class="normal">         </span><span class="string">"pand           _MMX_grn565,            %%mm5</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">         </span><span class="string">"por            %%mm7,                  %%mm3</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">         </span><span class="string">"movq           (%2,%4),                %%mm7</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// L4 load lum2</span>
<span class="normal">         </span><span class="string">"por            %%mm5,                  %%mm3</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">//</span>
<span class="normal">         </span><span class="string">"psrlw          $8,                     %%mm7</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// L4</span>
<span class="normal">         </span><span class="string">"movq           %%mm4,                  %%mm5</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">         </span><span class="string">"punpcklwd      %%mm3,                  %%mm4</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">         </span><span class="string">"pmullw         _MMX_Ycoeff,            %%mm7</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// lum4</span>
<span class="normal">         </span><span class="string">"punpckhwd      %%mm3,                  %%mm5</span><span class="specialchar">\n</span><span class="string">"</span>

<span class="normal">         </span><span class="string">"movq           %%mm4,                  (%3)</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal">  </span><span class="comment">// write row1</span>
<span class="normal">         </span><span class="string">"movq           %%mm5,                  8(%3)</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// write row1</span>

<span class="normal">         </span><span class="string">"movq           %%mm6,                  %%mm4</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// Lum3</span>
<span class="normal">         </span><span class="string">"paddw          %%mm0,                  %%mm6</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// Lum3 +blue</span>

<span class="normal">         </span><span class="string">"movq           %%mm4,                  %%mm5</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// Lum3</span>
<span class="normal">         </span><span class="string">"paddw          %%mm1,                  %%mm4</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// Lum3 +red</span>
<span class="normal">         </span><span class="string">"paddw          %%mm2,                  %%mm5</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// Lum3 +green</span>
<span class="normal">         </span><span class="string">"psraw          $6,                     %%mm4</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">         </span><span class="string">"movq           %%mm7,                  %%mm3</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// Lum4</span>
<span class="normal">         </span><span class="string">"psraw          $6,                     %%mm5</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">         </span><span class="string">"paddw          %%mm0,                  %%mm7</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// Lum4 +blue</span>
<span class="normal">         </span><span class="string">"psraw          $6,                     %%mm6</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// Lum3 +blue</span>
<span class="normal">         </span><span class="string">"movq           %%mm3,                  %%mm0</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// Lum4</span>
<span class="normal">         </span><span class="string">"packuswb       %%mm4,                  %%mm4</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">         </span><span class="string">"paddw          %%mm1,                  %%mm3</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// Lum4 +red</span>
<span class="normal">         </span><span class="string">"packuswb       %%mm5,                  %%mm5</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">         </span><span class="string">"paddw          %%mm2,                  %%mm0</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// Lum4 +green</span>
<span class="normal">         </span><span class="string">"packuswb       %%mm6,                  %%mm6</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">         </span><span class="string">"punpcklbw      %%mm4,                  %%mm4</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">         </span><span class="string">"punpcklbw      %%mm5,                  %%mm5</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">         </span><span class="string">"punpcklbw      %%mm6,                  %%mm6</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">         </span><span class="string">"psllw          $3,                     %%mm5</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// GREEN 3</span>
<span class="normal">         </span><span class="string">"pand           _MMX_red565,            %%mm4</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">         </span><span class="string">"psraw          $6,                     %%mm3</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// psr 6</span>
<span class="normal">         </span><span class="string">"psraw          $6,                     %%mm0</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">         </span><span class="string">"pand           _MMX_red565,            %%mm6</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// BLUE</span>
<span class="normal">         </span><span class="string">"pand           _MMX_grn565,            %%mm5</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">         </span><span class="string">"psrlw          $11,                    %%mm6</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// BLUE  3</span>
<span class="normal">         </span><span class="string">"por            %%mm5,                  %%mm4</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">         </span><span class="string">"psraw          $6,                     %%mm7</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">         </span><span class="string">"por            %%mm6,                  %%mm4</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">         </span><span class="string">"packuswb       %%mm3,                  %%mm3</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">         </span><span class="string">"packuswb       %%mm0,                  %%mm0</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">         </span><span class="string">"packuswb       %%mm7,                  %%mm7</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">         </span><span class="string">"punpcklbw      %%mm3,                  %%mm3</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">         </span><span class="string">"punpcklbw      %%mm0,                  %%mm0</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">         </span><span class="string">"punpcklbw      %%mm7,                  %%mm7</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">         </span><span class="string">"pand           _MMX_red565,            %%mm3</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">         </span><span class="string">"pand           _MMX_red565,            %%mm7</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// BLUE</span>
<span class="normal">         </span><span class="string">"psllw          $3,                     %%mm0</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// GREEN 4</span>
<span class="normal">         </span><span class="string">"psrlw          $11,                    %%mm7</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">         </span><span class="string">"pand           _MMX_grn565,            %%mm0</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">         </span><span class="string">"por            %%mm7,                  %%mm3</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">         </span><span class="string">"por            %%mm0,                  %%mm3</span><span class="specialchar">\n</span><span class="string">"</span>

<span class="normal">         </span><span class="string">"movq           %%mm4,                  %%mm5</span><span class="specialchar">\n</span><span class="string">"</span>

<span class="normal">         </span><span class="string">"punpcklwd      %%mm3,                  %%mm4</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">         </span><span class="string">"punpckhwd      %%mm3,                  %%mm5</span><span class="specialchar">\n</span><span class="string">"</span>

<span class="normal">         </span><span class="string">"movq           %%mm4,                  (%5)</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">	 </span><span class="string">"movq           %%mm5,                  8(%5)</span><span class="specialchar">\n</span><span class="string">"</span>

<span class="normal">         </span><span class="string">"addl           $8,                     %6</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">         </span><span class="string">"addl           $8,                     %2</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">         </span><span class="string">"addl           $4,                     %%ebx</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">         </span><span class="string">"addl           $4,                     %1</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">         </span><span class="string">"cmpl           %4,                     %6</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">         </span><span class="string">"leal           16(%3),                 %3</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">	 </span><span class="string">"leal           16(%5),%5</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// row2+16</span>


<span class="normal">         </span><span class="string">"jl             1b</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">	 </span><span class="string">"addl           %4,     %2</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// lum += cols </span>
<span class="normal">	 </span><span class="string">"addl           %8,     %3</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// row1+= mod</span>
<span class="normal">	 </span><span class="string">"addl           %8,     %5</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// row2+= mod</span>
<span class="normal">	 </span><span class="string">"movl           $0,     %6</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="comment">// x=0</span>
<span class="normal">	 </span><span class="string">"cmpl           %7,     %2</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">	 </span><span class="string">"jl             1b</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">         </span><span class="string">"emms</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">	 </span><span class="string">"popl %%ebx</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">         </span><span class="symbol">:</span>
<span class="normal">         </span><span class="symbol">:</span><span class="string">"m"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">cr</span><span class="symbol">),</span><span class="normal"> </span><span class="string">"r"</span><span class="symbol">(</span><span class="normal">cb</span><span class="symbol">),</span><span class="string">"r"</span><span class="symbol">(</span><span class="normal">lum</span><span class="symbol">),</span>
<span class="normal">	 </span><span class="string">"r"</span><span class="symbol">(</span><span class="normal">row1</span><span class="symbol">),</span><span class="string">"r"</span><span class="symbol">(</span><span class="normal">cols</span><span class="symbol">),</span><span class="string">"r"</span><span class="symbol">(</span><span class="normal">row2</span><span class="symbol">),</span><span class="string">"m"</span><span class="symbol">(</span><span class="normal">x</span><span class="symbol">),</span><span class="string">"m"</span><span class="symbol">(</span><span class="normal">y</span><span class="symbol">),</span><span class="string">"m"</span><span class="symbol">(</span><span class="normal">mod</span><span class="symbol">));</span>
<span class="cbracket">}</span>

<span class="preproc">#endif</span><span class="normal"> </span><span class="comment">/* GCC i386 inline assembly */</span>
<span class="preproc">#endif</span><span class="normal"> </span><span class="comment">/* 0 */</span>
</tt></pre></div><footer><div style="text-align: right; padding: 8pt; font-size: 13px"><a href="/xmlfeed/weblog-rss20.xml"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAAAPAgMAAAAOp6AcAAAADFBMVEVmZmb/ZgD///+JjnlbTUWmAAAACXBIWXMAAABIAAAASABGyWs+AAAACXZwQWcAAABQAAAADwCexKkxAAAAWUlEQVQYlWNgwAa0VmGAFQyqoSCQ/x8J/CBFMCt0ZdTU/F/7/+1HEkydFpoKVPn+93sUlUujQvP/7UcRTAuNDJ2a//s/imDqtKVZofm/1qGYSZk7sfodGwAAiobBJtffoNAAAAAASUVORK5CYII=" alt="RSS 2.0 Weblog Feed" width="80" height="15"/></a> <a href="/xmlfeed/weblog-atom10.xml"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAAAPAgMAAAAOp6AcAAAADFBMVEVmZmb/ZgD///+JjnlbTUWmAAAAaklEQVQYlWNgwAa0VmGAFQyqoSCQ/x8J/CBFMDV16rTQ/H/7V//69+//v/3/9oMEI6cuAwr+fv/+/b5d///v//0eJBgWOhMo+Gs9UPAdXDBy6lSYyn9wQZCZS0GCYDPXQcykzJ1Y/Y4NAABKvL80wyoMPgAAAABJRU5ErkJggg==" alt="Atom 1.0 Weblog Feed" width="80" height="15"/></a> <a href="http://validator.w3.org/check?uri=referer"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAAAPCAMAAABEF7i9AAAB1FBMVEUHQIgIRY0MN4QNRYoSRYsXUpIYVJQeUpUhWpgjUJMjWpgmU5QnXJkuYZ0uYpwwV5YyZJ4zaKM3ZaA5aaI6aqM6a6E8ZqA8Z6BAbaRBbqdCbaVHd61KSkpKcaZQUFBUf69UgbBVVVVXfq9Yg7NZhbJZh7RagrNeXVxeh7RfjLdgYGBiiLZmZmZnZ2doirhpkbt0m8F3m8B3ncJ5lb55ocR+ocSDgX+Do8eEpMqGhoaHp8iIpMeJjnmJpseKqMeOqsqPsdCQrcyVlZWVsM2Zs9CZtNCfu9ahoaGhuNShudSivNSjtMWjvNSmpqWnpqSrw9qvxNqyxdmyxdyzsK6zs7Ozx9y0xt21yN22tra4y+K80eK/v7/AwMDExMTEy9DH2ejK2+jM2ujN3uvP0dLR0NDR3uvS3uvS3+zU4u3V1dXY2dnY4u7Y4+3b5e/d3d3d5u/d5/De3t7f39/h4uLj4uHj6/Ll7PXm7fTn7/Xo7/Tp7/bq7Ozr6unr8ffw8PDw9vvx9fny+P7z8/Pz9vnz9vv3+fv4+vz5+vz6+vr6+/36/P36///7+/77/Pz7/f37/f78/Pz8/f38/f79/f39/f79/f/9/v79///+/v7+/v////3///+tYR2LAAABKklEQVQ4y2PQoTJg0JlNVYDPQBsyAMTAqaFes8tdsmdPCtA3MDStr3GKKK6myMAprgJ9pcpWs/MlRExYJBvNZLR0sigycHYOV1S7mtjsQJ4gf+HIFPXoWMs6qIGzIRiKZs9GFoEaMRuZhhrYqqJXy8uZYauRxC/VHew7e3YTPAxnI5swG6JxNrKBNjB1EFmIgV0+HA6C8pqqzhXG7BbJJROQIwViMYQ7G2oDQQNn57JyG7kxiCfObrBmS5+BHMuYLkTzMnYDm5WY4lOZZRPKZocxes+aPbuwCFsYohiICLvZsKBAMrDTQ7K/StveU8icTzrOL8JdLpOyWJ49u8Bx9ozw8DY7UYW03hhdxZAOSg2c3jN79rSJs1vSKmfOnpFXNJmynELlvExlAADnaZpLFGEC2wAAAABJRU5ErkJggg==" alt="Valid XHTML 1.1" width="80" height="15"/></a> <a href="http://jigsaw.w3.org/css-validator/check/referer"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAAAPCAMAAABEF7i9AAAB1FBMVEUHQIgIRY0MN4QNRYoSRYsXUpIYVJQeUpUhWpgjUJMjWpgmU5QnXJkuYZ0uYpwwV5YyZJ4zaKM3ZaA5aaI6aqM6a6E8ZqA8Z6BAbaRBbqdCbaVHd61KSkpKcaZQUFBUf69UgbBVVVVXfq9Yg7NZhbJZh7RagrNeXVxeh7RfjLdgYGBiiLZmZmZnZ2doirhpkbt0m8F3m8B3ncJ5lb55ocR+ocSDgX+Do8eEpMqGhoaHp8iIpMeJjnmJpseKqMeOqsqPsdCQrcyVlZWVsM2Zs9CZtNCfu9ahoaGhuNShudSivNSjtMWjvNSmpqWnpqSrw9qvxNqyxdmyxdyzsK6zs7Ozx9y0xt21yN22tra4y+K80eK/v7/AwMDExMTEy9DH2ejK2+jM2ujN3uvP0dLR0NDR3uvS3uvS3+zU4u3V1dXY2dnY4u7Y4+3b5e/d3d3d5u/d5/De3t7f39/h4uLj4uHj6/Ll7PXm7fTn7/Xo7/Tp7/bq7Ozr6unr8ffw8PDw9vvx9fny+P7z8/Pz9vnz9vv3+fv4+vz5+vz6+vr6+/36/P36///7+/77/Pz7/f37/f78/Pz8/f38/f79/f39/f79/f/9/v79///+/v7+/v////3///+tYR2LAAABEUlEQVQ4y2PQoTJg0JlNVYDPQBsyAMTAqaFes8tdsmdPCtA3MDStr3GKKK6myMAprgJ9pcpWs/MlRExYJBvNZLR0sigycHYOV1S7mtjsQJ4gf+HIFPXoWMs6mIEQCsIjwhKoga0qerW8nBm2Gkn8Ut3BvrNnN8HCcDYM2cBIogzs8uFwEJTXVHWuMGa3SC6ZgIgUqCEwdxJr4OxcVm4jNwbxxNkN1mzpM2ajGIjsPGK9PLtZiSk+lVk2oWx2GKP3rNmzC4tQwpDoIIQb2Okh2V+lbe8pZM4nHecX4S6XSVksz55d4Dh7Rnh4m52oQlpvjK5iSAelBk7vmT172sTZLWmVM2fPyCuaTFlOoXJepjIAANlljDGY/l5pAAAAAElFTkSuQmCC" alt="Valid CSS (2.1)" width="80" height="15"/></a><br/>Copyright 2005-2022 <a href="/about/">Timo Bingmann</a>. All rights reserved.</div></footer></body></html>