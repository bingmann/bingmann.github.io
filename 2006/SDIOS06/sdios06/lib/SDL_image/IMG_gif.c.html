<?xml version="1.0" encoding="iso-8859-1"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta content="text/html; charset=iso-8859-1" http-equiv="content-type" /><meta name="viewport" content="initial-scale=1"><title>/2006/SDIOS06/sdios06/lib/SDL_image/IMG_gif.c - panthema.net</title><link rel="stylesheet" type="text/css" href="/css/base.css" /><link rel="stylesheet" type="text/css" href="/css/fonts.css" /><link rel="alternate" type="application/rss+xml" title="panthema.net Weblog Feed RSS 2.0" href="https://panthema.net/xmlfeed/weblog-rss20.xml" /><link rel="alternate" type="application/atom+xml" title="panthema.net Weblog Feed Atom 1.0" href="https://panthema.net/xmlfeed/weblog-atom10.xml" /><script type="text/javascript" src="/js/base.js"></script><script type="text/javascript">/* <!-- */makeIEHover = function() {var lis = document.getElementById('ptnav').getElementsByTagName('li');for (var i = 0; i < lis.length; i++) {lis[i].onmouseover = function() {this.className += ' sfhover';};lis[i].onmouseout = function() {this.className = this.className.replace(new RegExp(' sfhover\b'), '');};}};if (window.attachEvent) window.attachEvent('onload', makeIEHover);/* --> */</script></head><body lang="en"><div class="pttopbar"><div style="float: right"><ul id="ptnav"><li class="top"><a class="ni" href="/timeline/"><i class="icon-book"></i> Weblog</a><ul style="margin-left: -6px; margin-top: 4px" class="nx"><li><a href="/2020/">2020</a></li><li><a href="/2019/">2019</a></li><li><a href="/2018/">2018</a></li><li><a href="/2017/">2017</a></li><li><a href="/2016/">2016</a></li><li><a href="/2015/">2015</a></li><li><a href="/2014/">2014</a></li><li><a href="/2013/">2013</a></li><li><a href="/2012/">2012</a></li><li><a href="/2011/">2011</a></li><li><a href="/2010/">2010</a></li><li><a href="/2009/">2009</a></li><li><a href="/2008/">2008</a></li><li><a href="/2007/">2007</a></li><li><a href="/2006/">2006</a></li><li class="nt"><a href="/2005/">2005</a></li><li class="ns"><a href="/xmlfeed/weblog-rss20.xml">RSS Feed</a></li><li class="nt"><a href="/xmlfeed/weblog-atom10.xml">XML Atom</a></li></ul></li><li class="top"> <a class="ni" href="/tags/"><i class="icon-tags"></i> Tags</a></li><li class="top"> <a class="ni" href="#"><i class="icon-cubes"></i> Projects</a> <ul style="margin-left: -8em; margin-top: 4px;" class="nx"> <li><a href="/2019/1008-COBS-A-Compact-Bit-Sliced-Signature-Index/">COBS</a></li> <li><a href="/2009/cryptote/">CryptoTE</a></li> <li><a href="/2009/digup/">digup</a></li> <li><a href="/2013/disk-filltest/">disk-filltest</a></li> <li><a href="/2012/1119-eSAIS-Inducing-Suffix-and-LCP-Arrays-in-External-Memory/">eSAIS-LCP</a></li> <li><a href="/2007/flex-bison-cpp-example/">Flex Bison C++ Example</a></li> <li><a href="/2013/malloc_count/">malloc_count</a></li> <li><a href="/2016/0114-diploma-thesis/">On Bispanning Graphs</a></li> <li><a href="/2013/pmbw/">Parallel Memory Bandwidth</a></li> <li><a href="/2013/parallel-string-sorting/">Parallel String Sorting</a></li> <li><a href="/2014/sqlplot-tools/">SqlPlotTools</a></li> <li><a href="/2013/sound-of-sorting/">The Sound of Sorting</a></li> <li><a href="/2007/stx-btree/">STX B+ Tree</a></li> <li><a href="/2010/stx-cbtreedb/">STX Constant BTreeDB</a></li> <li><a href="/2010/stx-execpipe/">STX ExecPipe</a></li> <li><a href="/2007/stx-exparser/">STX Expression Parser</a></li> <li><a href="/tags/stxxl.html">STXXL 1.4</a></li> <li><a href="/tags/thrill.html">Thrill - Big Data Framework</a></li> <li class="nt"><a href="/2014/vncrec-rgb/">VNCrec RGB 0.4</a></li> </ul></li><li class="top"> <a class="ni" href="/publications.html"><i class="icon-graduation-cap"></i> Publications</a></li><li class="top"> <a class="ni" href="/search.html"><i class="icon-search"></i> Search</a></li><li class="top"> <a class="ni" href="/subscribe.html"><i class="icon-rss-squared"></i> Subscribe</a></li><li class="top"> <a class="ni" href="/about/"><i class="icon-info-circled"></i> About</a></li></ul></div><div style="padding: 6px"><a href="/">panthema</a>  / <a href="/2006/">2006</a> / <a href="/2006/SDIOS06/">SDIOS06</a> / <a href="/2006/SDIOS06/sdios06/">sdios06</a> / <a href="/2006/SDIOS06/sdios06/lib/">lib</a> / <a href="/2006/SDIOS06/sdios06/lib/SDL_image/">SDL_image</a> / <a href="/2006/SDIOS06/sdios06/lib/SDL_image/IMG_gif.c.html">IMG_gif.c</a> (<a href="/2006/SDIOS06/sdios06/lib/SDL_image/IMG_gif.c">Download File</a>)</div></div><div class="ptfullwidth"><pre class="codesnippet" style="font-family: monospace"><tt><span class="comment">/*</span>
<span class="comment">    SDL_image:  An example image loading library for use with SDL</span>
<span class="comment">    Copyright (C) 1999-2004 Sam Lantinga</span>

<span class="comment">    This library is free software; you can redistribute it and/or</span>
<span class="comment">    modify it under the terms of the GNU Library General Public</span>
<span class="comment">    License as published by the Free Software Foundation; either</span>
<span class="comment">    version 2 of the License, or (at your option) any later version.</span>

<span class="comment">    This library is distributed in the hope that it will be useful,</span>
<span class="comment">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="comment">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="comment">    Library General Public License for more details.</span>

<span class="comment">    You should have received a copy of the GNU Library General Public</span>
<span class="comment">    License along with this library; if not, write to the Free</span>
<span class="comment">    Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>

<span class="comment">    Sam Lantinga</span>
<span class="comment">    </span><span class="url">slouken@libsdl.org</span>
<span class="comment">*/</span>

<span class="comment">/* $Id: IMG_gif.c,v 1.6 2004/01/04 17:33:01 slouken Exp $ */</span>

<span class="comment">/* This is a GIF image file loading framework */</span>

<span class="preproc">#include</span><span class="normal"> </span><span class="string">&lt;stdio.h&gt;</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">&lt;string.h&gt;</span>

<span class="preproc">#include</span><span class="normal"> </span><span class="string">"SDL_image.h"</span>

<span class="preproc">#ifdef</span><span class="normal"> LOAD_GIF</span>

<span class="comment">/* See if an image is contained in a data source */</span>
<span class="type">int</span><span class="normal"> </span><span class="function">IMG_isGIF</span><span class="symbol">(</span><span class="usertype">SDL_RWops</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">src</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> is_GIF</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">char</span><span class="normal"> magic</span><span class="symbol">[</span><span class="number">6</span><span class="symbol">];</span>

<span class="normal">	is_GIF </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal"> </span><span class="function">SDL_RWread</span><span class="symbol">(</span><span class="normal">src</span><span class="symbol">,</span><span class="normal"> magic</span><span class="symbol">,</span><span class="normal"> </span><span class="number">6</span><span class="symbol">,</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal"> </span><span class="symbol">(</span><span class="function">strncmp</span><span class="symbol">(</span><span class="normal">magic</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"GIF"</span><span class="symbol">,</span><span class="normal"> </span><span class="number">3</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span>
<span class="normal">		     </span><span class="symbol">((</span><span class="function">memcmp</span><span class="symbol">(</span><span class="normal">magic </span><span class="symbol">+</span><span class="normal"> </span><span class="number">3</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"87a"</span><span class="symbol">,</span><span class="normal"> </span><span class="number">3</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">||</span>
<span class="normal">		      </span><span class="symbol">(</span><span class="function">memcmp</span><span class="symbol">(</span><span class="normal">magic </span><span class="symbol">+</span><span class="normal"> </span><span class="number">3</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"89a"</span><span class="symbol">,</span><span class="normal"> </span><span class="number">3</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			is_GIF </span><span class="symbol">=</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">return</span><span class="symbol">(</span><span class="normal">is_GIF</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="comment">/* Code from here to end of file has been adapted from XPaint:           */</span>
<span class="comment">/* +-------------------------------------------------------------------+ */</span>
<span class="comment">/* | Copyright 1990, 1991, 1993 David Koblas.			       | */</span>
<span class="comment">/* | Copyright 1996 Torsten Martinsen.				       | */</span>
<span class="comment">/* |   Permission to use, copy, modify, and distribute this software   | */</span>
<span class="comment">/* |   and its documentation for any purpose and without fee is hereby | */</span>
<span class="comment">/* |   granted, provided that the above copyright notice appear in all | */</span>
<span class="comment">/* |   copies and that both that copyright notice and this permission  | */</span>
<span class="comment">/* |   notice appear in supporting documentation.  This software is    | */</span>
<span class="comment">/* |   provided "as is" without express or implied warranty.	       | */</span>
<span class="comment">/* +-------------------------------------------------------------------+ */</span>

<span class="comment">/* Adapted for use in SDL by Sam Lantinga -- 7/20/98 */</span>
<span class="preproc">#define</span><span class="normal"> USED_BY_SDL</span>

<span class="preproc">#include</span><span class="normal"> </span><span class="string">&lt;stdio.h&gt;</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">&lt;string.h&gt;</span>

<span class="preproc">#ifdef</span><span class="normal"> USED_BY_SDL</span>
<span class="comment">/* Changes to work with SDL:</span>

<span class="comment">   Include SDL header file</span>
<span class="comment">   Use SDL_Surface rather than xpaint Image structure</span>
<span class="comment">   Define SDL versions of RWSetMsg(), ImageNewCmap() and ImageSetCmap()</span>
<span class="comment">*/</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">"SDL.h"</span>

<span class="preproc">#define</span><span class="normal"> </span><span class="usertype">Image</span><span class="normal">			SDL_Surface</span>
<span class="preproc">#define</span><span class="normal"> </span><span class="usertype">RWSetMsg</span><span class="normal">		IMG_SetError</span>
<span class="preproc">#define</span><span class="normal"> </span><span class="function">ImageNewCmap</span><span class="symbol">(</span><span class="normal">w</span><span class="symbol">,</span><span class="normal"> h</span><span class="symbol">,</span><span class="normal"> s</span><span class="symbol">)</span><span class="normal">	</span><span class="function">SDL_AllocSurface</span><span class="symbol">(</span><span class="normal">SDL_SWSURFACE</span><span class="symbol">,</span><span class="normal">w</span><span class="symbol">,</span><span class="normal">h</span><span class="symbol">,</span><span class="number">8</span><span class="symbol">,</span><span class="number">0</span><span class="symbol">,</span><span class="number">0</span><span class="symbol">,</span><span class="number">0</span><span class="symbol">,</span><span class="number">0</span><span class="symbol">)</span>
<span class="preproc">#define</span><span class="normal"> </span><span class="function">ImageSetCmap</span><span class="symbol">(</span><span class="normal">s</span><span class="symbol">,</span><span class="normal"> i</span><span class="symbol">,</span><span class="normal"> R</span><span class="symbol">,</span><span class="normal"> G</span><span class="symbol">,</span><span class="normal"> B</span><span class="symbol">)</span><span class="normal"> </span><span class="keyword">do</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">				s</span><span class="symbol">-&gt;</span><span class="normal">format</span><span class="symbol">-&gt;</span><span class="normal">palette</span><span class="symbol">-&gt;</span><span class="normal">colors</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">r </span><span class="symbol">=</span><span class="normal"> R</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">				s</span><span class="symbol">-&gt;</span><span class="normal">format</span><span class="symbol">-&gt;</span><span class="normal">palette</span><span class="symbol">-&gt;</span><span class="normal">colors</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">g </span><span class="symbol">=</span><span class="normal"> G</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">				s</span><span class="symbol">-&gt;</span><span class="normal">format</span><span class="symbol">-&gt;</span><span class="normal">palette</span><span class="symbol">-&gt;</span><span class="normal">colors</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">b </span><span class="symbol">=</span><span class="normal"> B</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">			</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="number">0</span><span class="symbol">)</span>
<span class="comment">/* * * * * */</span>

<span class="preproc">#else</span>

<span class="comment">/* Original XPaint sources */</span>

<span class="preproc">#include</span><span class="normal"> </span><span class="string">"image.h"</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">"rwTable.h"</span>

<span class="preproc">#define</span><span class="normal"> SDL_RWops	FILE</span>
<span class="preproc">#define</span><span class="normal"> SDL_RWclose	fclose</span>

<span class="preproc">#endif</span><span class="normal"> </span><span class="comment">/* USED_BY_SDL */</span>


<span class="preproc">#define</span><span class="normal">	MAXCOLORMAPSIZE		</span><span class="number">256</span>

<span class="preproc">#define</span><span class="normal">	TRUE	</span><span class="number">1</span>
<span class="preproc">#define</span><span class="normal">	FALSE	</span><span class="number">0</span>

<span class="preproc">#define</span><span class="normal"> CM_RED		</span><span class="number">0</span>
<span class="preproc">#define</span><span class="normal"> CM_GREEN	</span><span class="number">1</span>
<span class="preproc">#define</span><span class="normal"> CM_BLUE		</span><span class="number">2</span>

<span class="preproc">#define</span><span class="normal">	MAX_LWZ_BITS		</span><span class="number">12</span>

<span class="preproc">#define</span><span class="normal"> INTERLACE		</span><span class="number">0x40</span>
<span class="preproc">#define</span><span class="normal"> LOCALCOLORMAP	</span><span class="number">0x80</span>
<span class="preproc">#define</span><span class="normal"> </span><span class="function">BitSet</span><span class="symbol">(</span><span class="normal">byte</span><span class="symbol">,</span><span class="normal"> bit</span><span class="symbol">)</span><span class="normal">	</span><span class="symbol">(((</span><span class="normal">byte</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">bit</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">bit</span><span class="symbol">))</span>

<span class="preproc">#define</span><span class="normal">	</span><span class="function">ReadOK</span><span class="symbol">(</span><span class="normal">file</span><span class="symbol">,</span><span class="normal">buffer</span><span class="symbol">,</span><span class="normal">len</span><span class="symbol">)</span><span class="normal">	</span><span class="function">SDL_RWread</span><span class="symbol">(</span><span class="normal">file</span><span class="symbol">,</span><span class="normal"> buffer</span><span class="symbol">,</span><span class="normal"> len</span><span class="symbol">,</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span>

<span class="preproc">#define</span><span class="normal"> </span><span class="function">LM_to_uint</span><span class="symbol">(</span><span class="normal">a</span><span class="symbol">,</span><span class="normal">b</span><span class="symbol">)</span><span class="normal">			</span><span class="symbol">(((</span><span class="normal">b</span><span class="symbol">)&lt;&lt;</span><span class="number">8</span><span class="symbol">)|(</span><span class="normal">a</span><span class="symbol">))</span>

<span class="keyword">static</span><span class="normal"> </span><span class="keyword">struct</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">    </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> Width</span><span class="symbol">;</span>
<span class="normal">    </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> Height</span><span class="symbol">;</span>
<span class="normal">    </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> ColorMap</span><span class="symbol">[</span><span class="number">3</span><span class="symbol">][</span><span class="normal">MAXCOLORMAPSIZE</span><span class="symbol">];</span>
<span class="normal">    </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> BitPixel</span><span class="symbol">;</span>
<span class="normal">    </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> ColorResolution</span><span class="symbol">;</span>
<span class="normal">    </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> Background</span><span class="symbol">;</span>
<span class="normal">    </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> AspectRatio</span><span class="symbol">;</span>
<span class="normal">    </span><span class="type">int</span><span class="normal"> GrayScale</span><span class="symbol">;</span>
<span class="cbracket">}</span><span class="normal"> GifScreen</span><span class="symbol">;</span>

<span class="keyword">static</span><span class="normal"> </span><span class="keyword">struct</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">    </span><span class="type">int</span><span class="normal"> transparent</span><span class="symbol">;</span>
<span class="normal">    </span><span class="type">int</span><span class="normal"> delayTime</span><span class="symbol">;</span>
<span class="normal">    </span><span class="type">int</span><span class="normal"> inputFlag</span><span class="symbol">;</span>
<span class="normal">    </span><span class="type">int</span><span class="normal"> disposal</span><span class="symbol">;</span>
<span class="cbracket">}</span><span class="normal"> Gif89</span><span class="symbol">;</span>

<span class="keyword">static</span><span class="normal"> </span><span class="type">int</span><span class="normal"> </span><span class="function">ReadColorMap</span><span class="symbol">(</span><span class="normal">SDL_RWops </span><span class="symbol">*</span><span class="normal"> src</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> number</span><span class="symbol">,</span>
<span class="normal">			</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> buffer</span><span class="symbol">[</span><span class="number">3</span><span class="symbol">][</span><span class="normal">MAXCOLORMAPSIZE</span><span class="symbol">],</span><span class="normal"> </span><span class="type">int</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">flag</span><span class="symbol">);</span>
<span class="keyword">static</span><span class="normal"> </span><span class="type">int</span><span class="normal"> </span><span class="function">DoExtension</span><span class="symbol">(</span><span class="normal">SDL_RWops </span><span class="symbol">*</span><span class="normal"> src</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> label</span><span class="symbol">);</span>
<span class="keyword">static</span><span class="normal"> </span><span class="type">int</span><span class="normal"> </span><span class="function">GetDataBlock</span><span class="symbol">(</span><span class="normal">SDL_RWops </span><span class="symbol">*</span><span class="normal"> src</span><span class="symbol">,</span><span class="normal"> </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">buf</span><span class="symbol">);</span>
<span class="keyword">static</span><span class="normal"> </span><span class="type">int</span><span class="normal"> </span><span class="function">GetCode</span><span class="symbol">(</span><span class="normal">SDL_RWops </span><span class="symbol">*</span><span class="normal"> src</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> code_size</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> flag</span><span class="symbol">);</span>
<span class="keyword">static</span><span class="normal"> </span><span class="type">int</span><span class="normal"> </span><span class="function">LWZReadByte</span><span class="symbol">(</span><span class="normal">SDL_RWops </span><span class="symbol">*</span><span class="normal"> src</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> flag</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> input_code_size</span><span class="symbol">);</span>
<span class="keyword">static</span><span class="normal"> </span><span class="usertype">Image</span><span class="normal"> </span><span class="symbol">*</span><span class="function">ReadImage</span><span class="symbol">(</span><span class="normal">SDL_RWops </span><span class="symbol">*</span><span class="normal"> src</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> len</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> height</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="symbol">,</span>
<span class="normal">			</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> cmap</span><span class="symbol">[</span><span class="number">3</span><span class="symbol">][</span><span class="normal">MAXCOLORMAPSIZE</span><span class="symbol">],</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> gray</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> interlace</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> ignore</span><span class="symbol">);</span>

<span class="normal">Image </span><span class="symbol">*</span>
<span class="function">IMG_LoadGIF_RW</span><span class="symbol">(</span><span class="usertype">SDL_RWops</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">src</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> buf</span><span class="symbol">[</span><span class="number">16</span><span class="symbol">];</span>
<span class="normal">    </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> c</span><span class="symbol">;</span>
<span class="normal">    </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> localColorMap</span><span class="symbol">[</span><span class="number">3</span><span class="symbol">][</span><span class="normal">MAXCOLORMAPSIZE</span><span class="symbol">];</span>
<span class="normal">    </span><span class="type">int</span><span class="normal"> grayScale</span><span class="symbol">;</span>
<span class="normal">    </span><span class="type">int</span><span class="normal"> useGlobalColormap</span><span class="symbol">;</span>
<span class="normal">    </span><span class="type">int</span><span class="normal"> bitPixel</span><span class="symbol">;</span>
<span class="normal">    </span><span class="type">int</span><span class="normal"> imageCount </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">    </span><span class="type">char</span><span class="normal"> version</span><span class="symbol">[</span><span class="number">4</span><span class="symbol">];</span>
<span class="normal">    </span><span class="type">int</span><span class="normal"> imageNumber </span><span class="symbol">=</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">    </span><span class="usertype">Image</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">image </span><span class="symbol">=</span><span class="normal"> NULL</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal"> src </span><span class="symbol">==</span><span class="normal"> NULL </span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">        </span><span class="keyword">goto</span><span class="normal"> done</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="function">ReadOK</span><span class="symbol">(</span><span class="normal">src</span><span class="symbol">,</span><span class="normal"> buf</span><span class="symbol">,</span><span class="normal"> </span><span class="number">6</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="function">RWSetMsg</span><span class="symbol">(</span><span class="string">"error reading magic number"</span><span class="symbol">);</span>
<span class="normal">        </span><span class="keyword">goto</span><span class="normal"> done</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">strncmp</span><span class="symbol">((</span><span class="type">char</span><span class="normal"> </span><span class="symbol">*)</span><span class="normal"> buf</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"GIF"</span><span class="symbol">,</span><span class="normal"> </span><span class="number">3</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="function">RWSetMsg</span><span class="symbol">(</span><span class="string">"not a GIF file"</span><span class="symbol">);</span>
<span class="normal">        </span><span class="keyword">goto</span><span class="normal"> done</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="normal">    </span><span class="function">strncpy</span><span class="symbol">(</span><span class="normal">version</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">(</span><span class="type">char</span><span class="normal"> </span><span class="symbol">*)</span><span class="normal"> buf </span><span class="symbol">+</span><span class="normal"> </span><span class="number">3</span><span class="symbol">,</span><span class="normal"> </span><span class="number">3</span><span class="symbol">);</span>
<span class="normal">    version</span><span class="symbol">[</span><span class="number">3</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="string">'</span><span class="specialchar">\0</span><span class="string">'</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="function">strcmp</span><span class="symbol">(</span><span class="normal">version</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"87a"</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="function">strcmp</span><span class="symbol">(</span><span class="normal">version</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"89a"</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="function">RWSetMsg</span><span class="symbol">(</span><span class="string">"bad version number, not '87a' or '89a'"</span><span class="symbol">);</span>
<span class="normal">        </span><span class="keyword">goto</span><span class="normal"> done</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="normal">    Gif89</span><span class="symbol">.</span><span class="normal">transparent </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">    Gif89</span><span class="symbol">.</span><span class="normal">delayTime </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">    Gif89</span><span class="symbol">.</span><span class="normal">inputFlag </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">    Gif89</span><span class="symbol">.</span><span class="normal">disposal </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="function">ReadOK</span><span class="symbol">(</span><span class="normal">src</span><span class="symbol">,</span><span class="normal"> buf</span><span class="symbol">,</span><span class="normal"> </span><span class="number">7</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="function">RWSetMsg</span><span class="symbol">(</span><span class="string">"failed to read screen descriptor"</span><span class="symbol">);</span>
<span class="normal">        </span><span class="keyword">goto</span><span class="normal"> done</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="normal">    GifScreen</span><span class="symbol">.</span><span class="normal">Width </span><span class="symbol">=</span><span class="normal"> </span><span class="function">LM_to_uint</span><span class="symbol">(</span><span class="normal">buf</span><span class="symbol">[</span><span class="number">0</span><span class="symbol">],</span><span class="normal"> buf</span><span class="symbol">[</span><span class="number">1</span><span class="symbol">]);</span>
<span class="normal">    GifScreen</span><span class="symbol">.</span><span class="normal">Height </span><span class="symbol">=</span><span class="normal"> </span><span class="function">LM_to_uint</span><span class="symbol">(</span><span class="normal">buf</span><span class="symbol">[</span><span class="number">2</span><span class="symbol">],</span><span class="normal"> buf</span><span class="symbol">[</span><span class="number">3</span><span class="symbol">]);</span>
<span class="normal">    GifScreen</span><span class="symbol">.</span><span class="normal">BitPixel </span><span class="symbol">=</span><span class="normal"> </span><span class="number">2</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">buf</span><span class="symbol">[</span><span class="number">4</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x07</span><span class="symbol">);</span>
<span class="normal">    GifScreen</span><span class="symbol">.</span><span class="normal">ColorResolution </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(((</span><span class="normal">buf</span><span class="symbol">[</span><span class="number">4</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x70</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">3</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">    GifScreen</span><span class="symbol">.</span><span class="normal">Background </span><span class="symbol">=</span><span class="normal"> buf</span><span class="symbol">[</span><span class="number">5</span><span class="symbol">];</span>
<span class="normal">    GifScreen</span><span class="symbol">.</span><span class="normal">AspectRatio </span><span class="symbol">=</span><span class="normal"> buf</span><span class="symbol">[</span><span class="number">6</span><span class="symbol">];</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">BitSet</span><span class="symbol">(</span><span class="normal">buf</span><span class="symbol">[</span><span class="number">4</span><span class="symbol">],</span><span class="normal"> LOCALCOLORMAP</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal">	</span><span class="comment">/* Global Colormap */</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">ReadColorMap</span><span class="symbol">(</span><span class="normal">src</span><span class="symbol">,</span><span class="normal"> GifScreen</span><span class="symbol">.</span><span class="normal">BitPixel</span><span class="symbol">,</span><span class="normal"> GifScreen</span><span class="symbol">.</span><span class="normal">ColorMap</span><span class="symbol">,</span>
<span class="normal">			 </span><span class="symbol">&amp;</span><span class="normal">GifScreen</span><span class="symbol">.</span><span class="normal">GrayScale</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="function">RWSetMsg</span><span class="symbol">(</span><span class="string">"error reading global colormap"</span><span class="symbol">);</span>
<span class="normal">            </span><span class="keyword">goto</span><span class="normal"> done</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="normal">    </span><span class="keyword">do</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="function">ReadOK</span><span class="symbol">(</span><span class="normal">src</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">c</span><span class="symbol">,</span><span class="normal"> </span><span class="number">1</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="function">RWSetMsg</span><span class="symbol">(</span><span class="string">"EOF / read error on image data"</span><span class="symbol">);</span>
<span class="normal">            </span><span class="keyword">goto</span><span class="normal"> done</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">c </span><span class="symbol">==</span><span class="normal"> </span><span class="string">';'</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal">		</span><span class="comment">/* GIF terminator */</span>
<span class="normal">	    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">imageCount </span><span class="symbol">&lt;</span><span class="normal"> imageNumber</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">RWSetMsg</span><span class="symbol">(</span><span class="string">"only %d image%s found in file"</span><span class="symbol">,</span>
<span class="normal">			 imageCount</span><span class="symbol">,</span><span class="normal"> imageCount </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">?</span><span class="normal"> </span><span class="string">"s"</span><span class="normal"> </span><span class="symbol">:</span><span class="normal"> </span><span class="string">""</span><span class="symbol">);</span>
<span class="normal">                </span><span class="keyword">goto</span><span class="normal"> done</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">c </span><span class="symbol">==</span><span class="normal"> </span><span class="string">'!'</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal">		</span><span class="comment">/* Extension */</span>
<span class="normal">	    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="function">ReadOK</span><span class="symbol">(</span><span class="normal">src</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">c</span><span class="symbol">,</span><span class="normal"> </span><span class="number">1</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">RWSetMsg</span><span class="symbol">(</span><span class="string">"EOF / read error on extention function code"</span><span class="symbol">);</span>
<span class="normal">                </span><span class="keyword">goto</span><span class="normal"> done</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	    </span><span class="function">DoExtension</span><span class="symbol">(</span><span class="normal">src</span><span class="symbol">,</span><span class="normal"> c</span><span class="symbol">);</span>
<span class="normal">	    </span><span class="keyword">continue</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">c </span><span class="symbol">!=</span><span class="normal"> </span><span class="string">','</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal">		</span><span class="comment">/* Not a valid start character */</span>
<span class="normal">	    </span><span class="keyword">continue</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="symbol">++</span><span class="normal">imageCount</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="function">ReadOK</span><span class="symbol">(</span><span class="normal">src</span><span class="symbol">,</span><span class="normal"> buf</span><span class="symbol">,</span><span class="normal"> </span><span class="number">9</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="function">RWSetMsg</span><span class="symbol">(</span><span class="string">"couldn't read left/top/width/height"</span><span class="symbol">);</span>
<span class="normal">            </span><span class="keyword">goto</span><span class="normal"> done</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	useGlobalColormap </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">!</span><span class="function">BitSet</span><span class="symbol">(</span><span class="normal">buf</span><span class="symbol">[</span><span class="number">8</span><span class="symbol">],</span><span class="normal"> LOCALCOLORMAP</span><span class="symbol">);</span>

<span class="normal">	bitPixel </span><span class="symbol">=</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">buf</span><span class="symbol">[</span><span class="number">8</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x07</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">useGlobalColormap</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">ReadColorMap</span><span class="symbol">(</span><span class="normal">src</span><span class="symbol">,</span><span class="normal"> bitPixel</span><span class="symbol">,</span><span class="normal"> localColorMap</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">grayScale</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">RWSetMsg</span><span class="symbol">(</span><span class="string">"error reading local colormap"</span><span class="symbol">);</span>
<span class="normal">                </span><span class="keyword">goto</span><span class="normal"> done</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	    image </span><span class="symbol">=</span><span class="normal"> </span><span class="function">ReadImage</span><span class="symbol">(</span><span class="normal">src</span><span class="symbol">,</span><span class="normal"> </span><span class="function">LM_to_uint</span><span class="symbol">(</span><span class="normal">buf</span><span class="symbol">[</span><span class="number">4</span><span class="symbol">],</span><span class="normal"> buf</span><span class="symbol">[</span><span class="number">5</span><span class="symbol">]),</span>
<span class="normal">			      </span><span class="function">LM_to_uint</span><span class="symbol">(</span><span class="normal">buf</span><span class="symbol">[</span><span class="number">6</span><span class="symbol">],</span><span class="normal"> buf</span><span class="symbol">[</span><span class="number">7</span><span class="symbol">]),</span>
<span class="normal">			      bitPixel</span><span class="symbol">,</span><span class="normal"> localColorMap</span><span class="symbol">,</span><span class="normal"> grayScale</span><span class="symbol">,</span>
<span class="normal">			      </span><span class="function">BitSet</span><span class="symbol">(</span><span class="normal">buf</span><span class="symbol">[</span><span class="number">8</span><span class="symbol">],</span><span class="normal"> INTERLACE</span><span class="symbol">),</span>
<span class="normal">			      imageCount </span><span class="symbol">!=</span><span class="normal"> imageNumber</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	    image </span><span class="symbol">=</span><span class="normal"> </span><span class="function">ReadImage</span><span class="symbol">(</span><span class="normal">src</span><span class="symbol">,</span><span class="normal"> </span><span class="function">LM_to_uint</span><span class="symbol">(</span><span class="normal">buf</span><span class="symbol">[</span><span class="number">4</span><span class="symbol">],</span><span class="normal"> buf</span><span class="symbol">[</span><span class="number">5</span><span class="symbol">]),</span>
<span class="normal">			      </span><span class="function">LM_to_uint</span><span class="symbol">(</span><span class="normal">buf</span><span class="symbol">[</span><span class="number">6</span><span class="symbol">],</span><span class="normal"> buf</span><span class="symbol">[</span><span class="number">7</span><span class="symbol">]),</span>
<span class="normal">			      GifScreen</span><span class="symbol">.</span><span class="normal">BitPixel</span><span class="symbol">,</span><span class="normal"> GifScreen</span><span class="symbol">.</span><span class="normal">ColorMap</span><span class="symbol">,</span>
<span class="normal">			      GifScreen</span><span class="symbol">.</span><span class="normal">GrayScale</span><span class="symbol">,</span><span class="normal"> </span><span class="function">BitSet</span><span class="symbol">(</span><span class="normal">buf</span><span class="symbol">[</span><span class="number">8</span><span class="symbol">],</span><span class="normal"> INTERLACE</span><span class="symbol">),</span>
<span class="normal">			      imageCount </span><span class="symbol">!=</span><span class="normal"> imageNumber</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">    </span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">image </span><span class="symbol">==</span><span class="normal"> NULL</span><span class="symbol">);</span>

<span class="preproc">#ifdef</span><span class="normal"> USED_BY_SDL</span>
<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal"> Gif89</span><span class="symbol">.</span><span class="normal">transparent </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">0</span><span class="normal"> </span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">        </span><span class="function">SDL_SetColorKey</span><span class="symbol">(</span><span class="normal">image</span><span class="symbol">,</span><span class="normal"> SDL_SRCCOLORKEY</span><span class="symbol">,</span><span class="normal"> Gif89</span><span class="symbol">.</span><span class="normal">transparent</span><span class="symbol">);</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="preproc">#endif</span>

<span class="label">done:</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> image</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="keyword">static</span><span class="normal"> </span><span class="type">int</span>
<span class="function">ReadColorMap</span><span class="symbol">(</span><span class="usertype">SDL_RWops</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">src</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> number</span><span class="symbol">,</span>
<span class="normal">             </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> buffer</span><span class="symbol">[</span><span class="number">3</span><span class="symbol">][</span><span class="normal">MAXCOLORMAPSIZE</span><span class="symbol">],</span><span class="normal"> </span><span class="type">int</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">gray</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="type">int</span><span class="normal"> i</span><span class="symbol">;</span>
<span class="normal">    </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> rgb</span><span class="symbol">[</span><span class="number">3</span><span class="symbol">];</span>
<span class="normal">    </span><span class="type">int</span><span class="normal"> flag</span><span class="symbol">;</span>

<span class="normal">    flag </span><span class="symbol">=</span><span class="normal"> TRUE</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> number</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">++</span><span class="normal">i</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="function">ReadOK</span><span class="symbol">(</span><span class="normal">src</span><span class="symbol">,</span><span class="normal"> rgb</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="normal">rgb</span><span class="symbol">)))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="function">RWSetMsg</span><span class="symbol">(</span><span class="string">"bad colormap"</span><span class="symbol">);</span>
<span class="normal">	    </span><span class="keyword">return</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	buffer</span><span class="symbol">[</span><span class="normal">CM_RED</span><span class="symbol">][</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> rgb</span><span class="symbol">[</span><span class="number">0</span><span class="symbol">];</span>
<span class="normal">	buffer</span><span class="symbol">[</span><span class="normal">CM_GREEN</span><span class="symbol">][</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> rgb</span><span class="symbol">[</span><span class="number">1</span><span class="symbol">];</span>
<span class="normal">	buffer</span><span class="symbol">[</span><span class="normal">CM_BLUE</span><span class="symbol">][</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> rgb</span><span class="symbol">[</span><span class="number">2</span><span class="symbol">];</span>
<span class="normal">	flag </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">rgb</span><span class="symbol">[</span><span class="number">0</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> rgb</span><span class="symbol">[</span><span class="number">1</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> rgb</span><span class="symbol">[</span><span class="number">1</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> rgb</span><span class="symbol">[</span><span class="number">2</span><span class="symbol">]);</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="number">0</span>
<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">flag</span><span class="symbol">)</span>
<span class="normal">	</span><span class="symbol">*</span><span class="normal">gray </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">number </span><span class="symbol">==</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">?</span><span class="normal"> PBM_TYPE </span><span class="symbol">:</span><span class="normal"> PGM_TYPE</span><span class="symbol">;</span>
<span class="normal">    </span><span class="keyword">else</span>
<span class="normal">	</span><span class="symbol">*</span><span class="normal">gray </span><span class="symbol">=</span><span class="normal"> PPM_TYPE</span><span class="symbol">;</span>
<span class="preproc">#else</span>
<span class="normal">    </span><span class="symbol">*</span><span class="normal">gray </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="preproc">#endif</span>

<span class="normal">    </span><span class="keyword">return</span><span class="normal"> FALSE</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="keyword">static</span><span class="normal"> </span><span class="type">int</span>
<span class="function">DoExtension</span><span class="symbol">(</span><span class="usertype">SDL_RWops</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">src</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> label</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">static</span><span class="normal"> </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> buf</span><span class="symbol">[</span><span class="number">256</span><span class="symbol">];</span>
<span class="normal">    </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">str</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">switch</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">label</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">case</span><span class="normal"> </span><span class="number">0x01</span><span class="symbol">:</span><span class="normal">			</span><span class="comment">/* Plain Text Extension */</span>
<span class="normal">	str </span><span class="symbol">=</span><span class="normal"> </span><span class="string">"Plain Text Extension"</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">    </span><span class="keyword">case</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">:</span><span class="normal">			</span><span class="comment">/* Application Extension */</span>
<span class="normal">	str </span><span class="symbol">=</span><span class="normal"> </span><span class="string">"Application Extension"</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">    </span><span class="keyword">case</span><span class="normal"> </span><span class="number">0xfe</span><span class="symbol">:</span><span class="normal">			</span><span class="comment">/* Comment Extension */</span>
<span class="normal">	str </span><span class="symbol">=</span><span class="normal"> </span><span class="string">"Comment Extension"</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="function">GetDataBlock</span><span class="symbol">(</span><span class="normal">src</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*)</span><span class="normal"> buf</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> FALSE</span><span class="symbol">;</span>
<span class="normal">    </span><span class="keyword">case</span><span class="normal"> </span><span class="number">0xf9</span><span class="symbol">:</span><span class="normal">			</span><span class="comment">/* Graphic Control Extension */</span>
<span class="normal">	str </span><span class="symbol">=</span><span class="normal"> </span><span class="string">"Graphic Control Extension"</span><span class="symbol">;</span>
<span class="normal">	</span><span class="symbol">(</span><span class="type">void</span><span class="symbol">)</span><span class="normal"> </span><span class="function">GetDataBlock</span><span class="symbol">(</span><span class="normal">src</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*)</span><span class="normal"> buf</span><span class="symbol">);</span>
<span class="normal">	Gif89</span><span class="symbol">.</span><span class="normal">disposal </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">buf</span><span class="symbol">[</span><span class="number">0</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x7</span><span class="symbol">;</span>
<span class="normal">	Gif89</span><span class="symbol">.</span><span class="normal">inputFlag </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">buf</span><span class="symbol">[</span><span class="number">0</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x1</span><span class="symbol">;</span>
<span class="normal">	Gif89</span><span class="symbol">.</span><span class="normal">delayTime </span><span class="symbol">=</span><span class="normal"> </span><span class="function">LM_to_uint</span><span class="symbol">(</span><span class="normal">buf</span><span class="symbol">[</span><span class="number">1</span><span class="symbol">],</span><span class="normal"> buf</span><span class="symbol">[</span><span class="number">2</span><span class="symbol">]);</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">buf</span><span class="symbol">[</span><span class="number">0</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">	    Gif89</span><span class="symbol">.</span><span class="normal">transparent </span><span class="symbol">=</span><span class="normal"> buf</span><span class="symbol">[</span><span class="number">3</span><span class="symbol">];</span>

<span class="normal">	</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="function">GetDataBlock</span><span class="symbol">(</span><span class="normal">src</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*)</span><span class="normal"> buf</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> FALSE</span><span class="symbol">;</span>
<span class="label">    default:</span>
<span class="normal">	str </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="type">char</span><span class="normal"> </span><span class="symbol">*)</span><span class="normal">buf</span><span class="symbol">;</span>
<span class="normal">	</span><span class="function">sprintf</span><span class="symbol">(</span><span class="normal">str</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"UNKNOWN (0x%02x)"</span><span class="symbol">,</span><span class="normal"> label</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="function">GetDataBlock</span><span class="symbol">(</span><span class="normal">src</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*)</span><span class="normal"> buf</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">);</span>

<span class="normal">    </span><span class="keyword">return</span><span class="normal"> FALSE</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="keyword">static</span><span class="normal"> </span><span class="type">int</span><span class="normal"> ZeroDataBlock </span><span class="symbol">=</span><span class="normal"> FALSE</span><span class="symbol">;</span>

<span class="keyword">static</span><span class="normal"> </span><span class="type">int</span>
<span class="function">GetDataBlock</span><span class="symbol">(</span><span class="usertype">SDL_RWops</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">src</span><span class="symbol">,</span><span class="normal"> </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">buf</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> count</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="function">ReadOK</span><span class="symbol">(</span><span class="normal">src</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">count</span><span class="symbol">,</span><span class="normal"> </span><span class="number">1</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="comment">/* pm_message("error in getting DataBlock size" ); */</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="normal">    ZeroDataBlock </span><span class="symbol">=</span><span class="normal"> count </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">count </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(!</span><span class="function">ReadOK</span><span class="symbol">(</span><span class="normal">src</span><span class="symbol">,</span><span class="normal"> buf</span><span class="symbol">,</span><span class="normal"> count</span><span class="symbol">)))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="comment">/* pm_message("error in reading DataBlock" ); */</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> count</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="keyword">static</span><span class="normal"> </span><span class="type">int</span>
<span class="function">GetCode</span><span class="symbol">(</span><span class="usertype">SDL_RWops</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">src</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> code_size</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> flag</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">static</span><span class="normal"> </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> buf</span><span class="symbol">[</span><span class="number">280</span><span class="symbol">];</span>
<span class="normal">    </span><span class="keyword">static</span><span class="normal"> </span><span class="type">int</span><span class="normal"> curbit</span><span class="symbol">,</span><span class="normal"> lastbit</span><span class="symbol">,</span><span class="normal"> done</span><span class="symbol">,</span><span class="normal"> last_byte</span><span class="symbol">;</span>
<span class="normal">    </span><span class="type">int</span><span class="normal"> i</span><span class="symbol">,</span><span class="normal"> j</span><span class="symbol">,</span><span class="normal"> ret</span><span class="symbol">;</span>
<span class="normal">    </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> count</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">flag</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	curbit </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">	lastbit </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">	done </span><span class="symbol">=</span><span class="normal"> FALSE</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">curbit </span><span class="symbol">+</span><span class="normal"> code_size</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;=</span><span class="normal"> lastbit</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">done</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">curbit </span><span class="symbol">&gt;=</span><span class="normal"> lastbit</span><span class="symbol">)</span>
<span class="normal">		</span><span class="function">RWSetMsg</span><span class="symbol">(</span><span class="string">"ran off the end of my bits"</span><span class="symbol">);</span>
<span class="normal">	    </span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	buf</span><span class="symbol">[</span><span class="number">0</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> buf</span><span class="symbol">[</span><span class="normal">last_byte </span><span class="symbol">-</span><span class="normal"> </span><span class="number">2</span><span class="symbol">];</span>
<span class="normal">	buf</span><span class="symbol">[</span><span class="number">1</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> buf</span><span class="symbol">[</span><span class="normal">last_byte </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">];</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">count </span><span class="symbol">=</span><span class="normal"> </span><span class="function">GetDataBlock</span><span class="symbol">(</span><span class="normal">src</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">buf</span><span class="symbol">[</span><span class="number">2</span><span class="symbol">]))</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">	    done </span><span class="symbol">=</span><span class="normal"> TRUE</span><span class="symbol">;</span>

<span class="normal">	last_byte </span><span class="symbol">=</span><span class="normal"> </span><span class="number">2</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> count</span><span class="symbol">;</span>
<span class="normal">	curbit </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">curbit </span><span class="symbol">-</span><span class="normal"> lastbit</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="number">16</span><span class="symbol">;</span>
<span class="normal">	lastbit </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="number">2</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> count</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> </span><span class="number">8</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="normal">    ret </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">    </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> curbit</span><span class="symbol">,</span><span class="normal"> j </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> j </span><span class="symbol">&lt;</span><span class="normal"> code_size</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">++</span><span class="normal">i</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">++</span><span class="normal">j</span><span class="symbol">)</span>
<span class="normal">	ret </span><span class="symbol">|=</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">buf</span><span class="symbol">[</span><span class="normal">i </span><span class="symbol">/</span><span class="normal"> </span><span class="number">8</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="number">1</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">%</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)))</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> j</span><span class="symbol">;</span>

<span class="normal">    curbit </span><span class="symbol">+=</span><span class="normal"> code_size</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">return</span><span class="normal"> ret</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="keyword">static</span><span class="normal"> </span><span class="type">int</span>
<span class="function">LWZReadByte</span><span class="symbol">(</span><span class="usertype">SDL_RWops</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">src</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> flag</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> input_code_size</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">static</span><span class="normal"> </span><span class="type">int</span><span class="normal"> fresh </span><span class="symbol">=</span><span class="normal"> FALSE</span><span class="symbol">;</span>
<span class="normal">    </span><span class="type">int</span><span class="normal"> code</span><span class="symbol">,</span><span class="normal"> incode</span><span class="symbol">;</span>
<span class="normal">    </span><span class="keyword">static</span><span class="normal"> </span><span class="type">int</span><span class="normal"> code_size</span><span class="symbol">,</span><span class="normal"> set_code_size</span><span class="symbol">;</span>
<span class="normal">    </span><span class="keyword">static</span><span class="normal"> </span><span class="type">int</span><span class="normal"> max_code</span><span class="symbol">,</span><span class="normal"> max_code_size</span><span class="symbol">;</span>
<span class="normal">    </span><span class="keyword">static</span><span class="normal"> </span><span class="type">int</span><span class="normal"> firstcode</span><span class="symbol">,</span><span class="normal"> oldcode</span><span class="symbol">;</span>
<span class="normal">    </span><span class="keyword">static</span><span class="normal"> </span><span class="type">int</span><span class="normal"> clear_code</span><span class="symbol">,</span><span class="normal"> end_code</span><span class="symbol">;</span>
<span class="normal">    </span><span class="keyword">static</span><span class="normal"> </span><span class="type">int</span><span class="normal"> table</span><span class="symbol">[</span><span class="number">2</span><span class="symbol">][(</span><span class="number">1</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> MAX_LWZ_BITS</span><span class="symbol">)];</span>
<span class="normal">    </span><span class="keyword">static</span><span class="normal"> </span><span class="type">int</span><span class="normal"> stack</span><span class="symbol">[(</span><span class="number">1</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">MAX_LWZ_BITS</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> </span><span class="number">2</span><span class="symbol">],</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">sp</span><span class="symbol">;</span>
<span class="normal">    </span><span class="keyword">register</span><span class="normal"> </span><span class="type">int</span><span class="normal"> i</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">flag</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	set_code_size </span><span class="symbol">=</span><span class="normal"> input_code_size</span><span class="symbol">;</span>
<span class="normal">	code_size </span><span class="symbol">=</span><span class="normal"> set_code_size </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">	clear_code </span><span class="symbol">=</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> set_code_size</span><span class="symbol">;</span>
<span class="normal">	end_code </span><span class="symbol">=</span><span class="normal"> clear_code </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">	max_code_size </span><span class="symbol">=</span><span class="normal"> </span><span class="number">2</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> clear_code</span><span class="symbol">;</span>
<span class="normal">	max_code </span><span class="symbol">=</span><span class="normal"> clear_code </span><span class="symbol">+</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>

<span class="normal">	</span><span class="function">GetCode</span><span class="symbol">(</span><span class="normal">src</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> TRUE</span><span class="symbol">);</span>

<span class="normal">	fresh </span><span class="symbol">=</span><span class="normal"> TRUE</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> clear_code</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">++</span><span class="normal">i</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	    table</span><span class="symbol">[</span><span class="number">0</span><span class="symbol">][</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">	    table</span><span class="symbol">[</span><span class="number">1</span><span class="symbol">][</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> i</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="symbol">(</span><span class="number">1</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> MAX_LWZ_BITS</span><span class="symbol">);</span><span class="normal"> </span><span class="symbol">++</span><span class="normal">i</span><span class="symbol">)</span>
<span class="normal">	    table</span><span class="symbol">[</span><span class="number">0</span><span class="symbol">][</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> table</span><span class="symbol">[</span><span class="number">1</span><span class="symbol">][</span><span class="number">0</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">	sp </span><span class="symbol">=</span><span class="normal"> stack</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">fresh</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	fresh </span><span class="symbol">=</span><span class="normal"> FALSE</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">do</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	    firstcode </span><span class="symbol">=</span><span class="normal"> oldcode </span><span class="symbol">=</span><span class="normal"> </span><span class="function">GetCode</span><span class="symbol">(</span><span class="normal">src</span><span class="symbol">,</span><span class="normal"> code_size</span><span class="symbol">,</span><span class="normal"> FALSE</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">firstcode </span><span class="symbol">==</span><span class="normal"> clear_code</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> firstcode</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">sp </span><span class="symbol">&gt;</span><span class="normal"> stack</span><span class="symbol">)</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">*--</span><span class="normal">sp</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">code </span><span class="symbol">=</span><span class="normal"> </span><span class="function">GetCode</span><span class="symbol">(</span><span class="normal">src</span><span class="symbol">,</span><span class="normal"> code_size</span><span class="symbol">,</span><span class="normal"> FALSE</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">code </span><span class="symbol">==</span><span class="normal"> clear_code</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> clear_code</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">++</span><span class="normal">i</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		table</span><span class="symbol">[</span><span class="number">0</span><span class="symbol">][</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		table</span><span class="symbol">[</span><span class="number">1</span><span class="symbol">][</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> i</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	    </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="symbol">(</span><span class="number">1</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> MAX_LWZ_BITS</span><span class="symbol">);</span><span class="normal"> </span><span class="symbol">++</span><span class="normal">i</span><span class="symbol">)</span>
<span class="normal">		table</span><span class="symbol">[</span><span class="number">0</span><span class="symbol">][</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> table</span><span class="symbol">[</span><span class="number">1</span><span class="symbol">][</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">	    code_size </span><span class="symbol">=</span><span class="normal"> set_code_size </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">	    max_code_size </span><span class="symbol">=</span><span class="normal"> </span><span class="number">2</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> clear_code</span><span class="symbol">;</span>
<span class="normal">	    max_code </span><span class="symbol">=</span><span class="normal"> clear_code </span><span class="symbol">+</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">	    sp </span><span class="symbol">=</span><span class="normal"> stack</span><span class="symbol">;</span>
<span class="normal">	    firstcode </span><span class="symbol">=</span><span class="normal"> oldcode </span><span class="symbol">=</span><span class="normal"> </span><span class="function">GetCode</span><span class="symbol">(</span><span class="normal">src</span><span class="symbol">,</span><span class="normal"> code_size</span><span class="symbol">,</span><span class="normal"> FALSE</span><span class="symbol">);</span>
<span class="normal">	    </span><span class="keyword">return</span><span class="normal"> firstcode</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">code </span><span class="symbol">==</span><span class="normal"> end_code</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="type">int</span><span class="normal"> count</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> buf</span><span class="symbol">[</span><span class="number">260</span><span class="symbol">];</span>

<span class="normal">	    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ZeroDataBlock</span><span class="symbol">)</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">-</span><span class="number">2</span><span class="symbol">;</span>

<span class="normal">	    </span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">count </span><span class="symbol">=</span><span class="normal"> </span><span class="function">GetDataBlock</span><span class="symbol">(</span><span class="normal">src</span><span class="symbol">,</span><span class="normal"> buf</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">);</span>

<span class="normal">	    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">count </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="comment">/*</span>
<span class="comment">		 * pm_message("missing EOD in data stream (common occurence)");</span>
<span class="comment">		 */</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	    </span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">-</span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	incode </span><span class="symbol">=</span><span class="normal"> code</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">code </span><span class="symbol">&gt;=</span><span class="normal"> max_code</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="symbol">*</span><span class="normal">sp</span><span class="symbol">++</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> firstcode</span><span class="symbol">;</span>
<span class="normal">	    code </span><span class="symbol">=</span><span class="normal"> oldcode</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">code </span><span class="symbol">&gt;=</span><span class="normal"> clear_code</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="symbol">*</span><span class="normal">sp</span><span class="symbol">++</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> table</span><span class="symbol">[</span><span class="number">1</span><span class="symbol">][</span><span class="normal">code</span><span class="symbol">];</span>
<span class="normal">	    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">code </span><span class="symbol">==</span><span class="normal"> table</span><span class="symbol">[</span><span class="number">0</span><span class="symbol">][</span><span class="normal">code</span><span class="symbol">])</span>
<span class="normal">		</span><span class="function">RWSetMsg</span><span class="symbol">(</span><span class="string">"circular table entry BIG ERROR"</span><span class="symbol">);</span>
<span class="normal">	    code </span><span class="symbol">=</span><span class="normal"> table</span><span class="symbol">[</span><span class="number">0</span><span class="symbol">][</span><span class="normal">code</span><span class="symbol">];</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="symbol">*</span><span class="normal">sp</span><span class="symbol">++</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> firstcode </span><span class="symbol">=</span><span class="normal"> table</span><span class="symbol">[</span><span class="number">1</span><span class="symbol">][</span><span class="normal">code</span><span class="symbol">];</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">code </span><span class="symbol">=</span><span class="normal"> max_code</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="symbol">(</span><span class="number">1</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> MAX_LWZ_BITS</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	    table</span><span class="symbol">[</span><span class="number">0</span><span class="symbol">][</span><span class="normal">code</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> oldcode</span><span class="symbol">;</span>
<span class="normal">	    table</span><span class="symbol">[</span><span class="number">1</span><span class="symbol">][</span><span class="normal">code</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> firstcode</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="symbol">++</span><span class="normal">max_code</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">max_code </span><span class="symbol">&gt;=</span><span class="normal"> max_code_size</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span>
<span class="normal">		</span><span class="symbol">(</span><span class="normal">max_code_size </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="symbol">(</span><span class="number">1</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> MAX_LWZ_BITS</span><span class="symbol">)))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		max_code_size </span><span class="symbol">*=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">		</span><span class="symbol">++</span><span class="normal">code_size</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	oldcode </span><span class="symbol">=</span><span class="normal"> incode</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">sp </span><span class="symbol">&gt;</span><span class="normal"> stack</span><span class="symbol">)</span>
<span class="normal">	    </span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">*--</span><span class="normal">sp</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> code</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="keyword">static</span><span class="normal"> Image </span><span class="symbol">*</span>
<span class="function">ReadImage</span><span class="symbol">(</span><span class="normal">SDL_RWops </span><span class="symbol">*</span><span class="normal"> src</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> len</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> height</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> cmapSize</span><span class="symbol">,</span>
<span class="normal">	  </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> cmap</span><span class="symbol">[</span><span class="number">3</span><span class="symbol">][</span><span class="normal">MAXCOLORMAPSIZE</span><span class="symbol">],</span>
<span class="normal">	  </span><span class="type">int</span><span class="normal"> gray</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> interlace</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> ignore</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="usertype">Image</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">image</span><span class="symbol">;</span>
<span class="normal">    </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> c</span><span class="symbol">;</span>
<span class="normal">    </span><span class="type">int</span><span class="normal"> i</span><span class="symbol">,</span><span class="normal"> v</span><span class="symbol">;</span>
<span class="normal">    </span><span class="type">int</span><span class="normal"> xpos </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> ypos </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> pass </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">    </span><span class="comment">/*</span>
<span class="comment">    **	Initialize the compression routines</span>
<span class="comment">     */</span>
<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="function">ReadOK</span><span class="symbol">(</span><span class="normal">src</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">c</span><span class="symbol">,</span><span class="normal"> </span><span class="number">1</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="function">RWSetMsg</span><span class="symbol">(</span><span class="string">"EOF / read error on image data"</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> NULL</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">LWZReadByte</span><span class="symbol">(</span><span class="normal">src</span><span class="symbol">,</span><span class="normal"> TRUE</span><span class="symbol">,</span><span class="normal"> c</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="function">RWSetMsg</span><span class="symbol">(</span><span class="string">"error reading image"</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> NULL</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="normal">    </span><span class="comment">/*</span>
<span class="comment">    **	If this is an "uninteresting picture" ignore it.</span>
<span class="comment">     */</span>
<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ignore</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="function">LWZReadByte</span><span class="symbol">(</span><span class="normal">src</span><span class="symbol">,</span><span class="normal"> FALSE</span><span class="symbol">,</span><span class="normal"> c</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> NULL</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="normal">    image </span><span class="symbol">=</span><span class="normal"> </span><span class="function">ImageNewCmap</span><span class="symbol">(</span><span class="normal">len</span><span class="symbol">,</span><span class="normal"> height</span><span class="symbol">,</span><span class="normal"> cmapSize</span><span class="symbol">);</span>

<span class="normal">    </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> cmapSize</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">	</span><span class="function">ImageSetCmap</span><span class="symbol">(</span><span class="normal">image</span><span class="symbol">,</span><span class="normal"> i</span><span class="symbol">,</span><span class="normal"> cmap</span><span class="symbol">[</span><span class="normal">CM_RED</span><span class="symbol">][</span><span class="normal">i</span><span class="symbol">],</span>
<span class="normal">		     cmap</span><span class="symbol">[</span><span class="normal">CM_GREEN</span><span class="symbol">][</span><span class="normal">i</span><span class="symbol">],</span><span class="normal"> cmap</span><span class="symbol">[</span><span class="normal">CM_BLUE</span><span class="symbol">][</span><span class="normal">i</span><span class="symbol">]);</span>

<span class="normal">    </span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">v </span><span class="symbol">=</span><span class="normal"> </span><span class="function">LWZReadByte</span><span class="symbol">(</span><span class="normal">src</span><span class="symbol">,</span><span class="normal"> FALSE</span><span class="symbol">,</span><span class="normal"> c</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="preproc">#ifdef</span><span class="normal"> USED_BY_SDL</span>
<span class="normal">	</span><span class="symbol">((</span><span class="normal">Uint8 </span><span class="symbol">*)</span><span class="normal">image</span><span class="symbol">-&gt;</span><span class="normal">pixels</span><span class="symbol">)[</span><span class="normal">xpos </span><span class="symbol">+</span><span class="normal"> ypos </span><span class="symbol">*</span><span class="normal"> image</span><span class="symbol">-&gt;</span><span class="normal">pitch</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> v</span><span class="symbol">;</span>
<span class="preproc">#else</span>
<span class="normal">	image</span><span class="symbol">-&gt;</span><span class="normal">data</span><span class="symbol">[</span><span class="normal">xpos </span><span class="symbol">+</span><span class="normal"> ypos </span><span class="symbol">*</span><span class="normal"> len</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> v</span><span class="symbol">;</span>
<span class="preproc">#endif</span>
<span class="normal">	</span><span class="symbol">++</span><span class="normal">xpos</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">xpos </span><span class="symbol">==</span><span class="normal"> len</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	    xpos </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">interlace</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">switch</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pass</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">case</span><span class="normal"> </span><span class="number">0</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">case</span><span class="normal"> </span><span class="number">1</span><span class="symbol">:</span>
<span class="normal">		    ypos </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">8</span><span class="symbol">;</span>
<span class="normal">		    </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">case</span><span class="normal"> </span><span class="number">2</span><span class="symbol">:</span>
<span class="normal">		    ypos </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">4</span><span class="symbol">;</span>
<span class="normal">		    </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">case</span><span class="normal"> </span><span class="number">3</span><span class="symbol">:</span>
<span class="normal">		    ypos </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">		    </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>

<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ypos </span><span class="symbol">&gt;=</span><span class="normal"> height</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		    </span><span class="symbol">++</span><span class="normal">pass</span><span class="symbol">;</span>
<span class="normal">		    </span><span class="keyword">switch</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pass</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		    </span><span class="keyword">case</span><span class="normal"> </span><span class="number">1</span><span class="symbol">:</span>
<span class="normal">			ypos </span><span class="symbol">=</span><span class="normal"> </span><span class="number">4</span><span class="symbol">;</span>
<span class="normal">			</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">		    </span><span class="keyword">case</span><span class="normal"> </span><span class="number">2</span><span class="symbol">:</span>
<span class="normal">			ypos </span><span class="symbol">=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">			</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">		    </span><span class="keyword">case</span><span class="normal"> </span><span class="number">3</span><span class="symbol">:</span>
<span class="normal">			ypos </span><span class="symbol">=</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">			</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="label">		    default:</span>
<span class="normal">			</span><span class="keyword">goto</span><span class="normal"> fini</span><span class="symbol">;</span>
<span class="normal">		    </span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	    </span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="symbol">++</span><span class="normal">ypos</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ypos </span><span class="symbol">&gt;=</span><span class="normal"> height</span><span class="symbol">)</span>
<span class="normal">	    </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="label">  fini:</span>

<span class="normal">    </span><span class="keyword">return</span><span class="normal"> image</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="preproc">#else</span>

<span class="comment">/* See if an image is contained in a data source */</span>
<span class="type">int</span><span class="normal"> </span><span class="function">IMG_isGIF</span><span class="symbol">(</span><span class="usertype">SDL_RWops</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">src</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">return</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="comment">/* Load a GIF type image from an SDL datasource */</span>
<span class="usertype">SDL_Surface</span><span class="normal"> </span><span class="symbol">*</span><span class="function">IMG_LoadGIF_RW</span><span class="symbol">(</span><span class="usertype">SDL_RWops</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">src</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">return</span><span class="symbol">(</span><span class="normal">NULL</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="preproc">#endif</span><span class="normal"> </span><span class="comment">/* LOAD_GIF */</span>
</tt></pre></div><footer><div style="text-align: right; padding: 8pt; font-size: 13px"><a href="/xmlfeed/weblog-rss20.xml"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAAAPAgMAAAAOp6AcAAAADFBMVEVmZmb/ZgD///+JjnlbTUWmAAAACXBIWXMAAABIAAAASABGyWs+AAAACXZwQWcAAABQAAAADwCexKkxAAAAWUlEQVQYlWNgwAa0VmGAFQyqoSCQ/x8J/CBFMCt0ZdTU/F/7/+1HEkydFpoKVPn+93sUlUujQvP/7UcRTAuNDJ2a//s/imDqtKVZofm/1qGYSZk7sfodGwAAiobBJtffoNAAAAAASUVORK5CYII=" alt="RSS 2.0 Weblog Feed" width="80" height="15"/></a> <a href="/xmlfeed/weblog-atom10.xml"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAAAPAgMAAAAOp6AcAAAADFBMVEVmZmb/ZgD///+JjnlbTUWmAAAAaklEQVQYlWNgwAa0VmGAFQyqoSCQ/x8J/CBFMDV16rTQ/H/7V//69+//v/3/9oMEI6cuAwr+fv/+/b5d///v//0eJBgWOhMo+Gs9UPAdXDBy6lSYyn9wQZCZS0GCYDPXQcykzJ1Y/Y4NAABKvL80wyoMPgAAAABJRU5ErkJggg==" alt="Atom 1.0 Weblog Feed" width="80" height="15"/></a> <a href="http://validator.w3.org/check?uri=referer"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAAAPCAMAAABEF7i9AAAB1FBMVEUHQIgIRY0MN4QNRYoSRYsXUpIYVJQeUpUhWpgjUJMjWpgmU5QnXJkuYZ0uYpwwV5YyZJ4zaKM3ZaA5aaI6aqM6a6E8ZqA8Z6BAbaRBbqdCbaVHd61KSkpKcaZQUFBUf69UgbBVVVVXfq9Yg7NZhbJZh7RagrNeXVxeh7RfjLdgYGBiiLZmZmZnZ2doirhpkbt0m8F3m8B3ncJ5lb55ocR+ocSDgX+Do8eEpMqGhoaHp8iIpMeJjnmJpseKqMeOqsqPsdCQrcyVlZWVsM2Zs9CZtNCfu9ahoaGhuNShudSivNSjtMWjvNSmpqWnpqSrw9qvxNqyxdmyxdyzsK6zs7Ozx9y0xt21yN22tra4y+K80eK/v7/AwMDExMTEy9DH2ejK2+jM2ujN3uvP0dLR0NDR3uvS3uvS3+zU4u3V1dXY2dnY4u7Y4+3b5e/d3d3d5u/d5/De3t7f39/h4uLj4uHj6/Ll7PXm7fTn7/Xo7/Tp7/bq7Ozr6unr8ffw8PDw9vvx9fny+P7z8/Pz9vnz9vv3+fv4+vz5+vz6+vr6+/36/P36///7+/77/Pz7/f37/f78/Pz8/f38/f79/f39/f79/f/9/v79///+/v7+/v////3///+tYR2LAAABKklEQVQ4y2PQoTJg0JlNVYDPQBsyAMTAqaFes8tdsmdPCtA3MDStr3GKKK6myMAprgJ9pcpWs/MlRExYJBvNZLR0sigycHYOV1S7mtjsQJ4gf+HIFPXoWMs6qIGzIRiKZs9GFoEaMRuZhhrYqqJXy8uZYauRxC/VHew7e3YTPAxnI5swG6JxNrKBNjB1EFmIgV0+HA6C8pqqzhXG7BbJJROQIwViMYQ7G2oDQQNn57JyG7kxiCfObrBmS5+BHMuYLkTzMnYDm5WY4lOZZRPKZocxes+aPbuwCFsYohiICLvZsKBAMrDTQ7K/StveU8icTzrOL8JdLpOyWJ49u8Bx9ozw8DY7UYW03hhdxZAOSg2c3jN79rSJs1vSKmfOnpFXNJmynELlvExlAADnaZpLFGEC2wAAAABJRU5ErkJggg==" alt="Valid XHTML 1.1" width="80" height="15"/></a> <a href="http://jigsaw.w3.org/css-validator/check/referer"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAAAPCAMAAABEF7i9AAAB1FBMVEUHQIgIRY0MN4QNRYoSRYsXUpIYVJQeUpUhWpgjUJMjWpgmU5QnXJkuYZ0uYpwwV5YyZJ4zaKM3ZaA5aaI6aqM6a6E8ZqA8Z6BAbaRBbqdCbaVHd61KSkpKcaZQUFBUf69UgbBVVVVXfq9Yg7NZhbJZh7RagrNeXVxeh7RfjLdgYGBiiLZmZmZnZ2doirhpkbt0m8F3m8B3ncJ5lb55ocR+ocSDgX+Do8eEpMqGhoaHp8iIpMeJjnmJpseKqMeOqsqPsdCQrcyVlZWVsM2Zs9CZtNCfu9ahoaGhuNShudSivNSjtMWjvNSmpqWnpqSrw9qvxNqyxdmyxdyzsK6zs7Ozx9y0xt21yN22tra4y+K80eK/v7/AwMDExMTEy9DH2ejK2+jM2ujN3uvP0dLR0NDR3uvS3uvS3+zU4u3V1dXY2dnY4u7Y4+3b5e/d3d3d5u/d5/De3t7f39/h4uLj4uHj6/Ll7PXm7fTn7/Xo7/Tp7/bq7Ozr6unr8ffw8PDw9vvx9fny+P7z8/Pz9vnz9vv3+fv4+vz5+vz6+vr6+/36/P36///7+/77/Pz7/f37/f78/Pz8/f38/f79/f39/f79/f/9/v79///+/v7+/v////3///+tYR2LAAABEUlEQVQ4y2PQoTJg0JlNVYDPQBsyAMTAqaFes8tdsmdPCtA3MDStr3GKKK6myMAprgJ9pcpWs/MlRExYJBvNZLR0sigycHYOV1S7mtjsQJ4gf+HIFPXoWMs6mIEQCsIjwhKoga0qerW8nBm2Gkn8Ut3BvrNnN8HCcDYM2cBIogzs8uFwEJTXVHWuMGa3SC6ZgIgUqCEwdxJr4OxcVm4jNwbxxNkN1mzpM2ajGIjsPGK9PLtZiSk+lVk2oWx2GKP3rNmzC4tQwpDoIIQb2Okh2V+lbe8pZM4nHecX4S6XSVksz55d4Dh7Rnh4m52oQlpvjK5iSAelBk7vmT172sTZLWmVM2fPyCuaTFlOoXJepjIAANlljDGY/l5pAAAAAElFTkSuQmCC" alt="Valid CSS (2.1)" width="80" height="15"/></a><br/>Copyright 2005-2020 <a href="/about/">Timo Bingmann</a> - <a href="/about/impressum.html">Impressum</a></div></footer></body></html>