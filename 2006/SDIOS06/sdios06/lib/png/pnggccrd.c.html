<?xml version="1.0" encoding="iso-8859-1"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta content="text/html; charset=iso-8859-1" http-equiv="content-type" /><meta name="viewport" content="initial-scale=1"><title>/2006/SDIOS06/sdios06/lib/png/pnggccrd.c - panthema.net</title><link rel="stylesheet" type="text/css" href="/css/base.css" /><link rel="stylesheet" type="text/css" href="/css/fonts.css" /><link rel="alternate" type="application/rss+xml" title="panthema.net Weblog Feed RSS 2.0" href="http://panthema.net/xmlfeed/weblog-rss20.xml" /><link rel="alternate" type="application/atom+xml" title="panthema.net Weblog Feed Atom 1.0" href="http://panthema.net/xmlfeed/weblog-atom10.xml" /><script type="text/javascript" src="/js/base.js"></script><script type="text/javascript">/* <!-- */makeIEHover = function() {var lis = document.getElementById('ptnav').getElementsByTagName('li');for (var i = 0; i < lis.length; i++) {lis[i].onmouseover = function() {this.className += ' sfhover';};lis[i].onmouseout = function() {this.className = this.className.replace(new RegExp(' sfhover\b'), '');};}};if (window.attachEvent) window.attachEvent('onload', makeIEHover);/* --> */</script></head><body style="background-image: url(/img/bgfractal3.jpg)"><div class="pttopbar"><div style="float: right"><ul id="ptnav"><li class="top"><a class="ni" href="/"><i class="icon-book"></i> Weblog</a><ul style="margin-left: -6px; margin-top: 4px" class="nx"><li><a href="/2015/">2015</a></li><li><a href="/2014/">2014</a></li><li><a href="/2013/">2013</a></li><li><a href="/2012/">2012</a></li><li><a href="/2011/">2011</a></li><li><a href="/2010/">2010</a></li><li><a href="/2009/">2009</a></li><li><a href="/2008/">2008</a></li><li><a href="/2007/">2007</a></li><li><a href="/2006/">2006</a></li><li class="nt"><a href="/2005/">2005</a></li><li class="ns"><a href="/xmlfeed/weblog-rss20.xml">RSS Feed</a></li><li class="nt"><a href="/xmlfeed/weblog-atom10.xml">XML Atom</a></li><li class="ns"><a href="/search.html">Search</a></li></ul></li><li class="top"><a class="ni" href="/tags/"><i class="icon-tags"></i> Tags</a><div style="width: 14em; margin-left: -9em; margin-top: 4px"><a style="font-size: 10pt" href="/tags/algebra.html">algebra</a> <a style="font-size: 16pt" href="/tags/c++.html">c++</a> <a style="font-size: 12pt" href="/tags/code-example.html">code-example</a> <a style="font-size: 14pt" href="/tags/code-snippet.html">code-snippet</a> <a style="font-size: 11pt" href="/tags/coding_tricks.html">coding tricks</a> <a style="font-size: 10pt" href="/tags/compsci.html">compsci</a> <a style="font-size: 10pt" href="/tags/compsci_study_thesis.html">compsci study thesis</a> <a style="font-size: 9pt" href="/tags/crypto-speedtest.html">crypto-speedtest</a> <a style="font-size: 10pt" href="/tags/cryptography.html">cryptography</a> <a style="font-size: 9pt" href="/tags/cryptote.html">cryptote</a> <a style="font-size: 12pt" href="/tags/flex-bison-cpp-example.html">flex-bison-cpp-example</a> <a style="font-size: 16pt" href="/tags/frontpage.html">frontpage</a> <a style="font-size: 14pt" href="/tags/fun.html">fun</a> <a style="font-size: 10pt" href="/tags/graphviz.html">graphviz</a> <a style="font-size: 9pt" href="http://www.hmtg.de">hartmetall</a> <a style="font-size: 9pt" href="/tags/helppc.html">helppc</a> <a style="font-size: 9pt" href="/tags/hifi_selbstbau.html">hifi selbstbau</a> <a style="font-size: 10pt" href="/tags/latex.html">latex</a> <a style="font-size: 10pt" href="/tags/librivox.html">librivox</a> <a style="font-size: 10pt" href="/tags/linux.html">linux</a> <a style="font-size: 9pt" href="/tags/massive-sorting.html">massive-sorting</a> <a style="font-size: 10pt" href="/tags/maths.html">maths</a> <a style="font-size: 9pt" href="/tags/music.html">music</a> <a style="font-size: 10pt" href="/tags/netfundamentals.html">netfundamentals</a> <a style="font-size: 11pt" href="/tags/ns-3.html">ns-3</a> <a style="font-size: 10pt" href="/tags/parallel-string-sorting.html">parallel-string-sorting</a> <a style="font-size: 9pt" href="/tags/qtsqlview.html">qtsqlview</a> <a style="font-size: 13pt" href="/tags/research.html">research</a> <a style="font-size: 11pt" href="/tags/sdios06.html">sdios06</a> <a style="font-size: 9pt" href="/tags/sdlfractal.html">sdlfractal</a> <a style="font-size: 14pt" href="/tags/sorting.html">sorting</a> <a style="font-size: 10pt" href="/tags/stringology.html">stringology</a> <a style="font-size: 16pt" href="/tags/stx-btree.html">stx-btree</a> <a style="font-size: 9pt" href="/tags/stx-exparser.html">stx-exparser</a> <a style="font-size: 14pt" href="/tags/stxxl.html">stxxl</a> <a style="font-size: 16pt" href="/tags/talk.html">talk</a> <a style="font-size: 10pt" href="/tags/thrill.html">thrill</a> <a style="font-size: 10pt" href="/tags/tutorium.html">tutorium</a> <a style="font-size: 16pt" href="/tags/university.html">university</a> <a style="font-size: 13pt" href="/tags/utilities.html">utilities</a> <a style="font-size: 10pt" href="/tags/vncrec.html">vncrec</a> <a style="font-size: 9pt" href="/tags/webdesign.html">webdesign</a> </div></li><li class="top"> <a class="ni" href="#"><i class="icon-cubes"></i> Projects</a> <ul style="margin-left: -8em; margin-top: 4px;" class="nx"> <li><a href="/2009/cryptote/">CryptoTE</a></li> <li><a href="/2009/digup/">digup</a></li> <li><a href="/2013/disk-filltest/">disk-filltest</a></li> <li><a href="/2012/1119-eSAIS-Inducing-Suffix-and-LCP-Arrays-in-External-Memory/">eSAIS-LCP</a></li> <li><a href="/2007/flex-bison-cpp-example/">Flex Bison C++ Example</a></li> <li><a href="/2013/malloc_count/">malloc_count</a></li> <li><a href="/2013/parallel-string-sorting/">parallel-string-sorting</a></li> <li><a href="/2013/pmbw/">Parallel Memory Bandwidth</a></li> <li><a href="/2014/sqlplot-tools/">SqlPlotTools</a></li> <li><a href="/2013/sound-of-sorting/">The Sound of Sorting</a></li> <li><a href="/2007/stx-btree/">STX B+ Tree</a></li> <li><a href="/2010/stx-cbtreedb/">STX Constant BTreeDB</a></li> <li><a href="/2010/stx-execpipe/">STX ExecPipe</a></li> <li><a href="/2007/stx-exparser/">STX Expression Parser</a></li> <li><a href="/tags/stxxl.html">STXXL 1.4</a></li> <li class="nt"><a href="/2014/vncrec-rgb/">VNCrec RGB 0.4</a></li> <li class="ns"><a href="/search.html">Search</a></li> </ul></li><li class="top"> <a class="ni" href="#"><i class="icon-graduation-cap"></i> Research</a> <ul style="margin-left: -16em; margin-top: 4px" class="nx"> <li><a href="/2012/1119-eSAIS-Inducing-Suffix-and-LCP-Arrays-in-External-Memory/">eSAIS-LCP - External Memory Suffix Sorting</a></li> <li><a href="/2013/parallel-string-sorting/">Parallel String Sorting</a></li> <li><a href="/tags/massive-sorting.html">Practical Massively Parallel Sorting</a></li> <li><a href="/tags/stxxl.html">STXXL - External Memory Algorithms</a></li> <li class="ns"><a href="/search.html">Search</a></li> </ul></li><li class="top"> <a class="ni" href="/about/"><i class="icon-info-circled"></i> About</a> <ul style="margin-left: -6em; margin-top: 4px" class="nx"> <li><a href="/about/">Timo Bingmann</a></li> <li><a href="/about/impressum.html">Impressum</a></li> </ul></li><li class="top"> <a class="ni" href="/subscribe.html"><i class="icon-rss-squared"></i> Subscribe</a></li></ul></div><div style="padding: 6px"><a href="/">panthema</a>  / <a href="/2006/">2006</a> / <a href="/2006/SDIOS06/">SDIOS06</a> / <a href="/2006/SDIOS06/sdios06/">sdios06</a> / <a href="/2006/SDIOS06/sdios06/lib/">lib</a> / <a href="/2006/SDIOS06/sdios06/lib/png/">png</a> / <a href="/2006/SDIOS06/sdios06/lib/png/pnggccrd.c.html">pnggccrd.c</a> (<a href="/2006/SDIOS06/sdios06/lib/png/pnggccrd.c">Download File</a>)</div></div><div class="ptfullwidth"><pre class="codesnippet" style="font-family: monospace"><tt>
<span class="comment">/* pnggccrd.c - mixed C/assembler version of utilities to read a PNG file</span>
<span class="comment"> *</span>
<span class="comment"> * For Intel x86 CPU (Pentium-MMX or later) and GNU C compiler.</span>
<span class="comment"> *</span>
<span class="comment"> *     See </span><span class="url">http://www.intel.com/drg/pentiumII/appnotes/916/916.htm</span>
<span class="comment"> *     and </span><span class="url">http://www.intel.com/drg/pentiumII/appnotes/923/923.htm</span>
<span class="comment"> *     for Intel's performance analysis of the MMX vs. non-MMX code.</span>
<span class="comment"> *</span>
<span class="comment"> * Last changed in libpng 1.2.9 April 14, 2006</span>
<span class="comment"> * For conditions of distribution and use, see copyright notice in png.h</span>
<span class="comment"> * Copyright (c) 1998-2006 Glenn Randers-Pehrson</span>
<span class="comment"> * Copyright (c) 1998, Intel Corporation</span>
<span class="comment"> *</span>
<span class="comment"> * Based on MSVC code contributed by Nirav Chhatrapati, Intel Corp., 1998.</span>
<span class="comment"> * Interface to libpng contributed by Gilles Vollant, 1999.</span>
<span class="comment"> * GNU C port by Greg Roelofs, 1999-2001.</span>
<span class="comment"> *</span>
<span class="comment"> * Lines 2350-4300 converted in place with intel2gas 1.3.1:</span>
<span class="comment"> *</span>
<span class="comment"> *   intel2gas -mdI pnggccrd.c.partially-msvc -o pnggccrd.c</span>
<span class="comment"> *</span>
<span class="comment"> * and then cleaned up by hand.  See </span><span class="url">http://hermes.terminal.at/intel2gas/</span><span class="comment"> .</span>
<span class="comment"> *</span>
<span class="comment"> * NOTE:  A sufficiently recent version of GNU as (or as.exe under DOS/Windows)</span>
<span class="comment"> *        is required to assemble the newer MMX instructions such as movq.</span>
<span class="comment"> *        For djgpp, see</span>
<span class="comment"> *</span>
<span class="comment"> *           </span><span class="url">ftp://ftp.simtel.net/pub/simtelnet/gnu/djgpp/v2gnu/bnu281b.zip</span>
<span class="comment"> *</span>
<span class="comment"> *        (or a later version in the same directory).  For Linux, check your</span>
<span class="comment"> *        distribution's web site(s) or try these links:</span>
<span class="comment"> *</span>
<span class="comment"> *           </span><span class="url">http://rufus.w3.org/linux/RPM/binutils.html</span>
<span class="comment"> *           </span><span class="url">http://www.debian.org/Packages/stable/devel/binutils.html</span>
<span class="comment"> *           </span><span class="url">ftp://ftp.slackware.com/pub/linux/slackware/slackware/slakware/d1/</span>
<span class="comment"> *             binutils.tgz</span>
<span class="comment"> *</span>
<span class="comment"> *        For other platforms, see the main GNU site:</span>
<span class="comment"> *</span>
<span class="comment"> *           </span><span class="url">ftp://ftp.gnu.org/pub/gnu/binutils/</span>
<span class="comment"> *</span>
<span class="comment"> *        Version 2.5.2l.15 is definitely too old...</span>
<span class="comment"> */</span>

<span class="comment">/*</span>
<span class="comment"> * TEMPORARY PORTING NOTES AND CHANGELOG (mostly by Greg Roelofs)</span>
<span class="comment"> * =====================================</span>
<span class="comment"> *</span>
<span class="comment"> * 19991006:</span>
<span class="comment"> *  - fixed sign error in post-MMX cleanup code (16- &amp; 32-bit cases)</span>
<span class="comment"> *</span>
<span class="comment"> * 19991007:</span>
<span class="comment"> *  - additional optimizations (possible or definite):</span>
<span class="comment"> *     x [DONE] write MMX code for 64-bit case (pixel_bytes == 8) [not tested]</span>
<span class="comment"> *     - write MMX code for 48-bit case (pixel_bytes == 6)</span>
<span class="comment"> *     - figure out what's up with 24-bit case (pixel_bytes == 3):</span>
<span class="comment"> *        why subtract 8 from width_mmx in the pass 4/5 case?</span>
<span class="comment"> *        (only width_mmx case) (near line 1606)</span>
<span class="comment"> *     x [DONE] replace pixel_bytes within each block with the true</span>
<span class="comment"> *        constant value (or are compilers smart enough to do that?)</span>
<span class="comment"> *     - rewrite all MMX interlacing code so it's aligned with</span>
<span class="comment"> *        the *beginning* of the row buffer, not the end.  This</span>
<span class="comment"> *        would not only allow one to eliminate half of the memory</span>
<span class="comment"> *        writes for odd passes (that is, pass == odd), it may also</span>
<span class="comment"> *        eliminate some unaligned-data-access exceptions (assuming</span>
<span class="comment"> *        there's a penalty for not aligning 64-bit accesses on</span>
<span class="comment"> *        64-bit boundaries).  The only catch is that the "leftover"</span>
<span class="comment"> *        pixel(s) at the end of the row would have to be saved,</span>
<span class="comment"> *        but there are enough unused MMX registers in every case,</span>
<span class="comment"> *        so this is not a problem.  A further benefit is that the</span>
<span class="comment"> *        post-MMX cleanup code (C code) in at least some of the</span>
<span class="comment"> *        cases could be done within the assembler block.</span>
<span class="comment"> *  x [DONE] the "v3 v2 v1 v0 v7 v6 v5 v4" comments are confusing,</span>
<span class="comment"> *     inconsistent, and don't match the MMX Programmer's Reference</span>
<span class="comment"> *     Manual conventions anyway.  They should be changed to</span>
<span class="comment"> *     "b7 b6 b5 b4 b3 b2 b1 b0," where b0 indicates the byte that</span>
<span class="comment"> *     was lowest in memory (e.g., corresponding to a left pixel)</span>
<span class="comment"> *     and b7 is the byte that was highest (e.g., a right pixel).</span>
<span class="comment"> *</span>
<span class="comment"> * 19991016:</span>
<span class="comment"> *  - Brennan's Guide notwithstanding, gcc under Linux does *not*</span>
<span class="comment"> *     want globals prefixed by underscores when referencing them--</span>
<span class="comment"> *     i.e., if the variable is const4, then refer to it as const4,</span>
<span class="comment"> *     not _const4.  This seems to be a djgpp-specific requirement.</span>
<span class="comment"> *     Also, such variables apparently *must* be declared outside</span>
<span class="comment"> *     of functions; neither static nor automatic variables work if</span>
<span class="comment"> *     defined within the scope of a single function, but both</span>
<span class="comment"> *     static and truly global (multi-module) variables work fine.</span>
<span class="comment"> *</span>
<span class="comment"> * 19991023:</span>
<span class="comment"> *  - fixed png_combine_row() non-MMX replication bug (odd passes only?)</span>
<span class="comment"> *  - switched from string-concatenation-with-macros to cleaner method of</span>
<span class="comment"> *     renaming global variables for djgpp--i.e., always use prefixes in</span>
<span class="comment"> *     inlined assembler code (== strings) and conditionally rename the</span>
<span class="comment"> *     variables, not the other way around.  Hence _const4, _mask8_0, etc.</span>
<span class="comment"> *</span>
<span class="comment"> * 19991024:</span>
<span class="comment"> *  - fixed mmxsupport()/png_do_read_interlace() first-row bug</span>
<span class="comment"> *     This one was severely weird:  even though mmxsupport() doesn't touch</span>
<span class="comment"> *     ebx (where "row" pointer was stored), it nevertheless managed to zero</span>
<span class="comment"> *     the register (even in static/non-fPIC code--see below), which in turn</span>
<span class="comment"> *     caused png_do_read_interlace() to return prematurely on the first row of</span>
<span class="comment"> *     interlaced images (i.e., without expanding the interlaced pixels).</span>
<span class="comment"> *     Inspection of the generated assembly code didn't turn up any clues,</span>
<span class="comment"> *     although it did point at a minor optimization (i.e., get rid of</span>
<span class="comment"> *     mmx_supported_local variable and just use eax).  Possibly the CPUID</span>
<span class="comment"> *     instruction is more destructive than it looks?  (Not yet checked.)</span>
<span class="comment"> *  - "info gcc" was next to useless, so compared fPIC and non-fPIC assembly</span>
<span class="comment"> *     listings...  Apparently register spillage has to do with ebx, since</span>
<span class="comment"> *     it's used to index the global offset table.  Commenting it out of the</span>
<span class="comment"> *     input-reg lists in png_combine_row() eliminated compiler barfage, so</span>
<span class="comment"> *     ifdef'd with __PIC__ macro:  if defined, use a global for unmask</span>
<span class="comment"> *</span>
<span class="comment"> * 19991107:</span>
<span class="comment"> *  - verified CPUID clobberage:  12-char string constant ("GenuineIntel",</span>
<span class="comment"> *     "AuthenticAMD", etc.) placed in ebx:ecx:edx.  Still need to polish.</span>
<span class="comment"> *</span>
<span class="comment"> * 19991120:</span>
<span class="comment"> *  - made "diff" variable (now "_dif") global to simplify conversion of</span>
<span class="comment"> *     filtering routines (running out of regs, sigh).  "diff" is still used</span>
<span class="comment"> *     in interlacing routines, however.</span>
<span class="comment"> *  - fixed up both versions of mmxsupport() (ORIG_THAT_USED_TO_CLOBBER_EBX</span>
<span class="comment"> *     macro determines which is used); original not yet tested.</span>
<span class="comment"> *</span>
<span class="comment"> * 20000213:</span>
<span class="comment"> *  - when compiling with gcc, be sure to use  -fomit-frame-pointer</span>
<span class="comment"> *</span>
<span class="comment"> * 20000319:</span>
<span class="comment"> *  - fixed a register-name typo in png_do_read_interlace(), default (MMX) case,</span>
<span class="comment"> *     pass == 4 or 5, that caused visible corruption of interlaced images</span>
<span class="comment"> *</span>
<span class="comment"> * 20000623:</span>
<span class="comment"> *  - Various problems were reported with gcc 2.95.2 in the Cygwin environment,</span>
<span class="comment"> *     many of the form "forbidden register 0 (ax) was spilled for class AREG."</span>
<span class="comment"> *     This is explained at </span><span class="url">http://gcc.gnu.org/fom_serv/cache/23.html</span><span class="comment">, and</span>
<span class="comment"> *     Chuck Wilson supplied a patch involving dummy output registers.  See</span>
<span class="comment"> *     </span><span class="url">http://sourceforge.net/bugs/</span><span class="comment">?func=detailbug&amp;bug_id=108741&amp;group_id=5624</span>
<span class="comment"> *     for the original (anonymous) SourceForge bug report.</span>
<span class="comment"> *</span>
<span class="comment"> * 20000706:</span>
<span class="comment"> *  - Chuck Wilson passed along these remaining gcc 2.95.2 errors:</span>
<span class="comment"> *       pnggccrd.c: In function `png_combine_row':</span>
<span class="comment"> *       pnggccrd.c:525: more than 10 operands in `asm'</span>
<span class="comment"> *       pnggccrd.c:669: more than 10 operands in `asm'</span>
<span class="comment"> *       pnggccrd.c:828: more than 10 operands in `asm'</span>
<span class="comment"> *       pnggccrd.c:994: more than 10 operands in `asm'</span>
<span class="comment"> *       pnggccrd.c:1177: more than 10 operands in `asm'</span>
<span class="comment"> *     They are all the same problem and can be worked around by using the</span>
<span class="comment"> *     global _unmask variable unconditionally, not just in the -fPIC case.</span>
<span class="comment"> *     Reportedly earlier versions of gcc also have the problem with more than</span>
<span class="comment"> *     10 operands; they just don't report it.  Much strangeness ensues, etc.</span>
<span class="comment"> *</span>
<span class="comment"> * 20000729:</span>
<span class="comment"> *  - enabled png_read_filter_row_mmx_up() (shortest remaining unconverted</span>
<span class="comment"> *     MMX routine); began converting png_read_filter_row_mmx_sub()</span>
<span class="comment"> *  - to finish remaining sections:</span>
<span class="comment"> *     - clean up indentation and comments</span>
<span class="comment"> *     - preload local variables</span>
<span class="comment"> *     - add output and input regs (order of former determines numerical</span>
<span class="comment"> *        mapping of latter)</span>
<span class="comment"> *     - avoid all usage of ebx (including bx, bh, bl) register [20000823]</span>
<span class="comment"> *     - remove "$" from addressing of Shift and Mask variables [20000823]</span>
<span class="comment"> *</span>
<span class="comment"> * 20000731:</span>
<span class="comment"> *  - global union vars causing segfaults in png_read_filter_row_mmx_sub()?</span>
<span class="comment"> *</span>
<span class="comment"> * 20000822:</span>
<span class="comment"> *  - ARGH, stupid png_read_filter_row_mmx_sub() segfault only happens with</span>
<span class="comment"> *     shared-library (-fPIC) version!  Code works just fine as part of static</span>
<span class="comment"> *     library.  Damn damn damn damn damn, should have tested that sooner.</span>
<span class="comment"> *     ebx is getting clobbered again (explicitly this time); need to save it</span>
<span class="comment"> *     on stack or rewrite asm code to avoid using it altogether.  Blargh!</span>
<span class="comment"> *</span>
<span class="comment"> * 20000823:</span>
<span class="comment"> *  - first section was trickiest; all remaining sections have ebx -&gt; edx now.</span>
<span class="comment"> *     (-fPIC works again.)  Also added missing underscores to various Shift*</span>
<span class="comment"> *     and *Mask* globals and got rid of leading "$" signs.</span>
<span class="comment"> *</span>
<span class="comment"> * 20000826:</span>
<span class="comment"> *  - added visual separators to help navigate microscopic printed copies</span>
<span class="comment"> *     (</span><span class="url">http://pobox.com/~newt/code/gpr-latest.zip</span><span class="comment">, mode 10); started working</span>
<span class="comment"> *     on png_read_filter_row_mmx_avg()</span>
<span class="comment"> *</span>
<span class="comment"> * 20000828:</span>
<span class="comment"> *  - finished png_read_filter_row_mmx_avg():  only Paeth left! (930 lines...)</span>
<span class="comment"> *     What the hell, did png_read_filter_row_mmx_paeth(), too.  Comments not</span>
<span class="comment"> *     cleaned up/shortened in either routine, but functionality is complete</span>
<span class="comment"> *     and seems to be working fine.</span>
<span class="comment"> *</span>
<span class="comment"> * 20000829:</span>
<span class="comment"> *  - ahhh, figured out last(?) bit of gcc/gas asm-fu:  if register is listed</span>
<span class="comment"> *     as an input reg (with dummy output variables, etc.), then it *cannot*</span>
<span class="comment"> *     also appear in the clobber list or gcc 2.95.2 will barf.  The solution</span>
<span class="comment"> *     is simple enough...</span>
<span class="comment"> *</span>
<span class="comment"> * 20000914:</span>
<span class="comment"> *  - bug in png_read_filter_row_mmx_avg():  16-bit grayscale not handled</span>
<span class="comment"> *     correctly (but 48-bit RGB just fine)</span>
<span class="comment"> *</span>
<span class="comment"> * 20000916:</span>
<span class="comment"> *  - fixed bug in png_read_filter_row_mmx_avg(), bpp == 2 case; three errors:</span>
<span class="comment"> *     - "_ShiftBpp.use = 24;"      should have been   "_ShiftBpp.use = 16;"</span>
<span class="comment"> *     - "_ShiftRem.use = 40;"      should have been   "_ShiftRem.use = 48;"</span>
<span class="comment"> *     - "psllq _ShiftRem, %%mm2"   should have been   "psrlq _ShiftRem, %%mm2"</span>
<span class="comment"> *</span>
<span class="comment"> * 20010101:</span>
<span class="comment"> *  - added new png_init_mmx_flags() function (here only because it needs to</span>
<span class="comment"> *     call mmxsupport(), which should probably become global png_mmxsupport());</span>
<span class="comment"> *     modified other MMX routines to run conditionally (png_ptr-&gt;asm_flags)</span>
<span class="comment"> *</span>
<span class="comment"> * 20010103:</span>
<span class="comment"> *  - renamed mmxsupport() to png_mmx_support(), with auto-set of mmx_supported,</span>
<span class="comment"> *     and made it public; moved png_init_mmx_flags() to png.c as internal func</span>
<span class="comment"> *</span>
<span class="comment"> * 20010104:</span>
<span class="comment"> *  - removed dependency on png_read_filter_row_c() (C code already duplicated</span>
<span class="comment"> *     within MMX version of png_read_filter_row()) so no longer necessary to</span>
<span class="comment"> *     compile it into pngrutil.o</span>
<span class="comment"> *</span>
<span class="comment"> * 20010310:</span>
<span class="comment"> *  - fixed buffer-overrun bug in png_combine_row() C code (non-MMX)</span>
<span class="comment"> *</span>
<span class="comment"> * 20020304:</span>
<span class="comment"> *  - eliminated incorrect use of width_mmx in pixel_bytes == 8 case</span>
<span class="comment"> *</span>
<span class="comment"> * 20040724:</span>
<span class="comment"> *   - more tinkering with clobber list at lines 4529 and 5033, to get</span>
<span class="comment"> *     it to compile on gcc-3.4.</span>
<span class="comment"> *</span>
<span class="comment"> * STILL TO DO:</span>
<span class="comment"> *     - test png_do_read_interlace() 64-bit case (pixel_bytes == 8)</span>
<span class="comment"> *     - write MMX code for 48-bit case (pixel_bytes == 6)</span>
<span class="comment"> *     - figure out what's up with 24-bit case (pixel_bytes == 3):</span>
<span class="comment"> *        why subtract 8 from width_mmx in the pass 4/5 case?</span>
<span class="comment"> *        (only width_mmx case) (near line 1606)</span>
<span class="comment"> *     - rewrite all MMX interlacing code so it's aligned with beginning</span>
<span class="comment"> *        of the row buffer, not the end (see 19991007 for details)</span>
<span class="comment"> *     x pick one version of mmxsupport() and get rid of the other</span>
<span class="comment"> *     - add error messages to any remaining bogus default cases</span>
<span class="comment"> *     - enable pixel_depth == 8 cases in png_read_filter_row()? (test speed)</span>
<span class="comment"> *     x add support for runtime enable/disable/query of various MMX routines</span>
<span class="comment"> */</span>

<span class="preproc">#define</span><span class="normal"> PNG_INTERNAL</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">"png.h"</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_USE_PNGGCCRD</span><span class="symbol">)</span>

<span class="type">int</span><span class="normal"> </span><span class="usertype">PNGAPI</span><span class="normal"> </span><span class="function">png_mmx_support</span><span class="symbol">(</span><span class="type">void</span><span class="symbol">);</span>

<span class="preproc">#ifdef</span><span class="normal"> PNG_USE_LOCAL_ARRAYS</span>
<span class="keyword">static</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> </span><span class="type">int</span><span class="normal"> </span><span class="usertype">FARDATA</span><span class="normal"> png_pass_start</span><span class="symbol">[</span><span class="number">7</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="cbracket">{</span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="number">4</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="number">2</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="cbracket">}</span><span class="symbol">;</span>
<span class="keyword">static</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> </span><span class="type">int</span><span class="normal"> </span><span class="usertype">FARDATA</span><span class="normal"> png_pass_inc</span><span class="symbol">[</span><span class="number">7</span><span class="symbol">]</span><span class="normal">   </span><span class="symbol">=</span><span class="normal"> </span><span class="cbracket">{</span><span class="number">8</span><span class="symbol">,</span><span class="normal"> </span><span class="number">8</span><span class="symbol">,</span><span class="normal"> </span><span class="number">4</span><span class="symbol">,</span><span class="normal"> </span><span class="number">4</span><span class="symbol">,</span><span class="normal"> </span><span class="number">2</span><span class="symbol">,</span><span class="normal"> </span><span class="number">2</span><span class="symbol">,</span><span class="normal"> </span><span class="number">1</span><span class="cbracket">}</span><span class="symbol">;</span>
<span class="keyword">static</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> </span><span class="type">int</span><span class="normal"> </span><span class="usertype">FARDATA</span><span class="normal"> png_pass_width</span><span class="symbol">[</span><span class="number">7</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="cbracket">{</span><span class="number">8</span><span class="symbol">,</span><span class="normal"> </span><span class="number">4</span><span class="symbol">,</span><span class="normal"> </span><span class="number">4</span><span class="symbol">,</span><span class="normal"> </span><span class="number">2</span><span class="symbol">,</span><span class="normal"> </span><span class="number">2</span><span class="symbol">,</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="number">1</span><span class="cbracket">}</span><span class="symbol">;</span>
<span class="preproc">#endif</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_ASSEMBLER_CODE_SUPPORTED</span><span class="symbol">)</span>
<span class="comment">/* djgpp, Win32, Cygwin, and OS2 add their own underscores to global variables,</span>
<span class="comment"> * so define them without: */</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">__DJGPP__</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">WIN32</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">__CYGWIN__</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">    </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">__OS2__</span><span class="symbol">)</span>
<span class="preproc">#  define</span><span class="normal"> </span><span class="usertype">_mmx_supported</span><span class="normal">  mmx_supported</span>
<span class="preproc">#  define</span><span class="normal"> _const4         const4</span>
<span class="preproc">#  define</span><span class="normal"> _const6         const6</span>
<span class="preproc">#  define</span><span class="normal"> </span><span class="usertype">_mask8_0</span><span class="normal">        mask8_0</span>
<span class="preproc">#  define</span><span class="normal"> </span><span class="usertype">_mask16_1</span><span class="normal">       mask16_1</span>
<span class="preproc">#  define</span><span class="normal"> </span><span class="usertype">_mask16_0</span><span class="normal">       mask16_0</span>
<span class="preproc">#  define</span><span class="normal"> </span><span class="usertype">_mask24_2</span><span class="normal">       mask24_2</span>
<span class="preproc">#  define</span><span class="normal"> </span><span class="usertype">_mask24_1</span><span class="normal">       mask24_1</span>
<span class="preproc">#  define</span><span class="normal"> </span><span class="usertype">_mask24_0</span><span class="normal">       mask24_0</span>
<span class="preproc">#  define</span><span class="normal"> </span><span class="usertype">_mask32_3</span><span class="normal">       mask32_3</span>
<span class="preproc">#  define</span><span class="normal"> </span><span class="usertype">_mask32_2</span><span class="normal">       mask32_2</span>
<span class="preproc">#  define</span><span class="normal"> </span><span class="usertype">_mask32_1</span><span class="normal">       mask32_1</span>
<span class="preproc">#  define</span><span class="normal"> </span><span class="usertype">_mask32_0</span><span class="normal">       mask32_0</span>
<span class="preproc">#  define</span><span class="normal"> </span><span class="usertype">_mask48_5</span><span class="normal">       mask48_5</span>
<span class="preproc">#  define</span><span class="normal"> </span><span class="usertype">_mask48_4</span><span class="normal">       mask48_4</span>
<span class="preproc">#  define</span><span class="normal"> </span><span class="usertype">_mask48_3</span><span class="normal">       mask48_3</span>
<span class="preproc">#  define</span><span class="normal"> </span><span class="usertype">_mask48_2</span><span class="normal">       mask48_2</span>
<span class="preproc">#  define</span><span class="normal"> </span><span class="usertype">_mask48_1</span><span class="normal">       mask48_1</span>
<span class="preproc">#  define</span><span class="normal"> </span><span class="usertype">_mask48_0</span><span class="normal">       mask48_0</span>
<span class="preproc">#  define</span><span class="normal"> _LBCarryMask    LBCarryMask</span>
<span class="preproc">#  define</span><span class="normal"> _HBClearMask    HBClearMask</span>
<span class="preproc">#  define</span><span class="normal"> _ActiveMask     ActiveMask</span>
<span class="preproc">#  define</span><span class="normal"> _ActiveMask2    ActiveMask2</span>
<span class="preproc">#  define</span><span class="normal"> _ActiveMaskEnd  ActiveMaskEnd</span>
<span class="preproc">#  define</span><span class="normal"> _ShiftBpp       ShiftBpp</span>
<span class="preproc">#  define</span><span class="normal"> _ShiftRem       ShiftRem</span>
<span class="preproc">#ifdef</span><span class="normal"> PNG_THREAD_UNSAFE_OK</span>
<span class="preproc">#  define</span><span class="normal"> _unmask         unmask</span>
<span class="preproc">#  define</span><span class="normal"> _FullLength     FullLength</span>
<span class="preproc">#  define</span><span class="normal"> _MMXLength      MMXLength</span>
<span class="preproc">#  define</span><span class="normal"> _dif            dif</span>
<span class="preproc">#  define</span><span class="normal"> _patemp         patemp</span>
<span class="preproc">#  define</span><span class="normal"> _pbtemp         pbtemp</span>
<span class="preproc">#  define</span><span class="normal"> _pctemp         pctemp</span>
<span class="preproc">#endif</span>
<span class="preproc">#endif</span>


<span class="comment">/* These constants are used in the inlined MMX assembly code.</span>
<span class="comment">   Ignore gcc's "At top level: defined but not used" warnings. */</span>

<span class="comment">/* GRR 20000706:  originally _unmask was needed only when compiling with -fPIC,</span>
<span class="comment"> *  since that case uses the %ebx register for indexing the Global Offset Table</span>
<span class="comment"> *  and there were no other registers available.  But gcc 2.95 and later emit</span>
<span class="comment"> *  "more than 10 operands in `asm'" errors when %ebx is used to preload unmask</span>
<span class="comment"> *  in the non-PIC case, so we'll just use the global unconditionally now.</span>
<span class="comment"> */</span>
<span class="preproc">#ifdef</span><span class="normal"> PNG_THREAD_UNSAFE_OK</span>
<span class="keyword">static</span><span class="normal"> </span><span class="type">int</span><span class="normal"> _unmask</span><span class="symbol">;</span>
<span class="preproc">#endif</span>

<span class="keyword">static</span><span class="normal"> </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">long</span><span class="normal"> </span><span class="type">long</span><span class="normal"> _mask8_0  </span><span class="symbol">=</span><span class="normal"> 0x0102040810204080LL</span><span class="symbol">;</span>

<span class="keyword">static</span><span class="normal"> </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">long</span><span class="normal"> </span><span class="type">long</span><span class="normal"> _mask16_1 </span><span class="symbol">=</span><span class="normal"> 0x0101020204040808LL</span><span class="symbol">;</span>
<span class="keyword">static</span><span class="normal"> </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">long</span><span class="normal"> </span><span class="type">long</span><span class="normal"> _mask16_0 </span><span class="symbol">=</span><span class="normal"> 0x1010202040408080LL</span><span class="symbol">;</span>

<span class="keyword">static</span><span class="normal"> </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">long</span><span class="normal"> </span><span class="type">long</span><span class="normal"> _mask24_2 </span><span class="symbol">=</span><span class="normal"> 0x0101010202020404LL</span><span class="symbol">;</span>
<span class="keyword">static</span><span class="normal"> </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">long</span><span class="normal"> </span><span class="type">long</span><span class="normal"> _mask24_1 </span><span class="symbol">=</span><span class="normal"> 0x0408080810101020LL</span><span class="symbol">;</span>
<span class="keyword">static</span><span class="normal"> </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">long</span><span class="normal"> </span><span class="type">long</span><span class="normal"> _mask24_0 </span><span class="symbol">=</span><span class="normal"> 0x2020404040808080LL</span><span class="symbol">;</span>

<span class="keyword">static</span><span class="normal"> </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">long</span><span class="normal"> </span><span class="type">long</span><span class="normal"> _mask32_3 </span><span class="symbol">=</span><span class="normal"> 0x0101010102020202LL</span><span class="symbol">;</span>
<span class="keyword">static</span><span class="normal"> </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">long</span><span class="normal"> </span><span class="type">long</span><span class="normal"> _mask32_2 </span><span class="symbol">=</span><span class="normal"> 0x0404040408080808LL</span><span class="symbol">;</span>
<span class="keyword">static</span><span class="normal"> </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">long</span><span class="normal"> </span><span class="type">long</span><span class="normal"> _mask32_1 </span><span class="symbol">=</span><span class="normal"> 0x1010101020202020LL</span><span class="symbol">;</span>
<span class="keyword">static</span><span class="normal"> </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">long</span><span class="normal"> </span><span class="type">long</span><span class="normal"> _mask32_0 </span><span class="symbol">=</span><span class="normal"> 0x4040404080808080LL</span><span class="symbol">;</span>

<span class="keyword">static</span><span class="normal"> </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">long</span><span class="normal"> </span><span class="type">long</span><span class="normal"> _mask48_5 </span><span class="symbol">=</span><span class="normal"> 0x0101010101010202LL</span><span class="symbol">;</span>
<span class="keyword">static</span><span class="normal"> </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">long</span><span class="normal"> </span><span class="type">long</span><span class="normal"> _mask48_4 </span><span class="symbol">=</span><span class="normal"> 0x0202020204040404LL</span><span class="symbol">;</span>
<span class="keyword">static</span><span class="normal"> </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">long</span><span class="normal"> </span><span class="type">long</span><span class="normal"> _mask48_3 </span><span class="symbol">=</span><span class="normal"> 0x0404080808080808LL</span><span class="symbol">;</span>
<span class="keyword">static</span><span class="normal"> </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">long</span><span class="normal"> </span><span class="type">long</span><span class="normal"> _mask48_2 </span><span class="symbol">=</span><span class="normal"> 0x1010101010102020LL</span><span class="symbol">;</span>
<span class="keyword">static</span><span class="normal"> </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">long</span><span class="normal"> </span><span class="type">long</span><span class="normal"> _mask48_1 </span><span class="symbol">=</span><span class="normal"> 0x2020202040404040LL</span><span class="symbol">;</span>
<span class="keyword">static</span><span class="normal"> </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">long</span><span class="normal"> </span><span class="type">long</span><span class="normal"> _mask48_0 </span><span class="symbol">=</span><span class="normal"> 0x4040808080808080LL</span><span class="symbol">;</span>

<span class="keyword">static</span><span class="normal"> </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">long</span><span class="normal"> </span><span class="type">long</span><span class="normal"> _const4   </span><span class="symbol">=</span><span class="normal"> 0x0000000000FFFFFFLL</span><span class="symbol">;</span>
<span class="comment">//static unsigned long long _const5 = 0x000000FFFFFF0000LL;     // NOT USED</span>
<span class="keyword">static</span><span class="normal"> </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">long</span><span class="normal"> </span><span class="type">long</span><span class="normal"> _const6   </span><span class="symbol">=</span><span class="normal"> 0x00000000000000FFLL</span><span class="symbol">;</span>

<span class="comment">// These are used in the row-filter routines and should/would be local</span>
<span class="comment">//  variables if not for gcc addressing limitations.</span>
<span class="comment">// WARNING: Their presence probably defeats the thread safety of libpng.</span>

<span class="preproc">#ifdef</span><span class="normal"> PNG_THREAD_UNSAFE_OK</span>
<span class="keyword">static</span><span class="normal"> </span><span class="usertype">png_uint_32</span><span class="normal">  _FullLength</span><span class="symbol">;</span>
<span class="keyword">static</span><span class="normal"> </span><span class="usertype">png_uint_32</span><span class="normal">  _MMXLength</span><span class="symbol">;</span>
<span class="keyword">static</span><span class="normal"> </span><span class="type">int</span><span class="normal">          _dif</span><span class="symbol">;</span>
<span class="keyword">static</span><span class="normal"> </span><span class="type">int</span><span class="normal">          _patemp</span><span class="symbol">;</span><span class="normal"> </span><span class="comment">// temp variables for Paeth routine</span>
<span class="keyword">static</span><span class="normal"> </span><span class="type">int</span><span class="normal">          _pbtemp</span><span class="symbol">;</span>
<span class="keyword">static</span><span class="normal"> </span><span class="type">int</span><span class="normal">          _pctemp</span><span class="symbol">;</span>
<span class="preproc">#endif</span>

<span class="type">void</span><span class="normal"> </span><span class="comment">/* PRIVATE */</span>
<span class="function">png_squelch_warnings</span><span class="symbol">(</span><span class="type">void</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="preproc">#ifdef</span><span class="normal"> PNG_THREAD_UNSAFE_OK</span>
<span class="normal">   _dif </span><span class="symbol">=</span><span class="normal"> _dif</span><span class="symbol">;</span>
<span class="normal">   _patemp </span><span class="symbol">=</span><span class="normal"> _patemp</span><span class="symbol">;</span>
<span class="normal">   _pbtemp </span><span class="symbol">=</span><span class="normal"> _pbtemp</span><span class="symbol">;</span>
<span class="normal">   _pctemp </span><span class="symbol">=</span><span class="normal"> _pctemp</span><span class="symbol">;</span>
<span class="normal">   _MMXLength </span><span class="symbol">=</span><span class="normal"> _MMXLength</span><span class="symbol">;</span>
<span class="preproc">#endif</span>
<span class="normal">   _const4  </span><span class="symbol">=</span><span class="normal"> _const4</span><span class="symbol">;</span>
<span class="normal">   _const6  </span><span class="symbol">=</span><span class="normal"> _const6</span><span class="symbol">;</span>
<span class="normal">   _mask8_0  </span><span class="symbol">=</span><span class="normal"> _mask8_0</span><span class="symbol">;</span>
<span class="normal">   _mask16_1 </span><span class="symbol">=</span><span class="normal"> _mask16_1</span><span class="symbol">;</span>
<span class="normal">   _mask16_0 </span><span class="symbol">=</span><span class="normal"> _mask16_0</span><span class="symbol">;</span>
<span class="normal">   _mask24_2 </span><span class="symbol">=</span><span class="normal"> _mask24_2</span><span class="symbol">;</span>
<span class="normal">   _mask24_1 </span><span class="symbol">=</span><span class="normal"> _mask24_1</span><span class="symbol">;</span>
<span class="normal">   _mask24_0 </span><span class="symbol">=</span><span class="normal"> _mask24_0</span><span class="symbol">;</span>
<span class="normal">   _mask32_3 </span><span class="symbol">=</span><span class="normal"> _mask32_3</span><span class="symbol">;</span>
<span class="normal">   _mask32_2 </span><span class="symbol">=</span><span class="normal"> _mask32_2</span><span class="symbol">;</span>
<span class="normal">   _mask32_1 </span><span class="symbol">=</span><span class="normal"> _mask32_1</span><span class="symbol">;</span>
<span class="normal">   _mask32_0 </span><span class="symbol">=</span><span class="normal"> _mask32_0</span><span class="symbol">;</span>
<span class="normal">   _mask48_5 </span><span class="symbol">=</span><span class="normal"> _mask48_5</span><span class="symbol">;</span>
<span class="normal">   _mask48_4 </span><span class="symbol">=</span><span class="normal"> _mask48_4</span><span class="symbol">;</span>
<span class="normal">   _mask48_3 </span><span class="symbol">=</span><span class="normal"> _mask48_3</span><span class="symbol">;</span>
<span class="normal">   _mask48_2 </span><span class="symbol">=</span><span class="normal"> _mask48_2</span><span class="symbol">;</span>
<span class="normal">   _mask48_1 </span><span class="symbol">=</span><span class="normal"> _mask48_1</span><span class="symbol">;</span>
<span class="normal">   _mask48_0 </span><span class="symbol">=</span><span class="normal"> _mask48_0</span><span class="symbol">;</span>
<span class="cbracket">}</span>
<span class="preproc">#endif</span><span class="normal"> </span><span class="comment">/* PNG_ASSEMBLER_CODE_SUPPORTED */</span>


<span class="keyword">static</span><span class="normal"> </span><span class="type">int</span><span class="normal"> _mmx_supported </span><span class="symbol">=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>

<span class="comment">/*===========================================================================*/</span>
<span class="comment">/*                                                                           */</span>
<span class="comment">/*                       P N G _ C O M B I N E _ R O W                       */</span>
<span class="comment">/*                                                                           */</span>
<span class="comment">/*===========================================================================*/</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_HAVE_ASSEMBLER_COMBINE_ROW</span><span class="symbol">)</span>

<span class="preproc">#define</span><span class="normal"> BPP2  </span><span class="number">2</span>
<span class="preproc">#define</span><span class="normal"> BPP3  </span><span class="number">3</span><span class="normal"> </span><span class="comment">/* bytes per pixel (a.k.a. pixel_bytes) */</span>
<span class="preproc">#define</span><span class="normal"> BPP4  </span><span class="number">4</span>
<span class="preproc">#define</span><span class="normal"> BPP6  </span><span class="number">6</span><span class="normal"> </span><span class="comment">/* (defined only to help avoid cut-and-paste errors) */</span>
<span class="preproc">#define</span><span class="normal"> BPP8  </span><span class="number">8</span>

<span class="comment">/* Combines the row recently read in with the previous row.</span>
<span class="comment">   This routine takes care of alpha and transparency if requested.</span>
<span class="comment">   This routine also handles the two methods of progressive display</span>
<span class="comment">   of interlaced images, depending on the mask value.</span>
<span class="comment">   The mask value describes which pixels are to be combined with</span>
<span class="comment">   the row.  The pattern always repeats every 8 pixels, so just 8</span>
<span class="comment">   bits are needed.  A one indicates the pixel is to be combined; a</span>
<span class="comment">   zero indicates the pixel is to be skipped.  This is in addition</span>
<span class="comment">   to any alpha or transparency value associated with the pixel.</span>
<span class="comment">   If you want all pixels to be combined, pass 0xff (255) in mask. */</span>

<span class="comment">/* Use this routine for the x86 platform - it uses a faster MMX routine</span>
<span class="comment">   if the machine supports MMX. */</span>

<span class="type">void</span><span class="normal"> </span><span class="comment">/* PRIVATE */</span>
<span class="function">png_combine_row</span><span class="symbol">(</span><span class="usertype">png_structp</span><span class="normal"> png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">png_bytep</span><span class="normal"> row</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> mask</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">   </span><span class="function">png_debug</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"in png_combine_row (pnggccrd.c)</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_ASSEMBLER_CODE_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">_mmx_supported </span><span class="symbol">==</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="symbol">!</span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_1_0_X</span><span class="symbol">)</span>
<span class="normal">       </span><span class="comment">/* this should have happened in png_init_mmx_flags() already */</span>
<span class="normal">       </span><span class="function">png_warning</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"asm_flags may not have been initialized"</span><span class="symbol">);</span>
<span class="preproc">#endif</span>
<span class="normal">       </span><span class="function">png_mmx_support</span><span class="symbol">();</span>
<span class="normal">   </span><span class="cbracket">}</span>
<span class="preproc">#endif</span>

<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">mask </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">)</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="function">png_debug</span><span class="symbol">(</span><span class="number">2</span><span class="symbol">,</span><span class="string">"mask == 0xff:  doing single png_memcpy()</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">      </span><span class="function">png_memcpy</span><span class="symbol">(</span><span class="normal">row</span><span class="symbol">,</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_buf </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span>
<span class="normal">       </span><span class="symbol">(</span><span class="normal">png_size_t</span><span class="symbol">)</span><span class="function">PNG_ROWBYTES</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_info</span><span class="symbol">.</span><span class="normal">pixel_depth</span><span class="symbol">,</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">width</span><span class="symbol">));</span>
<span class="normal">   </span><span class="cbracket">}</span>
<span class="normal">   </span><span class="keyword">else</span><span class="normal">   </span><span class="comment">/* (png_combine_row() is never called with mask == 0) */</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="keyword">switch</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_info</span><span class="symbol">.</span><span class="normal">pixel_depth</span><span class="symbol">)</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         </span><span class="keyword">case</span><span class="normal"> </span><span class="number">1</span><span class="symbol">:</span><span class="normal">        </span><span class="comment">/* png_ptr-&gt;row_info.pixel_depth */</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> sp</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> dp</span><span class="symbol">;</span>
<span class="normal">            </span><span class="type">int</span><span class="normal"> s_inc</span><span class="symbol">,</span><span class="normal"> s_start</span><span class="symbol">,</span><span class="normal"> s_end</span><span class="symbol">;</span>
<span class="normal">            </span><span class="type">int</span><span class="normal"> m</span><span class="symbol">;</span>
<span class="normal">            </span><span class="type">int</span><span class="normal"> shift</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_uint_32</span><span class="normal"> i</span><span class="symbol">;</span>

<span class="normal">            sp </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_buf </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">            dp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">            m </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0x80</span><span class="symbol">;</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_PACKSWAP_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">            </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">&amp;</span><span class="normal"> PNG_PACKSWAP</span><span class="symbol">)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">                s_start </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">                s_end </span><span class="symbol">=</span><span class="normal"> </span><span class="number">7</span><span class="symbol">;</span>
<span class="normal">                s_inc </span><span class="symbol">=</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="keyword">else</span>
<span class="preproc">#endif</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">                s_start </span><span class="symbol">=</span><span class="normal"> </span><span class="number">7</span><span class="symbol">;</span>
<span class="normal">                s_end </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">                s_inc </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">            </span><span class="cbracket">}</span>

<span class="normal">            shift </span><span class="symbol">=</span><span class="normal"> s_start</span><span class="symbol">;</span>

<span class="normal">            </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">m </span><span class="symbol">&amp;</span><span class="normal"> mask</span><span class="symbol">)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  </span><span class="type">int</span><span class="normal"> value</span><span class="symbol">;</span>

<span class="normal">                  value </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(*</span><span class="normal">sp </span><span class="symbol">&gt;&gt;</span><span class="normal"> shift</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x1</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="symbol">*</span><span class="normal">dp </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((</span><span class="number">0x7f7f</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="symbol">(</span><span class="number">7</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> shift</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                  </span><span class="symbol">*</span><span class="normal">dp </span><span class="symbol">|=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">value </span><span class="symbol">&lt;&lt;</span><span class="normal"> shift</span><span class="symbol">);</span>
<span class="normal">               </span><span class="cbracket">}</span>

<span class="normal">               </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">shift </span><span class="symbol">==</span><span class="normal"> s_end</span><span class="symbol">)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  shift </span><span class="symbol">=</span><span class="normal"> s_start</span><span class="symbol">;</span>
<span class="normal">                  sp</span><span class="symbol">++;</span>
<span class="normal">                  dp</span><span class="symbol">++;</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="keyword">else</span>
<span class="normal">                  shift </span><span class="symbol">+=</span><span class="normal"> s_inc</span><span class="symbol">;</span>

<span class="normal">               </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">m </span><span class="symbol">==</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span>
<span class="normal">                  m </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0x80</span><span class="symbol">;</span>
<span class="normal">               </span><span class="keyword">else</span>
<span class="normal">                  m </span><span class="symbol">&gt;&gt;=</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">         </span><span class="cbracket">}</span>

<span class="normal">         </span><span class="keyword">case</span><span class="normal"> </span><span class="number">2</span><span class="symbol">:</span><span class="normal">        </span><span class="comment">/* png_ptr-&gt;row_info.pixel_depth */</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> sp</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> dp</span><span class="symbol">;</span>
<span class="normal">            </span><span class="type">int</span><span class="normal"> s_start</span><span class="symbol">,</span><span class="normal"> s_end</span><span class="symbol">,</span><span class="normal"> s_inc</span><span class="symbol">;</span>
<span class="normal">            </span><span class="type">int</span><span class="normal"> m</span><span class="symbol">;</span>
<span class="normal">            </span><span class="type">int</span><span class="normal"> shift</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_uint_32</span><span class="normal"> i</span><span class="symbol">;</span>
<span class="normal">            </span><span class="type">int</span><span class="normal"> value</span><span class="symbol">;</span>

<span class="normal">            sp </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_buf </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">            dp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">            m </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0x80</span><span class="symbol">;</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_PACKSWAP_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">            </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">&amp;</span><span class="normal"> PNG_PACKSWAP</span><span class="symbol">)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               s_start </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">               s_end </span><span class="symbol">=</span><span class="normal"> </span><span class="number">6</span><span class="symbol">;</span>
<span class="normal">               s_inc </span><span class="symbol">=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="keyword">else</span>
<span class="preproc">#endif</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               s_start </span><span class="symbol">=</span><span class="normal"> </span><span class="number">6</span><span class="symbol">;</span>
<span class="normal">               s_end </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">               s_inc </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">-</span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">            </span><span class="cbracket">}</span>

<span class="normal">            shift </span><span class="symbol">=</span><span class="normal"> s_start</span><span class="symbol">;</span>

<span class="normal">            </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">m </span><span class="symbol">&amp;</span><span class="normal"> mask</span><span class="symbol">)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  value </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(*</span><span class="normal">sp </span><span class="symbol">&gt;&gt;</span><span class="normal"> shift</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x3</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="symbol">*</span><span class="normal">dp </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((</span><span class="number">0x3f3f</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="symbol">(</span><span class="number">6</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> shift</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                  </span><span class="symbol">*</span><span class="normal">dp </span><span class="symbol">|=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">value </span><span class="symbol">&lt;&lt;</span><span class="normal"> shift</span><span class="symbol">);</span>
<span class="normal">               </span><span class="cbracket">}</span>

<span class="normal">               </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">shift </span><span class="symbol">==</span><span class="normal"> s_end</span><span class="symbol">)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  shift </span><span class="symbol">=</span><span class="normal"> s_start</span><span class="symbol">;</span>
<span class="normal">                  sp</span><span class="symbol">++;</span>
<span class="normal">                  dp</span><span class="symbol">++;</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="keyword">else</span>
<span class="normal">                  shift </span><span class="symbol">+=</span><span class="normal"> s_inc</span><span class="symbol">;</span>
<span class="normal">               </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">m </span><span class="symbol">==</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span>
<span class="normal">                  m </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0x80</span><span class="symbol">;</span>
<span class="normal">               </span><span class="keyword">else</span>
<span class="normal">                  m </span><span class="symbol">&gt;&gt;=</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">         </span><span class="cbracket">}</span>

<span class="normal">         </span><span class="keyword">case</span><span class="normal"> </span><span class="number">4</span><span class="symbol">:</span><span class="normal">        </span><span class="comment">/* png_ptr-&gt;row_info.pixel_depth */</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> sp</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> dp</span><span class="symbol">;</span>
<span class="normal">            </span><span class="type">int</span><span class="normal"> s_start</span><span class="symbol">,</span><span class="normal"> s_end</span><span class="symbol">,</span><span class="normal"> s_inc</span><span class="symbol">;</span>
<span class="normal">            </span><span class="type">int</span><span class="normal"> m</span><span class="symbol">;</span>
<span class="normal">            </span><span class="type">int</span><span class="normal"> shift</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_uint_32</span><span class="normal"> i</span><span class="symbol">;</span>
<span class="normal">            </span><span class="type">int</span><span class="normal"> value</span><span class="symbol">;</span>

<span class="normal">            sp </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_buf </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">            dp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">            m </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0x80</span><span class="symbol">;</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_PACKSWAP_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">            </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">&amp;</span><span class="normal"> PNG_PACKSWAP</span><span class="symbol">)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               s_start </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">               s_end </span><span class="symbol">=</span><span class="normal"> </span><span class="number">4</span><span class="symbol">;</span>
<span class="normal">               s_inc </span><span class="symbol">=</span><span class="normal"> </span><span class="number">4</span><span class="symbol">;</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="keyword">else</span>
<span class="preproc">#endif</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               s_start </span><span class="symbol">=</span><span class="normal"> </span><span class="number">4</span><span class="symbol">;</span>
<span class="normal">               s_end </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">               s_inc </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">-</span><span class="number">4</span><span class="symbol">;</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            shift </span><span class="symbol">=</span><span class="normal"> s_start</span><span class="symbol">;</span>

<span class="normal">            </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">m </span><span class="symbol">&amp;</span><span class="normal"> mask</span><span class="symbol">)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  value </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(*</span><span class="normal">sp </span><span class="symbol">&gt;&gt;</span><span class="normal"> shift</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xf</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="symbol">*</span><span class="normal">dp </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((</span><span class="number">0xf0f</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="symbol">(</span><span class="number">4</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> shift</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                  </span><span class="symbol">*</span><span class="normal">dp </span><span class="symbol">|=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">value </span><span class="symbol">&lt;&lt;</span><span class="normal"> shift</span><span class="symbol">);</span>
<span class="normal">               </span><span class="cbracket">}</span>

<span class="normal">               </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">shift </span><span class="symbol">==</span><span class="normal"> s_end</span><span class="symbol">)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  shift </span><span class="symbol">=</span><span class="normal"> s_start</span><span class="symbol">;</span>
<span class="normal">                  sp</span><span class="symbol">++;</span>
<span class="normal">                  dp</span><span class="symbol">++;</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="keyword">else</span>
<span class="normal">                  shift </span><span class="symbol">+=</span><span class="normal"> s_inc</span><span class="symbol">;</span>
<span class="normal">               </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">m </span><span class="symbol">==</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span>
<span class="normal">                  m </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0x80</span><span class="symbol">;</span>
<span class="normal">               </span><span class="keyword">else</span>
<span class="normal">                  m </span><span class="symbol">&gt;&gt;=</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">         </span><span class="cbracket">}</span>

<span class="normal">         </span><span class="keyword">case</span><span class="normal"> </span><span class="number">8</span><span class="symbol">:</span><span class="normal">        </span><span class="comment">/* png_ptr-&gt;row_info.pixel_depth */</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> srcptr</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> dstptr</span><span class="symbol">;</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_ASSEMBLER_CODE_SUPPORTED</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_THREAD_UNSAFE_OK</span><span class="symbol">)</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="symbol">!</span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_1_0_X</span><span class="symbol">)</span>
<span class="normal">            </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">asm_flags </span><span class="symbol">&amp;</span><span class="normal"> PNG_ASM_FLAG_MMX_READ_COMBINE_ROW</span><span class="symbol">)</span>
<span class="normal">                </span><span class="comment">/* &amp;&amp; _mmx_supported */</span><span class="normal"> </span><span class="symbol">)</span>
<span class="preproc">#else</span>
<span class="normal">            </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">_mmx_supported</span><span class="symbol">)</span>
<span class="preproc">#endif</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="usertype">png_uint_32</span><span class="normal"> len</span><span class="symbol">;</span>
<span class="normal">               </span><span class="type">int</span><span class="normal"> diff</span><span class="symbol">;</span>
<span class="normal">               </span><span class="type">int</span><span class="normal"> dummy_value_a</span><span class="symbol">;</span><span class="normal">   </span><span class="comment">// fix 'forbidden register spilled' error</span>
<span class="normal">               </span><span class="type">int</span><span class="normal"> dummy_value_d</span><span class="symbol">;</span>
<span class="normal">               </span><span class="type">int</span><span class="normal"> dummy_value_c</span><span class="symbol">;</span>
<span class="normal">               </span><span class="type">int</span><span class="normal"> dummy_value_S</span><span class="symbol">;</span>
<span class="normal">               </span><span class="type">int</span><span class="normal"> dummy_value_D</span><span class="symbol">;</span>
<span class="normal">               _unmask </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">~</span><span class="normal">mask</span><span class="symbol">;</span><span class="normal">            </span><span class="comment">// global variable for -fPIC version</span>
<span class="normal">               srcptr </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_buf </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">               dstptr </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">               len  </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">width </span><span class="symbol">&amp;~</span><span class="number">7</span><span class="symbol">;</span><span class="normal">  </span><span class="comment">// reduce to multiple of 8</span>
<span class="normal">               diff </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">width </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">7</span><span class="symbol">);</span><span class="normal">  </span><span class="comment">// amount lost</span>

<span class="normal">               </span><span class="usertype">__asm__</span><span class="normal"> </span><span class="function">__volatile__</span><span class="normal"> </span><span class="symbol">(</span>
<span class="normal">                  </span><span class="string">"movd      _unmask, %%mm7  </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// load bit pattern</span>
<span class="normal">                  </span><span class="string">"psubb     %%mm6, %%mm6    </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// zero mm6</span>
<span class="normal">                  </span><span class="string">"punpcklbw %%mm7, %%mm7    </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"punpcklwd %%mm7, %%mm7    </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"punpckldq %%mm7, %%mm7    </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// fill reg with 8 masks</span>

<span class="normal">                  </span><span class="string">"movq      _mask8_0, %%mm0 </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"pand      %%mm7, %%mm0    </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// nonzero if keep byte</span>
<span class="normal">                  </span><span class="string">"pcmpeqb   %%mm6, %%mm0    </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// zeros-&gt;1s, v versa</span>

<span class="comment">// preload        "movl      len, %%ecx      \n\t" // load length of line</span>
<span class="comment">// preload        "movl      srcptr, %%esi   \n\t" // load source</span>
<span class="comment">// preload        "movl      dstptr, %%edi   \n\t" // load dest</span>

<span class="normal">                  </span><span class="string">"cmpl      $0, %%ecx       </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// len == 0 ?</span>
<span class="normal">                  </span><span class="string">"je        mainloop8end    </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">                </span><span class="string">"mainloop8:                  </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"movq      (%%esi), %%mm4  </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// *srcptr</span>
<span class="normal">                  </span><span class="string">"pand      %%mm0, %%mm4    </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"movq      %%mm0, %%mm6    </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"pandn     (%%edi), %%mm6  </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// *dstptr</span>
<span class="normal">                  </span><span class="string">"por       %%mm6, %%mm4    </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"movq      %%mm4, (%%edi)  </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"addl      $8, %%esi       </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// inc by 8 bytes processed</span>
<span class="normal">                  </span><span class="string">"addl      $8, %%edi       </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"subl      $8, %%ecx       </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// dec by 8 pixels processed</span>
<span class="normal">                  </span><span class="string">"ja        mainloop8       </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">                </span><span class="string">"mainloop8end:               </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="comment">// preload        "movl      diff, %%ecx     \n\t" // (diff is in eax)</span>
<span class="normal">                  </span><span class="string">"movl      %%eax, %%ecx    </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"cmpl      $0, %%ecx       </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"jz        end8            </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="comment">// preload        "movl      mask, %%edx     \n\t"</span>
<span class="normal">                  </span><span class="string">"sall      $24, %%edx      </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// make low byte, high byte</span>

<span class="normal">                </span><span class="string">"secondloop8:                </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"sall      %%edx           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// move high bit to CF</span>
<span class="normal">                  </span><span class="string">"jnc       skip8           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// if CF = 0</span>
<span class="normal">                  </span><span class="string">"movb      (%%esi), %%al   </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"movb      %%al, (%%edi)   </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">                </span><span class="string">"skip8:                      </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"incl      %%esi           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"incl      %%edi           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"decl      %%ecx           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"jnz       secondloop8     </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">                </span><span class="string">"end8:                       </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"EMMS                      </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal">  </span><span class="comment">// DONE</span>

<span class="normal">                  </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"=a"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_a</span><span class="symbol">),</span><span class="normal">           </span><span class="comment">// output regs (dummy)</span>
<span class="normal">                    </span><span class="string">"=d"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_d</span><span class="symbol">),</span>
<span class="normal">                    </span><span class="string">"=c"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_c</span><span class="symbol">),</span>
<span class="normal">                    </span><span class="string">"=S"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_S</span><span class="symbol">),</span>
<span class="normal">                    </span><span class="string">"=D"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_D</span><span class="symbol">)</span>

<span class="normal">                  </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"3"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">srcptr</span><span class="symbol">),</span><span class="normal">      </span><span class="comment">// esi       // input regs</span>
<span class="normal">                    </span><span class="string">"4"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dstptr</span><span class="symbol">),</span><span class="normal">      </span><span class="comment">// edi</span>
<span class="normal">                    </span><span class="string">"0"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">diff</span><span class="symbol">),</span><span class="normal">        </span><span class="comment">// eax</span>
<span class="comment">// was (unmask)     "b"    RESERVED    // ebx       // Global Offset Table idx</span>
<span class="normal">                    </span><span class="string">"2"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">len</span><span class="symbol">),</span><span class="normal">         </span><span class="comment">// ecx</span>
<span class="normal">                    </span><span class="string">"1"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">mask</span><span class="symbol">)</span><span class="normal">         </span><span class="comment">// edx</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="number">0</span><span class="normal">  </span><span class="comment">/* MMX regs (%mm0, etc.) not supported by gcc 2.7.2.3 or egcs 1.1 */</span>
<span class="normal">                  </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"%mm0"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm4"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm6"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm7"</span><span class="normal">  </span><span class="comment">// clobber list</span>
<span class="preproc">#endif</span>
<span class="normal">               </span><span class="symbol">);</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="keyword">else</span><span class="normal"> </span><span class="comment">/* mmx _not supported - Use modified C routine */</span>
<span class="preproc">#endif</span><span class="normal"> </span><span class="comment">/* PNG_ASSEMBLER_CODE_SUPPORTED */</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="keyword">register</span><span class="normal"> </span><span class="usertype">png_uint_32</span><span class="normal"> i</span><span class="symbol">;</span>
<span class="normal">               </span><span class="usertype">png_uint_32</span><span class="normal"> initial_val </span><span class="symbol">=</span><span class="normal"> png_pass_start</span><span class="symbol">[</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">pass</span><span class="symbol">];</span>
<span class="normal">                 </span><span class="comment">/* png.c:  png_pass_start[] = {0, 4, 0, 2, 0, 1, 0}; */</span>
<span class="normal">               </span><span class="keyword">register</span><span class="normal"> </span><span class="type">int</span><span class="normal"> stride </span><span class="symbol">=</span><span class="normal"> png_pass_inc</span><span class="symbol">[</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">pass</span><span class="symbol">];</span>
<span class="normal">                 </span><span class="comment">/* png.c:  png_pass_inc[] = {8, 8, 4, 4, 2, 2, 1}; */</span>
<span class="normal">               </span><span class="keyword">register</span><span class="normal"> </span><span class="type">int</span><span class="normal"> rep_bytes </span><span class="symbol">=</span><span class="normal"> png_pass_width</span><span class="symbol">[</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">pass</span><span class="symbol">];</span>
<span class="normal">                 </span><span class="comment">/* png.c:  png_pass_width[] = {8, 4, 4, 2, 2, 1, 1}; */</span>
<span class="normal">               </span><span class="usertype">png_uint_32</span><span class="normal"> len </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">width </span><span class="symbol">&amp;~</span><span class="number">7</span><span class="symbol">;</span><span class="normal">  </span><span class="comment">/* reduce to mult. of 8 */</span>
<span class="normal">               </span><span class="type">int</span><span class="normal"> diff </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">width </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">7</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* amount lost */</span>
<span class="normal">               </span><span class="keyword">register</span><span class="normal"> </span><span class="usertype">png_uint_32</span><span class="normal"> final_val </span><span class="symbol">=</span><span class="normal"> len</span><span class="symbol">;</span><span class="normal">  </span><span class="comment">/* GRR bugfix */</span>

<span class="normal">               srcptr </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_buf </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> initial_val</span><span class="symbol">;</span>
<span class="normal">               dstptr </span><span class="symbol">=</span><span class="normal"> row </span><span class="symbol">+</span><span class="normal"> initial_val</span><span class="symbol">;</span>

<span class="normal">               </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> initial_val</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> final_val</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">+=</span><span class="normal"> stride</span><span class="symbol">)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  </span><span class="function">png_memcpy</span><span class="symbol">(</span><span class="normal">dstptr</span><span class="symbol">,</span><span class="normal"> srcptr</span><span class="symbol">,</span><span class="normal"> rep_bytes</span><span class="symbol">);</span>
<span class="normal">                  srcptr </span><span class="symbol">+=</span><span class="normal"> stride</span><span class="symbol">;</span>
<span class="normal">                  dstptr </span><span class="symbol">+=</span><span class="normal"> stride</span><span class="symbol">;</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">diff</span><span class="symbol">)</span><span class="normal">  </span><span class="comment">/* number of leftover pixels:  3 for pngtest */</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  final_val</span><span class="symbol">+=</span><span class="normal">diff </span><span class="comment">/* *BPP1 */</span><span class="normal"> </span><span class="symbol">;</span>
<span class="normal">                  </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> final_val</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">+=</span><span class="normal"> stride</span><span class="symbol">)</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">rep_bytes </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="symbol">)(</span><span class="normal">final_val</span><span class="symbol">-</span><span class="normal">i</span><span class="symbol">))</span>
<span class="normal">                        rep_bytes </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="symbol">)(</span><span class="normal">final_val</span><span class="symbol">-</span><span class="normal">i</span><span class="symbol">);</span>
<span class="normal">                     </span><span class="function">png_memcpy</span><span class="symbol">(</span><span class="normal">dstptr</span><span class="symbol">,</span><span class="normal"> srcptr</span><span class="symbol">,</span><span class="normal"> rep_bytes</span><span class="symbol">);</span>
<span class="normal">                     srcptr </span><span class="symbol">+=</span><span class="normal"> stride</span><span class="symbol">;</span>
<span class="normal">                     dstptr </span><span class="symbol">+=</span><span class="normal"> stride</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="cbracket">}</span>

<span class="normal">            </span><span class="cbracket">}</span><span class="normal"> </span><span class="comment">/* end of else (_mmx_supported) */</span>

<span class="normal">            </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">         </span><span class="cbracket">}</span><span class="normal">       </span><span class="comment">/* end 8 bpp */</span>

<span class="normal">         </span><span class="keyword">case</span><span class="normal"> </span><span class="number">16</span><span class="symbol">:</span><span class="normal">       </span><span class="comment">/* png_ptr-&gt;row_info.pixel_depth */</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> srcptr</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> dstptr</span><span class="symbol">;</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_ASSEMBLER_CODE_SUPPORTED</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_THREAD_UNSAFE_OK</span><span class="symbol">)</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="symbol">!</span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_1_0_X</span><span class="symbol">)</span>
<span class="normal">            </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">asm_flags </span><span class="symbol">&amp;</span><span class="normal"> PNG_ASM_FLAG_MMX_READ_COMBINE_ROW</span><span class="symbol">)</span>
<span class="normal">                </span><span class="comment">/* &amp;&amp; _mmx_supported */</span><span class="normal"> </span><span class="symbol">)</span>
<span class="preproc">#else</span>
<span class="normal">            </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">_mmx_supported</span><span class="symbol">)</span>
<span class="preproc">#endif</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="usertype">png_uint_32</span><span class="normal"> len</span><span class="symbol">;</span>
<span class="normal">               </span><span class="type">int</span><span class="normal"> diff</span><span class="symbol">;</span>
<span class="normal">               </span><span class="type">int</span><span class="normal"> dummy_value_a</span><span class="symbol">;</span><span class="normal">   </span><span class="comment">// fix 'forbidden register spilled' error</span>
<span class="normal">               </span><span class="type">int</span><span class="normal"> dummy_value_d</span><span class="symbol">;</span>
<span class="normal">               </span><span class="type">int</span><span class="normal"> dummy_value_c</span><span class="symbol">;</span>
<span class="normal">               </span><span class="type">int</span><span class="normal"> dummy_value_S</span><span class="symbol">;</span>
<span class="normal">               </span><span class="type">int</span><span class="normal"> dummy_value_D</span><span class="symbol">;</span>
<span class="normal">               _unmask </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">~</span><span class="normal">mask</span><span class="symbol">;</span><span class="normal">            </span><span class="comment">// global variable for -fPIC version</span>
<span class="normal">               srcptr </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_buf </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">               dstptr </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">               len  </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">width </span><span class="symbol">&amp;~</span><span class="number">7</span><span class="symbol">;</span><span class="normal">  </span><span class="comment">// reduce to multiple of 8</span>
<span class="normal">               diff </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">width </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">7</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">// amount lost //</span>

<span class="normal">               </span><span class="usertype">__asm__</span><span class="normal"> </span><span class="function">__volatile__</span><span class="normal"> </span><span class="symbol">(</span>
<span class="normal">                  </span><span class="string">"movd      _unmask, %%mm7   </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// load bit pattern</span>
<span class="normal">                  </span><span class="string">"psubb     %%mm6, %%mm6     </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// zero mm6</span>
<span class="normal">                  </span><span class="string">"punpcklbw %%mm7, %%mm7     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"punpcklwd %%mm7, %%mm7     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"punpckldq %%mm7, %%mm7     </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// fill reg with 8 masks</span>

<span class="normal">                  </span><span class="string">"movq      _mask16_0, %%mm0 </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"movq      _mask16_1, %%mm1 </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">                  </span><span class="string">"pand      %%mm7, %%mm0     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"pand      %%mm7, %%mm1     </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">                  </span><span class="string">"pcmpeqb   %%mm6, %%mm0     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"pcmpeqb   %%mm6, %%mm1     </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="comment">// preload        "movl      len, %%ecx       \n\t" // load length of line</span>
<span class="comment">// preload        "movl      srcptr, %%esi    \n\t" // load source</span>
<span class="comment">// preload        "movl      dstptr, %%edi    \n\t" // load dest</span>

<span class="normal">                  </span><span class="string">"cmpl      $0, %%ecx        </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"jz        mainloop16end    </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">                </span><span class="string">"mainloop16:                  </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"movq      (%%esi), %%mm4   </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"pand      %%mm0, %%mm4     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"movq      %%mm0, %%mm6     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"movq      (%%edi), %%mm7   </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"pandn     %%mm7, %%mm6     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"por       %%mm6, %%mm4     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"movq      %%mm4, (%%edi)   </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">                  </span><span class="string">"movq      8(%%esi), %%mm5  </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"pand      %%mm1, %%mm5     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"movq      %%mm1, %%mm7     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"movq      8(%%edi), %%mm6  </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"pandn     %%mm6, %%mm7     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"por       %%mm7, %%mm5     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"movq      %%mm5, 8(%%edi)  </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">                  </span><span class="string">"addl      $16, %%esi       </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// inc by 16 bytes processed</span>
<span class="normal">                  </span><span class="string">"addl      $16, %%edi       </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"subl      $8, %%ecx        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// dec by 8 pixels processed</span>
<span class="normal">                  </span><span class="string">"ja        mainloop16       </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">                </span><span class="string">"mainloop16end:               </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="comment">// preload        "movl      diff, %%ecx      \n\t" // (diff is in eax)</span>
<span class="normal">                  </span><span class="string">"movl      %%eax, %%ecx     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"cmpl      $0, %%ecx        </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"jz        end16            </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="comment">// preload        "movl      mask, %%edx      \n\t"</span>
<span class="normal">                  </span><span class="string">"sall      $24, %%edx       </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// make low byte, high byte</span>

<span class="normal">                </span><span class="string">"secondloop16:                </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"sall      %%edx            </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// move high bit to CF</span>
<span class="normal">                  </span><span class="string">"jnc       skip16           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// if CF = 0</span>
<span class="normal">                  </span><span class="string">"movw      (%%esi), %%ax    </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"movw      %%ax, (%%edi)    </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">                </span><span class="string">"skip16:                      </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"addl      $2, %%esi        </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"addl      $2, %%edi        </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"decl      %%ecx            </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"jnz       secondloop16     </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">                </span><span class="string">"end16:                       </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"EMMS                       </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// DONE</span>

<span class="normal">                  </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"=a"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_a</span><span class="symbol">),</span><span class="normal">           </span><span class="comment">// output regs (dummy)</span>
<span class="normal">                    </span><span class="string">"=c"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_c</span><span class="symbol">),</span>
<span class="normal">                    </span><span class="string">"=d"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_d</span><span class="symbol">),</span>
<span class="normal">                    </span><span class="string">"=S"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_S</span><span class="symbol">),</span>
<span class="normal">                    </span><span class="string">"=D"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_D</span><span class="symbol">)</span>

<span class="normal">                  </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"0"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">diff</span><span class="symbol">),</span><span class="normal">        </span><span class="comment">// eax       // input regs</span>
<span class="comment">// was (unmask)     " "    RESERVED    // ebx       // Global Offset Table idx</span>
<span class="normal">                    </span><span class="string">"1"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">len</span><span class="symbol">),</span><span class="normal">         </span><span class="comment">// ecx</span>
<span class="normal">                    </span><span class="string">"2"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">mask</span><span class="symbol">),</span><span class="normal">        </span><span class="comment">// edx</span>
<span class="normal">                    </span><span class="string">"3"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">srcptr</span><span class="symbol">),</span><span class="normal">      </span><span class="comment">// esi</span>
<span class="normal">                    </span><span class="string">"4"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dstptr</span><span class="symbol">)</span><span class="normal">       </span><span class="comment">// edi</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="number">0</span><span class="normal">  </span><span class="comment">/* MMX regs (%mm0, etc.) not supported by gcc 2.7.2.3 or egcs 1.1 */</span>
<span class="normal">                  </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"%mm0"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm1"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm4"</span><span class="normal">          </span><span class="comment">// clobber list</span>
<span class="normal">                  </span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm5"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm6"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm7"</span>
<span class="preproc">#endif</span>
<span class="normal">               </span><span class="symbol">);</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="keyword">else</span><span class="normal"> </span><span class="comment">/* mmx _not supported - Use modified C routine */</span>
<span class="preproc">#endif</span><span class="normal"> </span><span class="comment">/* PNG_ASSEMBLER_CODE_SUPPORTED */</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="keyword">register</span><span class="normal"> </span><span class="usertype">png_uint_32</span><span class="normal"> i</span><span class="symbol">;</span>
<span class="normal">               </span><span class="usertype">png_uint_32</span><span class="normal"> initial_val </span><span class="symbol">=</span><span class="normal"> BPP2 </span><span class="symbol">*</span><span class="normal"> png_pass_start</span><span class="symbol">[</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">pass</span><span class="symbol">];</span>
<span class="normal">                 </span><span class="comment">/* png.c:  png_pass_start[] = {0, 4, 0, 2, 0, 1, 0}; */</span>
<span class="normal">               </span><span class="keyword">register</span><span class="normal"> </span><span class="type">int</span><span class="normal"> stride </span><span class="symbol">=</span><span class="normal"> BPP2 </span><span class="symbol">*</span><span class="normal"> png_pass_inc</span><span class="symbol">[</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">pass</span><span class="symbol">];</span>
<span class="normal">                 </span><span class="comment">/* png.c:  png_pass_inc[] = {8, 8, 4, 4, 2, 2, 1}; */</span>
<span class="normal">               </span><span class="keyword">register</span><span class="normal"> </span><span class="type">int</span><span class="normal"> rep_bytes </span><span class="symbol">=</span><span class="normal"> BPP2 </span><span class="symbol">*</span><span class="normal"> png_pass_width</span><span class="symbol">[</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">pass</span><span class="symbol">];</span>
<span class="normal">                 </span><span class="comment">/* png.c:  png_pass_width[] = {8, 4, 4, 2, 2, 1, 1}; */</span>
<span class="normal">               </span><span class="usertype">png_uint_32</span><span class="normal"> len </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">width </span><span class="symbol">&amp;~</span><span class="number">7</span><span class="symbol">;</span><span class="normal">  </span><span class="comment">/* reduce to mult. of 8 */</span>
<span class="normal">               </span><span class="type">int</span><span class="normal"> diff </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">width </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">7</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* amount lost */</span>
<span class="normal">               </span><span class="keyword">register</span><span class="normal"> </span><span class="usertype">png_uint_32</span><span class="normal"> final_val </span><span class="symbol">=</span><span class="normal"> BPP2 </span><span class="symbol">*</span><span class="normal"> len</span><span class="symbol">;</span><span class="normal">   </span><span class="comment">/* GRR bugfix */</span>

<span class="normal">               srcptr </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_buf </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> initial_val</span><span class="symbol">;</span>
<span class="normal">               dstptr </span><span class="symbol">=</span><span class="normal"> row </span><span class="symbol">+</span><span class="normal"> initial_val</span><span class="symbol">;</span>

<span class="normal">               </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> initial_val</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> final_val</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">+=</span><span class="normal"> stride</span><span class="symbol">)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  </span><span class="function">png_memcpy</span><span class="symbol">(</span><span class="normal">dstptr</span><span class="symbol">,</span><span class="normal"> srcptr</span><span class="symbol">,</span><span class="normal"> rep_bytes</span><span class="symbol">);</span>
<span class="normal">                  srcptr </span><span class="symbol">+=</span><span class="normal"> stride</span><span class="symbol">;</span>
<span class="normal">                  dstptr </span><span class="symbol">+=</span><span class="normal"> stride</span><span class="symbol">;</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">diff</span><span class="symbol">)</span><span class="normal">  </span><span class="comment">/* number of leftover pixels:  3 for pngtest */</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  final_val</span><span class="symbol">+=</span><span class="normal">diff</span><span class="symbol">*</span><span class="normal">BPP2</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> final_val</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">+=</span><span class="normal"> stride</span><span class="symbol">)</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">rep_bytes </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="symbol">)(</span><span class="normal">final_val</span><span class="symbol">-</span><span class="normal">i</span><span class="symbol">))</span>
<span class="normal">                        rep_bytes </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="symbol">)(</span><span class="normal">final_val</span><span class="symbol">-</span><span class="normal">i</span><span class="symbol">);</span>
<span class="normal">                     </span><span class="function">png_memcpy</span><span class="symbol">(</span><span class="normal">dstptr</span><span class="symbol">,</span><span class="normal"> srcptr</span><span class="symbol">,</span><span class="normal"> rep_bytes</span><span class="symbol">);</span>
<span class="normal">                     srcptr </span><span class="symbol">+=</span><span class="normal"> stride</span><span class="symbol">;</span>
<span class="normal">                     dstptr </span><span class="symbol">+=</span><span class="normal"> stride</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="cbracket">}</span><span class="normal"> </span><span class="comment">/* end of else (_mmx_supported) */</span>

<span class="normal">            </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">         </span><span class="cbracket">}</span><span class="normal">       </span><span class="comment">/* end 16 bpp */</span>

<span class="normal">         </span><span class="keyword">case</span><span class="normal"> </span><span class="number">24</span><span class="symbol">:</span><span class="normal">       </span><span class="comment">/* png_ptr-&gt;row_info.pixel_depth */</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> srcptr</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> dstptr</span><span class="symbol">;</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_ASSEMBLER_CODE_SUPPORTED</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_THREAD_UNSAFE_OK</span><span class="symbol">)</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="symbol">!</span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_1_0_X</span><span class="symbol">)</span>
<span class="normal">            </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">asm_flags </span><span class="symbol">&amp;</span><span class="normal"> PNG_ASM_FLAG_MMX_READ_COMBINE_ROW</span><span class="symbol">)</span>
<span class="normal">                </span><span class="comment">/* &amp;&amp; _mmx_supported */</span><span class="normal"> </span><span class="symbol">)</span>
<span class="preproc">#else</span>
<span class="normal">            </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">_mmx_supported</span><span class="symbol">)</span>
<span class="preproc">#endif</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="usertype">png_uint_32</span><span class="normal"> len</span><span class="symbol">;</span>
<span class="normal">               </span><span class="type">int</span><span class="normal"> diff</span><span class="symbol">;</span>
<span class="normal">               </span><span class="type">int</span><span class="normal"> dummy_value_a</span><span class="symbol">;</span><span class="normal">   </span><span class="comment">// fix 'forbidden register spilled' error</span>
<span class="normal">               </span><span class="type">int</span><span class="normal"> dummy_value_d</span><span class="symbol">;</span>
<span class="normal">               </span><span class="type">int</span><span class="normal"> dummy_value_c</span><span class="symbol">;</span>
<span class="normal">               </span><span class="type">int</span><span class="normal"> dummy_value_S</span><span class="symbol">;</span>
<span class="normal">               </span><span class="type">int</span><span class="normal"> dummy_value_D</span><span class="symbol">;</span>
<span class="normal">               _unmask </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">~</span><span class="normal">mask</span><span class="symbol">;</span><span class="normal">            </span><span class="comment">// global variable for -fPIC version</span>
<span class="normal">               srcptr </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_buf </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">               dstptr </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">               len  </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">width </span><span class="symbol">&amp;~</span><span class="number">7</span><span class="symbol">;</span><span class="normal">  </span><span class="comment">// reduce to multiple of 8</span>
<span class="normal">               diff </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">width </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">7</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">// amount lost //</span>

<span class="normal">               </span><span class="usertype">__asm__</span><span class="normal"> </span><span class="function">__volatile__</span><span class="normal"> </span><span class="symbol">(</span>
<span class="normal">                  </span><span class="string">"movd      _unmask, %%mm7   </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// load bit pattern</span>
<span class="normal">                  </span><span class="string">"psubb     %%mm6, %%mm6     </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// zero mm6</span>
<span class="normal">                  </span><span class="string">"punpcklbw %%mm7, %%mm7     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"punpcklwd %%mm7, %%mm7     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"punpckldq %%mm7, %%mm7     </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// fill reg with 8 masks</span>

<span class="normal">                  </span><span class="string">"movq      _mask24_0, %%mm0 </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"movq      _mask24_1, %%mm1 </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"movq      _mask24_2, %%mm2 </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">                  </span><span class="string">"pand      %%mm7, %%mm0     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"pand      %%mm7, %%mm1     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"pand      %%mm7, %%mm2     </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">                  </span><span class="string">"pcmpeqb   %%mm6, %%mm0     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"pcmpeqb   %%mm6, %%mm1     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"pcmpeqb   %%mm6, %%mm2     </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="comment">// preload        "movl      len, %%ecx       \n\t" // load length of line</span>
<span class="comment">// preload        "movl      srcptr, %%esi    \n\t" // load source</span>
<span class="comment">// preload        "movl      dstptr, %%edi    \n\t" // load dest</span>

<span class="normal">                  </span><span class="string">"cmpl      $0, %%ecx        </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"jz        mainloop24end    </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">                </span><span class="string">"mainloop24:                  </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"movq      (%%esi), %%mm4   </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"pand      %%mm0, %%mm4     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"movq      %%mm0, %%mm6     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"movq      (%%edi), %%mm7   </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"pandn     %%mm7, %%mm6     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"por       %%mm6, %%mm4     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"movq      %%mm4, (%%edi)   </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">                  </span><span class="string">"movq      8(%%esi), %%mm5  </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"pand      %%mm1, %%mm5     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"movq      %%mm1, %%mm7     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"movq      8(%%edi), %%mm6  </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"pandn     %%mm6, %%mm7     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"por       %%mm7, %%mm5     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"movq      %%mm5, 8(%%edi)  </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">                  </span><span class="string">"movq      16(%%esi), %%mm6 </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"pand      %%mm2, %%mm6     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"movq      %%mm2, %%mm4     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"movq      16(%%edi), %%mm7 </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"pandn     %%mm7, %%mm4     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"por       %%mm4, %%mm6     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"movq      %%mm6, 16(%%edi) </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">                  </span><span class="string">"addl      $24, %%esi       </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// inc by 24 bytes processed</span>
<span class="normal">                  </span><span class="string">"addl      $24, %%edi       </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"subl      $8, %%ecx        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// dec by 8 pixels processed</span>

<span class="normal">                  </span><span class="string">"ja        mainloop24       </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">                </span><span class="string">"mainloop24end:               </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="comment">// preload        "movl      diff, %%ecx      \n\t" // (diff is in eax)</span>
<span class="normal">                  </span><span class="string">"movl      %%eax, %%ecx     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"cmpl      $0, %%ecx        </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"jz        end24            </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="comment">// preload        "movl      mask, %%edx      \n\t"</span>
<span class="normal">                  </span><span class="string">"sall      $24, %%edx       </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// make low byte, high byte</span>

<span class="normal">                </span><span class="string">"secondloop24:                </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"sall      %%edx            </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// move high bit to CF</span>
<span class="normal">                  </span><span class="string">"jnc       skip24           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// if CF = 0</span>
<span class="normal">                  </span><span class="string">"movw      (%%esi), %%ax    </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"movw      %%ax, (%%edi)    </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"xorl      %%eax, %%eax     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"movb      2(%%esi), %%al   </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"movb      %%al, 2(%%edi)   </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">                </span><span class="string">"skip24:                      </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"addl      $3, %%esi        </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"addl      $3, %%edi        </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"decl      %%ecx            </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"jnz       secondloop24     </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">                </span><span class="string">"end24:                       </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"EMMS                       </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// DONE</span>

<span class="normal">                  </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"=a"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_a</span><span class="symbol">),</span><span class="normal">           </span><span class="comment">// output regs (dummy)</span>
<span class="normal">                    </span><span class="string">"=d"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_d</span><span class="symbol">),</span>
<span class="normal">                    </span><span class="string">"=c"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_c</span><span class="symbol">),</span>
<span class="normal">                    </span><span class="string">"=S"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_S</span><span class="symbol">),</span>
<span class="normal">                    </span><span class="string">"=D"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_D</span><span class="symbol">)</span>

<span class="normal">                  </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"3"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">srcptr</span><span class="symbol">),</span><span class="normal">      </span><span class="comment">// esi       // input regs</span>
<span class="normal">                    </span><span class="string">"4"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dstptr</span><span class="symbol">),</span><span class="normal">      </span><span class="comment">// edi</span>
<span class="normal">                    </span><span class="string">"0"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">diff</span><span class="symbol">),</span><span class="normal">        </span><span class="comment">// eax</span>
<span class="comment">// was (unmask)     "b"    RESERVED    // ebx       // Global Offset Table idx</span>
<span class="normal">                    </span><span class="string">"2"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">len</span><span class="symbol">),</span><span class="normal">         </span><span class="comment">// ecx</span>
<span class="normal">                    </span><span class="string">"1"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">mask</span><span class="symbol">)</span><span class="normal">         </span><span class="comment">// edx</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="number">0</span><span class="normal">  </span><span class="comment">/* MMX regs (%mm0, etc.) not supported by gcc 2.7.2.3 or egcs 1.1 */</span>
<span class="normal">                  </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"%mm0"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm1"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm2"</span><span class="normal">          </span><span class="comment">// clobber list</span>
<span class="normal">                  </span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm4"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm5"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm6"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm7"</span>
<span class="preproc">#endif</span>
<span class="normal">               </span><span class="symbol">);</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="keyword">else</span><span class="normal"> </span><span class="comment">/* mmx _not supported - Use modified C routine */</span>
<span class="preproc">#endif</span><span class="normal"> </span><span class="comment">/* PNG_ASSEMBLER_CODE_SUPPORTED */</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="keyword">register</span><span class="normal"> </span><span class="usertype">png_uint_32</span><span class="normal"> i</span><span class="symbol">;</span>
<span class="normal">               </span><span class="usertype">png_uint_32</span><span class="normal"> initial_val </span><span class="symbol">=</span><span class="normal"> BPP3 </span><span class="symbol">*</span><span class="normal"> png_pass_start</span><span class="symbol">[</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">pass</span><span class="symbol">];</span>
<span class="normal">                 </span><span class="comment">/* png.c:  png_pass_start[] = {0, 4, 0, 2, 0, 1, 0}; */</span>
<span class="normal">               </span><span class="keyword">register</span><span class="normal"> </span><span class="type">int</span><span class="normal"> stride </span><span class="symbol">=</span><span class="normal"> BPP3 </span><span class="symbol">*</span><span class="normal"> png_pass_inc</span><span class="symbol">[</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">pass</span><span class="symbol">];</span>
<span class="normal">                 </span><span class="comment">/* png.c:  png_pass_inc[] = {8, 8, 4, 4, 2, 2, 1}; */</span>
<span class="normal">               </span><span class="keyword">register</span><span class="normal"> </span><span class="type">int</span><span class="normal"> rep_bytes </span><span class="symbol">=</span><span class="normal"> BPP3 </span><span class="symbol">*</span><span class="normal"> png_pass_width</span><span class="symbol">[</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">pass</span><span class="symbol">];</span>
<span class="normal">                 </span><span class="comment">/* png.c:  png_pass_width[] = {8, 4, 4, 2, 2, 1, 1}; */</span>
<span class="normal">               </span><span class="usertype">png_uint_32</span><span class="normal"> len </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">width </span><span class="symbol">&amp;~</span><span class="number">7</span><span class="symbol">;</span><span class="normal">  </span><span class="comment">/* reduce to mult. of 8 */</span>
<span class="normal">               </span><span class="type">int</span><span class="normal"> diff </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">width </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">7</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* amount lost */</span>
<span class="normal">               </span><span class="keyword">register</span><span class="normal"> </span><span class="usertype">png_uint_32</span><span class="normal"> final_val </span><span class="symbol">=</span><span class="normal"> BPP3 </span><span class="symbol">*</span><span class="normal"> len</span><span class="symbol">;</span><span class="normal">   </span><span class="comment">/* GRR bugfix */</span>

<span class="normal">               srcptr </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_buf </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> initial_val</span><span class="symbol">;</span>
<span class="normal">               dstptr </span><span class="symbol">=</span><span class="normal"> row </span><span class="symbol">+</span><span class="normal"> initial_val</span><span class="symbol">;</span>

<span class="normal">               </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> initial_val</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> final_val</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">+=</span><span class="normal"> stride</span><span class="symbol">)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  </span><span class="function">png_memcpy</span><span class="symbol">(</span><span class="normal">dstptr</span><span class="symbol">,</span><span class="normal"> srcptr</span><span class="symbol">,</span><span class="normal"> rep_bytes</span><span class="symbol">);</span>
<span class="normal">                  srcptr </span><span class="symbol">+=</span><span class="normal"> stride</span><span class="symbol">;</span>
<span class="normal">                  dstptr </span><span class="symbol">+=</span><span class="normal"> stride</span><span class="symbol">;</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">diff</span><span class="symbol">)</span><span class="normal">  </span><span class="comment">/* number of leftover pixels:  3 for pngtest */</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  final_val</span><span class="symbol">+=</span><span class="normal">diff</span><span class="symbol">*</span><span class="normal">BPP3</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> final_val</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">+=</span><span class="normal"> stride</span><span class="symbol">)</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">rep_bytes </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="symbol">)(</span><span class="normal">final_val</span><span class="symbol">-</span><span class="normal">i</span><span class="symbol">))</span>
<span class="normal">                        rep_bytes </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="symbol">)(</span><span class="normal">final_val</span><span class="symbol">-</span><span class="normal">i</span><span class="symbol">);</span>
<span class="normal">                     </span><span class="function">png_memcpy</span><span class="symbol">(</span><span class="normal">dstptr</span><span class="symbol">,</span><span class="normal"> srcptr</span><span class="symbol">,</span><span class="normal"> rep_bytes</span><span class="symbol">);</span>
<span class="normal">                     srcptr </span><span class="symbol">+=</span><span class="normal"> stride</span><span class="symbol">;</span>
<span class="normal">                     dstptr </span><span class="symbol">+=</span><span class="normal"> stride</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="cbracket">}</span><span class="normal"> </span><span class="comment">/* end of else (_mmx_supported) */</span>

<span class="normal">            </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">         </span><span class="cbracket">}</span><span class="normal">       </span><span class="comment">/* end 24 bpp */</span>

<span class="normal">         </span><span class="keyword">case</span><span class="normal"> </span><span class="number">32</span><span class="symbol">:</span><span class="normal">       </span><span class="comment">/* png_ptr-&gt;row_info.pixel_depth */</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> srcptr</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> dstptr</span><span class="symbol">;</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_ASSEMBLER_CODE_SUPPORTED</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_THREAD_UNSAFE_OK</span><span class="symbol">)</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="symbol">!</span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_1_0_X</span><span class="symbol">)</span>
<span class="normal">            </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">asm_flags </span><span class="symbol">&amp;</span><span class="normal"> PNG_ASM_FLAG_MMX_READ_COMBINE_ROW</span><span class="symbol">)</span>
<span class="normal">                </span><span class="comment">/* &amp;&amp; _mmx_supported */</span><span class="normal"> </span><span class="symbol">)</span>
<span class="preproc">#else</span>
<span class="normal">            </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">_mmx_supported</span><span class="symbol">)</span>
<span class="preproc">#endif</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="usertype">png_uint_32</span><span class="normal"> len</span><span class="symbol">;</span>
<span class="normal">               </span><span class="type">int</span><span class="normal"> diff</span><span class="symbol">;</span>
<span class="normal">               </span><span class="type">int</span><span class="normal"> dummy_value_a</span><span class="symbol">;</span><span class="normal">   </span><span class="comment">// fix 'forbidden register spilled' error</span>
<span class="normal">               </span><span class="type">int</span><span class="normal"> dummy_value_d</span><span class="symbol">;</span>
<span class="normal">               </span><span class="type">int</span><span class="normal"> dummy_value_c</span><span class="symbol">;</span>
<span class="normal">               </span><span class="type">int</span><span class="normal"> dummy_value_S</span><span class="symbol">;</span>
<span class="normal">               </span><span class="type">int</span><span class="normal"> dummy_value_D</span><span class="symbol">;</span>
<span class="normal">               _unmask </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">~</span><span class="normal">mask</span><span class="symbol">;</span><span class="normal">            </span><span class="comment">// global variable for -fPIC version</span>
<span class="normal">               srcptr </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_buf </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">               dstptr </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">               len  </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">width </span><span class="symbol">&amp;~</span><span class="number">7</span><span class="symbol">;</span><span class="normal">  </span><span class="comment">// reduce to multiple of 8</span>
<span class="normal">               diff </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">width </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">7</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">// amount lost //</span>

<span class="normal">               </span><span class="usertype">__asm__</span><span class="normal"> </span><span class="function">__volatile__</span><span class="normal"> </span><span class="symbol">(</span>
<span class="normal">                  </span><span class="string">"movd      _unmask, %%mm7   </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// load bit pattern</span>
<span class="normal">                  </span><span class="string">"psubb     %%mm6, %%mm6     </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// zero mm6</span>
<span class="normal">                  </span><span class="string">"punpcklbw %%mm7, %%mm7     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"punpcklwd %%mm7, %%mm7     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"punpckldq %%mm7, %%mm7     </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// fill reg with 8 masks</span>

<span class="normal">                  </span><span class="string">"movq      _mask32_0, %%mm0 </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"movq      _mask32_1, %%mm1 </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"movq      _mask32_2, %%mm2 </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"movq      _mask32_3, %%mm3 </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">                  </span><span class="string">"pand      %%mm7, %%mm0     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"pand      %%mm7, %%mm1     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"pand      %%mm7, %%mm2     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"pand      %%mm7, %%mm3     </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">                  </span><span class="string">"pcmpeqb   %%mm6, %%mm0     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"pcmpeqb   %%mm6, %%mm1     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"pcmpeqb   %%mm6, %%mm2     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"pcmpeqb   %%mm6, %%mm3     </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="comment">// preload        "movl      len, %%ecx       \n\t" // load length of line</span>
<span class="comment">// preload        "movl      srcptr, %%esi    \n\t" // load source</span>
<span class="comment">// preload        "movl      dstptr, %%edi    \n\t" // load dest</span>

<span class="normal">                  </span><span class="string">"cmpl      $0, %%ecx        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// lcr</span>
<span class="normal">                  </span><span class="string">"jz        mainloop32end    </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">                </span><span class="string">"mainloop32:                  </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"movq      (%%esi), %%mm4   </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"pand      %%mm0, %%mm4     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"movq      %%mm0, %%mm6     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"movq      (%%edi), %%mm7   </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"pandn     %%mm7, %%mm6     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"por       %%mm6, %%mm4     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"movq      %%mm4, (%%edi)   </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">                  </span><span class="string">"movq      8(%%esi), %%mm5  </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"pand      %%mm1, %%mm5     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"movq      %%mm1, %%mm7     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"movq      8(%%edi), %%mm6  </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"pandn     %%mm6, %%mm7     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"por       %%mm7, %%mm5     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"movq      %%mm5, 8(%%edi)  </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">                  </span><span class="string">"movq      16(%%esi), %%mm6 </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"pand      %%mm2, %%mm6     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"movq      %%mm2, %%mm4     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"movq      16(%%edi), %%mm7 </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"pandn     %%mm7, %%mm4     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"por       %%mm4, %%mm6     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"movq      %%mm6, 16(%%edi) </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">                  </span><span class="string">"movq      24(%%esi), %%mm7 </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"pand      %%mm3, %%mm7     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"movq      %%mm3, %%mm5     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"movq      24(%%edi), %%mm4 </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"pandn     %%mm4, %%mm5     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"por       %%mm5, %%mm7     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"movq      %%mm7, 24(%%edi) </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">                  </span><span class="string">"addl      $32, %%esi       </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// inc by 32 bytes processed</span>
<span class="normal">                  </span><span class="string">"addl      $32, %%edi       </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"subl      $8, %%ecx        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// dec by 8 pixels processed</span>
<span class="normal">                  </span><span class="string">"ja        mainloop32       </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">                </span><span class="string">"mainloop32end:               </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="comment">// preload        "movl      diff, %%ecx      \n\t" // (diff is in eax)</span>
<span class="normal">                  </span><span class="string">"movl      %%eax, %%ecx     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"cmpl      $0, %%ecx        </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"jz        end32            </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="comment">// preload        "movl      mask, %%edx      \n\t"</span>
<span class="normal">                  </span><span class="string">"sall      $24, %%edx       </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// low byte =&gt; high byte</span>

<span class="normal">                </span><span class="string">"secondloop32:                </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"sall      %%edx            </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// move high bit to CF</span>
<span class="normal">                  </span><span class="string">"jnc       skip32           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// if CF = 0</span>
<span class="normal">                  </span><span class="string">"movl      (%%esi), %%eax   </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"movl      %%eax, (%%edi)   </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">                </span><span class="string">"skip32:                      </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"addl      $4, %%esi        </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"addl      $4, %%edi        </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"decl      %%ecx            </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"jnz       secondloop32     </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">                </span><span class="string">"end32:                       </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"EMMS                       </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// DONE</span>

<span class="normal">                  </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"=a"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_a</span><span class="symbol">),</span><span class="normal">           </span><span class="comment">// output regs (dummy)</span>
<span class="normal">                    </span><span class="string">"=d"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_d</span><span class="symbol">),</span>
<span class="normal">                    </span><span class="string">"=c"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_c</span><span class="symbol">),</span>
<span class="normal">                    </span><span class="string">"=S"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_S</span><span class="symbol">),</span>
<span class="normal">                    </span><span class="string">"=D"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_D</span><span class="symbol">)</span>

<span class="normal">                  </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"3"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">srcptr</span><span class="symbol">),</span><span class="normal">      </span><span class="comment">// esi       // input regs</span>
<span class="normal">                    </span><span class="string">"4"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dstptr</span><span class="symbol">),</span><span class="normal">      </span><span class="comment">// edi</span>
<span class="normal">                    </span><span class="string">"0"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">diff</span><span class="symbol">),</span><span class="normal">        </span><span class="comment">// eax</span>
<span class="comment">// was (unmask)     "b"    RESERVED    // ebx       // Global Offset Table idx</span>
<span class="normal">                    </span><span class="string">"2"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">len</span><span class="symbol">),</span><span class="normal">         </span><span class="comment">// ecx</span>
<span class="normal">                    </span><span class="string">"1"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">mask</span><span class="symbol">)</span><span class="normal">         </span><span class="comment">// edx</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="number">0</span><span class="normal">  </span><span class="comment">/* MMX regs (%mm0, etc.) not supported by gcc 2.7.2.3 or egcs 1.1 */</span>
<span class="normal">                  </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"%mm0"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm1"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm2"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm3"</span><span class="normal">  </span><span class="comment">// clobber list</span>
<span class="normal">                  </span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm4"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm5"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm6"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm7"</span>
<span class="preproc">#endif</span>
<span class="normal">               </span><span class="symbol">);</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="keyword">else</span><span class="normal"> </span><span class="comment">/* mmx _not supported - Use modified C routine */</span>
<span class="preproc">#endif</span><span class="normal"> </span><span class="comment">/* PNG_ASSEMBLER_CODE_SUPPORTED */</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="keyword">register</span><span class="normal"> </span><span class="usertype">png_uint_32</span><span class="normal"> i</span><span class="symbol">;</span>
<span class="normal">               </span><span class="usertype">png_uint_32</span><span class="normal"> initial_val </span><span class="symbol">=</span><span class="normal"> BPP4 </span><span class="symbol">*</span><span class="normal"> png_pass_start</span><span class="symbol">[</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">pass</span><span class="symbol">];</span>
<span class="normal">                 </span><span class="comment">/* png.c:  png_pass_start[] = {0, 4, 0, 2, 0, 1, 0}; */</span>
<span class="normal">               </span><span class="keyword">register</span><span class="normal"> </span><span class="type">int</span><span class="normal"> stride </span><span class="symbol">=</span><span class="normal"> BPP4 </span><span class="symbol">*</span><span class="normal"> png_pass_inc</span><span class="symbol">[</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">pass</span><span class="symbol">];</span>
<span class="normal">                 </span><span class="comment">/* png.c:  png_pass_inc[] = {8, 8, 4, 4, 2, 2, 1}; */</span>
<span class="normal">               </span><span class="keyword">register</span><span class="normal"> </span><span class="type">int</span><span class="normal"> rep_bytes </span><span class="symbol">=</span><span class="normal"> BPP4 </span><span class="symbol">*</span><span class="normal"> png_pass_width</span><span class="symbol">[</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">pass</span><span class="symbol">];</span>
<span class="normal">                 </span><span class="comment">/* png.c:  png_pass_width[] = {8, 4, 4, 2, 2, 1, 1}; */</span>
<span class="normal">               </span><span class="usertype">png_uint_32</span><span class="normal"> len </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">width </span><span class="symbol">&amp;~</span><span class="number">7</span><span class="symbol">;</span><span class="normal">  </span><span class="comment">/* reduce to mult. of 8 */</span>
<span class="normal">               </span><span class="type">int</span><span class="normal"> diff </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">width </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">7</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* amount lost */</span>
<span class="normal">               </span><span class="keyword">register</span><span class="normal"> </span><span class="usertype">png_uint_32</span><span class="normal"> final_val </span><span class="symbol">=</span><span class="normal"> BPP4 </span><span class="symbol">*</span><span class="normal"> len</span><span class="symbol">;</span><span class="normal">   </span><span class="comment">/* GRR bugfix */</span>

<span class="normal">               srcptr </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_buf </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> initial_val</span><span class="symbol">;</span>
<span class="normal">               dstptr </span><span class="symbol">=</span><span class="normal"> row </span><span class="symbol">+</span><span class="normal"> initial_val</span><span class="symbol">;</span>

<span class="normal">               </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> initial_val</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> final_val</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">+=</span><span class="normal"> stride</span><span class="symbol">)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  </span><span class="function">png_memcpy</span><span class="symbol">(</span><span class="normal">dstptr</span><span class="symbol">,</span><span class="normal"> srcptr</span><span class="symbol">,</span><span class="normal"> rep_bytes</span><span class="symbol">);</span>
<span class="normal">                  srcptr </span><span class="symbol">+=</span><span class="normal"> stride</span><span class="symbol">;</span>
<span class="normal">                  dstptr </span><span class="symbol">+=</span><span class="normal"> stride</span><span class="symbol">;</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">diff</span><span class="symbol">)</span><span class="normal">  </span><span class="comment">/* number of leftover pixels:  3 for pngtest */</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  final_val</span><span class="symbol">+=</span><span class="normal">diff</span><span class="symbol">*</span><span class="normal">BPP4</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> final_val</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">+=</span><span class="normal"> stride</span><span class="symbol">)</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">rep_bytes </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="symbol">)(</span><span class="normal">final_val</span><span class="symbol">-</span><span class="normal">i</span><span class="symbol">))</span>
<span class="normal">                        rep_bytes </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="symbol">)(</span><span class="normal">final_val</span><span class="symbol">-</span><span class="normal">i</span><span class="symbol">);</span>
<span class="normal">                     </span><span class="function">png_memcpy</span><span class="symbol">(</span><span class="normal">dstptr</span><span class="symbol">,</span><span class="normal"> srcptr</span><span class="symbol">,</span><span class="normal"> rep_bytes</span><span class="symbol">);</span>
<span class="normal">                     srcptr </span><span class="symbol">+=</span><span class="normal"> stride</span><span class="symbol">;</span>
<span class="normal">                     dstptr </span><span class="symbol">+=</span><span class="normal"> stride</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="cbracket">}</span><span class="normal"> </span><span class="comment">/* end of else (_mmx_supported) */</span>

<span class="normal">            </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">         </span><span class="cbracket">}</span><span class="normal">       </span><span class="comment">/* end 32 bpp */</span>

<span class="normal">         </span><span class="keyword">case</span><span class="normal"> </span><span class="number">48</span><span class="symbol">:</span><span class="normal">       </span><span class="comment">/* png_ptr-&gt;row_info.pixel_depth */</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> srcptr</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> dstptr</span><span class="symbol">;</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_ASSEMBLER_CODE_SUPPORTED</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_THREAD_UNSAFE_OK</span><span class="symbol">)</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="symbol">!</span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_1_0_X</span><span class="symbol">)</span>
<span class="normal">            </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">asm_flags </span><span class="symbol">&amp;</span><span class="normal"> PNG_ASM_FLAG_MMX_READ_COMBINE_ROW</span><span class="symbol">)</span>
<span class="normal">                </span><span class="comment">/* &amp;&amp; _mmx_supported */</span><span class="normal"> </span><span class="symbol">)</span>
<span class="preproc">#else</span>
<span class="normal">            </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">_mmx_supported</span><span class="symbol">)</span>
<span class="preproc">#endif</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="usertype">png_uint_32</span><span class="normal"> len</span><span class="symbol">;</span>
<span class="normal">               </span><span class="type">int</span><span class="normal"> diff</span><span class="symbol">;</span>
<span class="normal">               </span><span class="type">int</span><span class="normal"> dummy_value_a</span><span class="symbol">;</span><span class="normal">   </span><span class="comment">// fix 'forbidden register spilled' error</span>
<span class="normal">               </span><span class="type">int</span><span class="normal"> dummy_value_d</span><span class="symbol">;</span>
<span class="normal">               </span><span class="type">int</span><span class="normal"> dummy_value_c</span><span class="symbol">;</span>
<span class="normal">               </span><span class="type">int</span><span class="normal"> dummy_value_S</span><span class="symbol">;</span>
<span class="normal">               </span><span class="type">int</span><span class="normal"> dummy_value_D</span><span class="symbol">;</span>
<span class="normal">               _unmask </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">~</span><span class="normal">mask</span><span class="symbol">;</span><span class="normal">            </span><span class="comment">// global variable for -fPIC version</span>
<span class="normal">               srcptr </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_buf </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">               dstptr </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">               len  </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">width </span><span class="symbol">&amp;~</span><span class="number">7</span><span class="symbol">;</span><span class="normal">  </span><span class="comment">// reduce to multiple of 8</span>
<span class="normal">               diff </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">width </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">7</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">// amount lost //</span>

<span class="normal">               </span><span class="usertype">__asm__</span><span class="normal"> </span><span class="function">__volatile__</span><span class="normal"> </span><span class="symbol">(</span>
<span class="normal">                  </span><span class="string">"movd      _unmask, %%mm7   </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// load bit pattern</span>
<span class="normal">                  </span><span class="string">"psubb     %%mm6, %%mm6     </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// zero mm6</span>
<span class="normal">                  </span><span class="string">"punpcklbw %%mm7, %%mm7     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"punpcklwd %%mm7, %%mm7     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"punpckldq %%mm7, %%mm7     </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// fill reg with 8 masks</span>

<span class="normal">                  </span><span class="string">"movq      _mask48_0, %%mm0 </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"movq      _mask48_1, %%mm1 </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"movq      _mask48_2, %%mm2 </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"movq      _mask48_3, %%mm3 </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"movq      _mask48_4, %%mm4 </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"movq      _mask48_5, %%mm5 </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">                  </span><span class="string">"pand      %%mm7, %%mm0     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"pand      %%mm7, %%mm1     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"pand      %%mm7, %%mm2     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"pand      %%mm7, %%mm3     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"pand      %%mm7, %%mm4     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"pand      %%mm7, %%mm5     </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">                  </span><span class="string">"pcmpeqb   %%mm6, %%mm0     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"pcmpeqb   %%mm6, %%mm1     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"pcmpeqb   %%mm6, %%mm2     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"pcmpeqb   %%mm6, %%mm3     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"pcmpeqb   %%mm6, %%mm4     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"pcmpeqb   %%mm6, %%mm5     </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="comment">// preload        "movl      len, %%ecx       \n\t" // load length of line</span>
<span class="comment">// preload        "movl      srcptr, %%esi    \n\t" // load source</span>
<span class="comment">// preload        "movl      dstptr, %%edi    \n\t" // load dest</span>

<span class="normal">                  </span><span class="string">"cmpl      $0, %%ecx        </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"jz        mainloop48end    </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">                </span><span class="string">"mainloop48:                  </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"movq      (%%esi), %%mm7   </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"pand      %%mm0, %%mm7     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"movq      %%mm0, %%mm6     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"pandn     (%%edi), %%mm6   </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"por       %%mm6, %%mm7     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"movq      %%mm7, (%%edi)   </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">                  </span><span class="string">"movq      8(%%esi), %%mm6  </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"pand      %%mm1, %%mm6     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"movq      %%mm1, %%mm7     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"pandn     8(%%edi), %%mm7  </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"por       %%mm7, %%mm6     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"movq      %%mm6, 8(%%edi)  </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">                  </span><span class="string">"movq      16(%%esi), %%mm6 </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"pand      %%mm2, %%mm6     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"movq      %%mm2, %%mm7     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"pandn     16(%%edi), %%mm7 </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"por       %%mm7, %%mm6     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"movq      %%mm6, 16(%%edi) </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">                  </span><span class="string">"movq      24(%%esi), %%mm7 </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"pand      %%mm3, %%mm7     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"movq      %%mm3, %%mm6     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"pandn     24(%%edi), %%mm6 </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"por       %%mm6, %%mm7     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"movq      %%mm7, 24(%%edi) </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">                  </span><span class="string">"movq      32(%%esi), %%mm6 </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"pand      %%mm4, %%mm6     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"movq      %%mm4, %%mm7     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"pandn     32(%%edi), %%mm7 </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"por       %%mm7, %%mm6     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"movq      %%mm6, 32(%%edi) </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">                  </span><span class="string">"movq      40(%%esi), %%mm7 </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"pand      %%mm5, %%mm7     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"movq      %%mm5, %%mm6     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"pandn     40(%%edi), %%mm6 </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"por       %%mm6, %%mm7     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"movq      %%mm7, 40(%%edi) </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">                  </span><span class="string">"addl      $48, %%esi       </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// inc by 48 bytes processed</span>
<span class="normal">                  </span><span class="string">"addl      $48, %%edi       </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"subl      $8, %%ecx        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// dec by 8 pixels processed</span>

<span class="normal">                  </span><span class="string">"ja        mainloop48       </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">                </span><span class="string">"mainloop48end:               </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="comment">// preload        "movl      diff, %%ecx      \n\t" // (diff is in eax)</span>
<span class="normal">                  </span><span class="string">"movl      %%eax, %%ecx     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"cmpl      $0, %%ecx        </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"jz        end48            </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="comment">// preload        "movl      mask, %%edx      \n\t"</span>
<span class="normal">                  </span><span class="string">"sall      $24, %%edx       </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// make low byte, high byte</span>

<span class="normal">                </span><span class="string">"secondloop48:                </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"sall      %%edx            </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// move high bit to CF</span>
<span class="normal">                  </span><span class="string">"jnc       skip48           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// if CF = 0</span>
<span class="normal">                  </span><span class="string">"movl      (%%esi), %%eax   </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"movl      %%eax, (%%edi)   </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">                </span><span class="string">"skip48:                      </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"addl      $4, %%esi        </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"addl      $4, %%edi        </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"decl      %%ecx            </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"jnz       secondloop48     </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">                </span><span class="string">"end48:                       </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                  </span><span class="string">"EMMS                       </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// DONE</span>

<span class="normal">                  </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"=a"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_a</span><span class="symbol">),</span><span class="normal">           </span><span class="comment">// output regs (dummy)</span>
<span class="normal">                    </span><span class="string">"=d"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_d</span><span class="symbol">),</span>
<span class="normal">                    </span><span class="string">"=c"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_c</span><span class="symbol">),</span>
<span class="normal">                    </span><span class="string">"=S"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_S</span><span class="symbol">),</span>
<span class="normal">                    </span><span class="string">"=D"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_D</span><span class="symbol">)</span>

<span class="normal">                  </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"3"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">srcptr</span><span class="symbol">),</span><span class="normal">      </span><span class="comment">// esi       // input regs</span>
<span class="normal">                    </span><span class="string">"4"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dstptr</span><span class="symbol">),</span><span class="normal">      </span><span class="comment">// edi</span>
<span class="normal">                    </span><span class="string">"0"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">diff</span><span class="symbol">),</span><span class="normal">        </span><span class="comment">// eax</span>
<span class="comment">// was (unmask)     "b"    RESERVED    // ebx       // Global Offset Table idx</span>
<span class="normal">                    </span><span class="string">"2"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">len</span><span class="symbol">),</span><span class="normal">         </span><span class="comment">// ecx</span>
<span class="normal">                    </span><span class="string">"1"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">mask</span><span class="symbol">)</span><span class="normal">         </span><span class="comment">// edx</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="number">0</span><span class="normal">  </span><span class="comment">/* MMX regs (%mm0, etc.) not supported by gcc 2.7.2.3 or egcs 1.1 */</span>
<span class="normal">                  </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"%mm0"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm1"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm2"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm3"</span><span class="normal">  </span><span class="comment">// clobber list</span>
<span class="normal">                  </span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm4"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm5"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm6"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm7"</span>
<span class="preproc">#endif</span>
<span class="normal">               </span><span class="symbol">);</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="keyword">else</span><span class="normal"> </span><span class="comment">/* mmx _not supported - Use modified C routine */</span>
<span class="preproc">#endif</span><span class="normal"> </span><span class="comment">/* PNG_ASSEMBLER_CODE_SUPPORTED */</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="keyword">register</span><span class="normal"> </span><span class="usertype">png_uint_32</span><span class="normal"> i</span><span class="symbol">;</span>
<span class="normal">               </span><span class="usertype">png_uint_32</span><span class="normal"> initial_val </span><span class="symbol">=</span><span class="normal"> BPP6 </span><span class="symbol">*</span><span class="normal"> png_pass_start</span><span class="symbol">[</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">pass</span><span class="symbol">];</span>
<span class="normal">                 </span><span class="comment">/* png.c:  png_pass_start[] = {0, 4, 0, 2, 0, 1, 0}; */</span>
<span class="normal">               </span><span class="keyword">register</span><span class="normal"> </span><span class="type">int</span><span class="normal"> stride </span><span class="symbol">=</span><span class="normal"> BPP6 </span><span class="symbol">*</span><span class="normal"> png_pass_inc</span><span class="symbol">[</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">pass</span><span class="symbol">];</span>
<span class="normal">                 </span><span class="comment">/* png.c:  png_pass_inc[] = {8, 8, 4, 4, 2, 2, 1}; */</span>
<span class="normal">               </span><span class="keyword">register</span><span class="normal"> </span><span class="type">int</span><span class="normal"> rep_bytes </span><span class="symbol">=</span><span class="normal"> BPP6 </span><span class="symbol">*</span><span class="normal"> png_pass_width</span><span class="symbol">[</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">pass</span><span class="symbol">];</span>
<span class="normal">                 </span><span class="comment">/* png.c:  png_pass_width[] = {8, 4, 4, 2, 2, 1, 1}; */</span>
<span class="normal">               </span><span class="usertype">png_uint_32</span><span class="normal"> len </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">width </span><span class="symbol">&amp;~</span><span class="number">7</span><span class="symbol">;</span><span class="normal">  </span><span class="comment">/* reduce to mult. of 8 */</span>
<span class="normal">               </span><span class="type">int</span><span class="normal"> diff </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">width </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">7</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* amount lost */</span>
<span class="normal">               </span><span class="keyword">register</span><span class="normal"> </span><span class="usertype">png_uint_32</span><span class="normal"> final_val </span><span class="symbol">=</span><span class="normal"> BPP6 </span><span class="symbol">*</span><span class="normal"> len</span><span class="symbol">;</span><span class="normal">   </span><span class="comment">/* GRR bugfix */</span>

<span class="normal">               srcptr </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_buf </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> initial_val</span><span class="symbol">;</span>
<span class="normal">               dstptr </span><span class="symbol">=</span><span class="normal"> row </span><span class="symbol">+</span><span class="normal"> initial_val</span><span class="symbol">;</span>

<span class="normal">               </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> initial_val</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> final_val</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">+=</span><span class="normal"> stride</span><span class="symbol">)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  </span><span class="function">png_memcpy</span><span class="symbol">(</span><span class="normal">dstptr</span><span class="symbol">,</span><span class="normal"> srcptr</span><span class="symbol">,</span><span class="normal"> rep_bytes</span><span class="symbol">);</span>
<span class="normal">                  srcptr </span><span class="symbol">+=</span><span class="normal"> stride</span><span class="symbol">;</span>
<span class="normal">                  dstptr </span><span class="symbol">+=</span><span class="normal"> stride</span><span class="symbol">;</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">diff</span><span class="symbol">)</span><span class="normal">  </span><span class="comment">/* number of leftover pixels:  3 for pngtest */</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  final_val</span><span class="symbol">+=</span><span class="normal">diff</span><span class="symbol">*</span><span class="normal">BPP6</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> final_val</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">+=</span><span class="normal"> stride</span><span class="symbol">)</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">rep_bytes </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="symbol">)(</span><span class="normal">final_val</span><span class="symbol">-</span><span class="normal">i</span><span class="symbol">))</span>
<span class="normal">                        rep_bytes </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="symbol">)(</span><span class="normal">final_val</span><span class="symbol">-</span><span class="normal">i</span><span class="symbol">);</span>
<span class="normal">                     </span><span class="function">png_memcpy</span><span class="symbol">(</span><span class="normal">dstptr</span><span class="symbol">,</span><span class="normal"> srcptr</span><span class="symbol">,</span><span class="normal"> rep_bytes</span><span class="symbol">);</span>
<span class="normal">                     srcptr </span><span class="symbol">+=</span><span class="normal"> stride</span><span class="symbol">;</span>
<span class="normal">                     dstptr </span><span class="symbol">+=</span><span class="normal"> stride</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="cbracket">}</span><span class="normal"> </span><span class="comment">/* end of else (_mmx_supported) */</span>

<span class="normal">            </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">         </span><span class="cbracket">}</span><span class="normal">       </span><span class="comment">/* end 48 bpp */</span>

<span class="normal">         </span><span class="keyword">case</span><span class="normal"> </span><span class="number">64</span><span class="symbol">:</span><span class="normal">       </span><span class="comment">/* png_ptr-&gt;row_info.pixel_depth */</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> srcptr</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> dstptr</span><span class="symbol">;</span>
<span class="normal">            </span><span class="keyword">register</span><span class="normal"> </span><span class="usertype">png_uint_32</span><span class="normal"> i</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_uint_32</span><span class="normal"> initial_val </span><span class="symbol">=</span><span class="normal"> BPP8 </span><span class="symbol">*</span><span class="normal"> png_pass_start</span><span class="symbol">[</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">pass</span><span class="symbol">];</span>
<span class="normal">              </span><span class="comment">/* png.c:  png_pass_start[] = {0, 4, 0, 2, 0, 1, 0}; */</span>
<span class="normal">            </span><span class="keyword">register</span><span class="normal"> </span><span class="type">int</span><span class="normal"> stride </span><span class="symbol">=</span><span class="normal"> BPP8 </span><span class="symbol">*</span><span class="normal"> png_pass_inc</span><span class="symbol">[</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">pass</span><span class="symbol">];</span>
<span class="normal">              </span><span class="comment">/* png.c:  png_pass_inc[] = {8, 8, 4, 4, 2, 2, 1}; */</span>
<span class="normal">            </span><span class="keyword">register</span><span class="normal"> </span><span class="type">int</span><span class="normal"> rep_bytes </span><span class="symbol">=</span><span class="normal"> BPP8 </span><span class="symbol">*</span><span class="normal"> png_pass_width</span><span class="symbol">[</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">pass</span><span class="symbol">];</span>
<span class="normal">              </span><span class="comment">/* png.c:  png_pass_width[] = {8, 4, 4, 2, 2, 1, 1}; */</span>
<span class="normal">            </span><span class="usertype">png_uint_32</span><span class="normal"> len </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">width </span><span class="symbol">&amp;~</span><span class="number">7</span><span class="symbol">;</span><span class="normal">  </span><span class="comment">/* reduce to mult. of 8 */</span>
<span class="normal">            </span><span class="type">int</span><span class="normal"> diff </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">width </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">7</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* amount lost */</span>
<span class="normal">            </span><span class="keyword">register</span><span class="normal"> </span><span class="usertype">png_uint_32</span><span class="normal"> final_val </span><span class="symbol">=</span><span class="normal"> BPP8 </span><span class="symbol">*</span><span class="normal"> len</span><span class="symbol">;</span><span class="normal">   </span><span class="comment">/* GRR bugfix */</span>

<span class="normal">            srcptr </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_buf </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> initial_val</span><span class="symbol">;</span>
<span class="normal">            dstptr </span><span class="symbol">=</span><span class="normal"> row </span><span class="symbol">+</span><span class="normal"> initial_val</span><span class="symbol">;</span>

<span class="normal">            </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> initial_val</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> final_val</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">+=</span><span class="normal"> stride</span><span class="symbol">)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="function">png_memcpy</span><span class="symbol">(</span><span class="normal">dstptr</span><span class="symbol">,</span><span class="normal"> srcptr</span><span class="symbol">,</span><span class="normal"> rep_bytes</span><span class="symbol">);</span>
<span class="normal">               srcptr </span><span class="symbol">+=</span><span class="normal"> stride</span><span class="symbol">;</span>
<span class="normal">               dstptr </span><span class="symbol">+=</span><span class="normal"> stride</span><span class="symbol">;</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">diff</span><span class="symbol">)</span><span class="normal">  </span><span class="comment">/* number of leftover pixels:  3 for pngtest */</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               final_val</span><span class="symbol">+=</span><span class="normal">diff</span><span class="symbol">*</span><span class="normal">BPP8</span><span class="symbol">;</span>
<span class="normal">               </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> final_val</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">+=</span><span class="normal"> stride</span><span class="symbol">)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">rep_bytes </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="symbol">)(</span><span class="normal">final_val</span><span class="symbol">-</span><span class="normal">i</span><span class="symbol">))</span>
<span class="normal">                     rep_bytes </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="symbol">)(</span><span class="normal">final_val</span><span class="symbol">-</span><span class="normal">i</span><span class="symbol">);</span>
<span class="normal">                  </span><span class="function">png_memcpy</span><span class="symbol">(</span><span class="normal">dstptr</span><span class="symbol">,</span><span class="normal"> srcptr</span><span class="symbol">,</span><span class="normal"> rep_bytes</span><span class="symbol">);</span>
<span class="normal">                  srcptr </span><span class="symbol">+=</span><span class="normal"> stride</span><span class="symbol">;</span>
<span class="normal">                  dstptr </span><span class="symbol">+=</span><span class="normal"> stride</span><span class="symbol">;</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="cbracket">}</span>

<span class="normal">            </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">         </span><span class="cbracket">}</span><span class="normal">       </span><span class="comment">/* end 64 bpp */</span>

<span class="normal">         </span><span class="keyword">default</span><span class="symbol">:</span><span class="normal"> </span><span class="comment">/* png_ptr-&gt;row_info.pixel_depth != 1,2,4,8,16,24,32,48,64 */</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="comment">/* this should never happen */</span>
<span class="normal">            </span><span class="function">png_warning</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"Invalid row_info.pixel_depth in pnggccrd"</span><span class="symbol">);</span>
<span class="normal">            </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="cbracket">}</span><span class="normal"> </span><span class="comment">/* end switch (png_ptr-&gt;row_info.pixel_depth) */</span>

<span class="normal">   </span><span class="cbracket">}</span><span class="normal"> </span><span class="comment">/* end if (non-trivial mask) */</span>

<span class="cbracket">}</span><span class="normal"> </span><span class="comment">/* end png_combine_row() */</span>

<span class="preproc">#endif</span><span class="normal"> </span><span class="comment">/* PNG_HAVE_ASSEMBLER_COMBINE_ROW */</span>




<span class="comment">/*===========================================================================*/</span>
<span class="comment">/*                                                                           */</span>
<span class="comment">/*                 P N G _ D O _ R E A D _ I N T E R L A C E                 */</span>
<span class="comment">/*                                                                           */</span>
<span class="comment">/*===========================================================================*/</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_INTERLACING_SUPPORTED</span><span class="symbol">)</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_HAVE_ASSEMBLER_READ_INTERLACE</span><span class="symbol">)</span>

<span class="comment">/* png_do_read_interlace() is called after any 16-bit to 8-bit conversion</span>
<span class="comment"> * has taken place.  [GRR: what other steps come before and/or after?]</span>
<span class="comment"> */</span>

<span class="type">void</span><span class="normal"> </span><span class="comment">/* PRIVATE */</span>
<span class="function">png_do_read_interlace</span><span class="symbol">(</span><span class="usertype">png_structp</span><span class="normal"> png_ptr</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">   </span><span class="usertype">png_row_infop</span><span class="normal"> row_info </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">&amp;(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_info</span><span class="symbol">);</span>
<span class="normal">   </span><span class="usertype">png_bytep</span><span class="normal"> row </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_buf </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">   </span><span class="type">int</span><span class="normal"> pass </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">pass</span><span class="symbol">;</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_PACKSWAP_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="usertype">png_uint_32</span><span class="normal"> transformations </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations</span><span class="symbol">;</span>
<span class="preproc">#endif</span>

<span class="normal">   </span><span class="function">png_debug</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"in png_do_read_interlace (pnggccrd.c)</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_ASSEMBLER_CODE_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">_mmx_supported </span><span class="symbol">==</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="symbol">!</span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_1_0_X</span><span class="symbol">)</span>
<span class="normal">       </span><span class="comment">/* this should have happened in png_init_mmx_flags() already */</span>
<span class="normal">       </span><span class="function">png_warning</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"asm_flags may not have been initialized"</span><span class="symbol">);</span>
<span class="preproc">#endif</span>
<span class="normal">       </span><span class="function">png_mmx_support</span><span class="symbol">();</span>
<span class="normal">   </span><span class="cbracket">}</span>
<span class="preproc">#endif</span>

<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row </span><span class="symbol">!=</span><span class="normal"> NULL </span><span class="symbol">&amp;&amp;</span><span class="normal"> row_info </span><span class="symbol">!=</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="usertype">png_uint_32</span><span class="normal"> final_width</span><span class="symbol">;</span>

<span class="normal">      final_width </span><span class="symbol">=</span><span class="normal"> row_info</span><span class="symbol">-&gt;</span><span class="normal">width </span><span class="symbol">*</span><span class="normal"> png_pass_inc</span><span class="symbol">[</span><span class="normal">pass</span><span class="symbol">];</span>

<span class="normal">      </span><span class="keyword">switch</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">pixel_depth</span><span class="symbol">)</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         </span><span class="keyword">case</span><span class="normal"> </span><span class="number">1</span><span class="symbol">:</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> sp</span><span class="symbol">,</span><span class="normal"> dp</span><span class="symbol">;</span>
<span class="normal">            </span><span class="type">int</span><span class="normal"> sshift</span><span class="symbol">,</span><span class="normal"> dshift</span><span class="symbol">;</span>
<span class="normal">            </span><span class="type">int</span><span class="normal"> s_start</span><span class="symbol">,</span><span class="normal"> s_end</span><span class="symbol">,</span><span class="normal"> s_inc</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_byte</span><span class="normal"> v</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_uint_32</span><span class="normal"> i</span><span class="symbol">;</span>
<span class="normal">            </span><span class="type">int</span><span class="normal"> j</span><span class="symbol">;</span>

<span class="normal">            sp </span><span class="symbol">=</span><span class="normal"> row </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_size_t</span><span class="symbol">)((</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">width </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">3</span><span class="symbol">);</span>
<span class="normal">            dp </span><span class="symbol">=</span><span class="normal"> row </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_size_t</span><span class="symbol">)((</span><span class="normal">final_width </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">3</span><span class="symbol">);</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_PACKSWAP_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">            </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">transformations </span><span class="symbol">&amp;</span><span class="normal"> PNG_PACKSWAP</span><span class="symbol">)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               sshift </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="symbol">)((</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">width </span><span class="symbol">+</span><span class="normal"> </span><span class="number">7</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">7</span><span class="symbol">);</span>
<span class="normal">               dshift </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="symbol">)((</span><span class="normal">final_width </span><span class="symbol">+</span><span class="normal"> </span><span class="number">7</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">7</span><span class="symbol">);</span>
<span class="normal">               s_start </span><span class="symbol">=</span><span class="normal"> </span><span class="number">7</span><span class="symbol">;</span>
<span class="normal">               s_end </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">               s_inc </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="keyword">else</span>
<span class="preproc">#endif</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               sshift </span><span class="symbol">=</span><span class="normal"> </span><span class="number">7</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="symbol">)((</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">width </span><span class="symbol">+</span><span class="normal"> </span><span class="number">7</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">7</span><span class="symbol">);</span>
<span class="normal">               dshift </span><span class="symbol">=</span><span class="normal"> </span><span class="number">7</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="symbol">)((</span><span class="normal">final_width </span><span class="symbol">+</span><span class="normal"> </span><span class="number">7</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">7</span><span class="symbol">);</span>
<span class="normal">               s_start </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">               s_end </span><span class="symbol">=</span><span class="normal"> </span><span class="number">7</span><span class="symbol">;</span>
<span class="normal">               s_inc </span><span class="symbol">=</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">            </span><span class="cbracket">}</span>

<span class="normal">            </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> row_info</span><span class="symbol">-&gt;</span><span class="normal">width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">--)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               v </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((*</span><span class="normal">sp </span><span class="symbol">&gt;&gt;</span><span class="normal"> sshift</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x1</span><span class="symbol">);</span>
<span class="normal">               </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">j </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> j </span><span class="symbol">&lt;</span><span class="normal"> png_pass_inc</span><span class="symbol">[</span><span class="normal">pass</span><span class="symbol">];</span><span class="normal"> j</span><span class="symbol">++)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  </span><span class="symbol">*</span><span class="normal">dp </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((</span><span class="number">0x7f7f</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="symbol">(</span><span class="number">7</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> dshift</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                  </span><span class="symbol">*</span><span class="normal">dp </span><span class="symbol">|=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">v </span><span class="symbol">&lt;&lt;</span><span class="normal"> dshift</span><span class="symbol">);</span>
<span class="normal">                  </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dshift </span><span class="symbol">==</span><span class="normal"> s_end</span><span class="symbol">)</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     dshift </span><span class="symbol">=</span><span class="normal"> s_start</span><span class="symbol">;</span>
<span class="normal">                     dp</span><span class="symbol">--;</span>
<span class="normal">                  </span><span class="cbracket">}</span>
<span class="normal">                  </span><span class="keyword">else</span>
<span class="normal">                     dshift </span><span class="symbol">+=</span><span class="normal"> s_inc</span><span class="symbol">;</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">sshift </span><span class="symbol">==</span><span class="normal"> s_end</span><span class="symbol">)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  sshift </span><span class="symbol">=</span><span class="normal"> s_start</span><span class="symbol">;</span>
<span class="normal">                  sp</span><span class="symbol">--;</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="keyword">else</span>
<span class="normal">                  sshift </span><span class="symbol">+=</span><span class="normal"> s_inc</span><span class="symbol">;</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">         </span><span class="cbracket">}</span>

<span class="normal">         </span><span class="keyword">case</span><span class="normal"> </span><span class="number">2</span><span class="symbol">:</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> sp</span><span class="symbol">,</span><span class="normal"> dp</span><span class="symbol">;</span>
<span class="normal">            </span><span class="type">int</span><span class="normal"> sshift</span><span class="symbol">,</span><span class="normal"> dshift</span><span class="symbol">;</span>
<span class="normal">            </span><span class="type">int</span><span class="normal"> s_start</span><span class="symbol">,</span><span class="normal"> s_end</span><span class="symbol">,</span><span class="normal"> s_inc</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_uint_32</span><span class="normal"> i</span><span class="symbol">;</span>

<span class="normal">            sp </span><span class="symbol">=</span><span class="normal"> row </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_size_t</span><span class="symbol">)((</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">width </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">2</span><span class="symbol">);</span>
<span class="normal">            dp </span><span class="symbol">=</span><span class="normal"> row </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_size_t</span><span class="symbol">)((</span><span class="normal">final_width </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">2</span><span class="symbol">);</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_PACKSWAP_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">            </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">transformations </span><span class="symbol">&amp;</span><span class="normal"> PNG_PACKSWAP</span><span class="symbol">)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               sshift </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_size_t</span><span class="symbol">)(((</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">width </span><span class="symbol">+</span><span class="normal"> </span><span class="number">3</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">3</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">               dshift </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_size_t</span><span class="symbol">)(((</span><span class="normal">final_width </span><span class="symbol">+</span><span class="normal"> </span><span class="number">3</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">3</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">               s_start </span><span class="symbol">=</span><span class="normal"> </span><span class="number">6</span><span class="symbol">;</span>
<span class="normal">               s_end </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">               s_inc </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">-</span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="keyword">else</span>
<span class="preproc">#endif</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               sshift </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_size_t</span><span class="symbol">)((</span><span class="number">3</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">width </span><span class="symbol">+</span><span class="normal"> </span><span class="number">3</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">3</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">               dshift </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_size_t</span><span class="symbol">)((</span><span class="number">3</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">final_width </span><span class="symbol">+</span><span class="normal"> </span><span class="number">3</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">3</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">               s_start </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">               s_end </span><span class="symbol">=</span><span class="normal"> </span><span class="number">6</span><span class="symbol">;</span>
<span class="normal">               s_inc </span><span class="symbol">=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">            </span><span class="cbracket">}</span>

<span class="normal">            </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> row_info</span><span class="symbol">-&gt;</span><span class="normal">width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">--)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="usertype">png_byte</span><span class="normal"> v</span><span class="symbol">;</span>
<span class="normal">               </span><span class="type">int</span><span class="normal"> j</span><span class="symbol">;</span>

<span class="normal">               v </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((*</span><span class="normal">sp </span><span class="symbol">&gt;&gt;</span><span class="normal"> sshift</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x3</span><span class="symbol">);</span>
<span class="normal">               </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">j </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> j </span><span class="symbol">&lt;</span><span class="normal"> png_pass_inc</span><span class="symbol">[</span><span class="normal">pass</span><span class="symbol">];</span><span class="normal"> j</span><span class="symbol">++)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  </span><span class="symbol">*</span><span class="normal">dp </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((</span><span class="number">0x3f3f</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="symbol">(</span><span class="number">6</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> dshift</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                  </span><span class="symbol">*</span><span class="normal">dp </span><span class="symbol">|=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">v </span><span class="symbol">&lt;&lt;</span><span class="normal"> dshift</span><span class="symbol">);</span>
<span class="normal">                  </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dshift </span><span class="symbol">==</span><span class="normal"> s_end</span><span class="symbol">)</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     dshift </span><span class="symbol">=</span><span class="normal"> s_start</span><span class="symbol">;</span>
<span class="normal">                     dp</span><span class="symbol">--;</span>
<span class="normal">                  </span><span class="cbracket">}</span>
<span class="normal">                  </span><span class="keyword">else</span>
<span class="normal">                     dshift </span><span class="symbol">+=</span><span class="normal"> s_inc</span><span class="symbol">;</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">sshift </span><span class="symbol">==</span><span class="normal"> s_end</span><span class="symbol">)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  sshift </span><span class="symbol">=</span><span class="normal"> s_start</span><span class="symbol">;</span>
<span class="normal">                  sp</span><span class="symbol">--;</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="keyword">else</span>
<span class="normal">                  sshift </span><span class="symbol">+=</span><span class="normal"> s_inc</span><span class="symbol">;</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">         </span><span class="cbracket">}</span>

<span class="normal">         </span><span class="keyword">case</span><span class="normal"> </span><span class="number">4</span><span class="symbol">:</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> sp</span><span class="symbol">,</span><span class="normal"> dp</span><span class="symbol">;</span>
<span class="normal">            </span><span class="type">int</span><span class="normal"> sshift</span><span class="symbol">,</span><span class="normal"> dshift</span><span class="symbol">;</span>
<span class="normal">            </span><span class="type">int</span><span class="normal"> s_start</span><span class="symbol">,</span><span class="normal"> s_end</span><span class="symbol">,</span><span class="normal"> s_inc</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_uint_32</span><span class="normal"> i</span><span class="symbol">;</span>

<span class="normal">            sp </span><span class="symbol">=</span><span class="normal"> row </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_size_t</span><span class="symbol">)((</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">width </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">            dp </span><span class="symbol">=</span><span class="normal"> row </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_size_t</span><span class="symbol">)((</span><span class="normal">final_width </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_PACKSWAP_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">            </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">transformations </span><span class="symbol">&amp;</span><span class="normal"> PNG_PACKSWAP</span><span class="symbol">)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               sshift </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_size_t</span><span class="symbol">)(((</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">width </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">2</span><span class="symbol">);</span>
<span class="normal">               dshift </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_size_t</span><span class="symbol">)(((</span><span class="normal">final_width </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">2</span><span class="symbol">);</span>
<span class="normal">               s_start </span><span class="symbol">=</span><span class="normal"> </span><span class="number">4</span><span class="symbol">;</span>
<span class="normal">               s_end </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">               s_inc </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">-</span><span class="number">4</span><span class="symbol">;</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="keyword">else</span>
<span class="preproc">#endif</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               sshift </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_size_t</span><span class="symbol">)((</span><span class="number">1</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">width </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">2</span><span class="symbol">);</span>
<span class="normal">               dshift </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_size_t</span><span class="symbol">)((</span><span class="number">1</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">final_width </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">2</span><span class="symbol">);</span>
<span class="normal">               s_start </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">               s_end </span><span class="symbol">=</span><span class="normal"> </span><span class="number">4</span><span class="symbol">;</span>
<span class="normal">               s_inc </span><span class="symbol">=</span><span class="normal"> </span><span class="number">4</span><span class="symbol">;</span>
<span class="normal">            </span><span class="cbracket">}</span>

<span class="normal">            </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> row_info</span><span class="symbol">-&gt;</span><span class="normal">width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">--)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="usertype">png_byte</span><span class="normal"> v</span><span class="symbol">;</span>
<span class="normal">               </span><span class="type">int</span><span class="normal"> j</span><span class="symbol">;</span>

<span class="normal">               v </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((*</span><span class="normal">sp </span><span class="symbol">&gt;&gt;</span><span class="normal"> sshift</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xf</span><span class="symbol">);</span>
<span class="normal">               </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">j </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> j </span><span class="symbol">&lt;</span><span class="normal"> png_pass_inc</span><span class="symbol">[</span><span class="normal">pass</span><span class="symbol">];</span><span class="normal"> j</span><span class="symbol">++)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  </span><span class="symbol">*</span><span class="normal">dp </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((</span><span class="number">0xf0f</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="symbol">(</span><span class="number">4</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> dshift</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                  </span><span class="symbol">*</span><span class="normal">dp </span><span class="symbol">|=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">v </span><span class="symbol">&lt;&lt;</span><span class="normal"> dshift</span><span class="symbol">);</span>
<span class="normal">                  </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dshift </span><span class="symbol">==</span><span class="normal"> s_end</span><span class="symbol">)</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     dshift </span><span class="symbol">=</span><span class="normal"> s_start</span><span class="symbol">;</span>
<span class="normal">                     dp</span><span class="symbol">--;</span>
<span class="normal">                  </span><span class="cbracket">}</span>
<span class="normal">                  </span><span class="keyword">else</span>
<span class="normal">                     dshift </span><span class="symbol">+=</span><span class="normal"> s_inc</span><span class="symbol">;</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">sshift </span><span class="symbol">==</span><span class="normal"> s_end</span><span class="symbol">)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  sshift </span><span class="symbol">=</span><span class="normal"> s_start</span><span class="symbol">;</span>
<span class="normal">                  sp</span><span class="symbol">--;</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="keyword">else</span>
<span class="normal">                  sshift </span><span class="symbol">+=</span><span class="normal"> s_inc</span><span class="symbol">;</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">         </span><span class="cbracket">}</span>

<span class="normal">       </span><span class="comment">/*====================================================================*/</span>

<span class="normal">         </span><span class="keyword">default</span><span class="symbol">:</span><span class="normal"> </span><span class="comment">/* 8-bit or larger (this is where the routine is modified) */</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="number">0</span>
<span class="comment">//          static unsigned long long _const4 = 0x0000000000FFFFFFLL;  no good</span>
<span class="comment">//          static unsigned long long const4 = 0x0000000000FFFFFFLL;   no good</span>
<span class="comment">//          unsigned long long _const4 = 0x0000000000FFFFFFLL;         no good</span>
<span class="comment">//          unsigned long long const4 = 0x0000000000FFFFFFLL;          no good</span>
<span class="preproc">#endif</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> sptr</span><span class="symbol">,</span><span class="normal"> dp</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_uint_32</span><span class="normal"> i</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_size_t</span><span class="normal"> pixel_bytes</span><span class="symbol">;</span>
<span class="normal">            </span><span class="type">int</span><span class="normal"> width </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="symbol">)</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">width</span><span class="symbol">;</span>

<span class="normal">            pixel_bytes </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">pixel_depth </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">3</span><span class="symbol">);</span>

<span class="normal">            </span><span class="comment">/* point sptr at the last pixel in the pre-expanded row: */</span>
<span class="normal">            sptr </span><span class="symbol">=</span><span class="normal"> row </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> pixel_bytes</span><span class="symbol">;</span>

<span class="normal">            </span><span class="comment">/* point dp at the last pixel position in the expanded row: */</span>
<span class="normal">            dp </span><span class="symbol">=</span><span class="normal"> row </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">final_width </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> pixel_bytes</span><span class="symbol">;</span>

<span class="normal">            </span><span class="comment">/* New code by Nirav Chhatrapati - Intel Corporation */</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_ASSEMBLER_CODE_SUPPORTED</span><span class="symbol">)</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="symbol">!</span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_1_0_X</span><span class="symbol">)</span>
<span class="normal">            </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">asm_flags </span><span class="symbol">&amp;</span><span class="normal"> PNG_ASM_FLAG_MMX_READ_INTERLACE</span><span class="symbol">)</span>
<span class="normal">                </span><span class="comment">/* &amp;&amp; _mmx_supported */</span><span class="normal"> </span><span class="symbol">)</span>
<span class="preproc">#else</span>
<span class="normal">            </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">_mmx_supported</span><span class="symbol">)</span>
<span class="preproc">#endif</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="comment">//--------------------------------------------------------------</span>
<span class="normal">               </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pixel_bytes </span><span class="symbol">==</span><span class="normal"> </span><span class="number">3</span><span class="symbol">)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(((</span><span class="normal">pass </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pass </span><span class="symbol">==</span><span class="normal"> </span><span class="number">1</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> width</span><span class="symbol">)</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     </span><span class="type">int</span><span class="normal"> dummy_value_c</span><span class="symbol">;</span><span class="normal">   </span><span class="comment">// fix 'forbidden register spilled'</span>
<span class="normal">                     </span><span class="type">int</span><span class="normal"> dummy_value_S</span><span class="symbol">;</span>
<span class="normal">                     </span><span class="type">int</span><span class="normal"> dummy_value_D</span><span class="symbol">;</span>
<span class="normal">                     </span><span class="type">int</span><span class="normal"> dummy_value_a</span><span class="symbol">;</span>

<span class="normal">                     </span><span class="usertype">__asm__</span><span class="normal"> </span><span class="function">__volatile__</span><span class="normal"> </span><span class="symbol">(</span>
<span class="normal">                        </span><span class="string">"subl $21, %%edi         </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                                     </span><span class="comment">// (png_pass_inc[pass] - 1)*pixel_bytes</span>

<span class="normal">                     </span><span class="string">".loop3_pass0:              </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                        </span><span class="string">"movd (%%esi), %%mm0     </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// x x x x x 2 1 0</span>
<span class="normal">                        </span><span class="string">"pand (%3), %%mm0        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// z z z z z 2 1 0</span>
<span class="normal">                        </span><span class="string">"movq %%mm0, %%mm1       </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// z z z z z 2 1 0</span>
<span class="normal">                        </span><span class="string">"psllq $16, %%mm0        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// z z z 2 1 0 z z</span>
<span class="normal">                        </span><span class="string">"movq %%mm0, %%mm2       </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// z z z 2 1 0 z z</span>
<span class="normal">                        </span><span class="string">"psllq $24, %%mm0        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// 2 1 0 z z z z z</span>
<span class="normal">                        </span><span class="string">"psrlq $8, %%mm1         </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// z z z z z z 2 1</span>
<span class="normal">                        </span><span class="string">"por %%mm2, %%mm0        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// 2 1 0 2 1 0 z z</span>
<span class="normal">                        </span><span class="string">"por %%mm1, %%mm0        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// 2 1 0 2 1 0 2 1</span>
<span class="normal">                        </span><span class="string">"movq %%mm0, %%mm3       </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// 2 1 0 2 1 0 2 1</span>
<span class="normal">                        </span><span class="string">"psllq $16, %%mm0        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// 0 2 1 0 2 1 z z</span>
<span class="normal">                        </span><span class="string">"movq %%mm3, %%mm4       </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// 2 1 0 2 1 0 2 1</span>
<span class="normal">                        </span><span class="string">"punpckhdq %%mm0, %%mm3  </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// 0 2 1 0 2 1 0 2</span>
<span class="normal">                        </span><span class="string">"movq %%mm4, 16(%%edi)   </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                        </span><span class="string">"psrlq $32, %%mm0        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// z z z z 0 2 1 0</span>
<span class="normal">                        </span><span class="string">"movq %%mm3, 8(%%edi)    </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                        </span><span class="string">"punpckldq %%mm4, %%mm0  </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// 1 0 2 1 0 2 1 0</span>
<span class="normal">                        </span><span class="string">"subl $3, %%esi          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                        </span><span class="string">"movq %%mm0, (%%edi)     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                        </span><span class="string">"subl $24, %%edi         </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                        </span><span class="string">"decl %%ecx              </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                        </span><span class="string">"jnz .loop3_pass0        </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                        </span><span class="string">"EMMS                    </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// DONE</span>

<span class="normal">                        </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"=c"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_c</span><span class="symbol">),</span><span class="normal">        </span><span class="comment">// output regs (dummy)</span>
<span class="normal">                          </span><span class="string">"=S"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_S</span><span class="symbol">),</span>
<span class="normal">                          </span><span class="string">"=D"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_D</span><span class="symbol">),</span>
<span class="normal">                          </span><span class="string">"=a"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_a</span><span class="symbol">)</span>


<span class="normal">                        </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"1"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">sptr</span><span class="symbol">),</span><span class="normal">      </span><span class="comment">// esi      // input regs</span>
<span class="normal">                          </span><span class="string">"2"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dp</span><span class="symbol">),</span><span class="normal">        </span><span class="comment">// edi</span>
<span class="normal">                          </span><span class="string">"0"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width</span><span class="symbol">),</span><span class="normal">     </span><span class="comment">// ecx</span>
<span class="normal">                          </span><span class="string">"3"</span><span class="normal"> </span><span class="symbol">(&amp;</span><span class="normal">_const4</span><span class="symbol">)</span><span class="normal">  </span><span class="comment">// %1(?)  (0x0000000000FFFFFFLL)</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="number">0</span><span class="normal">  </span><span class="comment">/* %mm0, ..., %mm4 not supported by gcc 2.7.2.3 or egcs 1.1 */</span>
<span class="normal">                        </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"%mm0"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm1"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm2"</span><span class="normal">       </span><span class="comment">// clobber list</span>
<span class="normal">                        </span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm3"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm4"</span>
<span class="preproc">#endif</span>
<span class="normal">                     </span><span class="symbol">);</span>
<span class="normal">                  </span><span class="cbracket">}</span>
<span class="normal">                  </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(((</span><span class="normal">pass </span><span class="symbol">==</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pass </span><span class="symbol">==</span><span class="normal"> </span><span class="number">3</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> width</span><span class="symbol">)</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     </span><span class="type">int</span><span class="normal"> dummy_value_c</span><span class="symbol">;</span><span class="normal">   </span><span class="comment">// fix 'forbidden register spilled'</span>
<span class="normal">                     </span><span class="type">int</span><span class="normal"> dummy_value_S</span><span class="symbol">;</span>
<span class="normal">                     </span><span class="type">int</span><span class="normal"> dummy_value_D</span><span class="symbol">;</span>
<span class="normal">                     </span><span class="type">int</span><span class="normal"> dummy_value_a</span><span class="symbol">;</span>

<span class="normal">                     </span><span class="usertype">__asm__</span><span class="normal"> </span><span class="function">__volatile__</span><span class="normal"> </span><span class="symbol">(</span>
<span class="normal">                        </span><span class="string">"subl $9, %%edi          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                                     </span><span class="comment">// (png_pass_inc[pass] - 1)*pixel_bytes</span>

<span class="normal">                     </span><span class="string">".loop3_pass2:              </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                        </span><span class="string">"movd (%%esi), %%mm0     </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// x x x x x 2 1 0</span>
<span class="normal">                        </span><span class="string">"pand (%3), %%mm0     </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// z z z z z 2 1 0</span>
<span class="normal">                        </span><span class="string">"movq %%mm0, %%mm1       </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// z z z z z 2 1 0</span>
<span class="normal">                        </span><span class="string">"psllq $16, %%mm0        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// z z z 2 1 0 z z</span>
<span class="normal">                        </span><span class="string">"movq %%mm0, %%mm2       </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// z z z 2 1 0 z z</span>
<span class="normal">                        </span><span class="string">"psllq $24, %%mm0        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// 2 1 0 z z z z z</span>
<span class="normal">                        </span><span class="string">"psrlq $8, %%mm1         </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// z z z z z z 2 1</span>
<span class="normal">                        </span><span class="string">"por %%mm2, %%mm0        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// 2 1 0 2 1 0 z z</span>
<span class="normal">                        </span><span class="string">"por %%mm1, %%mm0        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// 2 1 0 2 1 0 2 1</span>
<span class="normal">                        </span><span class="string">"movq %%mm0, 4(%%edi)    </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                        </span><span class="string">"psrlq $16, %%mm0        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// z z 2 1 0 2 1 0</span>
<span class="normal">                        </span><span class="string">"subl $3, %%esi          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                        </span><span class="string">"movd %%mm0, (%%edi)     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                        </span><span class="string">"subl $12, %%edi         </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                        </span><span class="string">"decl %%ecx              </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                        </span><span class="string">"jnz .loop3_pass2        </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                        </span><span class="string">"EMMS                    </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// DONE</span>

<span class="normal">                        </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"=c"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_c</span><span class="symbol">),</span><span class="normal">        </span><span class="comment">// output regs (dummy)</span>
<span class="normal">                          </span><span class="string">"=S"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_S</span><span class="symbol">),</span>
<span class="normal">                          </span><span class="string">"=D"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_D</span><span class="symbol">),</span>
<span class="normal">                          </span><span class="string">"=a"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_a</span><span class="symbol">)</span>

<span class="normal">                        </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"1"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">sptr</span><span class="symbol">),</span><span class="normal">      </span><span class="comment">// esi      // input regs</span>
<span class="normal">                          </span><span class="string">"2"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dp</span><span class="symbol">),</span><span class="normal">        </span><span class="comment">// edi</span>
<span class="normal">                          </span><span class="string">"0"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width</span><span class="symbol">),</span><span class="normal">     </span><span class="comment">// ecx</span>
<span class="normal">                          </span><span class="string">"3"</span><span class="normal"> </span><span class="symbol">(&amp;</span><span class="normal">_const4</span><span class="symbol">)</span><span class="normal">  </span><span class="comment">// (0x0000000000FFFFFFLL)</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="number">0</span><span class="normal">  </span><span class="comment">/* %mm0, ..., %mm2 not supported by gcc 2.7.2.3 or egcs 1.1 */</span>
<span class="normal">                        </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"%mm0"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm1"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm2"</span><span class="normal">       </span><span class="comment">// clobber list</span>
<span class="preproc">#endif</span>
<span class="normal">                     </span><span class="symbol">);</span>
<span class="normal">                  </span><span class="cbracket">}</span>
<span class="normal">                  </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width</span><span class="symbol">)</span><span class="normal"> </span><span class="comment">/* &amp;&amp; ((pass == 4) || (pass == 5)) */</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     </span><span class="type">int</span><span class="normal"> width_mmx </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">width </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="number">8</span><span class="symbol">;</span><span class="normal">   </span><span class="comment">// GRR:  huh?</span>
<span class="normal">                     </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width_mmx </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">                         width_mmx </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">                     width </span><span class="symbol">-=</span><span class="normal"> width_mmx</span><span class="symbol">;</span><span class="normal">        </span><span class="comment">// 8 or 9 pix, 24 or 27 bytes</span>
<span class="normal">                     </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width_mmx</span><span class="symbol">)</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="comment">// png_pass_inc[] = {8, 8, 4, 4, 2, 2, 1};</span>
<span class="normal">                        </span><span class="comment">// sptr points at last pixel in pre-expanded row</span>
<span class="normal">                        </span><span class="comment">// dp points at last pixel position in expanded row</span>
<span class="normal">                        </span><span class="type">int</span><span class="normal"> dummy_value_c</span><span class="symbol">;</span><span class="normal">  </span><span class="comment">// fix 'forbidden register spilled'</span>
<span class="normal">                        </span><span class="type">int</span><span class="normal"> dummy_value_S</span><span class="symbol">;</span>
<span class="normal">                        </span><span class="type">int</span><span class="normal"> dummy_value_D</span><span class="symbol">;</span>
<span class="normal">                        </span><span class="type">int</span><span class="normal"> dummy_value_a</span><span class="symbol">;</span>
<span class="normal">                        </span><span class="type">int</span><span class="normal"> dummy_value_d</span><span class="symbol">;</span>

<span class="normal">                        </span><span class="usertype">__asm__</span><span class="normal"> </span><span class="function">__volatile__</span><span class="normal"> </span><span class="symbol">(</span>
<span class="normal">                           </span><span class="string">"subl $3, %%esi          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"subl $9, %%edi          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                                        </span><span class="comment">// (png_pass_inc[pass] + 1)*pixel_bytes</span>

<span class="normal">                        </span><span class="string">".loop3_pass4:              </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"movq (%%esi), %%mm0     </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// x x 5 4 3 2 1 0</span>
<span class="normal">                           </span><span class="string">"movq %%mm0, %%mm1       </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// x x 5 4 3 2 1 0</span>
<span class="normal">                           </span><span class="string">"movq %%mm0, %%mm2       </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// x x 5 4 3 2 1 0</span>
<span class="normal">                           </span><span class="string">"psllq $24, %%mm0        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// 4 3 2 1 0 z z z</span>
<span class="normal">                           </span><span class="string">"pand (%3), %%mm1          </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// z z z z z 2 1 0</span>
<span class="normal">                           </span><span class="string">"psrlq $24, %%mm2        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// z z z x x 5 4 3</span>
<span class="normal">                           </span><span class="string">"por %%mm1, %%mm0        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// 4 3 2 1 0 2 1 0</span>
<span class="normal">                           </span><span class="string">"movq %%mm2, %%mm3       </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// z z z x x 5 4 3</span>
<span class="normal">                           </span><span class="string">"psllq $8, %%mm2         </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// z z x x 5 4 3 z</span>
<span class="normal">                           </span><span class="string">"movq %%mm0, (%%edi)     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"psrlq $16, %%mm3        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// z z z z z x x 5</span>
<span class="normal">                           </span><span class="string">"pand (%4), %%mm3     </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// z z z z z z z 5</span>
<span class="normal">                           </span><span class="string">"por %%mm3, %%mm2        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// z z x x 5 4 3 5</span>
<span class="normal">                           </span><span class="string">"subl $6, %%esi          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"movd %%mm2, 8(%%edi)    </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"subl $12, %%edi         </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"subl $2, %%ecx          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"jnz .loop3_pass4        </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"EMMS                    </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// DONE</span>

<span class="normal">                           </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"=c"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_c</span><span class="symbol">),</span><span class="normal">        </span><span class="comment">// output regs (dummy)</span>
<span class="normal">                             </span><span class="string">"=S"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_S</span><span class="symbol">),</span>
<span class="normal">                             </span><span class="string">"=D"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_D</span><span class="symbol">),</span>
<span class="normal">                             </span><span class="string">"=a"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_a</span><span class="symbol">),</span>
<span class="normal">                             </span><span class="string">"=d"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_d</span><span class="symbol">)</span>

<span class="normal">                           </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"1"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">sptr</span><span class="symbol">),</span><span class="normal">      </span><span class="comment">// esi      // input regs</span>
<span class="normal">                             </span><span class="string">"2"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dp</span><span class="symbol">),</span><span class="normal">        </span><span class="comment">// edi</span>
<span class="normal">                             </span><span class="string">"0"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width_mmx</span><span class="symbol">),</span><span class="normal"> </span><span class="comment">// ecx</span>
<span class="normal">                             </span><span class="string">"3"</span><span class="normal"> </span><span class="symbol">(&amp;</span><span class="normal">_const4</span><span class="symbol">),</span><span class="normal"> </span><span class="comment">// 0x0000000000FFFFFFLL</span>
<span class="normal">                             </span><span class="string">"4"</span><span class="normal"> </span><span class="symbol">(&amp;</span><span class="normal">_const6</span><span class="symbol">)</span><span class="normal">  </span><span class="comment">// 0x00000000000000FFLL</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="number">0</span><span class="normal">  </span><span class="comment">/* %mm0, ..., %mm3 not supported by gcc 2.7.2.3 or egcs 1.1 */</span>
<span class="normal">                           </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"%mm0"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm1"</span><span class="normal">               </span><span class="comment">// clobber list</span>
<span class="normal">                           </span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm2"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm3"</span>
<span class="preproc">#endif</span>
<span class="normal">                        </span><span class="symbol">);</span>
<span class="normal">                     </span><span class="cbracket">}</span>

<span class="normal">                     sptr </span><span class="symbol">-=</span><span class="normal"> width_mmx</span><span class="symbol">*</span><span class="number">3</span><span class="symbol">;</span>
<span class="normal">                     dp </span><span class="symbol">-=</span><span class="normal"> width_mmx</span><span class="symbol">*</span><span class="number">6</span><span class="symbol">;</span>
<span class="normal">                     </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">--)</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="usertype">png_byte</span><span class="normal"> v</span><span class="symbol">[</span><span class="number">8</span><span class="symbol">];</span>
<span class="normal">                        </span><span class="type">int</span><span class="normal"> j</span><span class="symbol">;</span>

<span class="normal">                        </span><span class="function">png_memcpy</span><span class="symbol">(</span><span class="normal">v</span><span class="symbol">,</span><span class="normal"> sptr</span><span class="symbol">,</span><span class="normal"> </span><span class="number">3</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">j </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> j </span><span class="symbol">&lt;</span><span class="normal"> png_pass_inc</span><span class="symbol">[</span><span class="normal">pass</span><span class="symbol">];</span><span class="normal"> j</span><span class="symbol">++)</span>
<span class="normal">                        </span><span class="cbracket">{</span>
<span class="normal">                           </span><span class="function">png_memcpy</span><span class="symbol">(</span><span class="normal">dp</span><span class="symbol">,</span><span class="normal"> v</span><span class="symbol">,</span><span class="normal"> </span><span class="number">3</span><span class="symbol">);</span>
<span class="normal">                           dp </span><span class="symbol">-=</span><span class="normal"> </span><span class="number">3</span><span class="symbol">;</span>
<span class="normal">                        </span><span class="cbracket">}</span>
<span class="normal">                        sptr </span><span class="symbol">-=</span><span class="normal"> </span><span class="number">3</span><span class="symbol">;</span>
<span class="normal">                     </span><span class="cbracket">}</span>
<span class="normal">                  </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="cbracket">}</span><span class="normal"> </span><span class="comment">/* end of pixel_bytes == 3 */</span>

<span class="normal">               </span><span class="comment">//--------------------------------------------------------------</span>
<span class="normal">               </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pixel_bytes </span><span class="symbol">==</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(((</span><span class="normal">pass </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pass </span><span class="symbol">==</span><span class="normal"> </span><span class="number">1</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> width</span><span class="symbol">)</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     </span><span class="type">int</span><span class="normal"> width_mmx </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">width </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">2</span><span class="symbol">);</span>
<span class="normal">                     width </span><span class="symbol">-=</span><span class="normal"> width_mmx</span><span class="symbol">;</span><span class="normal">        </span><span class="comment">// 0-3 pixels =&gt; 0-3 bytes</span>
<span class="normal">                     </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width_mmx</span><span class="symbol">)</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="type">int</span><span class="normal"> dummy_value_c</span><span class="symbol">;</span><span class="normal">  </span><span class="comment">// fix 'forbidden register spilled'</span>
<span class="normal">                        </span><span class="type">int</span><span class="normal"> dummy_value_S</span><span class="symbol">;</span>
<span class="normal">                        </span><span class="type">int</span><span class="normal"> dummy_value_D</span><span class="symbol">;</span>

<span class="normal">                        </span><span class="usertype">__asm__</span><span class="normal"> </span><span class="function">__volatile__</span><span class="normal"> </span><span class="symbol">(</span>
<span class="normal">                           </span><span class="string">"subl $3, %%esi          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"subl $31, %%edi         </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">                        </span><span class="string">".loop1_pass0:              </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"movd (%%esi), %%mm0     </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// x x x x 3 2 1 0</span>
<span class="normal">                           </span><span class="string">"movq %%mm0, %%mm1       </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// x x x x 3 2 1 0</span>
<span class="normal">                           </span><span class="string">"punpcklbw %%mm0, %%mm0  </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// 3 3 2 2 1 1 0 0</span>
<span class="normal">                           </span><span class="string">"movq %%mm0, %%mm2       </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// 3 3 2 2 1 1 0 0</span>
<span class="normal">                           </span><span class="string">"punpcklwd %%mm0, %%mm0  </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// 1 1 1 1 0 0 0 0</span>
<span class="normal">                           </span><span class="string">"movq %%mm0, %%mm3       </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// 1 1 1 1 0 0 0 0</span>
<span class="normal">                           </span><span class="string">"punpckldq %%mm0, %%mm0  </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// 0 0 0 0 0 0 0 0</span>
<span class="normal">                           </span><span class="string">"punpckhdq %%mm3, %%mm3  </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// 1 1 1 1 1 1 1 1</span>
<span class="normal">                           </span><span class="string">"movq %%mm0, (%%edi)     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"punpckhwd %%mm2, %%mm2  </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// 3 3 3 3 2 2 2 2</span>
<span class="normal">                           </span><span class="string">"movq %%mm3, 8(%%edi)    </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"movq %%mm2, %%mm4       </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// 3 3 3 3 2 2 2 2</span>
<span class="normal">                           </span><span class="string">"punpckldq %%mm2, %%mm2  </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// 2 2 2 2 2 2 2 2</span>
<span class="normal">                           </span><span class="string">"punpckhdq %%mm4, %%mm4  </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// 3 3 3 3 3 3 3 3</span>
<span class="normal">                           </span><span class="string">"movq %%mm2, 16(%%edi)   </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"subl $4, %%esi          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"movq %%mm4, 24(%%edi)   </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"subl $32, %%edi         </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"subl $4, %%ecx          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"jnz .loop1_pass0        </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"EMMS                    </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// DONE</span>

<span class="normal">                           </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"=c"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_c</span><span class="symbol">),</span><span class="normal">        </span><span class="comment">// output regs (dummy)</span>
<span class="normal">                             </span><span class="string">"=S"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_S</span><span class="symbol">),</span>
<span class="normal">                             </span><span class="string">"=D"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_D</span><span class="symbol">)</span>

<span class="normal">                           </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"1"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">sptr</span><span class="symbol">),</span><span class="normal">      </span><span class="comment">// esi      // input regs</span>
<span class="normal">                             </span><span class="string">"2"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dp</span><span class="symbol">),</span><span class="normal">        </span><span class="comment">// edi</span>
<span class="normal">                             </span><span class="string">"0"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width_mmx</span><span class="symbol">)</span><span class="normal">  </span><span class="comment">// ecx</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="number">0</span><span class="normal">  </span><span class="comment">/* %mm0, ..., %mm4 not supported by gcc 2.7.2.3 or egcs 1.1 */</span>
<span class="normal">                           </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"%mm0"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm1"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm2"</span><span class="normal">       </span><span class="comment">// clobber list</span>
<span class="normal">                           </span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm3"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm4"</span>
<span class="preproc">#endif</span>
<span class="normal">                        </span><span class="symbol">);</span>
<span class="normal">                     </span><span class="cbracket">}</span>

<span class="normal">                     sptr </span><span class="symbol">-=</span><span class="normal"> width_mmx</span><span class="symbol">;</span>
<span class="normal">                     dp </span><span class="symbol">-=</span><span class="normal"> width_mmx</span><span class="symbol">*</span><span class="number">8</span><span class="symbol">;</span>
<span class="normal">                     </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">--)</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="type">int</span><span class="normal"> j</span><span class="symbol">;</span>

<span class="normal">                       </span><span class="comment">/* I simplified this part in version 1.0.4e</span>
<span class="comment">                        * here and in several other instances where</span>
<span class="comment">                        * pixel_bytes == 1  -- GR-P</span>
<span class="comment">                        *</span>
<span class="comment">                        * Original code:</span>
<span class="comment">                        *</span>
<span class="comment">                        * png_byte v[8];</span>
<span class="comment">                        * png_memcpy(v, sptr, pixel_bytes);</span>
<span class="comment">                        * for (j = 0; j &lt; png_pass_inc[pass]; j++)</span>
<span class="comment">                        * {</span>
<span class="comment">                        *    png_memcpy(dp, v, pixel_bytes);</span>
<span class="comment">                        *    dp -= pixel_bytes;</span>
<span class="comment">                        * }</span>
<span class="comment">                        * sptr -= pixel_bytes;</span>
<span class="comment">                        *</span>
<span class="comment">                        * Replacement code is in the next three lines:</span>
<span class="comment">                        */</span>

<span class="normal">                        </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">j </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> j </span><span class="symbol">&lt;</span><span class="normal"> png_pass_inc</span><span class="symbol">[</span><span class="normal">pass</span><span class="symbol">];</span><span class="normal"> j</span><span class="symbol">++)</span>
<span class="normal">                        </span><span class="cbracket">{</span>
<span class="normal">                           </span><span class="symbol">*</span><span class="normal">dp</span><span class="symbol">--</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">sptr</span><span class="symbol">;</span>
<span class="normal">                        </span><span class="cbracket">}</span>
<span class="normal">                        </span><span class="symbol">--</span><span class="normal">sptr</span><span class="symbol">;</span>
<span class="normal">                     </span><span class="cbracket">}</span>
<span class="normal">                  </span><span class="cbracket">}</span>
<span class="normal">                  </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(((</span><span class="normal">pass </span><span class="symbol">==</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pass </span><span class="symbol">==</span><span class="normal"> </span><span class="number">3</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> width</span><span class="symbol">)</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     </span><span class="type">int</span><span class="normal"> width_mmx </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">width </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">2</span><span class="symbol">);</span>
<span class="normal">                     width </span><span class="symbol">-=</span><span class="normal"> width_mmx</span><span class="symbol">;</span><span class="normal">        </span><span class="comment">// 0-3 pixels =&gt; 0-3 bytes</span>
<span class="normal">                     </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width_mmx</span><span class="symbol">)</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="type">int</span><span class="normal"> dummy_value_c</span><span class="symbol">;</span><span class="normal">  </span><span class="comment">// fix 'forbidden register spilled'</span>
<span class="normal">                        </span><span class="type">int</span><span class="normal"> dummy_value_S</span><span class="symbol">;</span>
<span class="normal">                        </span><span class="type">int</span><span class="normal"> dummy_value_D</span><span class="symbol">;</span>

<span class="normal">                        </span><span class="usertype">__asm__</span><span class="normal"> </span><span class="function">__volatile__</span><span class="normal"> </span><span class="symbol">(</span>
<span class="normal">                           </span><span class="string">"subl $3, %%esi          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"subl $15, %%edi         </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">                        </span><span class="string">".loop1_pass2:              </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"movd (%%esi), %%mm0     </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// x x x x 3 2 1 0</span>
<span class="normal">                           </span><span class="string">"punpcklbw %%mm0, %%mm0  </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// 3 3 2 2 1 1 0 0</span>
<span class="normal">                           </span><span class="string">"movq %%mm0, %%mm1       </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// 3 3 2 2 1 1 0 0</span>
<span class="normal">                           </span><span class="string">"punpcklwd %%mm0, %%mm0  </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// 1 1 1 1 0 0 0 0</span>
<span class="normal">                           </span><span class="string">"punpckhwd %%mm1, %%mm1  </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// 3 3 3 3 2 2 2 2</span>
<span class="normal">                           </span><span class="string">"movq %%mm0, (%%edi)     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"subl $4, %%esi          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"movq %%mm1, 8(%%edi)    </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"subl $16, %%edi         </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"subl $4, %%ecx          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"jnz .loop1_pass2        </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"EMMS                    </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// DONE</span>

<span class="normal">                           </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"=c"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_c</span><span class="symbol">),</span><span class="normal">        </span><span class="comment">// output regs (dummy)</span>
<span class="normal">                             </span><span class="string">"=S"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_S</span><span class="symbol">),</span>
<span class="normal">                             </span><span class="string">"=D"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_D</span><span class="symbol">)</span>

<span class="normal">                           </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"1"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">sptr</span><span class="symbol">),</span><span class="normal">      </span><span class="comment">// esi      // input regs</span>
<span class="normal">                             </span><span class="string">"2"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dp</span><span class="symbol">),</span><span class="normal">        </span><span class="comment">// edi</span>
<span class="normal">                             </span><span class="string">"0"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width_mmx</span><span class="symbol">)</span><span class="normal">  </span><span class="comment">// ecx</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="number">0</span><span class="normal">  </span><span class="comment">/* %mm0, %mm1 not supported by gcc 2.7.2.3 or egcs 1.1 */</span>
<span class="normal">                           </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"%mm0"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm1"</span><span class="normal">               </span><span class="comment">// clobber list</span>
<span class="preproc">#endif</span>
<span class="normal">                        </span><span class="symbol">);</span>
<span class="normal">                     </span><span class="cbracket">}</span>

<span class="normal">                     sptr </span><span class="symbol">-=</span><span class="normal"> width_mmx</span><span class="symbol">;</span>
<span class="normal">                     dp </span><span class="symbol">-=</span><span class="normal"> width_mmx</span><span class="symbol">*</span><span class="number">4</span><span class="symbol">;</span>
<span class="normal">                     </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">--)</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="type">int</span><span class="normal"> j</span><span class="symbol">;</span>

<span class="normal">                        </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">j </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> j </span><span class="symbol">&lt;</span><span class="normal"> png_pass_inc</span><span class="symbol">[</span><span class="normal">pass</span><span class="symbol">];</span><span class="normal"> j</span><span class="symbol">++)</span>
<span class="normal">                        </span><span class="cbracket">{</span>
<span class="normal">                           </span><span class="symbol">*</span><span class="normal">dp</span><span class="symbol">--</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">sptr</span><span class="symbol">;</span>
<span class="normal">                        </span><span class="cbracket">}</span>
<span class="normal">                        </span><span class="symbol">--</span><span class="normal">sptr</span><span class="symbol">;</span>
<span class="normal">                     </span><span class="cbracket">}</span>
<span class="normal">                  </span><span class="cbracket">}</span>
<span class="normal">                  </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width</span><span class="symbol">)</span><span class="normal">  </span><span class="comment">/* &amp;&amp; ((pass == 4) || (pass == 5)) */</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     </span><span class="type">int</span><span class="normal"> width_mmx </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">width </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">3</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">3</span><span class="symbol">);</span>
<span class="normal">                     width </span><span class="symbol">-=</span><span class="normal"> width_mmx</span><span class="symbol">;</span><span class="normal">        </span><span class="comment">// 0-3 pixels =&gt; 0-3 bytes</span>
<span class="normal">                     </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width_mmx</span><span class="symbol">)</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="type">int</span><span class="normal"> dummy_value_c</span><span class="symbol">;</span><span class="normal">  </span><span class="comment">// fix 'forbidden register spilled'</span>
<span class="normal">                        </span><span class="type">int</span><span class="normal"> dummy_value_S</span><span class="symbol">;</span>
<span class="normal">                        </span><span class="type">int</span><span class="normal"> dummy_value_D</span><span class="symbol">;</span>

<span class="normal">                        </span><span class="usertype">__asm__</span><span class="normal"> </span><span class="function">__volatile__</span><span class="normal"> </span><span class="symbol">(</span>
<span class="normal">                           </span><span class="string">"subl $7, %%esi          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"subl $15, %%edi         </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">                        </span><span class="string">".loop1_pass4:              </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"movq (%%esi), %%mm0     </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// 7 6 5 4 3 2 1 0</span>
<span class="normal">                           </span><span class="string">"movq %%mm0, %%mm1       </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// 7 6 5 4 3 2 1 0</span>
<span class="normal">                           </span><span class="string">"punpcklbw %%mm0, %%mm0  </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// 3 3 2 2 1 1 0 0</span>
<span class="normal">                           </span><span class="string">"punpckhbw %%mm1, %%mm1  </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// 7 7 6 6 5 5 4 4</span>
<span class="normal">                           </span><span class="string">"movq %%mm1, 8(%%edi)    </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"subl $8, %%esi          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"movq %%mm0, (%%edi)     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"subl $16, %%edi         </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"subl $8, %%ecx          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"jnz .loop1_pass4        </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"EMMS                    </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// DONE</span>

<span class="normal">                           </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"=c"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_c</span><span class="symbol">),</span><span class="normal">        </span><span class="comment">// output regs (none)</span>
<span class="normal">                             </span><span class="string">"=S"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_S</span><span class="symbol">),</span>
<span class="normal">                             </span><span class="string">"=D"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_D</span><span class="symbol">)</span>

<span class="normal">                           </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"1"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">sptr</span><span class="symbol">),</span><span class="normal">      </span><span class="comment">// esi      // input regs</span>
<span class="normal">                             </span><span class="string">"2"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dp</span><span class="symbol">),</span><span class="normal">        </span><span class="comment">// edi</span>
<span class="normal">                             </span><span class="string">"0"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width_mmx</span><span class="symbol">)</span><span class="normal">  </span><span class="comment">// ecx</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="number">0</span><span class="normal">  </span><span class="comment">/* %mm0, %mm1 not supported by gcc 2.7.2.3 or egcs 1.1 */</span>
<span class="normal">                           </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"%mm0"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm1"</span><span class="normal">               </span><span class="comment">// clobber list</span>
<span class="preproc">#endif</span>
<span class="normal">                        </span><span class="symbol">);</span>
<span class="normal">                     </span><span class="cbracket">}</span>

<span class="normal">                     sptr </span><span class="symbol">-=</span><span class="normal"> width_mmx</span><span class="symbol">;</span>
<span class="normal">                     dp </span><span class="symbol">-=</span><span class="normal"> width_mmx</span><span class="symbol">*</span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">                     </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">--)</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="type">int</span><span class="normal"> j</span><span class="symbol">;</span>

<span class="normal">                        </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">j </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> j </span><span class="symbol">&lt;</span><span class="normal"> png_pass_inc</span><span class="symbol">[</span><span class="normal">pass</span><span class="symbol">];</span><span class="normal"> j</span><span class="symbol">++)</span>
<span class="normal">                        </span><span class="cbracket">{</span>
<span class="normal">                           </span><span class="symbol">*</span><span class="normal">dp</span><span class="symbol">--</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">sptr</span><span class="symbol">;</span>
<span class="normal">                        </span><span class="cbracket">}</span>
<span class="normal">                        </span><span class="symbol">--</span><span class="normal">sptr</span><span class="symbol">;</span>
<span class="normal">                     </span><span class="cbracket">}</span>
<span class="normal">                  </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="cbracket">}</span><span class="normal"> </span><span class="comment">/* end of pixel_bytes == 1 */</span>

<span class="normal">               </span><span class="comment">//--------------------------------------------------------------</span>
<span class="normal">               </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pixel_bytes </span><span class="symbol">==</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(((</span><span class="normal">pass </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pass </span><span class="symbol">==</span><span class="normal"> </span><span class="number">1</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> width</span><span class="symbol">)</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     </span><span class="type">int</span><span class="normal"> width_mmx </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">width </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">                     width </span><span class="symbol">-=</span><span class="normal"> width_mmx</span><span class="symbol">;</span><span class="normal">        </span><span class="comment">// 0,1 pixels =&gt; 0,2 bytes</span>
<span class="normal">                     </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width_mmx</span><span class="symbol">)</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="type">int</span><span class="normal"> dummy_value_c</span><span class="symbol">;</span><span class="normal">  </span><span class="comment">// fix 'forbidden register spilled'</span>
<span class="normal">                        </span><span class="type">int</span><span class="normal"> dummy_value_S</span><span class="symbol">;</span>
<span class="normal">                        </span><span class="type">int</span><span class="normal"> dummy_value_D</span><span class="symbol">;</span>

<span class="normal">                        </span><span class="usertype">__asm__</span><span class="normal"> </span><span class="function">__volatile__</span><span class="normal"> </span><span class="symbol">(</span>
<span class="normal">                           </span><span class="string">"subl $2, %%esi          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"subl $30, %%edi         </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">                        </span><span class="string">".loop2_pass0:              </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"movd (%%esi), %%mm0     </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// x x x x 3 2 1 0</span>
<span class="normal">                           </span><span class="string">"punpcklwd %%mm0, %%mm0  </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// 3 2 3 2 1 0 1 0</span>
<span class="normal">                           </span><span class="string">"movq %%mm0, %%mm1       </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// 3 2 3 2 1 0 1 0</span>
<span class="normal">                           </span><span class="string">"punpckldq %%mm0, %%mm0  </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// 1 0 1 0 1 0 1 0</span>
<span class="normal">                           </span><span class="string">"punpckhdq %%mm1, %%mm1  </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// 3 2 3 2 3 2 3 2</span>
<span class="normal">                           </span><span class="string">"movq %%mm0, (%%edi)     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"movq %%mm0, 8(%%edi)    </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"movq %%mm1, 16(%%edi)   </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"subl $4, %%esi          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"movq %%mm1, 24(%%edi)   </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"subl $32, %%edi         </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"subl $2, %%ecx          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"jnz .loop2_pass0        </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"EMMS                    </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// DONE</span>

<span class="normal">                           </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"=c"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_c</span><span class="symbol">),</span><span class="normal">        </span><span class="comment">// output regs (dummy)</span>
<span class="normal">                             </span><span class="string">"=S"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_S</span><span class="symbol">),</span>
<span class="normal">                             </span><span class="string">"=D"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_D</span><span class="symbol">)</span>

<span class="normal">                           </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"1"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">sptr</span><span class="symbol">),</span><span class="normal">      </span><span class="comment">// esi      // input regs</span>
<span class="normal">                             </span><span class="string">"2"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dp</span><span class="symbol">),</span><span class="normal">        </span><span class="comment">// edi</span>
<span class="normal">                             </span><span class="string">"0"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width_mmx</span><span class="symbol">)</span><span class="normal">  </span><span class="comment">// ecx</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="number">0</span><span class="normal">  </span><span class="comment">/* %mm0, %mm1 not supported by gcc 2.7.2.3 or egcs 1.1 */</span>
<span class="normal">                           </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"%mm0"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm1"</span><span class="normal">               </span><span class="comment">// clobber list</span>
<span class="preproc">#endif</span>
<span class="normal">                        </span><span class="symbol">);</span>
<span class="normal">                     </span><span class="cbracket">}</span>

<span class="normal">                     sptr </span><span class="symbol">-=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width_mmx</span><span class="symbol">*</span><span class="number">2</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="number">2</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">// sign fixed</span>
<span class="normal">                     dp </span><span class="symbol">-=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width_mmx</span><span class="symbol">*</span><span class="number">16</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="number">2</span><span class="symbol">);</span><span class="normal">  </span><span class="comment">// sign fixed</span>
<span class="normal">                     </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">--)</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="usertype">png_byte</span><span class="normal"> v</span><span class="symbol">[</span><span class="number">8</span><span class="symbol">];</span>
<span class="normal">                        </span><span class="type">int</span><span class="normal"> j</span><span class="symbol">;</span>
<span class="normal">                        sptr </span><span class="symbol">-=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">                        </span><span class="function">png_memcpy</span><span class="symbol">(</span><span class="normal">v</span><span class="symbol">,</span><span class="normal"> sptr</span><span class="symbol">,</span><span class="normal"> </span><span class="number">2</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">j </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> j </span><span class="symbol">&lt;</span><span class="normal"> png_pass_inc</span><span class="symbol">[</span><span class="normal">pass</span><span class="symbol">];</span><span class="normal"> j</span><span class="symbol">++)</span>
<span class="normal">                        </span><span class="cbracket">{</span>
<span class="normal">                           dp </span><span class="symbol">-=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">                           </span><span class="function">png_memcpy</span><span class="symbol">(</span><span class="normal">dp</span><span class="symbol">,</span><span class="normal"> v</span><span class="symbol">,</span><span class="normal"> </span><span class="number">2</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="cbracket">}</span>
<span class="normal">                     </span><span class="cbracket">}</span>
<span class="normal">                  </span><span class="cbracket">}</span>
<span class="normal">                  </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(((</span><span class="normal">pass </span><span class="symbol">==</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pass </span><span class="symbol">==</span><span class="normal"> </span><span class="number">3</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> width</span><span class="symbol">)</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     </span><span class="type">int</span><span class="normal"> width_mmx </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">width </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">;</span>
<span class="normal">                     width </span><span class="symbol">-=</span><span class="normal"> width_mmx</span><span class="symbol">;</span><span class="normal">        </span><span class="comment">// 0,1 pixels =&gt; 0,2 bytes</span>
<span class="normal">                     </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width_mmx</span><span class="symbol">)</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="type">int</span><span class="normal"> dummy_value_c</span><span class="symbol">;</span><span class="normal">  </span><span class="comment">// fix 'forbidden register spilled'</span>
<span class="normal">                        </span><span class="type">int</span><span class="normal"> dummy_value_S</span><span class="symbol">;</span>
<span class="normal">                        </span><span class="type">int</span><span class="normal"> dummy_value_D</span><span class="symbol">;</span>

<span class="normal">                        </span><span class="usertype">__asm__</span><span class="normal"> </span><span class="function">__volatile__</span><span class="normal"> </span><span class="symbol">(</span>
<span class="normal">                           </span><span class="string">"subl $2, %%esi          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"subl $14, %%edi         </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">                        </span><span class="string">".loop2_pass2:              </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"movd (%%esi), %%mm0     </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// x x x x 3 2 1 0</span>
<span class="normal">                           </span><span class="string">"punpcklwd %%mm0, %%mm0  </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// 3 2 3 2 1 0 1 0</span>
<span class="normal">                           </span><span class="string">"movq %%mm0, %%mm1       </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// 3 2 3 2 1 0 1 0</span>
<span class="normal">                           </span><span class="string">"punpckldq %%mm0, %%mm0  </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// 1 0 1 0 1 0 1 0</span>
<span class="normal">                           </span><span class="string">"punpckhdq %%mm1, %%mm1  </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// 3 2 3 2 3 2 3 2</span>
<span class="normal">                           </span><span class="string">"movq %%mm0, (%%edi)     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"subl $4, %%esi          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"movq %%mm1, 8(%%edi)    </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"subl $16, %%edi         </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"subl $2, %%ecx          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"jnz .loop2_pass2        </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"EMMS                    </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// DONE</span>

<span class="normal">                           </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"=c"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_c</span><span class="symbol">),</span><span class="normal">        </span><span class="comment">// output regs (dummy)</span>
<span class="normal">                             </span><span class="string">"=S"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_S</span><span class="symbol">),</span>
<span class="normal">                             </span><span class="string">"=D"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_D</span><span class="symbol">)</span>

<span class="normal">                           </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"1"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">sptr</span><span class="symbol">),</span><span class="normal">      </span><span class="comment">// esi      // input regs</span>
<span class="normal">                             </span><span class="string">"2"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dp</span><span class="symbol">),</span><span class="normal">        </span><span class="comment">// edi</span>
<span class="normal">                             </span><span class="string">"0"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width_mmx</span><span class="symbol">)</span><span class="normal">  </span><span class="comment">// ecx</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="number">0</span><span class="normal">  </span><span class="comment">/* %mm0, %mm1 not supported by gcc 2.7.2.3 or egcs 1.1 */</span>
<span class="normal">                           </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"%mm0"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm1"</span><span class="normal">               </span><span class="comment">// clobber list</span>
<span class="preproc">#endif</span>
<span class="normal">                        </span><span class="symbol">);</span>
<span class="normal">                     </span><span class="cbracket">}</span>

<span class="normal">                     sptr </span><span class="symbol">-=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width_mmx</span><span class="symbol">*</span><span class="number">2</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="number">2</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">// sign fixed</span>
<span class="normal">                     dp </span><span class="symbol">-=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width_mmx</span><span class="symbol">*</span><span class="number">8</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="number">2</span><span class="symbol">);</span><span class="normal">   </span><span class="comment">// sign fixed</span>
<span class="normal">                     </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">--)</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="usertype">png_byte</span><span class="normal"> v</span><span class="symbol">[</span><span class="number">8</span><span class="symbol">];</span>
<span class="normal">                        </span><span class="type">int</span><span class="normal"> j</span><span class="symbol">;</span>
<span class="normal">                        sptr </span><span class="symbol">-=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">                        </span><span class="function">png_memcpy</span><span class="symbol">(</span><span class="normal">v</span><span class="symbol">,</span><span class="normal"> sptr</span><span class="symbol">,</span><span class="normal"> </span><span class="number">2</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">j </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> j </span><span class="symbol">&lt;</span><span class="normal"> png_pass_inc</span><span class="symbol">[</span><span class="normal">pass</span><span class="symbol">];</span><span class="normal"> j</span><span class="symbol">++)</span>
<span class="normal">                        </span><span class="cbracket">{</span>
<span class="normal">                           dp </span><span class="symbol">-=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">                           </span><span class="function">png_memcpy</span><span class="symbol">(</span><span class="normal">dp</span><span class="symbol">,</span><span class="normal"> v</span><span class="symbol">,</span><span class="normal"> </span><span class="number">2</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="cbracket">}</span>
<span class="normal">                     </span><span class="cbracket">}</span>
<span class="normal">                  </span><span class="cbracket">}</span>
<span class="normal">                  </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width</span><span class="symbol">)</span><span class="normal">  </span><span class="comment">// pass == 4 or 5</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     </span><span class="type">int</span><span class="normal"> width_mmx </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">width </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">;</span>
<span class="normal">                     width </span><span class="symbol">-=</span><span class="normal"> width_mmx</span><span class="symbol">;</span><span class="normal">        </span><span class="comment">// 0,1 pixels =&gt; 0,2 bytes</span>
<span class="normal">                     </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width_mmx</span><span class="symbol">)</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="type">int</span><span class="normal"> dummy_value_c</span><span class="symbol">;</span><span class="normal">  </span><span class="comment">// fix 'forbidden register spilled'</span>
<span class="normal">                        </span><span class="type">int</span><span class="normal"> dummy_value_S</span><span class="symbol">;</span>
<span class="normal">                        </span><span class="type">int</span><span class="normal"> dummy_value_D</span><span class="symbol">;</span>

<span class="normal">                        </span><span class="usertype">__asm__</span><span class="normal"> </span><span class="function">__volatile__</span><span class="normal"> </span><span class="symbol">(</span>
<span class="normal">                           </span><span class="string">"subl $2, %%esi          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"subl $6, %%edi          </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">                        </span><span class="string">".loop2_pass4:              </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"movd (%%esi), %%mm0     </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// x x x x 3 2 1 0</span>
<span class="normal">                           </span><span class="string">"punpcklwd %%mm0, %%mm0  </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// 3 2 3 2 1 0 1 0</span>
<span class="normal">                           </span><span class="string">"subl $4, %%esi          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"movq %%mm0, (%%edi)     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"subl $8, %%edi          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"subl $2, %%ecx          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"jnz .loop2_pass4        </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"EMMS                    </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// DONE</span>

<span class="normal">                           </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"=c"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_c</span><span class="symbol">),</span><span class="normal">        </span><span class="comment">// output regs (dummy)</span>
<span class="normal">                             </span><span class="string">"=S"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_S</span><span class="symbol">),</span>
<span class="normal">                             </span><span class="string">"=D"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_D</span><span class="symbol">)</span>

<span class="normal">                           </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"1"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">sptr</span><span class="symbol">),</span><span class="normal">      </span><span class="comment">// esi      // input regs</span>
<span class="normal">                             </span><span class="string">"2"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dp</span><span class="symbol">),</span><span class="normal">        </span><span class="comment">// edi</span>
<span class="normal">                             </span><span class="string">"0"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width_mmx</span><span class="symbol">)</span><span class="normal">  </span><span class="comment">// ecx</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="number">0</span><span class="normal">  </span><span class="comment">/* %mm0 not supported by gcc 2.7.2.3 or egcs 1.1 */</span>
<span class="normal">                           </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"%mm0"</span><span class="normal">                       </span><span class="comment">// clobber list</span>
<span class="preproc">#endif</span>
<span class="normal">                        </span><span class="symbol">);</span>
<span class="normal">                     </span><span class="cbracket">}</span>

<span class="normal">                     sptr </span><span class="symbol">-=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width_mmx</span><span class="symbol">*</span><span class="number">2</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="number">2</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">// sign fixed</span>
<span class="normal">                     dp </span><span class="symbol">-=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width_mmx</span><span class="symbol">*</span><span class="number">4</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="number">2</span><span class="symbol">);</span><span class="normal">   </span><span class="comment">// sign fixed</span>
<span class="normal">                     </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">--)</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="usertype">png_byte</span><span class="normal"> v</span><span class="symbol">[</span><span class="number">8</span><span class="symbol">];</span>
<span class="normal">                        </span><span class="type">int</span><span class="normal"> j</span><span class="symbol">;</span>
<span class="normal">                        sptr </span><span class="symbol">-=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">                        </span><span class="function">png_memcpy</span><span class="symbol">(</span><span class="normal">v</span><span class="symbol">,</span><span class="normal"> sptr</span><span class="symbol">,</span><span class="normal"> </span><span class="number">2</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">j </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> j </span><span class="symbol">&lt;</span><span class="normal"> png_pass_inc</span><span class="symbol">[</span><span class="normal">pass</span><span class="symbol">];</span><span class="normal"> j</span><span class="symbol">++)</span>
<span class="normal">                        </span><span class="cbracket">{</span>
<span class="normal">                           dp </span><span class="symbol">-=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">                           </span><span class="function">png_memcpy</span><span class="symbol">(</span><span class="normal">dp</span><span class="symbol">,</span><span class="normal"> v</span><span class="symbol">,</span><span class="normal"> </span><span class="number">2</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="cbracket">}</span>
<span class="normal">                     </span><span class="cbracket">}</span>
<span class="normal">                  </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="cbracket">}</span><span class="normal"> </span><span class="comment">/* end of pixel_bytes == 2 */</span>

<span class="normal">               </span><span class="comment">//--------------------------------------------------------------</span>
<span class="normal">               </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pixel_bytes </span><span class="symbol">==</span><span class="normal"> </span><span class="number">4</span><span class="symbol">)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(((</span><span class="normal">pass </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pass </span><span class="symbol">==</span><span class="normal"> </span><span class="number">1</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> width</span><span class="symbol">)</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     </span><span class="type">int</span><span class="normal"> width_mmx </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">width </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">                     width </span><span class="symbol">-=</span><span class="normal"> width_mmx</span><span class="symbol">;</span><span class="normal">        </span><span class="comment">// 0,1 pixels =&gt; 0,4 bytes</span>
<span class="normal">                     </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width_mmx</span><span class="symbol">)</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="type">int</span><span class="normal"> dummy_value_c</span><span class="symbol">;</span><span class="normal">  </span><span class="comment">// fix 'forbidden register spilled'</span>
<span class="normal">                        </span><span class="type">int</span><span class="normal"> dummy_value_S</span><span class="symbol">;</span>
<span class="normal">                        </span><span class="type">int</span><span class="normal"> dummy_value_D</span><span class="symbol">;</span>

<span class="normal">                        </span><span class="usertype">__asm__</span><span class="normal"> </span><span class="function">__volatile__</span><span class="normal"> </span><span class="symbol">(</span>
<span class="normal">                           </span><span class="string">"subl $4, %%esi          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"subl $60, %%edi         </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">                        </span><span class="string">".loop4_pass0:              </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"movq (%%esi), %%mm0     </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// 7 6 5 4 3 2 1 0</span>
<span class="normal">                           </span><span class="string">"movq %%mm0, %%mm1       </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// 7 6 5 4 3 2 1 0</span>
<span class="normal">                           </span><span class="string">"punpckldq %%mm0, %%mm0  </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// 3 2 1 0 3 2 1 0</span>
<span class="normal">                           </span><span class="string">"punpckhdq %%mm1, %%mm1  </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// 7 6 5 4 7 6 5 4</span>
<span class="normal">                           </span><span class="string">"movq %%mm0, (%%edi)     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"movq %%mm0, 8(%%edi)    </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"movq %%mm0, 16(%%edi)   </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"movq %%mm0, 24(%%edi)   </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"movq %%mm1, 32(%%edi)   </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"movq %%mm1, 40(%%edi)   </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"movq %%mm1, 48(%%edi)   </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"subl $8, %%esi          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"movq %%mm1, 56(%%edi)   </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"subl $64, %%edi         </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"subl $2, %%ecx          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"jnz .loop4_pass0        </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"EMMS                    </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// DONE</span>

<span class="normal">                           </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"=c"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_c</span><span class="symbol">),</span><span class="normal">        </span><span class="comment">// output regs (dummy)</span>
<span class="normal">                             </span><span class="string">"=S"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_S</span><span class="symbol">),</span>
<span class="normal">                             </span><span class="string">"=D"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_D</span><span class="symbol">)</span>

<span class="normal">                           </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"1"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">sptr</span><span class="symbol">),</span><span class="normal">      </span><span class="comment">// esi      // input regs</span>
<span class="normal">                             </span><span class="string">"2"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dp</span><span class="symbol">),</span><span class="normal">        </span><span class="comment">// edi</span>
<span class="normal">                             </span><span class="string">"0"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width_mmx</span><span class="symbol">)</span><span class="normal">  </span><span class="comment">// ecx</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="number">0</span><span class="normal">  </span><span class="comment">/* %mm0, %mm1 not supported by gcc 2.7.2.3 or egcs 1.1 */</span>
<span class="normal">                           </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"%mm0"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm1"</span><span class="normal">               </span><span class="comment">// clobber list</span>
<span class="preproc">#endif</span>
<span class="normal">                        </span><span class="symbol">);</span>
<span class="normal">                     </span><span class="cbracket">}</span>

<span class="normal">                     sptr </span><span class="symbol">-=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width_mmx</span><span class="symbol">*</span><span class="number">4</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="number">4</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">// sign fixed</span>
<span class="normal">                     dp </span><span class="symbol">-=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width_mmx</span><span class="symbol">*</span><span class="number">32</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="number">4</span><span class="symbol">);</span><span class="normal">  </span><span class="comment">// sign fixed</span>
<span class="normal">                     </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">--)</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="usertype">png_byte</span><span class="normal"> v</span><span class="symbol">[</span><span class="number">8</span><span class="symbol">];</span>
<span class="normal">                        </span><span class="type">int</span><span class="normal"> j</span><span class="symbol">;</span>
<span class="normal">                        sptr </span><span class="symbol">-=</span><span class="normal"> </span><span class="number">4</span><span class="symbol">;</span>
<span class="normal">                        </span><span class="function">png_memcpy</span><span class="symbol">(</span><span class="normal">v</span><span class="symbol">,</span><span class="normal"> sptr</span><span class="symbol">,</span><span class="normal"> </span><span class="number">4</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">j </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> j </span><span class="symbol">&lt;</span><span class="normal"> png_pass_inc</span><span class="symbol">[</span><span class="normal">pass</span><span class="symbol">];</span><span class="normal"> j</span><span class="symbol">++)</span>
<span class="normal">                        </span><span class="cbracket">{</span>
<span class="normal">                           dp </span><span class="symbol">-=</span><span class="normal"> </span><span class="number">4</span><span class="symbol">;</span>
<span class="normal">                           </span><span class="function">png_memcpy</span><span class="symbol">(</span><span class="normal">dp</span><span class="symbol">,</span><span class="normal"> v</span><span class="symbol">,</span><span class="normal"> </span><span class="number">4</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="cbracket">}</span>
<span class="normal">                     </span><span class="cbracket">}</span>
<span class="normal">                  </span><span class="cbracket">}</span>
<span class="normal">                  </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(((</span><span class="normal">pass </span><span class="symbol">==</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pass </span><span class="symbol">==</span><span class="normal"> </span><span class="number">3</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> width</span><span class="symbol">)</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     </span><span class="type">int</span><span class="normal"> width_mmx </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">width </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">                     width </span><span class="symbol">-=</span><span class="normal"> width_mmx</span><span class="symbol">;</span><span class="normal">        </span><span class="comment">// 0,1 pixels =&gt; 0,4 bytes</span>
<span class="normal">                     </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width_mmx</span><span class="symbol">)</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="type">int</span><span class="normal"> dummy_value_c</span><span class="symbol">;</span><span class="normal">  </span><span class="comment">// fix 'forbidden register spilled'</span>
<span class="normal">                        </span><span class="type">int</span><span class="normal"> dummy_value_S</span><span class="symbol">;</span>
<span class="normal">                        </span><span class="type">int</span><span class="normal"> dummy_value_D</span><span class="symbol">;</span>

<span class="normal">                        </span><span class="usertype">__asm__</span><span class="normal"> </span><span class="function">__volatile__</span><span class="normal"> </span><span class="symbol">(</span>
<span class="normal">                           </span><span class="string">"subl $4, %%esi          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"subl $28, %%edi         </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">                        </span><span class="string">".loop4_pass2:              </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"movq (%%esi), %%mm0     </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// 7 6 5 4 3 2 1 0</span>
<span class="normal">                           </span><span class="string">"movq %%mm0, %%mm1       </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// 7 6 5 4 3 2 1 0</span>
<span class="normal">                           </span><span class="string">"punpckldq %%mm0, %%mm0  </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// 3 2 1 0 3 2 1 0</span>
<span class="normal">                           </span><span class="string">"punpckhdq %%mm1, %%mm1  </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// 7 6 5 4 7 6 5 4</span>
<span class="normal">                           </span><span class="string">"movq %%mm0, (%%edi)     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"movq %%mm0, 8(%%edi)    </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"movq %%mm1, 16(%%edi)   </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"movq %%mm1, 24(%%edi)   </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"subl $8, %%esi          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"subl $32, %%edi         </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"subl $2, %%ecx          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"jnz .loop4_pass2        </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"EMMS                    </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// DONE</span>

<span class="normal">                           </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"=c"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_c</span><span class="symbol">),</span><span class="normal">        </span><span class="comment">// output regs (dummy)</span>
<span class="normal">                             </span><span class="string">"=S"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_S</span><span class="symbol">),</span>
<span class="normal">                             </span><span class="string">"=D"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_D</span><span class="symbol">)</span>

<span class="normal">                           </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"1"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">sptr</span><span class="symbol">),</span><span class="normal">      </span><span class="comment">// esi      // input regs</span>
<span class="normal">                             </span><span class="string">"2"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dp</span><span class="symbol">),</span><span class="normal">        </span><span class="comment">// edi</span>
<span class="normal">                             </span><span class="string">"0"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width_mmx</span><span class="symbol">)</span><span class="normal">  </span><span class="comment">// ecx</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="number">0</span><span class="normal">  </span><span class="comment">/* %mm0, %mm1 not supported by gcc 2.7.2.3 or egcs 1.1 */</span>
<span class="normal">                           </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"%mm0"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm1"</span><span class="normal">               </span><span class="comment">// clobber list</span>
<span class="preproc">#endif</span>
<span class="normal">                        </span><span class="symbol">);</span>
<span class="normal">                     </span><span class="cbracket">}</span>

<span class="normal">                     sptr </span><span class="symbol">-=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width_mmx</span><span class="symbol">*</span><span class="number">4</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="number">4</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">// sign fixed</span>
<span class="normal">                     dp </span><span class="symbol">-=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width_mmx</span><span class="symbol">*</span><span class="number">16</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="number">4</span><span class="symbol">);</span><span class="normal">  </span><span class="comment">// sign fixed</span>
<span class="normal">                     </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">--)</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="usertype">png_byte</span><span class="normal"> v</span><span class="symbol">[</span><span class="number">8</span><span class="symbol">];</span>
<span class="normal">                        </span><span class="type">int</span><span class="normal"> j</span><span class="symbol">;</span>
<span class="normal">                        sptr </span><span class="symbol">-=</span><span class="normal"> </span><span class="number">4</span><span class="symbol">;</span>
<span class="normal">                        </span><span class="function">png_memcpy</span><span class="symbol">(</span><span class="normal">v</span><span class="symbol">,</span><span class="normal"> sptr</span><span class="symbol">,</span><span class="normal"> </span><span class="number">4</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">j </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> j </span><span class="symbol">&lt;</span><span class="normal"> png_pass_inc</span><span class="symbol">[</span><span class="normal">pass</span><span class="symbol">];</span><span class="normal"> j</span><span class="symbol">++)</span>
<span class="normal">                        </span><span class="cbracket">{</span>
<span class="normal">                           dp </span><span class="symbol">-=</span><span class="normal"> </span><span class="number">4</span><span class="symbol">;</span>
<span class="normal">                           </span><span class="function">png_memcpy</span><span class="symbol">(</span><span class="normal">dp</span><span class="symbol">,</span><span class="normal"> v</span><span class="symbol">,</span><span class="normal"> </span><span class="number">4</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="cbracket">}</span>
<span class="normal">                     </span><span class="cbracket">}</span>
<span class="normal">                  </span><span class="cbracket">}</span>
<span class="normal">                  </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width</span><span class="symbol">)</span><span class="normal">  </span><span class="comment">// pass == 4 or 5</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     </span><span class="type">int</span><span class="normal"> width_mmx </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">width </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">;</span>
<span class="normal">                     width </span><span class="symbol">-=</span><span class="normal"> width_mmx</span><span class="symbol">;</span><span class="normal">        </span><span class="comment">// 0,1 pixels =&gt; 0,4 bytes</span>
<span class="normal">                     </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width_mmx</span><span class="symbol">)</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="type">int</span><span class="normal"> dummy_value_c</span><span class="symbol">;</span><span class="normal">  </span><span class="comment">// fix 'forbidden register spilled'</span>
<span class="normal">                        </span><span class="type">int</span><span class="normal"> dummy_value_S</span><span class="symbol">;</span>
<span class="normal">                        </span><span class="type">int</span><span class="normal"> dummy_value_D</span><span class="symbol">;</span>

<span class="normal">                        </span><span class="usertype">__asm__</span><span class="normal"> </span><span class="function">__volatile__</span><span class="normal"> </span><span class="symbol">(</span>
<span class="normal">                           </span><span class="string">"subl $4, %%esi          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"subl $12, %%edi         </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">                        </span><span class="string">".loop4_pass4:              </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"movq (%%esi), %%mm0     </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// 7 6 5 4 3 2 1 0</span>
<span class="normal">                           </span><span class="string">"movq %%mm0, %%mm1       </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// 7 6 5 4 3 2 1 0</span>
<span class="normal">                           </span><span class="string">"punpckldq %%mm0, %%mm0  </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// 3 2 1 0 3 2 1 0</span>
<span class="normal">                           </span><span class="string">"punpckhdq %%mm1, %%mm1  </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// 7 6 5 4 7 6 5 4</span>
<span class="normal">                           </span><span class="string">"movq %%mm0, (%%edi)     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"subl $8, %%esi          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"movq %%mm1, 8(%%edi)    </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"subl $16, %%edi         </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"subl $2, %%ecx          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"jnz .loop4_pass4        </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"EMMS                    </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// DONE</span>

<span class="normal">                           </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"=c"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_c</span><span class="symbol">),</span><span class="normal">        </span><span class="comment">// output regs (dummy)</span>
<span class="normal">                             </span><span class="string">"=S"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_S</span><span class="symbol">),</span>
<span class="normal">                             </span><span class="string">"=D"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_D</span><span class="symbol">)</span>

<span class="normal">                           </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"1"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">sptr</span><span class="symbol">),</span><span class="normal">      </span><span class="comment">// esi      // input regs</span>
<span class="normal">                             </span><span class="string">"2"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dp</span><span class="symbol">),</span><span class="normal">        </span><span class="comment">// edi</span>
<span class="normal">                             </span><span class="string">"0"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width_mmx</span><span class="symbol">)</span><span class="normal">  </span><span class="comment">// ecx</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="number">0</span><span class="normal">  </span><span class="comment">/* %mm0, %mm1 not supported by gcc 2.7.2.3 or egcs 1.1 */</span>
<span class="normal">                           </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"%mm0"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm1"</span><span class="normal">               </span><span class="comment">// clobber list</span>
<span class="preproc">#endif</span>
<span class="normal">                        </span><span class="symbol">);</span>
<span class="normal">                     </span><span class="cbracket">}</span>

<span class="normal">                     sptr </span><span class="symbol">-=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width_mmx</span><span class="symbol">*</span><span class="number">4</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="number">4</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">// sign fixed</span>
<span class="normal">                     dp </span><span class="symbol">-=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width_mmx</span><span class="symbol">*</span><span class="number">8</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="number">4</span><span class="symbol">);</span><span class="normal">   </span><span class="comment">// sign fixed</span>
<span class="normal">                     </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">--)</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="usertype">png_byte</span><span class="normal"> v</span><span class="symbol">[</span><span class="number">8</span><span class="symbol">];</span>
<span class="normal">                        </span><span class="type">int</span><span class="normal"> j</span><span class="symbol">;</span>
<span class="normal">                        sptr </span><span class="symbol">-=</span><span class="normal"> </span><span class="number">4</span><span class="symbol">;</span>
<span class="normal">                        </span><span class="function">png_memcpy</span><span class="symbol">(</span><span class="normal">v</span><span class="symbol">,</span><span class="normal"> sptr</span><span class="symbol">,</span><span class="normal"> </span><span class="number">4</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">j </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> j </span><span class="symbol">&lt;</span><span class="normal"> png_pass_inc</span><span class="symbol">[</span><span class="normal">pass</span><span class="symbol">];</span><span class="normal"> j</span><span class="symbol">++)</span>
<span class="normal">                        </span><span class="cbracket">{</span>
<span class="normal">                           dp </span><span class="symbol">-=</span><span class="normal"> </span><span class="number">4</span><span class="symbol">;</span>
<span class="normal">                           </span><span class="function">png_memcpy</span><span class="symbol">(</span><span class="normal">dp</span><span class="symbol">,</span><span class="normal"> v</span><span class="symbol">,</span><span class="normal"> </span><span class="number">4</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="cbracket">}</span>
<span class="normal">                     </span><span class="cbracket">}</span>
<span class="normal">                  </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="cbracket">}</span><span class="normal"> </span><span class="comment">/* end of pixel_bytes == 4 */</span>

<span class="normal">               </span><span class="comment">//--------------------------------------------------------------</span>
<span class="normal">               </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pixel_bytes </span><span class="symbol">==</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="comment">// GRR TEST:  should work, but needs testing (special 64-bit version of rpng2?)</span>
<span class="normal">                  </span><span class="comment">// GRR NOTE:  no need to combine passes here!</span>
<span class="normal">                  </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(((</span><span class="normal">pass </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pass </span><span class="symbol">==</span><span class="normal"> </span><span class="number">1</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> width</span><span class="symbol">)</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     </span><span class="type">int</span><span class="normal"> dummy_value_c</span><span class="symbol">;</span><span class="normal">  </span><span class="comment">// fix 'forbidden register spilled'</span>
<span class="normal">                     </span><span class="type">int</span><span class="normal"> dummy_value_S</span><span class="symbol">;</span>
<span class="normal">                     </span><span class="type">int</span><span class="normal"> dummy_value_D</span><span class="symbol">;</span>

<span class="normal">                     </span><span class="comment">// source is 8-byte RRGGBBAA</span>
<span class="normal">                     </span><span class="comment">// dest is 64-byte RRGGBBAA RRGGBBAA RRGGBBAA RRGGBBAA ...</span>
<span class="normal">                     </span><span class="usertype">__asm__</span><span class="normal"> </span><span class="function">__volatile__</span><span class="normal"> </span><span class="symbol">(</span>
<span class="normal">                        </span><span class="string">"subl $56, %%edi         </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// start of last block</span>

<span class="normal">                     </span><span class="string">".loop8_pass0:              </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                        </span><span class="string">"movq (%%esi), %%mm0     </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// 7 6 5 4 3 2 1 0</span>
<span class="normal">                        </span><span class="string">"movq %%mm0, (%%edi)     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                        </span><span class="string">"movq %%mm0, 8(%%edi)    </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                        </span><span class="string">"movq %%mm0, 16(%%edi)   </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                        </span><span class="string">"movq %%mm0, 24(%%edi)   </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                        </span><span class="string">"movq %%mm0, 32(%%edi)   </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                        </span><span class="string">"movq %%mm0, 40(%%edi)   </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                        </span><span class="string">"movq %%mm0, 48(%%edi)   </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                        </span><span class="string">"subl $8, %%esi          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                        </span><span class="string">"movq %%mm0, 56(%%edi)   </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                        </span><span class="string">"subl $64, %%edi         </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                        </span><span class="string">"decl %%ecx              </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                        </span><span class="string">"jnz .loop8_pass0        </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                        </span><span class="string">"EMMS                    </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// DONE</span>

<span class="normal">                        </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"=c"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_c</span><span class="symbol">),</span><span class="normal">        </span><span class="comment">// output regs (dummy)</span>
<span class="normal">                          </span><span class="string">"=S"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_S</span><span class="symbol">),</span>
<span class="normal">                          </span><span class="string">"=D"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_D</span><span class="symbol">)</span>

<span class="normal">                        </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"1"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">sptr</span><span class="symbol">),</span><span class="normal">      </span><span class="comment">// esi      // input regs</span>
<span class="normal">                          </span><span class="string">"2"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dp</span><span class="symbol">),</span><span class="normal">        </span><span class="comment">// edi</span>
<span class="normal">                          </span><span class="string">"0"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width</span><span class="symbol">)</span><span class="normal">      </span><span class="comment">// ecx</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="number">0</span><span class="normal">  </span><span class="comment">/* %mm0 not supported by gcc 2.7.2.3 or egcs 1.1 */</span>
<span class="normal">                        </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"%mm0"</span><span class="normal">                       </span><span class="comment">// clobber list</span>
<span class="preproc">#endif</span>
<span class="normal">                     </span><span class="symbol">);</span>
<span class="normal">                  </span><span class="cbracket">}</span>
<span class="normal">                  </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(((</span><span class="normal">pass </span><span class="symbol">==</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pass </span><span class="symbol">==</span><span class="normal"> </span><span class="number">3</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> width</span><span class="symbol">)</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     </span><span class="comment">// source is 8-byte RRGGBBAA</span>
<span class="normal">                     </span><span class="comment">// dest is 32-byte RRGGBBAA RRGGBBAA RRGGBBAA RRGGBBAA</span>
<span class="normal">                     </span><span class="comment">// (recall that expansion is _in place_:  sptr and dp</span>
<span class="normal">                     </span><span class="comment">//  both point at locations within same row buffer)</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="type">int</span><span class="normal"> dummy_value_c</span><span class="symbol">;</span><span class="normal">  </span><span class="comment">// fix 'forbidden register spilled'</span>
<span class="normal">                        </span><span class="type">int</span><span class="normal"> dummy_value_S</span><span class="symbol">;</span>
<span class="normal">                        </span><span class="type">int</span><span class="normal"> dummy_value_D</span><span class="symbol">;</span>

<span class="normal">                        </span><span class="usertype">__asm__</span><span class="normal"> </span><span class="function">__volatile__</span><span class="normal"> </span><span class="symbol">(</span>
<span class="normal">                           </span><span class="string">"subl $24, %%edi         </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// start of last block</span>

<span class="normal">                        </span><span class="string">".loop8_pass2:              </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"movq (%%esi), %%mm0     </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// 7 6 5 4 3 2 1 0</span>
<span class="normal">                           </span><span class="string">"movq %%mm0, (%%edi)     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"movq %%mm0, 8(%%edi)    </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"movq %%mm0, 16(%%edi)   </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"subl $8, %%esi          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"movq %%mm0, 24(%%edi)   </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"subl $32, %%edi         </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"decl %%ecx              </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"jnz .loop8_pass2        </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"EMMS                    </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// DONE</span>

<span class="normal">                           </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"=c"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_c</span><span class="symbol">),</span><span class="normal">        </span><span class="comment">// output regs (dummy)</span>
<span class="normal">                             </span><span class="string">"=S"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_S</span><span class="symbol">),</span>
<span class="normal">                             </span><span class="string">"=D"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_D</span><span class="symbol">)</span>

<span class="normal">                           </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"1"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">sptr</span><span class="symbol">),</span><span class="normal">      </span><span class="comment">// esi      // input regs</span>
<span class="normal">                             </span><span class="string">"2"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dp</span><span class="symbol">),</span><span class="normal">        </span><span class="comment">// edi</span>
<span class="normal">                             </span><span class="string">"0"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width</span><span class="symbol">)</span><span class="normal">      </span><span class="comment">// ecx</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="number">0</span><span class="normal">  </span><span class="comment">/* %mm0 not supported by gcc 2.7.2.3 or egcs 1.1 */</span>
<span class="normal">                           </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"%mm0"</span><span class="normal">                       </span><span class="comment">// clobber list</span>
<span class="preproc">#endif</span>
<span class="normal">                        </span><span class="symbol">);</span>
<span class="normal">                     </span><span class="cbracket">}</span>
<span class="normal">                  </span><span class="cbracket">}</span>
<span class="normal">                  </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width</span><span class="symbol">)</span><span class="normal">  </span><span class="comment">// pass == 4 or 5</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     </span><span class="comment">// source is 8-byte RRGGBBAA</span>
<span class="normal">                     </span><span class="comment">// dest is 16-byte RRGGBBAA RRGGBBAA</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="type">int</span><span class="normal"> dummy_value_c</span><span class="symbol">;</span><span class="normal">  </span><span class="comment">// fix 'forbidden register spilled'</span>
<span class="normal">                        </span><span class="type">int</span><span class="normal"> dummy_value_S</span><span class="symbol">;</span>
<span class="normal">                        </span><span class="type">int</span><span class="normal"> dummy_value_D</span><span class="symbol">;</span>

<span class="normal">                        </span><span class="usertype">__asm__</span><span class="normal"> </span><span class="function">__volatile__</span><span class="normal"> </span><span class="symbol">(</span>
<span class="normal">                           </span><span class="string">"subl $8, %%edi          </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// start of last block</span>

<span class="normal">                        </span><span class="string">".loop8_pass4:              </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"movq (%%esi), %%mm0     </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// 7 6 5 4 3 2 1 0</span>
<span class="normal">                           </span><span class="string">"movq %%mm0, (%%edi)     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"subl $8, %%esi          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"movq %%mm0, 8(%%edi)    </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"subl $16, %%edi         </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"decl %%ecx              </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"jnz .loop8_pass4        </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">                           </span><span class="string">"EMMS                    </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// DONE</span>

<span class="normal">                           </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"=c"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_c</span><span class="symbol">),</span><span class="normal">        </span><span class="comment">// output regs (dummy)</span>
<span class="normal">                             </span><span class="string">"=S"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_S</span><span class="symbol">),</span>
<span class="normal">                             </span><span class="string">"=D"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_D</span><span class="symbol">)</span>

<span class="normal">                           </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"1"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">sptr</span><span class="symbol">),</span><span class="normal">      </span><span class="comment">// esi      // input regs</span>
<span class="normal">                             </span><span class="string">"2"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dp</span><span class="symbol">),</span><span class="normal">        </span><span class="comment">// edi</span>
<span class="normal">                             </span><span class="string">"0"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width</span><span class="symbol">)</span><span class="normal">      </span><span class="comment">// ecx</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="number">0</span><span class="normal">  </span><span class="comment">/* %mm0 not supported by gcc 2.7.2.3 or egcs 1.1 */</span>
<span class="normal">                           </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"%mm0"</span><span class="normal">                       </span><span class="comment">// clobber list</span>
<span class="preproc">#endif</span>
<span class="normal">                        </span><span class="symbol">);</span>
<span class="normal">                     </span><span class="cbracket">}</span>
<span class="normal">                  </span><span class="cbracket">}</span>

<span class="normal">               </span><span class="cbracket">}</span><span class="normal"> </span><span class="comment">/* end of pixel_bytes == 8 */</span>

<span class="normal">               </span><span class="comment">//--------------------------------------------------------------</span>
<span class="normal">               </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pixel_bytes </span><span class="symbol">==</span><span class="normal"> </span><span class="number">6</span><span class="symbol">)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">--)</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     </span><span class="usertype">png_byte</span><span class="normal"> v</span><span class="symbol">[</span><span class="number">8</span><span class="symbol">];</span>
<span class="normal">                     </span><span class="type">int</span><span class="normal"> j</span><span class="symbol">;</span>
<span class="normal">                     </span><span class="function">png_memcpy</span><span class="symbol">(</span><span class="normal">v</span><span class="symbol">,</span><span class="normal"> sptr</span><span class="symbol">,</span><span class="normal"> </span><span class="number">6</span><span class="symbol">);</span>
<span class="normal">                     </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">j </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> j </span><span class="symbol">&lt;</span><span class="normal"> png_pass_inc</span><span class="symbol">[</span><span class="normal">pass</span><span class="symbol">];</span><span class="normal"> j</span><span class="symbol">++)</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="function">png_memcpy</span><span class="symbol">(</span><span class="normal">dp</span><span class="symbol">,</span><span class="normal"> v</span><span class="symbol">,</span><span class="normal"> </span><span class="number">6</span><span class="symbol">);</span>
<span class="normal">                        dp </span><span class="symbol">-=</span><span class="normal"> </span><span class="number">6</span><span class="symbol">;</span>
<span class="normal">                     </span><span class="cbracket">}</span>
<span class="normal">                     sptr </span><span class="symbol">-=</span><span class="normal"> </span><span class="number">6</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="cbracket">}</span><span class="normal"> </span><span class="comment">/* end of pixel_bytes == 6 */</span>

<span class="normal">               </span><span class="comment">//--------------------------------------------------------------</span>
<span class="normal">               </span><span class="keyword">else</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">--)</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     </span><span class="usertype">png_byte</span><span class="normal"> v</span><span class="symbol">[</span><span class="number">8</span><span class="symbol">];</span>
<span class="normal">                     </span><span class="type">int</span><span class="normal"> j</span><span class="symbol">;</span>
<span class="normal">                     </span><span class="function">png_memcpy</span><span class="symbol">(</span><span class="normal">v</span><span class="symbol">,</span><span class="normal"> sptr</span><span class="symbol">,</span><span class="normal"> pixel_bytes</span><span class="symbol">);</span>
<span class="normal">                     </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">j </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> j </span><span class="symbol">&lt;</span><span class="normal"> png_pass_inc</span><span class="symbol">[</span><span class="normal">pass</span><span class="symbol">];</span><span class="normal"> j</span><span class="symbol">++)</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="function">png_memcpy</span><span class="symbol">(</span><span class="normal">dp</span><span class="symbol">,</span><span class="normal"> v</span><span class="symbol">,</span><span class="normal"> pixel_bytes</span><span class="symbol">);</span>
<span class="normal">                        dp </span><span class="symbol">-=</span><span class="normal"> pixel_bytes</span><span class="symbol">;</span>
<span class="normal">                     </span><span class="cbracket">}</span>
<span class="normal">                     sptr</span><span class="symbol">-=</span><span class="normal"> pixel_bytes</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="cbracket">}</span><span class="normal"> </span><span class="comment">// end of _mmx_supported ========================================</span>

<span class="normal">            </span><span class="keyword">else</span><span class="normal"> </span><span class="comment">/* MMX not supported:  use modified C code - takes advantage</span>
<span class="comment">                  *   of inlining of png_memcpy for a constant */</span>
<span class="normal">                 </span><span class="comment">/* GRR 19991007:  does it?  or should pixel_bytes in each</span>
<span class="comment">                  *   block be replaced with immediate value (e.g., 1)? */</span>
<span class="normal">                 </span><span class="comment">/* GRR 19991017:  replaced with constants in each case */</span>
<span class="preproc">#endif</span><span class="normal"> </span><span class="comment">/* PNG_ASSEMBLER_CODE_SUPPORTED */</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pixel_bytes </span><span class="symbol">==</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">--)</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     </span><span class="type">int</span><span class="normal"> j</span><span class="symbol">;</span>
<span class="normal">                     </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">j </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> j </span><span class="symbol">&lt;</span><span class="normal"> png_pass_inc</span><span class="symbol">[</span><span class="normal">pass</span><span class="symbol">];</span><span class="normal"> j</span><span class="symbol">++)</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="symbol">*</span><span class="normal">dp</span><span class="symbol">--</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">sptr</span><span class="symbol">;</span>
<span class="normal">                     </span><span class="cbracket">}</span>
<span class="normal">                     </span><span class="symbol">--</span><span class="normal">sptr</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pixel_bytes </span><span class="symbol">==</span><span class="normal"> </span><span class="number">3</span><span class="symbol">)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">--)</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     </span><span class="usertype">png_byte</span><span class="normal"> v</span><span class="symbol">[</span><span class="number">8</span><span class="symbol">];</span>
<span class="normal">                     </span><span class="type">int</span><span class="normal"> j</span><span class="symbol">;</span>
<span class="normal">                     </span><span class="function">png_memcpy</span><span class="symbol">(</span><span class="normal">v</span><span class="symbol">,</span><span class="normal"> sptr</span><span class="symbol">,</span><span class="normal"> </span><span class="number">3</span><span class="symbol">);</span>
<span class="normal">                     </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">j </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> j </span><span class="symbol">&lt;</span><span class="normal"> png_pass_inc</span><span class="symbol">[</span><span class="normal">pass</span><span class="symbol">];</span><span class="normal"> j</span><span class="symbol">++)</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="function">png_memcpy</span><span class="symbol">(</span><span class="normal">dp</span><span class="symbol">,</span><span class="normal"> v</span><span class="symbol">,</span><span class="normal"> </span><span class="number">3</span><span class="symbol">);</span>
<span class="normal">                        dp </span><span class="symbol">-=</span><span class="normal"> </span><span class="number">3</span><span class="symbol">;</span>
<span class="normal">                     </span><span class="cbracket">}</span>
<span class="normal">                     sptr </span><span class="symbol">-=</span><span class="normal"> </span><span class="number">3</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pixel_bytes </span><span class="symbol">==</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">--)</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     </span><span class="usertype">png_byte</span><span class="normal"> v</span><span class="symbol">[</span><span class="number">8</span><span class="symbol">];</span>
<span class="normal">                     </span><span class="type">int</span><span class="normal"> j</span><span class="symbol">;</span>
<span class="normal">                     </span><span class="function">png_memcpy</span><span class="symbol">(</span><span class="normal">v</span><span class="symbol">,</span><span class="normal"> sptr</span><span class="symbol">,</span><span class="normal"> </span><span class="number">2</span><span class="symbol">);</span>
<span class="normal">                     </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">j </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> j </span><span class="symbol">&lt;</span><span class="normal"> png_pass_inc</span><span class="symbol">[</span><span class="normal">pass</span><span class="symbol">];</span><span class="normal"> j</span><span class="symbol">++)</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="function">png_memcpy</span><span class="symbol">(</span><span class="normal">dp</span><span class="symbol">,</span><span class="normal"> v</span><span class="symbol">,</span><span class="normal"> </span><span class="number">2</span><span class="symbol">);</span>
<span class="normal">                        dp </span><span class="symbol">-=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">                     </span><span class="cbracket">}</span>
<span class="normal">                     sptr </span><span class="symbol">-=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pixel_bytes </span><span class="symbol">==</span><span class="normal"> </span><span class="number">4</span><span class="symbol">)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">--)</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     </span><span class="usertype">png_byte</span><span class="normal"> v</span><span class="symbol">[</span><span class="number">8</span><span class="symbol">];</span>
<span class="normal">                     </span><span class="type">int</span><span class="normal"> j</span><span class="symbol">;</span>
<span class="normal">                     </span><span class="function">png_memcpy</span><span class="symbol">(</span><span class="normal">v</span><span class="symbol">,</span><span class="normal"> sptr</span><span class="symbol">,</span><span class="normal"> </span><span class="number">4</span><span class="symbol">);</span>
<span class="normal">                     </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">j </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> j </span><span class="symbol">&lt;</span><span class="normal"> png_pass_inc</span><span class="symbol">[</span><span class="normal">pass</span><span class="symbol">];</span><span class="normal"> j</span><span class="symbol">++)</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="preproc">#ifdef</span><span class="normal"> PNG_DEBUG</span>
<span class="normal">                        </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dp </span><span class="symbol">&lt;</span><span class="normal"> row </span><span class="symbol">||</span><span class="normal"> dp</span><span class="symbol">+</span><span class="number">3</span><span class="normal"> </span><span class="symbol">&gt;</span><span class="normal"> row</span><span class="symbol">+</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_buf_size</span><span class="symbol">)</span>
<span class="normal">                        </span><span class="cbracket">{</span>
<span class="normal">                           </span><span class="function">printf</span><span class="symbol">(</span><span class="string">"dp out of bounds: row=%d, dp=%d, rp=%d</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">                             row</span><span class="symbol">,</span><span class="normal"> dp</span><span class="symbol">,</span><span class="normal"> row</span><span class="symbol">+</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_buf_size</span><span class="symbol">);</span>
<span class="normal">                           </span><span class="function">printf</span><span class="symbol">(</span><span class="string">"row_buf=%d</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_buf_size</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="cbracket">}</span>
<span class="preproc">#endif</span>
<span class="normal">                        </span><span class="function">png_memcpy</span><span class="symbol">(</span><span class="normal">dp</span><span class="symbol">,</span><span class="normal"> v</span><span class="symbol">,</span><span class="normal"> </span><span class="number">4</span><span class="symbol">);</span>
<span class="normal">                        dp </span><span class="symbol">-=</span><span class="normal"> </span><span class="number">4</span><span class="symbol">;</span>
<span class="normal">                     </span><span class="cbracket">}</span>
<span class="normal">                     sptr </span><span class="symbol">-=</span><span class="normal"> </span><span class="number">4</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pixel_bytes </span><span class="symbol">==</span><span class="normal"> </span><span class="number">6</span><span class="symbol">)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">--)</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     </span><span class="usertype">png_byte</span><span class="normal"> v</span><span class="symbol">[</span><span class="number">8</span><span class="symbol">];</span>
<span class="normal">                     </span><span class="type">int</span><span class="normal"> j</span><span class="symbol">;</span>
<span class="normal">                     </span><span class="function">png_memcpy</span><span class="symbol">(</span><span class="normal">v</span><span class="symbol">,</span><span class="normal"> sptr</span><span class="symbol">,</span><span class="normal"> </span><span class="number">6</span><span class="symbol">);</span>
<span class="normal">                     </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">j </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> j </span><span class="symbol">&lt;</span><span class="normal"> png_pass_inc</span><span class="symbol">[</span><span class="normal">pass</span><span class="symbol">];</span><span class="normal"> j</span><span class="symbol">++)</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="function">png_memcpy</span><span class="symbol">(</span><span class="normal">dp</span><span class="symbol">,</span><span class="normal"> v</span><span class="symbol">,</span><span class="normal"> </span><span class="number">6</span><span class="symbol">);</span>
<span class="normal">                        dp </span><span class="symbol">-=</span><span class="normal"> </span><span class="number">6</span><span class="symbol">;</span>
<span class="normal">                     </span><span class="cbracket">}</span>
<span class="normal">                     sptr </span><span class="symbol">-=</span><span class="normal"> </span><span class="number">6</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pixel_bytes </span><span class="symbol">==</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">--)</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     </span><span class="usertype">png_byte</span><span class="normal"> v</span><span class="symbol">[</span><span class="number">8</span><span class="symbol">];</span>
<span class="normal">                     </span><span class="type">int</span><span class="normal"> j</span><span class="symbol">;</span>
<span class="normal">                     </span><span class="function">png_memcpy</span><span class="symbol">(</span><span class="normal">v</span><span class="symbol">,</span><span class="normal"> sptr</span><span class="symbol">,</span><span class="normal"> </span><span class="number">8</span><span class="symbol">);</span>
<span class="normal">                     </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">j </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> j </span><span class="symbol">&lt;</span><span class="normal"> png_pass_inc</span><span class="symbol">[</span><span class="normal">pass</span><span class="symbol">];</span><span class="normal"> j</span><span class="symbol">++)</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="function">png_memcpy</span><span class="symbol">(</span><span class="normal">dp</span><span class="symbol">,</span><span class="normal"> v</span><span class="symbol">,</span><span class="normal"> </span><span class="number">8</span><span class="symbol">);</span>
<span class="normal">                        dp </span><span class="symbol">-=</span><span class="normal"> </span><span class="number">8</span><span class="symbol">;</span>
<span class="normal">                     </span><span class="cbracket">}</span>
<span class="normal">                     sptr </span><span class="symbol">-=</span><span class="normal"> </span><span class="number">8</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="keyword">else</span><span class="normal">     </span><span class="comment">/* GRR:  should never be reached */</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">--)</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     </span><span class="usertype">png_byte</span><span class="normal"> v</span><span class="symbol">[</span><span class="number">8</span><span class="symbol">];</span>
<span class="normal">                     </span><span class="type">int</span><span class="normal"> j</span><span class="symbol">;</span>
<span class="normal">                     </span><span class="function">png_memcpy</span><span class="symbol">(</span><span class="normal">v</span><span class="symbol">,</span><span class="normal"> sptr</span><span class="symbol">,</span><span class="normal"> pixel_bytes</span><span class="symbol">);</span>
<span class="normal">                     </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">j </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> j </span><span class="symbol">&lt;</span><span class="normal"> png_pass_inc</span><span class="symbol">[</span><span class="normal">pass</span><span class="symbol">];</span><span class="normal"> j</span><span class="symbol">++)</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="function">png_memcpy</span><span class="symbol">(</span><span class="normal">dp</span><span class="symbol">,</span><span class="normal"> v</span><span class="symbol">,</span><span class="normal"> pixel_bytes</span><span class="symbol">);</span>
<span class="normal">                        dp </span><span class="symbol">-=</span><span class="normal"> pixel_bytes</span><span class="symbol">;</span>
<span class="normal">                     </span><span class="cbracket">}</span>
<span class="normal">                     sptr </span><span class="symbol">-=</span><span class="normal"> pixel_bytes</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="cbracket">}</span>

<span class="normal">            </span><span class="cbracket">}</span><span class="normal"> </span><span class="comment">/* end if (MMX not supported) */</span>
<span class="normal">            </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="cbracket">}</span><span class="normal"> </span><span class="comment">/* end switch (row_info-&gt;pixel_depth) */</span>

<span class="normal">      row_info</span><span class="symbol">-&gt;</span><span class="normal">width </span><span class="symbol">=</span><span class="normal"> final_width</span><span class="symbol">;</span>

<span class="normal">      row_info</span><span class="symbol">-&gt;</span><span class="normal">rowbytes </span><span class="symbol">=</span><span class="normal"> </span><span class="function">PNG_ROWBYTES</span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">pixel_depth</span><span class="symbol">,</span><span class="normal">final_width</span><span class="symbol">);</span>
<span class="normal">   </span><span class="cbracket">}</span>

<span class="cbracket">}</span><span class="normal"> </span><span class="comment">/* end png_do_read_interlace() */</span>

<span class="preproc">#endif</span><span class="normal"> </span><span class="comment">/* PNG_HAVE_ASSEMBLER_READ_INTERLACE */</span>
<span class="preproc">#endif</span><span class="normal"> </span><span class="comment">/* PNG_READ_INTERLACING_SUPPORTED */</span>



<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_HAVE_ASSEMBLER_READ_FILTER_ROW</span><span class="symbol">)</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_ASSEMBLER_CODE_SUPPORTED</span><span class="symbol">)</span>

<span class="comment">// These variables are utilized in the functions below.  They are declared</span>
<span class="comment">// globally here to ensure alignment on 8-byte boundaries.</span>

<span class="keyword">union</span><span class="normal"> uAll </span><span class="cbracket">{</span>
<span class="normal">   </span><span class="type">long</span><span class="normal"> </span><span class="type">long</span><span class="normal"> use</span><span class="symbol">;</span>
<span class="normal">   </span><span class="type">double</span><span class="normal">  align</span><span class="symbol">;</span>
<span class="cbracket">}</span><span class="normal"> _LBCarryMask </span><span class="symbol">=</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal">0x0101010101010101LL</span><span class="cbracket">}</span><span class="symbol">,</span>
<span class="normal">  _HBClearMask </span><span class="symbol">=</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal">0x7f7f7f7f7f7f7f7fLL</span><span class="cbracket">}</span><span class="symbol">,</span>
<span class="normal">  _ActiveMask</span><span class="symbol">,</span><span class="normal"> _ActiveMask2</span><span class="symbol">,</span><span class="normal"> _ActiveMaskEnd</span><span class="symbol">,</span><span class="normal"> _ShiftBpp</span><span class="symbol">,</span><span class="normal"> _ShiftRem</span><span class="symbol">;</span>

<span class="preproc">#ifdef</span><span class="normal"> PNG_THREAD_UNSAFE_OK</span>
<span class="comment">//===========================================================================//</span>
<span class="comment">//                                                                           //</span>
<span class="comment">//           P N G _ R E A D _ F I L T E R _ R O W _ M M X _ A V G           //</span>
<span class="comment">//                                                                           //</span>
<span class="comment">//===========================================================================//</span>

<span class="comment">// Optimized code for PNG Average filter decoder</span>

<span class="keyword">static</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="comment">/* PRIVATE */</span>
<span class="function">png_read_filter_row_mmx_avg</span><span class="symbol">(</span><span class="usertype">png_row_infop</span><span class="normal"> row_info</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">png_bytep</span><span class="normal"> row</span><span class="symbol">,</span>
<span class="normal">                            </span><span class="usertype">png_bytep</span><span class="normal"> prev_row</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">   </span><span class="type">int</span><span class="normal"> bpp</span><span class="symbol">;</span>
<span class="normal">   </span><span class="type">int</span><span class="normal"> dummy_value_c</span><span class="symbol">;</span><span class="normal">   </span><span class="comment">// fix 'forbidden register 2 (cx) was spilled' error</span>
<span class="normal">   </span><span class="type">int</span><span class="normal"> dummy_value_S</span><span class="symbol">;</span>
<span class="normal">   </span><span class="type">int</span><span class="normal"> dummy_value_D</span><span class="symbol">;</span>

<span class="normal">   bpp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">pixel_depth </span><span class="symbol">+</span><span class="normal"> </span><span class="number">7</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">3</span><span class="symbol">;</span><span class="normal">  </span><span class="comment">// get # bytes per pixel</span>
<span class="normal">   _FullLength  </span><span class="symbol">=</span><span class="normal"> row_info</span><span class="symbol">-&gt;</span><span class="normal">rowbytes</span><span class="symbol">;</span><span class="normal">       </span><span class="comment">// # of bytes to filter</span>

<span class="normal">   </span><span class="usertype">__asm__</span><span class="normal"> </span><span class="function">__volatile__</span><span class="normal"> </span><span class="symbol">(</span>
<span class="normal">      </span><span class="comment">// initialize address pointers and offset</span>
<span class="preproc">#ifdef</span><span class="normal"> __PIC__</span>
<span class="normal">      </span><span class="string">"pushl %%ebx                 </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// save index to Global Offset Table</span>
<span class="preproc">#endif</span>
<span class="comment">//pre "movl row, %%edi             \n\t" // edi:  Avg(x)</span>
<span class="normal">      </span><span class="string">"xorl %%ebx, %%ebx           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// ebx:  x</span>
<span class="normal">      </span><span class="string">"movl %%edi, %%edx           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="comment">//pre "movl prev_row, %%esi        \n\t" // esi:  Prior(x)</span>
<span class="comment">//pre "subl bpp, %%edx             \n\t" // (bpp is preloaded into ecx)</span>
<span class="normal">      </span><span class="string">"subl %%ecx, %%edx           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// edx:  Raw(x-bpp)</span>

<span class="normal">      </span><span class="string">"xorl %%eax,%%eax            </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">      </span><span class="comment">// Compute the Raw value for the first bpp bytes</span>
<span class="normal">      </span><span class="comment">//    Raw(x) = Avg(x) + (Prior(x)/2)</span>
<span class="normal">   </span><span class="string">"avg_rlp:                       </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"movb (%%esi,%%ebx,),%%al    </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// load al with Prior(x)</span>
<span class="normal">      </span><span class="string">"incl %%ebx                  </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"shrb %%al                   </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// divide by 2</span>
<span class="normal">      </span><span class="string">"addb -1(%%edi,%%ebx,),%%al  </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// add Avg(x); -1 to offset inc ebx</span>
<span class="comment">//pre "cmpl bpp, %%ebx             \n\t" // (bpp is preloaded into ecx)</span>
<span class="normal">      </span><span class="string">"cmpl %%ecx, %%ebx           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"movb %%al,-1(%%edi,%%ebx,)  </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// write Raw(x); -1 to offset inc ebx</span>
<span class="normal">      </span><span class="string">"jb avg_rlp                  </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// mov does not affect flags</span>

<span class="normal">      </span><span class="comment">// get # of bytes to alignment</span>
<span class="normal">      </span><span class="string">"movl %%edi, _dif            </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// take start of row</span>
<span class="normal">      </span><span class="string">"addl %%ebx, _dif            </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// add bpp</span>
<span class="normal">      </span><span class="string">"addl $0xf, _dif             </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// add 7+8 to incr past alignment bdry</span>
<span class="normal">      </span><span class="string">"andl $0xfffffff8, _dif      </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// mask to alignment boundary</span>
<span class="normal">      </span><span class="string">"subl %%edi, _dif            </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// subtract from start =&gt; value ebx at</span>
<span class="normal">      </span><span class="string">"jz avg_go                   </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">//  alignment</span>

<span class="normal">      </span><span class="comment">// fix alignment</span>
<span class="normal">      </span><span class="comment">// Compute the Raw value for the bytes up to the alignment boundary</span>
<span class="normal">      </span><span class="comment">//    Raw(x) = Avg(x) + ((Raw(x-bpp) + Prior(x))/2)</span>
<span class="normal">      </span><span class="string">"xorl %%ecx, %%ecx           </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">   </span><span class="string">"avg_lp1:                       </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"xorl %%eax, %%eax           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"movb (%%esi,%%ebx,), %%cl   </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// load cl with Prior(x)</span>
<span class="normal">      </span><span class="string">"movb (%%edx,%%ebx,), %%al   </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// load al with Raw(x-bpp)</span>
<span class="normal">      </span><span class="string">"addw %%cx, %%ax             </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"incl %%ebx                  </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"shrw %%ax                   </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// divide by 2</span>
<span class="normal">      </span><span class="string">"addb -1(%%edi,%%ebx,), %%al </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// add Avg(x); -1 to offset inc ebx</span>
<span class="normal">      </span><span class="string">"cmpl _dif, %%ebx            </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// check if at alignment boundary</span>
<span class="normal">      </span><span class="string">"movb %%al, -1(%%edi,%%ebx,) </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// write Raw(x); -1 to offset inc ebx</span>
<span class="normal">      </span><span class="string">"jb avg_lp1                  </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// repeat until at alignment boundary</span>

<span class="normal">   </span><span class="string">"avg_go:                        </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"movl _FullLength, %%eax     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"movl %%eax, %%ecx           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"subl %%ebx, %%eax           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// subtract alignment fix</span>
<span class="normal">      </span><span class="string">"andl $0x00000007, %%eax     </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// calc bytes over mult of 8</span>
<span class="normal">      </span><span class="string">"subl %%eax, %%ecx           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// drop over bytes from original length</span>
<span class="normal">      </span><span class="string">"movl %%ecx, _MMXLength      </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="preproc">#ifdef</span><span class="normal"> __PIC__</span>
<span class="normal">      </span><span class="string">"popl %%ebx                  </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// restore index to Global Offset Table</span>
<span class="preproc">#endif</span>

<span class="normal">      </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"=c"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_c</span><span class="symbol">),</span><span class="normal">            </span><span class="comment">// output regs (dummy)</span>
<span class="normal">        </span><span class="string">"=S"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_S</span><span class="symbol">),</span>
<span class="normal">        </span><span class="string">"=D"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_D</span><span class="symbol">)</span>

<span class="normal">      </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"0"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">bpp</span><span class="symbol">),</span><span class="normal">       </span><span class="comment">// ecx          // input regs</span>
<span class="normal">        </span><span class="string">"1"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">prev_row</span><span class="symbol">),</span><span class="normal">  </span><span class="comment">// esi</span>
<span class="normal">        </span><span class="string">"2"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row</span><span class="symbol">)</span><span class="normal">        </span><span class="comment">// edi</span>

<span class="normal">      </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"%eax"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%edx"</span><span class="normal">                   </span><span class="comment">// clobber list</span>
<span class="preproc">#ifndef</span><span class="normal"> __PIC__</span>
<span class="normal">      </span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%ebx"</span>
<span class="preproc">#endif</span>
<span class="normal">      </span><span class="comment">// GRR: INCLUDE "memory" as clobbered? (_dif, _MMXLength)</span>
<span class="normal">      </span><span class="comment">// (seems to work fine without...)</span>
<span class="normal">   </span><span class="symbol">);</span>

<span class="normal">   </span><span class="comment">// now do the math for the rest of the row</span>
<span class="normal">   </span><span class="keyword">switch</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">bpp</span><span class="symbol">)</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="keyword">case</span><span class="normal"> </span><span class="number">3</span><span class="symbol">:</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         _ActiveMask</span><span class="symbol">.</span><span class="normal">use  </span><span class="symbol">=</span><span class="normal"> 0x0000000000ffffffLL</span><span class="symbol">;</span>
<span class="normal">         _ShiftBpp</span><span class="symbol">.</span><span class="normal">use </span><span class="symbol">=</span><span class="normal"> </span><span class="number">24</span><span class="symbol">;</span><span class="normal">    </span><span class="comment">// == 3 * 8</span>
<span class="normal">         _ShiftRem</span><span class="symbol">.</span><span class="normal">use </span><span class="symbol">=</span><span class="normal"> </span><span class="number">40</span><span class="symbol">;</span><span class="normal">    </span><span class="comment">// == 64 - 24</span>

<span class="normal">         </span><span class="usertype">__asm__</span><span class="normal"> </span><span class="function">__volatile__</span><span class="normal"> </span><span class="symbol">(</span>
<span class="normal">            </span><span class="comment">// re-init address pointers and offset</span>
<span class="normal">            </span><span class="string">"movq _ActiveMask, %%mm7      </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"movl _dif, %%ecx             </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// ecx:  x = offset to</span>
<span class="normal">            </span><span class="string">"movq _LBCarryMask, %%mm5     </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">//  alignment boundary</span>
<span class="comment">// preload  "movl row, %%edi              \n\t" // edi:  Avg(x)</span>
<span class="normal">            </span><span class="string">"movq _HBClearMask, %%mm4     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="comment">// preload  "movl prev_row, %%esi         \n\t" // esi:  Prior(x)</span>

<span class="normal">            </span><span class="comment">// prime the pump:  load the first Raw(x-bpp) data set</span>
<span class="normal">            </span><span class="string">"movq -8(%%edi,%%ecx,), %%mm2 </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// load previous aligned 8 bytes</span>
<span class="normal">                                                </span><span class="comment">// (correct pos. in loop below)</span>
<span class="normal">         </span><span class="string">"avg_3lp:                        </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"movq (%%edi,%%ecx,), %%mm0   </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// load mm0 with Avg(x)</span>
<span class="normal">            </span><span class="string">"movq %%mm5, %%mm3            </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"psrlq _ShiftRem, %%mm2       </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// correct position Raw(x-bpp)</span>
<span class="normal">                                                </span><span class="comment">// data</span>
<span class="normal">            </span><span class="string">"movq (%%esi,%%ecx,), %%mm1   </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// load mm1 with Prior(x)</span>
<span class="normal">            </span><span class="string">"movq %%mm7, %%mm6            </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pand %%mm1, %%mm3            </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// get lsb for each prev_row byte</span>
<span class="normal">            </span><span class="string">"psrlq $1, %%mm1              </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// divide prev_row bytes by 2</span>
<span class="normal">            </span><span class="string">"pand  %%mm4, %%mm1           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// clear invalid bit 7 of each</span>
<span class="normal">                                                </span><span class="comment">// byte</span>
<span class="normal">            </span><span class="string">"paddb %%mm1, %%mm0           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// add (Prev_row/2) to Avg for</span>
<span class="normal">                                                </span><span class="comment">// each byte</span>
<span class="normal">            </span><span class="comment">// add 1st active group (Raw(x-bpp)/2) to average with LBCarry</span>
<span class="normal">            </span><span class="string">"movq %%mm3, %%mm1            </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// now use mm1 for getting</span>
<span class="normal">                                                </span><span class="comment">// LBCarrys</span>
<span class="normal">            </span><span class="string">"pand %%mm2, %%mm1            </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// get LBCarrys for each byte</span>
<span class="normal">                                                </span><span class="comment">// where both</span>
<span class="normal">                               </span><span class="comment">// lsb's were == 1 (only valid for active group)</span>
<span class="normal">            </span><span class="string">"psrlq $1, %%mm2              </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// divide raw bytes by 2</span>
<span class="normal">            </span><span class="string">"pand  %%mm4, %%mm2           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// clear invalid bit 7 of each</span>
<span class="normal">                                                </span><span class="comment">// byte</span>
<span class="normal">            </span><span class="string">"paddb %%mm1, %%mm2           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// add LBCarrys to (Raw(x-bpp)/2)</span>
<span class="normal">                                                </span><span class="comment">// for each byte</span>
<span class="normal">            </span><span class="string">"pand %%mm6, %%mm2            </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// leave only Active Group 1</span>
<span class="normal">                                                </span><span class="comment">// bytes to add to Avg</span>
<span class="normal">            </span><span class="string">"paddb %%mm2, %%mm0           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// add (Raw/2) + LBCarrys to</span>
<span class="normal">                                                </span><span class="comment">// Avg for each Active</span>
<span class="normal">                               </span><span class="comment">//  byte</span>
<span class="normal">            </span><span class="comment">// add 2nd active group (Raw(x-bpp)/2) to average with _LBCarry</span>
<span class="normal">            </span><span class="string">"psllq _ShiftBpp, %%mm6       </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// shift the mm6 mask to cover</span>
<span class="normal">                                                </span><span class="comment">// bytes 3-5</span>
<span class="normal">            </span><span class="string">"movq %%mm0, %%mm2            </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// mov updated Raws to mm2</span>
<span class="normal">            </span><span class="string">"psllq _ShiftBpp, %%mm2       </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// shift data to pos. correctly</span>
<span class="normal">            </span><span class="string">"movq %%mm3, %%mm1            </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// now use mm1 for getting</span>
<span class="normal">                                                </span><span class="comment">// LBCarrys</span>
<span class="normal">            </span><span class="string">"pand %%mm2, %%mm1            </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// get LBCarrys for each byte</span>
<span class="normal">                                                </span><span class="comment">// where both</span>
<span class="normal">                               </span><span class="comment">// lsb's were == 1 (only valid for active group)</span>
<span class="normal">            </span><span class="string">"psrlq $1, %%mm2              </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// divide raw bytes by 2</span>
<span class="normal">            </span><span class="string">"pand  %%mm4, %%mm2           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// clear invalid bit 7 of each</span>
<span class="normal">                                                </span><span class="comment">// byte</span>
<span class="normal">            </span><span class="string">"paddb %%mm1, %%mm2           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// add LBCarrys to (Raw(x-bpp)/2)</span>
<span class="normal">                                                </span><span class="comment">// for each byte</span>
<span class="normal">            </span><span class="string">"pand %%mm6, %%mm2            </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// leave only Active Group 2</span>
<span class="normal">                                                </span><span class="comment">// bytes to add to Avg</span>
<span class="normal">            </span><span class="string">"paddb %%mm2, %%mm0           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// add (Raw/2) + LBCarrys to</span>
<span class="normal">                                                </span><span class="comment">// Avg for each Active</span>
<span class="normal">                               </span><span class="comment">//  byte</span>

<span class="normal">            </span><span class="comment">// add 3rd active group (Raw(x-bpp)/2) to average with _LBCarry</span>
<span class="normal">            </span><span class="string">"psllq _ShiftBpp, %%mm6       </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// shift mm6 mask to cover last</span>
<span class="normal">                                                </span><span class="comment">// two</span>
<span class="normal">                                 </span><span class="comment">// bytes</span>
<span class="normal">            </span><span class="string">"movq %%mm0, %%mm2            </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// mov updated Raws to mm2</span>
<span class="normal">            </span><span class="string">"psllq _ShiftBpp, %%mm2       </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// shift data to pos. correctly</span>
<span class="normal">                              </span><span class="comment">// Data only needs to be shifted once here to</span>
<span class="normal">                              </span><span class="comment">// get the correct x-bpp offset.</span>
<span class="normal">            </span><span class="string">"movq %%mm3, %%mm1            </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// now use mm1 for getting</span>
<span class="normal">                                                </span><span class="comment">// LBCarrys</span>
<span class="normal">            </span><span class="string">"pand %%mm2, %%mm1            </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// get LBCarrys for each byte</span>
<span class="normal">                                                </span><span class="comment">// where both</span>
<span class="normal">                              </span><span class="comment">// lsb's were == 1 (only valid for active group)</span>
<span class="normal">            </span><span class="string">"psrlq $1, %%mm2              </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// divide raw bytes by 2</span>
<span class="normal">            </span><span class="string">"pand  %%mm4, %%mm2           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// clear invalid bit 7 of each</span>
<span class="normal">                                                </span><span class="comment">// byte</span>
<span class="normal">            </span><span class="string">"paddb %%mm1, %%mm2           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// add LBCarrys to (Raw(x-bpp)/2)</span>
<span class="normal">                                                </span><span class="comment">// for each byte</span>
<span class="normal">            </span><span class="string">"pand %%mm6, %%mm2            </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// leave only Active Group 2</span>
<span class="normal">                                                </span><span class="comment">// bytes to add to Avg</span>
<span class="normal">            </span><span class="string">"addl $8, %%ecx               </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"paddb %%mm2, %%mm0           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// add (Raw/2) + LBCarrys to</span>
<span class="normal">                                                </span><span class="comment">// Avg for each Active</span>
<span class="normal">                                                </span><span class="comment">// byte</span>
<span class="normal">            </span><span class="comment">// now ready to write back to memory</span>
<span class="normal">            </span><span class="string">"movq %%mm0, -8(%%edi,%%ecx,) </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// move updated Raw(x) to use as Raw(x-bpp) for next loop</span>
<span class="normal">            </span><span class="string">"cmpl _MMXLength, %%ecx       </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"movq %%mm0, %%mm2            </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// mov updated Raw(x) to mm2</span>
<span class="normal">            </span><span class="string">"jb avg_3lp                   </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">            </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"=S"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_S</span><span class="symbol">),</span><span class="normal">             </span><span class="comment">// output regs (dummy)</span>
<span class="normal">              </span><span class="string">"=D"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_D</span><span class="symbol">)</span>

<span class="normal">            </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"0"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">prev_row</span><span class="symbol">),</span><span class="normal">  </span><span class="comment">// esi           // input regs</span>
<span class="normal">              </span><span class="string">"1"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row</span><span class="symbol">)</span><span class="normal">        </span><span class="comment">// edi</span>

<span class="normal">            </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"%ecx"</span><span class="normal">                            </span><span class="comment">// clobber list</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="number">0</span><span class="normal">  </span><span class="comment">/* %mm0, ..., %mm7 not supported by gcc 2.7.2.3 or egcs 1.1 */</span>
<span class="normal">            </span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm0"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm1"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm2"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm3"</span>
<span class="normal">            </span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm4"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm5"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm6"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm7"</span>
<span class="preproc">#endif</span>
<span class="normal">         </span><span class="symbol">);</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="keyword">break</span><span class="symbol">;</span><span class="normal">  </span><span class="comment">// end 3 bpp</span>

<span class="normal">      </span><span class="keyword">case</span><span class="normal"> </span><span class="number">6</span><span class="symbol">:</span>
<span class="normal">      </span><span class="keyword">case</span><span class="normal"> </span><span class="number">4</span><span class="symbol">:</span>
<span class="normal">      </span><span class="comment">//case 7:   // who wrote this?  PNG doesn't support 5 or 7 bytes/pixel</span>
<span class="normal">      </span><span class="comment">//case 5:   // GRR BOGUS</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         _ActiveMask</span><span class="symbol">.</span><span class="normal">use  </span><span class="symbol">=</span><span class="normal"> 0xffffffffffffffffLL</span><span class="symbol">;</span><span class="normal"> </span><span class="comment">// use shift below to clear</span>
<span class="normal">                                                  </span><span class="comment">// appropriate inactive bytes</span>
<span class="normal">         _ShiftBpp</span><span class="symbol">.</span><span class="normal">use </span><span class="symbol">=</span><span class="normal"> bpp </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">3</span><span class="symbol">;</span>
<span class="normal">         _ShiftRem</span><span class="symbol">.</span><span class="normal">use </span><span class="symbol">=</span><span class="normal"> </span><span class="number">64</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> _ShiftBpp</span><span class="symbol">.</span><span class="normal">use</span><span class="symbol">;</span>

<span class="normal">         </span><span class="usertype">__asm__</span><span class="normal"> </span><span class="function">__volatile__</span><span class="normal"> </span><span class="symbol">(</span>
<span class="normal">            </span><span class="string">"movq _HBClearMask, %%mm4    </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">            </span><span class="comment">// re-init address pointers and offset</span>
<span class="normal">            </span><span class="string">"movl _dif, %%ecx            </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// ecx:  x = offset to</span>
<span class="normal">                                               </span><span class="comment">// alignment boundary</span>

<span class="normal">            </span><span class="comment">// load _ActiveMask and clear all bytes except for 1st active group</span>
<span class="normal">            </span><span class="string">"movq _ActiveMask, %%mm7     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="comment">// preload  "movl row, %%edi             \n\t" // edi:  Avg(x)</span>
<span class="normal">            </span><span class="string">"psrlq _ShiftRem, %%mm7      </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="comment">// preload  "movl prev_row, %%esi        \n\t" // esi:  Prior(x)</span>
<span class="normal">            </span><span class="string">"movq %%mm7, %%mm6           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"movq _LBCarryMask, %%mm5    </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"psllq _ShiftBpp, %%mm6      </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// create mask for 2nd active</span>
<span class="normal">                                               </span><span class="comment">// group</span>

<span class="normal">            </span><span class="comment">// prime the pump:  load the first Raw(x-bpp) data set</span>
<span class="normal">            </span><span class="string">"movq -8(%%edi,%%ecx,), %%mm2 </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// load previous aligned 8 bytes</span>
<span class="normal">                                          </span><span class="comment">// (we correct pos. in loop below)</span>
<span class="normal">         </span><span class="string">"avg_4lp:                       </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"movq (%%edi,%%ecx,), %%mm0  </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"psrlq _ShiftRem, %%mm2      </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// shift data to pos. correctly</span>
<span class="normal">            </span><span class="string">"movq (%%esi,%%ecx,), %%mm1  </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// add (Prev_row/2) to average</span>
<span class="normal">            </span><span class="string">"movq %%mm5, %%mm3           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pand %%mm1, %%mm3           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// get lsb for each prev_row byte</span>
<span class="normal">            </span><span class="string">"psrlq $1, %%mm1             </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// divide prev_row bytes by 2</span>
<span class="normal">            </span><span class="string">"pand  %%mm4, %%mm1          </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// clear invalid bit 7 of each</span>
<span class="normal">                                               </span><span class="comment">// byte</span>
<span class="normal">            </span><span class="string">"paddb %%mm1, %%mm0          </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// add (Prev_row/2) to Avg for</span>
<span class="normal">                                               </span><span class="comment">// each byte</span>
<span class="normal">            </span><span class="comment">// add 1st active group (Raw(x-bpp)/2) to average with _LBCarry</span>
<span class="normal">            </span><span class="string">"movq %%mm3, %%mm1           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// now use mm1 for getting</span>
<span class="normal">                                               </span><span class="comment">// LBCarrys</span>
<span class="normal">            </span><span class="string">"pand %%mm2, %%mm1           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// get LBCarrys for each byte</span>
<span class="normal">                                               </span><span class="comment">// where both</span>
<span class="normal">                              </span><span class="comment">// lsb's were == 1 (only valid for active group)</span>
<span class="normal">            </span><span class="string">"psrlq $1, %%mm2             </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// divide raw bytes by 2</span>
<span class="normal">            </span><span class="string">"pand  %%mm4, %%mm2          </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// clear invalid bit 7 of each</span>
<span class="normal">                                               </span><span class="comment">// byte</span>
<span class="normal">            </span><span class="string">"paddb %%mm1, %%mm2          </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// add LBCarrys to (Raw(x-bpp)/2)</span>
<span class="normal">                                               </span><span class="comment">// for each byte</span>
<span class="normal">            </span><span class="string">"pand %%mm7, %%mm2           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// leave only Active Group 1</span>
<span class="normal">                                               </span><span class="comment">// bytes to add to Avg</span>
<span class="normal">            </span><span class="string">"paddb %%mm2, %%mm0          </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// add (Raw/2) + LBCarrys to Avg</span>
<span class="normal">                                               </span><span class="comment">// for each Active</span>
<span class="normal">                              </span><span class="comment">// byte</span>
<span class="normal">            </span><span class="comment">// add 2nd active group (Raw(x-bpp)/2) to average with _LBCarry</span>
<span class="normal">            </span><span class="string">"movq %%mm0, %%mm2           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// mov updated Raws to mm2</span>
<span class="normal">            </span><span class="string">"psllq _ShiftBpp, %%mm2      </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// shift data to pos. correctly</span>
<span class="normal">            </span><span class="string">"addl $8, %%ecx              </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"movq %%mm3, %%mm1           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// now use mm1 for getting</span>
<span class="normal">                                               </span><span class="comment">// LBCarrys</span>
<span class="normal">            </span><span class="string">"pand %%mm2, %%mm1           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// get LBCarrys for each byte</span>
<span class="normal">                                               </span><span class="comment">// where both</span>
<span class="normal">                              </span><span class="comment">// lsb's were == 1 (only valid for active group)</span>
<span class="normal">            </span><span class="string">"psrlq $1, %%mm2             </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// divide raw bytes by 2</span>
<span class="normal">            </span><span class="string">"pand  %%mm4, %%mm2          </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// clear invalid bit 7 of each</span>
<span class="normal">                                               </span><span class="comment">// byte</span>
<span class="normal">            </span><span class="string">"paddb %%mm1, %%mm2          </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// add LBCarrys to (Raw(x-bpp)/2)</span>
<span class="normal">                                               </span><span class="comment">// for each byte</span>
<span class="normal">            </span><span class="string">"pand %%mm6, %%mm2           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// leave only Active Group 2</span>
<span class="normal">                                               </span><span class="comment">// bytes to add to Avg</span>
<span class="normal">            </span><span class="string">"paddb %%mm2, %%mm0          </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// add (Raw/2) + LBCarrys to</span>
<span class="normal">                                               </span><span class="comment">// Avg for each Active</span>
<span class="normal">                              </span><span class="comment">// byte</span>
<span class="normal">            </span><span class="string">"cmpl _MMXLength, %%ecx      </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// now ready to write back to memory</span>
<span class="normal">            </span><span class="string">"movq %%mm0, -8(%%edi,%%ecx,) </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// prep Raw(x-bpp) for next loop</span>
<span class="normal">            </span><span class="string">"movq %%mm0, %%mm2           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// mov updated Raws to mm2</span>
<span class="normal">            </span><span class="string">"jb avg_4lp                  </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">            </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"=S"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_S</span><span class="symbol">),</span><span class="normal">            </span><span class="comment">// output regs (dummy)</span>
<span class="normal">              </span><span class="string">"=D"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_D</span><span class="symbol">)</span>

<span class="normal">            </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"0"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">prev_row</span><span class="symbol">),</span><span class="normal">  </span><span class="comment">// esi          // input regs</span>
<span class="normal">              </span><span class="string">"1"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row</span><span class="symbol">)</span><span class="normal">        </span><span class="comment">// edi</span>

<span class="normal">            </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"%ecx"</span><span class="normal">                           </span><span class="comment">// clobber list</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="number">0</span><span class="normal">  </span><span class="comment">/* %mm0, ..., %mm7 not supported by gcc 2.7.2.3 or egcs 1.1 */</span>
<span class="normal">            </span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm0"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm1"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm2"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm3"</span>
<span class="normal">            </span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm4"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm5"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm6"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm7"</span>
<span class="preproc">#endif</span>
<span class="normal">         </span><span class="symbol">);</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="keyword">break</span><span class="symbol">;</span><span class="normal">  </span><span class="comment">// end 4,6 bpp</span>

<span class="normal">      </span><span class="keyword">case</span><span class="normal"> </span><span class="number">2</span><span class="symbol">:</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         _ActiveMask</span><span class="symbol">.</span><span class="normal">use  </span><span class="symbol">=</span><span class="normal"> 0x000000000000ffffLL</span><span class="symbol">;</span>
<span class="normal">         _ShiftBpp</span><span class="symbol">.</span><span class="normal">use </span><span class="symbol">=</span><span class="normal"> </span><span class="number">16</span><span class="symbol">;</span><span class="normal">   </span><span class="comment">// == 2 * 8</span>
<span class="normal">         _ShiftRem</span><span class="symbol">.</span><span class="normal">use </span><span class="symbol">=</span><span class="normal"> </span><span class="number">48</span><span class="symbol">;</span><span class="normal">   </span><span class="comment">// == 64 - 16</span>

<span class="normal">         </span><span class="usertype">__asm__</span><span class="normal"> </span><span class="function">__volatile__</span><span class="normal"> </span><span class="symbol">(</span>
<span class="normal">            </span><span class="comment">// load _ActiveMask</span>
<span class="normal">            </span><span class="string">"movq _ActiveMask, %%mm7     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// re-init address pointers and offset</span>
<span class="normal">            </span><span class="string">"movl _dif, %%ecx            </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// ecx:  x = offset to alignment</span>
<span class="normal">                                               </span><span class="comment">// boundary</span>
<span class="normal">            </span><span class="string">"movq _LBCarryMask, %%mm5    </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="comment">// preload  "movl row, %%edi             \n\t" // edi:  Avg(x)</span>
<span class="normal">            </span><span class="string">"movq _HBClearMask, %%mm4    </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="comment">// preload  "movl prev_row, %%esi        \n\t" // esi:  Prior(x)</span>

<span class="normal">            </span><span class="comment">// prime the pump:  load the first Raw(x-bpp) data set</span>
<span class="normal">            </span><span class="string">"movq -8(%%edi,%%ecx,), %%mm2 </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// load previous aligned 8 bytes</span>
<span class="normal">                              </span><span class="comment">// (we correct pos. in loop below)</span>
<span class="normal">         </span><span class="string">"avg_2lp:                       </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"movq (%%edi,%%ecx,), %%mm0  </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"psrlq _ShiftRem, %%mm2      </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// shift data to pos. correctly</span>
<span class="normal">            </span><span class="string">"movq (%%esi,%%ecx,), %%mm1  </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">//  (GRR BUGFIX:  was psllq)</span>
<span class="normal">            </span><span class="comment">// add (Prev_row/2) to average</span>
<span class="normal">            </span><span class="string">"movq %%mm5, %%mm3           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pand %%mm1, %%mm3           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// get lsb for each prev_row byte</span>
<span class="normal">            </span><span class="string">"psrlq $1, %%mm1             </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// divide prev_row bytes by 2</span>
<span class="normal">            </span><span class="string">"pand  %%mm4, %%mm1          </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// clear invalid bit 7 of each</span>
<span class="normal">                                               </span><span class="comment">// byte</span>
<span class="normal">            </span><span class="string">"movq %%mm7, %%mm6           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"paddb %%mm1, %%mm0          </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// add (Prev_row/2) to Avg for</span>
<span class="normal">                                               </span><span class="comment">// each byte</span>

<span class="normal">            </span><span class="comment">// add 1st active group (Raw(x-bpp)/2) to average with _LBCarry</span>
<span class="normal">            </span><span class="string">"movq %%mm3, %%mm1           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// now use mm1 for getting</span>
<span class="normal">                                               </span><span class="comment">// LBCarrys</span>
<span class="normal">            </span><span class="string">"pand %%mm2, %%mm1           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// get LBCarrys for each byte</span>
<span class="normal">                                               </span><span class="comment">// where both</span>
<span class="normal">                                               </span><span class="comment">// lsb's were == 1 (only valid</span>
<span class="normal">                                               </span><span class="comment">// for active group)</span>
<span class="normal">            </span><span class="string">"psrlq $1, %%mm2             </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// divide raw bytes by 2</span>
<span class="normal">            </span><span class="string">"pand  %%mm4, %%mm2          </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// clear invalid bit 7 of each</span>
<span class="normal">                                               </span><span class="comment">// byte</span>
<span class="normal">            </span><span class="string">"paddb %%mm1, %%mm2          </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// add LBCarrys to (Raw(x-bpp)/2)</span>
<span class="normal">                                               </span><span class="comment">// for each byte</span>
<span class="normal">            </span><span class="string">"pand %%mm6, %%mm2           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// leave only Active Group 1</span>
<span class="normal">                                               </span><span class="comment">// bytes to add to Avg</span>
<span class="normal">            </span><span class="string">"paddb %%mm2, %%mm0          </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// add (Raw/2) + LBCarrys to Avg</span>
<span class="normal">                                               </span><span class="comment">// for each Active byte</span>

<span class="normal">            </span><span class="comment">// add 2nd active group (Raw(x-bpp)/2) to average with _LBCarry</span>
<span class="normal">            </span><span class="string">"psllq _ShiftBpp, %%mm6      </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// shift the mm6 mask to cover</span>
<span class="normal">                                               </span><span class="comment">// bytes 2 &amp; 3</span>
<span class="normal">            </span><span class="string">"movq %%mm0, %%mm2           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// mov updated Raws to mm2</span>
<span class="normal">            </span><span class="string">"psllq _ShiftBpp, %%mm2      </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// shift data to pos. correctly</span>
<span class="normal">            </span><span class="string">"movq %%mm3, %%mm1           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// now use mm1 for getting</span>
<span class="normal">                                               </span><span class="comment">// LBCarrys</span>
<span class="normal">            </span><span class="string">"pand %%mm2, %%mm1           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// get LBCarrys for each byte</span>
<span class="normal">                                               </span><span class="comment">// where both</span>
<span class="normal">                                               </span><span class="comment">// lsb's were == 1 (only valid</span>
<span class="normal">                                               </span><span class="comment">// for active group)</span>
<span class="normal">            </span><span class="string">"psrlq $1, %%mm2             </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// divide raw bytes by 2</span>
<span class="normal">            </span><span class="string">"pand  %%mm4, %%mm2          </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// clear invalid bit 7 of each</span>
<span class="normal">                                               </span><span class="comment">// byte</span>
<span class="normal">            </span><span class="string">"paddb %%mm1, %%mm2          </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// add LBCarrys to (Raw(x-bpp)/2)</span>
<span class="normal">                                               </span><span class="comment">// for each byte</span>
<span class="normal">            </span><span class="string">"pand %%mm6, %%mm2           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// leave only Active Group 2</span>
<span class="normal">                                               </span><span class="comment">// bytes to add to Avg</span>
<span class="normal">            </span><span class="string">"paddb %%mm2, %%mm0          </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// add (Raw/2) + LBCarrys to</span>
<span class="normal">                                               </span><span class="comment">// Avg for each Active byte</span>

<span class="normal">            </span><span class="comment">// add 3rd active group (Raw(x-bpp)/2) to average with _LBCarry</span>
<span class="normal">            </span><span class="string">"psllq _ShiftBpp, %%mm6      </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// shift the mm6 mask to cover</span>
<span class="normal">                                               </span><span class="comment">// bytes 4 &amp; 5</span>
<span class="normal">            </span><span class="string">"movq %%mm0, %%mm2           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// mov updated Raws to mm2</span>
<span class="normal">            </span><span class="string">"psllq _ShiftBpp, %%mm2      </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// shift data to pos. correctly</span>
<span class="normal">            </span><span class="string">"movq %%mm3, %%mm1           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// now use mm1 for getting</span>
<span class="normal">                                               </span><span class="comment">// LBCarrys</span>
<span class="normal">            </span><span class="string">"pand %%mm2, %%mm1           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// get LBCarrys for each byte</span>
<span class="normal">                                               </span><span class="comment">// where both lsb's were == 1</span>
<span class="normal">                                               </span><span class="comment">// (only valid for active group)</span>
<span class="normal">            </span><span class="string">"psrlq $1, %%mm2             </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// divide raw bytes by 2</span>
<span class="normal">            </span><span class="string">"pand  %%mm4, %%mm2          </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// clear invalid bit 7 of each</span>
<span class="normal">                                               </span><span class="comment">// byte</span>
<span class="normal">            </span><span class="string">"paddb %%mm1, %%mm2          </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// add LBCarrys to (Raw(x-bpp)/2)</span>
<span class="normal">                                               </span><span class="comment">// for each byte</span>
<span class="normal">            </span><span class="string">"pand %%mm6, %%mm2           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// leave only Active Group 2</span>
<span class="normal">                                               </span><span class="comment">// bytes to add to Avg</span>
<span class="normal">            </span><span class="string">"paddb %%mm2, %%mm0          </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// add (Raw/2) + LBCarrys to</span>
<span class="normal">                                               </span><span class="comment">// Avg for each Active byte</span>

<span class="normal">            </span><span class="comment">// add 4th active group (Raw(x-bpp)/2) to average with _LBCarry</span>
<span class="normal">            </span><span class="string">"psllq _ShiftBpp, %%mm6      </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// shift the mm6 mask to cover</span>
<span class="normal">                                               </span><span class="comment">// bytes 6 &amp; 7</span>
<span class="normal">            </span><span class="string">"movq %%mm0, %%mm2           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// mov updated Raws to mm2</span>
<span class="normal">            </span><span class="string">"psllq _ShiftBpp, %%mm2      </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// shift data to pos. correctly</span>
<span class="normal">            </span><span class="string">"addl $8, %%ecx              </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"movq %%mm3, %%mm1           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// now use mm1 for getting</span>
<span class="normal">                                               </span><span class="comment">// LBCarrys</span>
<span class="normal">            </span><span class="string">"pand %%mm2, %%mm1           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// get LBCarrys for each byte</span>
<span class="normal">                                               </span><span class="comment">// where both</span>
<span class="normal">                                               </span><span class="comment">// lsb's were == 1 (only valid</span>
<span class="normal">                                               </span><span class="comment">// for active group)</span>
<span class="normal">            </span><span class="string">"psrlq $1, %%mm2             </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// divide raw bytes by 2</span>
<span class="normal">            </span><span class="string">"pand  %%mm4, %%mm2          </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// clear invalid bit 7 of each</span>
<span class="normal">                                               </span><span class="comment">// byte</span>
<span class="normal">            </span><span class="string">"paddb %%mm1, %%mm2          </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// add LBCarrys to (Raw(x-bpp)/2)</span>
<span class="normal">                                               </span><span class="comment">// for each byte</span>
<span class="normal">            </span><span class="string">"pand %%mm6, %%mm2           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// leave only Active Group 2</span>
<span class="normal">                                               </span><span class="comment">// bytes to add to Avg</span>
<span class="normal">            </span><span class="string">"paddb %%mm2, %%mm0          </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// add (Raw/2) + LBCarrys to</span>
<span class="normal">                                               </span><span class="comment">// Avg for each Active byte</span>

<span class="normal">            </span><span class="string">"cmpl _MMXLength, %%ecx      </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// now ready to write back to memory</span>
<span class="normal">            </span><span class="string">"movq %%mm0, -8(%%edi,%%ecx,) </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// prep Raw(x-bpp) for next loop</span>
<span class="normal">            </span><span class="string">"movq %%mm0, %%mm2           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// mov updated Raws to mm2</span>
<span class="normal">            </span><span class="string">"jb avg_2lp                  </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">            </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"=S"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_S</span><span class="symbol">),</span><span class="normal">            </span><span class="comment">// output regs (dummy)</span>
<span class="normal">              </span><span class="string">"=D"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_D</span><span class="symbol">)</span>

<span class="normal">            </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"0"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">prev_row</span><span class="symbol">),</span><span class="normal">  </span><span class="comment">// esi          // input regs</span>
<span class="normal">              </span><span class="string">"1"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row</span><span class="symbol">)</span><span class="normal">        </span><span class="comment">// edi</span>

<span class="normal">            </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"%ecx"</span><span class="normal">                           </span><span class="comment">// clobber list</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="number">0</span><span class="normal">  </span><span class="comment">/* %mm0, ..., %mm7 not supported by gcc 2.7.2.3 or egcs 1.1 */</span>
<span class="normal">            </span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm0"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm1"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm2"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm3"</span>
<span class="normal">            </span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm4"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm5"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm6"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm7"</span>
<span class="preproc">#endif</span>
<span class="normal">         </span><span class="symbol">);</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="keyword">break</span><span class="symbol">;</span><span class="normal">  </span><span class="comment">// end 2 bpp</span>

<span class="normal">      </span><span class="keyword">case</span><span class="normal"> </span><span class="number">1</span><span class="symbol">:</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         </span><span class="usertype">__asm__</span><span class="normal"> </span><span class="function">__volatile__</span><span class="normal"> </span><span class="symbol">(</span>
<span class="normal">            </span><span class="comment">// re-init address pointers and offset</span>
<span class="preproc">#ifdef</span><span class="normal"> __PIC__</span>
<span class="normal">            </span><span class="string">"pushl %%ebx                 </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// save Global Offset Table index</span>
<span class="preproc">#endif</span>
<span class="normal">            </span><span class="string">"movl _dif, %%ebx            </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// ebx:  x = offset to alignment</span>
<span class="normal">                                               </span><span class="comment">// boundary</span>
<span class="comment">// preload  "movl row, %%edi             \n\t" // edi:  Avg(x)</span>
<span class="normal">            </span><span class="string">"cmpl _FullLength, %%ebx     </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// test if offset at end of array</span>
<span class="normal">            </span><span class="string">"jnb avg_1end                </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// do Paeth decode for remaining bytes</span>
<span class="comment">// preload  "movl prev_row, %%esi        \n\t" // esi:  Prior(x)</span>
<span class="normal">            </span><span class="string">"movl %%edi, %%edx           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="comment">// preload  "subl bpp, %%edx             \n\t" // (bpp is preloaded into ecx)</span>
<span class="normal">            </span><span class="string">"subl %%ecx, %%edx           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// edx:  Raw(x-bpp)</span>
<span class="normal">            </span><span class="string">"xorl %%ecx, %%ecx           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// zero ecx before using cl &amp; cx</span>
<span class="normal">                                               </span><span class="comment">//  in loop below</span>
<span class="normal">         </span><span class="string">"avg_1lp:                       </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// Raw(x) = Avg(x) + ((Raw(x-bpp) + Prior(x))/2)</span>
<span class="normal">            </span><span class="string">"xorl %%eax, %%eax           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"movb (%%esi,%%ebx,), %%cl   </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// load cl with Prior(x)</span>
<span class="normal">            </span><span class="string">"movb (%%edx,%%ebx,), %%al   </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// load al with Raw(x-bpp)</span>
<span class="normal">            </span><span class="string">"addw %%cx, %%ax             </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"incl %%ebx                  </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"shrw %%ax                   </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// divide by 2</span>
<span class="normal">            </span><span class="string">"addb -1(%%edi,%%ebx,), %%al </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// add Avg(x); -1 to offset</span>
<span class="normal">                                               </span><span class="comment">// inc ebx</span>
<span class="normal">            </span><span class="string">"cmpl _FullLength, %%ebx     </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// check if at end of array</span>
<span class="normal">            </span><span class="string">"movb %%al, -1(%%edi,%%ebx,) </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// write back Raw(x);</span>
<span class="normal">                         </span><span class="comment">// mov does not affect flags; -1 to offset inc ebx</span>
<span class="normal">            </span><span class="string">"jb avg_1lp                  </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">         </span><span class="string">"avg_1end:                      </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="preproc">#ifdef</span><span class="normal"> __PIC__</span>
<span class="normal">            </span><span class="string">"popl %%ebx                  </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// Global Offset Table index</span>
<span class="preproc">#endif</span>

<span class="normal">            </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"=c"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_c</span><span class="symbol">),</span><span class="normal">            </span><span class="comment">// output regs (dummy)</span>
<span class="normal">              </span><span class="string">"=S"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_S</span><span class="symbol">),</span>
<span class="normal">              </span><span class="string">"=D"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_D</span><span class="symbol">)</span>

<span class="normal">            </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"0"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">bpp</span><span class="symbol">),</span><span class="normal">       </span><span class="comment">// ecx          // input regs</span>
<span class="normal">              </span><span class="string">"1"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">prev_row</span><span class="symbol">),</span><span class="normal">  </span><span class="comment">// esi</span>
<span class="normal">              </span><span class="string">"2"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row</span><span class="symbol">)</span><span class="normal">        </span><span class="comment">// edi</span>

<span class="normal">            </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"%eax"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%edx"</span><span class="normal">                   </span><span class="comment">// clobber list</span>
<span class="preproc">#ifndef</span><span class="normal"> __PIC__</span>
<span class="normal">            </span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%ebx"</span>
<span class="preproc">#endif</span>
<span class="normal">         </span><span class="symbol">);</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="keyword">return</span><span class="symbol">;</span><span class="normal">  </span><span class="comment">// end 1 bpp</span>

<span class="normal">      </span><span class="keyword">case</span><span class="normal"> </span><span class="number">8</span><span class="symbol">:</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         </span><span class="usertype">__asm__</span><span class="normal"> </span><span class="function">__volatile__</span><span class="normal"> </span><span class="symbol">(</span>
<span class="normal">            </span><span class="comment">// re-init address pointers and offset</span>
<span class="normal">            </span><span class="string">"movl _dif, %%ecx            </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// ecx:  x == offset to alignment</span>
<span class="normal">            </span><span class="string">"movq _LBCarryMask, %%mm5    </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">//            boundary</span>
<span class="comment">// preload  "movl row, %%edi             \n\t" // edi:  Avg(x)</span>
<span class="normal">            </span><span class="string">"movq _HBClearMask, %%mm4    </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="comment">// preload  "movl prev_row, %%esi        \n\t" // esi:  Prior(x)</span>

<span class="normal">            </span><span class="comment">// prime the pump:  load the first Raw(x-bpp) data set</span>
<span class="normal">            </span><span class="string">"movq -8(%%edi,%%ecx,), %%mm2 </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// load previous aligned 8 bytes</span>
<span class="normal">                                      </span><span class="comment">// (NO NEED to correct pos. in loop below)</span>

<span class="normal">         </span><span class="string">"avg_8lp:                       </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"movq (%%edi,%%ecx,), %%mm0  </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"movq %%mm5, %%mm3           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"movq (%%esi,%%ecx,), %%mm1  </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"addl $8, %%ecx              </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pand %%mm1, %%mm3           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// get lsb for each prev_row byte</span>
<span class="normal">            </span><span class="string">"psrlq $1, %%mm1             </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// divide prev_row bytes by 2</span>
<span class="normal">            </span><span class="string">"pand %%mm2, %%mm3           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// get LBCarrys for each byte</span>
<span class="normal">                                               </span><span class="comment">//  where both lsb's were == 1</span>
<span class="normal">            </span><span class="string">"psrlq $1, %%mm2             </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// divide raw bytes by 2</span>
<span class="normal">            </span><span class="string">"pand  %%mm4, %%mm1          </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// clear invalid bit 7, each byte</span>
<span class="normal">            </span><span class="string">"paddb %%mm3, %%mm0          </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// add LBCarrys to Avg, each byte</span>
<span class="normal">            </span><span class="string">"pand  %%mm4, %%mm2          </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// clear invalid bit 7, each byte</span>
<span class="normal">            </span><span class="string">"paddb %%mm1, %%mm0          </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// add (Prev_row/2) to Avg, each</span>
<span class="normal">            </span><span class="string">"paddb %%mm2, %%mm0          </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// add (Raw/2) to Avg for each</span>
<span class="normal">            </span><span class="string">"cmpl _MMXLength, %%ecx      </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"movq %%mm0, -8(%%edi,%%ecx,) </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"movq %%mm0, %%mm2           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// reuse as Raw(x-bpp)</span>
<span class="normal">            </span><span class="string">"jb avg_8lp                  </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">            </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"=S"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_S</span><span class="symbol">),</span><span class="normal">            </span><span class="comment">// output regs (dummy)</span>
<span class="normal">              </span><span class="string">"=D"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_D</span><span class="symbol">)</span>

<span class="normal">            </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"0"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">prev_row</span><span class="symbol">),</span><span class="normal">  </span><span class="comment">// esi          // input regs</span>
<span class="normal">              </span><span class="string">"1"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row</span><span class="symbol">)</span><span class="normal">        </span><span class="comment">// edi</span>

<span class="normal">            </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"%ecx"</span><span class="normal">                           </span><span class="comment">// clobber list</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="number">0</span><span class="normal">  </span><span class="comment">/* %mm0, ..., %mm5 not supported by gcc 2.7.2.3 or egcs 1.1 */</span>
<span class="normal">            </span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm0"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm1"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm2"</span>
<span class="normal">            </span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm3"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm4"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm5"</span>
<span class="preproc">#endif</span>
<span class="normal">         </span><span class="symbol">);</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="keyword">break</span><span class="symbol">;</span><span class="normal">  </span><span class="comment">// end 8 bpp</span>

<span class="normal">      </span><span class="keyword">default</span><span class="symbol">:</span><span class="normal">                  </span><span class="comment">// bpp greater than 8 (!= 1,2,3,4,[5],6,[7],8)</span>
<span class="normal">      </span><span class="cbracket">{</span>

<span class="preproc">#ifdef</span><span class="normal"> PNG_DEBUG</span>
<span class="normal">         </span><span class="comment">// GRR:  PRINT ERROR HERE:  SHOULD NEVER BE REACHED</span>
<span class="normal">        </span><span class="function">png_debug</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span>
<span class="normal">        </span><span class="string">"Internal logic error in pnggccrd (png_read_filter_row_mmx_avg())</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="preproc">#endif</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="number">0</span>
<span class="normal">        </span><span class="usertype">__asm__</span><span class="normal"> </span><span class="function">__volatile__</span><span class="normal"> </span><span class="symbol">(</span>
<span class="normal">            </span><span class="string">"movq _LBCarryMask, %%mm5    </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// re-init address pointers and offset</span>
<span class="normal">            </span><span class="string">"movl _dif, %%ebx            </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// ebx:  x = offset to</span>
<span class="normal">                                               </span><span class="comment">// alignment boundary</span>
<span class="normal">            </span><span class="string">"movl row, %%edi             </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// edi:  Avg(x)</span>
<span class="normal">            </span><span class="string">"movq _HBClearMask, %%mm4    </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"movl %%edi, %%edx           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"movl prev_row, %%esi        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// esi:  Prior(x)</span>
<span class="normal">            </span><span class="string">"subl bpp, %%edx             </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// edx:  Raw(x-bpp)</span>
<span class="normal">         </span><span class="string">"avg_Alp:                       </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"movq (%%edi,%%ebx,), %%mm0  </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"movq %%mm5, %%mm3           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"movq (%%esi,%%ebx,), %%mm1  </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pand %%mm1, %%mm3           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// get lsb for each prev_row byte</span>
<span class="normal">            </span><span class="string">"movq (%%edx,%%ebx,), %%mm2  </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"psrlq $1, %%mm1             </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// divide prev_row bytes by 2</span>
<span class="normal">            </span><span class="string">"pand %%mm2, %%mm3           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// get LBCarrys for each byte</span>
<span class="normal">                                               </span><span class="comment">// where both lsb's were == 1</span>
<span class="normal">            </span><span class="string">"psrlq $1, %%mm2             </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// divide raw bytes by 2</span>
<span class="normal">            </span><span class="string">"pand  %%mm4, %%mm1          </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// clear invalid bit 7 of each</span>
<span class="normal">                                               </span><span class="comment">// byte</span>
<span class="normal">            </span><span class="string">"paddb %%mm3, %%mm0          </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// add LBCarrys to Avg for each</span>
<span class="normal">                                               </span><span class="comment">// byte</span>
<span class="normal">            </span><span class="string">"pand  %%mm4, %%mm2          </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// clear invalid bit 7 of each</span>
<span class="normal">                                               </span><span class="comment">// byte</span>
<span class="normal">            </span><span class="string">"paddb %%mm1, %%mm0          </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// add (Prev_row/2) to Avg for</span>
<span class="normal">                                               </span><span class="comment">// each byte</span>
<span class="normal">            </span><span class="string">"addl $8, %%ebx              </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"paddb %%mm2, %%mm0          </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// add (Raw/2) to Avg for each</span>
<span class="normal">                                               </span><span class="comment">// byte</span>
<span class="normal">            </span><span class="string">"cmpl _MMXLength, %%ebx      </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"movq %%mm0, -8(%%edi,%%ebx,) </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"jb avg_Alp                  </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">            </span><span class="symbol">:</span><span class="normal"> </span><span class="comment">// FIXASM: output regs/vars go here, e.g.:  "=m" (memory_var)</span>

<span class="normal">            </span><span class="symbol">:</span><span class="normal"> </span><span class="comment">// FIXASM: input regs, e.g.:  "c" (count), "S" (src), "D" (dest)</span>

<span class="normal">            </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"%ebx"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%edx"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%edi"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%esi"</span><span class="normal"> </span><span class="comment">// CHECKASM: clobber list</span>
<span class="normal">         </span><span class="symbol">);</span>
<span class="preproc">#endif</span><span class="normal"> </span><span class="comment">/* 0 - NEVER REACHED */</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">   </span><span class="cbracket">}</span><span class="normal"> </span><span class="comment">// end switch (bpp)</span>

<span class="normal">   </span><span class="usertype">__asm__</span><span class="normal"> </span><span class="function">__volatile__</span><span class="normal"> </span><span class="symbol">(</span>
<span class="normal">      </span><span class="comment">// MMX acceleration complete; now do clean-up</span>
<span class="normal">      </span><span class="comment">// check if any remaining bytes left to decode</span>
<span class="preproc">#ifdef</span><span class="normal"> __PIC__</span>
<span class="normal">      </span><span class="string">"pushl %%ebx                 </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// save index to Global Offset Table</span>
<span class="preproc">#endif</span>
<span class="normal">      </span><span class="string">"movl _MMXLength, %%ebx      </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// ebx:  x == offset bytes after MMX</span>
<span class="comment">//pre "movl row, %%edi             \n\t" // edi:  Avg(x)</span>
<span class="normal">      </span><span class="string">"cmpl _FullLength, %%ebx     </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// test if offset at end of array</span>
<span class="normal">      </span><span class="string">"jnb avg_end                 </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">      </span><span class="comment">// do Avg decode for remaining bytes</span>
<span class="comment">//pre "movl prev_row, %%esi        \n\t" // esi:  Prior(x)</span>
<span class="normal">      </span><span class="string">"movl %%edi, %%edx           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="comment">//pre "subl bpp, %%edx             \n\t" // (bpp is preloaded into ecx)</span>
<span class="normal">      </span><span class="string">"subl %%ecx, %%edx           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// edx:  Raw(x-bpp)</span>
<span class="normal">      </span><span class="string">"xorl %%ecx, %%ecx           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// zero ecx before using cl &amp; cx below</span>

<span class="normal">   </span><span class="string">"avg_lp2:                       </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="comment">// Raw(x) = Avg(x) + ((Raw(x-bpp) + Prior(x))/2)</span>
<span class="normal">      </span><span class="string">"xorl %%eax, %%eax           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"movb (%%esi,%%ebx,), %%cl   </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// load cl with Prior(x)</span>
<span class="normal">      </span><span class="string">"movb (%%edx,%%ebx,), %%al   </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// load al with Raw(x-bpp)</span>
<span class="normal">      </span><span class="string">"addw %%cx, %%ax             </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"incl %%ebx                  </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"shrw %%ax                   </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// divide by 2</span>
<span class="normal">      </span><span class="string">"addb -1(%%edi,%%ebx,), %%al </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// add Avg(x); -1 to offset inc ebx</span>
<span class="normal">      </span><span class="string">"cmpl _FullLength, %%ebx     </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// check if at end of array</span>
<span class="normal">      </span><span class="string">"movb %%al, -1(%%edi,%%ebx,) </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// write back Raw(x) [mov does not</span>
<span class="normal">      </span><span class="string">"jb avg_lp2                  </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">//  affect flags; -1 to offset inc ebx]</span>

<span class="normal">   </span><span class="string">"avg_end:                       </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"EMMS                        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// end MMX; prep for poss. FP instrs.</span>
<span class="preproc">#ifdef</span><span class="normal"> __PIC__</span>
<span class="normal">      </span><span class="string">"popl %%ebx                  </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// restore index to Global Offset Table</span>
<span class="preproc">#endif</span>

<span class="normal">      </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"=c"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_c</span><span class="symbol">),</span><span class="normal">            </span><span class="comment">// output regs (dummy)</span>
<span class="normal">        </span><span class="string">"=S"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_S</span><span class="symbol">),</span>
<span class="normal">        </span><span class="string">"=D"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_D</span><span class="symbol">)</span>

<span class="normal">      </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"0"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">bpp</span><span class="symbol">),</span><span class="normal">       </span><span class="comment">// ecx          // input regs</span>
<span class="normal">        </span><span class="string">"1"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">prev_row</span><span class="symbol">),</span><span class="normal">  </span><span class="comment">// esi</span>
<span class="normal">        </span><span class="string">"2"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row</span><span class="symbol">)</span><span class="normal">        </span><span class="comment">// edi</span>

<span class="normal">      </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"%eax"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%edx"</span><span class="normal">                   </span><span class="comment">// clobber list</span>
<span class="preproc">#ifndef</span><span class="normal"> __PIC__</span>
<span class="normal">      </span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%ebx"</span>
<span class="preproc">#endif</span>
<span class="normal">   </span><span class="symbol">);</span>

<span class="cbracket">}</span><span class="normal"> </span><span class="comment">/* end png_read_filter_row_mmx_avg() */</span>
<span class="preproc">#endif</span>



<span class="preproc">#ifdef</span><span class="normal"> PNG_THREAD_UNSAFE_OK</span>
<span class="comment">//===========================================================================//</span>
<span class="comment">//                                                                           //</span>
<span class="comment">//         P N G _ R E A D _ F I L T E R _ R O W _ M M X _ P A E T H         //</span>
<span class="comment">//                                                                           //</span>
<span class="comment">//===========================================================================//</span>

<span class="comment">// Optimized code for PNG Paeth filter decoder</span>

<span class="keyword">static</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="comment">/* PRIVATE */</span>
<span class="function">png_read_filter_row_mmx_paeth</span><span class="symbol">(</span><span class="usertype">png_row_infop</span><span class="normal"> row_info</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">png_bytep</span><span class="normal"> row</span><span class="symbol">,</span>
<span class="normal">                              </span><span class="usertype">png_bytep</span><span class="normal"> prev_row</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">   </span><span class="type">int</span><span class="normal"> bpp</span><span class="symbol">;</span>
<span class="normal">   </span><span class="type">int</span><span class="normal"> dummy_value_c</span><span class="symbol">;</span><span class="normal">   </span><span class="comment">// fix 'forbidden register 2 (cx) was spilled' error</span>
<span class="normal">   </span><span class="type">int</span><span class="normal"> dummy_value_S</span><span class="symbol">;</span>
<span class="normal">   </span><span class="type">int</span><span class="normal"> dummy_value_D</span><span class="symbol">;</span>

<span class="normal">   bpp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">pixel_depth </span><span class="symbol">+</span><span class="normal"> </span><span class="number">7</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">3</span><span class="symbol">;</span><span class="normal"> </span><span class="comment">// Get # bytes per pixel</span>
<span class="normal">   _FullLength  </span><span class="symbol">=</span><span class="normal"> row_info</span><span class="symbol">-&gt;</span><span class="normal">rowbytes</span><span class="symbol">;</span><span class="normal"> </span><span class="comment">// # of bytes to filter</span>

<span class="normal">   </span><span class="usertype">__asm__</span><span class="normal"> </span><span class="function">__volatile__</span><span class="normal"> </span><span class="symbol">(</span>
<span class="preproc">#ifdef</span><span class="normal"> __PIC__</span>
<span class="normal">      </span><span class="string">"pushl %%ebx                 </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// save index to Global Offset Table</span>
<span class="preproc">#endif</span>
<span class="normal">      </span><span class="string">"xorl %%ebx, %%ebx           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// ebx:  x offset</span>
<span class="comment">//pre "movl row, %%edi             \n\t"</span>
<span class="normal">      </span><span class="string">"xorl %%edx, %%edx           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// edx:  x-bpp offset</span>
<span class="comment">//pre "movl prev_row, %%esi        \n\t"</span>
<span class="normal">      </span><span class="string">"xorl %%eax, %%eax           </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">      </span><span class="comment">// Compute the Raw value for the first bpp bytes</span>
<span class="normal">      </span><span class="comment">// Note: the formula works out to be always</span>
<span class="normal">      </span><span class="comment">//   Paeth(x) = Raw(x) + Prior(x)      where x &lt; bpp</span>
<span class="normal">   </span><span class="string">"paeth_rlp:                     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"movb (%%edi,%%ebx,), %%al   </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"addb (%%esi,%%ebx,), %%al   </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"incl %%ebx                  </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="comment">//pre "cmpl bpp, %%ebx             \n\t" (bpp is preloaded into ecx)</span>
<span class="normal">      </span><span class="string">"cmpl %%ecx, %%ebx           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"movb %%al, -1(%%edi,%%ebx,) </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"jb paeth_rlp                </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="comment">// get # of bytes to alignment</span>
<span class="normal">      </span><span class="string">"movl %%edi, _dif            </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// take start of row</span>
<span class="normal">      </span><span class="string">"addl %%ebx, _dif            </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// add bpp</span>
<span class="normal">      </span><span class="string">"xorl %%ecx, %%ecx           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"addl $0xf, _dif             </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// add 7 + 8 to incr past alignment</span>
<span class="normal">                                         </span><span class="comment">// boundary</span>
<span class="normal">      </span><span class="string">"andl $0xfffffff8, _dif      </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// mask to alignment boundary</span>
<span class="normal">      </span><span class="string">"subl %%edi, _dif            </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// subtract from start ==&gt; value ebx</span>
<span class="normal">                                         </span><span class="comment">// at alignment</span>
<span class="normal">      </span><span class="string">"jz paeth_go                 </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="comment">// fix alignment</span>

<span class="normal">   </span><span class="string">"paeth_lp1:                     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"xorl %%eax, %%eax           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="comment">// pav = p - a = (a + b - c) - a = b - c</span>
<span class="normal">      </span><span class="string">"movb (%%esi,%%ebx,), %%al   </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// load Prior(x) into al</span>
<span class="normal">      </span><span class="string">"movb (%%esi,%%edx,), %%cl   </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// load Prior(x-bpp) into cl</span>
<span class="normal">      </span><span class="string">"subl %%ecx, %%eax           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// subtract Prior(x-bpp)</span>
<span class="normal">      </span><span class="string">"movl %%eax, _patemp         </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// Save pav for later use</span>
<span class="normal">      </span><span class="string">"xorl %%eax, %%eax           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="comment">// pbv = p - b = (a + b - c) - b = a - c</span>
<span class="normal">      </span><span class="string">"movb (%%edi,%%edx,), %%al   </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// load Raw(x-bpp) into al</span>
<span class="normal">      </span><span class="string">"subl %%ecx, %%eax           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// subtract Prior(x-bpp)</span>
<span class="normal">      </span><span class="string">"movl %%eax, %%ecx           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="comment">// pcv = p - c = (a + b - c) -c = (a - c) + (b - c) = pav + pbv</span>
<span class="normal">      </span><span class="string">"addl _patemp, %%eax         </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// pcv = pav + pbv</span>
<span class="normal">      </span><span class="comment">// pc = abs(pcv)</span>
<span class="normal">      </span><span class="string">"testl $0x80000000, %%eax    </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"jz paeth_pca                </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"negl %%eax                  </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// reverse sign of neg values</span>

<span class="normal">   </span><span class="string">"paeth_pca:                     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"movl %%eax, _pctemp         </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// save pc for later use</span>
<span class="normal">      </span><span class="comment">// pb = abs(pbv)</span>
<span class="normal">      </span><span class="string">"testl $0x80000000, %%ecx    </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"jz paeth_pba                </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"negl %%ecx                  </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// reverse sign of neg values</span>

<span class="normal">   </span><span class="string">"paeth_pba:                     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"movl %%ecx, _pbtemp         </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// save pb for later use</span>
<span class="normal">      </span><span class="comment">// pa = abs(pav)</span>
<span class="normal">      </span><span class="string">"movl _patemp, %%eax         </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"testl $0x80000000, %%eax    </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"jz paeth_paa                </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"negl %%eax                  </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// reverse sign of neg values</span>

<span class="normal">   </span><span class="string">"paeth_paa:                     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"movl %%eax, _patemp         </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// save pa for later use</span>
<span class="normal">      </span><span class="comment">// test if pa &lt;= pb</span>
<span class="normal">      </span><span class="string">"cmpl %%ecx, %%eax           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"jna paeth_abb               </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="comment">// pa &gt; pb; now test if pb &lt;= pc</span>
<span class="normal">      </span><span class="string">"cmpl _pctemp, %%ecx         </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"jna paeth_bbc               </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="comment">// pb &gt; pc; Raw(x) = Paeth(x) + Prior(x-bpp)</span>
<span class="normal">      </span><span class="string">"movb (%%esi,%%edx,), %%cl   </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// load Prior(x-bpp) into cl</span>
<span class="normal">      </span><span class="string">"jmp paeth_paeth             </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">   </span><span class="string">"paeth_bbc:                     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="comment">// pb &lt;= pc; Raw(x) = Paeth(x) + Prior(x)</span>
<span class="normal">      </span><span class="string">"movb (%%esi,%%ebx,), %%cl   </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// load Prior(x) into cl</span>
<span class="normal">      </span><span class="string">"jmp paeth_paeth             </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">   </span><span class="string">"paeth_abb:                     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="comment">// pa &lt;= pb; now test if pa &lt;= pc</span>
<span class="normal">      </span><span class="string">"cmpl _pctemp, %%eax         </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"jna paeth_abc               </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="comment">// pa &gt; pc; Raw(x) = Paeth(x) + Prior(x-bpp)</span>
<span class="normal">      </span><span class="string">"movb (%%esi,%%edx,), %%cl   </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// load Prior(x-bpp) into cl</span>
<span class="normal">      </span><span class="string">"jmp paeth_paeth             </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">   </span><span class="string">"paeth_abc:                     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="comment">// pa &lt;= pc; Raw(x) = Paeth(x) + Raw(x-bpp)</span>
<span class="normal">      </span><span class="string">"movb (%%edi,%%edx,), %%cl   </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// load Raw(x-bpp) into cl</span>

<span class="normal">   </span><span class="string">"paeth_paeth:                   </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"incl %%ebx                  </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"incl %%edx                  </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="comment">// Raw(x) = (Paeth(x) + Paeth_Predictor( a, b, c )) mod 256</span>
<span class="normal">      </span><span class="string">"addb %%cl, -1(%%edi,%%ebx,) </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"cmpl _dif, %%ebx            </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"jb paeth_lp1                </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">   </span><span class="string">"paeth_go:                      </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"movl _FullLength, %%ecx     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"movl %%ecx, %%eax           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"subl %%ebx, %%eax           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// subtract alignment fix</span>
<span class="normal">      </span><span class="string">"andl $0x00000007, %%eax     </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// calc bytes over mult of 8</span>
<span class="normal">      </span><span class="string">"subl %%eax, %%ecx           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// drop over bytes from original length</span>
<span class="normal">      </span><span class="string">"movl %%ecx, _MMXLength      </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="preproc">#ifdef</span><span class="normal"> __PIC__</span>
<span class="normal">      </span><span class="string">"popl %%ebx                  </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// restore index to Global Offset Table</span>
<span class="preproc">#endif</span>

<span class="normal">      </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"=c"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_c</span><span class="symbol">),</span><span class="normal">            </span><span class="comment">// output regs (dummy)</span>
<span class="normal">        </span><span class="string">"=S"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_S</span><span class="symbol">),</span>
<span class="normal">        </span><span class="string">"=D"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_D</span><span class="symbol">)</span>

<span class="normal">      </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"0"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">bpp</span><span class="symbol">),</span><span class="normal">       </span><span class="comment">// ecx          // input regs</span>
<span class="normal">        </span><span class="string">"1"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">prev_row</span><span class="symbol">),</span><span class="normal">  </span><span class="comment">// esi</span>
<span class="normal">        </span><span class="string">"2"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row</span><span class="symbol">)</span><span class="normal">        </span><span class="comment">// edi</span>

<span class="normal">      </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"%eax"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%edx"</span><span class="normal">                   </span><span class="comment">// clobber list</span>
<span class="preproc">#ifndef</span><span class="normal"> __PIC__</span>
<span class="normal">      </span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%ebx"</span>
<span class="preproc">#endif</span>
<span class="normal">   </span><span class="symbol">);</span>

<span class="normal">   </span><span class="comment">// now do the math for the rest of the row</span>
<span class="normal">   </span><span class="keyword">switch</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">bpp</span><span class="symbol">)</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="keyword">case</span><span class="normal"> </span><span class="number">3</span><span class="symbol">:</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         _ActiveMask</span><span class="symbol">.</span><span class="normal">use </span><span class="symbol">=</span><span class="normal"> 0x0000000000ffffffLL</span><span class="symbol">;</span>
<span class="normal">         _ActiveMaskEnd</span><span class="symbol">.</span><span class="normal">use </span><span class="symbol">=</span><span class="normal"> 0xffff000000000000LL</span><span class="symbol">;</span>
<span class="normal">         _ShiftBpp</span><span class="symbol">.</span><span class="normal">use </span><span class="symbol">=</span><span class="normal"> </span><span class="number">24</span><span class="symbol">;</span><span class="normal">    </span><span class="comment">// == bpp(3) * 8</span>
<span class="normal">         _ShiftRem</span><span class="symbol">.</span><span class="normal">use </span><span class="symbol">=</span><span class="normal"> </span><span class="number">40</span><span class="symbol">;</span><span class="normal">    </span><span class="comment">// == 64 - 24</span>

<span class="normal">         </span><span class="usertype">__asm__</span><span class="normal"> </span><span class="function">__volatile__</span><span class="normal"> </span><span class="symbol">(</span>
<span class="normal">            </span><span class="string">"movl _dif, %%ecx            </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="comment">// preload  "movl row, %%edi             \n\t"</span>
<span class="comment">// preload  "movl prev_row, %%esi        \n\t"</span>
<span class="normal">            </span><span class="string">"pxor %%mm0, %%mm0           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// prime the pump:  load the first Raw(x-bpp) data set</span>
<span class="normal">            </span><span class="string">"movq -8(%%edi,%%ecx,), %%mm1 </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">         </span><span class="string">"paeth_3lp:                     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"psrlq _ShiftRem, %%mm1      </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// shift last 3 bytes to 1st</span>
<span class="normal">                                               </span><span class="comment">// 3 bytes</span>
<span class="normal">            </span><span class="string">"movq (%%esi,%%ecx,), %%mm2  </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// load b=Prior(x)</span>
<span class="normal">            </span><span class="string">"punpcklbw %%mm0, %%mm1      </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// unpack High bytes of a</span>
<span class="normal">            </span><span class="string">"movq -8(%%esi,%%ecx,), %%mm3 </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// prep c=Prior(x-bpp) bytes</span>
<span class="normal">            </span><span class="string">"punpcklbw %%mm0, %%mm2      </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// unpack High bytes of b</span>
<span class="normal">            </span><span class="string">"psrlq _ShiftRem, %%mm3      </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// shift last 3 bytes to 1st</span>
<span class="normal">                                               </span><span class="comment">// 3 bytes</span>
<span class="normal">            </span><span class="comment">// pav = p - a = (a + b - c) - a = b - c</span>
<span class="normal">            </span><span class="string">"movq %%mm2, %%mm4           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"punpcklbw %%mm0, %%mm3      </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// unpack High bytes of c</span>
<span class="normal">            </span><span class="comment">// pbv = p - b = (a + b - c) - b = a - c</span>
<span class="normal">            </span><span class="string">"movq %%mm1, %%mm5           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"psubw %%mm3, %%mm4          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pxor %%mm7, %%mm7           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// pcv = p - c = (a + b - c) -c = (a - c) + (b - c) = pav + pbv</span>
<span class="normal">            </span><span class="string">"movq %%mm4, %%mm6           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"psubw %%mm3, %%mm5          </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">            </span><span class="comment">// pa = abs(p-a) = abs(pav)</span>
<span class="normal">            </span><span class="comment">// pb = abs(p-b) = abs(pbv)</span>
<span class="normal">            </span><span class="comment">// pc = abs(p-c) = abs(pcv)</span>
<span class="normal">            </span><span class="string">"pcmpgtw %%mm4, %%mm0        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// create mask pav bytes &lt; 0</span>
<span class="normal">            </span><span class="string">"paddw %%mm5, %%mm6          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pand %%mm4, %%mm0           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// only pav bytes &lt; 0 in mm7</span>
<span class="normal">            </span><span class="string">"pcmpgtw %%mm5, %%mm7        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// create mask pbv bytes &lt; 0</span>
<span class="normal">            </span><span class="string">"psubw %%mm0, %%mm4          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pand %%mm5, %%mm7           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// only pbv bytes &lt; 0 in mm0</span>
<span class="normal">            </span><span class="string">"psubw %%mm0, %%mm4          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"psubw %%mm7, %%mm5          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pxor %%mm0, %%mm0           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pcmpgtw %%mm6, %%mm0        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// create mask pcv bytes &lt; 0</span>
<span class="normal">            </span><span class="string">"pand %%mm6, %%mm0           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// only pav bytes &lt; 0 in mm7</span>
<span class="normal">            </span><span class="string">"psubw %%mm7, %%mm5          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"psubw %%mm0, %%mm6          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">//  test pa &lt;= pb</span>
<span class="normal">            </span><span class="string">"movq %%mm4, %%mm7           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"psubw %%mm0, %%mm6          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pcmpgtw %%mm5, %%mm7        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// pa &gt; pb?</span>
<span class="normal">            </span><span class="string">"movq %%mm7, %%mm0           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// use mm7 mask to merge pa &amp; pb</span>
<span class="normal">            </span><span class="string">"pand %%mm7, %%mm5           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// use mm0 mask copy to merge a &amp; b</span>
<span class="normal">            </span><span class="string">"pand %%mm0, %%mm2           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pandn %%mm4, %%mm7          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pandn %%mm1, %%mm0          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"paddw %%mm5, %%mm7          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"paddw %%mm2, %%mm0          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">//  test  ((pa &lt;= pb)? pa:pb) &lt;= pc</span>
<span class="normal">            </span><span class="string">"pcmpgtw %%mm6, %%mm7        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// pab &gt; pc?</span>
<span class="normal">            </span><span class="string">"pxor %%mm1, %%mm1           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pand %%mm7, %%mm3           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pandn %%mm0, %%mm7          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"paddw %%mm3, %%mm7          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pxor %%mm0, %%mm0           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"packuswb %%mm1, %%mm7       </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"movq (%%esi,%%ecx,), %%mm3  </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// load c=Prior(x-bpp)</span>
<span class="normal">            </span><span class="string">"pand _ActiveMask, %%mm7     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"movq %%mm3, %%mm2           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// load b=Prior(x) step 1</span>
<span class="normal">            </span><span class="string">"paddb (%%edi,%%ecx,), %%mm7 </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// add Paeth predictor with Raw(x)</span>
<span class="normal">            </span><span class="string">"punpcklbw %%mm0, %%mm3      </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// unpack High bytes of c</span>
<span class="normal">            </span><span class="string">"movq %%mm7, (%%edi,%%ecx,)  </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// write back updated value</span>
<span class="normal">            </span><span class="string">"movq %%mm7, %%mm1           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// now mm1 will be used as</span>
<span class="normal">                                               </span><span class="comment">// Raw(x-bpp)</span>
<span class="normal">            </span><span class="comment">// now do Paeth for 2nd set of bytes (3-5)</span>
<span class="normal">            </span><span class="string">"psrlq _ShiftBpp, %%mm2      </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// load b=Prior(x) step 2</span>
<span class="normal">            </span><span class="string">"punpcklbw %%mm0, %%mm1      </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// unpack High bytes of a</span>
<span class="normal">            </span><span class="string">"pxor %%mm7, %%mm7           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"punpcklbw %%mm0, %%mm2      </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// unpack High bytes of b</span>
<span class="normal">            </span><span class="comment">// pbv = p - b = (a + b - c) - b = a - c</span>
<span class="normal">            </span><span class="string">"movq %%mm1, %%mm5           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// pav = p - a = (a + b - c) - a = b - c</span>
<span class="normal">            </span><span class="string">"movq %%mm2, %%mm4           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"psubw %%mm3, %%mm5          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"psubw %%mm3, %%mm4          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// pcv = p - c = (a + b - c) -c = (a - c) + (b - c) =</span>
<span class="normal">            </span><span class="comment">//       pav + pbv = pbv + pav</span>
<span class="normal">            </span><span class="string">"movq %%mm5, %%mm6           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"paddw %%mm4, %%mm6          </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">            </span><span class="comment">// pa = abs(p-a) = abs(pav)</span>
<span class="normal">            </span><span class="comment">// pb = abs(p-b) = abs(pbv)</span>
<span class="normal">            </span><span class="comment">// pc = abs(p-c) = abs(pcv)</span>
<span class="normal">            </span><span class="string">"pcmpgtw %%mm5, %%mm0        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// create mask pbv bytes &lt; 0</span>
<span class="normal">            </span><span class="string">"pcmpgtw %%mm4, %%mm7        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// create mask pav bytes &lt; 0</span>
<span class="normal">            </span><span class="string">"pand %%mm5, %%mm0           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// only pbv bytes &lt; 0 in mm0</span>
<span class="normal">            </span><span class="string">"pand %%mm4, %%mm7           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// only pav bytes &lt; 0 in mm7</span>
<span class="normal">            </span><span class="string">"psubw %%mm0, %%mm5          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"psubw %%mm7, %%mm4          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"psubw %%mm0, %%mm5          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"psubw %%mm7, %%mm4          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pxor %%mm0, %%mm0           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pcmpgtw %%mm6, %%mm0        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// create mask pcv bytes &lt; 0</span>
<span class="normal">            </span><span class="string">"pand %%mm6, %%mm0           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// only pav bytes &lt; 0 in mm7</span>
<span class="normal">            </span><span class="string">"psubw %%mm0, %%mm6          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">//  test pa &lt;= pb</span>
<span class="normal">            </span><span class="string">"movq %%mm4, %%mm7           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"psubw %%mm0, %%mm6          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pcmpgtw %%mm5, %%mm7        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// pa &gt; pb?</span>
<span class="normal">            </span><span class="string">"movq %%mm7, %%mm0           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// use mm7 mask to merge pa &amp; pb</span>
<span class="normal">            </span><span class="string">"pand %%mm7, %%mm5           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// use mm0 mask copy to merge a &amp; b</span>
<span class="normal">            </span><span class="string">"pand %%mm0, %%mm2           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pandn %%mm4, %%mm7          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pandn %%mm1, %%mm0          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"paddw %%mm5, %%mm7          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"paddw %%mm2, %%mm0          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">//  test  ((pa &lt;= pb)? pa:pb) &lt;= pc</span>
<span class="normal">            </span><span class="string">"pcmpgtw %%mm6, %%mm7        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// pab &gt; pc?</span>
<span class="normal">            </span><span class="string">"movq (%%esi,%%ecx,), %%mm2  </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// load b=Prior(x)</span>
<span class="normal">            </span><span class="string">"pand %%mm7, %%mm3           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pandn %%mm0, %%mm7          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pxor %%mm1, %%mm1           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"paddw %%mm3, %%mm7          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pxor %%mm0, %%mm0           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"packuswb %%mm1, %%mm7       </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"movq %%mm2, %%mm3           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// load c=Prior(x-bpp) step 1</span>
<span class="normal">            </span><span class="string">"pand _ActiveMask, %%mm7     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"punpckhbw %%mm0, %%mm2      </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// unpack High bytes of b</span>
<span class="normal">            </span><span class="string">"psllq _ShiftBpp, %%mm7      </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// shift bytes to 2nd group of</span>
<span class="normal">                                               </span><span class="comment">// 3 bytes</span>
<span class="normal">             </span><span class="comment">// pav = p - a = (a + b - c) - a = b - c</span>
<span class="normal">            </span><span class="string">"movq %%mm2, %%mm4           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"paddb (%%edi,%%ecx,), %%mm7 </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// add Paeth predictor with Raw(x)</span>
<span class="normal">            </span><span class="string">"psllq _ShiftBpp, %%mm3      </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// load c=Prior(x-bpp) step 2</span>
<span class="normal">            </span><span class="string">"movq %%mm7, (%%edi,%%ecx,)  </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// write back updated value</span>
<span class="normal">            </span><span class="string">"movq %%mm7, %%mm1           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"punpckhbw %%mm0, %%mm3      </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// unpack High bytes of c</span>
<span class="normal">            </span><span class="string">"psllq _ShiftBpp, %%mm1      </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// shift bytes</span>
<span class="normal">                                    </span><span class="comment">// now mm1 will be used as Raw(x-bpp)</span>
<span class="normal">            </span><span class="comment">// now do Paeth for 3rd, and final, set of bytes (6-7)</span>
<span class="normal">            </span><span class="string">"pxor %%mm7, %%mm7           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"punpckhbw %%mm0, %%mm1      </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// unpack High bytes of a</span>
<span class="normal">            </span><span class="string">"psubw %%mm3, %%mm4          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// pbv = p - b = (a + b - c) - b = a - c</span>
<span class="normal">            </span><span class="string">"movq %%mm1, %%mm5           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// pcv = p - c = (a + b - c) -c = (a - c) + (b - c) = pav + pbv</span>
<span class="normal">            </span><span class="string">"movq %%mm4, %%mm6           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"psubw %%mm3, %%mm5          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pxor %%mm0, %%mm0           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"paddw %%mm5, %%mm6          </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">            </span><span class="comment">// pa = abs(p-a) = abs(pav)</span>
<span class="normal">            </span><span class="comment">// pb = abs(p-b) = abs(pbv)</span>
<span class="normal">            </span><span class="comment">// pc = abs(p-c) = abs(pcv)</span>
<span class="normal">            </span><span class="string">"pcmpgtw %%mm4, %%mm0        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// create mask pav bytes &lt; 0</span>
<span class="normal">            </span><span class="string">"pcmpgtw %%mm5, %%mm7        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// create mask pbv bytes &lt; 0</span>
<span class="normal">            </span><span class="string">"pand %%mm4, %%mm0           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// only pav bytes &lt; 0 in mm7</span>
<span class="normal">            </span><span class="string">"pand %%mm5, %%mm7           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// only pbv bytes &lt; 0 in mm0</span>
<span class="normal">            </span><span class="string">"psubw %%mm0, %%mm4          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"psubw %%mm7, %%mm5          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"psubw %%mm0, %%mm4          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"psubw %%mm7, %%mm5          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pxor %%mm0, %%mm0           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pcmpgtw %%mm6, %%mm0        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// create mask pcv bytes &lt; 0</span>
<span class="normal">            </span><span class="string">"pand %%mm6, %%mm0           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// only pav bytes &lt; 0 in mm7</span>
<span class="normal">            </span><span class="string">"psubw %%mm0, %%mm6          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">//  test pa &lt;= pb</span>
<span class="normal">            </span><span class="string">"movq %%mm4, %%mm7           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"psubw %%mm0, %%mm6          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pcmpgtw %%mm5, %%mm7        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// pa &gt; pb?</span>
<span class="normal">            </span><span class="string">"movq %%mm7, %%mm0           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// use mm0 mask copy to merge a &amp; b</span>
<span class="normal">            </span><span class="string">"pand %%mm0, %%mm2           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// use mm7 mask to merge pa &amp; pb</span>
<span class="normal">            </span><span class="string">"pand %%mm7, %%mm5           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pandn %%mm1, %%mm0          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pandn %%mm4, %%mm7          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"paddw %%mm2, %%mm0          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"paddw %%mm5, %%mm7          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">//  test  ((pa &lt;= pb)? pa:pb) &lt;= pc</span>
<span class="normal">            </span><span class="string">"pcmpgtw %%mm6, %%mm7        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// pab &gt; pc?</span>
<span class="normal">            </span><span class="string">"pand %%mm7, %%mm3           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pandn %%mm0, %%mm7          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"paddw %%mm3, %%mm7          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pxor %%mm1, %%mm1           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"packuswb %%mm7, %%mm1       </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// step ecx to next set of 8 bytes and repeat loop til done</span>
<span class="normal">            </span><span class="string">"addl $8, %%ecx              </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pand _ActiveMaskEnd, %%mm1  </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"paddb -8(%%edi,%%ecx,), %%mm1 </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// add Paeth predictor with</span>
<span class="normal">                                                 </span><span class="comment">// Raw(x)</span>

<span class="normal">            </span><span class="string">"cmpl _MMXLength, %%ecx      </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pxor %%mm0, %%mm0           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// pxor does not affect flags</span>
<span class="normal">            </span><span class="string">"movq %%mm1, -8(%%edi,%%ecx,) </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// write back updated value</span>
<span class="normal">                                 </span><span class="comment">// mm1 will be used as Raw(x-bpp) next loop</span>
<span class="normal">                           </span><span class="comment">// mm3 ready to be used as Prior(x-bpp) next loop</span>
<span class="normal">            </span><span class="string">"jb paeth_3lp                </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">            </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"=S"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_S</span><span class="symbol">),</span><span class="normal">             </span><span class="comment">// output regs (dummy)</span>
<span class="normal">              </span><span class="string">"=D"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_D</span><span class="symbol">)</span>

<span class="normal">            </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"0"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">prev_row</span><span class="symbol">),</span><span class="normal">  </span><span class="comment">// esi           // input regs</span>
<span class="normal">              </span><span class="string">"1"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row</span><span class="symbol">)</span><span class="normal">        </span><span class="comment">// edi</span>

<span class="normal">            </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"%ecx"</span><span class="normal">                            </span><span class="comment">// clobber list</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="number">0</span><span class="normal">  </span><span class="comment">/* %mm0, ..., %mm7 not supported by gcc 2.7.2.3 or egcs 1.1 */</span>
<span class="normal">            </span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm0"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm1"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm2"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm3"</span>
<span class="normal">            </span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm4"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm5"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm6"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm7"</span>
<span class="preproc">#endif</span>
<span class="normal">         </span><span class="symbol">);</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="keyword">break</span><span class="symbol">;</span><span class="normal">  </span><span class="comment">// end 3 bpp</span>

<span class="normal">      </span><span class="keyword">case</span><span class="normal"> </span><span class="number">6</span><span class="symbol">:</span>
<span class="normal">      </span><span class="comment">//case 7:   // GRR BOGUS</span>
<span class="normal">      </span><span class="comment">//case 5:   // GRR BOGUS</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         _ActiveMask</span><span class="symbol">.</span><span class="normal">use  </span><span class="symbol">=</span><span class="normal"> 0x00000000ffffffffLL</span><span class="symbol">;</span>
<span class="normal">         _ActiveMask2</span><span class="symbol">.</span><span class="normal">use </span><span class="symbol">=</span><span class="normal"> 0xffffffff00000000LL</span><span class="symbol">;</span>
<span class="normal">         _ShiftBpp</span><span class="symbol">.</span><span class="normal">use </span><span class="symbol">=</span><span class="normal"> bpp </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">3</span><span class="symbol">;</span><span class="normal">    </span><span class="comment">// == bpp * 8</span>
<span class="normal">         _ShiftRem</span><span class="symbol">.</span><span class="normal">use </span><span class="symbol">=</span><span class="normal"> </span><span class="number">64</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> _ShiftBpp</span><span class="symbol">.</span><span class="normal">use</span><span class="symbol">;</span>

<span class="normal">         </span><span class="usertype">__asm__</span><span class="normal"> </span><span class="function">__volatile__</span><span class="normal"> </span><span class="symbol">(</span>
<span class="normal">            </span><span class="string">"movl _dif, %%ecx            </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="comment">// preload  "movl row, %%edi             \n\t"</span>
<span class="comment">// preload  "movl prev_row, %%esi        \n\t"</span>
<span class="normal">            </span><span class="comment">// prime the pump:  load the first Raw(x-bpp) data set</span>
<span class="normal">            </span><span class="string">"movq -8(%%edi,%%ecx,), %%mm1 </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pxor %%mm0, %%mm0           </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">         </span><span class="string">"paeth_6lp:                     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// must shift to position Raw(x-bpp) data</span>
<span class="normal">            </span><span class="string">"psrlq _ShiftRem, %%mm1      </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// do first set of 4 bytes</span>
<span class="normal">            </span><span class="string">"movq -8(%%esi,%%ecx,), %%mm3 </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// read c=Prior(x-bpp) bytes</span>
<span class="normal">            </span><span class="string">"punpcklbw %%mm0, %%mm1      </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// unpack Low bytes of a</span>
<span class="normal">            </span><span class="string">"movq (%%esi,%%ecx,), %%mm2  </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// load b=Prior(x)</span>
<span class="normal">            </span><span class="string">"punpcklbw %%mm0, %%mm2      </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// unpack Low bytes of b</span>
<span class="normal">            </span><span class="comment">// must shift to position Prior(x-bpp) data</span>
<span class="normal">            </span><span class="string">"psrlq _ShiftRem, %%mm3      </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// pav = p - a = (a + b - c) - a = b - c</span>
<span class="normal">            </span><span class="string">"movq %%mm2, %%mm4           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"punpcklbw %%mm0, %%mm3      </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// unpack Low bytes of c</span>
<span class="normal">            </span><span class="comment">// pbv = p - b = (a + b - c) - b = a - c</span>
<span class="normal">            </span><span class="string">"movq %%mm1, %%mm5           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"psubw %%mm3, %%mm4          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pxor %%mm7, %%mm7           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// pcv = p - c = (a + b - c) -c = (a - c) + (b - c) = pav + pbv</span>
<span class="normal">            </span><span class="string">"movq %%mm4, %%mm6           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"psubw %%mm3, %%mm5          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// pa = abs(p-a) = abs(pav)</span>
<span class="normal">            </span><span class="comment">// pb = abs(p-b) = abs(pbv)</span>
<span class="normal">            </span><span class="comment">// pc = abs(p-c) = abs(pcv)</span>
<span class="normal">            </span><span class="string">"pcmpgtw %%mm4, %%mm0        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// create mask pav bytes &lt; 0</span>
<span class="normal">            </span><span class="string">"paddw %%mm5, %%mm6          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pand %%mm4, %%mm0           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// only pav bytes &lt; 0 in mm7</span>
<span class="normal">            </span><span class="string">"pcmpgtw %%mm5, %%mm7        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// create mask pbv bytes &lt; 0</span>
<span class="normal">            </span><span class="string">"psubw %%mm0, %%mm4          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pand %%mm5, %%mm7           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// only pbv bytes &lt; 0 in mm0</span>
<span class="normal">            </span><span class="string">"psubw %%mm0, %%mm4          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"psubw %%mm7, %%mm5          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pxor %%mm0, %%mm0           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pcmpgtw %%mm6, %%mm0        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// create mask pcv bytes &lt; 0</span>
<span class="normal">            </span><span class="string">"pand %%mm6, %%mm0           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// only pav bytes &lt; 0 in mm7</span>
<span class="normal">            </span><span class="string">"psubw %%mm7, %%mm5          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"psubw %%mm0, %%mm6          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">//  test pa &lt;= pb</span>
<span class="normal">            </span><span class="string">"movq %%mm4, %%mm7           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"psubw %%mm0, %%mm6          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pcmpgtw %%mm5, %%mm7        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// pa &gt; pb?</span>
<span class="normal">            </span><span class="string">"movq %%mm7, %%mm0           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// use mm7 mask to merge pa &amp; pb</span>
<span class="normal">            </span><span class="string">"pand %%mm7, %%mm5           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// use mm0 mask copy to merge a &amp; b</span>
<span class="normal">            </span><span class="string">"pand %%mm0, %%mm2           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pandn %%mm4, %%mm7          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pandn %%mm1, %%mm0          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"paddw %%mm5, %%mm7          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"paddw %%mm2, %%mm0          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">//  test  ((pa &lt;= pb)? pa:pb) &lt;= pc</span>
<span class="normal">            </span><span class="string">"pcmpgtw %%mm6, %%mm7        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// pab &gt; pc?</span>
<span class="normal">            </span><span class="string">"pxor %%mm1, %%mm1           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pand %%mm7, %%mm3           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pandn %%mm0, %%mm7          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"paddw %%mm3, %%mm7          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pxor %%mm0, %%mm0           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"packuswb %%mm1, %%mm7       </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"movq -8(%%esi,%%ecx,), %%mm3 </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// load c=Prior(x-bpp)</span>
<span class="normal">            </span><span class="string">"pand _ActiveMask, %%mm7     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"psrlq _ShiftRem, %%mm3      </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"movq (%%esi,%%ecx,), %%mm2  </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// load b=Prior(x) step 1</span>
<span class="normal">            </span><span class="string">"paddb (%%edi,%%ecx,), %%mm7 </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// add Paeth predictor and Raw(x)</span>
<span class="normal">            </span><span class="string">"movq %%mm2, %%mm6           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"movq %%mm7, (%%edi,%%ecx,)  </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// write back updated value</span>
<span class="normal">            </span><span class="string">"movq -8(%%edi,%%ecx,), %%mm1 </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"psllq _ShiftBpp, %%mm6      </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"movq %%mm7, %%mm5           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"psrlq _ShiftRem, %%mm1      </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"por %%mm6, %%mm3            </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"psllq _ShiftBpp, %%mm5      </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"punpckhbw %%mm0, %%mm3      </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// unpack High bytes of c</span>
<span class="normal">            </span><span class="string">"por %%mm5, %%mm1            </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// do second set of 4 bytes</span>
<span class="normal">            </span><span class="string">"punpckhbw %%mm0, %%mm2      </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// unpack High bytes of b</span>
<span class="normal">            </span><span class="string">"punpckhbw %%mm0, %%mm1      </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// unpack High bytes of a</span>
<span class="normal">            </span><span class="comment">// pav = p - a = (a + b - c) - a = b - c</span>
<span class="normal">            </span><span class="string">"movq %%mm2, %%mm4           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// pbv = p - b = (a + b - c) - b = a - c</span>
<span class="normal">            </span><span class="string">"movq %%mm1, %%mm5           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"psubw %%mm3, %%mm4          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pxor %%mm7, %%mm7           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// pcv = p - c = (a + b - c) -c = (a - c) + (b - c) = pav + pbv</span>
<span class="normal">            </span><span class="string">"movq %%mm4, %%mm6           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"psubw %%mm3, %%mm5          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// pa = abs(p-a) = abs(pav)</span>
<span class="normal">            </span><span class="comment">// pb = abs(p-b) = abs(pbv)</span>
<span class="normal">            </span><span class="comment">// pc = abs(p-c) = abs(pcv)</span>
<span class="normal">            </span><span class="string">"pcmpgtw %%mm4, %%mm0        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// create mask pav bytes &lt; 0</span>
<span class="normal">            </span><span class="string">"paddw %%mm5, %%mm6          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pand %%mm4, %%mm0           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// only pav bytes &lt; 0 in mm7</span>
<span class="normal">            </span><span class="string">"pcmpgtw %%mm5, %%mm7        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// create mask pbv bytes &lt; 0</span>
<span class="normal">            </span><span class="string">"psubw %%mm0, %%mm4          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pand %%mm5, %%mm7           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// only pbv bytes &lt; 0 in mm0</span>
<span class="normal">            </span><span class="string">"psubw %%mm0, %%mm4          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"psubw %%mm7, %%mm5          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pxor %%mm0, %%mm0           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pcmpgtw %%mm6, %%mm0        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// create mask pcv bytes &lt; 0</span>
<span class="normal">            </span><span class="string">"pand %%mm6, %%mm0           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// only pav bytes &lt; 0 in mm7</span>
<span class="normal">            </span><span class="string">"psubw %%mm7, %%mm5          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"psubw %%mm0, %%mm6          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">//  test pa &lt;= pb</span>
<span class="normal">            </span><span class="string">"movq %%mm4, %%mm7           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"psubw %%mm0, %%mm6          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pcmpgtw %%mm5, %%mm7        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// pa &gt; pb?</span>
<span class="normal">            </span><span class="string">"movq %%mm7, %%mm0           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// use mm7 mask to merge pa &amp; pb</span>
<span class="normal">            </span><span class="string">"pand %%mm7, %%mm5           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// use mm0 mask copy to merge a &amp; b</span>
<span class="normal">            </span><span class="string">"pand %%mm0, %%mm2           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pandn %%mm4, %%mm7          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pandn %%mm1, %%mm0          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"paddw %%mm5, %%mm7          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"paddw %%mm2, %%mm0          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">//  test  ((pa &lt;= pb)? pa:pb) &lt;= pc</span>
<span class="normal">            </span><span class="string">"pcmpgtw %%mm6, %%mm7        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// pab &gt; pc?</span>
<span class="normal">            </span><span class="string">"pxor %%mm1, %%mm1           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pand %%mm7, %%mm3           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pandn %%mm0, %%mm7          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pxor %%mm1, %%mm1           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"paddw %%mm3, %%mm7          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pxor %%mm0, %%mm0           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// step ecx to next set of 8 bytes and repeat loop til done</span>
<span class="normal">            </span><span class="string">"addl $8, %%ecx              </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"packuswb %%mm7, %%mm1       </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"paddb -8(%%edi,%%ecx,), %%mm1 </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// add Paeth predictor with Raw(x)</span>
<span class="normal">            </span><span class="string">"cmpl _MMXLength, %%ecx      </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"movq %%mm1, -8(%%edi,%%ecx,) </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// write back updated value</span>
<span class="normal">                                </span><span class="comment">// mm1 will be used as Raw(x-bpp) next loop</span>
<span class="normal">            </span><span class="string">"jb paeth_6lp                </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">            </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"=S"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_S</span><span class="symbol">),</span><span class="normal">             </span><span class="comment">// output regs (dummy)</span>
<span class="normal">              </span><span class="string">"=D"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_D</span><span class="symbol">)</span>

<span class="normal">            </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"0"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">prev_row</span><span class="symbol">),</span><span class="normal">  </span><span class="comment">// esi           // input regs</span>
<span class="normal">              </span><span class="string">"1"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row</span><span class="symbol">)</span><span class="normal">        </span><span class="comment">// edi</span>

<span class="normal">            </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"%ecx"</span><span class="normal">                            </span><span class="comment">// clobber list</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="number">0</span><span class="normal">  </span><span class="comment">/* %mm0, ..., %mm7 not supported by gcc 2.7.2.3 or egcs 1.1 */</span>
<span class="normal">            </span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm0"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm1"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm2"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm3"</span>
<span class="normal">            </span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm4"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm5"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm6"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm7"</span>
<span class="preproc">#endif</span>
<span class="normal">         </span><span class="symbol">);</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="keyword">break</span><span class="symbol">;</span><span class="normal">  </span><span class="comment">// end 6 bpp</span>

<span class="normal">      </span><span class="keyword">case</span><span class="normal"> </span><span class="number">4</span><span class="symbol">:</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         _ActiveMask</span><span class="symbol">.</span><span class="normal">use  </span><span class="symbol">=</span><span class="normal"> 0x00000000ffffffffLL</span><span class="symbol">;</span>

<span class="normal">         </span><span class="usertype">__asm__</span><span class="normal"> </span><span class="function">__volatile__</span><span class="normal"> </span><span class="symbol">(</span>
<span class="normal">            </span><span class="string">"movl _dif, %%ecx            </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="comment">// preload  "movl row, %%edi             \n\t"</span>
<span class="comment">// preload  "movl prev_row, %%esi        \n\t"</span>
<span class="normal">            </span><span class="string">"pxor %%mm0, %%mm0           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// prime the pump:  load the first Raw(x-bpp) data set</span>
<span class="normal">            </span><span class="string">"movq -8(%%edi,%%ecx,), %%mm1 </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// only time should need to read</span>
<span class="normal">                                     </span><span class="comment">//  a=Raw(x-bpp) bytes</span>
<span class="normal">         </span><span class="string">"paeth_4lp:                     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// do first set of 4 bytes</span>
<span class="normal">            </span><span class="string">"movq -8(%%esi,%%ecx,), %%mm3 </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// read c=Prior(x-bpp) bytes</span>
<span class="normal">            </span><span class="string">"punpckhbw %%mm0, %%mm1      </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// unpack Low bytes of a</span>
<span class="normal">            </span><span class="string">"movq (%%esi,%%ecx,), %%mm2  </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// load b=Prior(x)</span>
<span class="normal">            </span><span class="string">"punpcklbw %%mm0, %%mm2      </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// unpack High bytes of b</span>
<span class="normal">            </span><span class="comment">// pav = p - a = (a + b - c) - a = b - c</span>
<span class="normal">            </span><span class="string">"movq %%mm2, %%mm4           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"punpckhbw %%mm0, %%mm3      </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// unpack High bytes of c</span>
<span class="normal">            </span><span class="comment">// pbv = p - b = (a + b - c) - b = a - c</span>
<span class="normal">            </span><span class="string">"movq %%mm1, %%mm5           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"psubw %%mm3, %%mm4          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pxor %%mm7, %%mm7           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// pcv = p - c = (a + b - c) -c = (a - c) + (b - c) = pav + pbv</span>
<span class="normal">            </span><span class="string">"movq %%mm4, %%mm6           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"psubw %%mm3, %%mm5          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// pa = abs(p-a) = abs(pav)</span>
<span class="normal">            </span><span class="comment">// pb = abs(p-b) = abs(pbv)</span>
<span class="normal">            </span><span class="comment">// pc = abs(p-c) = abs(pcv)</span>
<span class="normal">            </span><span class="string">"pcmpgtw %%mm4, %%mm0        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// create mask pav bytes &lt; 0</span>
<span class="normal">            </span><span class="string">"paddw %%mm5, %%mm6          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pand %%mm4, %%mm0           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// only pav bytes &lt; 0 in mm7</span>
<span class="normal">            </span><span class="string">"pcmpgtw %%mm5, %%mm7        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// create mask pbv bytes &lt; 0</span>
<span class="normal">            </span><span class="string">"psubw %%mm0, %%mm4          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pand %%mm5, %%mm7           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// only pbv bytes &lt; 0 in mm0</span>
<span class="normal">            </span><span class="string">"psubw %%mm0, %%mm4          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"psubw %%mm7, %%mm5          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pxor %%mm0, %%mm0           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pcmpgtw %%mm6, %%mm0        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// create mask pcv bytes &lt; 0</span>
<span class="normal">            </span><span class="string">"pand %%mm6, %%mm0           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// only pav bytes &lt; 0 in mm7</span>
<span class="normal">            </span><span class="string">"psubw %%mm7, %%mm5          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"psubw %%mm0, %%mm6          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">//  test pa &lt;= pb</span>
<span class="normal">            </span><span class="string">"movq %%mm4, %%mm7           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"psubw %%mm0, %%mm6          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pcmpgtw %%mm5, %%mm7        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// pa &gt; pb?</span>
<span class="normal">            </span><span class="string">"movq %%mm7, %%mm0           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// use mm7 mask to merge pa &amp; pb</span>
<span class="normal">            </span><span class="string">"pand %%mm7, %%mm5           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// use mm0 mask copy to merge a &amp; b</span>
<span class="normal">            </span><span class="string">"pand %%mm0, %%mm2           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pandn %%mm4, %%mm7          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pandn %%mm1, %%mm0          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"paddw %%mm5, %%mm7          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"paddw %%mm2, %%mm0          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">//  test  ((pa &lt;= pb)? pa:pb) &lt;= pc</span>
<span class="normal">            </span><span class="string">"pcmpgtw %%mm6, %%mm7        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// pab &gt; pc?</span>
<span class="normal">            </span><span class="string">"pxor %%mm1, %%mm1           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pand %%mm7, %%mm3           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pandn %%mm0, %%mm7          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"paddw %%mm3, %%mm7          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pxor %%mm0, %%mm0           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"packuswb %%mm1, %%mm7       </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"movq (%%esi,%%ecx,), %%mm3  </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// load c=Prior(x-bpp)</span>
<span class="normal">            </span><span class="string">"pand _ActiveMask, %%mm7     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"movq %%mm3, %%mm2           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// load b=Prior(x) step 1</span>
<span class="normal">            </span><span class="string">"paddb (%%edi,%%ecx,), %%mm7 </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// add Paeth predictor with Raw(x)</span>
<span class="normal">            </span><span class="string">"punpcklbw %%mm0, %%mm3      </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// unpack High bytes of c</span>
<span class="normal">            </span><span class="string">"movq %%mm7, (%%edi,%%ecx,)  </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// write back updated value</span>
<span class="normal">            </span><span class="string">"movq %%mm7, %%mm1           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// now mm1 will be used as Raw(x-bpp)</span>
<span class="normal">            </span><span class="comment">// do second set of 4 bytes</span>
<span class="normal">            </span><span class="string">"punpckhbw %%mm0, %%mm2      </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// unpack Low bytes of b</span>
<span class="normal">            </span><span class="string">"punpcklbw %%mm0, %%mm1      </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// unpack Low bytes of a</span>
<span class="normal">            </span><span class="comment">// pav = p - a = (a + b - c) - a = b - c</span>
<span class="normal">            </span><span class="string">"movq %%mm2, %%mm4           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// pbv = p - b = (a + b - c) - b = a - c</span>
<span class="normal">            </span><span class="string">"movq %%mm1, %%mm5           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"psubw %%mm3, %%mm4          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pxor %%mm7, %%mm7           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// pcv = p - c = (a + b - c) -c = (a - c) + (b - c) = pav + pbv</span>
<span class="normal">            </span><span class="string">"movq %%mm4, %%mm6           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"psubw %%mm3, %%mm5          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// pa = abs(p-a) = abs(pav)</span>
<span class="normal">            </span><span class="comment">// pb = abs(p-b) = abs(pbv)</span>
<span class="normal">            </span><span class="comment">// pc = abs(p-c) = abs(pcv)</span>
<span class="normal">            </span><span class="string">"pcmpgtw %%mm4, %%mm0        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// create mask pav bytes &lt; 0</span>
<span class="normal">            </span><span class="string">"paddw %%mm5, %%mm6          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pand %%mm4, %%mm0           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// only pav bytes &lt; 0 in mm7</span>
<span class="normal">            </span><span class="string">"pcmpgtw %%mm5, %%mm7        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// create mask pbv bytes &lt; 0</span>
<span class="normal">            </span><span class="string">"psubw %%mm0, %%mm4          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pand %%mm5, %%mm7           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// only pbv bytes &lt; 0 in mm0</span>
<span class="normal">            </span><span class="string">"psubw %%mm0, %%mm4          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"psubw %%mm7, %%mm5          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pxor %%mm0, %%mm0           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pcmpgtw %%mm6, %%mm0        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// create mask pcv bytes &lt; 0</span>
<span class="normal">            </span><span class="string">"pand %%mm6, %%mm0           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// only pav bytes &lt; 0 in mm7</span>
<span class="normal">            </span><span class="string">"psubw %%mm7, %%mm5          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"psubw %%mm0, %%mm6          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">//  test pa &lt;= pb</span>
<span class="normal">            </span><span class="string">"movq %%mm4, %%mm7           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"psubw %%mm0, %%mm6          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pcmpgtw %%mm5, %%mm7        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// pa &gt; pb?</span>
<span class="normal">            </span><span class="string">"movq %%mm7, %%mm0           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// use mm7 mask to merge pa &amp; pb</span>
<span class="normal">            </span><span class="string">"pand %%mm7, %%mm5           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// use mm0 mask copy to merge a &amp; b</span>
<span class="normal">            </span><span class="string">"pand %%mm0, %%mm2           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pandn %%mm4, %%mm7          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pandn %%mm1, %%mm0          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"paddw %%mm5, %%mm7          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"paddw %%mm2, %%mm0          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">//  test  ((pa &lt;= pb)? pa:pb) &lt;= pc</span>
<span class="normal">            </span><span class="string">"pcmpgtw %%mm6, %%mm7        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// pab &gt; pc?</span>
<span class="normal">            </span><span class="string">"pxor %%mm1, %%mm1           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pand %%mm7, %%mm3           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pandn %%mm0, %%mm7          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pxor %%mm1, %%mm1           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"paddw %%mm3, %%mm7          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pxor %%mm0, %%mm0           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// step ecx to next set of 8 bytes and repeat loop til done</span>
<span class="normal">            </span><span class="string">"addl $8, %%ecx              </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"packuswb %%mm7, %%mm1       </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"paddb -8(%%edi,%%ecx,), %%mm1 </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// add predictor with Raw(x)</span>
<span class="normal">            </span><span class="string">"cmpl _MMXLength, %%ecx      </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"movq %%mm1, -8(%%edi,%%ecx,) </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// write back updated value</span>
<span class="normal">                                </span><span class="comment">// mm1 will be used as Raw(x-bpp) next loop</span>
<span class="normal">            </span><span class="string">"jb paeth_4lp                </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">            </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"=S"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_S</span><span class="symbol">),</span><span class="normal">             </span><span class="comment">// output regs (dummy)</span>
<span class="normal">              </span><span class="string">"=D"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_D</span><span class="symbol">)</span>

<span class="normal">            </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"0"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">prev_row</span><span class="symbol">),</span><span class="normal">  </span><span class="comment">// esi           // input regs</span>
<span class="normal">              </span><span class="string">"1"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row</span><span class="symbol">)</span><span class="normal">        </span><span class="comment">// edi</span>

<span class="normal">            </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"%ecx"</span><span class="normal">                            </span><span class="comment">// clobber list</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="number">0</span><span class="normal">  </span><span class="comment">/* %mm0, ..., %mm7 not supported by gcc 2.7.2.3 or egcs 1.1 */</span>
<span class="normal">            </span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm0"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm1"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm2"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm3"</span>
<span class="normal">            </span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm4"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm5"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm6"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm7"</span>
<span class="preproc">#endif</span>
<span class="normal">         </span><span class="symbol">);</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="keyword">break</span><span class="symbol">;</span><span class="normal">  </span><span class="comment">// end 4 bpp</span>

<span class="normal">      </span><span class="keyword">case</span><span class="normal"> </span><span class="number">8</span><span class="symbol">:</span><span class="normal">                          </span><span class="comment">// bpp == 8</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         _ActiveMask</span><span class="symbol">.</span><span class="normal">use  </span><span class="symbol">=</span><span class="normal"> 0x00000000ffffffffLL</span><span class="symbol">;</span>

<span class="normal">         </span><span class="usertype">__asm__</span><span class="normal"> </span><span class="function">__volatile__</span><span class="normal"> </span><span class="symbol">(</span>
<span class="normal">            </span><span class="string">"movl _dif, %%ecx            </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="comment">// preload  "movl row, %%edi             \n\t"</span>
<span class="comment">// preload  "movl prev_row, %%esi        \n\t"</span>
<span class="normal">            </span><span class="string">"pxor %%mm0, %%mm0           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// prime the pump:  load the first Raw(x-bpp) data set</span>
<span class="normal">            </span><span class="string">"movq -8(%%edi,%%ecx,), %%mm1 </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// only time should need to read</span>
<span class="normal">                                       </span><span class="comment">//  a=Raw(x-bpp) bytes</span>
<span class="normal">         </span><span class="string">"paeth_8lp:                     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// do first set of 4 bytes</span>
<span class="normal">            </span><span class="string">"movq -8(%%esi,%%ecx,), %%mm3 </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// read c=Prior(x-bpp) bytes</span>
<span class="normal">            </span><span class="string">"punpcklbw %%mm0, %%mm1      </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// unpack Low bytes of a</span>
<span class="normal">            </span><span class="string">"movq (%%esi,%%ecx,), %%mm2  </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// load b=Prior(x)</span>
<span class="normal">            </span><span class="string">"punpcklbw %%mm0, %%mm2      </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// unpack Low bytes of b</span>
<span class="normal">            </span><span class="comment">// pav = p - a = (a + b - c) - a = b - c</span>
<span class="normal">            </span><span class="string">"movq %%mm2, %%mm4           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"punpcklbw %%mm0, %%mm3      </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// unpack Low bytes of c</span>
<span class="normal">            </span><span class="comment">// pbv = p - b = (a + b - c) - b = a - c</span>
<span class="normal">            </span><span class="string">"movq %%mm1, %%mm5           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"psubw %%mm3, %%mm4          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pxor %%mm7, %%mm7           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// pcv = p - c = (a + b - c) -c = (a - c) + (b - c) = pav + pbv</span>
<span class="normal">            </span><span class="string">"movq %%mm4, %%mm6           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"psubw %%mm3, %%mm5          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// pa = abs(p-a) = abs(pav)</span>
<span class="normal">            </span><span class="comment">// pb = abs(p-b) = abs(pbv)</span>
<span class="normal">            </span><span class="comment">// pc = abs(p-c) = abs(pcv)</span>
<span class="normal">            </span><span class="string">"pcmpgtw %%mm4, %%mm0        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// create mask pav bytes &lt; 0</span>
<span class="normal">            </span><span class="string">"paddw %%mm5, %%mm6          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pand %%mm4, %%mm0           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// only pav bytes &lt; 0 in mm7</span>
<span class="normal">            </span><span class="string">"pcmpgtw %%mm5, %%mm7        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// create mask pbv bytes &lt; 0</span>
<span class="normal">            </span><span class="string">"psubw %%mm0, %%mm4          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pand %%mm5, %%mm7           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// only pbv bytes &lt; 0 in mm0</span>
<span class="normal">            </span><span class="string">"psubw %%mm0, %%mm4          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"psubw %%mm7, %%mm5          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pxor %%mm0, %%mm0           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pcmpgtw %%mm6, %%mm0        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// create mask pcv bytes &lt; 0</span>
<span class="normal">            </span><span class="string">"pand %%mm6, %%mm0           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// only pav bytes &lt; 0 in mm7</span>
<span class="normal">            </span><span class="string">"psubw %%mm7, %%mm5          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"psubw %%mm0, %%mm6          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">//  test pa &lt;= pb</span>
<span class="normal">            </span><span class="string">"movq %%mm4, %%mm7           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"psubw %%mm0, %%mm6          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pcmpgtw %%mm5, %%mm7        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// pa &gt; pb?</span>
<span class="normal">            </span><span class="string">"movq %%mm7, %%mm0           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// use mm7 mask to merge pa &amp; pb</span>
<span class="normal">            </span><span class="string">"pand %%mm7, %%mm5           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// use mm0 mask copy to merge a &amp; b</span>
<span class="normal">            </span><span class="string">"pand %%mm0, %%mm2           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pandn %%mm4, %%mm7          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pandn %%mm1, %%mm0          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"paddw %%mm5, %%mm7          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"paddw %%mm2, %%mm0          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">//  test  ((pa &lt;= pb)? pa:pb) &lt;= pc</span>
<span class="normal">            </span><span class="string">"pcmpgtw %%mm6, %%mm7        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// pab &gt; pc?</span>
<span class="normal">            </span><span class="string">"pxor %%mm1, %%mm1           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pand %%mm7, %%mm3           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pandn %%mm0, %%mm7          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"paddw %%mm3, %%mm7          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pxor %%mm0, %%mm0           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"packuswb %%mm1, %%mm7       </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"movq -8(%%esi,%%ecx,), %%mm3 </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// read c=Prior(x-bpp) bytes</span>
<span class="normal">            </span><span class="string">"pand _ActiveMask, %%mm7     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"movq (%%esi,%%ecx,), %%mm2  </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// load b=Prior(x)</span>
<span class="normal">            </span><span class="string">"paddb (%%edi,%%ecx,), %%mm7 </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// add Paeth predictor with Raw(x)</span>
<span class="normal">            </span><span class="string">"punpckhbw %%mm0, %%mm3      </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// unpack High bytes of c</span>
<span class="normal">            </span><span class="string">"movq %%mm7, (%%edi,%%ecx,)  </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// write back updated value</span>
<span class="normal">            </span><span class="string">"movq -8(%%edi,%%ecx,), %%mm1 </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// read a=Raw(x-bpp) bytes</span>

<span class="normal">            </span><span class="comment">// do second set of 4 bytes</span>
<span class="normal">            </span><span class="string">"punpckhbw %%mm0, %%mm2      </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// unpack High bytes of b</span>
<span class="normal">            </span><span class="string">"punpckhbw %%mm0, %%mm1      </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// unpack High bytes of a</span>
<span class="normal">            </span><span class="comment">// pav = p - a = (a + b - c) - a = b - c</span>
<span class="normal">            </span><span class="string">"movq %%mm2, %%mm4           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// pbv = p - b = (a + b - c) - b = a - c</span>
<span class="normal">            </span><span class="string">"movq %%mm1, %%mm5           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"psubw %%mm3, %%mm4          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pxor %%mm7, %%mm7           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// pcv = p - c = (a + b - c) -c = (a - c) + (b - c) = pav + pbv</span>
<span class="normal">            </span><span class="string">"movq %%mm4, %%mm6           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"psubw %%mm3, %%mm5          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// pa = abs(p-a) = abs(pav)</span>
<span class="normal">            </span><span class="comment">// pb = abs(p-b) = abs(pbv)</span>
<span class="normal">            </span><span class="comment">// pc = abs(p-c) = abs(pcv)</span>
<span class="normal">            </span><span class="string">"pcmpgtw %%mm4, %%mm0        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// create mask pav bytes &lt; 0</span>
<span class="normal">            </span><span class="string">"paddw %%mm5, %%mm6          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pand %%mm4, %%mm0           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// only pav bytes &lt; 0 in mm7</span>
<span class="normal">            </span><span class="string">"pcmpgtw %%mm5, %%mm7        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// create mask pbv bytes &lt; 0</span>
<span class="normal">            </span><span class="string">"psubw %%mm0, %%mm4          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pand %%mm5, %%mm7           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// only pbv bytes &lt; 0 in mm0</span>
<span class="normal">            </span><span class="string">"psubw %%mm0, %%mm4          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"psubw %%mm7, %%mm5          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pxor %%mm0, %%mm0           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pcmpgtw %%mm6, %%mm0        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// create mask pcv bytes &lt; 0</span>
<span class="normal">            </span><span class="string">"pand %%mm6, %%mm0           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// only pav bytes &lt; 0 in mm7</span>
<span class="normal">            </span><span class="string">"psubw %%mm7, %%mm5          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"psubw %%mm0, %%mm6          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">//  test pa &lt;= pb</span>
<span class="normal">            </span><span class="string">"movq %%mm4, %%mm7           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"psubw %%mm0, %%mm6          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pcmpgtw %%mm5, %%mm7        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// pa &gt; pb?</span>
<span class="normal">            </span><span class="string">"movq %%mm7, %%mm0           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// use mm7 mask to merge pa &amp; pb</span>
<span class="normal">            </span><span class="string">"pand %%mm7, %%mm5           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// use mm0 mask copy to merge a &amp; b</span>
<span class="normal">            </span><span class="string">"pand %%mm0, %%mm2           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pandn %%mm4, %%mm7          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pandn %%mm1, %%mm0          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"paddw %%mm5, %%mm7          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"paddw %%mm2, %%mm0          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">//  test  ((pa &lt;= pb)? pa:pb) &lt;= pc</span>
<span class="normal">            </span><span class="string">"pcmpgtw %%mm6, %%mm7        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// pab &gt; pc?</span>
<span class="normal">            </span><span class="string">"pxor %%mm1, %%mm1           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pand %%mm7, %%mm3           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pandn %%mm0, %%mm7          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pxor %%mm1, %%mm1           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"paddw %%mm3, %%mm7          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"pxor %%mm0, %%mm0           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// step ecx to next set of 8 bytes and repeat loop til done</span>
<span class="normal">            </span><span class="string">"addl $8, %%ecx              </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"packuswb %%mm7, %%mm1       </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"paddb -8(%%edi,%%ecx,), %%mm1 </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// add Paeth predictor with Raw(x)</span>
<span class="normal">            </span><span class="string">"cmpl _MMXLength, %%ecx      </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"movq %%mm1, -8(%%edi,%%ecx,) </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// write back updated value</span>
<span class="normal">                            </span><span class="comment">// mm1 will be used as Raw(x-bpp) next loop</span>
<span class="normal">            </span><span class="string">"jb paeth_8lp                </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">            </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"=S"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_S</span><span class="symbol">),</span><span class="normal">             </span><span class="comment">// output regs (dummy)</span>
<span class="normal">              </span><span class="string">"=D"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_D</span><span class="symbol">)</span>

<span class="normal">            </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"0"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">prev_row</span><span class="symbol">),</span><span class="normal">  </span><span class="comment">// esi           // input regs</span>
<span class="normal">              </span><span class="string">"1"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row</span><span class="symbol">)</span><span class="normal">        </span><span class="comment">// edi</span>

<span class="normal">            </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"%ecx"</span><span class="normal">                            </span><span class="comment">// clobber list</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="number">0</span><span class="normal">  </span><span class="comment">/* %mm0, ..., %mm7 not supported by gcc 2.7.2.3 or egcs 1.1 */</span>
<span class="normal">            </span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm0"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm1"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm2"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm3"</span>
<span class="normal">            </span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm4"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm5"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm6"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm7"</span>
<span class="preproc">#endif</span>
<span class="normal">         </span><span class="symbol">);</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="keyword">break</span><span class="symbol">;</span><span class="normal">  </span><span class="comment">// end 8 bpp</span>

<span class="normal">      </span><span class="keyword">case</span><span class="normal"> </span><span class="number">1</span><span class="symbol">:</span><span class="normal">                </span><span class="comment">// bpp = 1</span>
<span class="normal">      </span><span class="keyword">case</span><span class="normal"> </span><span class="number">2</span><span class="symbol">:</span><span class="normal">                </span><span class="comment">// bpp = 2</span>
<span class="normal">      </span><span class="keyword">default</span><span class="symbol">:</span><span class="normal">               </span><span class="comment">// bpp &gt; 8</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         </span><span class="usertype">__asm__</span><span class="normal"> </span><span class="function">__volatile__</span><span class="normal"> </span><span class="symbol">(</span>
<span class="preproc">#ifdef</span><span class="normal"> __PIC__</span>
<span class="normal">            </span><span class="string">"pushl %%ebx                 </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// save Global Offset Table index</span>
<span class="preproc">#endif</span>
<span class="normal">            </span><span class="string">"movl _dif, %%ebx            </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"cmpl _FullLength, %%ebx     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"jnb paeth_dend              </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="comment">// preload  "movl row, %%edi             \n\t"</span>
<span class="comment">// preload  "movl prev_row, %%esi        \n\t"</span>
<span class="normal">            </span><span class="comment">// do Paeth decode for remaining bytes</span>
<span class="normal">            </span><span class="string">"movl %%ebx, %%edx           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="comment">// preload  "subl bpp, %%edx             \n\t" // (bpp is preloaded into ecx)</span>
<span class="normal">            </span><span class="string">"subl %%ecx, %%edx           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// edx = ebx - bpp</span>
<span class="normal">            </span><span class="string">"xorl %%ecx, %%ecx           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// zero ecx before using cl &amp; cx</span>

<span class="normal">         </span><span class="string">"paeth_dlp:                     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"xorl %%eax, %%eax           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// pav = p - a = (a + b - c) - a = b - c</span>
<span class="normal">            </span><span class="string">"movb (%%esi,%%ebx,), %%al   </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// load Prior(x) into al</span>
<span class="normal">            </span><span class="string">"movb (%%esi,%%edx,), %%cl   </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// load Prior(x-bpp) into cl</span>
<span class="normal">            </span><span class="string">"subl %%ecx, %%eax           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// subtract Prior(x-bpp)</span>
<span class="normal">            </span><span class="string">"movl %%eax, _patemp         </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// Save pav for later use</span>
<span class="normal">            </span><span class="string">"xorl %%eax, %%eax           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// pbv = p - b = (a + b - c) - b = a - c</span>
<span class="normal">            </span><span class="string">"movb (%%edi,%%edx,), %%al   </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// load Raw(x-bpp) into al</span>
<span class="normal">            </span><span class="string">"subl %%ecx, %%eax           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// subtract Prior(x-bpp)</span>
<span class="normal">            </span><span class="string">"movl %%eax, %%ecx           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// pcv = p - c = (a + b - c) -c = (a - c) + (b - c) = pav + pbv</span>
<span class="normal">            </span><span class="string">"addl _patemp, %%eax         </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// pcv = pav + pbv</span>
<span class="normal">            </span><span class="comment">// pc = abs(pcv)</span>
<span class="normal">            </span><span class="string">"testl $0x80000000, %%eax    </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"jz paeth_dpca               </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"negl %%eax                  </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// reverse sign of neg values</span>

<span class="normal">         </span><span class="string">"paeth_dpca:                    </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"movl %%eax, _pctemp         </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// save pc for later use</span>
<span class="normal">            </span><span class="comment">// pb = abs(pbv)</span>
<span class="normal">            </span><span class="string">"testl $0x80000000, %%ecx    </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"jz paeth_dpba               </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"negl %%ecx                  </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// reverse sign of neg values</span>

<span class="normal">         </span><span class="string">"paeth_dpba:                    </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"movl %%ecx, _pbtemp         </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// save pb for later use</span>
<span class="normal">            </span><span class="comment">// pa = abs(pav)</span>
<span class="normal">            </span><span class="string">"movl _patemp, %%eax         </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"testl $0x80000000, %%eax    </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"jz paeth_dpaa               </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"negl %%eax                  </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// reverse sign of neg values</span>

<span class="normal">         </span><span class="string">"paeth_dpaa:                    </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"movl %%eax, _patemp         </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// save pa for later use</span>
<span class="normal">            </span><span class="comment">// test if pa &lt;= pb</span>
<span class="normal">            </span><span class="string">"cmpl %%ecx, %%eax           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"jna paeth_dabb              </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// pa &gt; pb; now test if pb &lt;= pc</span>
<span class="normal">            </span><span class="string">"cmpl _pctemp, %%ecx         </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"jna paeth_dbbc              </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// pb &gt; pc; Raw(x) = Paeth(x) + Prior(x-bpp)</span>
<span class="normal">            </span><span class="string">"movb (%%esi,%%edx,), %%cl   </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// load Prior(x-bpp) into cl</span>
<span class="normal">            </span><span class="string">"jmp paeth_dpaeth            </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">         </span><span class="string">"paeth_dbbc:                    </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// pb &lt;= pc; Raw(x) = Paeth(x) + Prior(x)</span>
<span class="normal">            </span><span class="string">"movb (%%esi,%%ebx,), %%cl   </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// load Prior(x) into cl</span>
<span class="normal">            </span><span class="string">"jmp paeth_dpaeth            </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">         </span><span class="string">"paeth_dabb:                    </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// pa &lt;= pb; now test if pa &lt;= pc</span>
<span class="normal">            </span><span class="string">"cmpl _pctemp, %%eax         </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"jna paeth_dabc              </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// pa &gt; pc; Raw(x) = Paeth(x) + Prior(x-bpp)</span>
<span class="normal">            </span><span class="string">"movb (%%esi,%%edx,), %%cl   </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// load Prior(x-bpp) into cl</span>
<span class="normal">            </span><span class="string">"jmp paeth_dpaeth            </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">         </span><span class="string">"paeth_dabc:                    </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// pa &lt;= pc; Raw(x) = Paeth(x) + Raw(x-bpp)</span>
<span class="normal">            </span><span class="string">"movb (%%edi,%%edx,), %%cl   </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// load Raw(x-bpp) into cl</span>

<span class="normal">         </span><span class="string">"paeth_dpaeth:                  </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"incl %%ebx                  </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"incl %%edx                  </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="comment">// Raw(x) = (Paeth(x) + Paeth_Predictor( a, b, c )) mod 256</span>
<span class="normal">            </span><span class="string">"addb %%cl, -1(%%edi,%%ebx,) </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"cmpl _FullLength, %%ebx     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"jb paeth_dlp                </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">         </span><span class="string">"paeth_dend:                    </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="preproc">#ifdef</span><span class="normal"> __PIC__</span>
<span class="normal">            </span><span class="string">"popl %%ebx                  </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// index to Global Offset Table</span>
<span class="preproc">#endif</span>

<span class="normal">            </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"=c"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_c</span><span class="symbol">),</span><span class="normal">            </span><span class="comment">// output regs (dummy)</span>
<span class="normal">              </span><span class="string">"=S"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_S</span><span class="symbol">),</span>
<span class="normal">              </span><span class="string">"=D"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_D</span><span class="symbol">)</span>

<span class="normal">            </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"0"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">bpp</span><span class="symbol">),</span><span class="normal">       </span><span class="comment">// ecx          // input regs</span>
<span class="normal">              </span><span class="string">"1"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">prev_row</span><span class="symbol">),</span><span class="normal">  </span><span class="comment">// esi</span>
<span class="normal">              </span><span class="string">"2"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row</span><span class="symbol">)</span><span class="normal">        </span><span class="comment">// edi</span>

<span class="normal">            </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"%eax"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%edx"</span><span class="normal">                   </span><span class="comment">// clobber list</span>
<span class="preproc">#ifndef</span><span class="normal"> __PIC__</span>
<span class="normal">            </span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%ebx"</span>
<span class="preproc">#endif</span>
<span class="normal">         </span><span class="symbol">);</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="keyword">return</span><span class="symbol">;</span><span class="normal">                   </span><span class="comment">// No need to go further with this one</span>

<span class="normal">   </span><span class="cbracket">}</span><span class="normal"> </span><span class="comment">// end switch (bpp)</span>

<span class="normal">   </span><span class="usertype">__asm__</span><span class="normal"> </span><span class="function">__volatile__</span><span class="normal"> </span><span class="symbol">(</span>
<span class="normal">      </span><span class="comment">// MMX acceleration complete; now do clean-up</span>
<span class="normal">      </span><span class="comment">// check if any remaining bytes left to decode</span>
<span class="preproc">#ifdef</span><span class="normal"> __PIC__</span>
<span class="normal">      </span><span class="string">"pushl %%ebx                 </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// save index to Global Offset Table</span>
<span class="preproc">#endif</span>
<span class="normal">      </span><span class="string">"movl _MMXLength, %%ebx      </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"cmpl _FullLength, %%ebx     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"jnb paeth_end               </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="comment">//pre "movl row, %%edi             \n\t"</span>
<span class="comment">//pre "movl prev_row, %%esi        \n\t"</span>
<span class="normal">      </span><span class="comment">// do Paeth decode for remaining bytes</span>
<span class="normal">      </span><span class="string">"movl %%ebx, %%edx           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="comment">//pre "subl bpp, %%edx             \n\t" // (bpp is preloaded into ecx)</span>
<span class="normal">      </span><span class="string">"subl %%ecx, %%edx           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// edx = ebx - bpp</span>
<span class="normal">      </span><span class="string">"xorl %%ecx, %%ecx           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// zero ecx before using cl &amp; cx below</span>

<span class="normal">   </span><span class="string">"paeth_lp2:                     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"xorl %%eax, %%eax           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="comment">// pav = p - a = (a + b - c) - a = b - c</span>
<span class="normal">      </span><span class="string">"movb (%%esi,%%ebx,), %%al   </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// load Prior(x) into al</span>
<span class="normal">      </span><span class="string">"movb (%%esi,%%edx,), %%cl   </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// load Prior(x-bpp) into cl</span>
<span class="normal">      </span><span class="string">"subl %%ecx, %%eax           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// subtract Prior(x-bpp)</span>
<span class="normal">      </span><span class="string">"movl %%eax, _patemp         </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// Save pav for later use</span>
<span class="normal">      </span><span class="string">"xorl %%eax, %%eax           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="comment">// pbv = p - b = (a + b - c) - b = a - c</span>
<span class="normal">      </span><span class="string">"movb (%%edi,%%edx,), %%al   </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// load Raw(x-bpp) into al</span>
<span class="normal">      </span><span class="string">"subl %%ecx, %%eax           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// subtract Prior(x-bpp)</span>
<span class="normal">      </span><span class="string">"movl %%eax, %%ecx           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="comment">// pcv = p - c = (a + b - c) -c = (a - c) + (b - c) = pav + pbv</span>
<span class="normal">      </span><span class="string">"addl _patemp, %%eax         </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// pcv = pav + pbv</span>
<span class="normal">      </span><span class="comment">// pc = abs(pcv)</span>
<span class="normal">      </span><span class="string">"testl $0x80000000, %%eax    </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"jz paeth_pca2               </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"negl %%eax                  </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// reverse sign of neg values</span>

<span class="normal">   </span><span class="string">"paeth_pca2:                    </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"movl %%eax, _pctemp         </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// save pc for later use</span>
<span class="normal">      </span><span class="comment">// pb = abs(pbv)</span>
<span class="normal">      </span><span class="string">"testl $0x80000000, %%ecx    </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"jz paeth_pba2               </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"negl %%ecx                  </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// reverse sign of neg values</span>

<span class="normal">   </span><span class="string">"paeth_pba2:                    </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"movl %%ecx, _pbtemp         </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// save pb for later use</span>
<span class="normal">      </span><span class="comment">// pa = abs(pav)</span>
<span class="normal">      </span><span class="string">"movl _patemp, %%eax         </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"testl $0x80000000, %%eax    </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"jz paeth_paa2               </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"negl %%eax                  </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// reverse sign of neg values</span>

<span class="normal">   </span><span class="string">"paeth_paa2:                    </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"movl %%eax, _patemp         </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// save pa for later use</span>
<span class="normal">      </span><span class="comment">// test if pa &lt;= pb</span>
<span class="normal">      </span><span class="string">"cmpl %%ecx, %%eax           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"jna paeth_abb2              </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="comment">// pa &gt; pb; now test if pb &lt;= pc</span>
<span class="normal">      </span><span class="string">"cmpl _pctemp, %%ecx         </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"jna paeth_bbc2              </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="comment">// pb &gt; pc; Raw(x) = Paeth(x) + Prior(x-bpp)</span>
<span class="normal">      </span><span class="string">"movb (%%esi,%%edx,), %%cl   </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// load Prior(x-bpp) into cl</span>
<span class="normal">      </span><span class="string">"jmp paeth_paeth2            </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">   </span><span class="string">"paeth_bbc2:                    </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="comment">// pb &lt;= pc; Raw(x) = Paeth(x) + Prior(x)</span>
<span class="normal">      </span><span class="string">"movb (%%esi,%%ebx,), %%cl   </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// load Prior(x) into cl</span>
<span class="normal">      </span><span class="string">"jmp paeth_paeth2            </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">   </span><span class="string">"paeth_abb2:                    </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="comment">// pa &lt;= pb; now test if pa &lt;= pc</span>
<span class="normal">      </span><span class="string">"cmpl _pctemp, %%eax         </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"jna paeth_abc2              </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="comment">// pa &gt; pc; Raw(x) = Paeth(x) + Prior(x-bpp)</span>
<span class="normal">      </span><span class="string">"movb (%%esi,%%edx,), %%cl   </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// load Prior(x-bpp) into cl</span>
<span class="normal">      </span><span class="string">"jmp paeth_paeth2            </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">   </span><span class="string">"paeth_abc2:                    </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="comment">// pa &lt;= pc; Raw(x) = Paeth(x) + Raw(x-bpp)</span>
<span class="normal">      </span><span class="string">"movb (%%edi,%%edx,), %%cl   </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// load Raw(x-bpp) into cl</span>

<span class="normal">   </span><span class="string">"paeth_paeth2:                  </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"incl %%ebx                  </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"incl %%edx                  </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="comment">// Raw(x) = (Paeth(x) + Paeth_Predictor( a, b, c )) mod 256</span>
<span class="normal">      </span><span class="string">"addb %%cl, -1(%%edi,%%ebx,) </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"cmpl _FullLength, %%ebx     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"jb paeth_lp2                </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">   </span><span class="string">"paeth_end:                     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"EMMS                        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// end MMX; prep for poss. FP instrs.</span>
<span class="preproc">#ifdef</span><span class="normal"> __PIC__</span>
<span class="normal">      </span><span class="string">"popl %%ebx                  </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// restore index to Global Offset Table</span>
<span class="preproc">#endif</span>

<span class="normal">      </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"=c"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_c</span><span class="symbol">),</span><span class="normal">            </span><span class="comment">// output regs (dummy)</span>
<span class="normal">        </span><span class="string">"=S"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_S</span><span class="symbol">),</span>
<span class="normal">        </span><span class="string">"=D"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_D</span><span class="symbol">)</span>

<span class="normal">      </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"0"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">bpp</span><span class="symbol">),</span><span class="normal">       </span><span class="comment">// ecx          // input regs</span>
<span class="normal">        </span><span class="string">"1"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">prev_row</span><span class="symbol">),</span><span class="normal">  </span><span class="comment">// esi</span>
<span class="normal">        </span><span class="string">"2"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row</span><span class="symbol">)</span><span class="normal">        </span><span class="comment">// edi</span>

<span class="normal">      </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"%eax"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%edx"</span><span class="normal">                   </span><span class="comment">// clobber list (no input regs!)</span>
<span class="preproc">#ifndef</span><span class="normal"> __PIC__</span>
<span class="normal">      </span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%ebx"</span>
<span class="preproc">#endif</span>
<span class="normal">   </span><span class="symbol">);</span>

<span class="cbracket">}</span><span class="normal"> </span><span class="comment">/* end png_read_filter_row_mmx_paeth() */</span>
<span class="preproc">#endif</span>




<span class="preproc">#ifdef</span><span class="normal"> PNG_THREAD_UNSAFE_OK</span>
<span class="comment">//===========================================================================//</span>
<span class="comment">//                                                                           //</span>
<span class="comment">//           P N G _ R E A D _ F I L T E R _ R O W _ M M X _ S U B           //</span>
<span class="comment">//                                                                           //</span>
<span class="comment">//===========================================================================//</span>

<span class="comment">// Optimized code for PNG Sub filter decoder</span>

<span class="keyword">static</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="comment">/* PRIVATE */</span>
<span class="function">png_read_filter_row_mmx_sub</span><span class="symbol">(</span><span class="usertype">png_row_infop</span><span class="normal"> row_info</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">png_bytep</span><span class="normal"> row</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">   </span><span class="type">int</span><span class="normal"> bpp</span><span class="symbol">;</span>
<span class="normal">   </span><span class="type">int</span><span class="normal"> dummy_value_a</span><span class="symbol">;</span>
<span class="normal">   </span><span class="type">int</span><span class="normal"> dummy_value_D</span><span class="symbol">;</span>

<span class="normal">   bpp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">pixel_depth </span><span class="symbol">+</span><span class="normal"> </span><span class="number">7</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">3</span><span class="symbol">;</span><span class="normal">   </span><span class="comment">// calc number of bytes per pixel</span>
<span class="normal">   _FullLength </span><span class="symbol">=</span><span class="normal"> row_info</span><span class="symbol">-&gt;</span><span class="normal">rowbytes </span><span class="symbol">-</span><span class="normal"> bpp</span><span class="symbol">;</span><span class="normal">   </span><span class="comment">// number of bytes to filter</span>

<span class="normal">   </span><span class="usertype">__asm__</span><span class="normal"> </span><span class="function">__volatile__</span><span class="normal"> </span><span class="symbol">(</span>
<span class="comment">//pre "movl row, %%edi             \n\t"</span>
<span class="normal">      </span><span class="string">"movl %%edi, %%esi           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// lp = row</span>
<span class="comment">//pre "movl bpp, %%eax             \n\t"</span>
<span class="normal">      </span><span class="string">"addl %%eax, %%edi           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// rp = row + bpp</span>
<span class="comment">//irr "xorl %%eax, %%eax           \n\t"</span>
<span class="normal">      </span><span class="comment">// get # of bytes to alignment</span>
<span class="normal">      </span><span class="string">"movl %%edi, _dif            </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// take start of row</span>
<span class="normal">      </span><span class="string">"addl $0xf, _dif             </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// add 7 + 8 to incr past</span>
<span class="normal">                                         </span><span class="comment">//  alignment boundary</span>
<span class="normal">      </span><span class="string">"xorl %%ecx, %%ecx           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"andl $0xfffffff8, _dif      </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// mask to alignment boundary</span>
<span class="normal">      </span><span class="string">"subl %%edi, _dif            </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// subtract from start ==&gt; value</span>
<span class="normal">      </span><span class="string">"jz sub_go                   </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">//  ecx at alignment</span>

<span class="normal">   </span><span class="string">"sub_lp1:                       </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// fix alignment</span>
<span class="normal">      </span><span class="string">"movb (%%esi,%%ecx,), %%al   </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"addb %%al, (%%edi,%%ecx,)   </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"incl %%ecx                  </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"cmpl _dif, %%ecx            </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"jb sub_lp1                  </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">   </span><span class="string">"sub_go:                        </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"movl _FullLength, %%eax     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"movl %%eax, %%edx           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"subl %%ecx, %%edx           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// subtract alignment fix</span>
<span class="normal">      </span><span class="string">"andl $0x00000007, %%edx     </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// calc bytes over mult of 8</span>
<span class="normal">      </span><span class="string">"subl %%edx, %%eax           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// drop over bytes from length</span>
<span class="normal">      </span><span class="string">"movl %%eax, _MMXLength      </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">      </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"=a"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_a</span><span class="symbol">),</span><span class="normal">   </span><span class="comment">// 0      // output regs (dummy)</span>
<span class="normal">        </span><span class="string">"=D"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_D</span><span class="symbol">)</span><span class="normal">    </span><span class="comment">// 1</span>

<span class="normal">      </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"0"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">bpp</span><span class="symbol">),</span><span class="normal">              </span><span class="comment">// eax    // input regs</span>
<span class="normal">        </span><span class="string">"1"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row</span><span class="symbol">)</span><span class="normal">               </span><span class="comment">// edi</span>

<span class="normal">      </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"%esi"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%ecx"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%edx"</span><span class="normal">            </span><span class="comment">// clobber list</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="number">0</span><span class="normal">  </span><span class="comment">/* MMX regs (%mm0, etc.) not supported by gcc 2.7.2.3 or egcs 1.1 */</span>
<span class="normal">      </span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm0"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm1"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm2"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm3"</span>
<span class="normal">      </span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm4"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm5"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm6"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm7"</span>
<span class="preproc">#endif</span>
<span class="normal">   </span><span class="symbol">);</span>

<span class="normal">   </span><span class="comment">// now do the math for the rest of the row</span>
<span class="normal">   </span><span class="keyword">switch</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">bpp</span><span class="symbol">)</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="keyword">case</span><span class="normal"> </span><span class="number">3</span><span class="symbol">:</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         _ActiveMask</span><span class="symbol">.</span><span class="normal">use  </span><span class="symbol">=</span><span class="normal"> 0x0000ffffff000000LL</span><span class="symbol">;</span>
<span class="normal">         _ShiftBpp</span><span class="symbol">.</span><span class="normal">use </span><span class="symbol">=</span><span class="normal"> </span><span class="number">24</span><span class="symbol">;</span><span class="normal">       </span><span class="comment">// == 3 * 8</span>
<span class="normal">         _ShiftRem</span><span class="symbol">.</span><span class="normal">use  </span><span class="symbol">=</span><span class="normal"> </span><span class="number">40</span><span class="symbol">;</span><span class="normal">      </span><span class="comment">// == 64 - 24</span>

<span class="normal">         </span><span class="usertype">__asm__</span><span class="normal"> </span><span class="function">__volatile__</span><span class="normal"> </span><span class="symbol">(</span>
<span class="comment">// preload  "movl row, %%edi              \n\t"</span>
<span class="normal">            </span><span class="string">"movq _ActiveMask, %%mm7       </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// load _ActiveMask for 2nd</span>
<span class="normal">                                                </span><span class="comment">//  active byte group</span>
<span class="normal">            </span><span class="string">"movl %%edi, %%esi            </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// lp = row</span>
<span class="comment">// preload  "movl bpp, %%eax              \n\t"</span>
<span class="normal">            </span><span class="string">"addl %%eax, %%edi            </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// rp = row + bpp</span>
<span class="normal">            </span><span class="string">"movq %%mm7, %%mm6            </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"movl _dif, %%edx             </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"psllq _ShiftBpp, %%mm6       </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// move mask in mm6 to cover</span>
<span class="normal">                                                </span><span class="comment">//  3rd active byte group</span>
<span class="normal">            </span><span class="comment">// prime the pump:  load the first Raw(x-bpp) data set</span>
<span class="normal">            </span><span class="string">"movq -8(%%edi,%%edx,), %%mm1 </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">         </span><span class="string">"sub_3lp:                        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// shift data for adding first</span>
<span class="normal">            </span><span class="string">"psrlq _ShiftRem, %%mm1       </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">//  bpp bytes (no need for mask;</span>
<span class="normal">                                                </span><span class="comment">//  shift clears inactive bytes)</span>
<span class="normal">            </span><span class="comment">// add 1st active group</span>
<span class="normal">            </span><span class="string">"movq (%%edi,%%edx,), %%mm0   </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"paddb %%mm1, %%mm0           </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">            </span><span class="comment">// add 2nd active group</span>
<span class="normal">            </span><span class="string">"movq %%mm0, %%mm1            </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// mov updated Raws to mm1</span>
<span class="normal">            </span><span class="string">"psllq _ShiftBpp, %%mm1       </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// shift data to pos. correctly</span>
<span class="normal">            </span><span class="string">"pand %%mm7, %%mm1            </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// mask to use 2nd active group</span>
<span class="normal">            </span><span class="string">"paddb %%mm1, %%mm0           </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">            </span><span class="comment">// add 3rd active group</span>
<span class="normal">            </span><span class="string">"movq %%mm0, %%mm1            </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// mov updated Raws to mm1</span>
<span class="normal">            </span><span class="string">"psllq _ShiftBpp, %%mm1       </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// shift data to pos. correctly</span>
<span class="normal">            </span><span class="string">"pand %%mm6, %%mm1            </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// mask to use 3rd active group</span>
<span class="normal">            </span><span class="string">"addl $8, %%edx               </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"paddb %%mm1, %%mm0           </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">            </span><span class="string">"cmpl _MMXLength, %%edx       </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"movq %%mm0, -8(%%edi,%%edx,) </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// write updated Raws to array</span>
<span class="normal">            </span><span class="string">"movq %%mm0, %%mm1            </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// prep 1st add at top of loop</span>
<span class="normal">            </span><span class="string">"jb sub_3lp                   </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">            </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"=a"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_a</span><span class="symbol">),</span><span class="normal">   </span><span class="comment">// 0      // output regs (dummy)</span>
<span class="normal">              </span><span class="string">"=D"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_D</span><span class="symbol">)</span><span class="normal">    </span><span class="comment">// 1</span>

<span class="normal">            </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"0"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">bpp</span><span class="symbol">),</span><span class="normal">              </span><span class="comment">// eax    // input regs</span>
<span class="normal">              </span><span class="string">"1"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row</span><span class="symbol">)</span><span class="normal">               </span><span class="comment">// edi</span>

<span class="normal">            </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"%edx"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%esi"</span><span class="normal">                    </span><span class="comment">// clobber list</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="number">0</span><span class="normal">  </span><span class="comment">/* MMX regs (%mm0, etc.) not supported by gcc 2.7.2.3 or egcs 1.1 */</span>
<span class="normal">            </span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm0"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm1"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm6"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm7"</span>
<span class="preproc">#endif</span>
<span class="normal">         </span><span class="symbol">);</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">      </span><span class="keyword">case</span><span class="normal"> </span><span class="number">1</span><span class="symbol">:</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         </span><span class="usertype">__asm__</span><span class="normal"> </span><span class="function">__volatile__</span><span class="normal"> </span><span class="symbol">(</span>
<span class="normal">            </span><span class="string">"movl _dif, %%edx            </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="comment">// preload  "movl row, %%edi             \n\t"</span>
<span class="normal">            </span><span class="string">"cmpl _FullLength, %%edx     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"jnb sub_1end                </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"movl %%edi, %%esi           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// lp = row</span>
<span class="normal">            </span><span class="string">"xorl %%eax, %%eax           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="comment">// preload  "movl bpp, %%eax             \n\t"</span>
<span class="normal">            </span><span class="string">"addl %%eax, %%edi           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// rp = row + bpp</span>

<span class="normal">         </span><span class="string">"sub_1lp:                       </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"movb (%%esi,%%edx,), %%al   </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"addb %%al, (%%edi,%%edx,)   </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"incl %%edx                  </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"cmpl _FullLength, %%edx     </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"jb sub_1lp                  </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">         </span><span class="string">"sub_1end:                      </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">            </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"=a"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_a</span><span class="symbol">),</span><span class="normal">   </span><span class="comment">// 0      // output regs (dummy)</span>
<span class="normal">              </span><span class="string">"=D"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_D</span><span class="symbol">)</span><span class="normal">    </span><span class="comment">// 1</span>

<span class="normal">            </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"0"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">bpp</span><span class="symbol">),</span><span class="normal">              </span><span class="comment">// eax    // input regs</span>
<span class="normal">              </span><span class="string">"1"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row</span><span class="symbol">)</span><span class="normal">               </span><span class="comment">// edi</span>

<span class="normal">            </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"%edx"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%esi"</span><span class="normal">                    </span><span class="comment">// clobber list</span>
<span class="normal">         </span><span class="symbol">);</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="keyword">return</span><span class="symbol">;</span>

<span class="normal">      </span><span class="keyword">case</span><span class="normal"> </span><span class="number">6</span><span class="symbol">:</span>
<span class="normal">      </span><span class="keyword">case</span><span class="normal"> </span><span class="number">4</span><span class="symbol">:</span>
<span class="normal">      </span><span class="comment">//case 7:   // GRR BOGUS</span>
<span class="normal">      </span><span class="comment">//case 5:   // GRR BOGUS</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         _ShiftBpp</span><span class="symbol">.</span><span class="normal">use </span><span class="symbol">=</span><span class="normal"> bpp </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">3</span><span class="symbol">;</span>
<span class="normal">         _ShiftRem</span><span class="symbol">.</span><span class="normal">use </span><span class="symbol">=</span><span class="normal"> </span><span class="number">64</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> _ShiftBpp</span><span class="symbol">.</span><span class="normal">use</span><span class="symbol">;</span>

<span class="normal">         </span><span class="usertype">__asm__</span><span class="normal"> </span><span class="function">__volatile__</span><span class="normal"> </span><span class="symbol">(</span>
<span class="comment">// preload  "movl row, %%edi              \n\t"</span>
<span class="normal">            </span><span class="string">"movl _dif, %%edx             </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"movl %%edi, %%esi            </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// lp = row</span>
<span class="comment">// preload  "movl bpp, %%eax              \n\t"</span>
<span class="normal">            </span><span class="string">"addl %%eax, %%edi            </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// rp = row + bpp</span>

<span class="normal">            </span><span class="comment">// prime the pump:  load the first Raw(x-bpp) data set</span>
<span class="normal">            </span><span class="string">"movq -8(%%edi,%%edx,), %%mm1 </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">         </span><span class="string">"sub_4lp:                        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// shift data for adding first</span>
<span class="normal">            </span><span class="string">"psrlq _ShiftRem, %%mm1       </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">//  bpp bytes (no need for mask;</span>
<span class="normal">                                                </span><span class="comment">//  shift clears inactive bytes)</span>
<span class="normal">            </span><span class="string">"movq (%%edi,%%edx,), %%mm0   </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"paddb %%mm1, %%mm0           </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">            </span><span class="comment">// add 2nd active group</span>
<span class="normal">            </span><span class="string">"movq %%mm0, %%mm1            </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// mov updated Raws to mm1</span>
<span class="normal">            </span><span class="string">"psllq _ShiftBpp, %%mm1       </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// shift data to pos. correctly</span>
<span class="normal">            </span><span class="string">"addl $8, %%edx               </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"paddb %%mm1, %%mm0           </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">            </span><span class="string">"cmpl _MMXLength, %%edx       </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"movq %%mm0, -8(%%edi,%%edx,) </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"movq %%mm0, %%mm1            </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// prep 1st add at top of loop</span>
<span class="normal">            </span><span class="string">"jb sub_4lp                   </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">            </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"=a"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_a</span><span class="symbol">),</span><span class="normal">   </span><span class="comment">// 0      // output regs (dummy)</span>
<span class="normal">              </span><span class="string">"=D"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_D</span><span class="symbol">)</span><span class="normal">    </span><span class="comment">// 1</span>

<span class="normal">            </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"0"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">bpp</span><span class="symbol">),</span><span class="normal">              </span><span class="comment">// eax    // input regs</span>
<span class="normal">              </span><span class="string">"1"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row</span><span class="symbol">)</span><span class="normal">               </span><span class="comment">// edi</span>

<span class="normal">            </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"%edx"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%esi"</span><span class="normal">                    </span><span class="comment">// clobber list</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="number">0</span><span class="normal">  </span><span class="comment">/* MMX regs (%mm0, etc.) not supported by gcc 2.7.2.3 or egcs 1.1 */</span>
<span class="normal">            </span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm0"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm1"</span>
<span class="preproc">#endif</span>
<span class="normal">         </span><span class="symbol">);</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">      </span><span class="keyword">case</span><span class="normal"> </span><span class="number">2</span><span class="symbol">:</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         _ActiveMask</span><span class="symbol">.</span><span class="normal">use </span><span class="symbol">=</span><span class="normal"> 0x00000000ffff0000LL</span><span class="symbol">;</span>
<span class="normal">         _ShiftBpp</span><span class="symbol">.</span><span class="normal">use </span><span class="symbol">=</span><span class="normal"> </span><span class="number">16</span><span class="symbol">;</span><span class="normal">       </span><span class="comment">// == 2 * 8</span>
<span class="normal">         _ShiftRem</span><span class="symbol">.</span><span class="normal">use </span><span class="symbol">=</span><span class="normal"> </span><span class="number">48</span><span class="symbol">;</span><span class="normal">       </span><span class="comment">// == 64 - 16</span>

<span class="normal">         </span><span class="usertype">__asm__</span><span class="normal"> </span><span class="function">__volatile__</span><span class="normal"> </span><span class="symbol">(</span>
<span class="normal">            </span><span class="string">"movq _ActiveMask, %%mm7      </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// load _ActiveMask for 2nd</span>
<span class="normal">                                                </span><span class="comment">//  active byte group</span>
<span class="normal">            </span><span class="string">"movl _dif, %%edx             </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"movq %%mm7, %%mm6            </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="comment">// preload  "movl row, %%edi              \n\t"</span>
<span class="normal">            </span><span class="string">"psllq _ShiftBpp, %%mm6       </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// move mask in mm6 to cover</span>
<span class="normal">                                                </span><span class="comment">//  3rd active byte group</span>
<span class="normal">            </span><span class="string">"movl %%edi, %%esi            </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// lp = row</span>
<span class="normal">            </span><span class="string">"movq %%mm6, %%mm5            </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="comment">// preload  "movl bpp, %%eax              \n\t"</span>
<span class="normal">            </span><span class="string">"addl %%eax, %%edi            </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// rp = row + bpp</span>
<span class="normal">            </span><span class="string">"psllq _ShiftBpp, %%mm5       </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// move mask in mm5 to cover</span>
<span class="normal">                                                </span><span class="comment">//  4th active byte group</span>
<span class="normal">            </span><span class="comment">// prime the pump:  load the first Raw(x-bpp) data set</span>
<span class="normal">            </span><span class="string">"movq -8(%%edi,%%edx,), %%mm1 </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">         </span><span class="string">"sub_2lp:                        </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// shift data for adding first</span>
<span class="normal">            </span><span class="string">"psrlq _ShiftRem, %%mm1       </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">//  bpp bytes (no need for mask;</span>
<span class="normal">                                                </span><span class="comment">//  shift clears inactive bytes)</span>
<span class="normal">            </span><span class="comment">// add 1st active group</span>
<span class="normal">            </span><span class="string">"movq (%%edi,%%edx,), %%mm0   </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"paddb %%mm1, %%mm0           </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">            </span><span class="comment">// add 2nd active group</span>
<span class="normal">            </span><span class="string">"movq %%mm0, %%mm1            </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// mov updated Raws to mm1</span>
<span class="normal">            </span><span class="string">"psllq _ShiftBpp, %%mm1       </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// shift data to pos. correctly</span>
<span class="normal">            </span><span class="string">"pand %%mm7, %%mm1            </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// mask to use 2nd active group</span>
<span class="normal">            </span><span class="string">"paddb %%mm1, %%mm0           </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">            </span><span class="comment">// add 3rd active group</span>
<span class="normal">            </span><span class="string">"movq %%mm0, %%mm1            </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// mov updated Raws to mm1</span>
<span class="normal">            </span><span class="string">"psllq _ShiftBpp, %%mm1       </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// shift data to pos. correctly</span>
<span class="normal">            </span><span class="string">"pand %%mm6, %%mm1            </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// mask to use 3rd active group</span>
<span class="normal">            </span><span class="string">"paddb %%mm1, %%mm0           </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">            </span><span class="comment">// add 4th active group</span>
<span class="normal">            </span><span class="string">"movq %%mm0, %%mm1            </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// mov updated Raws to mm1</span>
<span class="normal">            </span><span class="string">"psllq _ShiftBpp, %%mm1       </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// shift data to pos. correctly</span>
<span class="normal">            </span><span class="string">"pand %%mm5, %%mm1            </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// mask to use 4th active group</span>
<span class="normal">            </span><span class="string">"addl $8, %%edx               </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"paddb %%mm1, %%mm0           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"cmpl _MMXLength, %%edx       </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"movq %%mm0, -8(%%edi,%%edx,) </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// write updated Raws to array</span>
<span class="normal">            </span><span class="string">"movq %%mm0, %%mm1            </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// prep 1st add at top of loop</span>
<span class="normal">            </span><span class="string">"jb sub_2lp                   </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">            </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"=a"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_a</span><span class="symbol">),</span><span class="normal">   </span><span class="comment">// 0      // output regs (dummy)</span>
<span class="normal">              </span><span class="string">"=D"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_D</span><span class="symbol">)</span><span class="normal">    </span><span class="comment">// 1</span>

<span class="normal">            </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"0"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">bpp</span><span class="symbol">),</span><span class="normal">              </span><span class="comment">// eax    // input regs</span>
<span class="normal">              </span><span class="string">"1"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row</span><span class="symbol">)</span><span class="normal">               </span><span class="comment">// edi</span>

<span class="normal">            </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"%edx"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%esi"</span><span class="normal">                    </span><span class="comment">// clobber list</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="number">0</span><span class="normal">  </span><span class="comment">/* MMX regs (%mm0, etc.) not supported by gcc 2.7.2.3 or egcs 1.1 */</span>
<span class="normal">            </span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm0"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm1"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm5"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm6"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm7"</span>
<span class="preproc">#endif</span>
<span class="normal">         </span><span class="symbol">);</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">      </span><span class="keyword">case</span><span class="normal"> </span><span class="number">8</span><span class="symbol">:</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         </span><span class="usertype">__asm__</span><span class="normal"> </span><span class="function">__volatile__</span><span class="normal"> </span><span class="symbol">(</span>
<span class="comment">// preload  "movl row, %%edi              \n\t"</span>
<span class="normal">            </span><span class="string">"movl _dif, %%edx             </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"movl %%edi, %%esi            </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// lp = row</span>
<span class="comment">// preload  "movl bpp, %%eax              \n\t"</span>
<span class="normal">            </span><span class="string">"addl %%eax, %%edi            </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// rp = row + bpp</span>
<span class="normal">            </span><span class="string">"movl _MMXLength, %%ecx       </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">            </span><span class="comment">// prime the pump:  load the first Raw(x-bpp) data set</span>
<span class="normal">            </span><span class="string">"movq -8(%%edi,%%edx,), %%mm7 </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"andl $0x0000003f, %%ecx      </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// calc bytes over mult of 64</span>

<span class="normal">         </span><span class="string">"sub_8lp:                        </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"movq (%%edi,%%edx,), %%mm0   </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// load Sub(x) for 1st 8 bytes</span>
<span class="normal">            </span><span class="string">"paddb %%mm7, %%mm0           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"movq 8(%%edi,%%edx,), %%mm1  </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// load Sub(x) for 2nd 8 bytes</span>
<span class="normal">            </span><span class="string">"movq %%mm0, (%%edi,%%edx,)   </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// write Raw(x) for 1st 8 bytes</span>

<span class="normal">            </span><span class="comment">// Now mm0 will be used as Raw(x-bpp) for the 2nd group of 8 bytes.</span>
<span class="normal">            </span><span class="comment">// This will be repeated for each group of 8 bytes with the 8th</span>
<span class="normal">            </span><span class="comment">// group being used as the Raw(x-bpp) for the 1st group of the</span>
<span class="normal">            </span><span class="comment">// next loop.</span>

<span class="normal">            </span><span class="string">"paddb %%mm0, %%mm1           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"movq 16(%%edi,%%edx,), %%mm2 </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// load Sub(x) for 3rd 8 bytes</span>
<span class="normal">            </span><span class="string">"movq %%mm1, 8(%%edi,%%edx,)  </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// write Raw(x) for 2nd 8 bytes</span>
<span class="normal">            </span><span class="string">"paddb %%mm1, %%mm2           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"movq 24(%%edi,%%edx,), %%mm3 </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// load Sub(x) for 4th 8 bytes</span>
<span class="normal">            </span><span class="string">"movq %%mm2, 16(%%edi,%%edx,) </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// write Raw(x) for 3rd 8 bytes</span>
<span class="normal">            </span><span class="string">"paddb %%mm2, %%mm3           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"movq 32(%%edi,%%edx,), %%mm4 </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// load Sub(x) for 5th 8 bytes</span>
<span class="normal">            </span><span class="string">"movq %%mm3, 24(%%edi,%%edx,) </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// write Raw(x) for 4th 8 bytes</span>
<span class="normal">            </span><span class="string">"paddb %%mm3, %%mm4           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"movq 40(%%edi,%%edx,), %%mm5 </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// load Sub(x) for 6th 8 bytes</span>
<span class="normal">            </span><span class="string">"movq %%mm4, 32(%%edi,%%edx,) </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// write Raw(x) for 5th 8 bytes</span>
<span class="normal">            </span><span class="string">"paddb %%mm4, %%mm5           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"movq 48(%%edi,%%edx,), %%mm6 </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// load Sub(x) for 7th 8 bytes</span>
<span class="normal">            </span><span class="string">"movq %%mm5, 40(%%edi,%%edx,) </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// write Raw(x) for 6th 8 bytes</span>
<span class="normal">            </span><span class="string">"paddb %%mm5, %%mm6           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"movq 56(%%edi,%%edx,), %%mm7 </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// load Sub(x) for 8th 8 bytes</span>
<span class="normal">            </span><span class="string">"movq %%mm6, 48(%%edi,%%edx,) </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// write Raw(x) for 7th 8 bytes</span>
<span class="normal">            </span><span class="string">"addl $64, %%edx              </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"paddb %%mm6, %%mm7           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"cmpl %%ecx, %%edx            </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"movq %%mm7, -8(%%edi,%%edx,) </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// write Raw(x) for 8th 8 bytes</span>
<span class="normal">            </span><span class="string">"jb sub_8lp                   </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">            </span><span class="string">"cmpl _MMXLength, %%edx       </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"jnb sub_8lt8                 </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">         </span><span class="string">"sub_8lpA:                       </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"movq (%%edi,%%edx,), %%mm0   </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"addl $8, %%edx               </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"paddb %%mm7, %%mm0           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"cmpl _MMXLength, %%edx       </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"movq %%mm0, -8(%%edi,%%edx,) </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// -8 to offset early addl edx</span>
<span class="normal">            </span><span class="string">"movq %%mm0, %%mm7            </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// move calculated Raw(x) data</span>
<span class="normal">                                                </span><span class="comment">//  to mm1 to be new Raw(x-bpp)</span>
<span class="normal">                                                </span><span class="comment">//  for next loop</span>
<span class="normal">            </span><span class="string">"jb sub_8lpA                  </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">         </span><span class="string">"sub_8lt8:                       </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">            </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"=a"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_a</span><span class="symbol">),</span><span class="normal">   </span><span class="comment">// 0      // output regs (dummy)</span>
<span class="normal">              </span><span class="string">"=D"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_D</span><span class="symbol">)</span><span class="normal">    </span><span class="comment">// 1</span>

<span class="normal">            </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"0"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">bpp</span><span class="symbol">),</span><span class="normal">              </span><span class="comment">// eax    // input regs</span>
<span class="normal">              </span><span class="string">"1"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row</span><span class="symbol">)</span><span class="normal">               </span><span class="comment">// edi</span>

<span class="normal">            </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"%ecx"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%edx"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%esi"</span><span class="normal">            </span><span class="comment">// clobber list</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="number">0</span><span class="normal">  </span><span class="comment">/* MMX regs (%mm0, etc.) not supported by gcc 2.7.2.3 or egcs 1.1 */</span>
<span class="normal">            </span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm0"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm1"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm2"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm3"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm4"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm5"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm6"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm7"</span>
<span class="preproc">#endif</span>
<span class="normal">         </span><span class="symbol">);</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">      </span><span class="keyword">default</span><span class="symbol">:</span><span class="normal">                </span><span class="comment">// bpp greater than 8 bytes   GRR BOGUS</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         </span><span class="usertype">__asm__</span><span class="normal"> </span><span class="function">__volatile__</span><span class="normal"> </span><span class="symbol">(</span>
<span class="normal">            </span><span class="string">"movl _dif, %%edx             </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="comment">// preload  "movl row, %%edi              \n\t"</span>
<span class="normal">            </span><span class="string">"movl %%edi, %%esi            </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// lp = row</span>
<span class="comment">// preload  "movl bpp, %%eax              \n\t"</span>
<span class="normal">            </span><span class="string">"addl %%eax, %%edi            </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// rp = row + bpp</span>

<span class="normal">         </span><span class="string">"sub_Alp:                        </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"movq (%%edi,%%edx,), %%mm0   </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"movq (%%esi,%%edx,), %%mm1   </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"addl $8, %%edx               </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"paddb %%mm1, %%mm0           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"cmpl _MMXLength, %%edx       </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">            </span><span class="string">"movq %%mm0, -8(%%edi,%%edx,) </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// mov does not affect flags;</span>
<span class="normal">                                                </span><span class="comment">//  -8 to offset addl edx</span>
<span class="normal">            </span><span class="string">"jb sub_Alp                   </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">            </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"=a"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_a</span><span class="symbol">),</span><span class="normal">   </span><span class="comment">// 0      // output regs (dummy)</span>
<span class="normal">              </span><span class="string">"=D"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_D</span><span class="symbol">)</span><span class="normal">    </span><span class="comment">// 1</span>

<span class="normal">            </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"0"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">bpp</span><span class="symbol">),</span><span class="normal">              </span><span class="comment">// eax    // input regs</span>
<span class="normal">              </span><span class="string">"1"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row</span><span class="symbol">)</span><span class="normal">               </span><span class="comment">// edi</span>

<span class="normal">            </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"%edx"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%esi"</span><span class="normal">                    </span><span class="comment">// clobber list</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="number">0</span><span class="normal">  </span><span class="comment">/* MMX regs (%mm0, etc.) not supported by gcc 2.7.2.3 or egcs 1.1 */</span>
<span class="normal">            </span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm0"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm1"</span>
<span class="preproc">#endif</span>
<span class="normal">         </span><span class="symbol">);</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">   </span><span class="cbracket">}</span><span class="normal"> </span><span class="comment">// end switch (bpp)</span>

<span class="normal">   </span><span class="usertype">__asm__</span><span class="normal"> </span><span class="function">__volatile__</span><span class="normal"> </span><span class="symbol">(</span>
<span class="normal">      </span><span class="string">"movl _MMXLength, %%edx       </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="comment">//pre "movl row, %%edi              \n\t"</span>
<span class="normal">      </span><span class="string">"cmpl _FullLength, %%edx      </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"jnb sub_end                  </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">      </span><span class="string">"movl %%edi, %%esi            </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// lp = row</span>
<span class="comment">//pre "movl bpp, %%eax              \n\t"</span>
<span class="normal">      </span><span class="string">"addl %%eax, %%edi            </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// rp = row + bpp</span>
<span class="normal">      </span><span class="string">"xorl %%eax, %%eax            </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">   </span><span class="string">"sub_lp2:                        </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"movb (%%esi,%%edx,), %%al    </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"addb %%al, (%%edi,%%edx,)    </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"incl %%edx                   </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"cmpl _FullLength, %%edx      </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"jb sub_lp2                   </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">   </span><span class="string">"sub_end:                        </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"EMMS                         </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// end MMX instructions</span>

<span class="normal">      </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"=a"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_a</span><span class="symbol">),</span><span class="normal">   </span><span class="comment">// 0      // output regs (dummy)</span>
<span class="normal">        </span><span class="string">"=D"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_D</span><span class="symbol">)</span><span class="normal">    </span><span class="comment">// 1</span>

<span class="normal">      </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"0"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">bpp</span><span class="symbol">),</span><span class="normal">              </span><span class="comment">// eax    // input regs</span>
<span class="normal">        </span><span class="string">"1"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row</span><span class="symbol">)</span><span class="normal">               </span><span class="comment">// edi</span>

<span class="normal">      </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"%edx"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%esi"</span><span class="normal">                    </span><span class="comment">// clobber list</span>
<span class="normal">   </span><span class="symbol">);</span>

<span class="cbracket">}</span><span class="normal"> </span><span class="comment">// end of png_read_filter_row_mmx_sub()</span>
<span class="preproc">#endif</span>




<span class="comment">//===========================================================================//</span>
<span class="comment">//                                                                           //</span>
<span class="comment">//            P N G _ R E A D _ F I L T E R _ R O W _ M M X _ U P            //</span>
<span class="comment">//                                                                           //</span>
<span class="comment">//===========================================================================//</span>

<span class="comment">// Optimized code for PNG Up filter decoder</span>

<span class="keyword">static</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="comment">/* PRIVATE */</span>
<span class="function">png_read_filter_row_mmx_up</span><span class="symbol">(</span><span class="usertype">png_row_infop</span><span class="normal"> row_info</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">png_bytep</span><span class="normal"> row</span><span class="symbol">,</span>
<span class="normal">                           </span><span class="usertype">png_bytep</span><span class="normal"> prev_row</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">   </span><span class="usertype">png_uint_32</span><span class="normal"> len</span><span class="symbol">;</span>
<span class="normal">   </span><span class="type">int</span><span class="normal"> dummy_value_d</span><span class="symbol">;</span><span class="normal">   </span><span class="comment">// fix 'forbidden register 3 (dx) was spilled' error</span>
<span class="normal">   </span><span class="type">int</span><span class="normal"> dummy_value_S</span><span class="symbol">;</span>
<span class="normal">   </span><span class="type">int</span><span class="normal"> dummy_value_D</span><span class="symbol">;</span>

<span class="normal">   len </span><span class="symbol">=</span><span class="normal"> row_info</span><span class="symbol">-&gt;</span><span class="normal">rowbytes</span><span class="symbol">;</span><span class="normal">              </span><span class="comment">// number of bytes to filter</span>

<span class="normal">   </span><span class="usertype">__asm__</span><span class="normal"> </span><span class="function">__volatile__</span><span class="normal"> </span><span class="symbol">(</span>
<span class="comment">//pre "movl row, %%edi              \n\t"</span>
<span class="normal">      </span><span class="comment">// get # of bytes to alignment</span>
<span class="preproc">#ifdef</span><span class="normal"> __PIC__</span>
<span class="normal">      </span><span class="string">"pushl %%ebx                  </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="preproc">#endif</span>
<span class="normal">      </span><span class="string">"movl %%edi, %%ecx            </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"xorl %%ebx, %%ebx            </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"addl $0x7, %%ecx             </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"xorl %%eax, %%eax            </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"andl $0xfffffff8, %%ecx      </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="comment">//pre "movl prev_row, %%esi         \n\t"</span>
<span class="normal">      </span><span class="string">"subl %%edi, %%ecx            </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"jz up_go                     </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">   </span><span class="string">"up_lp1:                         </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// fix alignment</span>
<span class="normal">      </span><span class="string">"movb (%%edi,%%ebx,), %%al    </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"addb (%%esi,%%ebx,), %%al    </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"incl %%ebx                   </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"cmpl %%ecx, %%ebx            </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"movb %%al, -1(%%edi,%%ebx,)  </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// mov does not affect flags; -1 to</span>
<span class="normal">      </span><span class="string">"jb up_lp1                    </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">//  offset incl ebx</span>

<span class="normal">   </span><span class="string">"up_go:                          </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="comment">//pre "movl len, %%edx              \n\t"</span>
<span class="normal">      </span><span class="string">"movl %%edx, %%ecx            </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"subl %%ebx, %%edx            </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// subtract alignment fix</span>
<span class="normal">      </span><span class="string">"andl $0x0000003f, %%edx      </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// calc bytes over mult of 64</span>
<span class="normal">      </span><span class="string">"subl %%edx, %%ecx            </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// drop over bytes from length</span>

<span class="normal">      </span><span class="comment">// unrolled loop - use all MMX registers and interleave to reduce</span>
<span class="normal">      </span><span class="comment">// number of branch instructions (loops) and reduce partial stalls</span>
<span class="normal">   </span><span class="string">"up_loop:                        </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"movq (%%esi,%%ebx,), %%mm1   </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"movq (%%edi,%%ebx,), %%mm0   </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"movq 8(%%esi,%%ebx,), %%mm3  </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"paddb %%mm1, %%mm0           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"movq 8(%%edi,%%ebx,), %%mm2  </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"movq %%mm0, (%%edi,%%ebx,)   </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"paddb %%mm3, %%mm2           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"movq 16(%%esi,%%ebx,), %%mm5 </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"movq %%mm2, 8(%%edi,%%ebx,)  </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"movq 16(%%edi,%%ebx,), %%mm4 </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"movq 24(%%esi,%%ebx,), %%mm7 </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"paddb %%mm5, %%mm4           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"movq 24(%%edi,%%ebx,), %%mm6 </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"movq %%mm4, 16(%%edi,%%ebx,) </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"paddb %%mm7, %%mm6           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"movq 32(%%esi,%%ebx,), %%mm1 </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"movq %%mm6, 24(%%edi,%%ebx,) </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"movq 32(%%edi,%%ebx,), %%mm0 </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"movq 40(%%esi,%%ebx,), %%mm3 </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"paddb %%mm1, %%mm0           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"movq 40(%%edi,%%ebx,), %%mm2 </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"movq %%mm0, 32(%%edi,%%ebx,) </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"paddb %%mm3, %%mm2           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"movq 48(%%esi,%%ebx,), %%mm5 </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"movq %%mm2, 40(%%edi,%%ebx,) </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"movq 48(%%edi,%%ebx,), %%mm4 </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"movq 56(%%esi,%%ebx,), %%mm7 </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"paddb %%mm5, %%mm4           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"movq 56(%%edi,%%ebx,), %%mm6 </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"movq %%mm4, 48(%%edi,%%ebx,) </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"addl $64, %%ebx              </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"paddb %%mm7, %%mm6           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"cmpl %%ecx, %%ebx            </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"movq %%mm6, -8(%%edi,%%ebx,) </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// (+56)movq does not affect flags;</span>
<span class="normal">      </span><span class="string">"jb up_loop                   </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">//  -8 to offset addl ebx</span>

<span class="normal">      </span><span class="string">"cmpl $0, %%edx               </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// test for bytes over mult of 64</span>
<span class="normal">      </span><span class="string">"jz up_end                    </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">      </span><span class="string">"cmpl $8, %%edx               </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// test for less than 8 bytes</span>
<span class="normal">      </span><span class="string">"jb up_lt8                    </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">//  [added by lcreeve at netins.net]</span>

<span class="normal">      </span><span class="string">"addl %%edx, %%ecx            </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"andl $0x00000007, %%edx      </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// calc bytes over mult of 8</span>
<span class="normal">      </span><span class="string">"subl %%edx, %%ecx            </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// drop over bytes from length</span>
<span class="normal">      </span><span class="string">"jz up_lt8                    </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">   </span><span class="string">"up_lpA:                         </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// use MMX regs to update 8 bytes sim.</span>
<span class="normal">      </span><span class="string">"movq (%%esi,%%ebx,), %%mm1   </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"movq (%%edi,%%ebx,), %%mm0   </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"addl $8, %%ebx               </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"paddb %%mm1, %%mm0           </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"cmpl %%ecx, %%ebx            </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"movq %%mm0, -8(%%edi,%%ebx,) </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// movq does not affect flags; -8 to</span>
<span class="normal">      </span><span class="string">"jb up_lpA                    </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">//  offset add ebx</span>
<span class="normal">      </span><span class="string">"cmpl $0, %%edx               </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// test for bytes over mult of 8</span>
<span class="normal">      </span><span class="string">"jz up_end                    </span><span class="specialchar">\n\t</span><span class="string">"</span>

<span class="normal">   </span><span class="string">"up_lt8:                         </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"xorl %%eax, %%eax            </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"addl %%edx, %%ecx            </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// move over byte count into counter</span>

<span class="normal">   </span><span class="string">"up_lp2:                         </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// use x86 regs for remaining bytes</span>
<span class="normal">      </span><span class="string">"movb (%%edi,%%ebx,), %%al    </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"addb (%%esi,%%ebx,), %%al    </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"incl %%ebx                   </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"cmpl %%ecx, %%ebx            </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"movb %%al, -1(%%edi,%%ebx,)  </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// mov does not affect flags; -1 to</span>
<span class="normal">      </span><span class="string">"jb up_lp2                    </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">//  offset inc ebx</span>

<span class="normal">   </span><span class="string">"up_end:                         </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="normal">      </span><span class="string">"EMMS                         </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// conversion of filtered row complete</span>
<span class="preproc">#ifdef</span><span class="normal"> __PIC__</span>
<span class="normal">      </span><span class="string">"popl %%ebx                   </span><span class="specialchar">\n\t</span><span class="string">"</span>
<span class="preproc">#endif</span>

<span class="normal">      </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"=d"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_d</span><span class="symbol">),</span><span class="normal">   </span><span class="comment">// 0      // output regs (dummy)</span>
<span class="normal">        </span><span class="string">"=S"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_S</span><span class="symbol">),</span><span class="normal">   </span><span class="comment">// 1</span>
<span class="normal">        </span><span class="string">"=D"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dummy_value_D</span><span class="symbol">)</span><span class="normal">    </span><span class="comment">// 2</span>

<span class="normal">      </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"0"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">len</span><span class="symbol">),</span><span class="normal">              </span><span class="comment">// edx    // input regs</span>
<span class="normal">        </span><span class="string">"1"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">prev_row</span><span class="symbol">),</span><span class="normal">         </span><span class="comment">// esi</span>
<span class="normal">        </span><span class="string">"2"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row</span><span class="symbol">)</span><span class="normal">               </span><span class="comment">// edi</span>

<span class="normal">      </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"%eax"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%ecx"</span><span class="normal">            </span><span class="comment">// clobber list (no input regs!)</span>
<span class="preproc">#ifndef</span><span class="normal"> __PIC__</span>
<span class="normal">      </span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%ebx"</span>
<span class="preproc">#endif</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="number">0</span><span class="normal">  </span><span class="comment">/* MMX regs (%mm0, etc.) not supported by gcc 2.7.2.3 or egcs 1.1 */</span>
<span class="normal">      </span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm0"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm1"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm2"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm3"</span>
<span class="normal">      </span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm4"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm5"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm6"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%mm7"</span>
<span class="preproc">#endif</span>
<span class="normal">   </span><span class="symbol">);</span>

<span class="cbracket">}</span><span class="normal"> </span><span class="comment">// end of png_read_filter_row_mmx_up()</span>

<span class="preproc">#endif</span><span class="normal"> </span><span class="comment">/* PNG_ASSEMBLER_CODE_SUPPORTED */</span>




<span class="comment">/*===========================================================================*/</span>
<span class="comment">/*                                                                           */</span>
<span class="comment">/*                   P N G _ R E A D _ F I L T E R _ R O W                   */</span>
<span class="comment">/*                                                                           */</span>
<span class="comment">/*===========================================================================*/</span>


<span class="comment">/* Optimized png_read_filter_row routines */</span>

<span class="type">void</span><span class="normal"> </span><span class="comment">/* PRIVATE */</span>
<span class="function">png_read_filter_row</span><span class="symbol">(</span><span class="usertype">png_structp</span><span class="normal"> png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">png_row_infop</span><span class="normal"> row_info</span><span class="symbol">,</span><span class="normal"> png_bytep</span>
<span class="normal">   row</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">png_bytep</span><span class="normal"> prev_row</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> filter</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="preproc">#ifdef</span><span class="normal"> PNG_DEBUG</span>
<span class="normal">   </span><span class="type">char</span><span class="normal"> filnm</span><span class="symbol">[</span><span class="number">10</span><span class="symbol">];</span>
<span class="preproc">#endif</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_ASSEMBLER_CODE_SUPPORTED</span><span class="symbol">)</span>
<span class="comment">/* GRR:  these are superseded by png_ptr-&gt;asm_flags: */</span>
<span class="preproc">#define</span><span class="normal"> UseMMX_sub    </span><span class="number">1</span><span class="normal">   </span><span class="comment">// GRR:  converted 20000730</span>
<span class="preproc">#define</span><span class="normal"> UseMMX_up     </span><span class="number">1</span><span class="normal">   </span><span class="comment">// GRR:  converted 20000729</span>
<span class="preproc">#define</span><span class="normal"> UseMMX_avg    </span><span class="number">1</span><span class="normal">   </span><span class="comment">// GRR:  converted 20000828 (+ 16-bit bugfix 20000916)</span>
<span class="preproc">#define</span><span class="normal"> UseMMX_paeth  </span><span class="number">1</span><span class="normal">   </span><span class="comment">// GRR:  converted 20000828</span>

<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">_mmx_supported </span><span class="symbol">==</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">       </span><span class="comment">/* this should have happened in png_init_mmx_flags() already */</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="symbol">!</span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_1_0_X</span><span class="symbol">)</span>
<span class="normal">       </span><span class="function">png_warning</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"asm_flags may not have been initialized"</span><span class="symbol">);</span>
<span class="preproc">#endif</span>
<span class="normal">       </span><span class="function">png_mmx_support</span><span class="symbol">();</span>
<span class="normal">   </span><span class="cbracket">}</span>
<span class="preproc">#endif</span><span class="normal"> </span><span class="comment">/* PNG_ASSEMBLER_CODE_SUPPORTED */</span>

<span class="preproc">#ifdef</span><span class="normal"> PNG_DEBUG</span>
<span class="normal">   </span><span class="function">png_debug</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"in png_read_filter_row (pnggccrd.c)</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">   </span><span class="keyword">switch</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">filter</span><span class="symbol">)</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="keyword">case</span><span class="normal"> </span><span class="number">0</span><span class="symbol">:</span><span class="normal"> </span><span class="function">sprintf</span><span class="symbol">(</span><span class="normal">filnm</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"none"</span><span class="symbol">);</span>
<span class="normal">         </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">      </span><span class="keyword">case</span><span class="normal"> </span><span class="number">1</span><span class="symbol">:</span><span class="normal"> </span><span class="function">sprintf</span><span class="symbol">(</span><span class="normal">filnm</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"sub-%s"</span><span class="symbol">,</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_ASSEMBLER_CODE_SUPPORTED</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_THREAD_UNSAFE_OK</span><span class="symbol">)</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="symbol">!</span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_1_0_X</span><span class="symbol">)</span>
<span class="normal">        </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">asm_flags </span><span class="symbol">&amp;</span><span class="normal"> PNG_ASM_FLAG_MMX_READ_FILTER_SUB</span><span class="symbol">)?</span><span class="normal"> </span><span class="string">"MMX"</span><span class="normal"> </span><span class="symbol">:</span>
<span class="preproc">#endif</span>
<span class="preproc">#endif</span>
<span class="string">"x86"</span><span class="symbol">);</span>
<span class="normal">         </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">      </span><span class="keyword">case</span><span class="normal"> </span><span class="number">2</span><span class="symbol">:</span><span class="normal"> </span><span class="function">sprintf</span><span class="symbol">(</span><span class="normal">filnm</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"up-%s"</span><span class="symbol">,</span>
<span class="preproc">#ifdef</span><span class="normal"> PNG_ASSEMBLER_CODE_SUPPORTED</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="symbol">!</span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_1_0_X</span><span class="symbol">)</span>
<span class="normal">        </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">asm_flags </span><span class="symbol">&amp;</span><span class="normal"> PNG_ASM_FLAG_MMX_READ_FILTER_UP</span><span class="symbol">)?</span><span class="normal"> </span><span class="string">"MMX"</span><span class="normal"> </span><span class="symbol">:</span>
<span class="preproc">#endif</span>
<span class="preproc">#endif</span>
<span class="normal"> </span><span class="string">"x86"</span><span class="symbol">);</span>
<span class="normal">         </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">      </span><span class="keyword">case</span><span class="normal"> </span><span class="number">3</span><span class="symbol">:</span><span class="normal"> </span><span class="function">sprintf</span><span class="symbol">(</span><span class="normal">filnm</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"avg-%s"</span><span class="symbol">,</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_ASSEMBLER_CODE_SUPPORTED</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_THREAD_UNSAFE_OK</span><span class="symbol">)</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="symbol">!</span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_1_0_X</span><span class="symbol">)</span>
<span class="normal">        </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">asm_flags </span><span class="symbol">&amp;</span><span class="normal"> PNG_ASM_FLAG_MMX_READ_FILTER_AVG</span><span class="symbol">)?</span><span class="normal"> </span><span class="string">"MMX"</span><span class="normal"> </span><span class="symbol">:</span>
<span class="preproc">#endif</span>
<span class="preproc">#endif</span>
<span class="normal"> </span><span class="string">"x86"</span><span class="symbol">);</span>
<span class="normal">         </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">      </span><span class="keyword">case</span><span class="normal"> </span><span class="number">4</span><span class="symbol">:</span><span class="normal"> </span><span class="function">sprintf</span><span class="symbol">(</span><span class="normal">filnm</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"Paeth-%s"</span><span class="symbol">,</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_ASSEMBLER_CODE_SUPPORTED</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_THREAD_UNSAFE_OK</span><span class="symbol">)</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="symbol">!</span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_1_0_X</span><span class="symbol">)</span>
<span class="normal">        </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">asm_flags </span><span class="symbol">&amp;</span><span class="normal"> PNG_ASM_FLAG_MMX_READ_FILTER_PAETH</span><span class="symbol">)?</span><span class="normal"> </span><span class="string">"MMX"</span><span class="symbol">:</span>
<span class="preproc">#endif</span>
<span class="preproc">#endif</span>
<span class="string">"x86"</span><span class="symbol">);</span>
<span class="normal">         </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">      </span><span class="keyword">default</span><span class="symbol">:</span><span class="normal"> </span><span class="function">sprintf</span><span class="symbol">(</span><span class="normal">filnm</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"unknw"</span><span class="symbol">);</span>
<span class="normal">         </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">   </span><span class="cbracket">}</span>
<span class="normal">   </span><span class="function">png_debug2</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"row_number=%5ld, %5s, "</span><span class="symbol">,</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_number</span><span class="symbol">,</span><span class="normal"> filnm</span><span class="symbol">);</span>
<span class="normal">   </span><span class="function">png_debug1</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"row=0x%08lx, "</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">long</span><span class="symbol">)</span><span class="normal">row</span><span class="symbol">);</span>
<span class="normal">   </span><span class="function">png_debug2</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"pixdepth=%2d, bytes=%d, "</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="symbol">)</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">pixel_depth</span><span class="symbol">,</span>
<span class="normal">      </span><span class="symbol">(</span><span class="type">int</span><span class="symbol">)((</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">pixel_depth </span><span class="symbol">+</span><span class="normal"> </span><span class="number">7</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">3</span><span class="symbol">));</span>
<span class="normal">   </span><span class="function">png_debug1</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">,</span><span class="string">"rowbytes=%8ld</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> row_info</span><span class="symbol">-&gt;</span><span class="normal">rowbytes</span><span class="symbol">);</span>
<span class="preproc">#endif</span><span class="normal"> </span><span class="comment">/* PNG_DEBUG */</span>

<span class="normal">   </span><span class="keyword">switch</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">filter</span><span class="symbol">)</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="keyword">case</span><span class="normal"> PNG_FILTER_VALUE_NONE</span><span class="symbol">:</span>
<span class="normal">         </span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">      </span><span class="keyword">case</span><span class="normal"> PNG_FILTER_VALUE_SUB</span><span class="symbol">:</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_ASSEMBLER_CODE_SUPPORTED</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_THREAD_UNSAFE_OK</span><span class="symbol">)</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="symbol">!</span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_1_0_X</span><span class="symbol">)</span>
<span class="normal">         </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">asm_flags </span><span class="symbol">&amp;</span><span class="normal"> PNG_ASM_FLAG_MMX_READ_FILTER_SUB</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span>
<span class="normal">             </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">pixel_depth </span><span class="symbol">&gt;=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">mmx_bitdepth_threshold</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span>
<span class="normal">             </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">rowbytes </span><span class="symbol">&gt;=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">mmx_rowbytes_threshold</span><span class="symbol">))</span>
<span class="preproc">#else</span>
<span class="normal">         </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">_mmx_supported</span><span class="symbol">)</span>
<span class="preproc">#endif</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="function">png_read_filter_row_mmx_sub</span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">,</span><span class="normal"> row</span><span class="symbol">);</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">         </span><span class="keyword">else</span>
<span class="preproc">#endif</span><span class="normal"> </span><span class="comment">/* PNG_ASSEMBLER_CODE_SUPPORTED */</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="usertype">png_uint_32</span><span class="normal"> i</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_uint_32</span><span class="normal"> istop </span><span class="symbol">=</span><span class="normal"> row_info</span><span class="symbol">-&gt;</span><span class="normal">rowbytes</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_uint_32</span><span class="normal"> bpp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">pixel_depth </span><span class="symbol">+</span><span class="normal"> </span><span class="number">7</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">3</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> rp </span><span class="symbol">=</span><span class="normal"> row </span><span class="symbol">+</span><span class="normal"> bpp</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> lp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>

<span class="normal">            </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> bpp</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> istop</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="symbol">*</span><span class="normal">rp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(((</span><span class="type">int</span><span class="symbol">)(*</span><span class="normal">rp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="symbol">)(*</span><span class="normal">lp</span><span class="symbol">++))</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">               rp</span><span class="symbol">++;</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">         </span><span class="cbracket">}</span><span class="normal">  </span><span class="comment">/* end !UseMMX_sub */</span>
<span class="normal">         </span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">      </span><span class="keyword">case</span><span class="normal"> PNG_FILTER_VALUE_UP</span><span class="symbol">:</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_ASSEMBLER_CODE_SUPPORTED</span><span class="symbol">)</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="symbol">!</span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_1_0_X</span><span class="symbol">)</span>
<span class="normal">         </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">asm_flags </span><span class="symbol">&amp;</span><span class="normal"> PNG_ASM_FLAG_MMX_READ_FILTER_UP</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span>
<span class="normal">             </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">pixel_depth </span><span class="symbol">&gt;=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">mmx_bitdepth_threshold</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span>
<span class="normal">             </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">rowbytes </span><span class="symbol">&gt;=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">mmx_rowbytes_threshold</span><span class="symbol">))</span>
<span class="preproc">#else</span>
<span class="normal">         </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">_mmx_supported</span><span class="symbol">)</span>
<span class="preproc">#endif</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="function">png_read_filter_row_mmx_up</span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">,</span><span class="normal"> row</span><span class="symbol">,</span><span class="normal"> prev_row</span><span class="symbol">);</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">          </span><span class="keyword">else</span>
<span class="preproc">#endif</span><span class="normal"> </span><span class="comment">/* PNG_ASSEMBLER_CODE_SUPPORTED */</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="usertype">png_uint_32</span><span class="normal"> i</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_uint_32</span><span class="normal"> istop </span><span class="symbol">=</span><span class="normal"> row_info</span><span class="symbol">-&gt;</span><span class="normal">rowbytes</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> rp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> pp </span><span class="symbol">=</span><span class="normal"> prev_row</span><span class="symbol">;</span>

<span class="normal">            </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> istop</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">++</span><span class="normal">i</span><span class="symbol">)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="symbol">*</span><span class="normal">rp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(((</span><span class="type">int</span><span class="symbol">)(*</span><span class="normal">rp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="symbol">)(*</span><span class="normal">pp</span><span class="symbol">++))</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">               rp</span><span class="symbol">++;</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">         </span><span class="cbracket">}</span><span class="normal">  </span><span class="comment">/* end !UseMMX_up */</span>
<span class="normal">         </span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">      </span><span class="keyword">case</span><span class="normal"> PNG_FILTER_VALUE_AVG</span><span class="symbol">:</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_ASSEMBLER_CODE_SUPPORTED</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_THREAD_UNSAFE_OK</span><span class="symbol">)</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="symbol">!</span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_1_0_X</span><span class="symbol">)</span>
<span class="normal">         </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">asm_flags </span><span class="symbol">&amp;</span><span class="normal"> PNG_ASM_FLAG_MMX_READ_FILTER_AVG</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span>
<span class="normal">             </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">pixel_depth </span><span class="symbol">&gt;=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">mmx_bitdepth_threshold</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span>
<span class="normal">             </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">rowbytes </span><span class="symbol">&gt;=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">mmx_rowbytes_threshold</span><span class="symbol">))</span>
<span class="preproc">#else</span>
<span class="normal">         </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">_mmx_supported</span><span class="symbol">)</span>
<span class="preproc">#endif</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="function">png_read_filter_row_mmx_avg</span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">,</span><span class="normal"> row</span><span class="symbol">,</span><span class="normal"> prev_row</span><span class="symbol">);</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">         </span><span class="keyword">else</span>
<span class="preproc">#endif</span><span class="normal"> </span><span class="comment">/* PNG_ASSEMBLER_CODE_SUPPORTED */</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="usertype">png_uint_32</span><span class="normal"> i</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> rp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> pp </span><span class="symbol">=</span><span class="normal"> prev_row</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> lp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_uint_32</span><span class="normal"> bpp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">pixel_depth </span><span class="symbol">+</span><span class="normal"> </span><span class="number">7</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">3</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_uint_32</span><span class="normal"> istop </span><span class="symbol">=</span><span class="normal"> row_info</span><span class="symbol">-&gt;</span><span class="normal">rowbytes </span><span class="symbol">-</span><span class="normal"> bpp</span><span class="symbol">;</span>

<span class="normal">            </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> bpp</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="symbol">*</span><span class="normal">rp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(((</span><span class="type">int</span><span class="symbol">)(*</span><span class="normal">rp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span>
<span class="normal">                  </span><span class="symbol">((</span><span class="type">int</span><span class="symbol">)(*</span><span class="normal">pp</span><span class="symbol">++)</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">               rp</span><span class="symbol">++;</span>
<span class="normal">            </span><span class="cbracket">}</span>

<span class="normal">            </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> istop</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="symbol">*</span><span class="normal">rp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(((</span><span class="type">int</span><span class="symbol">)(*</span><span class="normal">rp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span>
<span class="normal">                  </span><span class="symbol">((</span><span class="type">int</span><span class="symbol">)(*</span><span class="normal">pp</span><span class="symbol">++</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">lp</span><span class="symbol">++)</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">               rp</span><span class="symbol">++;</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">         </span><span class="cbracket">}</span><span class="normal">  </span><span class="comment">/* end !UseMMX_avg */</span>
<span class="normal">         </span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">      </span><span class="keyword">case</span><span class="normal"> PNG_FILTER_VALUE_PAETH</span><span class="symbol">:</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_ASSEMBLER_CODE_SUPPORTED</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_THREAD_UNSAFE_OK</span><span class="symbol">)</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="symbol">!</span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_1_0_X</span><span class="symbol">)</span>
<span class="normal">         </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">asm_flags </span><span class="symbol">&amp;</span><span class="normal"> PNG_ASM_FLAG_MMX_READ_FILTER_PAETH</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span>
<span class="normal">             </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">pixel_depth </span><span class="symbol">&gt;=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">mmx_bitdepth_threshold</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span>
<span class="normal">             </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">rowbytes </span><span class="symbol">&gt;=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">mmx_rowbytes_threshold</span><span class="symbol">))</span>
<span class="preproc">#else</span>
<span class="normal">         </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">_mmx_supported</span><span class="symbol">)</span>
<span class="preproc">#endif</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="function">png_read_filter_row_mmx_paeth</span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">,</span><span class="normal"> row</span><span class="symbol">,</span><span class="normal"> prev_row</span><span class="symbol">);</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">         </span><span class="keyword">else</span>
<span class="preproc">#endif</span><span class="normal"> </span><span class="comment">/* PNG_ASSEMBLER_CODE_SUPPORTED */</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="usertype">png_uint_32</span><span class="normal"> i</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> rp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> pp </span><span class="symbol">=</span><span class="normal"> prev_row</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> lp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> cp </span><span class="symbol">=</span><span class="normal"> prev_row</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_uint_32</span><span class="normal"> bpp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">pixel_depth </span><span class="symbol">+</span><span class="normal"> </span><span class="number">7</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">3</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_uint_32</span><span class="normal"> istop </span><span class="symbol">=</span><span class="normal"> row_info</span><span class="symbol">-&gt;</span><span class="normal">rowbytes </span><span class="symbol">-</span><span class="normal"> bpp</span><span class="symbol">;</span>

<span class="normal">            </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> bpp</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="symbol">*</span><span class="normal">rp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(((</span><span class="type">int</span><span class="symbol">)(*</span><span class="normal">rp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="symbol">)(*</span><span class="normal">pp</span><span class="symbol">++))</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">               rp</span><span class="symbol">++;</span>
<span class="normal">            </span><span class="cbracket">}</span>

<span class="normal">            </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> istop</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span><span class="normal">   </span><span class="comment">/* use leftover rp,pp */</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="type">int</span><span class="normal"> a</span><span class="symbol">,</span><span class="normal"> b</span><span class="symbol">,</span><span class="normal"> c</span><span class="symbol">,</span><span class="normal"> pa</span><span class="symbol">,</span><span class="normal"> pb</span><span class="symbol">,</span><span class="normal"> pc</span><span class="symbol">,</span><span class="normal"> p</span><span class="symbol">;</span>

<span class="normal">               a </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">lp</span><span class="symbol">++;</span>
<span class="normal">               b </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">pp</span><span class="symbol">++;</span>
<span class="normal">               c </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">cp</span><span class="symbol">++;</span>

<span class="normal">               p </span><span class="symbol">=</span><span class="normal"> b </span><span class="symbol">-</span><span class="normal"> c</span><span class="symbol">;</span>
<span class="normal">               pc </span><span class="symbol">=</span><span class="normal"> a </span><span class="symbol">-</span><span class="normal"> c</span><span class="symbol">;</span>

<span class="preproc">#ifdef</span><span class="normal"> PNG_USE_ABS</span>
<span class="normal">               pa </span><span class="symbol">=</span><span class="normal"> </span><span class="function">abs</span><span class="symbol">(</span><span class="normal">p</span><span class="symbol">);</span>
<span class="normal">               pb </span><span class="symbol">=</span><span class="normal"> </span><span class="function">abs</span><span class="symbol">(</span><span class="normal">pc</span><span class="symbol">);</span>
<span class="normal">               pc </span><span class="symbol">=</span><span class="normal"> </span><span class="function">abs</span><span class="symbol">(</span><span class="normal">p </span><span class="symbol">+</span><span class="normal"> pc</span><span class="symbol">);</span>
<span class="preproc">#else</span>
<span class="normal">               pa </span><span class="symbol">=</span><span class="normal"> p </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">0</span><span class="normal"> </span><span class="symbol">?</span><span class="normal"> </span><span class="symbol">-</span><span class="normal">p </span><span class="symbol">:</span><span class="normal"> p</span><span class="symbol">;</span>
<span class="normal">               pb </span><span class="symbol">=</span><span class="normal"> pc </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">0</span><span class="normal"> </span><span class="symbol">?</span><span class="normal"> </span><span class="symbol">-</span><span class="normal">pc </span><span class="symbol">:</span><span class="normal"> pc</span><span class="symbol">;</span>
<span class="normal">               pc </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">p </span><span class="symbol">+</span><span class="normal"> pc</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">0</span><span class="normal"> </span><span class="symbol">?</span><span class="normal"> </span><span class="symbol">-(</span><span class="normal">p </span><span class="symbol">+</span><span class="normal"> pc</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">:</span><span class="normal"> p </span><span class="symbol">+</span><span class="normal"> pc</span><span class="symbol">;</span>
<span class="preproc">#endif</span>

<span class="normal">               </span><span class="comment">/*</span>
<span class="comment">                  if (pa &lt;= pb &amp;&amp; pa &lt;= pc)</span>
<span class="comment">                     p = a;</span>
<span class="comment">                  else if (pb &lt;= pc)</span>
<span class="comment">                     p = b;</span>
<span class="comment">                  else</span>
<span class="comment">                     p = c;</span>
<span class="comment">                */</span>

<span class="normal">               p </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pa </span><span class="symbol">&lt;=</span><span class="normal"> pb </span><span class="symbol">&amp;&amp;</span><span class="normal"> pa </span><span class="symbol">&lt;=</span><span class="normal"> pc</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">?</span><span class="normal"> a </span><span class="symbol">:</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pb </span><span class="symbol">&lt;=</span><span class="normal"> pc</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">?</span><span class="normal"> b </span><span class="symbol">:</span><span class="normal"> c</span><span class="symbol">;</span>

<span class="normal">               </span><span class="symbol">*</span><span class="normal">rp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(((</span><span class="type">int</span><span class="symbol">)(*</span><span class="normal">rp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> p</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">               rp</span><span class="symbol">++;</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">         </span><span class="cbracket">}</span><span class="normal">  </span><span class="comment">/* end !UseMMX_paeth */</span>
<span class="normal">         </span><span class="keyword">break</span><span class="symbol">;</span>

<span class="label">      default:</span>
<span class="normal">         </span><span class="function">png_warning</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"Ignoring bad row-filter type"</span><span class="symbol">);</span>
<span class="normal">         </span><span class="symbol">*</span><span class="normal">row</span><span class="symbol">=</span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">         </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">   </span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="preproc">#endif</span><span class="normal"> </span><span class="comment">/* PNG_HAVE_ASSEMBLER_READ_FILTER_ROW */</span>


<span class="comment">/*===========================================================================*/</span>
<span class="comment">/*                                                                           */</span>
<span class="comment">/*                      P N G _ M M X _ S U P P O R T                        */</span>
<span class="comment">/*                                                                           */</span>
<span class="comment">/*===========================================================================*/</span>

<span class="comment">/* GRR NOTES:  (1) the following code assumes 386 or better (pushfl/popfl)</span>
<span class="comment"> *             (2) all instructions compile with gcc 2.7.2.3 and later</span>
<span class="comment"> *             (3) the function is moved down here to prevent gcc from</span>
<span class="comment"> *                  inlining it in multiple places and then barfing be-</span>
<span class="comment"> *                  cause the ".NOT_SUPPORTED" label is multiply defined</span>
<span class="comment"> *             [is there a way to signal that a *single* function should</span>
<span class="comment"> *              not be inlined?  is there a way to modify the label for</span>
<span class="comment"> *              each inlined instance, e.g., by appending _1, _2, etc.?</span>
<span class="comment"> *              maybe if don't use leading "." in label name? (nope...sigh)]</span>
<span class="comment"> */</span>

<span class="type">int</span><span class="normal"> PNGAPI</span>
<span class="function">png_mmx_support</span><span class="symbol">(</span><span class="type">void</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_MMX_CODE_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">    </span><span class="type">int</span><span class="normal"> result</span><span class="symbol">;</span>
<span class="normal">    </span><span class="usertype">__asm__</span><span class="normal"> </span><span class="function">__volatile__</span><span class="normal"> </span><span class="symbol">(</span>
<span class="normal">        </span><span class="string">"pushl %%ebx          </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal">  </span><span class="comment">// ebx gets clobbered by CPUID instruction</span>
<span class="normal">        </span><span class="string">"pushl %%ecx          </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal">  </span><span class="comment">// so does ecx...</span>
<span class="normal">        </span><span class="string">"pushl %%edx          </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal">  </span><span class="comment">// ...and edx (but ecx &amp; edx safe on Linux)</span>
<span class="comment">//      ".byte  0x66          \n\t"  // convert 16-bit pushf to 32-bit pushfd</span>
<span class="comment">//      "pushf                \n\t"  // 16-bit pushf</span>
<span class="normal">        </span><span class="string">"pushfl               </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal">  </span><span class="comment">// save Eflag to stack</span>
<span class="normal">        </span><span class="string">"popl %%eax           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal">  </span><span class="comment">// get Eflag from stack into eax</span>
<span class="normal">        </span><span class="string">"movl %%eax, %%ecx    </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal">  </span><span class="comment">// make another copy of Eflag in ecx</span>
<span class="normal">        </span><span class="string">"xorl $0x200000, %%eax </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// toggle ID bit in Eflag (i.e., bit 21)</span>
<span class="normal">        </span><span class="string">"pushl %%eax          </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal">  </span><span class="comment">// save modified Eflag back to stack</span>
<span class="comment">//      ".byte  0x66          \n\t"  // convert 16-bit popf to 32-bit popfd</span>
<span class="comment">//      "popf                 \n\t"  // 16-bit popf</span>
<span class="normal">        </span><span class="string">"popfl                </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal">  </span><span class="comment">// restore modified value to Eflag reg</span>
<span class="normal">        </span><span class="string">"pushfl               </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal">  </span><span class="comment">// save Eflag to stack</span>
<span class="normal">        </span><span class="string">"popl %%eax           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal">  </span><span class="comment">// get Eflag from stack</span>
<span class="normal">        </span><span class="string">"pushl %%ecx          </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal">  </span><span class="comment">// save original Eflag to stack</span>
<span class="normal">        </span><span class="string">"popfl                </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal">  </span><span class="comment">// restore original Eflag</span>
<span class="normal">        </span><span class="string">"xorl %%ecx, %%eax    </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal">  </span><span class="comment">// compare new Eflag with original Eflag</span>
<span class="normal">        </span><span class="string">"jz 0f                </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal">  </span><span class="comment">// if same, CPUID instr. is not supported</span>

<span class="normal">        </span><span class="string">"xorl %%eax, %%eax    </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal">  </span><span class="comment">// set eax to zero</span>
<span class="comment">//      ".byte  0x0f, 0xa2    \n\t"  // CPUID instruction (two-byte opcode)</span>
<span class="normal">        </span><span class="string">"cpuid                </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal">  </span><span class="comment">// get the CPU identification info</span>
<span class="normal">        </span><span class="string">"cmpl $1, %%eax       </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal">  </span><span class="comment">// make sure eax return non-zero value</span>
<span class="normal">        </span><span class="string">"jl 0f                </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal">  </span><span class="comment">// if eax is zero, MMX is not supported</span>

<span class="normal">        </span><span class="string">"xorl %%eax, %%eax    </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal">  </span><span class="comment">// set eax to zero and...</span>
<span class="normal">        </span><span class="string">"incl %%eax           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal">  </span><span class="comment">// ...increment eax to 1.  This pair is</span>
<span class="normal">                                     </span><span class="comment">// faster than the instruction "mov eax, 1"</span>
<span class="normal">        </span><span class="string">"cpuid                </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal">  </span><span class="comment">// get the CPU identification info again</span>
<span class="normal">        </span><span class="string">"andl $0x800000, %%edx </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal"> </span><span class="comment">// mask out all bits but MMX bit (23)</span>
<span class="normal">        </span><span class="string">"cmpl $0, %%edx       </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal">  </span><span class="comment">// 0 = MMX not supported</span>
<span class="normal">        </span><span class="string">"jz 0f                </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal">  </span><span class="comment">// non-zero = yes, MMX IS supported</span>

<span class="normal">        </span><span class="string">"movl $1, %%eax       </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal">  </span><span class="comment">// set return value to 1</span>
<span class="normal">        </span><span class="string">"jmp  1f              </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal">  </span><span class="comment">// DONE:  have MMX support</span>

<span class="normal">    </span><span class="string">"0:                       </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal">  </span><span class="comment">// .NOT_SUPPORTED: target label for jump instructions</span>
<span class="normal">        </span><span class="string">"movl $0, %%eax       </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal">  </span><span class="comment">// set return value to 0</span>
<span class="normal">    </span><span class="string">"1:                       </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal">  </span><span class="comment">// .RETURN: target label for jump instructions</span>
<span class="normal">        </span><span class="string">"popl %%edx           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal">  </span><span class="comment">// restore edx</span>
<span class="normal">        </span><span class="string">"popl %%ecx           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal">  </span><span class="comment">// restore ecx</span>
<span class="normal">        </span><span class="string">"popl %%ebx           </span><span class="specialchar">\n\t</span><span class="string">"</span><span class="normal">  </span><span class="comment">// restore ebx</span>

<span class="comment">//      "ret                  \n\t"  // DONE:  no MMX support</span>
<span class="normal">                                     </span><span class="comment">// (fall through to standard C "ret")</span>

<span class="normal">        </span><span class="symbol">:</span><span class="normal"> </span><span class="string">"=a"</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">result</span><span class="symbol">)</span><span class="normal">              </span><span class="comment">// output list</span>

<span class="normal">        </span><span class="symbol">:</span><span class="normal">                            </span><span class="comment">// any variables used on input (none)</span>

<span class="normal">                                     </span><span class="comment">// no clobber list</span>
<span class="comment">//      , "%ebx", "%ecx", "%edx"     // GRR:  we handle these manually</span>
<span class="comment">//      , "memory"   // if write to a variable gcc thought was in a reg</span>
<span class="comment">//      , "cc"       // "condition codes" (flag bits)</span>
<span class="normal">    </span><span class="symbol">);</span>
<span class="normal">    _mmx_supported </span><span class="symbol">=</span><span class="normal"> result</span><span class="symbol">;</span>
<span class="preproc">#else</span>
<span class="normal">    _mmx_supported </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="preproc">#endif</span><span class="normal"> </span><span class="comment">/* PNG_MMX_CODE_SUPPORTED */</span>

<span class="normal">    </span><span class="keyword">return</span><span class="normal"> _mmx_supported</span><span class="symbol">;</span>
<span class="cbracket">}</span>


<span class="preproc">#endif</span><span class="normal"> </span><span class="comment">/* PNG_USE_PNGGCCRD */</span>
</tt></pre></div><div style="text-align: right; padding: 8pt; font-size: 12px"><a href="/xmlfeed/weblog-rss20.xml"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAAAPAgMAAAAOp6AcAAAADFBMVEVmZmb/ZgD///+JjnlbTUWmAAAACXBIWXMAAABIAAAASABGyWs+AAAACXZwQWcAAABQAAAADwCexKkxAAAAWUlEQVQYlWNgwAa0VmGAFQyqoSCQ/x8J/CBFMCt0ZdTU/F/7/+1HEkydFpoKVPn+93sUlUujQvP/7UcRTAuNDJ2a//s/imDqtKVZofm/1qGYSZk7sfodGwAAiobBJtffoNAAAAAASUVORK5CYII=" alt="RSS 2.0 Weblog Feed" width="80" height="15"/></a> <a href="/xmlfeed/weblog-atom10.xml"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAAAPAgMAAAAOp6AcAAAADFBMVEVmZmb/ZgD///+JjnlbTUWmAAAAaklEQVQYlWNgwAa0VmGAFQyqoSCQ/x8J/CBFMDV16rTQ/H/7V//69+//v/3/9oMEI6cuAwr+fv/+/b5d///v//0eJBgWOhMo+Gs9UPAdXDBy6lSYyn9wQZCZS0GCYDPXQcykzJ1Y/Y4NAABKvL80wyoMPgAAAABJRU5ErkJggg==" alt="Atom 1.0 Weblog Feed" width="80" height="15"/></a> <a href="http://validator.w3.org/check?uri=referer"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAAAPCAMAAABEF7i9AAAB1FBMVEUHQIgIRY0MN4QNRYoSRYsXUpIYVJQeUpUhWpgjUJMjWpgmU5QnXJkuYZ0uYpwwV5YyZJ4zaKM3ZaA5aaI6aqM6a6E8ZqA8Z6BAbaRBbqdCbaVHd61KSkpKcaZQUFBUf69UgbBVVVVXfq9Yg7NZhbJZh7RagrNeXVxeh7RfjLdgYGBiiLZmZmZnZ2doirhpkbt0m8F3m8B3ncJ5lb55ocR+ocSDgX+Do8eEpMqGhoaHp8iIpMeJjnmJpseKqMeOqsqPsdCQrcyVlZWVsM2Zs9CZtNCfu9ahoaGhuNShudSivNSjtMWjvNSmpqWnpqSrw9qvxNqyxdmyxdyzsK6zs7Ozx9y0xt21yN22tra4y+K80eK/v7/AwMDExMTEy9DH2ejK2+jM2ujN3uvP0dLR0NDR3uvS3uvS3+zU4u3V1dXY2dnY4u7Y4+3b5e/d3d3d5u/d5/De3t7f39/h4uLj4uHj6/Ll7PXm7fTn7/Xo7/Tp7/bq7Ozr6unr8ffw8PDw9vvx9fny+P7z8/Pz9vnz9vv3+fv4+vz5+vz6+vr6+/36/P36///7+/77/Pz7/f37/f78/Pz8/f38/f79/f39/f79/f/9/v79///+/v7+/v////3///+tYR2LAAABKklEQVQ4y2PQoTJg0JlNVYDPQBsyAMTAqaFes8tdsmdPCtA3MDStr3GKKK6myMAprgJ9pcpWs/MlRExYJBvNZLR0sigycHYOV1S7mtjsQJ4gf+HIFPXoWMs6qIGzIRiKZs9GFoEaMRuZhhrYqqJXy8uZYauRxC/VHew7e3YTPAxnI5swG6JxNrKBNjB1EFmIgV0+HA6C8pqqzhXG7BbJJROQIwViMYQ7G2oDQQNn57JyG7kxiCfObrBmS5+BHMuYLkTzMnYDm5WY4lOZZRPKZocxes+aPbuwCFsYohiICLvZsKBAMrDTQ7K/StveU8icTzrOL8JdLpOyWJ49u8Bx9ozw8DY7UYW03hhdxZAOSg2c3jN79rSJs1vSKmfOnpFXNJmynELlvExlAADnaZpLFGEC2wAAAABJRU5ErkJggg==" alt="Valid XHTML 1.1" width="80" height="15"/></a> <a href="http://jigsaw.w3.org/css-validator/check/referer"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAAAPCAMAAABEF7i9AAAB1FBMVEUHQIgIRY0MN4QNRYoSRYsXUpIYVJQeUpUhWpgjUJMjWpgmU5QnXJkuYZ0uYpwwV5YyZJ4zaKM3ZaA5aaI6aqM6a6E8ZqA8Z6BAbaRBbqdCbaVHd61KSkpKcaZQUFBUf69UgbBVVVVXfq9Yg7NZhbJZh7RagrNeXVxeh7RfjLdgYGBiiLZmZmZnZ2doirhpkbt0m8F3m8B3ncJ5lb55ocR+ocSDgX+Do8eEpMqGhoaHp8iIpMeJjnmJpseKqMeOqsqPsdCQrcyVlZWVsM2Zs9CZtNCfu9ahoaGhuNShudSivNSjtMWjvNSmpqWnpqSrw9qvxNqyxdmyxdyzsK6zs7Ozx9y0xt21yN22tra4y+K80eK/v7/AwMDExMTEy9DH2ejK2+jM2ujN3uvP0dLR0NDR3uvS3uvS3+zU4u3V1dXY2dnY4u7Y4+3b5e/d3d3d5u/d5/De3t7f39/h4uLj4uHj6/Ll7PXm7fTn7/Xo7/Tp7/bq7Ozr6unr8ffw8PDw9vvx9fny+P7z8/Pz9vnz9vv3+fv4+vz5+vz6+vr6+/36/P36///7+/77/Pz7/f37/f78/Pz8/f38/f79/f39/f79/f/9/v79///+/v7+/v////3///+tYR2LAAABEUlEQVQ4y2PQoTJg0JlNVYDPQBsyAMTAqaFes8tdsmdPCtA3MDStr3GKKK6myMAprgJ9pcpWs/MlRExYJBvNZLR0sigycHYOV1S7mtjsQJ4gf+HIFPXoWMs6mIEQCsIjwhKoga0qerW8nBm2Gkn8Ut3BvrNnN8HCcDYM2cBIogzs8uFwEJTXVHWuMGa3SC6ZgIgUqCEwdxJr4OxcVm4jNwbxxNkN1mzpM2ajGIjsPGK9PLtZiSk+lVk2oWx2GKP3rNmzC4tQwpDoIIQb2Okh2V+lbe8pZM4nHecX4S6XSVksz55d4Dh7Rnh4m52oQlpvjK5iSAelBk7vmT172sTZLWmVM2fPyCuaTFlOoXJepjIAANlljDGY/l5pAAAAAElFTkSuQmCC" alt="Valid CSS (2.1)" width="80" height="15"/></a><br/>Copyright 2005-2015 <a href="/about/">Timo Bingmann</a> - <a href="/about/impressum.html">Impressum</a></div><script type="text/javascript">var _paq = _paq || []; _paq.push(["trackPageView"]); _paq.push(["enableLinkTracking"]);(function() {var u=(("https:" == document.location.protocol) ? "https" : "http") + "://panthema.net/wik-331/"; _paq.push(["setTrackerUrl", u+"js/"]); _paq.push(["setSiteId", "2"]);var d=document, g=d.createElement("script"), s=d.getElementsByTagName("script")[0]; g.type="text/javascript";g.defer=true; g.async=true; g.src=u+"js/"; s.parentNode.insertBefore(g,s);})();</script><noscript><p><img src="http://panthema.net/wik-331/js/?idsite=2&amp;rec=1" style="border:0" alt="" /></p></noscript></body></html>