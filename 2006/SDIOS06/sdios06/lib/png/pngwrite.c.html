<?xml version="1.0" encoding="iso-8859-1"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta content="text/html; charset=iso-8859-1" http-equiv="content-type" /><meta name="viewport" content="initial-scale=1"><title>/2006/SDIOS06/sdios06/lib/png/pngwrite.c - panthema.net</title><link rel="stylesheet" type="text/css" href="/css/base.css" /><link rel="stylesheet" type="text/css" href="/css/fonts.css" /><link rel="alternate" type="application/rss+xml" title="panthema.net Weblog Feed RSS 2.0" href="http://panthema.net/xmlfeed/weblog-rss20.xml" /><link rel="alternate" type="application/atom+xml" title="panthema.net Weblog Feed Atom 1.0" href="http://panthema.net/xmlfeed/weblog-atom10.xml" /><script type="text/javascript" src="/js/base.js"></script><script type="text/javascript">/* <!-- */makeIEHover = function() {var lis = document.getElementById('ptnav').getElementsByTagName('li');for (var i = 0; i < lis.length; i++) {lis[i].onmouseover = function() {this.className += ' sfhover';};lis[i].onmouseout = function() {this.className = this.className.replace(new RegExp(' sfhover\b'), '');};}};if (window.attachEvent) window.attachEvent('onload', makeIEHover);/* --> */</script></head><body style="background-image: url(/img/bgfractal3.jpg)" lang="en"><div class="pttopbar"><div style="float: right"><ul id="ptnav"><li class="top"><a class="ni" href="/"><i class="icon-book"></i> Weblog</a><ul style="margin-left: -6px; margin-top: 4px" class="nx"><li><a href="/2019/">2019</a></li><li><a href="/2018/">2018</a></li><li><a href="/2017/">2017</a></li><li><a href="/2016/">2016</a></li><li><a href="/2015/">2015</a></li><li><a href="/2014/">2014</a></li><li><a href="/2013/">2013</a></li><li><a href="/2012/">2012</a></li><li><a href="/2011/">2011</a></li><li><a href="/2010/">2010</a></li><li><a href="/2009/">2009</a></li><li><a href="/2008/">2008</a></li><li><a href="/2007/">2007</a></li><li><a href="/2006/">2006</a></li><li class="nt"><a href="/2005/">2005</a></li><li class="ns"><a href="/xmlfeed/weblog-rss20.xml">RSS Feed</a></li><li class="nt"><a href="/xmlfeed/weblog-atom10.xml">XML Atom</a></li><li class="ns"><a href="/search.html">Search</a></li></ul></li><li class="top"><a class="ni" href="/tags/"><i class="icon-tags"></i> Tags</a><div style="width: 14em; margin-left: -9em; margin-top: 4px"><a style="font-size: 10pt" href="/tags/algebra.html">algebra</a> <a style="font-size: 16pt" href="/tags/c++.html">c++</a> <a style="font-size: 12pt" href="/tags/code-example.html">code-example</a> <a style="font-size: 14pt" href="/tags/code-snippet.html">code-snippet</a> <a style="font-size: 11pt" href="/tags/coding_tricks.html">coding tricks</a> <a style="font-size: 10pt" href="/tags/compsci.html">compsci</a> <a style="font-size: 10pt" href="/tags/compsci_study_thesis.html">compsci study thesis</a> <a style="font-size: 9pt" href="/tags/crypto-speedtest.html">crypto-speedtest</a> <a style="font-size: 10pt" href="/tags/cryptography.html">cryptography</a> <a style="font-size: 9pt" href="/tags/cryptote.html">cryptote</a> <a style="font-size: 11pt" href="/tags/dissertation.html">dissertation</a> <a style="font-size: 10pt" href="/tags/electronics.html">electronics</a> <a style="font-size: 12pt" href="/tags/flex-bison-cpp-example.html">flex-bison-cpp-example</a> <a style="font-size: 16pt" href="/tags/frontpage.html">frontpage</a> <a style="font-size: 15pt" href="/tags/fun.html">fun</a> <a style="font-size: 10pt" href="/tags/graphviz.html">graphviz</a> <a style="font-size: 9pt" href="http://www.hmtg.de">hartmetall</a> <a style="font-size: 9pt" href="/tags/helppc.html">helppc</a> <a style="font-size: 9pt" href="/tags/hifi_selbstbau.html">hifi selbstbau</a> <a style="font-size: 10pt" href="/tags/latex.html">latex</a> <a style="font-size: 10pt" href="/tags/LEDs.html">LEDs</a> <a style="font-size: 10pt" href="/tags/librivox.html">librivox</a> <a style="font-size: 10pt" href="/tags/linux.html">linux</a> <a style="font-size: 9pt" href="/tags/market.html">market</a> <a style="font-size: 9pt" href="/tags/massive-sorting.html">massive-sorting</a> <a style="font-size: 11pt" href="/tags/maths.html">maths</a> <a style="font-size: 9pt" href="/tags/music.html">music</a> <a style="font-size: 10pt" href="/tags/netfundamentals.html">netfundamentals</a> <a style="font-size: 11pt" href="/tags/ns-3.html">ns-3</a> <a style="font-size: 10pt" href="/tags/parallel-string-sorting.html">parallel-string-sorting</a> <a style="font-size: 14pt" href="/tags/parsing.html">parsing</a> <a style="font-size: 9pt" href="/tags/qtsqlview.html">qtsqlview</a> <a style="font-size: 14pt" href="/tags/research.html">research</a> <a style="font-size: 11pt" href="/tags/sdios06.html">sdios06</a> <a style="font-size: 9pt" href="/tags/sdlfractal.html">sdlfractal</a> <a style="font-size: 16pt" href="/tags/sorting.html">sorting</a> <a style="font-size: 13pt" href="/tags/sound_of_sorting.html">sound of sorting</a> <a style="font-size: 10pt" href="/tags/stringology.html">stringology</a> <a style="font-size: 16pt" href="/tags/stx-btree.html">stx-btree</a> <a style="font-size: 16pt" href="/tags/stxxl.html">stxxl</a> <a style="font-size: 16pt" href="/tags/talk.html">talk</a> <a style="font-size: 15pt" href="/tags/thrill.html">thrill</a> <a style="font-size: 10pt" href="/tags/tutorium.html">tutorium</a> <a style="font-size: 16pt" href="/tags/university.html">university</a> <a style="font-size: 14pt" href="/tags/utilities.html">utilities</a> <a style="font-size: 10pt" href="/tags/vncrec.html">vncrec</a> <a style="font-size: 9pt" href="/tags/webdesign.html">webdesign</a> </div></li><li class="top"> <a class="ni" href="#"><i class="icon-cubes"></i> Projects</a> <ul style="margin-left: -8em; margin-top: 4px;" class="nx"> <li><a href="/2019/1008-COBS-A-Compact-Bit-Sliced-Signature-Index/">COBS</a></li> <li><a href="/2009/cryptote/">CryptoTE</a></li> <li><a href="/2009/digup/">digup</a></li> <li><a href="/2013/disk-filltest/">disk-filltest</a></li> <li><a href="/2012/1119-eSAIS-Inducing-Suffix-and-LCP-Arrays-in-External-Memory/">eSAIS-LCP</a></li> <li><a href="/2007/flex-bison-cpp-example/">Flex Bison C++ Example</a></li> <li><a href="/2013/malloc_count/">malloc_count</a></li> <li><a href="/2016/0114-diploma-thesis/">On Bispanning Graphs</a></li> <li><a href="/2013/pmbw/">Parallel Memory Bandwidth</a></li> <li><a href="/2013/parallel-string-sorting/">Parallel String Sorting</a></li> <li><a href="/2014/sqlplot-tools/">SqlPlotTools</a></li> <li><a href="/2013/sound-of-sorting/">The Sound of Sorting</a></li> <li><a href="/2007/stx-btree/">STX B+ Tree</a></li> <li><a href="/2010/stx-cbtreedb/">STX Constant BTreeDB</a></li> <li><a href="/2010/stx-execpipe/">STX ExecPipe</a></li> <li><a href="/2007/stx-exparser/">STX Expression Parser</a></li> <li><a href="/tags/stxxl.html">STXXL 1.4</a></li> <li><a href="/tags/thrill.html">Thrill - Big Data Framework</a></li> <li class="nt"><a href="/2014/vncrec-rgb/">VNCrec RGB 0.4</a></li> <li class="ns"><a href="/search.html">Search</a></li> </ul></li><li class="top"> <a class="ni" href="/publications.html"><i class="icon-graduation-cap"></i> Publications</a></li><li class="top"> <a class="ni" href="/about/"><i class="icon-info-circled"></i> About</a> <ul style="margin-left: -6em; margin-top: 4px" class="nx"> <li><a href="/about/">Timo Bingmann</a></li> <li><a href="/about/impressum.html">Impressum</a></li> </ul></li><li class="top"> <a class="ni" href="/subscribe.html"><i class="icon-rss-squared"></i> Subscribe</a></li></ul></div><div style="padding: 6px"><a href="/">panthema</a>  / <a href="/2006/">2006</a> / <a href="/2006/SDIOS06/">SDIOS06</a> / <a href="/2006/SDIOS06/sdios06/">sdios06</a> / <a href="/2006/SDIOS06/sdios06/lib/">lib</a> / <a href="/2006/SDIOS06/sdios06/lib/png/">png</a> / <a href="/2006/SDIOS06/sdios06/lib/png/pngwrite.c.html">pngwrite.c</a> (<a href="/2006/SDIOS06/sdios06/lib/png/pngwrite.c">Download File</a>)</div></div><div class="ptfullwidth"><pre class="codesnippet" style="font-family: monospace"><tt>
<span class="comment">/* pngwrite.c - general routines to write a PNG file</span>
<span class="comment"> *</span>
<span class="comment"> * Last changed in libpng 1.2.9 April 14, 2006</span>
<span class="comment"> * For conditions of distribution and use, see copyright notice in png.h</span>
<span class="comment"> * Copyright (c) 1998-2006 Glenn Randers-Pehrson</span>
<span class="comment"> * (Version 0.96 Copyright (c) 1996, 1997 Andreas Dilger)</span>
<span class="comment"> * (Version 0.88 Copyright (c) 1995, 1996 Guy Eric Schalnat, Group 42, Inc.)</span>
<span class="comment"> */</span>

<span class="comment">/* get internal access to png.h */</span>
<span class="preproc">#define</span><span class="normal"> PNG_INTERNAL</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">"png.h"</span>
<span class="preproc">#ifdef</span><span class="normal"> PNG_WRITE_SUPPORTED</span>

<span class="comment">/* Writes all the PNG information.  This is the suggested way to use the</span>
<span class="comment"> * library.  If you have a new chunk to add, make a function to write it,</span>
<span class="comment"> * and put it in the correct location here.  If you want the chunk written</span>
<span class="comment"> * after the image data, put it in png_write_end().  I strongly encourage</span>
<span class="comment"> * you to supply a PNG_INFO_ flag, and check info_ptr-&gt;valid before writing</span>
<span class="comment"> * the chunk, as that will keep the code from breaking if you want to just</span>
<span class="comment"> * write a plain PNG file.  If you have long comments, I suggest writing</span>
<span class="comment"> * them in png_write_end(), and compressing them.</span>
<span class="comment"> */</span>
<span class="type">void</span><span class="normal"> PNGAPI</span>
<span class="function">png_write_info_before_PLTE</span><span class="symbol">(</span><span class="usertype">png_structp</span><span class="normal"> png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">png_infop</span><span class="normal"> info_ptr</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">   </span><span class="function">png_debug</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"in png_write_info_before_PLTE</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr </span><span class="symbol">==</span><span class="normal"> NULL </span><span class="symbol">||</span><span class="normal"> info_ptr </span><span class="symbol">==</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">      </span><span class="keyword">return</span><span class="symbol">;</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">mode </span><span class="symbol">&amp;</span><span class="normal"> PNG_WROTE_INFO_BEFORE_PLTE</span><span class="symbol">))</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">   </span><span class="function">png_write_sig</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* write PNG signature */</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_MNG_FEATURES_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="symbol">((</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">mode</span><span class="symbol">&amp;</span><span class="normal">PNG_HAVE_PNG_SIGNATURE</span><span class="symbol">)&amp;&amp;(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">mng_features_permitted</span><span class="symbol">))</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="function">png_warning</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="string">"MNG features are not allowed in a PNG datastream"</span><span class="symbol">);</span>
<span class="normal">      png_ptr</span><span class="symbol">-&gt;</span><span class="normal">mng_features_permitted</span><span class="symbol">=</span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">   </span><span class="cbracket">}</span>
<span class="preproc">#endif</span>
<span class="normal">   </span><span class="comment">/* write IHDR information. */</span>
<span class="normal">   </span><span class="function">png_write_IHDR</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> info_ptr</span><span class="symbol">-&gt;</span><span class="normal">width</span><span class="symbol">,</span><span class="normal"> info_ptr</span><span class="symbol">-&gt;</span><span class="normal">height</span><span class="symbol">,</span>
<span class="normal">      info_ptr</span><span class="symbol">-&gt;</span><span class="normal">bit_depth</span><span class="symbol">,</span><span class="normal"> info_ptr</span><span class="symbol">-&gt;</span><span class="normal">color_type</span><span class="symbol">,</span><span class="normal"> info_ptr</span><span class="symbol">-&gt;</span><span class="normal">compression_type</span><span class="symbol">,</span>
<span class="normal">      info_ptr</span><span class="symbol">-&gt;</span><span class="normal">filter_type</span><span class="symbol">,</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_WRITE_INTERLACING_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">      info_ptr</span><span class="symbol">-&gt;</span><span class="normal">interlace_type</span><span class="symbol">);</span>
<span class="preproc">#else</span>
<span class="normal">      </span><span class="number">0</span><span class="symbol">);</span>
<span class="preproc">#endif</span>
<span class="normal">   </span><span class="comment">/* the rest of these check to see if the valid field has the appropriate</span>
<span class="comment">      flag set, and if it does, writes the chunk. */</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_WRITE_gAMA_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">info_ptr</span><span class="symbol">-&gt;</span><span class="normal">valid </span><span class="symbol">&amp;</span><span class="normal"> PNG_INFO_gAMA</span><span class="symbol">)</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="preproc">#  ifdef</span><span class="normal"> PNG_FLOATING_POINT_SUPPORTED</span>
<span class="normal">      </span><span class="function">png_write_gAMA</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> info_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma</span><span class="symbol">);</span>
<span class="preproc">#else</span>
<span class="preproc">#ifdef</span><span class="normal"> PNG_FIXED_POINT_SUPPORTED</span>
<span class="normal">      </span><span class="function">png_write_gAMA_fixed</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> info_ptr</span><span class="symbol">-&gt;</span><span class="normal">int_gamma</span><span class="symbol">);</span>
<span class="preproc">#  endif</span>
<span class="preproc">#endif</span>
<span class="normal">   </span><span class="cbracket">}</span>
<span class="preproc">#endif</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_WRITE_sRGB_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">info_ptr</span><span class="symbol">-&gt;</span><span class="normal">valid </span><span class="symbol">&amp;</span><span class="normal"> PNG_INFO_sRGB</span><span class="symbol">)</span>
<span class="normal">      </span><span class="function">png_write_sRGB</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="symbol">)</span><span class="normal">info_ptr</span><span class="symbol">-&gt;</span><span class="normal">srgb_intent</span><span class="symbol">);</span>
<span class="preproc">#endif</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_WRITE_iCCP_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">info_ptr</span><span class="symbol">-&gt;</span><span class="normal">valid </span><span class="symbol">&amp;</span><span class="normal"> PNG_INFO_iCCP</span><span class="symbol">)</span>
<span class="normal">      </span><span class="function">png_write_iCCP</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> info_ptr</span><span class="symbol">-&gt;</span><span class="normal">iccp_name</span><span class="symbol">,</span><span class="normal"> PNG_COMPRESSION_TYPE_BASE</span><span class="symbol">,</span>
<span class="normal">                     info_ptr</span><span class="symbol">-&gt;</span><span class="normal">iccp_profile</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="symbol">)</span><span class="normal">info_ptr</span><span class="symbol">-&gt;</span><span class="normal">iccp_proflen</span><span class="symbol">);</span>
<span class="preproc">#endif</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_WRITE_sBIT_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">info_ptr</span><span class="symbol">-&gt;</span><span class="normal">valid </span><span class="symbol">&amp;</span><span class="normal"> PNG_INFO_sBIT</span><span class="symbol">)</span>
<span class="normal">      </span><span class="function">png_write_sBIT</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">&amp;(</span><span class="normal">info_ptr</span><span class="symbol">-&gt;</span><span class="normal">sig_bit</span><span class="symbol">),</span><span class="normal"> info_ptr</span><span class="symbol">-&gt;</span><span class="normal">color_type</span><span class="symbol">);</span>
<span class="preproc">#endif</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_WRITE_cHRM_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">info_ptr</span><span class="symbol">-&gt;</span><span class="normal">valid </span><span class="symbol">&amp;</span><span class="normal"> PNG_INFO_cHRM</span><span class="symbol">)</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="preproc">#ifdef</span><span class="normal"> PNG_FLOATING_POINT_SUPPORTED</span>
<span class="normal">      </span><span class="function">png_write_cHRM</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span>
<span class="normal">         info_ptr</span><span class="symbol">-&gt;</span><span class="normal">x_white</span><span class="symbol">,</span><span class="normal"> info_ptr</span><span class="symbol">-&gt;</span><span class="normal">y_white</span><span class="symbol">,</span>
<span class="normal">         info_ptr</span><span class="symbol">-&gt;</span><span class="normal">x_red</span><span class="symbol">,</span><span class="normal"> info_ptr</span><span class="symbol">-&gt;</span><span class="normal">y_red</span><span class="symbol">,</span>
<span class="normal">         info_ptr</span><span class="symbol">-&gt;</span><span class="normal">x_green</span><span class="symbol">,</span><span class="normal"> info_ptr</span><span class="symbol">-&gt;</span><span class="normal">y_green</span><span class="symbol">,</span>
<span class="normal">         info_ptr</span><span class="symbol">-&gt;</span><span class="normal">x_blue</span><span class="symbol">,</span><span class="normal"> info_ptr</span><span class="symbol">-&gt;</span><span class="normal">y_blue</span><span class="symbol">);</span>
<span class="preproc">#else</span>
<span class="preproc">#  ifdef</span><span class="normal"> PNG_FIXED_POINT_SUPPORTED</span>
<span class="normal">      </span><span class="function">png_write_cHRM_fixed</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span>
<span class="normal">         info_ptr</span><span class="symbol">-&gt;</span><span class="normal">int_x_white</span><span class="symbol">,</span><span class="normal"> info_ptr</span><span class="symbol">-&gt;</span><span class="normal">int_y_white</span><span class="symbol">,</span>
<span class="normal">         info_ptr</span><span class="symbol">-&gt;</span><span class="normal">int_x_red</span><span class="symbol">,</span><span class="normal"> info_ptr</span><span class="symbol">-&gt;</span><span class="normal">int_y_red</span><span class="symbol">,</span>
<span class="normal">         info_ptr</span><span class="symbol">-&gt;</span><span class="normal">int_x_green</span><span class="symbol">,</span><span class="normal"> info_ptr</span><span class="symbol">-&gt;</span><span class="normal">int_y_green</span><span class="symbol">,</span>
<span class="normal">         info_ptr</span><span class="symbol">-&gt;</span><span class="normal">int_x_blue</span><span class="symbol">,</span><span class="normal"> info_ptr</span><span class="symbol">-&gt;</span><span class="normal">int_y_blue</span><span class="symbol">);</span>
<span class="preproc">#  endif</span>
<span class="preproc">#endif</span>
<span class="normal">   </span><span class="cbracket">}</span>
<span class="preproc">#endif</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_WRITE_UNKNOWN_CHUNKS_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">info_ptr</span><span class="symbol">-&gt;</span><span class="normal">unknown_chunks_num</span><span class="symbol">)</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">       </span><span class="usertype">png_unknown_chunk</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">up</span><span class="symbol">;</span>

<span class="normal">       </span><span class="function">png_debug</span><span class="symbol">(</span><span class="number">5</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"writing extra chunks</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>

<span class="normal">       </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">up </span><span class="symbol">=</span><span class="normal"> info_ptr</span><span class="symbol">-&gt;</span><span class="normal">unknown_chunks</span><span class="symbol">;</span>
<span class="normal">            up </span><span class="symbol">&lt;</span><span class="normal"> info_ptr</span><span class="symbol">-&gt;</span><span class="normal">unknown_chunks </span><span class="symbol">+</span><span class="normal"> info_ptr</span><span class="symbol">-&gt;</span><span class="normal">unknown_chunks_num</span><span class="symbol">;</span>
<span class="normal">            up</span><span class="symbol">++)</span>
<span class="normal">       </span><span class="cbracket">{</span>
<span class="normal">         </span><span class="type">int</span><span class="normal"> keep</span><span class="symbol">=</span><span class="function">png_handle_as_unknown</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> up</span><span class="symbol">-&gt;</span><span class="normal">name</span><span class="symbol">);</span>
<span class="normal">         </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">keep </span><span class="symbol">!=</span><span class="normal"> PNG_HANDLE_CHUNK_NEVER </span><span class="symbol">&amp;&amp;</span>
<span class="normal">            up</span><span class="symbol">-&gt;</span><span class="normal">location </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">!(</span><span class="normal">up</span><span class="symbol">-&gt;</span><span class="normal">location </span><span class="symbol">&amp;</span><span class="normal"> PNG_HAVE_PLTE</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span>
<span class="normal">            </span><span class="symbol">!(</span><span class="normal">up</span><span class="symbol">-&gt;</span><span class="normal">location </span><span class="symbol">&amp;</span><span class="normal"> PNG_HAVE_IDAT</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span>
<span class="normal">            </span><span class="symbol">((</span><span class="normal">up</span><span class="symbol">-&gt;</span><span class="normal">name</span><span class="symbol">[</span><span class="number">3</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x20</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> keep </span><span class="symbol">==</span><span class="normal"> PNG_HANDLE_CHUNK_ALWAYS </span><span class="symbol">||</span>
<span class="normal">            </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">flags </span><span class="symbol">&amp;</span><span class="normal"> PNG_FLAG_KEEP_UNSAFE_CHUNKS</span><span class="symbol">)))</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="function">png_write_chunk</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> up</span><span class="symbol">-&gt;</span><span class="normal">name</span><span class="symbol">,</span><span class="normal"> up</span><span class="symbol">-&gt;</span><span class="normal">data</span><span class="symbol">,</span><span class="normal"> up</span><span class="symbol">-&gt;</span><span class="normal">size</span><span class="symbol">);</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">       </span><span class="cbracket">}</span>
<span class="normal">   </span><span class="cbracket">}</span>
<span class="preproc">#endif</span>
<span class="normal">      png_ptr</span><span class="symbol">-&gt;</span><span class="normal">mode </span><span class="symbol">|=</span><span class="normal"> PNG_WROTE_INFO_BEFORE_PLTE</span><span class="symbol">;</span>
<span class="normal">   </span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> PNGAPI</span>
<span class="function">png_write_info</span><span class="symbol">(</span><span class="usertype">png_structp</span><span class="normal"> png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">png_infop</span><span class="normal"> info_ptr</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_WRITE_TEXT_SUPPORTED</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_WRITE_sPLT_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="type">int</span><span class="normal"> i</span><span class="symbol">;</span>
<span class="preproc">#endif</span>

<span class="normal">   </span><span class="function">png_debug</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"in png_write_info</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>

<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr </span><span class="symbol">==</span><span class="normal"> NULL </span><span class="symbol">||</span><span class="normal"> info_ptr </span><span class="symbol">==</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">      </span><span class="keyword">return</span><span class="symbol">;</span>

<span class="normal">   </span><span class="function">png_write_info_before_PLTE</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> info_ptr</span><span class="symbol">);</span>

<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">info_ptr</span><span class="symbol">-&gt;</span><span class="normal">valid </span><span class="symbol">&amp;</span><span class="normal"> PNG_INFO_PLTE</span><span class="symbol">)</span>
<span class="normal">      </span><span class="function">png_write_PLTE</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> info_ptr</span><span class="symbol">-&gt;</span><span class="normal">palette</span><span class="symbol">,</span>
<span class="normal">         </span><span class="symbol">(</span><span class="normal">png_uint_32</span><span class="symbol">)</span><span class="normal">info_ptr</span><span class="symbol">-&gt;</span><span class="normal">num_palette</span><span class="symbol">);</span>
<span class="normal">   </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">info_ptr</span><span class="symbol">-&gt;</span><span class="normal">color_type </span><span class="symbol">==</span><span class="normal"> PNG_COLOR_TYPE_PALETTE</span><span class="symbol">)</span>
<span class="normal">      </span><span class="function">png_error</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"Valid palette required for paletted images"</span><span class="symbol">);</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_WRITE_tRNS_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">info_ptr</span><span class="symbol">-&gt;</span><span class="normal">valid </span><span class="symbol">&amp;</span><span class="normal"> PNG_INFO_tRNS</span><span class="symbol">)</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_WRITE_INVERT_ALPHA_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">         </span><span class="comment">/* invert the alpha channel (in tRNS) */</span>
<span class="normal">         </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">&amp;</span><span class="normal"> PNG_INVERT_ALPHA</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span>
<span class="normal">            info_ptr</span><span class="symbol">-&gt;</span><span class="normal">color_type </span><span class="symbol">==</span><span class="normal"> PNG_COLOR_TYPE_PALETTE</span><span class="symbol">)</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="type">int</span><span class="normal"> j</span><span class="symbol">;</span>
<span class="normal">            </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">j</span><span class="symbol">=</span><span class="number">0</span><span class="symbol">;</span><span class="normal"> j</span><span class="symbol">&lt;(</span><span class="type">int</span><span class="symbol">)</span><span class="normal">info_ptr</span><span class="symbol">-&gt;</span><span class="normal">num_trans</span><span class="symbol">;</span><span class="normal"> j</span><span class="symbol">++)</span>
<span class="normal">               info_ptr</span><span class="symbol">-&gt;</span><span class="normal">trans</span><span class="symbol">[</span><span class="normal">j</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="number">255</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> info_ptr</span><span class="symbol">-&gt;</span><span class="normal">trans</span><span class="symbol">[</span><span class="normal">j</span><span class="symbol">]);</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="preproc">#endif</span>
<span class="normal">      </span><span class="function">png_write_tRNS</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> info_ptr</span><span class="symbol">-&gt;</span><span class="normal">trans</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">&amp;(</span><span class="normal">info_ptr</span><span class="symbol">-&gt;</span><span class="normal">trans_values</span><span class="symbol">),</span>
<span class="normal">         info_ptr</span><span class="symbol">-&gt;</span><span class="normal">num_trans</span><span class="symbol">,</span><span class="normal"> info_ptr</span><span class="symbol">-&gt;</span><span class="normal">color_type</span><span class="symbol">);</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="preproc">#endif</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_WRITE_bKGD_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">info_ptr</span><span class="symbol">-&gt;</span><span class="normal">valid </span><span class="symbol">&amp;</span><span class="normal"> PNG_INFO_bKGD</span><span class="symbol">)</span>
<span class="normal">      </span><span class="function">png_write_bKGD</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">&amp;(</span><span class="normal">info_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">),</span><span class="normal"> info_ptr</span><span class="symbol">-&gt;</span><span class="normal">color_type</span><span class="symbol">);</span>
<span class="preproc">#endif</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_WRITE_hIST_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">info_ptr</span><span class="symbol">-&gt;</span><span class="normal">valid </span><span class="symbol">&amp;</span><span class="normal"> PNG_INFO_hIST</span><span class="symbol">)</span>
<span class="normal">      </span><span class="function">png_write_hIST</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> info_ptr</span><span class="symbol">-&gt;</span><span class="normal">hist</span><span class="symbol">,</span><span class="normal"> info_ptr</span><span class="symbol">-&gt;</span><span class="normal">num_palette</span><span class="symbol">);</span>
<span class="preproc">#endif</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_WRITE_oFFs_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">info_ptr</span><span class="symbol">-&gt;</span><span class="normal">valid </span><span class="symbol">&amp;</span><span class="normal"> PNG_INFO_oFFs</span><span class="symbol">)</span>
<span class="normal">      </span><span class="function">png_write_oFFs</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> info_ptr</span><span class="symbol">-&gt;</span><span class="normal">x_offset</span><span class="symbol">,</span><span class="normal"> info_ptr</span><span class="symbol">-&gt;</span><span class="normal">y_offset</span><span class="symbol">,</span>
<span class="normal">         info_ptr</span><span class="symbol">-&gt;</span><span class="normal">offset_unit_type</span><span class="symbol">);</span>
<span class="preproc">#endif</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_WRITE_pCAL_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">info_ptr</span><span class="symbol">-&gt;</span><span class="normal">valid </span><span class="symbol">&amp;</span><span class="normal"> PNG_INFO_pCAL</span><span class="symbol">)</span>
<span class="normal">      </span><span class="function">png_write_pCAL</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> info_ptr</span><span class="symbol">-&gt;</span><span class="normal">pcal_purpose</span><span class="symbol">,</span><span class="normal"> info_ptr</span><span class="symbol">-&gt;</span><span class="normal">pcal_X0</span><span class="symbol">,</span>
<span class="normal">         info_ptr</span><span class="symbol">-&gt;</span><span class="normal">pcal_X1</span><span class="symbol">,</span><span class="normal"> info_ptr</span><span class="symbol">-&gt;</span><span class="normal">pcal_type</span><span class="symbol">,</span><span class="normal"> info_ptr</span><span class="symbol">-&gt;</span><span class="normal">pcal_nparams</span><span class="symbol">,</span>
<span class="normal">         info_ptr</span><span class="symbol">-&gt;</span><span class="normal">pcal_units</span><span class="symbol">,</span><span class="normal"> info_ptr</span><span class="symbol">-&gt;</span><span class="normal">pcal_params</span><span class="symbol">);</span>
<span class="preproc">#endif</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_WRITE_sCAL_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">info_ptr</span><span class="symbol">-&gt;</span><span class="normal">valid </span><span class="symbol">&amp;</span><span class="normal"> PNG_INFO_sCAL</span><span class="symbol">)</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_FLOATING_POINT_SUPPORTED</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">!</span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_NO_STDIO</span><span class="symbol">)</span>
<span class="normal">      </span><span class="function">png_write_sCAL</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="symbol">)</span><span class="normal">info_ptr</span><span class="symbol">-&gt;</span><span class="normal">scal_unit</span><span class="symbol">,</span>
<span class="normal">          info_ptr</span><span class="symbol">-&gt;</span><span class="normal">scal_pixel_width</span><span class="symbol">,</span><span class="normal"> info_ptr</span><span class="symbol">-&gt;</span><span class="normal">scal_pixel_height</span><span class="symbol">);</span>
<span class="preproc">#else</span>
<span class="preproc">#ifdef</span><span class="normal"> PNG_FIXED_POINT_SUPPORTED</span>
<span class="normal">      </span><span class="function">png_write_sCAL_s</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="symbol">)</span><span class="normal">info_ptr</span><span class="symbol">-&gt;</span><span class="normal">scal_unit</span><span class="symbol">,</span>
<span class="normal">          info_ptr</span><span class="symbol">-&gt;</span><span class="normal">scal_s_width</span><span class="symbol">,</span><span class="normal"> info_ptr</span><span class="symbol">-&gt;</span><span class="normal">scal_s_height</span><span class="symbol">);</span>
<span class="preproc">#else</span>
<span class="normal">      </span><span class="function">png_warning</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span>
<span class="normal">          </span><span class="string">"png_write_sCAL not supported; sCAL chunk not written."</span><span class="symbol">);</span>
<span class="preproc">#endif</span>
<span class="preproc">#endif</span>
<span class="preproc">#endif</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_WRITE_pHYs_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">info_ptr</span><span class="symbol">-&gt;</span><span class="normal">valid </span><span class="symbol">&amp;</span><span class="normal"> PNG_INFO_pHYs</span><span class="symbol">)</span>
<span class="normal">      </span><span class="function">png_write_pHYs</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> info_ptr</span><span class="symbol">-&gt;</span><span class="normal">x_pixels_per_unit</span><span class="symbol">,</span>
<span class="normal">         info_ptr</span><span class="symbol">-&gt;</span><span class="normal">y_pixels_per_unit</span><span class="symbol">,</span><span class="normal"> info_ptr</span><span class="symbol">-&gt;</span><span class="normal">phys_unit_type</span><span class="symbol">);</span>
<span class="preproc">#endif</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_WRITE_tIME_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">info_ptr</span><span class="symbol">-&gt;</span><span class="normal">valid </span><span class="symbol">&amp;</span><span class="normal"> PNG_INFO_tIME</span><span class="symbol">)</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="function">png_write_tIME</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">&amp;(</span><span class="normal">info_ptr</span><span class="symbol">-&gt;</span><span class="normal">mod_time</span><span class="symbol">));</span>
<span class="normal">      png_ptr</span><span class="symbol">-&gt;</span><span class="normal">mode </span><span class="symbol">|=</span><span class="normal"> PNG_WROTE_tIME</span><span class="symbol">;</span>
<span class="normal">   </span><span class="cbracket">}</span>
<span class="preproc">#endif</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_WRITE_sPLT_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">info_ptr</span><span class="symbol">-&gt;</span><span class="normal">valid </span><span class="symbol">&amp;</span><span class="normal"> PNG_INFO_sPLT</span><span class="symbol">)</span>
<span class="normal">     </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="symbol">)</span><span class="normal">info_ptr</span><span class="symbol">-&gt;</span><span class="normal">splt_palettes_num</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">       </span><span class="function">png_write_sPLT</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> info_ptr</span><span class="symbol">-&gt;</span><span class="normal">splt_palettes </span><span class="symbol">+</span><span class="normal"> i</span><span class="symbol">);</span>
<span class="preproc">#endif</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_WRITE_TEXT_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="comment">/* Check to see if we need to write text chunks */</span>
<span class="normal">   </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> info_ptr</span><span class="symbol">-&gt;</span><span class="normal">num_text</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="function">png_debug2</span><span class="symbol">(</span><span class="number">2</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"Writing header text chunk %d, type %d</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> i</span><span class="symbol">,</span>
<span class="normal">         info_ptr</span><span class="symbol">-&gt;</span><span class="normal">text</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">compression</span><span class="symbol">);</span>
<span class="normal">      </span><span class="comment">/* an internationalized chunk? */</span>
<span class="normal">      </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">info_ptr</span><span class="symbol">-&gt;</span><span class="normal">text</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">compression </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_WRITE_iTXt_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">          </span><span class="comment">/* write international chunk */</span>
<span class="normal">          </span><span class="function">png_write_iTXt</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span>
<span class="normal">                         info_ptr</span><span class="symbol">-&gt;</span><span class="normal">text</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">compression</span><span class="symbol">,</span>
<span class="normal">                         info_ptr</span><span class="symbol">-&gt;</span><span class="normal">text</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">key</span><span class="symbol">,</span>
<span class="normal">                         info_ptr</span><span class="symbol">-&gt;</span><span class="normal">text</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">lang</span><span class="symbol">,</span>
<span class="normal">                         info_ptr</span><span class="symbol">-&gt;</span><span class="normal">text</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">lang_key</span><span class="symbol">,</span>
<span class="normal">                         info_ptr</span><span class="symbol">-&gt;</span><span class="normal">text</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">text</span><span class="symbol">);</span>
<span class="preproc">#else</span>
<span class="normal">          </span><span class="function">png_warning</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"Unable to write international text"</span><span class="symbol">);</span>
<span class="preproc">#endif</span>
<span class="normal">          </span><span class="comment">/* Mark this chunk as written */</span>
<span class="normal">          info_ptr</span><span class="symbol">-&gt;</span><span class="normal">text</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">compression </span><span class="symbol">=</span><span class="normal"> PNG_TEXT_COMPRESSION_NONE_WR</span><span class="symbol">;</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="comment">/* If we want a compressed text chunk */</span>
<span class="normal">      </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">info_ptr</span><span class="symbol">-&gt;</span><span class="normal">text</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">compression </span><span class="symbol">==</span><span class="normal"> PNG_TEXT_COMPRESSION_zTXt</span><span class="symbol">)</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_WRITE_zTXt_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">         </span><span class="comment">/* write compressed chunk */</span>
<span class="normal">         </span><span class="function">png_write_zTXt</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> info_ptr</span><span class="symbol">-&gt;</span><span class="normal">text</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">key</span><span class="symbol">,</span>
<span class="normal">            info_ptr</span><span class="symbol">-&gt;</span><span class="normal">text</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">text</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span>
<span class="normal">            info_ptr</span><span class="symbol">-&gt;</span><span class="normal">text</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">compression</span><span class="symbol">);</span>
<span class="preproc">#else</span>
<span class="normal">         </span><span class="function">png_warning</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"Unable to write compressed text"</span><span class="symbol">);</span>
<span class="preproc">#endif</span>
<span class="normal">         </span><span class="comment">/* Mark this chunk as written */</span>
<span class="normal">         info_ptr</span><span class="symbol">-&gt;</span><span class="normal">text</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">compression </span><span class="symbol">=</span><span class="normal"> PNG_TEXT_COMPRESSION_zTXt_WR</span><span class="symbol">;</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">info_ptr</span><span class="symbol">-&gt;</span><span class="normal">text</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">compression </span><span class="symbol">==</span><span class="normal"> PNG_TEXT_COMPRESSION_NONE</span><span class="symbol">)</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_WRITE_tEXt_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">         </span><span class="comment">/* write uncompressed chunk */</span>
<span class="normal">         </span><span class="function">png_write_tEXt</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> info_ptr</span><span class="symbol">-&gt;</span><span class="normal">text</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">key</span><span class="symbol">,</span>
<span class="normal">                         info_ptr</span><span class="symbol">-&gt;</span><span class="normal">text</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">text</span><span class="symbol">,</span>
<span class="normal">                         </span><span class="number">0</span><span class="symbol">);</span>
<span class="preproc">#else</span>
<span class="normal">         </span><span class="function">png_warning</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"Unable to write uncompressed text"</span><span class="symbol">);</span>
<span class="preproc">#endif</span>
<span class="normal">         </span><span class="comment">/* Mark this chunk as written */</span>
<span class="normal">         info_ptr</span><span class="symbol">-&gt;</span><span class="normal">text</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">compression </span><span class="symbol">=</span><span class="normal"> PNG_TEXT_COMPRESSION_NONE_WR</span><span class="symbol">;</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">   </span><span class="cbracket">}</span>
<span class="preproc">#endif</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_WRITE_UNKNOWN_CHUNKS_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">info_ptr</span><span class="symbol">-&gt;</span><span class="normal">unknown_chunks_num</span><span class="symbol">)</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">       </span><span class="usertype">png_unknown_chunk</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">up</span><span class="symbol">;</span>

<span class="normal">       </span><span class="function">png_debug</span><span class="symbol">(</span><span class="number">5</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"writing extra chunks</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>

<span class="normal">       </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">up </span><span class="symbol">=</span><span class="normal"> info_ptr</span><span class="symbol">-&gt;</span><span class="normal">unknown_chunks</span><span class="symbol">;</span>
<span class="normal">            up </span><span class="symbol">&lt;</span><span class="normal"> info_ptr</span><span class="symbol">-&gt;</span><span class="normal">unknown_chunks </span><span class="symbol">+</span><span class="normal"> info_ptr</span><span class="symbol">-&gt;</span><span class="normal">unknown_chunks_num</span><span class="symbol">;</span>
<span class="normal">            up</span><span class="symbol">++)</span>
<span class="normal">       </span><span class="cbracket">{</span>
<span class="normal">         </span><span class="type">int</span><span class="normal"> keep</span><span class="symbol">=</span><span class="function">png_handle_as_unknown</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> up</span><span class="symbol">-&gt;</span><span class="normal">name</span><span class="symbol">);</span>
<span class="normal">         </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">keep </span><span class="symbol">!=</span><span class="normal"> PNG_HANDLE_CHUNK_NEVER </span><span class="symbol">&amp;&amp;</span>
<span class="normal">            up</span><span class="symbol">-&gt;</span><span class="normal">location </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">up</span><span class="symbol">-&gt;</span><span class="normal">location </span><span class="symbol">&amp;</span><span class="normal"> PNG_HAVE_PLTE</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span>
<span class="normal">            </span><span class="symbol">!(</span><span class="normal">up</span><span class="symbol">-&gt;</span><span class="normal">location </span><span class="symbol">&amp;</span><span class="normal"> PNG_HAVE_IDAT</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span>
<span class="normal">            </span><span class="symbol">((</span><span class="normal">up</span><span class="symbol">-&gt;</span><span class="normal">name</span><span class="symbol">[</span><span class="number">3</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x20</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> keep </span><span class="symbol">==</span><span class="normal"> PNG_HANDLE_CHUNK_ALWAYS </span><span class="symbol">||</span>
<span class="normal">            </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">flags </span><span class="symbol">&amp;</span><span class="normal"> PNG_FLAG_KEEP_UNSAFE_CHUNKS</span><span class="symbol">)))</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="function">png_write_chunk</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> up</span><span class="symbol">-&gt;</span><span class="normal">name</span><span class="symbol">,</span><span class="normal"> up</span><span class="symbol">-&gt;</span><span class="normal">data</span><span class="symbol">,</span><span class="normal"> up</span><span class="symbol">-&gt;</span><span class="normal">size</span><span class="symbol">);</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">       </span><span class="cbracket">}</span>
<span class="normal">   </span><span class="cbracket">}</span>
<span class="preproc">#endif</span>
<span class="cbracket">}</span>

<span class="comment">/* Writes the end of the PNG file.  If you don't want to write comments or</span>
<span class="comment"> * time information, you can pass NULL for info.  If you already wrote these</span>
<span class="comment"> * in png_write_info(), do not write them again here.  If you have long</span>
<span class="comment"> * comments, I suggest writing them here, and compressing them.</span>
<span class="comment"> */</span>
<span class="type">void</span><span class="normal"> PNGAPI</span>
<span class="function">png_write_end</span><span class="symbol">(</span><span class="usertype">png_structp</span><span class="normal"> png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">png_infop</span><span class="normal"> info_ptr</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">   </span><span class="function">png_debug</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"in png_write_end</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr </span><span class="symbol">==</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">      </span><span class="keyword">return</span><span class="symbol">;</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">mode </span><span class="symbol">&amp;</span><span class="normal"> PNG_HAVE_IDAT</span><span class="symbol">))</span>
<span class="normal">      </span><span class="function">png_error</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"No IDATs written into file"</span><span class="symbol">);</span>

<span class="normal">   </span><span class="comment">/* see if user wants us to write information chunks */</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">info_ptr </span><span class="symbol">!=</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_WRITE_TEXT_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">      </span><span class="type">int</span><span class="normal"> i</span><span class="symbol">;</span><span class="normal"> </span><span class="comment">/* local index variable */</span>
<span class="preproc">#endif</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_WRITE_tIME_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">      </span><span class="comment">/* check to see if user has supplied a time chunk */</span>
<span class="normal">      </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">info_ptr</span><span class="symbol">-&gt;</span><span class="normal">valid </span><span class="symbol">&amp;</span><span class="normal"> PNG_INFO_tIME</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span>
<span class="normal">         </span><span class="symbol">!(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">mode </span><span class="symbol">&amp;</span><span class="normal"> PNG_WROTE_tIME</span><span class="symbol">))</span>
<span class="normal">         </span><span class="function">png_write_tIME</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">&amp;(</span><span class="normal">info_ptr</span><span class="symbol">-&gt;</span><span class="normal">mod_time</span><span class="symbol">));</span>
<span class="preproc">#endif</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_WRITE_TEXT_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">      </span><span class="comment">/* loop through comment chunks */</span>
<span class="normal">      </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> info_ptr</span><span class="symbol">-&gt;</span><span class="normal">num_text</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         </span><span class="function">png_debug2</span><span class="symbol">(</span><span class="number">2</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"Writing trailer text chunk %d, type %d</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> i</span><span class="symbol">,</span>
<span class="normal">            info_ptr</span><span class="symbol">-&gt;</span><span class="normal">text</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">compression</span><span class="symbol">);</span>
<span class="normal">         </span><span class="comment">/* an internationalized chunk? */</span>
<span class="normal">         </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">info_ptr</span><span class="symbol">-&gt;</span><span class="normal">text</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">compression </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_WRITE_iTXt_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">             </span><span class="comment">/* write international chunk */</span>
<span class="normal">             </span><span class="function">png_write_iTXt</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span>
<span class="normal">                         info_ptr</span><span class="symbol">-&gt;</span><span class="normal">text</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">compression</span><span class="symbol">,</span>
<span class="normal">                         info_ptr</span><span class="symbol">-&gt;</span><span class="normal">text</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">key</span><span class="symbol">,</span>
<span class="normal">                         info_ptr</span><span class="symbol">-&gt;</span><span class="normal">text</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">lang</span><span class="symbol">,</span>
<span class="normal">                         info_ptr</span><span class="symbol">-&gt;</span><span class="normal">text</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">lang_key</span><span class="symbol">,</span>
<span class="normal">                         info_ptr</span><span class="symbol">-&gt;</span><span class="normal">text</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">text</span><span class="symbol">);</span>
<span class="preproc">#else</span>
<span class="normal">             </span><span class="function">png_warning</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"Unable to write international text"</span><span class="symbol">);</span>
<span class="preproc">#endif</span>
<span class="normal">             </span><span class="comment">/* Mark this chunk as written */</span>
<span class="normal">             info_ptr</span><span class="symbol">-&gt;</span><span class="normal">text</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">compression </span><span class="symbol">=</span><span class="normal"> PNG_TEXT_COMPRESSION_NONE_WR</span><span class="symbol">;</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">         </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">info_ptr</span><span class="symbol">-&gt;</span><span class="normal">text</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">compression </span><span class="symbol">&gt;=</span><span class="normal"> PNG_TEXT_COMPRESSION_zTXt</span><span class="symbol">)</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_WRITE_zTXt_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">            </span><span class="comment">/* write compressed chunk */</span>
<span class="normal">            </span><span class="function">png_write_zTXt</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> info_ptr</span><span class="symbol">-&gt;</span><span class="normal">text</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">key</span><span class="symbol">,</span>
<span class="normal">               info_ptr</span><span class="symbol">-&gt;</span><span class="normal">text</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">text</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span>
<span class="normal">               info_ptr</span><span class="symbol">-&gt;</span><span class="normal">text</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">compression</span><span class="symbol">);</span>
<span class="preproc">#else</span>
<span class="normal">            </span><span class="function">png_warning</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"Unable to write compressed text"</span><span class="symbol">);</span>
<span class="preproc">#endif</span>
<span class="normal">            </span><span class="comment">/* Mark this chunk as written */</span>
<span class="normal">            info_ptr</span><span class="symbol">-&gt;</span><span class="normal">text</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">compression </span><span class="symbol">=</span><span class="normal"> PNG_TEXT_COMPRESSION_zTXt_WR</span><span class="symbol">;</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">         </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">info_ptr</span><span class="symbol">-&gt;</span><span class="normal">text</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">compression </span><span class="symbol">==</span><span class="normal"> PNG_TEXT_COMPRESSION_NONE</span><span class="symbol">)</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_WRITE_tEXt_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">            </span><span class="comment">/* write uncompressed chunk */</span>
<span class="normal">            </span><span class="function">png_write_tEXt</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> info_ptr</span><span class="symbol">-&gt;</span><span class="normal">text</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">key</span><span class="symbol">,</span>
<span class="normal">               info_ptr</span><span class="symbol">-&gt;</span><span class="normal">text</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">text</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">);</span>
<span class="preproc">#else</span>
<span class="normal">            </span><span class="function">png_warning</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"Unable to write uncompressed text"</span><span class="symbol">);</span>
<span class="preproc">#endif</span>

<span class="normal">            </span><span class="comment">/* Mark this chunk as written */</span>
<span class="normal">            info_ptr</span><span class="symbol">-&gt;</span><span class="normal">text</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">compression </span><span class="symbol">=</span><span class="normal"> PNG_TEXT_COMPRESSION_NONE_WR</span><span class="symbol">;</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="preproc">#endif</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_WRITE_UNKNOWN_CHUNKS_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">info_ptr</span><span class="symbol">-&gt;</span><span class="normal">unknown_chunks_num</span><span class="symbol">)</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">       </span><span class="usertype">png_unknown_chunk</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">up</span><span class="symbol">;</span>

<span class="normal">       </span><span class="function">png_debug</span><span class="symbol">(</span><span class="number">5</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"writing extra chunks</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>

<span class="normal">       </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">up </span><span class="symbol">=</span><span class="normal"> info_ptr</span><span class="symbol">-&gt;</span><span class="normal">unknown_chunks</span><span class="symbol">;</span>
<span class="normal">            up </span><span class="symbol">&lt;</span><span class="normal"> info_ptr</span><span class="symbol">-&gt;</span><span class="normal">unknown_chunks </span><span class="symbol">+</span><span class="normal"> info_ptr</span><span class="symbol">-&gt;</span><span class="normal">unknown_chunks_num</span><span class="symbol">;</span>
<span class="normal">            up</span><span class="symbol">++)</span>
<span class="normal">       </span><span class="cbracket">{</span>
<span class="normal">         </span><span class="type">int</span><span class="normal"> keep</span><span class="symbol">=</span><span class="function">png_handle_as_unknown</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> up</span><span class="symbol">-&gt;</span><span class="normal">name</span><span class="symbol">);</span>
<span class="normal">         </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">keep </span><span class="symbol">!=</span><span class="normal"> PNG_HANDLE_CHUNK_NEVER </span><span class="symbol">&amp;&amp;</span>
<span class="normal">            up</span><span class="symbol">-&gt;</span><span class="normal">location </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">up</span><span class="symbol">-&gt;</span><span class="normal">location </span><span class="symbol">&amp;</span><span class="normal"> PNG_AFTER_IDAT</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span>
<span class="normal">            </span><span class="symbol">((</span><span class="normal">up</span><span class="symbol">-&gt;</span><span class="normal">name</span><span class="symbol">[</span><span class="number">3</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x20</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> keep </span><span class="symbol">==</span><span class="normal"> PNG_HANDLE_CHUNK_ALWAYS </span><span class="symbol">||</span>
<span class="normal">            </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">flags </span><span class="symbol">&amp;</span><span class="normal"> PNG_FLAG_KEEP_UNSAFE_CHUNKS</span><span class="symbol">)))</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="function">png_write_chunk</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> up</span><span class="symbol">-&gt;</span><span class="normal">name</span><span class="symbol">,</span><span class="normal"> up</span><span class="symbol">-&gt;</span><span class="normal">data</span><span class="symbol">,</span><span class="normal"> up</span><span class="symbol">-&gt;</span><span class="normal">size</span><span class="symbol">);</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">       </span><span class="cbracket">}</span>
<span class="normal">   </span><span class="cbracket">}</span>
<span class="preproc">#endif</span>
<span class="normal">   </span><span class="cbracket">}</span>

<span class="normal">   png_ptr</span><span class="symbol">-&gt;</span><span class="normal">mode </span><span class="symbol">|=</span><span class="normal"> PNG_AFTER_IDAT</span><span class="symbol">;</span>

<span class="normal">   </span><span class="comment">/* write end of PNG file */</span>
<span class="normal">   </span><span class="function">png_write_IEND</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">);</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="number">0</span>
<span class="comment">/* This flush, added in libpng-1.0.8,  causes some applications to crash</span>
<span class="comment">   because they do not set png_ptr-&gt;output_flush_fn */</span>
<span class="normal">   </span><span class="function">png_flush</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">);</span>
<span class="preproc">#endif</span>
<span class="cbracket">}</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_WRITE_tIME_SUPPORTED</span><span class="symbol">)</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="symbol">!</span><span class="function">defined</span><span class="symbol">(</span><span class="normal">_WIN32_WCE</span><span class="symbol">)</span>
<span class="comment">/* "time.h" functions are not supported on WindowsCE */</span>
<span class="type">void</span><span class="normal"> PNGAPI</span>
<span class="function">png_convert_from_struct_tm</span><span class="symbol">(</span><span class="usertype">png_timep</span><span class="normal"> ptime</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">tm</span><span class="normal"> FAR </span><span class="symbol">*</span><span class="normal"> ttime</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">   </span><span class="function">png_debug</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"in png_convert_from_struct_tm</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">   ptime</span><span class="symbol">-&gt;</span><span class="normal">year </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)(</span><span class="number">1900</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> ttime</span><span class="symbol">-&gt;</span><span class="normal">tm_year</span><span class="symbol">);</span>
<span class="normal">   ptime</span><span class="symbol">-&gt;</span><span class="normal">month </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">ttime</span><span class="symbol">-&gt;</span><span class="normal">tm_mon </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">   ptime</span><span class="symbol">-&gt;</span><span class="normal">day </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)</span><span class="normal">ttime</span><span class="symbol">-&gt;</span><span class="normal">tm_mday</span><span class="symbol">;</span>
<span class="normal">   ptime</span><span class="symbol">-&gt;</span><span class="normal">hour </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)</span><span class="normal">ttime</span><span class="symbol">-&gt;</span><span class="normal">tm_hour</span><span class="symbol">;</span>
<span class="normal">   ptime</span><span class="symbol">-&gt;</span><span class="normal">minute </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)</span><span class="normal">ttime</span><span class="symbol">-&gt;</span><span class="normal">tm_min</span><span class="symbol">;</span>
<span class="normal">   ptime</span><span class="symbol">-&gt;</span><span class="normal">second </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)</span><span class="normal">ttime</span><span class="symbol">-&gt;</span><span class="normal">tm_sec</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> PNGAPI</span>
<span class="function">png_convert_from_time_t</span><span class="symbol">(</span><span class="usertype">png_timep</span><span class="normal"> ptime</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">time_t</span><span class="normal"> ttime</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">   </span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">tm</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">tbuf</span><span class="symbol">;</span>

<span class="normal">   </span><span class="function">png_debug</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"in png_convert_from_time_t</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">   tbuf </span><span class="symbol">=</span><span class="normal"> </span><span class="function">gmtime</span><span class="symbol">(&amp;</span><span class="normal">ttime</span><span class="symbol">);</span>
<span class="normal">   </span><span class="function">png_convert_from_struct_tm</span><span class="symbol">(</span><span class="normal">ptime</span><span class="symbol">,</span><span class="normal"> tbuf</span><span class="symbol">);</span>
<span class="cbracket">}</span>
<span class="preproc">#endif</span>
<span class="preproc">#endif</span>

<span class="comment">/* Initialize png_ptr structure, and allocate any memory needed */</span>
<span class="normal">png_structp PNGAPI</span>
<span class="function">png_create_write_struct</span><span class="symbol">(</span><span class="usertype">png_const_charp</span><span class="normal"> user_png_ver</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">png_voidp</span><span class="normal"> error_ptr</span><span class="symbol">,</span>
<span class="normal">   </span><span class="usertype">png_error_ptr</span><span class="normal"> error_fn</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">png_error_ptr</span><span class="normal"> warn_fn</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="preproc">#ifdef</span><span class="normal"> PNG_USER_MEM_SUPPORTED</span>
<span class="normal">   </span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">(</span><span class="function">png_create_write_struct_2</span><span class="symbol">(</span><span class="normal">user_png_ver</span><span class="symbol">,</span><span class="normal"> error_ptr</span><span class="symbol">,</span><span class="normal"> error_fn</span><span class="symbol">,</span>
<span class="normal">      warn_fn</span><span class="symbol">,</span><span class="normal"> png_voidp_NULL</span><span class="symbol">,</span><span class="normal"> png_malloc_ptr_NULL</span><span class="symbol">,</span><span class="normal"> png_free_ptr_NULL</span><span class="symbol">));</span>
<span class="cbracket">}</span>

<span class="comment">/* Alternate initialize png_ptr structure, and allocate any memory needed */</span>
<span class="normal">png_structp PNGAPI</span>
<span class="function">png_create_write_struct_2</span><span class="symbol">(</span><span class="usertype">png_const_charp</span><span class="normal"> user_png_ver</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">png_voidp</span><span class="normal"> error_ptr</span><span class="symbol">,</span>
<span class="normal">   </span><span class="usertype">png_error_ptr</span><span class="normal"> error_fn</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">png_error_ptr</span><span class="normal"> warn_fn</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">png_voidp</span><span class="normal"> mem_ptr</span><span class="symbol">,</span>
<span class="normal">   </span><span class="usertype">png_malloc_ptr</span><span class="normal"> malloc_fn</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">png_free_ptr</span><span class="normal"> free_fn</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="preproc">#endif</span><span class="normal"> </span><span class="comment">/* PNG_USER_MEM_SUPPORTED */</span>
<span class="normal">   </span><span class="usertype">png_structp</span><span class="normal"> png_ptr</span><span class="symbol">;</span>
<span class="preproc">#ifdef</span><span class="normal"> PNG_SETJMP_SUPPORTED</span>
<span class="preproc">#ifdef</span><span class="normal"> USE_FAR_KEYWORD</span>
<span class="normal">   </span><span class="usertype">jmp_buf</span><span class="normal"> jmpbuf</span><span class="symbol">;</span>
<span class="preproc">#endif</span>
<span class="preproc">#endif</span>
<span class="normal">   </span><span class="type">int</span><span class="normal"> i</span><span class="symbol">;</span>
<span class="normal">   </span><span class="function">png_debug</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"in png_create_write_struct</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="preproc">#ifdef</span><span class="normal"> PNG_USER_MEM_SUPPORTED</span>
<span class="normal">   png_ptr </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_structp</span><span class="symbol">)</span><span class="function">png_create_struct_2</span><span class="symbol">(</span><span class="normal">PNG_STRUCT_PNG</span><span class="symbol">,</span>
<span class="normal">      </span><span class="symbol">(</span><span class="normal">png_malloc_ptr</span><span class="symbol">)</span><span class="normal">malloc_fn</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_voidp</span><span class="symbol">)</span><span class="normal">mem_ptr</span><span class="symbol">);</span>
<span class="preproc">#else</span>
<span class="normal">   png_ptr </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_structp</span><span class="symbol">)</span><span class="function">png_create_struct</span><span class="symbol">(</span><span class="normal">PNG_STRUCT_PNG</span><span class="symbol">);</span>
<span class="preproc">#endif</span><span class="normal"> </span><span class="comment">/* PNG_USER_MEM_SUPPORTED */</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr </span><span class="symbol">==</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">      </span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">NULL</span><span class="symbol">);</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="symbol">!</span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_1_0_X</span><span class="symbol">)</span>
<span class="preproc">#ifdef</span><span class="normal"> PNG_ASSEMBLER_CODE_SUPPORTED</span>
<span class="normal">   </span><span class="function">png_init_mmx_flags</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">);</span><span class="normal">   </span><span class="comment">/* 1.2.0 addition */</span>
<span class="preproc">#endif</span>
<span class="preproc">#endif</span><span class="normal"> </span><span class="comment">/* PNG_1_0_X */</span>

<span class="normal">   </span><span class="comment">/* added at libpng-1.2.6 */</span>
<span class="preproc">#ifdef</span><span class="normal"> PNG_SET_USER_LIMITS_SUPPORTED</span>
<span class="normal">   png_ptr</span><span class="symbol">-&gt;</span><span class="normal">user_width_max</span><span class="symbol">=</span><span class="normal">PNG_USER_WIDTH_MAX</span><span class="symbol">;</span>
<span class="normal">   png_ptr</span><span class="symbol">-&gt;</span><span class="normal">user_height_max</span><span class="symbol">=</span><span class="normal">PNG_USER_HEIGHT_MAX</span><span class="symbol">;</span>
<span class="preproc">#endif</span>

<span class="preproc">#ifdef</span><span class="normal"> PNG_SETJMP_SUPPORTED</span>
<span class="preproc">#ifdef</span><span class="normal"> USE_FAR_KEYWORD</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">setjmp</span><span class="symbol">(</span><span class="normal">jmpbuf</span><span class="symbol">))</span>
<span class="preproc">#else</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">setjmp</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">jmpbuf</span><span class="symbol">))</span>
<span class="preproc">#endif</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="function">png_free</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">zbuf</span><span class="symbol">);</span>
<span class="normal">      png_ptr</span><span class="symbol">-&gt;</span><span class="normal">zbuf</span><span class="symbol">=</span><span class="normal">NULL</span><span class="symbol">;</span>
<span class="normal">      </span><span class="function">png_destroy_struct</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">);</span>
<span class="normal">      </span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">NULL</span><span class="symbol">);</span>
<span class="normal">   </span><span class="cbracket">}</span>
<span class="preproc">#ifdef</span><span class="normal"> USE_FAR_KEYWORD</span>
<span class="normal">   </span><span class="function">png_memcpy</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">jmpbuf</span><span class="symbol">,</span><span class="normal">jmpbuf</span><span class="symbol">,</span><span class="function">png_sizeof</span><span class="symbol">(</span><span class="normal">jmp_buf</span><span class="symbol">));</span>
<span class="preproc">#endif</span>
<span class="preproc">#endif</span>

<span class="preproc">#ifdef</span><span class="normal"> PNG_USER_MEM_SUPPORTED</span>
<span class="normal">   </span><span class="function">png_set_mem_fn</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> mem_ptr</span><span class="symbol">,</span><span class="normal"> malloc_fn</span><span class="symbol">,</span><span class="normal"> free_fn</span><span class="symbol">);</span>
<span class="preproc">#endif</span><span class="normal"> </span><span class="comment">/* PNG_USER_MEM_SUPPORTED */</span>
<span class="normal">   </span><span class="function">png_set_error_fn</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> error_ptr</span><span class="symbol">,</span><span class="normal"> error_fn</span><span class="symbol">,</span><span class="normal"> warn_fn</span><span class="symbol">);</span>

<span class="normal">   i</span><span class="symbol">=</span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">   </span><span class="keyword">do</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">     </span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">user_png_ver</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> png_libpng_ver</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">])</span>
<span class="normal">        png_ptr</span><span class="symbol">-&gt;</span><span class="normal">flags </span><span class="symbol">|=</span><span class="normal"> PNG_FLAG_LIBRARY_MISMATCH</span><span class="symbol">;</span>
<span class="normal">   </span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_libpng_ver</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">++]);</span>

<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">flags </span><span class="symbol">&amp;</span><span class="normal"> PNG_FLAG_LIBRARY_MISMATCH</span><span class="symbol">)</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">     </span><span class="comment">/* Libpng 0.90 and later are binary incompatible with libpng 0.89, so</span>
<span class="comment">      * we must recompile any applications that use any older library version.</span>
<span class="comment">      * For versions after libpng 1.0, we will be compatible, so we need</span>
<span class="comment">      * only check the first digit.</span>
<span class="comment">      */</span>
<span class="normal">     </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">user_png_ver </span><span class="symbol">==</span><span class="normal"> NULL </span><span class="symbol">||</span><span class="normal"> user_png_ver</span><span class="symbol">[</span><span class="number">0</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> png_libpng_ver</span><span class="symbol">[</span><span class="number">0</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">||</span>
<span class="normal">         </span><span class="symbol">(</span><span class="normal">user_png_ver</span><span class="symbol">[</span><span class="number">0</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="string">'1'</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> user_png_ver</span><span class="symbol">[</span><span class="number">2</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> png_libpng_ver</span><span class="symbol">[</span><span class="number">2</span><span class="symbol">])</span><span class="normal"> </span><span class="symbol">||</span>
<span class="normal">         </span><span class="symbol">(</span><span class="normal">user_png_ver</span><span class="symbol">[</span><span class="number">0</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="string">'0'</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> user_png_ver</span><span class="symbol">[</span><span class="number">2</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="string">'9'</span><span class="symbol">))</span>
<span class="normal">     </span><span class="cbracket">{</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="symbol">!</span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_NO_STDIO</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">!</span><span class="function">defined</span><span class="symbol">(</span><span class="normal">_WIN32_WCE</span><span class="symbol">)</span>
<span class="normal">        </span><span class="type">char</span><span class="normal"> msg</span><span class="symbol">[</span><span class="number">80</span><span class="symbol">];</span>
<span class="normal">        </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">user_png_ver</span><span class="symbol">)</span>
<span class="normal">        </span><span class="cbracket">{</span>
<span class="normal">          </span><span class="function">sprintf</span><span class="symbol">(</span><span class="normal">msg</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"Application was compiled with png.h from libpng-%.20s"</span><span class="symbol">,</span>
<span class="normal">             user_png_ver</span><span class="symbol">);</span>
<span class="normal">          </span><span class="function">png_warning</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> msg</span><span class="symbol">);</span>
<span class="normal">        </span><span class="cbracket">}</span>
<span class="normal">        </span><span class="function">sprintf</span><span class="symbol">(</span><span class="normal">msg</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"Application  is  running with png.c from libpng-%.20s"</span><span class="symbol">,</span>
<span class="normal">           png_libpng_ver</span><span class="symbol">);</span>
<span class="normal">        </span><span class="function">png_warning</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> msg</span><span class="symbol">);</span>
<span class="preproc">#endif</span>
<span class="preproc">#ifdef</span><span class="normal"> PNG_ERROR_NUMBERS_SUPPORTED</span>
<span class="normal">        png_ptr</span><span class="symbol">-&gt;</span><span class="normal">flags</span><span class="symbol">=</span><span class="number">0</span><span class="symbol">;</span>
<span class="preproc">#endif</span>
<span class="normal">        </span><span class="function">png_error</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span>
<span class="normal">           </span><span class="string">"Incompatible libpng version in application and library"</span><span class="symbol">);</span>
<span class="normal">     </span><span class="cbracket">}</span>
<span class="normal">   </span><span class="cbracket">}</span>

<span class="normal">   </span><span class="comment">/* initialize zbuf - compression buffer */</span>
<span class="normal">   png_ptr</span><span class="symbol">-&gt;</span><span class="normal">zbuf_size </span><span class="symbol">=</span><span class="normal"> PNG_ZBUF_SIZE</span><span class="symbol">;</span>
<span class="normal">   png_ptr</span><span class="symbol">-&gt;</span><span class="normal">zbuf </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_bytep</span><span class="symbol">)</span><span class="function">png_malloc</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span>
<span class="normal">      </span><span class="symbol">(</span><span class="normal">png_uint_32</span><span class="symbol">)</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">zbuf_size</span><span class="symbol">);</span>

<span class="normal">   </span><span class="function">png_set_write_fn</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> png_voidp_NULL</span><span class="symbol">,</span><span class="normal"> png_rw_ptr_NULL</span><span class="symbol">,</span>
<span class="normal">      png_flush_ptr_NULL</span><span class="symbol">);</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_WRITE_WEIGHTED_FILTER_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="function">png_set_filter_heuristics</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> PNG_FILTER_HEURISTIC_DEFAULT</span><span class="symbol">,</span>
<span class="normal">      </span><span class="number">1</span><span class="symbol">,</span><span class="normal"> png_doublep_NULL</span><span class="symbol">,</span><span class="normal"> png_doublep_NULL</span><span class="symbol">);</span>
<span class="preproc">#endif</span>

<span class="preproc">#ifdef</span><span class="normal"> PNG_SETJMP_SUPPORTED</span>
<span class="comment">/* Applications that neglect to set up their own setjmp() and then encounter</span>
<span class="comment">   a png_error() will longjmp here.  Since the jmpbuf is then meaningless we</span>
<span class="comment">   abort instead of returning. */</span>
<span class="preproc">#ifdef</span><span class="normal"> USE_FAR_KEYWORD</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">setjmp</span><span class="symbol">(</span><span class="normal">jmpbuf</span><span class="symbol">))</span>
<span class="normal">      </span><span class="function">PNG_ABORT</span><span class="symbol">();</span>
<span class="normal">   </span><span class="function">png_memcpy</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">jmpbuf</span><span class="symbol">,</span><span class="normal">jmpbuf</span><span class="symbol">,</span><span class="function">png_sizeof</span><span class="symbol">(</span><span class="normal">jmp_buf</span><span class="symbol">));</span>
<span class="preproc">#else</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">setjmp</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">jmpbuf</span><span class="symbol">))</span>
<span class="normal">      </span><span class="function">PNG_ABORT</span><span class="symbol">();</span>
<span class="preproc">#endif</span>
<span class="preproc">#endif</span>
<span class="normal">   </span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="comment">/* Initialize png_ptr structure, and allocate any memory needed */</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_1_0_X</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_1_2_X</span><span class="symbol">)</span>
<span class="comment">/* Deprecated. */</span>
<span class="preproc">#undef</span><span class="normal"> png_write_init</span>
<span class="type">void</span><span class="normal"> PNGAPI</span>
<span class="function">png_write_init</span><span class="symbol">(</span><span class="usertype">png_structp</span><span class="normal"> png_ptr</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">   </span><span class="comment">/* We only come here via pre-1.0.7-compiled applications */</span>
<span class="normal">   </span><span class="function">png_write_init_2</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"1.0.6 or earlier"</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> PNGAPI</span>
<span class="function">png_write_init_2</span><span class="symbol">(</span><span class="usertype">png_structp</span><span class="normal"> png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">png_const_charp</span><span class="normal"> user_png_ver</span><span class="symbol">,</span>
<span class="normal">   </span><span class="usertype">png_size_t</span><span class="normal"> png_struct_size</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">png_size_t</span><span class="normal"> png_info_size</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">   </span><span class="comment">/* We only come here via pre-1.0.12-compiled applications */</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="symbol">!</span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_NO_STDIO</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">!</span><span class="function">defined</span><span class="symbol">(</span><span class="normal">_WIN32_WCE</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="symbol">(</span><span class="function">png_sizeof</span><span class="symbol">(</span><span class="normal">png_struct</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;</span><span class="normal"> png_struct_size </span><span class="symbol">||</span>
<span class="normal">      </span><span class="function">png_sizeof</span><span class="symbol">(</span><span class="normal">png_info</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;</span><span class="normal"> png_info_size</span><span class="symbol">)</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="type">char</span><span class="normal"> msg</span><span class="symbol">[</span><span class="number">80</span><span class="symbol">];</span>
<span class="normal">      png_ptr</span><span class="symbol">-&gt;</span><span class="normal">warning_fn</span><span class="symbol">=</span><span class="normal">NULL</span><span class="symbol">;</span>
<span class="normal">      </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">user_png_ver</span><span class="symbol">)</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">        </span><span class="function">sprintf</span><span class="symbol">(</span><span class="normal">msg</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"Application was compiled with png.h from libpng-%.20s"</span><span class="symbol">,</span>
<span class="normal">           user_png_ver</span><span class="symbol">);</span>
<span class="normal">        </span><span class="function">png_warning</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> msg</span><span class="symbol">);</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="function">sprintf</span><span class="symbol">(</span><span class="normal">msg</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"Application  is  running with png.c from libpng-%.20s"</span><span class="symbol">,</span>
<span class="normal">         png_libpng_ver</span><span class="symbol">);</span>
<span class="normal">      </span><span class="function">png_warning</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> msg</span><span class="symbol">);</span>
<span class="normal">   </span><span class="cbracket">}</span>
<span class="preproc">#endif</span>
<span class="normal">   </span><span class="keyword">if</span><span class="symbol">(</span><span class="function">png_sizeof</span><span class="symbol">(</span><span class="normal">png_struct</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;</span><span class="normal"> png_struct_size</span><span class="symbol">)</span>
<span class="normal">     </span><span class="cbracket">{</span>
<span class="normal">       png_ptr</span><span class="symbol">-&gt;</span><span class="normal">error_fn</span><span class="symbol">=</span><span class="normal">NULL</span><span class="symbol">;</span>
<span class="preproc">#ifdef</span><span class="normal"> PNG_ERROR_NUMBERS_SUPPORTED</span>
<span class="normal">       png_ptr</span><span class="symbol">-&gt;</span><span class="normal">flags</span><span class="symbol">=</span><span class="number">0</span><span class="symbol">;</span>
<span class="preproc">#endif</span>
<span class="normal">       </span><span class="function">png_error</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span>
<span class="normal">       </span><span class="string">"The png struct allocated by the application for writing is too small."</span><span class="symbol">);</span>
<span class="normal">     </span><span class="cbracket">}</span>
<span class="normal">   </span><span class="keyword">if</span><span class="symbol">(</span><span class="function">png_sizeof</span><span class="symbol">(</span><span class="normal">png_info</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;</span><span class="normal"> png_info_size</span><span class="symbol">)</span>
<span class="normal">     </span><span class="cbracket">{</span>
<span class="normal">       png_ptr</span><span class="symbol">-&gt;</span><span class="normal">error_fn</span><span class="symbol">=</span><span class="normal">NULL</span><span class="symbol">;</span>
<span class="preproc">#ifdef</span><span class="normal"> PNG_ERROR_NUMBERS_SUPPORTED</span>
<span class="normal">       png_ptr</span><span class="symbol">-&gt;</span><span class="normal">flags</span><span class="symbol">=</span><span class="number">0</span><span class="symbol">;</span>
<span class="preproc">#endif</span>
<span class="normal">       </span><span class="function">png_error</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span>
<span class="normal">       </span><span class="string">"The info struct allocated by the application for writing is too small."</span><span class="symbol">);</span>
<span class="normal">     </span><span class="cbracket">}</span>
<span class="normal">   </span><span class="function">png_write_init_3</span><span class="symbol">(&amp;</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> user_png_ver</span><span class="symbol">,</span><span class="normal"> png_struct_size</span><span class="symbol">);</span>
<span class="cbracket">}</span>
<span class="preproc">#endif</span><span class="normal"> </span><span class="comment">/* PNG_1_0_X || PNG_1_2_X */</span>


<span class="type">void</span><span class="normal"> PNGAPI</span>
<span class="function">png_write_init_3</span><span class="symbol">(</span><span class="usertype">png_structpp</span><span class="normal"> ptr_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">png_const_charp</span><span class="normal"> user_png_ver</span><span class="symbol">,</span>
<span class="normal">   </span><span class="usertype">png_size_t</span><span class="normal"> png_struct_size</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">   </span><span class="usertype">png_structp</span><span class="normal"> png_ptr</span><span class="symbol">=*</span><span class="normal">ptr_ptr</span><span class="symbol">;</span>
<span class="preproc">#ifdef</span><span class="normal"> PNG_SETJMP_SUPPORTED</span>
<span class="normal">   </span><span class="usertype">jmp_buf</span><span class="normal"> tmp_jmp</span><span class="symbol">;</span><span class="normal"> </span><span class="comment">/* to save current jump buffer */</span>
<span class="preproc">#endif</span>

<span class="normal">   </span><span class="type">int</span><span class="normal"> i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr </span><span class="symbol">==</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">      </span><span class="keyword">return</span><span class="symbol">;</span>

<span class="normal">   </span><span class="keyword">do</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">     </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">user_png_ver</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> png_libpng_ver</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">])</span>
<span class="normal">     </span><span class="cbracket">{</span>
<span class="preproc">#ifdef</span><span class="normal"> PNG_LEGACY_SUPPORTED</span>
<span class="normal">       png_ptr</span><span class="symbol">-&gt;</span><span class="normal">flags </span><span class="symbol">|=</span><span class="normal"> PNG_FLAG_LIBRARY_MISMATCH</span><span class="symbol">;</span>
<span class="preproc">#else</span>
<span class="normal">       png_ptr</span><span class="symbol">-&gt;</span><span class="normal">warning_fn</span><span class="symbol">=</span><span class="normal">NULL</span><span class="symbol">;</span>
<span class="normal">       </span><span class="function">png_warning</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span>
<span class="normal">     </span><span class="string">"Application uses deprecated png_write_init() and should be recompiled."</span><span class="symbol">);</span>
<span class="normal">       </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="preproc">#endif</span>
<span class="normal">     </span><span class="cbracket">}</span>
<span class="normal">   </span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_libpng_ver</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">++]);</span>

<span class="normal">   </span><span class="function">png_debug</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"in png_write_init_3</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>

<span class="preproc">#ifdef</span><span class="normal"> PNG_SETJMP_SUPPORTED</span>
<span class="normal">   </span><span class="comment">/* save jump buffer and error functions */</span>
<span class="normal">   </span><span class="function">png_memcpy</span><span class="symbol">(</span><span class="normal">tmp_jmp</span><span class="symbol">,</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">jmpbuf</span><span class="symbol">,</span><span class="normal"> </span><span class="function">png_sizeof</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">jmp_buf</span><span class="symbol">));</span>
<span class="preproc">#endif</span>

<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">png_sizeof</span><span class="symbol">(</span><span class="normal">png_struct</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;</span><span class="normal"> png_struct_size</span><span class="symbol">)</span>
<span class="normal">     </span><span class="cbracket">{</span>
<span class="normal">       </span><span class="function">png_destroy_struct</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">);</span>
<span class="normal">       png_ptr </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_structp</span><span class="symbol">)</span><span class="function">png_create_struct</span><span class="symbol">(</span><span class="normal">PNG_STRUCT_PNG</span><span class="symbol">);</span>
<span class="normal">       </span><span class="symbol">*</span><span class="normal">ptr_ptr </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">;</span>
<span class="normal">     </span><span class="cbracket">}</span>

<span class="normal">   </span><span class="comment">/* reset all variables to 0 */</span>
<span class="normal">   </span><span class="function">png_memset</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="function">png_sizeof</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_struct</span><span class="symbol">));</span>

<span class="normal">   </span><span class="comment">/* added at libpng-1.2.6 */</span>
<span class="preproc">#ifdef</span><span class="normal"> PNG_SET_USER_LIMITS_SUPPORTED</span>
<span class="normal">   png_ptr</span><span class="symbol">-&gt;</span><span class="normal">user_width_max</span><span class="symbol">=</span><span class="normal">PNG_USER_WIDTH_MAX</span><span class="symbol">;</span>
<span class="normal">   png_ptr</span><span class="symbol">-&gt;</span><span class="normal">user_height_max</span><span class="symbol">=</span><span class="normal">PNG_USER_HEIGHT_MAX</span><span class="symbol">;</span>
<span class="preproc">#endif</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="symbol">!</span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_1_0_X</span><span class="symbol">)</span>
<span class="preproc">#ifdef</span><span class="normal"> PNG_ASSEMBLER_CODE_SUPPORTED</span>
<span class="normal">   </span><span class="function">png_init_mmx_flags</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">);</span><span class="normal">   </span><span class="comment">/* 1.2.0 addition */</span>
<span class="preproc">#endif</span>
<span class="preproc">#endif</span><span class="normal"> </span><span class="comment">/* PNG_1_0_X */</span>

<span class="preproc">#ifdef</span><span class="normal"> PNG_SETJMP_SUPPORTED</span>
<span class="normal">   </span><span class="comment">/* restore jump buffer */</span>
<span class="normal">   </span><span class="function">png_memcpy</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">jmpbuf</span><span class="symbol">,</span><span class="normal"> tmp_jmp</span><span class="symbol">,</span><span class="normal"> </span><span class="function">png_sizeof</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">jmp_buf</span><span class="symbol">));</span>
<span class="preproc">#endif</span>

<span class="normal">   </span><span class="function">png_set_write_fn</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> png_voidp_NULL</span><span class="symbol">,</span><span class="normal"> png_rw_ptr_NULL</span><span class="symbol">,</span>
<span class="normal">      png_flush_ptr_NULL</span><span class="symbol">);</span>

<span class="normal">   </span><span class="comment">/* initialize zbuf - compression buffer */</span>
<span class="normal">   png_ptr</span><span class="symbol">-&gt;</span><span class="normal">zbuf_size </span><span class="symbol">=</span><span class="normal"> PNG_ZBUF_SIZE</span><span class="symbol">;</span>
<span class="normal">   png_ptr</span><span class="symbol">-&gt;</span><span class="normal">zbuf </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_bytep</span><span class="symbol">)</span><span class="function">png_malloc</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span>
<span class="normal">      </span><span class="symbol">(</span><span class="normal">png_uint_32</span><span class="symbol">)</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">zbuf_size</span><span class="symbol">);</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_WRITE_WEIGHTED_FILTER_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="function">png_set_filter_heuristics</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> PNG_FILTER_HEURISTIC_DEFAULT</span><span class="symbol">,</span>
<span class="normal">      </span><span class="number">1</span><span class="symbol">,</span><span class="normal"> png_doublep_NULL</span><span class="symbol">,</span><span class="normal"> png_doublep_NULL</span><span class="symbol">);</span>
<span class="preproc">#endif</span>
<span class="cbracket">}</span>

<span class="comment">/* Write a few rows of image data.  If the image is interlaced,</span>
<span class="comment"> * either you will have to write the 7 sub images, or, if you</span>
<span class="comment"> * have called png_set_interlace_handling(), you will have to</span>
<span class="comment"> * "write" the image seven times.</span>
<span class="comment"> */</span>
<span class="type">void</span><span class="normal"> PNGAPI</span>
<span class="function">png_write_rows</span><span class="symbol">(</span><span class="usertype">png_structp</span><span class="normal"> png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">png_bytepp</span><span class="normal"> row</span><span class="symbol">,</span>
<span class="normal">   </span><span class="usertype">png_uint_32</span><span class="normal"> num_rows</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">   </span><span class="usertype">png_uint_32</span><span class="normal"> i</span><span class="symbol">;</span><span class="normal"> </span><span class="comment">/* row counter */</span>
<span class="normal">   </span><span class="usertype">png_bytepp</span><span class="normal"> rp</span><span class="symbol">;</span><span class="normal"> </span><span class="comment">/* row pointer */</span>

<span class="normal">   </span><span class="function">png_debug</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"in png_write_rows</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>

<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr </span><span class="symbol">==</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">      </span><span class="keyword">return</span><span class="symbol">;</span>

<span class="normal">   </span><span class="comment">/* loop through the rows */</span>
<span class="normal">   </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> rp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> num_rows</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++,</span><span class="normal"> rp</span><span class="symbol">++)</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="function">png_write_row</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">rp</span><span class="symbol">);</span>
<span class="normal">   </span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="comment">/* Write the image.  You only need to call this function once, even</span>
<span class="comment"> * if you are writing an interlaced image.</span>
<span class="comment"> */</span>
<span class="type">void</span><span class="normal"> PNGAPI</span>
<span class="function">png_write_image</span><span class="symbol">(</span><span class="usertype">png_structp</span><span class="normal"> png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">png_bytepp</span><span class="normal"> image</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">   </span><span class="usertype">png_uint_32</span><span class="normal"> i</span><span class="symbol">;</span><span class="normal"> </span><span class="comment">/* row index */</span>
<span class="normal">   </span><span class="type">int</span><span class="normal"> pass</span><span class="symbol">,</span><span class="normal"> num_pass</span><span class="symbol">;</span><span class="normal"> </span><span class="comment">/* pass variables */</span>
<span class="normal">   </span><span class="usertype">png_bytepp</span><span class="normal"> rp</span><span class="symbol">;</span><span class="normal"> </span><span class="comment">/* points to current row */</span>

<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr </span><span class="symbol">==</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">      </span><span class="keyword">return</span><span class="symbol">;</span>

<span class="normal">   </span><span class="function">png_debug</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"in png_write_image</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_WRITE_INTERLACING_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="comment">/* intialize interlace handling.  If image is not interlaced,</span>
<span class="comment">      this will set pass to 1 */</span>
<span class="normal">   num_pass </span><span class="symbol">=</span><span class="normal"> </span><span class="function">png_set_interlace_handling</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">);</span>
<span class="preproc">#else</span>
<span class="normal">   num_pass </span><span class="symbol">=</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="preproc">#endif</span>
<span class="normal">   </span><span class="comment">/* loop through passes */</span>
<span class="normal">   </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pass </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> pass </span><span class="symbol">&lt;</span><span class="normal"> num_pass</span><span class="symbol">;</span><span class="normal"> pass</span><span class="symbol">++)</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="comment">/* loop through image */</span>
<span class="normal">      </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> rp </span><span class="symbol">=</span><span class="normal"> image</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">height</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++,</span><span class="normal"> rp</span><span class="symbol">++)</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         </span><span class="function">png_write_row</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">rp</span><span class="symbol">);</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">   </span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="comment">/* called by user to write a row of image data */</span>
<span class="type">void</span><span class="normal"> PNGAPI</span>
<span class="function">png_write_row</span><span class="symbol">(</span><span class="usertype">png_structp</span><span class="normal"> png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">png_bytep</span><span class="normal"> row</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr </span><span class="symbol">==</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">      </span><span class="keyword">return</span><span class="symbol">;</span>
<span class="normal">   </span><span class="function">png_debug2</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"in png_write_row (row %ld, pass %d)</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">      png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_number</span><span class="symbol">,</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">pass</span><span class="symbol">);</span>

<span class="normal">   </span><span class="comment">/* initialize transformations and other stuff if first time */</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_number </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">pass </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">   </span><span class="comment">/* make sure we wrote the header info */</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">mode </span><span class="symbol">&amp;</span><span class="normal"> PNG_WROTE_INFO_BEFORE_PLTE</span><span class="symbol">))</span>
<span class="normal">      </span><span class="function">png_error</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span>
<span class="normal">         </span><span class="string">"png_write_info was never called before png_write_row."</span><span class="symbol">);</span>

<span class="normal">   </span><span class="comment">/* check for transforms that have been set but were defined out */</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="symbol">!</span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_WRITE_INVERT_SUPPORTED</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_INVERT_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">&amp;</span><span class="normal"> PNG_INVERT_MONO</span><span class="symbol">)</span>
<span class="normal">      </span><span class="function">png_warning</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"PNG_WRITE_INVERT_SUPPORTED is not defined."</span><span class="symbol">);</span>
<span class="preproc">#endif</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="symbol">!</span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_WRITE_FILLER_SUPPORTED</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_FILLER_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">&amp;</span><span class="normal"> PNG_FILLER</span><span class="symbol">)</span>
<span class="normal">      </span><span class="function">png_warning</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"PNG_WRITE_FILLER_SUPPORTED is not defined."</span><span class="symbol">);</span>
<span class="preproc">#endif</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="symbol">!</span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_WRITE_PACKSWAP_SUPPORTED</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_PACKSWAP_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">&amp;</span><span class="normal"> PNG_PACKSWAP</span><span class="symbol">)</span>
<span class="normal">      </span><span class="function">png_warning</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"PNG_WRITE_PACKSWAP_SUPPORTED is not defined."</span><span class="symbol">);</span>
<span class="preproc">#endif</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="symbol">!</span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_WRITE_PACK_SUPPORTED</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_PACK_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">&amp;</span><span class="normal"> PNG_PACK</span><span class="symbol">)</span>
<span class="normal">      </span><span class="function">png_warning</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"PNG_WRITE_PACK_SUPPORTED is not defined."</span><span class="symbol">);</span>
<span class="preproc">#endif</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="symbol">!</span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_WRITE_SHIFT_SUPPORTED</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_SHIFT_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">&amp;</span><span class="normal"> PNG_SHIFT</span><span class="symbol">)</span>
<span class="normal">      </span><span class="function">png_warning</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"PNG_WRITE_SHIFT_SUPPORTED is not defined."</span><span class="symbol">);</span>
<span class="preproc">#endif</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="symbol">!</span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_WRITE_BGR_SUPPORTED</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_BGR_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">&amp;</span><span class="normal"> PNG_BGR</span><span class="symbol">)</span>
<span class="normal">      </span><span class="function">png_warning</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"PNG_WRITE_BGR_SUPPORTED is not defined."</span><span class="symbol">);</span>
<span class="preproc">#endif</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="symbol">!</span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_WRITE_SWAP_SUPPORTED</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_SWAP_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">&amp;</span><span class="normal"> PNG_SWAP_BYTES</span><span class="symbol">)</span>
<span class="normal">      </span><span class="function">png_warning</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"PNG_WRITE_SWAP_SUPPORTED is not defined."</span><span class="symbol">);</span>
<span class="preproc">#endif</span>

<span class="normal">      </span><span class="function">png_write_start_row</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">);</span>
<span class="normal">   </span><span class="cbracket">}</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_WRITE_INTERLACING_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="comment">/* if interlaced and not interested in row, return */</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">interlaced </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">&amp;</span><span class="normal"> PNG_INTERLACE</span><span class="symbol">))</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="keyword">switch</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">pass</span><span class="symbol">)</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         </span><span class="keyword">case</span><span class="normal"> </span><span class="number">0</span><span class="symbol">:</span>
<span class="normal">            </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_number </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x07</span><span class="symbol">)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="function">png_write_finish_row</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">);</span>
<span class="normal">               </span><span class="keyword">return</span><span class="symbol">;</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">         </span><span class="keyword">case</span><span class="normal"> </span><span class="number">1</span><span class="symbol">:</span>
<span class="normal">            </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_number </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x07</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">width </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">5</span><span class="symbol">)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="function">png_write_finish_row</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">);</span>
<span class="normal">               </span><span class="keyword">return</span><span class="symbol">;</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">         </span><span class="keyword">case</span><span class="normal"> </span><span class="number">2</span><span class="symbol">:</span>
<span class="normal">            </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_number </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x07</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">4</span><span class="symbol">)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="function">png_write_finish_row</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">);</span>
<span class="normal">               </span><span class="keyword">return</span><span class="symbol">;</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">         </span><span class="keyword">case</span><span class="normal"> </span><span class="number">3</span><span class="symbol">:</span>
<span class="normal">            </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_number </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x03</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">width </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">3</span><span class="symbol">)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="function">png_write_finish_row</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">);</span>
<span class="normal">               </span><span class="keyword">return</span><span class="symbol">;</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">         </span><span class="keyword">case</span><span class="normal"> </span><span class="number">4</span><span class="symbol">:</span>
<span class="normal">            </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_number </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x03</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="function">png_write_finish_row</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">);</span>
<span class="normal">               </span><span class="keyword">return</span><span class="symbol">;</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">         </span><span class="keyword">case</span><span class="normal"> </span><span class="number">5</span><span class="symbol">:</span>
<span class="normal">            </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_number </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x01</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">width </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="function">png_write_finish_row</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">);</span>
<span class="normal">               </span><span class="keyword">return</span><span class="symbol">;</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">         </span><span class="keyword">case</span><span class="normal"> </span><span class="number">6</span><span class="symbol">:</span>
<span class="normal">            </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_number </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x01</span><span class="symbol">))</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="function">png_write_finish_row</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">);</span>
<span class="normal">               </span><span class="keyword">return</span><span class="symbol">;</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">   </span><span class="cbracket">}</span>
<span class="preproc">#endif</span>

<span class="normal">   </span><span class="comment">/* set up row info for transformations */</span>
<span class="normal">   png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_info</span><span class="symbol">.</span><span class="normal">color_type </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">color_type</span><span class="symbol">;</span>
<span class="normal">   png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_info</span><span class="symbol">.</span><span class="normal">width </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">usr_width</span><span class="symbol">;</span>
<span class="normal">   png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_info</span><span class="symbol">.</span><span class="normal">channels </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">usr_channels</span><span class="symbol">;</span>
<span class="normal">   png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_info</span><span class="symbol">.</span><span class="normal">bit_depth </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">usr_bit_depth</span><span class="symbol">;</span>
<span class="normal">   png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_info</span><span class="symbol">.</span><span class="normal">pixel_depth </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_info</span><span class="symbol">.</span><span class="normal">bit_depth </span><span class="symbol">*</span>
<span class="normal">      png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_info</span><span class="symbol">.</span><span class="normal">channels</span><span class="symbol">);</span>

<span class="normal">   png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_info</span><span class="symbol">.</span><span class="normal">rowbytes </span><span class="symbol">=</span><span class="normal"> </span><span class="function">PNG_ROWBYTES</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_info</span><span class="symbol">.</span><span class="normal">pixel_depth</span><span class="symbol">,</span>
<span class="normal">      png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_info</span><span class="symbol">.</span><span class="normal">width</span><span class="symbol">);</span>

<span class="normal">   </span><span class="function">png_debug1</span><span class="symbol">(</span><span class="number">3</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"row_info-&gt;color_type = %d</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_info</span><span class="symbol">.</span><span class="normal">color_type</span><span class="symbol">);</span>
<span class="normal">   </span><span class="function">png_debug1</span><span class="symbol">(</span><span class="number">3</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"row_info-&gt;width = %lu</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_info</span><span class="symbol">.</span><span class="normal">width</span><span class="symbol">);</span>
<span class="normal">   </span><span class="function">png_debug1</span><span class="symbol">(</span><span class="number">3</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"row_info-&gt;channels = %d</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_info</span><span class="symbol">.</span><span class="normal">channels</span><span class="symbol">);</span>
<span class="normal">   </span><span class="function">png_debug1</span><span class="symbol">(</span><span class="number">3</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"row_info-&gt;bit_depth = %d</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_info</span><span class="symbol">.</span><span class="normal">bit_depth</span><span class="symbol">);</span>
<span class="normal">   </span><span class="function">png_debug1</span><span class="symbol">(</span><span class="number">3</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"row_info-&gt;pixel_depth = %d</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_info</span><span class="symbol">.</span><span class="normal">pixel_depth</span><span class="symbol">);</span>
<span class="normal">   </span><span class="function">png_debug1</span><span class="symbol">(</span><span class="number">3</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"row_info-&gt;rowbytes = %lu</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_info</span><span class="symbol">.</span><span class="normal">rowbytes</span><span class="symbol">);</span>

<span class="normal">   </span><span class="comment">/* Copy user's row into buffer, leaving room for filter byte. */</span>
<span class="normal">   </span><span class="function">png_memcpy_check</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_buf </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span><span class="normal"> row</span><span class="symbol">,</span>
<span class="normal">      png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_info</span><span class="symbol">.</span><span class="normal">rowbytes</span><span class="symbol">);</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_WRITE_INTERLACING_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="comment">/* handle interlacing */</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">interlaced </span><span class="symbol">&amp;&amp;</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">pass </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">6</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span>
<span class="normal">      </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">&amp;</span><span class="normal"> PNG_INTERLACE</span><span class="symbol">))</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="function">png_do_write_interlace</span><span class="symbol">(&amp;(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_info</span><span class="symbol">),</span>
<span class="normal">         png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_buf </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">pass</span><span class="symbol">);</span>
<span class="normal">      </span><span class="comment">/* this should always get caught above, but still ... */</span>
<span class="normal">      </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_info</span><span class="symbol">.</span><span class="normal">width</span><span class="symbol">))</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         </span><span class="function">png_write_finish_row</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">);</span>
<span class="normal">         </span><span class="keyword">return</span><span class="symbol">;</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">   </span><span class="cbracket">}</span>
<span class="preproc">#endif</span>

<span class="normal">   </span><span class="comment">/* handle other transformations */</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations</span><span class="symbol">)</span>
<span class="normal">      </span><span class="function">png_do_write_transformations</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">);</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_MNG_FEATURES_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="comment">/* Write filter_method 64 (intrapixel differencing) only if</span>
<span class="comment">    * 1. Libpng was compiled with PNG_MNG_FEATURES_SUPPORTED and</span>
<span class="comment">    * 2. Libpng did not write a PNG signature (this filter_method is only</span>
<span class="comment">    *    used in PNG datastreams that are embedded in MNG datastreams) and</span>
<span class="comment">    * 3. The application called png_permit_mng_features with a mask that</span>
<span class="comment">    *    included PNG_FLAG_MNG_FILTER_64 and</span>
<span class="comment">    * 4. The filter_method is 64 and</span>
<span class="comment">    * 5. The color_type is RGB or RGBA</span>
<span class="comment">    */</span>
<span class="normal">   </span><span class="keyword">if</span><span class="symbol">((</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">mng_features_permitted </span><span class="symbol">&amp;</span><span class="normal"> PNG_FLAG_MNG_FILTER_64</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span>
<span class="normal">      </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">filter_type </span><span class="symbol">==</span><span class="normal"> PNG_INTRAPIXEL_DIFFERENCING</span><span class="symbol">))</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="comment">/* Intrapixel differencing */</span>
<span class="normal">      </span><span class="function">png_do_write_intrapixel</span><span class="symbol">(&amp;(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_info</span><span class="symbol">),</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_buf </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">   </span><span class="cbracket">}</span>
<span class="preproc">#endif</span>

<span class="normal">   </span><span class="comment">/* Find a filter if necessary, filter the row and write it out. */</span>
<span class="normal">   </span><span class="function">png_write_find_filter</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">&amp;(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_info</span><span class="symbol">));</span>

<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">write_row_fn </span><span class="symbol">!=</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">      </span><span class="symbol">(*(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">write_row_fn</span><span class="symbol">))(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_number</span><span class="symbol">,</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">pass</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_WRITE_FLUSH_SUPPORTED</span><span class="symbol">)</span>
<span class="comment">/* Set the automatic flush interval or 0 to turn flushing off */</span>
<span class="type">void</span><span class="normal"> PNGAPI</span>
<span class="function">png_set_flush</span><span class="symbol">(</span><span class="usertype">png_structp</span><span class="normal"> png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> nrows</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">   </span><span class="function">png_debug</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"in png_set_flush</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr </span><span class="symbol">==</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">      </span><span class="keyword">return</span><span class="symbol">;</span>
<span class="normal">   png_ptr</span><span class="symbol">-&gt;</span><span class="normal">flush_dist </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">nrows </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">0</span><span class="normal"> </span><span class="symbol">?</span><span class="normal"> </span><span class="number">0</span><span class="normal"> </span><span class="symbol">:</span><span class="normal"> nrows</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="comment">/* flush the current output buffers now */</span>
<span class="type">void</span><span class="normal"> PNGAPI</span>
<span class="function">png_write_flush</span><span class="symbol">(</span><span class="usertype">png_structp</span><span class="normal"> png_ptr</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">   </span><span class="type">int</span><span class="normal"> wrote_IDAT</span><span class="symbol">;</span>

<span class="normal">   </span><span class="function">png_debug</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"in png_write_flush</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr </span><span class="symbol">==</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">      </span><span class="keyword">return</span><span class="symbol">;</span>
<span class="normal">   </span><span class="comment">/* We have already written out all of the data */</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_number </span><span class="symbol">&gt;=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">num_rows</span><span class="symbol">)</span>
<span class="normal">     </span><span class="keyword">return</span><span class="symbol">;</span>

<span class="normal">   </span><span class="keyword">do</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="type">int</span><span class="normal"> ret</span><span class="symbol">;</span>

<span class="normal">      </span><span class="comment">/* compress the data */</span>
<span class="normal">      ret </span><span class="symbol">=</span><span class="normal"> </span><span class="function">deflate</span><span class="symbol">(&amp;</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">zstream</span><span class="symbol">,</span><span class="normal"> Z_SYNC_FLUSH</span><span class="symbol">);</span>
<span class="normal">      wrote_IDAT </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">      </span><span class="comment">/* check for compression errors */</span>
<span class="normal">      </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ret </span><span class="symbol">!=</span><span class="normal"> Z_OK</span><span class="symbol">)</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">zstream</span><span class="symbol">.</span><span class="normal">msg </span><span class="symbol">!=</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">            </span><span class="function">png_error</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">zstream</span><span class="symbol">.</span><span class="normal">msg</span><span class="symbol">);</span>
<span class="normal">         </span><span class="keyword">else</span>
<span class="normal">            </span><span class="function">png_error</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"zlib error"</span><span class="symbol">);</span>
<span class="normal">      </span><span class="cbracket">}</span>

<span class="normal">      </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">zstream</span><span class="symbol">.</span><span class="normal">avail_out</span><span class="symbol">))</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         </span><span class="comment">/* write the IDAT and reset the zlib output buffer */</span>
<span class="normal">         </span><span class="function">png_write_IDAT</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">zbuf</span><span class="symbol">,</span>
<span class="normal">                        png_ptr</span><span class="symbol">-&gt;</span><span class="normal">zbuf_size</span><span class="symbol">);</span>
<span class="normal">         png_ptr</span><span class="symbol">-&gt;</span><span class="normal">zstream</span><span class="symbol">.</span><span class="normal">next_out </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">zbuf</span><span class="symbol">;</span>
<span class="normal">         png_ptr</span><span class="symbol">-&gt;</span><span class="normal">zstream</span><span class="symbol">.</span><span class="normal">avail_out </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">uInt</span><span class="symbol">)</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">zbuf_size</span><span class="symbol">;</span>
<span class="normal">         wrote_IDAT </span><span class="symbol">=</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">   </span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">while</span><span class="symbol">(</span><span class="normal">wrote_IDAT </span><span class="symbol">==</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>

<span class="normal">   </span><span class="comment">/* If there is any data left to be output, write it into a new IDAT */</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">zbuf_size </span><span class="symbol">!=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">zstream</span><span class="symbol">.</span><span class="normal">avail_out</span><span class="symbol">)</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="comment">/* write the IDAT and reset the zlib output buffer */</span>
<span class="normal">      </span><span class="function">png_write_IDAT</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">zbuf</span><span class="symbol">,</span>
<span class="normal">                     png_ptr</span><span class="symbol">-&gt;</span><span class="normal">zbuf_size </span><span class="symbol">-</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">zstream</span><span class="symbol">.</span><span class="normal">avail_out</span><span class="symbol">);</span>
<span class="normal">      png_ptr</span><span class="symbol">-&gt;</span><span class="normal">zstream</span><span class="symbol">.</span><span class="normal">next_out </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">zbuf</span><span class="symbol">;</span>
<span class="normal">      png_ptr</span><span class="symbol">-&gt;</span><span class="normal">zstream</span><span class="symbol">.</span><span class="normal">avail_out </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">uInt</span><span class="symbol">)</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">zbuf_size</span><span class="symbol">;</span>
<span class="normal">   </span><span class="cbracket">}</span>
<span class="normal">   png_ptr</span><span class="symbol">-&gt;</span><span class="normal">flush_rows </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">   </span><span class="function">png_flush</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">);</span>
<span class="cbracket">}</span>
<span class="preproc">#endif</span><span class="normal"> </span><span class="comment">/* PNG_WRITE_FLUSH_SUPPORTED */</span>

<span class="comment">/* free all memory used by the write */</span>
<span class="type">void</span><span class="normal"> PNGAPI</span>
<span class="function">png_destroy_write_struct</span><span class="symbol">(</span><span class="usertype">png_structpp</span><span class="normal"> png_ptr_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">png_infopp</span><span class="normal"> info_ptr_ptr</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">   </span><span class="usertype">png_structp</span><span class="normal"> png_ptr </span><span class="symbol">=</span><span class="normal"> NULL</span><span class="symbol">;</span>
<span class="normal">   </span><span class="usertype">png_infop</span><span class="normal"> info_ptr </span><span class="symbol">=</span><span class="normal"> NULL</span><span class="symbol">;</span>
<span class="preproc">#ifdef</span><span class="normal"> PNG_USER_MEM_SUPPORTED</span>
<span class="normal">   </span><span class="usertype">png_free_ptr</span><span class="normal"> free_fn </span><span class="symbol">=</span><span class="normal"> NULL</span><span class="symbol">;</span>
<span class="normal">   </span><span class="usertype">png_voidp</span><span class="normal"> mem_ptr </span><span class="symbol">=</span><span class="normal"> NULL</span><span class="symbol">;</span>
<span class="preproc">#endif</span>

<span class="normal">   </span><span class="function">png_debug</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"in png_destroy_write_struct</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr_ptr </span><span class="symbol">!=</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      png_ptr </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">png_ptr_ptr</span><span class="symbol">;</span>
<span class="preproc">#ifdef</span><span class="normal"> PNG_USER_MEM_SUPPORTED</span>
<span class="normal">      free_fn </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">free_fn</span><span class="symbol">;</span>
<span class="normal">      mem_ptr </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">mem_ptr</span><span class="symbol">;</span>
<span class="preproc">#endif</span>
<span class="normal">   </span><span class="cbracket">}</span>

<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">info_ptr_ptr </span><span class="symbol">!=</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">      info_ptr </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">info_ptr_ptr</span><span class="symbol">;</span>

<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">info_ptr </span><span class="symbol">!=</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="function">png_free_data</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> info_ptr</span><span class="symbol">,</span><span class="normal"> PNG_FREE_ALL</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">);</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_UNKNOWN_CHUNKS_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">      </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">num_chunk_list</span><span class="symbol">)</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         </span><span class="function">png_free</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">chunk_list</span><span class="symbol">);</span>
<span class="normal">         png_ptr</span><span class="symbol">-&gt;</span><span class="normal">chunk_list</span><span class="symbol">=</span><span class="normal">NULL</span><span class="symbol">;</span>
<span class="normal">         png_ptr</span><span class="symbol">-&gt;</span><span class="normal">num_chunk_list</span><span class="symbol">=</span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="preproc">#endif</span>

<span class="preproc">#ifdef</span><span class="normal"> PNG_USER_MEM_SUPPORTED</span>
<span class="normal">      </span><span class="function">png_destroy_struct_2</span><span class="symbol">((</span><span class="normal">png_voidp</span><span class="symbol">)</span><span class="normal">info_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_free_ptr</span><span class="symbol">)</span><span class="normal">free_fn</span><span class="symbol">,</span>
<span class="normal">         </span><span class="symbol">(</span><span class="normal">png_voidp</span><span class="symbol">)</span><span class="normal">mem_ptr</span><span class="symbol">);</span>
<span class="preproc">#else</span>
<span class="normal">      </span><span class="function">png_destroy_struct</span><span class="symbol">((</span><span class="normal">png_voidp</span><span class="symbol">)</span><span class="normal">info_ptr</span><span class="symbol">);</span>
<span class="preproc">#endif</span>
<span class="normal">      </span><span class="symbol">*</span><span class="normal">info_ptr_ptr </span><span class="symbol">=</span><span class="normal"> NULL</span><span class="symbol">;</span>
<span class="normal">   </span><span class="cbracket">}</span>

<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr </span><span class="symbol">!=</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="function">png_write_destroy</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">);</span>
<span class="preproc">#ifdef</span><span class="normal"> PNG_USER_MEM_SUPPORTED</span>
<span class="normal">      </span><span class="function">png_destroy_struct_2</span><span class="symbol">((</span><span class="normal">png_voidp</span><span class="symbol">)</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_free_ptr</span><span class="symbol">)</span><span class="normal">free_fn</span><span class="symbol">,</span>
<span class="normal">         </span><span class="symbol">(</span><span class="normal">png_voidp</span><span class="symbol">)</span><span class="normal">mem_ptr</span><span class="symbol">);</span>
<span class="preproc">#else</span>
<span class="normal">      </span><span class="function">png_destroy_struct</span><span class="symbol">((</span><span class="normal">png_voidp</span><span class="symbol">)</span><span class="normal">png_ptr</span><span class="symbol">);</span>
<span class="preproc">#endif</span>
<span class="normal">      </span><span class="symbol">*</span><span class="normal">png_ptr_ptr </span><span class="symbol">=</span><span class="normal"> NULL</span><span class="symbol">;</span>
<span class="normal">   </span><span class="cbracket">}</span>
<span class="cbracket">}</span>


<span class="comment">/* Free any memory used in png_ptr struct (old method) */</span>
<span class="type">void</span><span class="normal"> </span><span class="comment">/* PRIVATE */</span>
<span class="function">png_write_destroy</span><span class="symbol">(</span><span class="usertype">png_structp</span><span class="normal"> png_ptr</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="preproc">#ifdef</span><span class="normal"> PNG_SETJMP_SUPPORTED</span>
<span class="normal">   </span><span class="usertype">jmp_buf</span><span class="normal"> tmp_jmp</span><span class="symbol">;</span><span class="normal"> </span><span class="comment">/* save jump buffer */</span>
<span class="preproc">#endif</span>
<span class="normal">   </span><span class="usertype">png_error_ptr</span><span class="normal"> error_fn</span><span class="symbol">;</span>
<span class="normal">   </span><span class="usertype">png_error_ptr</span><span class="normal"> warning_fn</span><span class="symbol">;</span>
<span class="normal">   </span><span class="usertype">png_voidp</span><span class="normal"> error_ptr</span><span class="symbol">;</span>
<span class="preproc">#ifdef</span><span class="normal"> PNG_USER_MEM_SUPPORTED</span>
<span class="normal">   </span><span class="usertype">png_free_ptr</span><span class="normal"> free_fn</span><span class="symbol">;</span>
<span class="preproc">#endif</span>

<span class="normal">   </span><span class="function">png_debug</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"in png_write_destroy</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">   </span><span class="comment">/* free any memory zlib uses */</span>
<span class="normal">   </span><span class="function">deflateEnd</span><span class="symbol">(&amp;</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">zstream</span><span class="symbol">);</span>

<span class="normal">   </span><span class="comment">/* free our memory.  png_free checks NULL for us. */</span>
<span class="normal">   </span><span class="function">png_free</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">zbuf</span><span class="symbol">);</span>
<span class="normal">   </span><span class="function">png_free</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_buf</span><span class="symbol">);</span>
<span class="normal">   </span><span class="function">png_free</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">prev_row</span><span class="symbol">);</span>
<span class="normal">   </span><span class="function">png_free</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">sub_row</span><span class="symbol">);</span>
<span class="normal">   </span><span class="function">png_free</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">up_row</span><span class="symbol">);</span>
<span class="normal">   </span><span class="function">png_free</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">avg_row</span><span class="symbol">);</span>
<span class="normal">   </span><span class="function">png_free</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">paeth_row</span><span class="symbol">);</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_TIME_RFC1123_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="function">png_free</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">time_buffer</span><span class="symbol">);</span>
<span class="preproc">#endif</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_WRITE_WEIGHTED_FILTER_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="function">png_free</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">prev_filters</span><span class="symbol">);</span>
<span class="normal">   </span><span class="function">png_free</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">filter_weights</span><span class="symbol">);</span>
<span class="normal">   </span><span class="function">png_free</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">inv_filter_weights</span><span class="symbol">);</span>
<span class="normal">   </span><span class="function">png_free</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">filter_costs</span><span class="symbol">);</span>
<span class="normal">   </span><span class="function">png_free</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">inv_filter_costs</span><span class="symbol">);</span>
<span class="preproc">#endif</span>

<span class="preproc">#ifdef</span><span class="normal"> PNG_SETJMP_SUPPORTED</span>
<span class="normal">   </span><span class="comment">/* reset structure */</span>
<span class="normal">   </span><span class="function">png_memcpy</span><span class="symbol">(</span><span class="normal">tmp_jmp</span><span class="symbol">,</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">jmpbuf</span><span class="symbol">,</span><span class="normal"> </span><span class="function">png_sizeof</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">jmp_buf</span><span class="symbol">));</span>
<span class="preproc">#endif</span>

<span class="normal">   error_fn </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">error_fn</span><span class="symbol">;</span>
<span class="normal">   warning_fn </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">warning_fn</span><span class="symbol">;</span>
<span class="normal">   error_ptr </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">error_ptr</span><span class="symbol">;</span>
<span class="preproc">#ifdef</span><span class="normal"> PNG_USER_MEM_SUPPORTED</span>
<span class="normal">   free_fn </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">free_fn</span><span class="symbol">;</span>
<span class="preproc">#endif</span>

<span class="normal">   </span><span class="function">png_memset</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="function">png_sizeof</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_struct</span><span class="symbol">));</span>

<span class="normal">   png_ptr</span><span class="symbol">-&gt;</span><span class="normal">error_fn </span><span class="symbol">=</span><span class="normal"> error_fn</span><span class="symbol">;</span>
<span class="normal">   png_ptr</span><span class="symbol">-&gt;</span><span class="normal">warning_fn </span><span class="symbol">=</span><span class="normal"> warning_fn</span><span class="symbol">;</span>
<span class="normal">   png_ptr</span><span class="symbol">-&gt;</span><span class="normal">error_ptr </span><span class="symbol">=</span><span class="normal"> error_ptr</span><span class="symbol">;</span>
<span class="preproc">#ifdef</span><span class="normal"> PNG_USER_MEM_SUPPORTED</span>
<span class="normal">   png_ptr</span><span class="symbol">-&gt;</span><span class="normal">free_fn </span><span class="symbol">=</span><span class="normal"> free_fn</span><span class="symbol">;</span>
<span class="preproc">#endif</span>

<span class="preproc">#ifdef</span><span class="normal"> PNG_SETJMP_SUPPORTED</span>
<span class="normal">   </span><span class="function">png_memcpy</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">jmpbuf</span><span class="symbol">,</span><span class="normal"> tmp_jmp</span><span class="symbol">,</span><span class="normal"> </span><span class="function">png_sizeof</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">jmp_buf</span><span class="symbol">));</span>
<span class="preproc">#endif</span>
<span class="cbracket">}</span>

<span class="comment">/* Allow the application to select one or more row filters to use. */</span>
<span class="type">void</span><span class="normal"> PNGAPI</span>
<span class="function">png_set_filter</span><span class="symbol">(</span><span class="usertype">png_structp</span><span class="normal"> png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> method</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> filters</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">   </span><span class="function">png_debug</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"in png_set_filter</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr </span><span class="symbol">==</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">      </span><span class="keyword">return</span><span class="symbol">;</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_MNG_FEATURES_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="symbol">((</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">mng_features_permitted </span><span class="symbol">&amp;</span><span class="normal"> PNG_FLAG_MNG_FILTER_64</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span>
<span class="normal">      </span><span class="symbol">(</span><span class="normal">method </span><span class="symbol">==</span><span class="normal"> PNG_INTRAPIXEL_DIFFERENCING</span><span class="symbol">))</span>
<span class="normal">         method </span><span class="symbol">=</span><span class="normal"> PNG_FILTER_TYPE_BASE</span><span class="symbol">;</span>
<span class="preproc">#endif</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">method </span><span class="symbol">==</span><span class="normal"> PNG_FILTER_TYPE_BASE</span><span class="symbol">)</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="keyword">switch</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">filters </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">PNG_ALL_FILTERS </span><span class="symbol">|</span><span class="normal"> </span><span class="number">0x07</span><span class="symbol">))</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         </span><span class="keyword">case</span><span class="normal"> </span><span class="number">5</span><span class="symbol">:</span>
<span class="normal">         </span><span class="keyword">case</span><span class="normal"> </span><span class="number">6</span><span class="symbol">:</span>
<span class="normal">         </span><span class="keyword">case</span><span class="normal"> </span><span class="number">7</span><span class="symbol">:</span><span class="normal"> </span><span class="function">png_warning</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"Unknown row filter for method 0"</span><span class="symbol">);</span>
<span class="normal">         </span><span class="keyword">case</span><span class="normal"> PNG_FILTER_VALUE_NONE</span><span class="symbol">:</span><span class="normal">  png_ptr</span><span class="symbol">-&gt;</span><span class="normal">do_filter</span><span class="symbol">=</span><span class="normal">PNG_FILTER_NONE</span><span class="symbol">;</span><span class="normal"> </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">         </span><span class="keyword">case</span><span class="normal"> PNG_FILTER_VALUE_SUB</span><span class="symbol">:</span><span class="normal">   png_ptr</span><span class="symbol">-&gt;</span><span class="normal">do_filter</span><span class="symbol">=</span><span class="normal">PNG_FILTER_SUB</span><span class="symbol">;</span><span class="normal">  </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">         </span><span class="keyword">case</span><span class="normal"> PNG_FILTER_VALUE_UP</span><span class="symbol">:</span><span class="normal">    png_ptr</span><span class="symbol">-&gt;</span><span class="normal">do_filter</span><span class="symbol">=</span><span class="normal">PNG_FILTER_UP</span><span class="symbol">;</span><span class="normal">   </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">         </span><span class="keyword">case</span><span class="normal"> PNG_FILTER_VALUE_AVG</span><span class="symbol">:</span><span class="normal">   png_ptr</span><span class="symbol">-&gt;</span><span class="normal">do_filter</span><span class="symbol">=</span><span class="normal">PNG_FILTER_AVG</span><span class="symbol">;</span><span class="normal">  </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">         </span><span class="keyword">case</span><span class="normal"> PNG_FILTER_VALUE_PAETH</span><span class="symbol">:</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">do_filter</span><span class="symbol">=</span><span class="normal">PNG_FILTER_PAETH</span><span class="symbol">;</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">         </span><span class="keyword">default</span><span class="symbol">:</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">do_filter </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)</span><span class="normal">filters</span><span class="symbol">;</span><span class="normal"> </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">      </span><span class="cbracket">}</span>

<span class="normal">      </span><span class="comment">/* If we have allocated the row_buf, this means we have already started</span>
<span class="comment">       * with the image and we should have allocated all of the filter buffers</span>
<span class="comment">       * that have been selected.  If prev_row isn't already allocated, then</span>
<span class="comment">       * it is too late to start using the filters that need it, since we</span>
<span class="comment">       * will be missing the data in the previous row.  If an application</span>
<span class="comment">       * wants to start and stop using particular filters during compression,</span>
<span class="comment">       * it should start out with all of the filters, and then add and</span>
<span class="comment">       * remove them after the start of compression.</span>
<span class="comment">       */</span>
<span class="normal">      </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_buf </span><span class="symbol">!=</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">do_filter </span><span class="symbol">&amp;</span><span class="normal"> PNG_FILTER_SUB</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">sub_row </span><span class="symbol">==</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            png_ptr</span><span class="symbol">-&gt;</span><span class="normal">sub_row </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_bytep</span><span class="symbol">)</span><span class="function">png_malloc</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span>
<span class="normal">              </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">rowbytes </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">));</span>
<span class="normal">            png_ptr</span><span class="symbol">-&gt;</span><span class="normal">sub_row</span><span class="symbol">[</span><span class="number">0</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> PNG_FILTER_VALUE_SUB</span><span class="symbol">;</span>
<span class="normal">         </span><span class="cbracket">}</span>

<span class="normal">         </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">do_filter </span><span class="symbol">&amp;</span><span class="normal"> PNG_FILTER_UP</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">up_row </span><span class="symbol">==</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">prev_row </span><span class="symbol">==</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="function">png_warning</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"Can't add Up filter after starting"</span><span class="symbol">);</span>
<span class="normal">               png_ptr</span><span class="symbol">-&gt;</span><span class="normal">do_filter </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="symbol">~</span><span class="normal">PNG_FILTER_UP</span><span class="symbol">;</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="keyword">else</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               png_ptr</span><span class="symbol">-&gt;</span><span class="normal">up_row </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_bytep</span><span class="symbol">)</span><span class="function">png_malloc</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span>
<span class="normal">                  </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">rowbytes </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">));</span>
<span class="normal">               png_ptr</span><span class="symbol">-&gt;</span><span class="normal">up_row</span><span class="symbol">[</span><span class="number">0</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> PNG_FILTER_VALUE_UP</span><span class="symbol">;</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">         </span><span class="cbracket">}</span>

<span class="normal">         </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">do_filter </span><span class="symbol">&amp;</span><span class="normal"> PNG_FILTER_AVG</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">avg_row </span><span class="symbol">==</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">prev_row </span><span class="symbol">==</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="function">png_warning</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"Can't add Average filter after starting"</span><span class="symbol">);</span>
<span class="normal">               png_ptr</span><span class="symbol">-&gt;</span><span class="normal">do_filter </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="symbol">~</span><span class="normal">PNG_FILTER_AVG</span><span class="symbol">;</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="keyword">else</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               png_ptr</span><span class="symbol">-&gt;</span><span class="normal">avg_row </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_bytep</span><span class="symbol">)</span><span class="function">png_malloc</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span>
<span class="normal">                  </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">rowbytes </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">));</span>
<span class="normal">               png_ptr</span><span class="symbol">-&gt;</span><span class="normal">avg_row</span><span class="symbol">[</span><span class="number">0</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> PNG_FILTER_VALUE_AVG</span><span class="symbol">;</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">         </span><span class="cbracket">}</span>

<span class="normal">         </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">do_filter </span><span class="symbol">&amp;</span><span class="normal"> PNG_FILTER_PAETH</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span>
<span class="normal">             png_ptr</span><span class="symbol">-&gt;</span><span class="normal">paeth_row </span><span class="symbol">==</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">prev_row </span><span class="symbol">==</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="function">png_warning</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"Can't add Paeth filter after starting"</span><span class="symbol">);</span>
<span class="normal">               png_ptr</span><span class="symbol">-&gt;</span><span class="normal">do_filter </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(~</span><span class="normal">PNG_FILTER_PAETH</span><span class="symbol">);</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="keyword">else</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               png_ptr</span><span class="symbol">-&gt;</span><span class="normal">paeth_row </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_bytep</span><span class="symbol">)</span><span class="function">png_malloc</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span>
<span class="normal">                  </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">rowbytes </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">));</span>
<span class="normal">               png_ptr</span><span class="symbol">-&gt;</span><span class="normal">paeth_row</span><span class="symbol">[</span><span class="number">0</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> PNG_FILTER_VALUE_PAETH</span><span class="symbol">;</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">         </span><span class="cbracket">}</span>

<span class="normal">         </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">do_filter </span><span class="symbol">==</span><span class="normal"> PNG_NO_FILTERS</span><span class="symbol">)</span>
<span class="normal">            png_ptr</span><span class="symbol">-&gt;</span><span class="normal">do_filter </span><span class="symbol">=</span><span class="normal"> PNG_FILTER_NONE</span><span class="symbol">;</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">   </span><span class="cbracket">}</span>
<span class="normal">   </span><span class="keyword">else</span>
<span class="normal">      </span><span class="function">png_error</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"Unknown custom filter method"</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="comment">/* This allows us to influence the way in which libpng chooses the "best"</span>
<span class="comment"> * filter for the current scanline.  While the "minimum-sum-of-absolute-</span>
<span class="comment"> * differences metric is relatively fast and effective, there is some</span>
<span class="comment"> * question as to whether it can be improved upon by trying to keep the</span>
<span class="comment"> * filtered data going to zlib more consistent, hopefully resulting in</span>
<span class="comment"> * better compression.</span>
<span class="comment"> */</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_WRITE_WEIGHTED_FILTER_SUPPORTED</span><span class="symbol">)</span><span class="normal">      </span><span class="comment">/* GRR 970116 */</span>
<span class="type">void</span><span class="normal"> PNGAPI</span>
<span class="function">png_set_filter_heuristics</span><span class="symbol">(</span><span class="usertype">png_structp</span><span class="normal"> png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> heuristic_method</span><span class="symbol">,</span>
<span class="normal">   </span><span class="type">int</span><span class="normal"> num_weights</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">png_doublep</span><span class="normal"> filter_weights</span><span class="symbol">,</span>
<span class="normal">   </span><span class="usertype">png_doublep</span><span class="normal"> filter_costs</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">   </span><span class="type">int</span><span class="normal"> i</span><span class="symbol">;</span>

<span class="normal">   </span><span class="function">png_debug</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"in png_set_filter_heuristics</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr </span><span class="symbol">==</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">      </span><span class="keyword">return</span><span class="symbol">;</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">heuristic_method </span><span class="symbol">&gt;=</span><span class="normal"> PNG_FILTER_HEURISTIC_LAST</span><span class="symbol">)</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="function">png_warning</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"Unknown filter heuristic method"</span><span class="symbol">);</span>
<span class="normal">      </span><span class="keyword">return</span><span class="symbol">;</span>
<span class="normal">   </span><span class="cbracket">}</span>

<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">heuristic_method </span><span class="symbol">==</span><span class="normal"> PNG_FILTER_HEURISTIC_DEFAULT</span><span class="symbol">)</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      heuristic_method </span><span class="symbol">=</span><span class="normal"> PNG_FILTER_HEURISTIC_UNWEIGHTED</span><span class="symbol">;</span>
<span class="normal">   </span><span class="cbracket">}</span>

<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">num_weights </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">0</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> filter_weights </span><span class="symbol">==</span><span class="normal"> NULL </span><span class="symbol">||</span>
<span class="normal">      heuristic_method </span><span class="symbol">==</span><span class="normal"> PNG_FILTER_HEURISTIC_UNWEIGHTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      num_weights </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">   </span><span class="cbracket">}</span>

<span class="normal">   png_ptr</span><span class="symbol">-&gt;</span><span class="normal">num_prev_filters </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)</span><span class="normal">num_weights</span><span class="symbol">;</span>
<span class="normal">   png_ptr</span><span class="symbol">-&gt;</span><span class="normal">heuristic_method </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)</span><span class="normal">heuristic_method</span><span class="symbol">;</span>

<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">num_weights </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">prev_filters </span><span class="symbol">==</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         png_ptr</span><span class="symbol">-&gt;</span><span class="normal">prev_filters </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_bytep</span><span class="symbol">)</span><span class="function">png_malloc</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span>
<span class="normal">            </span><span class="symbol">(</span><span class="normal">png_uint_32</span><span class="symbol">)(</span><span class="function">png_sizeof</span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> num_weights</span><span class="symbol">));</span>

<span class="normal">         </span><span class="comment">/* To make sure that the weighting starts out fairly */</span>
<span class="normal">         </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> num_weights</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            png_ptr</span><span class="symbol">-&gt;</span><span class="normal">prev_filters</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="number">255</span><span class="symbol">;</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="cbracket">}</span>

<span class="normal">      </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">filter_weights </span><span class="symbol">==</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         png_ptr</span><span class="symbol">-&gt;</span><span class="normal">filter_weights </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16p</span><span class="symbol">)</span><span class="function">png_malloc</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span>
<span class="normal">            </span><span class="symbol">(</span><span class="normal">png_uint_32</span><span class="symbol">)(</span><span class="function">png_sizeof</span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> num_weights</span><span class="symbol">));</span>

<span class="normal">         png_ptr</span><span class="symbol">-&gt;</span><span class="normal">inv_filter_weights </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16p</span><span class="symbol">)</span><span class="function">png_malloc</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span>
<span class="normal">            </span><span class="symbol">(</span><span class="normal">png_uint_32</span><span class="symbol">)(</span><span class="function">png_sizeof</span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> num_weights</span><span class="symbol">));</span>
<span class="normal">         </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> num_weights</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            png_ptr</span><span class="symbol">-&gt;</span><span class="normal">inv_filter_weights</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span>
<span class="normal">            png_ptr</span><span class="symbol">-&gt;</span><span class="normal">filter_weights</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> PNG_WEIGHT_FACTOR</span><span class="symbol">;</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="cbracket">}</span>

<span class="normal">      </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> num_weights</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">filter_weights</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">0.0</span><span class="symbol">)</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            png_ptr</span><span class="symbol">-&gt;</span><span class="normal">inv_filter_weights</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span>
<span class="normal">            png_ptr</span><span class="symbol">-&gt;</span><span class="normal">filter_weights</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> PNG_WEIGHT_FACTOR</span><span class="symbol">;</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">         </span><span class="keyword">else</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            png_ptr</span><span class="symbol">-&gt;</span><span class="normal">inv_filter_weights</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span>
<span class="normal">               </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)((</span><span class="type">double</span><span class="symbol">)</span><span class="normal">PNG_WEIGHT_FACTOR</span><span class="symbol">*</span><span class="normal">filter_weights</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]+</span><span class="number">0.5</span><span class="symbol">);</span>
<span class="normal">            png_ptr</span><span class="symbol">-&gt;</span><span class="normal">filter_weights</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span>
<span class="normal">               </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)((</span><span class="type">double</span><span class="symbol">)</span><span class="normal">PNG_WEIGHT_FACTOR</span><span class="symbol">/</span><span class="normal">filter_weights</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]+</span><span class="number">0.5</span><span class="symbol">);</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">   </span><span class="cbracket">}</span>

<span class="normal">   </span><span class="comment">/* If, in the future, there are other filter methods, this would</span>
<span class="comment">    * need to be based on png_ptr-&gt;filter.</span>
<span class="comment">    */</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">filter_costs </span><span class="symbol">==</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      png_ptr</span><span class="symbol">-&gt;</span><span class="normal">filter_costs </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16p</span><span class="symbol">)</span><span class="function">png_malloc</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span>
<span class="normal">         </span><span class="symbol">(</span><span class="normal">png_uint_32</span><span class="symbol">)(</span><span class="function">png_sizeof</span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> PNG_FILTER_VALUE_LAST</span><span class="symbol">));</span>

<span class="normal">      png_ptr</span><span class="symbol">-&gt;</span><span class="normal">inv_filter_costs </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16p</span><span class="symbol">)</span><span class="function">png_malloc</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span>
<span class="normal">         </span><span class="symbol">(</span><span class="normal">png_uint_32</span><span class="symbol">)(</span><span class="function">png_sizeof</span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> PNG_FILTER_VALUE_LAST</span><span class="symbol">));</span>

<span class="normal">      </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> PNG_FILTER_VALUE_LAST</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         png_ptr</span><span class="symbol">-&gt;</span><span class="normal">inv_filter_costs</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span>
<span class="normal">         png_ptr</span><span class="symbol">-&gt;</span><span class="normal">filter_costs</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> PNG_COST_FACTOR</span><span class="symbol">;</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">   </span><span class="cbracket">}</span>

<span class="normal">   </span><span class="comment">/* Here is where we set the relative costs of the different filters.  We</span>
<span class="comment">    * should take the desired compression level into account when setting</span>
<span class="comment">    * the costs, so that Paeth, for instance, has a high relative cost at low</span>
<span class="comment">    * compression levels, while it has a lower relative cost at higher</span>
<span class="comment">    * compression settings.  The filter types are in order of increasing</span>
<span class="comment">    * relative cost, so it would be possible to do this with an algorithm.</span>
<span class="comment">    */</span>
<span class="normal">   </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> PNG_FILTER_VALUE_LAST</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">filter_costs </span><span class="symbol">==</span><span class="normal"> NULL </span><span class="symbol">||</span><span class="normal"> filter_costs</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">0.0</span><span class="symbol">)</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         png_ptr</span><span class="symbol">-&gt;</span><span class="normal">inv_filter_costs</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span>
<span class="normal">         png_ptr</span><span class="symbol">-&gt;</span><span class="normal">filter_costs</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> PNG_COST_FACTOR</span><span class="symbol">;</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">filter_costs</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">1.0</span><span class="symbol">)</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         png_ptr</span><span class="symbol">-&gt;</span><span class="normal">inv_filter_costs</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span>
<span class="normal">            </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)((</span><span class="type">double</span><span class="symbol">)</span><span class="normal">PNG_COST_FACTOR </span><span class="symbol">/</span><span class="normal"> filter_costs</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="number">0.5</span><span class="symbol">);</span>
<span class="normal">         png_ptr</span><span class="symbol">-&gt;</span><span class="normal">filter_costs</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span>
<span class="normal">            </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)((</span><span class="type">double</span><span class="symbol">)</span><span class="normal">PNG_COST_FACTOR </span><span class="symbol">*</span><span class="normal"> filter_costs</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="number">0.5</span><span class="symbol">);</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">   </span><span class="cbracket">}</span>
<span class="cbracket">}</span>
<span class="preproc">#endif</span><span class="normal"> </span><span class="comment">/* PNG_WRITE_WEIGHTED_FILTER_SUPPORTED */</span>

<span class="type">void</span><span class="normal"> PNGAPI</span>
<span class="function">png_set_compression_level</span><span class="symbol">(</span><span class="usertype">png_structp</span><span class="normal"> png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> level</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">   </span><span class="function">png_debug</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"in png_set_compression_level</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr </span><span class="symbol">==</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">      </span><span class="keyword">return</span><span class="symbol">;</span>
<span class="normal">   png_ptr</span><span class="symbol">-&gt;</span><span class="normal">flags </span><span class="symbol">|=</span><span class="normal"> PNG_FLAG_ZLIB_CUSTOM_LEVEL</span><span class="symbol">;</span>
<span class="normal">   png_ptr</span><span class="symbol">-&gt;</span><span class="normal">zlib_level </span><span class="symbol">=</span><span class="normal"> level</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> PNGAPI</span>
<span class="function">png_set_compression_mem_level</span><span class="symbol">(</span><span class="usertype">png_structp</span><span class="normal"> png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> mem_level</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">   </span><span class="function">png_debug</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"in png_set_compression_mem_level</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr </span><span class="symbol">==</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">      </span><span class="keyword">return</span><span class="symbol">;</span>
<span class="normal">   png_ptr</span><span class="symbol">-&gt;</span><span class="normal">flags </span><span class="symbol">|=</span><span class="normal"> PNG_FLAG_ZLIB_CUSTOM_MEM_LEVEL</span><span class="symbol">;</span>
<span class="normal">   png_ptr</span><span class="symbol">-&gt;</span><span class="normal">zlib_mem_level </span><span class="symbol">=</span><span class="normal"> mem_level</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> PNGAPI</span>
<span class="function">png_set_compression_strategy</span><span class="symbol">(</span><span class="usertype">png_structp</span><span class="normal"> png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> strategy</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">   </span><span class="function">png_debug</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"in png_set_compression_strategy</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr </span><span class="symbol">==</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">      </span><span class="keyword">return</span><span class="symbol">;</span>
<span class="normal">   png_ptr</span><span class="symbol">-&gt;</span><span class="normal">flags </span><span class="symbol">|=</span><span class="normal"> PNG_FLAG_ZLIB_CUSTOM_STRATEGY</span><span class="symbol">;</span>
<span class="normal">   png_ptr</span><span class="symbol">-&gt;</span><span class="normal">zlib_strategy </span><span class="symbol">=</span><span class="normal"> strategy</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> PNGAPI</span>
<span class="function">png_set_compression_window_bits</span><span class="symbol">(</span><span class="usertype">png_structp</span><span class="normal"> png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> window_bits</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr </span><span class="symbol">==</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">      </span><span class="keyword">return</span><span class="symbol">;</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">window_bits </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">15</span><span class="symbol">)</span>
<span class="normal">      </span><span class="function">png_warning</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"Only compression windows &lt;= 32k supported by PNG"</span><span class="symbol">);</span>
<span class="normal">   </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">window_bits </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span>
<span class="normal">      </span><span class="function">png_warning</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"Only compression windows &gt;= 256 supported by PNG"</span><span class="symbol">);</span>
<span class="preproc">#ifndef</span><span class="normal"> WBITS_8_OK</span>
<span class="normal">   </span><span class="comment">/* avoid libpng bug with 256-byte windows */</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">window_bits </span><span class="symbol">==</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span>
<span class="normal">     </span><span class="cbracket">{</span>
<span class="normal">       </span><span class="function">png_warning</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"Compression window is being reset to 512"</span><span class="symbol">);</span>
<span class="normal">       window_bits</span><span class="symbol">=</span><span class="number">9</span><span class="symbol">;</span>
<span class="normal">     </span><span class="cbracket">}</span>
<span class="preproc">#endif</span>
<span class="normal">   png_ptr</span><span class="symbol">-&gt;</span><span class="normal">flags </span><span class="symbol">|=</span><span class="normal"> PNG_FLAG_ZLIB_CUSTOM_WINDOW_BITS</span><span class="symbol">;</span>
<span class="normal">   png_ptr</span><span class="symbol">-&gt;</span><span class="normal">zlib_window_bits </span><span class="symbol">=</span><span class="normal"> window_bits</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> PNGAPI</span>
<span class="function">png_set_compression_method</span><span class="symbol">(</span><span class="usertype">png_structp</span><span class="normal"> png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> method</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">   </span><span class="function">png_debug</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"in png_set_compression_method</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr </span><span class="symbol">==</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">      </span><span class="keyword">return</span><span class="symbol">;</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">method </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span>
<span class="normal">      </span><span class="function">png_warning</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"Only compression method 8 is supported by PNG"</span><span class="symbol">);</span>
<span class="normal">   png_ptr</span><span class="symbol">-&gt;</span><span class="normal">flags </span><span class="symbol">|=</span><span class="normal"> PNG_FLAG_ZLIB_CUSTOM_METHOD</span><span class="symbol">;</span>
<span class="normal">   png_ptr</span><span class="symbol">-&gt;</span><span class="normal">zlib_method </span><span class="symbol">=</span><span class="normal"> method</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> PNGAPI</span>
<span class="function">png_set_write_status_fn</span><span class="symbol">(</span><span class="usertype">png_structp</span><span class="normal"> png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">png_write_status_ptr</span><span class="normal"> write_row_fn</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr </span><span class="symbol">==</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">      </span><span class="keyword">return</span><span class="symbol">;</span>
<span class="normal">   png_ptr</span><span class="symbol">-&gt;</span><span class="normal">write_row_fn </span><span class="symbol">=</span><span class="normal"> write_row_fn</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_WRITE_USER_TRANSFORM_SUPPORTED</span><span class="symbol">)</span>
<span class="type">void</span><span class="normal"> PNGAPI</span>
<span class="function">png_set_write_user_transform_fn</span><span class="symbol">(</span><span class="usertype">png_structp</span><span class="normal"> png_ptr</span><span class="symbol">,</span><span class="normal"> png_user_transform_ptr</span>
<span class="normal">   write_user_transform_fn</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">   </span><span class="function">png_debug</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"in png_set_write_user_transform_fn</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr </span><span class="symbol">==</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">      </span><span class="keyword">return</span><span class="symbol">;</span>
<span class="normal">   png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">|=</span><span class="normal"> PNG_USER_TRANSFORM</span><span class="symbol">;</span>
<span class="normal">   png_ptr</span><span class="symbol">-&gt;</span><span class="normal">write_user_transform_fn </span><span class="symbol">=</span><span class="normal"> write_user_transform_fn</span><span class="symbol">;</span>
<span class="cbracket">}</span>
<span class="preproc">#endif</span>


<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_INFO_IMAGE_SUPPORTED</span><span class="symbol">)</span>
<span class="type">void</span><span class="normal"> PNGAPI</span>
<span class="function">png_write_png</span><span class="symbol">(</span><span class="usertype">png_structp</span><span class="normal"> png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">png_infop</span><span class="normal"> info_ptr</span><span class="symbol">,</span>
<span class="normal">              </span><span class="type">int</span><span class="normal"> transforms</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">voidp</span><span class="normal"> params</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr </span><span class="symbol">==</span><span class="normal"> NULL </span><span class="symbol">||</span><span class="normal"> info_ptr </span><span class="symbol">==</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">      </span><span class="keyword">return</span><span class="symbol">;</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_WRITE_INVERT_ALPHA_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="comment">/* invert the alpha channel from opacity to transparency */</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">transforms </span><span class="symbol">&amp;</span><span class="normal"> PNG_TRANSFORM_INVERT_ALPHA</span><span class="symbol">)</span>
<span class="normal">       </span><span class="function">png_set_invert_alpha</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">);</span>
<span class="preproc">#endif</span>

<span class="normal">   </span><span class="comment">/* Write the file header information. */</span>
<span class="normal">   </span><span class="function">png_write_info</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> info_ptr</span><span class="symbol">);</span>

<span class="normal">   </span><span class="comment">/* ------ these transformations don't touch the info structure ------- */</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_WRITE_INVERT_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="comment">/* invert monochrome pixels */</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">transforms </span><span class="symbol">&amp;</span><span class="normal"> PNG_TRANSFORM_INVERT_MONO</span><span class="symbol">)</span>
<span class="normal">       </span><span class="function">png_set_invert_mono</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">);</span>
<span class="preproc">#endif</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_WRITE_SHIFT_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="comment">/* Shift the pixels up to a legal bit depth and fill in</span>
<span class="comment">    * as appropriate to correctly scale the image.</span>
<span class="comment">    */</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">transforms </span><span class="symbol">&amp;</span><span class="normal"> PNG_TRANSFORM_SHIFT</span><span class="symbol">)</span>
<span class="normal">               </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">info_ptr</span><span class="symbol">-&gt;</span><span class="normal">valid </span><span class="symbol">&amp;</span><span class="normal"> PNG_INFO_sBIT</span><span class="symbol">))</span>
<span class="normal">       </span><span class="function">png_set_shift</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">info_ptr</span><span class="symbol">-&gt;</span><span class="normal">sig_bit</span><span class="symbol">);</span>
<span class="preproc">#endif</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_WRITE_PACK_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="comment">/* pack pixels into bytes */</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">transforms </span><span class="symbol">&amp;</span><span class="normal"> PNG_TRANSFORM_PACKING</span><span class="symbol">)</span>
<span class="normal">       </span><span class="function">png_set_packing</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">);</span>
<span class="preproc">#endif</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_WRITE_SWAP_ALPHA_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="comment">/* swap location of alpha bytes from ARGB to RGBA */</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">transforms </span><span class="symbol">&amp;</span><span class="normal"> PNG_TRANSFORM_SWAP_ALPHA</span><span class="symbol">)</span>
<span class="normal">       </span><span class="function">png_set_swap_alpha</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">);</span>
<span class="preproc">#endif</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_WRITE_FILLER_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="comment">/* Get rid of filler (OR ALPHA) bytes, pack XRGB/RGBX/ARGB/RGBA into</span>
<span class="comment">    * RGB (4 channels -&gt; 3 channels). The second parameter is not used.</span>
<span class="comment">    */</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">transforms </span><span class="symbol">&amp;</span><span class="normal"> PNG_TRANSFORM_STRIP_FILLER</span><span class="symbol">)</span>
<span class="normal">       </span><span class="function">png_set_filler</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> PNG_FILLER_BEFORE</span><span class="symbol">);</span>
<span class="preproc">#endif</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_WRITE_BGR_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="comment">/* flip BGR pixels to RGB */</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">transforms </span><span class="symbol">&amp;</span><span class="normal"> PNG_TRANSFORM_BGR</span><span class="symbol">)</span>
<span class="normal">       </span><span class="function">png_set_bgr</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">);</span>
<span class="preproc">#endif</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_WRITE_SWAP_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="comment">/* swap bytes of 16-bit files to most significant byte first */</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">transforms </span><span class="symbol">&amp;</span><span class="normal"> PNG_TRANSFORM_SWAP_ENDIAN</span><span class="symbol">)</span>
<span class="normal">       </span><span class="function">png_set_swap</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">);</span>
<span class="preproc">#endif</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_WRITE_PACKSWAP_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="comment">/* swap bits of 1, 2, 4 bit packed pixel formats */</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">transforms </span><span class="symbol">&amp;</span><span class="normal"> PNG_TRANSFORM_PACKSWAP</span><span class="symbol">)</span>
<span class="normal">       </span><span class="function">png_set_packswap</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">);</span>
<span class="preproc">#endif</span>

<span class="normal">   </span><span class="comment">/* ----------------------- end of transformations ------------------- */</span>

<span class="normal">   </span><span class="comment">/* write the bits */</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">info_ptr</span><span class="symbol">-&gt;</span><span class="normal">valid </span><span class="symbol">&amp;</span><span class="normal"> PNG_INFO_IDAT</span><span class="symbol">)</span>
<span class="normal">       </span><span class="function">png_write_image</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> info_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_pointers</span><span class="symbol">);</span>

<span class="normal">   </span><span class="comment">/* It is REQUIRED to call this to finish writing the rest of the file */</span>
<span class="normal">   </span><span class="function">png_write_end</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> info_ptr</span><span class="symbol">);</span>

<span class="normal">   </span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">transforms </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> params </span><span class="symbol">==</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">      </span><span class="comment">/* quiet compiler warnings */</span><span class="normal"> </span><span class="keyword">return</span><span class="symbol">;</span>
<span class="cbracket">}</span>
<span class="preproc">#endif</span>
<span class="preproc">#endif</span><span class="normal"> </span><span class="comment">/* PNG_WRITE_SUPPORTED */</span>
</tt></pre></div><div style="text-align: right; padding: 8pt; font-size: 13px"><a href="/xmlfeed/weblog-rss20.xml"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAAAPAgMAAAAOp6AcAAAADFBMVEVmZmb/ZgD///+JjnlbTUWmAAAACXBIWXMAAABIAAAASABGyWs+AAAACXZwQWcAAABQAAAADwCexKkxAAAAWUlEQVQYlWNgwAa0VmGAFQyqoSCQ/x8J/CBFMCt0ZdTU/F/7/+1HEkydFpoKVPn+93sUlUujQvP/7UcRTAuNDJ2a//s/imDqtKVZofm/1qGYSZk7sfodGwAAiobBJtffoNAAAAAASUVORK5CYII=" alt="RSS 2.0 Weblog Feed" width="80" height="15"/></a> <a href="/xmlfeed/weblog-atom10.xml"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAAAPAgMAAAAOp6AcAAAADFBMVEVmZmb/ZgD///+JjnlbTUWmAAAAaklEQVQYlWNgwAa0VmGAFQyqoSCQ/x8J/CBFMDV16rTQ/H/7V//69+//v/3/9oMEI6cuAwr+fv/+/b5d///v//0eJBgWOhMo+Gs9UPAdXDBy6lSYyn9wQZCZS0GCYDPXQcykzJ1Y/Y4NAABKvL80wyoMPgAAAABJRU5ErkJggg==" alt="Atom 1.0 Weblog Feed" width="80" height="15"/></a> <a href="http://validator.w3.org/check?uri=referer"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAAAPCAMAAABEF7i9AAAB1FBMVEUHQIgIRY0MN4QNRYoSRYsXUpIYVJQeUpUhWpgjUJMjWpgmU5QnXJkuYZ0uYpwwV5YyZJ4zaKM3ZaA5aaI6aqM6a6E8ZqA8Z6BAbaRBbqdCbaVHd61KSkpKcaZQUFBUf69UgbBVVVVXfq9Yg7NZhbJZh7RagrNeXVxeh7RfjLdgYGBiiLZmZmZnZ2doirhpkbt0m8F3m8B3ncJ5lb55ocR+ocSDgX+Do8eEpMqGhoaHp8iIpMeJjnmJpseKqMeOqsqPsdCQrcyVlZWVsM2Zs9CZtNCfu9ahoaGhuNShudSivNSjtMWjvNSmpqWnpqSrw9qvxNqyxdmyxdyzsK6zs7Ozx9y0xt21yN22tra4y+K80eK/v7/AwMDExMTEy9DH2ejK2+jM2ujN3uvP0dLR0NDR3uvS3uvS3+zU4u3V1dXY2dnY4u7Y4+3b5e/d3d3d5u/d5/De3t7f39/h4uLj4uHj6/Ll7PXm7fTn7/Xo7/Tp7/bq7Ozr6unr8ffw8PDw9vvx9fny+P7z8/Pz9vnz9vv3+fv4+vz5+vz6+vr6+/36/P36///7+/77/Pz7/f37/f78/Pz8/f38/f79/f39/f79/f/9/v79///+/v7+/v////3///+tYR2LAAABKklEQVQ4y2PQoTJg0JlNVYDPQBsyAMTAqaFes8tdsmdPCtA3MDStr3GKKK6myMAprgJ9pcpWs/MlRExYJBvNZLR0sigycHYOV1S7mtjsQJ4gf+HIFPXoWMs6qIGzIRiKZs9GFoEaMRuZhhrYqqJXy8uZYauRxC/VHew7e3YTPAxnI5swG6JxNrKBNjB1EFmIgV0+HA6C8pqqzhXG7BbJJROQIwViMYQ7G2oDQQNn57JyG7kxiCfObrBmS5+BHMuYLkTzMnYDm5WY4lOZZRPKZocxes+aPbuwCFsYohiICLvZsKBAMrDTQ7K/StveU8icTzrOL8JdLpOyWJ49u8Bx9ozw8DY7UYW03hhdxZAOSg2c3jN79rSJs1vSKmfOnpFXNJmynELlvExlAADnaZpLFGEC2wAAAABJRU5ErkJggg==" alt="Valid XHTML 1.1" width="80" height="15"/></a> <a href="http://jigsaw.w3.org/css-validator/check/referer"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAAAPCAMAAABEF7i9AAAB1FBMVEUHQIgIRY0MN4QNRYoSRYsXUpIYVJQeUpUhWpgjUJMjWpgmU5QnXJkuYZ0uYpwwV5YyZJ4zaKM3ZaA5aaI6aqM6a6E8ZqA8Z6BAbaRBbqdCbaVHd61KSkpKcaZQUFBUf69UgbBVVVVXfq9Yg7NZhbJZh7RagrNeXVxeh7RfjLdgYGBiiLZmZmZnZ2doirhpkbt0m8F3m8B3ncJ5lb55ocR+ocSDgX+Do8eEpMqGhoaHp8iIpMeJjnmJpseKqMeOqsqPsdCQrcyVlZWVsM2Zs9CZtNCfu9ahoaGhuNShudSivNSjtMWjvNSmpqWnpqSrw9qvxNqyxdmyxdyzsK6zs7Ozx9y0xt21yN22tra4y+K80eK/v7/AwMDExMTEy9DH2ejK2+jM2ujN3uvP0dLR0NDR3uvS3uvS3+zU4u3V1dXY2dnY4u7Y4+3b5e/d3d3d5u/d5/De3t7f39/h4uLj4uHj6/Ll7PXm7fTn7/Xo7/Tp7/bq7Ozr6unr8ffw8PDw9vvx9fny+P7z8/Pz9vnz9vv3+fv4+vz5+vz6+vr6+/36/P36///7+/77/Pz7/f37/f78/Pz8/f38/f79/f39/f79/f/9/v79///+/v7+/v////3///+tYR2LAAABEUlEQVQ4y2PQoTJg0JlNVYDPQBsyAMTAqaFes8tdsmdPCtA3MDStr3GKKK6myMAprgJ9pcpWs/MlRExYJBvNZLR0sigycHYOV1S7mtjsQJ4gf+HIFPXoWMs6mIEQCsIjwhKoga0qerW8nBm2Gkn8Ut3BvrNnN8HCcDYM2cBIogzs8uFwEJTXVHWuMGa3SC6ZgIgUqCEwdxJr4OxcVm4jNwbxxNkN1mzpM2ajGIjsPGK9PLtZiSk+lVk2oWx2GKP3rNmzC4tQwpDoIIQb2Okh2V+lbe8pZM4nHecX4S6XSVksz55d4Dh7Rnh4m52oQlpvjK5iSAelBk7vmT172sTZLWmVM2fPyCuaTFlOoXJepjIAANlljDGY/l5pAAAAAElFTkSuQmCC" alt="Valid CSS (2.1)" width="80" height="15"/></a><br/>Copyright 2005-2019 <a href="/about/">Timo Bingmann</a> - <a href="/about/impressum.html">Impressum</a></div></body></html>