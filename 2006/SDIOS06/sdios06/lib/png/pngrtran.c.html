<?xml version="1.0" encoding="iso-8859-1"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta content="text/html; charset=iso-8859-1" http-equiv="content-type" /><meta name="viewport" content="initial-scale=1"><title>/2006/SDIOS06/sdios06/lib/png/pngrtran.c - panthema.net</title><link rel="stylesheet" type="text/css" href="/css/base.css" /><link rel="stylesheet" type="text/css" href="/css/fonts.css" /><link rel="alternate" type="application/rss+xml" title="panthema.net Weblog Feed RSS 2.0" href="http://panthema.net/xmlfeed/weblog-rss20.xml" /><link rel="alternate" type="application/atom+xml" title="panthema.net Weblog Feed Atom 1.0" href="http://panthema.net/xmlfeed/weblog-atom10.xml" /><script type="text/javascript" src="/js/base.js"></script><script type="text/javascript">/* <!-- */makeIEHover = function() {var lis = document.getElementById('ptnav').getElementsByTagName('li');for (var i = 0; i < lis.length; i++) {lis[i].onmouseover = function() {this.className += ' sfhover';};lis[i].onmouseout = function() {this.className = this.className.replace(new RegExp(' sfhover\b'), '');};}};if (window.attachEvent) window.attachEvent('onload', makeIEHover);/* --> */</script></head><body style="background-image: url(/img/bgfractal7.jpg)" lang="en"><div class="pttopbar"><div style="float: right"><ul id="ptnav"><li class="top"><a class="ni" href="/"><i class="icon-book"></i> Weblog</a><ul style="margin-left: -6px; margin-top: 4px" class="nx"><li><a href="/2020/">2020</a></li><li><a href="/2019/">2019</a></li><li><a href="/2018/">2018</a></li><li><a href="/2017/">2017</a></li><li><a href="/2016/">2016</a></li><li><a href="/2015/">2015</a></li><li><a href="/2014/">2014</a></li><li><a href="/2013/">2013</a></li><li><a href="/2012/">2012</a></li><li><a href="/2011/">2011</a></li><li><a href="/2010/">2010</a></li><li><a href="/2009/">2009</a></li><li><a href="/2008/">2008</a></li><li><a href="/2007/">2007</a></li><li><a href="/2006/">2006</a></li><li class="nt"><a href="/2005/">2005</a></li><li class="ns"><a href="/xmlfeed/weblog-rss20.xml">RSS Feed</a></li><li class="nt"><a href="/xmlfeed/weblog-atom10.xml">XML Atom</a></li><li class="ns"><a href="/search.html">Search</a></li></ul></li><li class="top"><a class="ni" href="/tags/"><i class="icon-tags"></i> Tags</a><div style="width: 14em; margin-left: -9em; margin-top: 4px"><a style="font-size: 10pt" href="/tags/algebra.html">algebra</a> <a style="font-size: 10pt" href="/tags/blinken-algorithms.html">blinken-algorithms</a> <a style="font-size: 16pt" href="/tags/c++.html">c++</a> <a style="font-size: 12pt" href="/tags/code-example.html">code-example</a> <a style="font-size: 14pt" href="/tags/code-snippet.html">code-snippet</a> <a style="font-size: 11pt" href="/tags/coding_tricks.html">coding tricks</a> <a style="font-size: 10pt" href="/tags/compsci.html">compsci</a> <a style="font-size: 10pt" href="/tags/compsci_study_thesis.html">compsci study thesis</a> <a style="font-size: 9pt" href="/tags/crypto-speedtest.html">crypto-speedtest</a> <a style="font-size: 10pt" href="/tags/cryptography.html">cryptography</a> <a style="font-size: 9pt" href="/tags/cryptote.html">cryptote</a> <a style="font-size: 11pt" href="/tags/dissertation.html">dissertation</a> <a style="font-size: 10pt" href="/tags/electronics.html">electronics</a> <a style="font-size: 12pt" href="/tags/flex-bison-cpp-example.html">flex-bison-cpp-example</a> <a style="font-size: 16pt" href="/tags/frontpage.html">frontpage</a> <a style="font-size: 15pt" href="/tags/fun.html">fun</a> <a style="font-size: 10pt" href="/tags/graphviz.html">graphviz</a> <a style="font-size: 9pt" href="http://www.hmtg.de">hartmetall</a> <a style="font-size: 9pt" href="/tags/helppc.html">helppc</a> <a style="font-size: 9pt" href="/tags/hifi_selbstbau.html">hifi selbstbau</a> <a style="font-size: 10pt" href="/tags/latex.html">latex</a> <a style="font-size: 10pt" href="/tags/LEDs.html">LEDs</a> <a style="font-size: 10pt" href="/tags/librivox.html">librivox</a> <a style="font-size: 10pt" href="/tags/linux.html">linux</a> <a style="font-size: 9pt" href="/tags/market.html">market</a> <a style="font-size: 9pt" href="/tags/massive-sorting.html">massive-sorting</a> <a style="font-size: 11pt" href="/tags/maths.html">maths</a> <a style="font-size: 9pt" href="/tags/music.html">music</a> <a style="font-size: 10pt" href="/tags/netfundamentals.html">netfundamentals</a> <a style="font-size: 11pt" href="/tags/ns-3.html">ns-3</a> <a style="font-size: 10pt" href="/tags/parallel-string-sorting.html">parallel-string-sorting</a> <a style="font-size: 14pt" href="/tags/parsing.html">parsing</a> <a style="font-size: 9pt" href="/tags/qtsqlview.html">qtsqlview</a> <a style="font-size: 14pt" href="/tags/research.html">research</a> <a style="font-size: 11pt" href="/tags/sdios06.html">sdios06</a> <a style="font-size: 9pt" href="/tags/sdlfractal.html">sdlfractal</a> <a style="font-size: 16pt" href="/tags/sorting.html">sorting</a> <a style="font-size: 13pt" href="/tags/sound_of_sorting.html">sound of sorting</a> <a style="font-size: 10pt" href="/tags/stringology.html">stringology</a> <a style="font-size: 16pt" href="/tags/stx-btree.html">stx-btree</a> <a style="font-size: 16pt" href="/tags/stxxl.html">stxxl</a> <a style="font-size: 16pt" href="/tags/talk.html">talk</a> <a style="font-size: 15pt" href="/tags/thrill.html">thrill</a> <a style="font-size: 10pt" href="/tags/tutorium.html">tutorium</a> <a style="font-size: 16pt" href="/tags/university.html">university</a> <a style="font-size: 14pt" href="/tags/utilities.html">utilities</a> <a style="font-size: 10pt" href="/tags/vncrec.html">vncrec</a> <a style="font-size: 9pt" href="/tags/webdesign.html">webdesign</a> </div></li><li class="top"> <a class="ni" href="#"><i class="icon-cubes"></i> Projects</a> <ul style="margin-left: -8em; margin-top: 4px;" class="nx"> <li><a href="/2019/1008-COBS-A-Compact-Bit-Sliced-Signature-Index/">COBS</a></li> <li><a href="/2009/cryptote/">CryptoTE</a></li> <li><a href="/2009/digup/">digup</a></li> <li><a href="/2013/disk-filltest/">disk-filltest</a></li> <li><a href="/2012/1119-eSAIS-Inducing-Suffix-and-LCP-Arrays-in-External-Memory/">eSAIS-LCP</a></li> <li><a href="/2007/flex-bison-cpp-example/">Flex Bison C++ Example</a></li> <li><a href="/2013/malloc_count/">malloc_count</a></li> <li><a href="/2016/0114-diploma-thesis/">On Bispanning Graphs</a></li> <li><a href="/2013/pmbw/">Parallel Memory Bandwidth</a></li> <li><a href="/2013/parallel-string-sorting/">Parallel String Sorting</a></li> <li><a href="/2014/sqlplot-tools/">SqlPlotTools</a></li> <li><a href="/2013/sound-of-sorting/">The Sound of Sorting</a></li> <li><a href="/2007/stx-btree/">STX B+ Tree</a></li> <li><a href="/2010/stx-cbtreedb/">STX Constant BTreeDB</a></li> <li><a href="/2010/stx-execpipe/">STX ExecPipe</a></li> <li><a href="/2007/stx-exparser/">STX Expression Parser</a></li> <li><a href="/tags/stxxl.html">STXXL 1.4</a></li> <li><a href="/tags/thrill.html">Thrill - Big Data Framework</a></li> <li class="nt"><a href="/2014/vncrec-rgb/">VNCrec RGB 0.4</a></li> <li class="ns"><a href="/search.html">Search</a></li> </ul></li><li class="top"> <a class="ni" href="/publications.html"><i class="icon-graduation-cap"></i> Publications</a></li><li class="top"> <a class="ni" href="/search.html"><i class="icon-search"></i> Search</a></li><li class="top"> <a class="ni" href="/subscribe.html"><i class="icon-rss-squared"></i> Subscribe</a></li><li class="top"> <a class="ni" href="/about/"><i class="icon-info-circled"></i> About</a> <ul style="margin-left: -6em; margin-top: 4px" class="nx"> <li><a href="/about/">Timo Bingmann</a></li> <li><a href="/about/impressum.html">Impressum</a></li> </ul></li></ul></div><div style="padding: 6px"><a href="/">panthema</a>  / <a href="/2006/">2006</a> / <a href="/2006/SDIOS06/">SDIOS06</a> / <a href="/2006/SDIOS06/sdios06/">sdios06</a> / <a href="/2006/SDIOS06/sdios06/lib/">lib</a> / <a href="/2006/SDIOS06/sdios06/lib/png/">png</a> / <a href="/2006/SDIOS06/sdios06/lib/png/pngrtran.c.html">pngrtran.c</a> (<a href="/2006/SDIOS06/sdios06/lib/png/pngrtran.c">Download File</a>)</div></div><div class="ptfullwidth"><pre class="codesnippet" style="font-family: monospace"><tt>
<span class="comment">/* pngrtran.c - transforms the data in a row for PNG readers</span>
<span class="comment"> *</span>
<span class="comment"> * Last changed in libpng 1.2.11 June 15, 2006</span>
<span class="comment"> * For conditions of distribution and use, see copyright notice in png.h</span>
<span class="comment"> * Copyright (c) 1998-2006 Glenn Randers-Pehrson</span>
<span class="comment"> * (Version 0.96 Copyright (c) 1996, 1997 Andreas Dilger)</span>
<span class="comment"> * (Version 0.88 Copyright (c) 1995, 1996 Guy Eric Schalnat, Group 42, Inc.)</span>
<span class="comment"> *</span>
<span class="comment"> * This file contains functions optionally called by an application</span>
<span class="comment"> * in order to tell libpng how to handle data when reading a PNG.</span>
<span class="comment"> * Transformations that are used in both reading and writing are</span>
<span class="comment"> * in pngtrans.c.</span>
<span class="comment"> */</span>

<span class="preproc">#define</span><span class="normal"> PNG_INTERNAL</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">"png.h"</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_SUPPORTED</span><span class="symbol">)</span>

<span class="comment">/* Set the action on getting a CRC error for an ancillary or critical chunk. */</span>
<span class="type">void</span><span class="normal"> PNGAPI</span>
<span class="function">png_set_crc_action</span><span class="symbol">(</span><span class="usertype">png_structp</span><span class="normal"> png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> crit_action</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> ancil_action</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">   </span><span class="function">png_debug</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"in png_set_crc_action</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">   </span><span class="comment">/* Tell libpng how we react to CRC errors in critical chunks */</span>
<span class="normal">   </span><span class="keyword">switch</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">crit_action</span><span class="symbol">)</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="keyword">case</span><span class="normal"> PNG_CRC_NO_CHANGE</span><span class="symbol">:</span><span class="normal">                        </span><span class="comment">/* leave setting as is */</span>
<span class="normal">         </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">      </span><span class="keyword">case</span><span class="normal"> PNG_CRC_WARN_USE</span><span class="symbol">:</span><span class="normal">                               </span><span class="comment">/* warn/use data */</span>
<span class="normal">         png_ptr</span><span class="symbol">-&gt;</span><span class="normal">flags </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="symbol">~</span><span class="normal">PNG_FLAG_CRC_CRITICAL_MASK</span><span class="symbol">;</span>
<span class="normal">         png_ptr</span><span class="symbol">-&gt;</span><span class="normal">flags </span><span class="symbol">|=</span><span class="normal"> PNG_FLAG_CRC_CRITICAL_USE</span><span class="symbol">;</span>
<span class="normal">         </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">      </span><span class="keyword">case</span><span class="normal"> PNG_CRC_QUIET_USE</span><span class="symbol">:</span><span class="normal">                             </span><span class="comment">/* quiet/use data */</span>
<span class="normal">         png_ptr</span><span class="symbol">-&gt;</span><span class="normal">flags </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="symbol">~</span><span class="normal">PNG_FLAG_CRC_CRITICAL_MASK</span><span class="symbol">;</span>
<span class="normal">         png_ptr</span><span class="symbol">-&gt;</span><span class="normal">flags </span><span class="symbol">|=</span><span class="normal"> PNG_FLAG_CRC_CRITICAL_USE </span><span class="symbol">|</span>
<span class="normal">                           PNG_FLAG_CRC_CRITICAL_IGNORE</span><span class="symbol">;</span>
<span class="normal">         </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">      </span><span class="keyword">case</span><span class="normal"> PNG_CRC_WARN_DISCARD</span><span class="symbol">:</span><span class="normal">    </span><span class="comment">/* not a valid action for critical data */</span>
<span class="normal">         </span><span class="function">png_warning</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"Can't discard critical data on CRC error."</span><span class="symbol">);</span>
<span class="normal">      </span><span class="keyword">case</span><span class="normal"> PNG_CRC_ERROR_QUIT</span><span class="symbol">:</span><span class="normal">                                </span><span class="comment">/* error/quit */</span>
<span class="normal">      </span><span class="keyword">case</span><span class="normal"> PNG_CRC_DEFAULT</span><span class="symbol">:</span>
<span class="label">      default:</span>
<span class="normal">         png_ptr</span><span class="symbol">-&gt;</span><span class="normal">flags </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="symbol">~</span><span class="normal">PNG_FLAG_CRC_CRITICAL_MASK</span><span class="symbol">;</span>
<span class="normal">         </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">   </span><span class="cbracket">}</span>

<span class="normal">   </span><span class="keyword">switch</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ancil_action</span><span class="symbol">)</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="keyword">case</span><span class="normal"> PNG_CRC_NO_CHANGE</span><span class="symbol">:</span><span class="normal">                       </span><span class="comment">/* leave setting as is */</span>
<span class="normal">         </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">      </span><span class="keyword">case</span><span class="normal"> PNG_CRC_WARN_USE</span><span class="symbol">:</span><span class="normal">                              </span><span class="comment">/* warn/use data */</span>
<span class="normal">         png_ptr</span><span class="symbol">-&gt;</span><span class="normal">flags </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="symbol">~</span><span class="normal">PNG_FLAG_CRC_ANCILLARY_MASK</span><span class="symbol">;</span>
<span class="normal">         png_ptr</span><span class="symbol">-&gt;</span><span class="normal">flags </span><span class="symbol">|=</span><span class="normal"> PNG_FLAG_CRC_ANCILLARY_USE</span><span class="symbol">;</span>
<span class="normal">         </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">      </span><span class="keyword">case</span><span class="normal"> PNG_CRC_QUIET_USE</span><span class="symbol">:</span><span class="normal">                            </span><span class="comment">/* quiet/use data */</span>
<span class="normal">         png_ptr</span><span class="symbol">-&gt;</span><span class="normal">flags </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="symbol">~</span><span class="normal">PNG_FLAG_CRC_ANCILLARY_MASK</span><span class="symbol">;</span>
<span class="normal">         png_ptr</span><span class="symbol">-&gt;</span><span class="normal">flags </span><span class="symbol">|=</span><span class="normal"> PNG_FLAG_CRC_ANCILLARY_USE </span><span class="symbol">|</span>
<span class="normal">                           PNG_FLAG_CRC_ANCILLARY_NOWARN</span><span class="symbol">;</span>
<span class="normal">         </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">      </span><span class="keyword">case</span><span class="normal"> PNG_CRC_ERROR_QUIT</span><span class="symbol">:</span><span class="normal">                               </span><span class="comment">/* error/quit */</span>
<span class="normal">         png_ptr</span><span class="symbol">-&gt;</span><span class="normal">flags </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="symbol">~</span><span class="normal">PNG_FLAG_CRC_ANCILLARY_MASK</span><span class="symbol">;</span>
<span class="normal">         png_ptr</span><span class="symbol">-&gt;</span><span class="normal">flags </span><span class="symbol">|=</span><span class="normal"> PNG_FLAG_CRC_ANCILLARY_NOWARN</span><span class="symbol">;</span>
<span class="normal">         </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">      </span><span class="keyword">case</span><span class="normal"> PNG_CRC_WARN_DISCARD</span><span class="symbol">:</span><span class="normal">                      </span><span class="comment">/* warn/discard data */</span>
<span class="normal">      </span><span class="keyword">case</span><span class="normal"> PNG_CRC_DEFAULT</span><span class="symbol">:</span>
<span class="label">      default:</span>
<span class="normal">         png_ptr</span><span class="symbol">-&gt;</span><span class="normal">flags </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="symbol">~</span><span class="normal">PNG_FLAG_CRC_ANCILLARY_MASK</span><span class="symbol">;</span>
<span class="normal">         </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">   </span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_BACKGROUND_SUPPORTED</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">    </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_FLOATING_POINT_SUPPORTED</span><span class="symbol">)</span>
<span class="comment">/* handle alpha and tRNS via a background color */</span>
<span class="type">void</span><span class="normal"> PNGAPI</span>
<span class="function">png_set_background</span><span class="symbol">(</span><span class="usertype">png_structp</span><span class="normal"> png_ptr</span><span class="symbol">,</span>
<span class="normal">   </span><span class="usertype">png_color_16p</span><span class="normal"> background_color</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> background_gamma_code</span><span class="symbol">,</span>
<span class="normal">   </span><span class="type">int</span><span class="normal"> need_expand</span><span class="symbol">,</span><span class="normal"> </span><span class="type">double</span><span class="normal"> background_gamma</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">   </span><span class="function">png_debug</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"in png_set_background</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">background_gamma_code </span><span class="symbol">==</span><span class="normal"> PNG_BACKGROUND_GAMMA_UNKNOWN</span><span class="symbol">)</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="function">png_warning</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"Application must supply a known background gamma"</span><span class="symbol">);</span>
<span class="normal">      </span><span class="keyword">return</span><span class="symbol">;</span>
<span class="normal">   </span><span class="cbracket">}</span>

<span class="normal">   png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">|=</span><span class="normal"> PNG_BACKGROUND</span><span class="symbol">;</span>
<span class="normal">   </span><span class="function">png_memcpy</span><span class="symbol">(&amp;(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">),</span><span class="normal"> background_color</span><span class="symbol">,</span>
<span class="normal">      </span><span class="function">png_sizeof</span><span class="symbol">(</span><span class="normal">png_color_16</span><span class="symbol">));</span>
<span class="normal">   png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background_gamma </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="type">float</span><span class="symbol">)</span><span class="normal">background_gamma</span><span class="symbol">;</span>
<span class="normal">   png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background_gamma_type </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">background_gamma_code</span><span class="symbol">);</span>
<span class="normal">   png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">|=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">need_expand </span><span class="symbol">?</span><span class="normal"> PNG_BACKGROUND_EXPAND </span><span class="symbol">:</span><span class="normal"> </span><span class="number">0</span><span class="symbol">);</span>

<span class="normal">   </span><span class="comment">/* Note:  if need_expand is set and color_type is either RGB or RGB_ALPHA</span>
<span class="comment">    * (in which case need_expand is superfluous anyway), the background color</span>
<span class="comment">    * might actually be gray yet not be flagged as such. This is not a problem</span>
<span class="comment">    * for the current code, which uses PNG_BACKGROUND_IS_GRAY only to</span>
<span class="comment">    * decide when to do the png_do_gray_to_rgb() transformation.</span>
<span class="comment">    */</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">need_expand </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">!(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">color_type </span><span class="symbol">&amp;</span><span class="normal"> PNG_COLOR_MASK_COLOR</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">||</span>
<span class="normal">       </span><span class="symbol">(!</span><span class="normal">need_expand </span><span class="symbol">&amp;&amp;</span><span class="normal"> background_color</span><span class="symbol">-&gt;</span><span class="normal">red </span><span class="symbol">==</span><span class="normal"> background_color</span><span class="symbol">-&gt;</span><span class="normal">green </span><span class="symbol">&amp;&amp;</span>
<span class="normal">        background_color</span><span class="symbol">-&gt;</span><span class="normal">red </span><span class="symbol">==</span><span class="normal"> background_color</span><span class="symbol">-&gt;</span><span class="normal">blue</span><span class="symbol">))</span>
<span class="normal">      png_ptr</span><span class="symbol">-&gt;</span><span class="normal">mode </span><span class="symbol">|=</span><span class="normal"> PNG_BACKGROUND_IS_GRAY</span><span class="symbol">;</span>
<span class="cbracket">}</span>
<span class="preproc">#endif</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_16_TO_8_SUPPORTED</span><span class="symbol">)</span>
<span class="comment">/* strip 16 bit depth files to 8 bit depth */</span>
<span class="type">void</span><span class="normal"> PNGAPI</span>
<span class="function">png_set_strip_16</span><span class="symbol">(</span><span class="usertype">png_structp</span><span class="normal"> png_ptr</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">   </span><span class="function">png_debug</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"in png_set_strip_16</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">   png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">|=</span><span class="normal"> PNG_16_TO_8</span><span class="symbol">;</span>
<span class="cbracket">}</span>
<span class="preproc">#endif</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_STRIP_ALPHA_SUPPORTED</span><span class="symbol">)</span>
<span class="type">void</span><span class="normal"> PNGAPI</span>
<span class="function">png_set_strip_alpha</span><span class="symbol">(</span><span class="usertype">png_structp</span><span class="normal"> png_ptr</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">   </span><span class="function">png_debug</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"in png_set_strip_alpha</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">   png_ptr</span><span class="symbol">-&gt;</span><span class="normal">flags </span><span class="symbol">|=</span><span class="normal"> PNG_FLAG_STRIP_ALPHA</span><span class="symbol">;</span>
<span class="cbracket">}</span>
<span class="preproc">#endif</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_DITHER_SUPPORTED</span><span class="symbol">)</span>
<span class="comment">/* Dither file to 8 bit.  Supply a palette, the current number</span>
<span class="comment"> * of elements in the palette, the maximum number of elements</span>
<span class="comment"> * allowed, and a histogram if possible.  If the current number</span>
<span class="comment"> * of colors is greater then the maximum number, the palette will be</span>
<span class="comment"> * modified to fit in the maximum number.  "full_dither" indicates</span>
<span class="comment"> * whether we need a dithering cube set up for RGB images, or if we</span>
<span class="comment"> * simply are reducing the number of colors in a paletted image.</span>
<span class="comment"> */</span>

<span class="keyword">typedef</span><span class="normal"> </span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">png_dsort_struct</span>
<span class="cbracket">{</span>
<span class="normal">   </span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">png_dsort_struct</span><span class="normal"> FAR </span><span class="symbol">*</span><span class="normal"> next</span><span class="symbol">;</span>
<span class="normal">   </span><span class="usertype">png_byte</span><span class="normal"> left</span><span class="symbol">;</span>
<span class="normal">   </span><span class="usertype">png_byte</span><span class="normal"> right</span><span class="symbol">;</span>
<span class="cbracket">}</span><span class="normal"> png_dsort</span><span class="symbol">;</span>
<span class="keyword">typedef</span><span class="normal"> </span><span class="usertype">png_dsort</span><span class="normal"> FAR </span><span class="symbol">*</span><span class="normal">       png_dsortp</span><span class="symbol">;</span>
<span class="keyword">typedef</span><span class="normal"> </span><span class="usertype">png_dsort</span><span class="normal"> FAR </span><span class="symbol">*</span><span class="normal"> FAR </span><span class="symbol">*</span><span class="normal"> png_dsortpp</span><span class="symbol">;</span>

<span class="type">void</span><span class="normal"> PNGAPI</span>
<span class="function">png_set_dither</span><span class="symbol">(</span><span class="usertype">png_structp</span><span class="normal"> png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">png_colorp</span><span class="normal"> palette</span><span class="symbol">,</span>
<span class="normal">   </span><span class="type">int</span><span class="normal"> num_palette</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> maximum_colors</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">png_uint_16p</span><span class="normal"> histogram</span><span class="symbol">,</span>
<span class="normal">   </span><span class="type">int</span><span class="normal"> full_dither</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">   </span><span class="function">png_debug</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"in png_set_dither</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">   png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">|=</span><span class="normal"> PNG_DITHER</span><span class="symbol">;</span>

<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">full_dither</span><span class="symbol">)</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="type">int</span><span class="normal"> i</span><span class="symbol">;</span>

<span class="normal">      png_ptr</span><span class="symbol">-&gt;</span><span class="normal">dither_index </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_bytep</span><span class="symbol">)</span><span class="function">png_malloc</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span>
<span class="normal">         </span><span class="symbol">(</span><span class="normal">png_uint_32</span><span class="symbol">)(</span><span class="normal">num_palette </span><span class="symbol">*</span><span class="normal"> </span><span class="function">png_sizeof</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)));</span>
<span class="normal">      </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> num_palette</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">         png_ptr</span><span class="symbol">-&gt;</span><span class="normal">dither_index</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)</span><span class="normal">i</span><span class="symbol">;</span>
<span class="normal">   </span><span class="cbracket">}</span>

<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">num_palette </span><span class="symbol">&gt;</span><span class="normal"> maximum_colors</span><span class="symbol">)</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">histogram </span><span class="symbol">!=</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         </span><span class="comment">/* This is easy enough, just throw out the least used colors.</span>
<span class="comment">            Perhaps not the best solution, but good enough. */</span>

<span class="normal">         </span><span class="type">int</span><span class="normal"> i</span><span class="symbol">;</span>

<span class="normal">         </span><span class="comment">/* initialize an array to sort colors */</span>
<span class="normal">         png_ptr</span><span class="symbol">-&gt;</span><span class="normal">dither_sort </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_bytep</span><span class="symbol">)</span><span class="function">png_malloc</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span>
<span class="normal">            </span><span class="symbol">(</span><span class="normal">png_uint_32</span><span class="symbol">)(</span><span class="normal">num_palette </span><span class="symbol">*</span><span class="normal"> </span><span class="function">png_sizeof</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)));</span>

<span class="normal">         </span><span class="comment">/* initialize the dither_sort array */</span>
<span class="normal">         </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> num_palette</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">            png_ptr</span><span class="symbol">-&gt;</span><span class="normal">dither_sort</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)</span><span class="normal">i</span><span class="symbol">;</span>

<span class="normal">         </span><span class="comment">/* Find the least used palette entries by starting a</span>
<span class="comment">            bubble sort, and running it until we have sorted</span>
<span class="comment">            out enough colors.  Note that we don't care about</span>
<span class="comment">            sorting all the colors, just finding which are</span>
<span class="comment">            least used. */</span>

<span class="normal">         </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> num_palette </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&gt;=</span><span class="normal"> maximum_colors</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">--)</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="type">int</span><span class="normal"> done</span><span class="symbol">;</span><span class="normal"> </span><span class="comment">/* to stop early if the list is pre-sorted */</span>
<span class="normal">            </span><span class="type">int</span><span class="normal"> j</span><span class="symbol">;</span>

<span class="normal">            done </span><span class="symbol">=</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">            </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">j </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> j </span><span class="symbol">&lt;</span><span class="normal"> i</span><span class="symbol">;</span><span class="normal"> j</span><span class="symbol">++)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">histogram</span><span class="symbol">[</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">dither_sort</span><span class="symbol">[</span><span class="normal">j</span><span class="symbol">]]</span>
<span class="normal">                   </span><span class="symbol">&lt;</span><span class="normal"> histogram</span><span class="symbol">[</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">dither_sort</span><span class="symbol">[</span><span class="normal">j </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">]])</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  </span><span class="usertype">png_byte</span><span class="normal"> t</span><span class="symbol">;</span>

<span class="normal">                  t </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">dither_sort</span><span class="symbol">[</span><span class="normal">j</span><span class="symbol">];</span>
<span class="normal">                  png_ptr</span><span class="symbol">-&gt;</span><span class="normal">dither_sort</span><span class="symbol">[</span><span class="normal">j</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">dither_sort</span><span class="symbol">[</span><span class="normal">j </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">];</span>
<span class="normal">                  png_ptr</span><span class="symbol">-&gt;</span><span class="normal">dither_sort</span><span class="symbol">[</span><span class="normal">j </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> t</span><span class="symbol">;</span>
<span class="normal">                  done </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">done</span><span class="symbol">)</span>
<span class="normal">               </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">         </span><span class="cbracket">}</span>

<span class="normal">         </span><span class="comment">/* swap the palette around, and set up a table, if necessary */</span>
<span class="normal">         </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">full_dither</span><span class="symbol">)</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="type">int</span><span class="normal"> j </span><span class="symbol">=</span><span class="normal"> num_palette</span><span class="symbol">;</span>

<span class="normal">            </span><span class="comment">/* put all the useful colors within the max, but don't</span>
<span class="comment">               move the others */</span>
<span class="normal">            </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> maximum_colors</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="type">int</span><span class="symbol">)</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">dither_sort</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">&gt;=</span><span class="normal"> maximum_colors</span><span class="symbol">)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  </span><span class="keyword">do</span>
<span class="normal">                     j</span><span class="symbol">--;</span>
<span class="normal">                  </span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">((</span><span class="type">int</span><span class="symbol">)</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">dither_sort</span><span class="symbol">[</span><span class="normal">j</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">&gt;=</span><span class="normal"> maximum_colors</span><span class="symbol">);</span>
<span class="normal">                  palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> palette</span><span class="symbol">[</span><span class="normal">j</span><span class="symbol">];</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">         </span><span class="keyword">else</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="type">int</span><span class="normal"> j </span><span class="symbol">=</span><span class="normal"> num_palette</span><span class="symbol">;</span>

<span class="normal">            </span><span class="comment">/* move all the used colors inside the max limit, and</span>
<span class="comment">               develop a translation table */</span>
<span class="normal">            </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> maximum_colors</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="comment">/* only move the colors we need to */</span>
<span class="normal">               </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="type">int</span><span class="symbol">)</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">dither_sort</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">&gt;=</span><span class="normal"> maximum_colors</span><span class="symbol">)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  </span><span class="usertype">png_color</span><span class="normal"> tmp_color</span><span class="symbol">;</span>

<span class="normal">                  </span><span class="keyword">do</span>
<span class="normal">                     j</span><span class="symbol">--;</span>
<span class="normal">                  </span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">((</span><span class="type">int</span><span class="symbol">)</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">dither_sort</span><span class="symbol">[</span><span class="normal">j</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">&gt;=</span><span class="normal"> maximum_colors</span><span class="symbol">);</span>

<span class="normal">                  tmp_color </span><span class="symbol">=</span><span class="normal"> palette</span><span class="symbol">[</span><span class="normal">j</span><span class="symbol">];</span>
<span class="normal">                  palette</span><span class="symbol">[</span><span class="normal">j</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">];</span>
<span class="normal">                  palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> tmp_color</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="comment">/* indicate where the color went */</span>
<span class="normal">                  png_ptr</span><span class="symbol">-&gt;</span><span class="normal">dither_index</span><span class="symbol">[</span><span class="normal">j</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)</span><span class="normal">i</span><span class="symbol">;</span>
<span class="normal">                  png_ptr</span><span class="symbol">-&gt;</span><span class="normal">dither_index</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)</span><span class="normal">j</span><span class="symbol">;</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="cbracket">}</span>

<span class="normal">            </span><span class="comment">/* find closest color for those colors we are not using */</span>
<span class="normal">            </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> num_palette</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="type">int</span><span class="symbol">)</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">dither_index</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">&gt;=</span><span class="normal"> maximum_colors</span><span class="symbol">)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  </span><span class="type">int</span><span class="normal"> min_d</span><span class="symbol">,</span><span class="normal"> k</span><span class="symbol">,</span><span class="normal"> min_k</span><span class="symbol">,</span><span class="normal"> d_index</span><span class="symbol">;</span>

<span class="normal">                  </span><span class="comment">/* find the closest color to one we threw out */</span>
<span class="normal">                  d_index </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">dither_index</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">];</span>
<span class="normal">                  min_d </span><span class="symbol">=</span><span class="normal"> </span><span class="function">PNG_COLOR_DIST</span><span class="symbol">(</span><span class="normal">palette</span><span class="symbol">[</span><span class="normal">d_index</span><span class="symbol">],</span><span class="normal"> palette</span><span class="symbol">[</span><span class="number">0</span><span class="symbol">]);</span>
<span class="normal">                  </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">k </span><span class="symbol">=</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span><span class="normal"> min_k </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> k </span><span class="symbol">&lt;</span><span class="normal"> maximum_colors</span><span class="symbol">;</span><span class="normal"> k</span><span class="symbol">++)</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     </span><span class="type">int</span><span class="normal"> d</span><span class="symbol">;</span>

<span class="normal">                     d </span><span class="symbol">=</span><span class="normal"> </span><span class="function">PNG_COLOR_DIST</span><span class="symbol">(</span><span class="normal">palette</span><span class="symbol">[</span><span class="normal">d_index</span><span class="symbol">],</span><span class="normal"> palette</span><span class="symbol">[</span><span class="normal">k</span><span class="symbol">]);</span>

<span class="normal">                     </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">d </span><span class="symbol">&lt;</span><span class="normal"> min_d</span><span class="symbol">)</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        min_d </span><span class="symbol">=</span><span class="normal"> d</span><span class="symbol">;</span>
<span class="normal">                        min_k </span><span class="symbol">=</span><span class="normal"> k</span><span class="symbol">;</span>
<span class="normal">                     </span><span class="cbracket">}</span>
<span class="normal">                  </span><span class="cbracket">}</span>
<span class="normal">                  </span><span class="comment">/* point to closest color */</span>
<span class="normal">                  png_ptr</span><span class="symbol">-&gt;</span><span class="normal">dither_index</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)</span><span class="normal">min_k</span><span class="symbol">;</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">         </span><span class="function">png_free</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">dither_sort</span><span class="symbol">);</span>
<span class="normal">         png_ptr</span><span class="symbol">-&gt;</span><span class="normal">dither_sort</span><span class="symbol">=</span><span class="normal">NULL</span><span class="symbol">;</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="keyword">else</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         </span><span class="comment">/* This is much harder to do simply (and quickly).  Perhaps</span>
<span class="comment">            we need to go through a median cut routine, but those</span>
<span class="comment">            don't always behave themselves with only a few colors</span>
<span class="comment">            as input.  So we will just find the closest two colors,</span>
<span class="comment">            and throw out one of them (chosen somewhat randomly).</span>
<span class="comment">            [We don't understand this at all, so if someone wants to</span>
<span class="comment">             work on improving it, be our guest - AED, GRP]</span>
<span class="comment">            */</span>
<span class="normal">         </span><span class="type">int</span><span class="normal"> i</span><span class="symbol">;</span>
<span class="normal">         </span><span class="type">int</span><span class="normal"> max_d</span><span class="symbol">;</span>
<span class="normal">         </span><span class="type">int</span><span class="normal"> num_new_palette</span><span class="symbol">;</span>
<span class="normal">         </span><span class="usertype">png_dsortp</span><span class="normal"> t</span><span class="symbol">;</span>
<span class="normal">         </span><span class="usertype">png_dsortpp</span><span class="normal"> hash</span><span class="symbol">;</span>

<span class="normal">         t</span><span class="symbol">=</span><span class="normal">NULL</span><span class="symbol">;</span>

<span class="normal">         </span><span class="comment">/* initialize palette index arrays */</span>
<span class="normal">         png_ptr</span><span class="symbol">-&gt;</span><span class="normal">index_to_palette </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_bytep</span><span class="symbol">)</span><span class="function">png_malloc</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span>
<span class="normal">            </span><span class="symbol">(</span><span class="normal">png_uint_32</span><span class="symbol">)(</span><span class="normal">num_palette </span><span class="symbol">*</span><span class="normal"> </span><span class="function">png_sizeof</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)));</span>
<span class="normal">         png_ptr</span><span class="symbol">-&gt;</span><span class="normal">palette_to_index </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_bytep</span><span class="symbol">)</span><span class="function">png_malloc</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span>
<span class="normal">            </span><span class="symbol">(</span><span class="normal">png_uint_32</span><span class="symbol">)(</span><span class="normal">num_palette </span><span class="symbol">*</span><span class="normal"> </span><span class="function">png_sizeof</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)));</span>

<span class="normal">         </span><span class="comment">/* initialize the sort array */</span>
<span class="normal">         </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> num_palette</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            png_ptr</span><span class="symbol">-&gt;</span><span class="normal">index_to_palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)</span><span class="normal">i</span><span class="symbol">;</span>
<span class="normal">            png_ptr</span><span class="symbol">-&gt;</span><span class="normal">palette_to_index</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)</span><span class="normal">i</span><span class="symbol">;</span>
<span class="normal">         </span><span class="cbracket">}</span>

<span class="normal">         hash </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_dsortpp</span><span class="symbol">)</span><span class="function">png_malloc</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_32</span><span class="symbol">)(</span><span class="number">769</span><span class="normal"> </span><span class="symbol">*</span>
<span class="normal">            </span><span class="function">png_sizeof</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_dsortp</span><span class="symbol">)));</span>
<span class="normal">         </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">769</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">            hash</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> NULL</span><span class="symbol">;</span>
<span class="comment">/*         png_memset(hash, 0, 769 * png_sizeof (png_dsortp)); */</span>

<span class="normal">         num_new_palette </span><span class="symbol">=</span><span class="normal"> num_palette</span><span class="symbol">;</span>

<span class="normal">         </span><span class="comment">/* initial wild guess at how far apart the farthest pixel</span>
<span class="comment">            pair we will be eliminating will be.  Larger</span>
<span class="comment">            numbers mean more areas will be allocated, Smaller</span>
<span class="comment">            numbers run the risk of not saving enough data, and</span>
<span class="comment">            having to do this all over again.</span>

<span class="comment">            I have not done extensive checking on this number.</span>
<span class="comment">            */</span>
<span class="normal">         max_d </span><span class="symbol">=</span><span class="normal"> </span><span class="number">96</span><span class="symbol">;</span>

<span class="normal">         </span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">num_new_palette </span><span class="symbol">&gt;</span><span class="normal"> maximum_colors</span><span class="symbol">)</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> num_new_palette </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="type">int</span><span class="normal"> j</span><span class="symbol">;</span>

<span class="normal">               </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">j </span><span class="symbol">=</span><span class="normal"> i </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span><span class="normal"> j </span><span class="symbol">&lt;</span><span class="normal"> num_new_palette</span><span class="symbol">;</span><span class="normal"> j</span><span class="symbol">++)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  </span><span class="type">int</span><span class="normal"> d</span><span class="symbol">;</span>

<span class="normal">                  d </span><span class="symbol">=</span><span class="normal"> </span><span class="function">PNG_COLOR_DIST</span><span class="symbol">(</span><span class="normal">palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">],</span><span class="normal"> palette</span><span class="symbol">[</span><span class="normal">j</span><span class="symbol">]);</span>

<span class="normal">                  </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">d </span><span class="symbol">&lt;=</span><span class="normal"> max_d</span><span class="symbol">)</span>
<span class="normal">                  </span><span class="cbracket">{</span>

<span class="normal">                     t </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_dsortp</span><span class="symbol">)</span><span class="function">png_malloc_warn</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span>
<span class="normal">                         </span><span class="symbol">(</span><span class="normal">png_uint_32</span><span class="symbol">)(</span><span class="function">png_sizeof</span><span class="symbol">(</span><span class="normal">png_dsort</span><span class="symbol">)));</span>
<span class="normal">                     </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">t </span><span class="symbol">==</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">                         </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">                     t</span><span class="symbol">-&gt;</span><span class="normal">next </span><span class="symbol">=</span><span class="normal"> hash</span><span class="symbol">[</span><span class="normal">d</span><span class="symbol">];</span>
<span class="normal">                     t</span><span class="symbol">-&gt;</span><span class="normal">left </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)</span><span class="normal">i</span><span class="symbol">;</span>
<span class="normal">                     t</span><span class="symbol">-&gt;</span><span class="normal">right </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)</span><span class="normal">j</span><span class="symbol">;</span>
<span class="normal">                     hash</span><span class="symbol">[</span><span class="normal">d</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> t</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">t </span><span class="symbol">==</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">                  </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">            </span><span class="cbracket">}</span>

<span class="normal">            </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">t </span><span class="symbol">!=</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">            </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;=</span><span class="normal"> max_d</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">hash</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  </span><span class="usertype">png_dsortp</span><span class="normal"> p</span><span class="symbol">;</span>

<span class="normal">                  </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">p </span><span class="symbol">=</span><span class="normal"> hash</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">];</span><span class="normal"> p</span><span class="symbol">;</span><span class="normal"> p </span><span class="symbol">=</span><span class="normal"> p</span><span class="symbol">-&gt;</span><span class="normal">next</span><span class="symbol">)</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="type">int</span><span class="symbol">)</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">index_to_palette</span><span class="symbol">[</span><span class="normal">p</span><span class="symbol">-&gt;</span><span class="normal">left</span><span class="symbol">]</span>
<span class="normal">                        </span><span class="symbol">&lt;</span><span class="normal"> num_new_palette </span><span class="symbol">&amp;&amp;</span>
<span class="normal">                        </span><span class="symbol">(</span><span class="type">int</span><span class="symbol">)</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">index_to_palette</span><span class="symbol">[</span><span class="normal">p</span><span class="symbol">-&gt;</span><span class="normal">right</span><span class="symbol">]</span>
<span class="normal">                        </span><span class="symbol">&lt;</span><span class="normal"> num_new_palette</span><span class="symbol">)</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="type">int</span><span class="normal"> j</span><span class="symbol">,</span><span class="normal"> next_j</span><span class="symbol">;</span>

<span class="normal">                        </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">num_new_palette </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x01</span><span class="symbol">)</span>
<span class="normal">                        </span><span class="cbracket">{</span>
<span class="normal">                           j </span><span class="symbol">=</span><span class="normal"> p</span><span class="symbol">-&gt;</span><span class="normal">left</span><span class="symbol">;</span>
<span class="normal">                           next_j </span><span class="symbol">=</span><span class="normal"> p</span><span class="symbol">-&gt;</span><span class="normal">right</span><span class="symbol">;</span>
<span class="normal">                        </span><span class="cbracket">}</span>
<span class="normal">                        </span><span class="keyword">else</span>
<span class="normal">                        </span><span class="cbracket">{</span>
<span class="normal">                           j </span><span class="symbol">=</span><span class="normal"> p</span><span class="symbol">-&gt;</span><span class="normal">right</span><span class="symbol">;</span>
<span class="normal">                           next_j </span><span class="symbol">=</span><span class="normal"> p</span><span class="symbol">-&gt;</span><span class="normal">left</span><span class="symbol">;</span>
<span class="normal">                        </span><span class="cbracket">}</span>

<span class="normal">                        num_new_palette</span><span class="symbol">--;</span>
<span class="normal">                        palette</span><span class="symbol">[</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">index_to_palette</span><span class="symbol">[</span><span class="normal">j</span><span class="symbol">]]</span>
<span class="normal">                          </span><span class="symbol">=</span><span class="normal"> palette</span><span class="symbol">[</span><span class="normal">num_new_palette</span><span class="symbol">];</span>
<span class="normal">                        </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">full_dither</span><span class="symbol">)</span>
<span class="normal">                        </span><span class="cbracket">{</span>
<span class="normal">                           </span><span class="type">int</span><span class="normal"> k</span><span class="symbol">;</span>

<span class="normal">                           </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">k </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> k </span><span class="symbol">&lt;</span><span class="normal"> num_palette</span><span class="symbol">;</span><span class="normal"> k</span><span class="symbol">++)</span>
<span class="normal">                           </span><span class="cbracket">{</span>
<span class="normal">                              </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">dither_index</span><span class="symbol">[</span><span class="normal">k</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">==</span>
<span class="normal">                                 png_ptr</span><span class="symbol">-&gt;</span><span class="normal">index_to_palette</span><span class="symbol">[</span><span class="normal">j</span><span class="symbol">])</span>
<span class="normal">                                 png_ptr</span><span class="symbol">-&gt;</span><span class="normal">dither_index</span><span class="symbol">[</span><span class="normal">k</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span>
<span class="normal">                                    png_ptr</span><span class="symbol">-&gt;</span><span class="normal">index_to_palette</span><span class="symbol">[</span><span class="normal">next_j</span><span class="symbol">];</span>
<span class="normal">                              </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="type">int</span><span class="symbol">)</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">dither_index</span><span class="symbol">[</span><span class="normal">k</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">==</span>
<span class="normal">                                 num_new_palette</span><span class="symbol">)</span>
<span class="normal">                                 png_ptr</span><span class="symbol">-&gt;</span><span class="normal">dither_index</span><span class="symbol">[</span><span class="normal">k</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span>
<span class="normal">                                    png_ptr</span><span class="symbol">-&gt;</span><span class="normal">index_to_palette</span><span class="symbol">[</span><span class="normal">j</span><span class="symbol">];</span>
<span class="normal">                           </span><span class="cbracket">}</span>
<span class="normal">                        </span><span class="cbracket">}</span>

<span class="normal">                        png_ptr</span><span class="symbol">-&gt;</span><span class="normal">index_to_palette</span><span class="symbol">[</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">palette_to_index</span>
<span class="normal">                           </span><span class="symbol">[</span><span class="normal">num_new_palette</span><span class="symbol">]]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">index_to_palette</span><span class="symbol">[</span><span class="normal">j</span><span class="symbol">];</span>
<span class="normal">                        png_ptr</span><span class="symbol">-&gt;</span><span class="normal">palette_to_index</span><span class="symbol">[</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">index_to_palette</span><span class="symbol">[</span><span class="normal">j</span><span class="symbol">]]</span>
<span class="normal">                           </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">palette_to_index</span><span class="symbol">[</span><span class="normal">num_new_palette</span><span class="symbol">];</span>

<span class="normal">                        png_ptr</span><span class="symbol">-&gt;</span><span class="normal">index_to_palette</span><span class="symbol">[</span><span class="normal">j</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)</span><span class="normal">num_new_palette</span><span class="symbol">;</span>
<span class="normal">                        png_ptr</span><span class="symbol">-&gt;</span><span class="normal">palette_to_index</span><span class="symbol">[</span><span class="normal">num_new_palette</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)</span><span class="normal">j</span><span class="symbol">;</span>
<span class="normal">                     </span><span class="cbracket">}</span>
<span class="normal">                     </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">num_new_palette </span><span class="symbol">&lt;=</span><span class="normal"> maximum_colors</span><span class="symbol">)</span>
<span class="normal">                        </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="cbracket">}</span>
<span class="normal">                  </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">num_new_palette </span><span class="symbol">&lt;=</span><span class="normal"> maximum_colors</span><span class="symbol">)</span>
<span class="normal">                     </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="cbracket">}</span>

<span class="normal">            </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">769</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">hash</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  </span><span class="usertype">png_dsortp</span><span class="normal"> p </span><span class="symbol">=</span><span class="normal"> hash</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">];</span>
<span class="normal">                  </span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">p</span><span class="symbol">)</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     t </span><span class="symbol">=</span><span class="normal"> p</span><span class="symbol">-&gt;</span><span class="normal">next</span><span class="symbol">;</span>
<span class="normal">                     </span><span class="function">png_free</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> p</span><span class="symbol">);</span>
<span class="normal">                     p </span><span class="symbol">=</span><span class="normal"> t</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">               hash</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            max_d </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">96</span><span class="symbol">;</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">         </span><span class="function">png_free</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> hash</span><span class="symbol">);</span>
<span class="normal">         </span><span class="function">png_free</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">palette_to_index</span><span class="symbol">);</span>
<span class="normal">         </span><span class="function">png_free</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">index_to_palette</span><span class="symbol">);</span>
<span class="normal">         png_ptr</span><span class="symbol">-&gt;</span><span class="normal">palette_to_index</span><span class="symbol">=</span><span class="normal">NULL</span><span class="symbol">;</span>
<span class="normal">         png_ptr</span><span class="symbol">-&gt;</span><span class="normal">index_to_palette</span><span class="symbol">=</span><span class="normal">NULL</span><span class="symbol">;</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">      num_palette </span><span class="symbol">=</span><span class="normal"> maximum_colors</span><span class="symbol">;</span>
<span class="normal">   </span><span class="cbracket">}</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">palette </span><span class="symbol">==</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      png_ptr</span><span class="symbol">-&gt;</span><span class="normal">palette </span><span class="symbol">=</span><span class="normal"> palette</span><span class="symbol">;</span>
<span class="normal">   </span><span class="cbracket">}</span>
<span class="normal">   png_ptr</span><span class="symbol">-&gt;</span><span class="normal">num_palette </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)</span><span class="normal">num_palette</span><span class="symbol">;</span>

<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">full_dither</span><span class="symbol">)</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="type">int</span><span class="normal"> i</span><span class="symbol">;</span>
<span class="normal">      </span><span class="usertype">png_bytep</span><span class="normal"> distance</span><span class="symbol">;</span>
<span class="normal">      </span><span class="type">int</span><span class="normal"> total_bits </span><span class="symbol">=</span><span class="normal"> PNG_DITHER_RED_BITS </span><span class="symbol">+</span><span class="normal"> PNG_DITHER_GREEN_BITS </span><span class="symbol">+</span>
<span class="normal">         PNG_DITHER_BLUE_BITS</span><span class="symbol">;</span>
<span class="normal">      </span><span class="type">int</span><span class="normal"> num_red </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="number">1</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> PNG_DITHER_RED_BITS</span><span class="symbol">);</span>
<span class="normal">      </span><span class="type">int</span><span class="normal"> num_green </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="number">1</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> PNG_DITHER_GREEN_BITS</span><span class="symbol">);</span>
<span class="normal">      </span><span class="type">int</span><span class="normal"> num_blue </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="number">1</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> PNG_DITHER_BLUE_BITS</span><span class="symbol">);</span>
<span class="normal">      </span><span class="usertype">png_size_t</span><span class="normal"> num_entries </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">png_size_t</span><span class="symbol">)</span><span class="number">1</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> total_bits</span><span class="symbol">);</span>

<span class="normal">      png_ptr</span><span class="symbol">-&gt;</span><span class="normal">palette_lookup </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_bytep </span><span class="symbol">)</span><span class="function">png_malloc</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span>
<span class="normal">         </span><span class="symbol">(</span><span class="normal">png_uint_32</span><span class="symbol">)(</span><span class="normal">num_entries </span><span class="symbol">*</span><span class="normal"> </span><span class="function">png_sizeof</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)));</span>

<span class="normal">      </span><span class="function">png_memset</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">palette_lookup</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> num_entries </span><span class="symbol">*</span>
<span class="normal">         </span><span class="function">png_sizeof</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">));</span>

<span class="normal">      distance </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_bytep</span><span class="symbol">)</span><span class="function">png_malloc</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_32</span><span class="symbol">)(</span><span class="normal">num_entries </span><span class="symbol">*</span>
<span class="normal">         </span><span class="function">png_sizeof</span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)));</span>

<span class="normal">      </span><span class="function">png_memset</span><span class="symbol">(</span><span class="normal">distance</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">,</span><span class="normal"> num_entries </span><span class="symbol">*</span><span class="normal"> </span><span class="function">png_sizeof</span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">));</span>

<span class="normal">      </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> num_palette</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         </span><span class="type">int</span><span class="normal"> ir</span><span class="symbol">,</span><span class="normal"> ig</span><span class="symbol">,</span><span class="normal"> ib</span><span class="symbol">;</span>
<span class="normal">         </span><span class="type">int</span><span class="normal"> r </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">red </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="symbol">(</span><span class="number">8</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> PNG_DITHER_RED_BITS</span><span class="symbol">));</span>
<span class="normal">         </span><span class="type">int</span><span class="normal"> g </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">green </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="symbol">(</span><span class="number">8</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> PNG_DITHER_GREEN_BITS</span><span class="symbol">));</span>
<span class="normal">         </span><span class="type">int</span><span class="normal"> b </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">blue </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="symbol">(</span><span class="number">8</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> PNG_DITHER_BLUE_BITS</span><span class="symbol">));</span>

<span class="normal">         </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ir </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> ir </span><span class="symbol">&lt;</span><span class="normal"> num_red</span><span class="symbol">;</span><span class="normal"> ir</span><span class="symbol">++)</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="comment">/* int dr = abs(ir - r); */</span>
<span class="normal">            </span><span class="type">int</span><span class="normal"> dr </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">ir </span><span class="symbol">&gt;</span><span class="normal"> r</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">?</span><span class="normal"> ir </span><span class="symbol">-</span><span class="normal"> r </span><span class="symbol">:</span><span class="normal"> r </span><span class="symbol">-</span><span class="normal"> ir</span><span class="symbol">);</span>
<span class="normal">            </span><span class="type">int</span><span class="normal"> index_r </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ir </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">PNG_DITHER_BLUE_BITS </span><span class="symbol">+</span><span class="normal"> PNG_DITHER_GREEN_BITS</span><span class="symbol">));</span>

<span class="normal">            </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ig </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> ig </span><span class="symbol">&lt;</span><span class="normal"> num_green</span><span class="symbol">;</span><span class="normal"> ig</span><span class="symbol">++)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="comment">/* int dg = abs(ig - g); */</span>
<span class="normal">               </span><span class="type">int</span><span class="normal"> dg </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">ig </span><span class="symbol">&gt;</span><span class="normal"> g</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">?</span><span class="normal"> ig </span><span class="symbol">-</span><span class="normal"> g </span><span class="symbol">:</span><span class="normal"> g </span><span class="symbol">-</span><span class="normal"> ig</span><span class="symbol">);</span>
<span class="normal">               </span><span class="type">int</span><span class="normal"> dt </span><span class="symbol">=</span><span class="normal"> dr </span><span class="symbol">+</span><span class="normal"> dg</span><span class="symbol">;</span>
<span class="normal">               </span><span class="type">int</span><span class="normal"> dm </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">dr </span><span class="symbol">&gt;</span><span class="normal"> dg</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">?</span><span class="normal"> dr </span><span class="symbol">:</span><span class="normal"> dg</span><span class="symbol">);</span>
<span class="normal">               </span><span class="type">int</span><span class="normal"> index_g </span><span class="symbol">=</span><span class="normal"> index_r </span><span class="symbol">|</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ig </span><span class="symbol">&lt;&lt;</span><span class="normal"> PNG_DITHER_BLUE_BITS</span><span class="symbol">);</span>

<span class="normal">               </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ib </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> ib </span><span class="symbol">&lt;</span><span class="normal"> num_blue</span><span class="symbol">;</span><span class="normal"> ib</span><span class="symbol">++)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  </span><span class="type">int</span><span class="normal"> d_index </span><span class="symbol">=</span><span class="normal"> index_g </span><span class="symbol">|</span><span class="normal"> ib</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="comment">/* int db = abs(ib - b); */</span>
<span class="normal">                  </span><span class="type">int</span><span class="normal"> db </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">ib </span><span class="symbol">&gt;</span><span class="normal"> b</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">?</span><span class="normal"> ib </span><span class="symbol">-</span><span class="normal"> b </span><span class="symbol">:</span><span class="normal"> b </span><span class="symbol">-</span><span class="normal"> ib</span><span class="symbol">);</span>
<span class="normal">                  </span><span class="type">int</span><span class="normal"> dmax </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">dm </span><span class="symbol">&gt;</span><span class="normal"> db</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">?</span><span class="normal"> dm </span><span class="symbol">:</span><span class="normal"> db</span><span class="symbol">);</span>
<span class="normal">                  </span><span class="type">int</span><span class="normal"> d </span><span class="symbol">=</span><span class="normal"> dmax </span><span class="symbol">+</span><span class="normal"> dt </span><span class="symbol">+</span><span class="normal"> db</span><span class="symbol">;</span>

<span class="normal">                  </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">d </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="symbol">)</span><span class="normal">distance</span><span class="symbol">[</span><span class="normal">d_index</span><span class="symbol">])</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     distance</span><span class="symbol">[</span><span class="normal">d_index</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)</span><span class="normal">d</span><span class="symbol">;</span>
<span class="normal">                     png_ptr</span><span class="symbol">-&gt;</span><span class="normal">palette_lookup</span><span class="symbol">[</span><span class="normal">d_index</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)</span><span class="normal">i</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="cbracket">}</span>

<span class="normal">      </span><span class="function">png_free</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> distance</span><span class="symbol">);</span>
<span class="normal">   </span><span class="cbracket">}</span>
<span class="cbracket">}</span>
<span class="preproc">#endif</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_GAMMA_SUPPORTED</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_FLOATING_POINT_SUPPORTED</span><span class="symbol">)</span>
<span class="comment">/* Transform the image from the file_gamma to the screen_gamma.  We</span>
<span class="comment"> * only do transformations on images where the file_gamma and screen_gamma</span>
<span class="comment"> * are not close reciprocals, otherwise it slows things down slightly, and</span>
<span class="comment"> * also needlessly introduces small errors.</span>
<span class="comment"> *</span>
<span class="comment"> * We will turn off gamma transformation later if no semitransparent entries</span>
<span class="comment"> * are present in the tRNS array for palette images.  We can't do it here</span>
<span class="comment"> * because we don't necessarily have the tRNS chunk yet.</span>
<span class="comment"> */</span>
<span class="type">void</span><span class="normal"> PNGAPI</span>
<span class="function">png_set_gamma</span><span class="symbol">(</span><span class="usertype">png_structp</span><span class="normal"> png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="type">double</span><span class="normal"> scrn_gamma</span><span class="symbol">,</span><span class="normal"> </span><span class="type">double</span><span class="normal"> file_gamma</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">   </span><span class="function">png_debug</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"in png_set_gamma</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="function">fabs</span><span class="symbol">(</span><span class="normal">scrn_gamma </span><span class="symbol">*</span><span class="normal"> file_gamma </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1.0</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;</span><span class="normal"> PNG_GAMMA_THRESHOLD</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">||</span>
<span class="normal">       </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">color_type </span><span class="symbol">&amp;</span><span class="normal"> PNG_COLOR_MASK_ALPHA</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">||</span>
<span class="normal">       </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">color_type </span><span class="symbol">==</span><span class="normal"> PNG_COLOR_TYPE_PALETTE</span><span class="symbol">))</span>
<span class="normal">     png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">|=</span><span class="normal"> PNG_GAMMA</span><span class="symbol">;</span>
<span class="normal">   png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="type">float</span><span class="symbol">)</span><span class="normal">file_gamma</span><span class="symbol">;</span>
<span class="normal">   png_ptr</span><span class="symbol">-&gt;</span><span class="normal">screen_gamma </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="type">float</span><span class="symbol">)</span><span class="normal">scrn_gamma</span><span class="symbol">;</span>
<span class="cbracket">}</span>
<span class="preproc">#endif</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_EXPAND_SUPPORTED</span><span class="symbol">)</span>
<span class="comment">/* Expand paletted images to RGB, expand grayscale images of</span>
<span class="comment"> * less than 8-bit depth to 8-bit depth, and expand tRNS chunks</span>
<span class="comment"> * to alpha channels.</span>
<span class="comment"> */</span>
<span class="type">void</span><span class="normal"> PNGAPI</span>
<span class="function">png_set_expand</span><span class="symbol">(</span><span class="usertype">png_structp</span><span class="normal"> png_ptr</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">   </span><span class="function">png_debug</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"in png_set_expand</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">   png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">|=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">PNG_EXPAND </span><span class="symbol">|</span><span class="normal"> PNG_EXPAND_tRNS</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="comment">/* GRR 19990627:  the following three functions currently are identical</span>
<span class="comment"> *  to png_set_expand().  However, it is entirely reasonable that someone</span>
<span class="comment"> *  might wish to expand an indexed image to RGB but *not* expand a single,</span>
<span class="comment"> *  fully transparent palette entry to a full alpha channel--perhaps instead</span>
<span class="comment"> *  convert tRNS to the grayscale/RGB format (16-bit RGB value), or replace</span>
<span class="comment"> *  the transparent color with a particular RGB value, or drop tRNS entirely.</span>
<span class="comment"> *  IOW, a future version of the library may make the transformations flag</span>
<span class="comment"> *  a bit more fine-grained, with separate bits for each of these three</span>
<span class="comment"> *  functions.</span>
<span class="comment"> *</span>
<span class="comment"> *  More to the point, these functions make it obvious what libpng will be</span>
<span class="comment"> *  doing, whereas "expand" can (and does) mean any number of things.</span>
<span class="comment"> *</span>
<span class="comment"> *  GRP 20060307: In libpng-1.4.0, png_set_gray_1_2_4_to_8() was modified</span>
<span class="comment"> *  to expand only the sample depth but not to expand the tRNS to alpha.</span>
<span class="comment"> */</span>

<span class="comment">/* Expand paletted images to RGB. */</span>
<span class="type">void</span><span class="normal"> PNGAPI</span>
<span class="function">png_set_palette_to_rgb</span><span class="symbol">(</span><span class="usertype">png_structp</span><span class="normal"> png_ptr</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">   </span><span class="function">png_debug</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"in png_set_palette_to_rgb</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">   png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">|=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">PNG_EXPAND </span><span class="symbol">|</span><span class="normal"> PNG_EXPAND_tRNS</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="symbol">!</span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_1_0_X</span><span class="symbol">)</span>
<span class="comment">/* Expand grayscale images of less than 8-bit depth to 8 bits. */</span>
<span class="type">void</span><span class="normal"> PNGAPI</span>
<span class="function">png_set_expand_gray_1_2_4_to_8</span><span class="symbol">(</span><span class="usertype">png_structp</span><span class="normal"> png_ptr</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">   </span><span class="function">png_debug</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"in png_set_expand_gray_1_2_4_to_8</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">   png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">|=</span><span class="normal"> PNG_EXPAND_tRNS</span><span class="symbol">;</span>
<span class="cbracket">}</span>
<span class="preproc">#endif</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_1_0_X</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_1_2_X</span><span class="symbol">)</span>
<span class="comment">/* Expand grayscale images of less than 8-bit depth to 8 bits. */</span>
<span class="comment">/* Deprecated as of libpng-1.2.9 */</span>
<span class="type">void</span><span class="normal"> PNGAPI</span>
<span class="function">png_set_gray_1_2_4_to_8</span><span class="symbol">(</span><span class="usertype">png_structp</span><span class="normal"> png_ptr</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">   </span><span class="function">png_debug</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"in png_set_gray_1_2_4_to_8</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">   png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">|=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">PNG_EXPAND </span><span class="symbol">|</span><span class="normal"> PNG_EXPAND_tRNS</span><span class="symbol">);</span>
<span class="cbracket">}</span>
<span class="preproc">#endif</span>


<span class="comment">/* Expand tRNS chunks to alpha channels. */</span>
<span class="type">void</span><span class="normal"> PNGAPI</span>
<span class="function">png_set_tRNS_to_alpha</span><span class="symbol">(</span><span class="usertype">png_structp</span><span class="normal"> png_ptr</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">   </span><span class="function">png_debug</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"in png_set_expand</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">   png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">|=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">PNG_EXPAND </span><span class="symbol">|</span><span class="normal"> PNG_EXPAND_tRNS</span><span class="symbol">);</span>
<span class="cbracket">}</span>
<span class="preproc">#endif</span><span class="normal"> </span><span class="comment">/* defined(PNG_READ_EXPAND_SUPPORTED) */</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_GRAY_TO_RGB_SUPPORTED</span><span class="symbol">)</span>
<span class="type">void</span><span class="normal"> PNGAPI</span>
<span class="function">png_set_gray_to_rgb</span><span class="symbol">(</span><span class="usertype">png_structp</span><span class="normal"> png_ptr</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">   </span><span class="function">png_debug</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"in png_set_gray_to_rgb</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">   png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">|=</span><span class="normal"> PNG_GRAY_TO_RGB</span><span class="symbol">;</span>
<span class="cbracket">}</span>
<span class="preproc">#endif</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_RGB_TO_GRAY_SUPPORTED</span><span class="symbol">)</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_FLOATING_POINT_SUPPORTED</span><span class="symbol">)</span>
<span class="comment">/* Convert a RGB image to a grayscale of the same width.  This allows us,</span>
<span class="comment"> * for example, to convert a 24 bpp RGB image into an 8 bpp grayscale image.</span>
<span class="comment"> */</span>

<span class="type">void</span><span class="normal"> PNGAPI</span>
<span class="function">png_set_rgb_to_gray</span><span class="symbol">(</span><span class="usertype">png_structp</span><span class="normal"> png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> error_action</span><span class="symbol">,</span><span class="normal"> </span><span class="type">double</span><span class="normal"> red</span><span class="symbol">,</span>
<span class="normal">   </span><span class="type">double</span><span class="normal"> green</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">      </span><span class="type">int</span><span class="normal"> red_fixed </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="symbol">)((</span><span class="type">float</span><span class="symbol">)</span><span class="normal">red</span><span class="symbol">*</span><span class="number">100000.0</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="number">0.5</span><span class="symbol">);</span>
<span class="normal">      </span><span class="type">int</span><span class="normal"> green_fixed </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="symbol">)((</span><span class="type">float</span><span class="symbol">)</span><span class="normal">green</span><span class="symbol">*</span><span class="number">100000.0</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="number">0.5</span><span class="symbol">);</span>
<span class="normal">      </span><span class="function">png_set_rgb_to_gray_fixed</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> error_action</span><span class="symbol">,</span><span class="normal"> red_fixed</span><span class="symbol">,</span><span class="normal"> green_fixed</span><span class="symbol">);</span>
<span class="cbracket">}</span>
<span class="preproc">#endif</span>

<span class="type">void</span><span class="normal"> PNGAPI</span>
<span class="function">png_set_rgb_to_gray_fixed</span><span class="symbol">(</span><span class="usertype">png_structp</span><span class="normal"> png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> error_action</span><span class="symbol">,</span>
<span class="normal">   </span><span class="usertype">png_fixed_point</span><span class="normal"> red</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">png_fixed_point</span><span class="normal"> green</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">   </span><span class="function">png_debug</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"in png_set_rgb_to_gray</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">   </span><span class="keyword">switch</span><span class="symbol">(</span><span class="normal">error_action</span><span class="symbol">)</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="keyword">case</span><span class="normal"> </span><span class="number">1</span><span class="symbol">:</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">|=</span><span class="normal"> PNG_RGB_TO_GRAY</span><span class="symbol">;</span>
<span class="normal">              </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">      </span><span class="keyword">case</span><span class="normal"> </span><span class="number">2</span><span class="symbol">:</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">|=</span><span class="normal"> PNG_RGB_TO_GRAY_WARN</span><span class="symbol">;</span>
<span class="normal">              </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">      </span><span class="keyword">case</span><span class="normal"> </span><span class="number">3</span><span class="symbol">:</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">|=</span><span class="normal"> PNG_RGB_TO_GRAY_ERR</span><span class="symbol">;</span>
<span class="normal">   </span><span class="cbracket">}</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">color_type </span><span class="symbol">==</span><span class="normal"> PNG_COLOR_TYPE_PALETTE</span><span class="symbol">)</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_EXPAND_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">      png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">|=</span><span class="normal"> PNG_EXPAND</span><span class="symbol">;</span>
<span class="preproc">#else</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="function">png_warning</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"Cannot do RGB_TO_GRAY without EXPAND_SUPPORTED."</span><span class="symbol">);</span>
<span class="normal">      png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="symbol">~</span><span class="normal">PNG_RGB_TO_GRAY</span><span class="symbol">;</span>
<span class="normal">   </span><span class="cbracket">}</span>
<span class="preproc">#endif</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="usertype">png_uint_16</span><span class="normal"> red_int</span><span class="symbol">,</span><span class="normal"> green_int</span><span class="symbol">;</span>
<span class="normal">      </span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">red </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">0</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> green </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         red_int   </span><span class="symbol">=</span><span class="normal">  </span><span class="number">6968</span><span class="symbol">;</span><span class="normal"> </span><span class="comment">/* .212671 * 32768 + .5 */</span>
<span class="normal">         green_int </span><span class="symbol">=</span><span class="normal"> </span><span class="number">23434</span><span class="symbol">;</span><span class="normal"> </span><span class="comment">/* .715160 * 32768 + .5 */</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">red </span><span class="symbol">+</span><span class="normal"> green </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">100000L</span><span class="symbol">)</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">        red_int </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)(((</span><span class="normal">png_uint_32</span><span class="symbol">)</span><span class="normal">red</span><span class="symbol">*</span><span class="number">32768L</span><span class="symbol">)/</span><span class="number">100000L</span><span class="symbol">);</span>
<span class="normal">        green_int </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)(((</span><span class="normal">png_uint_32</span><span class="symbol">)</span><span class="normal">green</span><span class="symbol">*</span><span class="number">32768L</span><span class="symbol">)/</span><span class="number">100000L</span><span class="symbol">);</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="keyword">else</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         </span><span class="function">png_warning</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"ignoring out of range rgb_to_gray coefficients"</span><span class="symbol">);</span>
<span class="normal">         red_int   </span><span class="symbol">=</span><span class="normal">  </span><span class="number">6968</span><span class="symbol">;</span>
<span class="normal">         green_int </span><span class="symbol">=</span><span class="normal"> </span><span class="number">23434</span><span class="symbol">;</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">      png_ptr</span><span class="symbol">-&gt;</span><span class="normal">rgb_to_gray_red_coeff   </span><span class="symbol">=</span><span class="normal"> red_int</span><span class="symbol">;</span>
<span class="normal">      png_ptr</span><span class="symbol">-&gt;</span><span class="normal">rgb_to_gray_green_coeff </span><span class="symbol">=</span><span class="normal"> green_int</span><span class="symbol">;</span>
<span class="normal">      png_ptr</span><span class="symbol">-&gt;</span><span class="normal">rgb_to_gray_blue_coeff  </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)(</span><span class="number">32768</span><span class="symbol">-</span><span class="normal">red_int</span><span class="symbol">-</span><span class="normal">green_int</span><span class="symbol">);</span>
<span class="normal">   </span><span class="cbracket">}</span>
<span class="cbracket">}</span>
<span class="preproc">#endif</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_USER_TRANSFORM_SUPPORTED</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">    </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_WRITE_USER_TRANSFORM_SUPPORTED</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">    </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_LEGACY_SUPPORTED</span><span class="symbol">)</span>
<span class="type">void</span><span class="normal"> PNGAPI</span>
<span class="function">png_set_read_user_transform_fn</span><span class="symbol">(</span><span class="usertype">png_structp</span><span class="normal"> png_ptr</span><span class="symbol">,</span><span class="normal"> png_user_transform_ptr</span>
<span class="normal">   read_user_transform_fn</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">   </span><span class="function">png_debug</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"in png_set_read_user_transform_fn</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_USER_TRANSFORM_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">|=</span><span class="normal"> PNG_USER_TRANSFORM</span><span class="symbol">;</span>
<span class="normal">   png_ptr</span><span class="symbol">-&gt;</span><span class="normal">read_user_transform_fn </span><span class="symbol">=</span><span class="normal"> read_user_transform_fn</span><span class="symbol">;</span>
<span class="preproc">#endif</span>
<span class="preproc">#ifdef</span><span class="normal"> PNG_LEGACY_SUPPORTED</span>
<span class="normal">   </span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">read_user_transform_fn</span><span class="symbol">)</span>
<span class="normal">      </span><span class="function">png_warning</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span>
<span class="normal">        </span><span class="string">"This version of libpng does not support user transforms"</span><span class="symbol">);</span>
<span class="preproc">#endif</span>
<span class="cbracket">}</span>
<span class="preproc">#endif</span>

<span class="comment">/* Initialize everything needed for the read.  This includes modifying</span>
<span class="comment"> * the palette.</span>
<span class="comment"> */</span>
<span class="type">void</span><span class="normal"> </span><span class="comment">/* PRIVATE */</span>
<span class="function">png_init_read_transformations</span><span class="symbol">(</span><span class="usertype">png_structp</span><span class="normal"> png_ptr</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">   </span><span class="function">png_debug</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"in png_init_read_transformations</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_USELESS_TESTS_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">png_ptr </span><span class="symbol">!=</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="preproc">#endif</span>
<span class="normal">  </span><span class="cbracket">{</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_BACKGROUND_SUPPORTED</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_SHIFT_SUPPORTED</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal"> </span><span class="symbol">||</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_GAMMA_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="type">int</span><span class="normal"> color_type </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">color_type</span><span class="symbol">;</span>
<span class="preproc">#endif</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_EXPAND_SUPPORTED</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_BACKGROUND_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">&amp;</span><span class="normal"> PNG_BACKGROUND_EXPAND</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span>
<span class="normal">       </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">&amp;</span><span class="normal"> PNG_EXPAND</span><span class="symbol">))</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!(</span><span class="normal">color_type </span><span class="symbol">&amp;</span><span class="normal"> PNG_COLOR_MASK_COLOR</span><span class="symbol">))</span><span class="normal">  </span><span class="comment">/* i.e., GRAY or GRAY_ALPHA */</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         </span><span class="comment">/* expand background and tRNS chunks */</span>
<span class="normal">         </span><span class="keyword">switch</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">bit_depth</span><span class="symbol">)</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="keyword">case</span><span class="normal"> </span><span class="number">1</span><span class="symbol">:</span>
<span class="normal">               png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">gray </span><span class="symbol">*=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)</span><span class="number">0xff</span><span class="symbol">;</span>
<span class="normal">               png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">red </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">green</span>
<span class="normal">                 </span><span class="symbol">=</span><span class="normal">  png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">blue </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">gray</span><span class="symbol">;</span>
<span class="normal">               </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">&amp;</span><span class="normal"> PNG_EXPAND_tRNS</span><span class="symbol">))</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                 png_ptr</span><span class="symbol">-&gt;</span><span class="normal">trans_values</span><span class="symbol">.</span><span class="normal">gray </span><span class="symbol">*=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)</span><span class="number">0xff</span><span class="symbol">;</span>
<span class="normal">                 png_ptr</span><span class="symbol">-&gt;</span><span class="normal">trans_values</span><span class="symbol">.</span><span class="normal">red </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">trans_values</span><span class="symbol">.</span><span class="normal">green</span>
<span class="normal">                   </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">trans_values</span><span class="symbol">.</span><span class="normal">blue </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">trans_values</span><span class="symbol">.</span><span class="normal">gray</span><span class="symbol">;</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">            </span><span class="keyword">case</span><span class="normal"> </span><span class="number">2</span><span class="symbol">:</span>
<span class="normal">               png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">gray </span><span class="symbol">*=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)</span><span class="number">0x55</span><span class="symbol">;</span>
<span class="normal">               png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">red </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">green</span>
<span class="normal">                 </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">blue </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">gray</span><span class="symbol">;</span>
<span class="normal">               </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">&amp;</span><span class="normal"> PNG_EXPAND_tRNS</span><span class="symbol">))</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                 png_ptr</span><span class="symbol">-&gt;</span><span class="normal">trans_values</span><span class="symbol">.</span><span class="normal">gray </span><span class="symbol">*=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)</span><span class="number">0x55</span><span class="symbol">;</span>
<span class="normal">                 png_ptr</span><span class="symbol">-&gt;</span><span class="normal">trans_values</span><span class="symbol">.</span><span class="normal">red </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">trans_values</span><span class="symbol">.</span><span class="normal">green</span>
<span class="normal">                   </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">trans_values</span><span class="symbol">.</span><span class="normal">blue </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">trans_values</span><span class="symbol">.</span><span class="normal">gray</span><span class="symbol">;</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">            </span><span class="keyword">case</span><span class="normal"> </span><span class="number">4</span><span class="symbol">:</span>
<span class="normal">               png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">gray </span><span class="symbol">*=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)</span><span class="number">0x11</span><span class="symbol">;</span>
<span class="normal">               png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">red </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">green</span>
<span class="normal">                 </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">blue </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">gray</span><span class="symbol">;</span>
<span class="normal">               </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">&amp;</span><span class="normal"> PNG_EXPAND_tRNS</span><span class="symbol">))</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                 png_ptr</span><span class="symbol">-&gt;</span><span class="normal">trans_values</span><span class="symbol">.</span><span class="normal">gray </span><span class="symbol">*=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)</span><span class="number">0x11</span><span class="symbol">;</span>
<span class="normal">                 png_ptr</span><span class="symbol">-&gt;</span><span class="normal">trans_values</span><span class="symbol">.</span><span class="normal">red </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">trans_values</span><span class="symbol">.</span><span class="normal">green</span>
<span class="normal">                   </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">trans_values</span><span class="symbol">.</span><span class="normal">blue </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">trans_values</span><span class="symbol">.</span><span class="normal">gray</span><span class="symbol">;</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">            </span><span class="keyword">case</span><span class="normal"> </span><span class="number">8</span><span class="symbol">:</span>
<span class="normal">            </span><span class="keyword">case</span><span class="normal"> </span><span class="number">16</span><span class="symbol">:</span>
<span class="normal">               png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">red </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">green</span>
<span class="normal">                 </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">blue </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">gray</span><span class="symbol">;</span>
<span class="normal">               </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">color_type </span><span class="symbol">==</span><span class="normal"> PNG_COLOR_TYPE_PALETTE</span><span class="symbol">)</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">red   </span><span class="symbol">=</span>
<span class="normal">            png_ptr</span><span class="symbol">-&gt;</span><span class="normal">palette</span><span class="symbol">[</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">index</span><span class="symbol">].</span><span class="normal">red</span><span class="symbol">;</span>
<span class="normal">         png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">green </span><span class="symbol">=</span>
<span class="normal">            png_ptr</span><span class="symbol">-&gt;</span><span class="normal">palette</span><span class="symbol">[</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">index</span><span class="symbol">].</span><span class="normal">green</span><span class="symbol">;</span>
<span class="normal">         png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">blue  </span><span class="symbol">=</span>
<span class="normal">            png_ptr</span><span class="symbol">-&gt;</span><span class="normal">palette</span><span class="symbol">[</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">index</span><span class="symbol">].</span><span class="normal">blue</span><span class="symbol">;</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_INVERT_ALPHA_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">        </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">&amp;</span><span class="normal"> PNG_INVERT_ALPHA</span><span class="symbol">)</span>
<span class="normal">        </span><span class="cbracket">{</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_EXPAND_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">           </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">&amp;</span><span class="normal"> PNG_EXPAND_tRNS</span><span class="symbol">))</span>
<span class="preproc">#endif</span>
<span class="normal">           </span><span class="cbracket">{</span>
<span class="normal">           </span><span class="comment">/* invert the alpha channel (in tRNS) unless the pixels are</span>
<span class="comment">              going to be expanded, in which case leave it for later */</span>
<span class="normal">              </span><span class="type">int</span><span class="normal"> i</span><span class="symbol">,</span><span class="normal">istop</span><span class="symbol">;</span>
<span class="normal">              istop</span><span class="symbol">=(</span><span class="type">int</span><span class="symbol">)</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">num_trans</span><span class="symbol">;</span>
<span class="normal">              </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i</span><span class="symbol">=</span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">&lt;</span><span class="normal">istop</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">                 png_ptr</span><span class="symbol">-&gt;</span><span class="normal">trans</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="number">255</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">trans</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]);</span>
<span class="normal">           </span><span class="cbracket">}</span>
<span class="normal">        </span><span class="cbracket">}</span>
<span class="preproc">#endif</span>

<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">   </span><span class="cbracket">}</span>
<span class="preproc">#endif</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_BACKGROUND_SUPPORTED</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_GAMMA_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background_1 </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">;</span>
<span class="preproc">#endif</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_GAMMA_SUPPORTED</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_FLOATING_POINT_SUPPORTED</span><span class="symbol">)</span>

<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">color_type </span><span class="symbol">==</span><span class="normal"> PNG_COLOR_TYPE_PALETTE </span><span class="symbol">&amp;&amp;</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">num_trans </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">       </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="function">fabs</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">screen_gamma </span><span class="symbol">*</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1.0</span><span class="symbol">)</span>
<span class="normal">         </span><span class="symbol">&lt;</span><span class="normal"> PNG_GAMMA_THRESHOLD</span><span class="symbol">))</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">    </span><span class="type">int</span><span class="normal"> i</span><span class="symbol">,</span><span class="normal">k</span><span class="symbol">;</span>
<span class="normal">    k</span><span class="symbol">=</span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">    </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i</span><span class="symbol">=</span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">&lt;</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">num_trans</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">trans</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">trans</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">)</span>
<span class="normal">        k</span><span class="symbol">=</span><span class="number">1</span><span class="symbol">;</span><span class="normal"> </span><span class="comment">/* partial transparency is present */</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">k </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">      png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="symbol">(~</span><span class="normal">PNG_GAMMA</span><span class="symbol">);</span>
<span class="normal">   </span><span class="cbracket">}</span>

<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">PNG_GAMMA </span><span class="symbol">|</span><span class="normal"> PNG_RGB_TO_GRAY</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span>
<span class="normal">        png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0.0</span><span class="symbol">)</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="function">png_build_gamma_table</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">);</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_BACKGROUND_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">      </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">&amp;</span><span class="normal"> PNG_BACKGROUND</span><span class="symbol">)</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">color_type </span><span class="symbol">==</span><span class="normal"> PNG_COLOR_TYPE_PALETTE</span><span class="symbol">)</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">           </span><span class="comment">/* could skip if no transparency and</span>
<span class="comment">           */</span>
<span class="normal">            </span><span class="usertype">png_color</span><span class="normal"> back</span><span class="symbol">,</span><span class="normal"> back_1</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_colorp</span><span class="normal"> palette </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">palette</span><span class="symbol">;</span>
<span class="normal">            </span><span class="type">int</span><span class="normal"> num_palette </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">num_palette</span><span class="symbol">;</span>
<span class="normal">            </span><span class="type">int</span><span class="normal"> i</span><span class="symbol">;</span>
<span class="normal">            </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background_gamma_type </span><span class="symbol">==</span><span class="normal"> PNG_BACKGROUND_GAMMA_FILE</span><span class="symbol">)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               back</span><span class="symbol">.</span><span class="normal">red </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_table</span><span class="symbol">[</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">red</span><span class="symbol">];</span>
<span class="normal">               back</span><span class="symbol">.</span><span class="normal">green </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_table</span><span class="symbol">[</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">green</span><span class="symbol">];</span>
<span class="normal">               back</span><span class="symbol">.</span><span class="normal">blue </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_table</span><span class="symbol">[</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">blue</span><span class="symbol">];</span>

<span class="normal">               back_1</span><span class="symbol">.</span><span class="normal">red </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_to_1</span><span class="symbol">[</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">red</span><span class="symbol">];</span>
<span class="normal">               back_1</span><span class="symbol">.</span><span class="normal">green </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_to_1</span><span class="symbol">[</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">green</span><span class="symbol">];</span>
<span class="normal">               back_1</span><span class="symbol">.</span><span class="normal">blue </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_to_1</span><span class="symbol">[</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">blue</span><span class="symbol">];</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="keyword">else</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="type">double</span><span class="normal"> g</span><span class="symbol">,</span><span class="normal"> gs</span><span class="symbol">;</span>

<span class="normal">               </span><span class="keyword">switch</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background_gamma_type</span><span class="symbol">)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  </span><span class="keyword">case</span><span class="normal"> PNG_BACKGROUND_GAMMA_SCREEN</span><span class="symbol">:</span>
<span class="normal">                     g </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">screen_gamma</span><span class="symbol">);</span>
<span class="normal">                     gs </span><span class="symbol">=</span><span class="normal"> </span><span class="number">1.0</span><span class="symbol">;</span>
<span class="normal">                     </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="keyword">case</span><span class="normal"> PNG_BACKGROUND_GAMMA_FILE</span><span class="symbol">:</span>
<span class="normal">                     g </span><span class="symbol">=</span><span class="normal"> </span><span class="number">1.0</span><span class="normal"> </span><span class="symbol">/</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma</span><span class="symbol">);</span>
<span class="normal">                     gs </span><span class="symbol">=</span><span class="normal"> </span><span class="number">1.0</span><span class="normal"> </span><span class="symbol">/</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma </span><span class="symbol">*</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">screen_gamma</span><span class="symbol">);</span>
<span class="normal">                     </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="keyword">case</span><span class="normal"> PNG_BACKGROUND_GAMMA_UNIQUE</span><span class="symbol">:</span>
<span class="normal">                     g </span><span class="symbol">=</span><span class="normal"> </span><span class="number">1.0</span><span class="normal"> </span><span class="symbol">/</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background_gamma</span><span class="symbol">);</span>
<span class="normal">                     gs </span><span class="symbol">=</span><span class="normal"> </span><span class="number">1.0</span><span class="normal"> </span><span class="symbol">/</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background_gamma </span><span class="symbol">*</span>
<span class="normal">                                 png_ptr</span><span class="symbol">-&gt;</span><span class="normal">screen_gamma</span><span class="symbol">);</span>
<span class="normal">                     </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="label">                  default:</span>
<span class="normal">                     g </span><span class="symbol">=</span><span class="normal"> </span><span class="number">1.0</span><span class="symbol">;</span><span class="normal">    </span><span class="comment">/* back_1 */</span>
<span class="normal">                     gs </span><span class="symbol">=</span><span class="normal"> </span><span class="number">1.0</span><span class="symbol">;</span><span class="normal">   </span><span class="comment">/* back */</span>
<span class="normal">               </span><span class="cbracket">}</span>

<span class="normal">               </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal"> </span><span class="function">fabs</span><span class="symbol">(</span><span class="normal">gs </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1.0</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&lt;</span><span class="normal"> PNG_GAMMA_THRESHOLD</span><span class="symbol">)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  back</span><span class="symbol">.</span><span class="normal">red   </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">red</span><span class="symbol">;</span>
<span class="normal">                  back</span><span class="symbol">.</span><span class="normal">green </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">green</span><span class="symbol">;</span>
<span class="normal">                  back</span><span class="symbol">.</span><span class="normal">blue  </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">blue</span><span class="symbol">;</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="keyword">else</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  back</span><span class="symbol">.</span><span class="normal">red </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="function">pow</span><span class="symbol">(</span>
<span class="normal">                     </span><span class="symbol">(</span><span class="type">double</span><span class="symbol">)</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">red</span><span class="symbol">/</span><span class="number">255</span><span class="symbol">,</span><span class="normal"> gs</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> </span><span class="number">255.0</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">.</span><span class="number">5</span><span class="symbol">);</span>
<span class="normal">                  back</span><span class="symbol">.</span><span class="normal">green </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="function">pow</span><span class="symbol">(</span>
<span class="normal">                     </span><span class="symbol">(</span><span class="type">double</span><span class="symbol">)</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">green</span><span class="symbol">/</span><span class="number">255</span><span class="symbol">,</span><span class="normal"> gs</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> </span><span class="number">255.0</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">.</span><span class="number">5</span><span class="symbol">);</span>
<span class="normal">                  back</span><span class="symbol">.</span><span class="normal">blue </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="function">pow</span><span class="symbol">(</span>
<span class="normal">                     </span><span class="symbol">(</span><span class="type">double</span><span class="symbol">)</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">blue</span><span class="symbol">/</span><span class="number">255</span><span class="symbol">,</span><span class="normal"> gs</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> </span><span class="number">255.0</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">.</span><span class="number">5</span><span class="symbol">);</span>
<span class="normal">               </span><span class="cbracket">}</span>

<span class="normal">               back_1</span><span class="symbol">.</span><span class="normal">red </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="function">pow</span><span class="symbol">(</span>
<span class="normal">                  </span><span class="symbol">(</span><span class="type">double</span><span class="symbol">)</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">red</span><span class="symbol">/</span><span class="number">255</span><span class="symbol">,</span><span class="normal"> g</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> </span><span class="number">255.0</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">.</span><span class="number">5</span><span class="symbol">);</span>
<span class="normal">               back_1</span><span class="symbol">.</span><span class="normal">green </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="function">pow</span><span class="symbol">(</span>
<span class="normal">                  </span><span class="symbol">(</span><span class="type">double</span><span class="symbol">)</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">green</span><span class="symbol">/</span><span class="number">255</span><span class="symbol">,</span><span class="normal"> g</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> </span><span class="number">255.0</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">.</span><span class="number">5</span><span class="symbol">);</span>
<span class="normal">               back_1</span><span class="symbol">.</span><span class="normal">blue </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="function">pow</span><span class="symbol">(</span>
<span class="normal">                  </span><span class="symbol">(</span><span class="type">double</span><span class="symbol">)</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">blue</span><span class="symbol">/</span><span class="number">255</span><span class="symbol">,</span><span class="normal"> g</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> </span><span class="number">255.0</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">.</span><span class="number">5</span><span class="symbol">);</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> num_palette</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="symbol">)</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">num_trans </span><span class="symbol">&amp;&amp;</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">trans</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">trans</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> back</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="cbracket">}</span>
<span class="normal">                  </span><span class="keyword">else</span><span class="normal"> </span><span class="comment">/* if (png_ptr-&gt;trans[i] != 0xff) */</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     </span><span class="usertype">png_byte</span><span class="normal"> v</span><span class="symbol">,</span><span class="normal"> w</span><span class="symbol">;</span>

<span class="normal">                     v </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_to_1</span><span class="symbol">[</span><span class="normal">palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">red</span><span class="symbol">];</span>
<span class="normal">                     </span><span class="function">png_composite</span><span class="symbol">(</span><span class="normal">w</span><span class="symbol">,</span><span class="normal"> v</span><span class="symbol">,</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">trans</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">],</span><span class="normal"> back_1</span><span class="symbol">.</span><span class="normal">red</span><span class="symbol">);</span>
<span class="normal">                     palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">red </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_from_1</span><span class="symbol">[</span><span class="normal">w</span><span class="symbol">];</span>

<span class="normal">                     v </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_to_1</span><span class="symbol">[</span><span class="normal">palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">green</span><span class="symbol">];</span>
<span class="normal">                     </span><span class="function">png_composite</span><span class="symbol">(</span><span class="normal">w</span><span class="symbol">,</span><span class="normal"> v</span><span class="symbol">,</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">trans</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">],</span><span class="normal"> back_1</span><span class="symbol">.</span><span class="normal">green</span><span class="symbol">);</span>
<span class="normal">                     palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">green </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_from_1</span><span class="symbol">[</span><span class="normal">w</span><span class="symbol">];</span>

<span class="normal">                     v </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_to_1</span><span class="symbol">[</span><span class="normal">palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">blue</span><span class="symbol">];</span>
<span class="normal">                     </span><span class="function">png_composite</span><span class="symbol">(</span><span class="normal">w</span><span class="symbol">,</span><span class="normal"> v</span><span class="symbol">,</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">trans</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">],</span><span class="normal"> back_1</span><span class="symbol">.</span><span class="normal">blue</span><span class="symbol">);</span>
<span class="normal">                     palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">blue </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_from_1</span><span class="symbol">[</span><span class="normal">w</span><span class="symbol">];</span>
<span class="normal">                  </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="keyword">else</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">red </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_table</span><span class="symbol">[</span><span class="normal">palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">red</span><span class="symbol">];</span>
<span class="normal">                  palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">green </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_table</span><span class="symbol">[</span><span class="normal">palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">green</span><span class="symbol">];</span>
<span class="normal">                  palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">blue </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_table</span><span class="symbol">[</span><span class="normal">palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">blue</span><span class="symbol">];</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">         </span><span class="comment">/* if (png_ptr-&gt;background_gamma_type!=PNG_BACKGROUND_GAMMA_UNKNOWN) */</span>
<span class="normal">         </span><span class="keyword">else</span>
<span class="normal">         </span><span class="comment">/* color_type != PNG_COLOR_TYPE_PALETTE */</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="type">double</span><span class="normal"> m </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="type">double</span><span class="symbol">)(((</span><span class="normal">png_uint_32</span><span class="symbol">)</span><span class="number">1</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">bit_depth</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">            </span><span class="type">double</span><span class="normal"> g </span><span class="symbol">=</span><span class="normal"> </span><span class="number">1.0</span><span class="symbol">;</span>
<span class="normal">            </span><span class="type">double</span><span class="normal"> gs </span><span class="symbol">=</span><span class="normal"> </span><span class="number">1.0</span><span class="symbol">;</span>

<span class="normal">            </span><span class="keyword">switch</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background_gamma_type</span><span class="symbol">)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="keyword">case</span><span class="normal"> PNG_BACKGROUND_GAMMA_SCREEN</span><span class="symbol">:</span>
<span class="normal">                  g </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">screen_gamma</span><span class="symbol">);</span>
<span class="normal">                  gs </span><span class="symbol">=</span><span class="normal"> </span><span class="number">1.0</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">               </span><span class="keyword">case</span><span class="normal"> PNG_BACKGROUND_GAMMA_FILE</span><span class="symbol">:</span>
<span class="normal">                  g </span><span class="symbol">=</span><span class="normal"> </span><span class="number">1.0</span><span class="normal"> </span><span class="symbol">/</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma</span><span class="symbol">);</span>
<span class="normal">                  gs </span><span class="symbol">=</span><span class="normal"> </span><span class="number">1.0</span><span class="normal"> </span><span class="symbol">/</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma </span><span class="symbol">*</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">screen_gamma</span><span class="symbol">);</span>
<span class="normal">                  </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">               </span><span class="keyword">case</span><span class="normal"> PNG_BACKGROUND_GAMMA_UNIQUE</span><span class="symbol">:</span>
<span class="normal">                  g </span><span class="symbol">=</span><span class="normal"> </span><span class="number">1.0</span><span class="normal"> </span><span class="symbol">/</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background_gamma</span><span class="symbol">);</span>
<span class="normal">                  gs </span><span class="symbol">=</span><span class="normal"> </span><span class="number">1.0</span><span class="normal"> </span><span class="symbol">/</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background_gamma </span><span class="symbol">*</span>
<span class="normal">                     png_ptr</span><span class="symbol">-&gt;</span><span class="normal">screen_gamma</span><span class="symbol">);</span>
<span class="normal">                  </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">            </span><span class="cbracket">}</span>

<span class="normal">            png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background_1</span><span class="symbol">.</span><span class="normal">gray </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)(</span><span class="function">pow</span><span class="symbol">(</span>
<span class="normal">               </span><span class="symbol">(</span><span class="type">double</span><span class="symbol">)</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">gray </span><span class="symbol">/</span><span class="normal"> m</span><span class="symbol">,</span><span class="normal"> g</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> m </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">.</span><span class="number">5</span><span class="symbol">);</span>
<span class="normal">            png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">gray </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)(</span><span class="function">pow</span><span class="symbol">(</span>
<span class="normal">               </span><span class="symbol">(</span><span class="type">double</span><span class="symbol">)</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">gray </span><span class="symbol">/</span><span class="normal"> m</span><span class="symbol">,</span><span class="normal"> gs</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> m </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">.</span><span class="number">5</span><span class="symbol">);</span>

<span class="normal">            </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">red </span><span class="symbol">!=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">green</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">||</span>
<span class="normal">                </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">red </span><span class="symbol">!=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">blue</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">||</span>
<span class="normal">                </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">red </span><span class="symbol">!=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">gray</span><span class="symbol">))</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="comment">/* RGB or RGBA with color background */</span>
<span class="normal">               png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background_1</span><span class="symbol">.</span><span class="normal">red </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)(</span><span class="function">pow</span><span class="symbol">(</span>
<span class="normal">                  </span><span class="symbol">(</span><span class="type">double</span><span class="symbol">)</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">red </span><span class="symbol">/</span><span class="normal"> m</span><span class="symbol">,</span><span class="normal"> g</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> m </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">.</span><span class="number">5</span><span class="symbol">);</span>
<span class="normal">               png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background_1</span><span class="symbol">.</span><span class="normal">green </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)(</span><span class="function">pow</span><span class="symbol">(</span>
<span class="normal">                  </span><span class="symbol">(</span><span class="type">double</span><span class="symbol">)</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">green </span><span class="symbol">/</span><span class="normal"> m</span><span class="symbol">,</span><span class="normal"> g</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> m </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">.</span><span class="number">5</span><span class="symbol">);</span>
<span class="normal">               png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background_1</span><span class="symbol">.</span><span class="normal">blue </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)(</span><span class="function">pow</span><span class="symbol">(</span>
<span class="normal">                  </span><span class="symbol">(</span><span class="type">double</span><span class="symbol">)</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">blue </span><span class="symbol">/</span><span class="normal"> m</span><span class="symbol">,</span><span class="normal"> g</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> m </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">.</span><span class="number">5</span><span class="symbol">);</span>
<span class="normal">               png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">red </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)(</span><span class="function">pow</span><span class="symbol">(</span>
<span class="normal">                  </span><span class="symbol">(</span><span class="type">double</span><span class="symbol">)</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">red </span><span class="symbol">/</span><span class="normal"> m</span><span class="symbol">,</span><span class="normal"> gs</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> m </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">.</span><span class="number">5</span><span class="symbol">);</span>
<span class="normal">               png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">green </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)(</span><span class="function">pow</span><span class="symbol">(</span>
<span class="normal">                  </span><span class="symbol">(</span><span class="type">double</span><span class="symbol">)</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">green </span><span class="symbol">/</span><span class="normal"> m</span><span class="symbol">,</span><span class="normal"> gs</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> m </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">.</span><span class="number">5</span><span class="symbol">);</span>
<span class="normal">               png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">blue </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)(</span><span class="function">pow</span><span class="symbol">(</span>
<span class="normal">                  </span><span class="symbol">(</span><span class="type">double</span><span class="symbol">)</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">blue </span><span class="symbol">/</span><span class="normal"> m</span><span class="symbol">,</span><span class="normal"> gs</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> m </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">.</span><span class="number">5</span><span class="symbol">);</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="keyword">else</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="comment">/* GRAY, GRAY ALPHA, RGB, or RGBA with gray background */</span>
<span class="normal">               png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background_1</span><span class="symbol">.</span><span class="normal">red </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background_1</span><span class="symbol">.</span><span class="normal">green</span>
<span class="normal">                 </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background_1</span><span class="symbol">.</span><span class="normal">blue </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background_1</span><span class="symbol">.</span><span class="normal">gray</span><span class="symbol">;</span>
<span class="normal">               png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">red </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">green</span>
<span class="normal">                 </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">blue </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">gray</span><span class="symbol">;</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="keyword">else</span>
<span class="normal">      </span><span class="comment">/* transformation does not include PNG_BACKGROUND */</span>
<span class="preproc">#endif</span><span class="normal"> </span><span class="comment">/* PNG_READ_BACKGROUND_SUPPORTED */</span>
<span class="normal">      </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">color_type </span><span class="symbol">==</span><span class="normal"> PNG_COLOR_TYPE_PALETTE</span><span class="symbol">)</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         </span><span class="usertype">png_colorp</span><span class="normal"> palette </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">palette</span><span class="symbol">;</span>
<span class="normal">         </span><span class="type">int</span><span class="normal"> num_palette </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">num_palette</span><span class="symbol">;</span>
<span class="normal">         </span><span class="type">int</span><span class="normal"> i</span><span class="symbol">;</span>

<span class="normal">         </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> num_palette</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">red </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_table</span><span class="symbol">[</span><span class="normal">palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">red</span><span class="symbol">];</span>
<span class="normal">            palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">green </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_table</span><span class="symbol">[</span><span class="normal">palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">green</span><span class="symbol">];</span>
<span class="normal">            palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">blue </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_table</span><span class="symbol">[</span><span class="normal">palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">blue</span><span class="symbol">];</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">   </span><span class="cbracket">}</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_BACKGROUND_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">else</span>
<span class="preproc">#endif</span>
<span class="preproc">#endif</span><span class="normal"> </span><span class="comment">/* PNG_READ_GAMMA_SUPPORTED &amp;&amp; PNG_FLOATING_POINT_SUPPORTED */</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_BACKGROUND_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="comment">/* No GAMMA transformation */</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">&amp;</span><span class="normal"> PNG_BACKGROUND</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span>
<span class="normal">       </span><span class="symbol">(</span><span class="normal">color_type </span><span class="symbol">==</span><span class="normal"> PNG_COLOR_TYPE_PALETTE</span><span class="symbol">))</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="type">int</span><span class="normal"> i</span><span class="symbol">;</span>
<span class="normal">      </span><span class="type">int</span><span class="normal"> istop </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="symbol">)</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">num_trans</span><span class="symbol">;</span>
<span class="normal">      </span><span class="usertype">png_color</span><span class="normal"> back</span><span class="symbol">;</span>
<span class="normal">      </span><span class="usertype">png_colorp</span><span class="normal"> palette </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">palette</span><span class="symbol">;</span>

<span class="normal">      back</span><span class="symbol">.</span><span class="normal">red   </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">red</span><span class="symbol">;</span>
<span class="normal">      back</span><span class="symbol">.</span><span class="normal">green </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">green</span><span class="symbol">;</span>
<span class="normal">      back</span><span class="symbol">.</span><span class="normal">blue  </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">blue</span><span class="symbol">;</span>

<span class="normal">      </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> istop</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">trans</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> back</span><span class="symbol">;</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">         </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">trans</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">)</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="comment">/* The png_composite() macro is defined in png.h */</span>
<span class="normal">            </span><span class="function">png_composite</span><span class="symbol">(</span><span class="normal">palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">red</span><span class="symbol">,</span><span class="normal"> palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">red</span><span class="symbol">,</span>
<span class="normal">               png_ptr</span><span class="symbol">-&gt;</span><span class="normal">trans</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">],</span><span class="normal"> back</span><span class="symbol">.</span><span class="normal">red</span><span class="symbol">);</span>
<span class="normal">            </span><span class="function">png_composite</span><span class="symbol">(</span><span class="normal">palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">green</span><span class="symbol">,</span><span class="normal"> palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">green</span><span class="symbol">,</span>
<span class="normal">               png_ptr</span><span class="symbol">-&gt;</span><span class="normal">trans</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">],</span><span class="normal"> back</span><span class="symbol">.</span><span class="normal">green</span><span class="symbol">);</span>
<span class="normal">            </span><span class="function">png_composite</span><span class="symbol">(</span><span class="normal">palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">blue</span><span class="symbol">,</span><span class="normal"> palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">blue</span><span class="symbol">,</span>
<span class="normal">               png_ptr</span><span class="symbol">-&gt;</span><span class="normal">trans</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">],</span><span class="normal"> back</span><span class="symbol">.</span><span class="normal">blue</span><span class="symbol">);</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">   </span><span class="cbracket">}</span>
<span class="preproc">#endif</span><span class="normal"> </span><span class="comment">/* PNG_READ_BACKGROUND_SUPPORTED */</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_SHIFT_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">&amp;</span><span class="normal"> PNG_SHIFT</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span>
<span class="normal">      </span><span class="symbol">(</span><span class="normal">color_type </span><span class="symbol">==</span><span class="normal"> PNG_COLOR_TYPE_PALETTE</span><span class="symbol">))</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="usertype">png_uint_16</span><span class="normal"> i</span><span class="symbol">;</span>
<span class="normal">      </span><span class="usertype">png_uint_16</span><span class="normal"> istop </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">num_palette</span><span class="symbol">;</span>
<span class="normal">      </span><span class="type">int</span><span class="normal"> sr </span><span class="symbol">=</span><span class="normal"> </span><span class="number">8</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">sig_bit</span><span class="symbol">.</span><span class="normal">red</span><span class="symbol">;</span>
<span class="normal">      </span><span class="type">int</span><span class="normal"> sg </span><span class="symbol">=</span><span class="normal"> </span><span class="number">8</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">sig_bit</span><span class="symbol">.</span><span class="normal">green</span><span class="symbol">;</span>
<span class="normal">      </span><span class="type">int</span><span class="normal"> sb </span><span class="symbol">=</span><span class="normal"> </span><span class="number">8</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">sig_bit</span><span class="symbol">.</span><span class="normal">blue</span><span class="symbol">;</span>

<span class="normal">      </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">sr </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">0</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> sr </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span>
<span class="normal">         sr </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">      </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">sg </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">0</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> sg </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span>
<span class="normal">         sg </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">      </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">sb </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">0</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> sb </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span>
<span class="normal">         sb </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">      </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> istop</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         png_ptr</span><span class="symbol">-&gt;</span><span class="normal">palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">red </span><span class="symbol">&gt;&gt;=</span><span class="normal"> sr</span><span class="symbol">;</span>
<span class="normal">         png_ptr</span><span class="symbol">-&gt;</span><span class="normal">palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">green </span><span class="symbol">&gt;&gt;=</span><span class="normal"> sg</span><span class="symbol">;</span>
<span class="normal">         png_ptr</span><span class="symbol">-&gt;</span><span class="normal">palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">blue </span><span class="symbol">&gt;&gt;=</span><span class="normal"> sb</span><span class="symbol">;</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">   </span><span class="cbracket">}</span>
<span class="preproc">#endif</span><span class="normal">  </span><span class="comment">/* PNG_READ_SHIFT_SUPPORTED */</span>
<span class="normal"> </span><span class="cbracket">}</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="symbol">!</span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_GAMMA_SUPPORTED</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">!</span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_SHIFT_SUPPORTED</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">!</span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_BACKGROUND_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">)</span>
<span class="normal">      </span><span class="keyword">return</span><span class="symbol">;</span>
<span class="preproc">#endif</span>
<span class="cbracket">}</span>

<span class="comment">/* Modify the info structure to reflect the transformations.  The</span>
<span class="comment"> * info should be updated so a PNG file could be written with it,</span>
<span class="comment"> * assuming the transformations result in valid PNG data.</span>
<span class="comment"> */</span>
<span class="type">void</span><span class="normal"> </span><span class="comment">/* PRIVATE */</span>
<span class="function">png_read_transform_info</span><span class="symbol">(</span><span class="usertype">png_structp</span><span class="normal"> png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">png_infop</span><span class="normal"> info_ptr</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">   </span><span class="function">png_debug</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"in png_read_transform_info</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_EXPAND_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">&amp;</span><span class="normal"> PNG_EXPAND</span><span class="symbol">)</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">info_ptr</span><span class="symbol">-&gt;</span><span class="normal">color_type </span><span class="symbol">==</span><span class="normal"> PNG_COLOR_TYPE_PALETTE</span><span class="symbol">)</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">num_trans </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">&amp;</span><span class="normal"> PNG_EXPAND_tRNS</span><span class="symbol">))</span>
<span class="normal">            info_ptr</span><span class="symbol">-&gt;</span><span class="normal">color_type </span><span class="symbol">=</span><span class="normal"> PNG_COLOR_TYPE_RGB_ALPHA</span><span class="symbol">;</span>
<span class="normal">         </span><span class="keyword">else</span>
<span class="normal">            info_ptr</span><span class="symbol">-&gt;</span><span class="normal">color_type </span><span class="symbol">=</span><span class="normal"> PNG_COLOR_TYPE_RGB</span><span class="symbol">;</span>
<span class="normal">         info_ptr</span><span class="symbol">-&gt;</span><span class="normal">bit_depth </span><span class="symbol">=</span><span class="normal"> </span><span class="number">8</span><span class="symbol">;</span>
<span class="normal">         info_ptr</span><span class="symbol">-&gt;</span><span class="normal">num_trans </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="keyword">else</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">num_trans</span><span class="symbol">)</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">&amp;</span><span class="normal"> PNG_EXPAND_tRNS</span><span class="symbol">)</span>
<span class="normal">              info_ptr</span><span class="symbol">-&gt;</span><span class="normal">color_type </span><span class="symbol">|=</span><span class="normal"> PNG_COLOR_MASK_ALPHA</span><span class="symbol">;</span>
<span class="normal">            </span><span class="keyword">else</span>
<span class="normal">              info_ptr</span><span class="symbol">-&gt;</span><span class="normal">color_type </span><span class="symbol">|=</span><span class="normal"> PNG_COLOR_MASK_COLOR</span><span class="symbol">;</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">         </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">info_ptr</span><span class="symbol">-&gt;</span><span class="normal">bit_depth </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span>
<span class="normal">            info_ptr</span><span class="symbol">-&gt;</span><span class="normal">bit_depth </span><span class="symbol">=</span><span class="normal"> </span><span class="number">8</span><span class="symbol">;</span>
<span class="normal">         info_ptr</span><span class="symbol">-&gt;</span><span class="normal">num_trans </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">   </span><span class="cbracket">}</span>
<span class="preproc">#endif</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_BACKGROUND_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">&amp;</span><span class="normal"> PNG_BACKGROUND</span><span class="symbol">)</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      info_ptr</span><span class="symbol">-&gt;</span><span class="normal">color_type </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="symbol">~</span><span class="normal">PNG_COLOR_MASK_ALPHA</span><span class="symbol">;</span>
<span class="normal">      info_ptr</span><span class="symbol">-&gt;</span><span class="normal">num_trans </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">      info_ptr</span><span class="symbol">-&gt;</span><span class="normal">background </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">;</span>
<span class="normal">   </span><span class="cbracket">}</span>
<span class="preproc">#endif</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_GAMMA_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">&amp;</span><span class="normal"> PNG_GAMMA</span><span class="symbol">)</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="preproc">#ifdef</span><span class="normal"> PNG_FLOATING_POINT_SUPPORTED</span>
<span class="normal">      info_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma</span><span class="symbol">;</span>
<span class="preproc">#endif</span>
<span class="preproc">#ifdef</span><span class="normal"> PNG_FIXED_POINT_SUPPORTED</span>
<span class="normal">      info_ptr</span><span class="symbol">-&gt;</span><span class="normal">int_gamma </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">int_gamma</span><span class="symbol">;</span>
<span class="preproc">#endif</span>
<span class="normal">   </span><span class="cbracket">}</span>
<span class="preproc">#endif</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_16_TO_8_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">&amp;</span><span class="normal"> PNG_16_TO_8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">info_ptr</span><span class="symbol">-&gt;</span><span class="normal">bit_depth </span><span class="symbol">==</span><span class="normal"> </span><span class="number">16</span><span class="symbol">))</span>
<span class="normal">      info_ptr</span><span class="symbol">-&gt;</span><span class="normal">bit_depth </span><span class="symbol">=</span><span class="normal"> </span><span class="number">8</span><span class="symbol">;</span>
<span class="preproc">#endif</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_GRAY_TO_RGB_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">&amp;</span><span class="normal"> PNG_GRAY_TO_RGB</span><span class="symbol">)</span>
<span class="normal">      info_ptr</span><span class="symbol">-&gt;</span><span class="normal">color_type </span><span class="symbol">|=</span><span class="normal"> PNG_COLOR_MASK_COLOR</span><span class="symbol">;</span>
<span class="preproc">#endif</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_RGB_TO_GRAY_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">&amp;</span><span class="normal"> PNG_RGB_TO_GRAY</span><span class="symbol">)</span>
<span class="normal">      info_ptr</span><span class="symbol">-&gt;</span><span class="normal">color_type </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="symbol">~</span><span class="normal">PNG_COLOR_MASK_COLOR</span><span class="symbol">;</span>
<span class="preproc">#endif</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_DITHER_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">&amp;</span><span class="normal"> PNG_DITHER</span><span class="symbol">)</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(((</span><span class="normal">info_ptr</span><span class="symbol">-&gt;</span><span class="normal">color_type </span><span class="symbol">==</span><span class="normal"> PNG_COLOR_TYPE_RGB</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">||</span>
<span class="normal">         </span><span class="symbol">(</span><span class="normal">info_ptr</span><span class="symbol">-&gt;</span><span class="normal">color_type </span><span class="symbol">==</span><span class="normal"> PNG_COLOR_TYPE_RGB_ALPHA</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span>
<span class="normal">         png_ptr</span><span class="symbol">-&gt;</span><span class="normal">palette_lookup </span><span class="symbol">&amp;&amp;</span><span class="normal"> info_ptr</span><span class="symbol">-&gt;</span><span class="normal">bit_depth </span><span class="symbol">==</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         info_ptr</span><span class="symbol">-&gt;</span><span class="normal">color_type </span><span class="symbol">=</span><span class="normal"> PNG_COLOR_TYPE_PALETTE</span><span class="symbol">;</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">   </span><span class="cbracket">}</span>
<span class="preproc">#endif</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_PACK_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">&amp;</span><span class="normal"> PNG_PACK</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">info_ptr</span><span class="symbol">-&gt;</span><span class="normal">bit_depth </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">))</span>
<span class="normal">      info_ptr</span><span class="symbol">-&gt;</span><span class="normal">bit_depth </span><span class="symbol">=</span><span class="normal"> </span><span class="number">8</span><span class="symbol">;</span>
<span class="preproc">#endif</span>

<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">info_ptr</span><span class="symbol">-&gt;</span><span class="normal">color_type </span><span class="symbol">==</span><span class="normal"> PNG_COLOR_TYPE_PALETTE</span><span class="symbol">)</span>
<span class="normal">      info_ptr</span><span class="symbol">-&gt;</span><span class="normal">channels </span><span class="symbol">=</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">   </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">info_ptr</span><span class="symbol">-&gt;</span><span class="normal">color_type </span><span class="symbol">&amp;</span><span class="normal"> PNG_COLOR_MASK_COLOR</span><span class="symbol">)</span>
<span class="normal">      info_ptr</span><span class="symbol">-&gt;</span><span class="normal">channels </span><span class="symbol">=</span><span class="normal"> </span><span class="number">3</span><span class="symbol">;</span>
<span class="normal">   </span><span class="keyword">else</span>
<span class="normal">      info_ptr</span><span class="symbol">-&gt;</span><span class="normal">channels </span><span class="symbol">=</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_STRIP_ALPHA_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">flags </span><span class="symbol">&amp;</span><span class="normal"> PNG_FLAG_STRIP_ALPHA</span><span class="symbol">)</span>
<span class="normal">      info_ptr</span><span class="symbol">-&gt;</span><span class="normal">color_type </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="symbol">~</span><span class="normal">PNG_COLOR_MASK_ALPHA</span><span class="symbol">;</span>
<span class="preproc">#endif</span>

<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">info_ptr</span><span class="symbol">-&gt;</span><span class="normal">color_type </span><span class="symbol">&amp;</span><span class="normal"> PNG_COLOR_MASK_ALPHA</span><span class="symbol">)</span>
<span class="normal">      info_ptr</span><span class="symbol">-&gt;</span><span class="normal">channels</span><span class="symbol">++;</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_FILLER_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="comment">/* STRIP_ALPHA and FILLER allowed:  MASK_ALPHA bit stripped above */</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">&amp;</span><span class="normal"> PNG_FILLER</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span>
<span class="normal">       </span><span class="symbol">((</span><span class="normal">info_ptr</span><span class="symbol">-&gt;</span><span class="normal">color_type </span><span class="symbol">==</span><span class="normal"> PNG_COLOR_TYPE_RGB</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">||</span>
<span class="normal">       </span><span class="symbol">(</span><span class="normal">info_ptr</span><span class="symbol">-&gt;</span><span class="normal">color_type </span><span class="symbol">==</span><span class="normal"> PNG_COLOR_TYPE_GRAY</span><span class="symbol">)))</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      info_ptr</span><span class="symbol">-&gt;</span><span class="normal">channels</span><span class="symbol">++;</span>
<span class="normal">      </span><span class="comment">/* if adding a true alpha channel not just filler */</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="symbol">!</span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_1_0_X</span><span class="symbol">)</span>
<span class="normal">      </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">&amp;</span><span class="normal"> PNG_ADD_ALPHA</span><span class="symbol">)</span>
<span class="normal">        info_ptr</span><span class="symbol">-&gt;</span><span class="normal">color_type </span><span class="symbol">|=</span><span class="normal"> PNG_COLOR_MASK_ALPHA</span><span class="symbol">;</span>
<span class="preproc">#endif</span>
<span class="normal">   </span><span class="cbracket">}</span>
<span class="preproc">#endif</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_USER_TRANSFORM_PTR_SUPPORTED</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">\</span>
<span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_USER_TRANSFORM_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">&amp;</span><span class="normal"> PNG_USER_TRANSFORM</span><span class="symbol">)</span>
<span class="normal">     </span><span class="cbracket">{</span>
<span class="normal">       </span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">info_ptr</span><span class="symbol">-&gt;</span><span class="normal">bit_depth </span><span class="symbol">&lt;</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">user_transform_depth</span><span class="symbol">)</span>
<span class="normal">         info_ptr</span><span class="symbol">-&gt;</span><span class="normal">bit_depth </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">user_transform_depth</span><span class="symbol">;</span>
<span class="normal">       </span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">info_ptr</span><span class="symbol">-&gt;</span><span class="normal">channels </span><span class="symbol">&lt;</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">user_transform_channels</span><span class="symbol">)</span>
<span class="normal">         info_ptr</span><span class="symbol">-&gt;</span><span class="normal">channels </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">user_transform_channels</span><span class="symbol">;</span>
<span class="normal">     </span><span class="cbracket">}</span>
<span class="preproc">#endif</span>

<span class="normal">   info_ptr</span><span class="symbol">-&gt;</span><span class="normal">pixel_depth </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">info_ptr</span><span class="symbol">-&gt;</span><span class="normal">channels </span><span class="symbol">*</span>
<span class="normal">      info_ptr</span><span class="symbol">-&gt;</span><span class="normal">bit_depth</span><span class="symbol">);</span>

<span class="normal">   info_ptr</span><span class="symbol">-&gt;</span><span class="normal">rowbytes </span><span class="symbol">=</span><span class="normal"> </span><span class="function">PNG_ROWBYTES</span><span class="symbol">(</span><span class="normal">info_ptr</span><span class="symbol">-&gt;</span><span class="normal">pixel_depth</span><span class="symbol">,</span><span class="normal">info_ptr</span><span class="symbol">-&gt;</span><span class="normal">width</span><span class="symbol">);</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="symbol">!</span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_EXPAND_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">)</span>
<span class="normal">      </span><span class="keyword">return</span><span class="symbol">;</span>
<span class="preproc">#endif</span>
<span class="cbracket">}</span>

<span class="comment">/* Transform the row.  The order of transformations is significant,</span>
<span class="comment"> * and is very touchy.  If you add a transformation, take care to</span>
<span class="comment"> * decide how it fits in with the other transformations here.</span>
<span class="comment"> */</span>
<span class="type">void</span><span class="normal"> </span><span class="comment">/* PRIVATE */</span>
<span class="function">png_do_read_transformations</span><span class="symbol">(</span><span class="usertype">png_structp</span><span class="normal"> png_ptr</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">   </span><span class="function">png_debug</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"in png_do_read_transformations</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="symbol">!</span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_USELESS_TESTS_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_buf </span><span class="symbol">==</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="symbol">!</span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_NO_STDIO</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">!</span><span class="function">defined</span><span class="symbol">(</span><span class="normal">_WIN32_WCE</span><span class="symbol">)</span>
<span class="normal">      </span><span class="type">char</span><span class="normal"> msg</span><span class="symbol">[</span><span class="number">50</span><span class="symbol">];</span>

<span class="normal">      </span><span class="function">sprintf</span><span class="symbol">(</span><span class="normal">msg</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"NULL row buffer for row %ld, pass %d"</span><span class="symbol">,</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_number</span><span class="symbol">,</span>
<span class="normal">         png_ptr</span><span class="symbol">-&gt;</span><span class="normal">pass</span><span class="symbol">);</span>
<span class="normal">      </span><span class="function">png_error</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> msg</span><span class="symbol">);</span>
<span class="preproc">#else</span>
<span class="normal">      </span><span class="function">png_error</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"NULL row buffer"</span><span class="symbol">);</span>
<span class="preproc">#endif</span>
<span class="normal">   </span><span class="cbracket">}</span>
<span class="preproc">#endif</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_EXPAND_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">&amp;</span><span class="normal"> PNG_EXPAND</span><span class="symbol">)</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_info</span><span class="symbol">.</span><span class="normal">color_type </span><span class="symbol">==</span><span class="normal"> PNG_COLOR_TYPE_PALETTE</span><span class="symbol">)</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         </span><span class="function">png_do_expand_palette</span><span class="symbol">(&amp;(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_info</span><span class="symbol">),</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_buf </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span>
<span class="normal">            png_ptr</span><span class="symbol">-&gt;</span><span class="normal">palette</span><span class="symbol">,</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">trans</span><span class="symbol">,</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">num_trans</span><span class="symbol">);</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="keyword">else</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">num_trans </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">&amp;</span><span class="normal"> PNG_EXPAND_tRNS</span><span class="symbol">))</span>
<span class="normal">            </span><span class="function">png_do_expand</span><span class="symbol">(&amp;(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_info</span><span class="symbol">),</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_buf </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span>
<span class="normal">               </span><span class="symbol">&amp;(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">trans_values</span><span class="symbol">));</span>
<span class="normal">         </span><span class="keyword">else</span>
<span class="normal">            </span><span class="function">png_do_expand</span><span class="symbol">(&amp;(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_info</span><span class="symbol">),</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_buf </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span>
<span class="normal">               NULL</span><span class="symbol">);</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">   </span><span class="cbracket">}</span>
<span class="preproc">#endif</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_STRIP_ALPHA_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">flags </span><span class="symbol">&amp;</span><span class="normal"> PNG_FLAG_STRIP_ALPHA</span><span class="symbol">)</span>
<span class="normal">      </span><span class="function">png_do_strip_filler</span><span class="symbol">(&amp;(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_info</span><span class="symbol">),</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_buf </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span>
<span class="normal">         PNG_FLAG_FILLER_AFTER </span><span class="symbol">|</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">flags </span><span class="symbol">&amp;</span><span class="normal"> PNG_FLAG_STRIP_ALPHA</span><span class="symbol">));</span>
<span class="preproc">#endif</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_RGB_TO_GRAY_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">&amp;</span><span class="normal"> PNG_RGB_TO_GRAY</span><span class="symbol">)</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="type">int</span><span class="normal"> rgb_error </span><span class="symbol">=</span>
<span class="normal">         </span><span class="function">png_do_rgb_to_gray</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">&amp;(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_info</span><span class="symbol">),</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_buf </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">      </span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">rgb_error</span><span class="symbol">)</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         png_ptr</span><span class="symbol">-&gt;</span><span class="normal">rgb_to_gray_status</span><span class="symbol">=</span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">         </span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">==</span><span class="normal"> PNG_RGB_TO_GRAY_WARN</span><span class="symbol">)</span>
<span class="normal">            </span><span class="function">png_warning</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"png_do_rgb_to_gray found nongray pixel"</span><span class="symbol">);</span>
<span class="normal">         </span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">==</span><span class="normal"> PNG_RGB_TO_GRAY_ERR</span><span class="symbol">)</span>
<span class="normal">            </span><span class="function">png_error</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"png_do_rgb_to_gray found nongray pixel"</span><span class="symbol">);</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">   </span><span class="cbracket">}</span>
<span class="preproc">#endif</span>

<span class="comment">/*</span>
<span class="comment">From Andreas Dilger e-mail to png-implement, 26 March 1998:</span>

<span class="comment">  In most cases, the "simple transparency" should be done prior to doing</span>
<span class="comment">  gray-to-RGB, or you will have to test 3x as many bytes to check if a</span>
<span class="comment">  pixel is transparent.  You would also need to make sure that the</span>
<span class="comment">  transparency information is upgraded to RGB.</span>

<span class="comment">  To summarize, the current flow is:</span>
<span class="comment">  - Gray + simple transparency -&gt; compare 1 or 2 gray bytes and composite</span>
<span class="comment">                                  with background "in place" if transparent,</span>
<span class="comment">                                  convert to RGB if necessary</span>
<span class="comment">  - Gray + alpha -&gt; composite with gray background and remove alpha bytes,</span>
<span class="comment">                                  convert to RGB if necessary</span>

<span class="comment">  To support RGB backgrounds for gray images we need:</span>
<span class="comment">  - Gray + simple transparency -&gt; convert to RGB + simple transparency, compare</span>
<span class="comment">                                  3 or 6 bytes and composite with background</span>
<span class="comment">                                  "in place" if transparent (3x compare/pixel</span>
<span class="comment">                                  compared to doing composite with gray bkgrnd)</span>
<span class="comment">  - Gray + alpha -&gt; convert to RGB + alpha, composite with background and</span>
<span class="comment">                                  remove alpha bytes (3x float operations/pixel</span>
<span class="comment">                                  compared with composite on gray background)</span>

<span class="comment">  Greg's change will do this.  The reason it wasn't done before is for</span>
<span class="comment">  performance, as this increases the per-pixel operations.  If we would check</span>
<span class="comment">  in advance if the background was gray or RGB, and position the gray-to-RGB</span>
<span class="comment">  transform appropriately, then it would save a lot of work/time.</span>
<span class="comment"> */</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_GRAY_TO_RGB_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="comment">/* if gray -&gt; RGB, do so now only if background is non-gray; else do later</span>
<span class="comment">    * for performance reasons */</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">&amp;</span><span class="normal"> PNG_GRAY_TO_RGB</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span>
<span class="normal">       </span><span class="symbol">!(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">mode </span><span class="symbol">&amp;</span><span class="normal"> PNG_BACKGROUND_IS_GRAY</span><span class="symbol">))</span>
<span class="normal">      </span><span class="function">png_do_gray_to_rgb</span><span class="symbol">(&amp;(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_info</span><span class="symbol">),</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_buf </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="preproc">#endif</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_BACKGROUND_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">&amp;</span><span class="normal"> PNG_BACKGROUND</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span>
<span class="normal">      </span><span class="symbol">((</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">num_trans </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="normal"> </span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">||</span>
<span class="normal">      </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">color_type </span><span class="symbol">&amp;</span><span class="normal"> PNG_COLOR_MASK_ALPHA</span><span class="symbol">)))</span>
<span class="normal">      </span><span class="function">png_do_background</span><span class="symbol">(&amp;(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_info</span><span class="symbol">),</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_buf </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span>
<span class="normal">         </span><span class="symbol">&amp;(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">trans_values</span><span class="symbol">),</span><span class="normal"> </span><span class="symbol">&amp;(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">)</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_GAMMA_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">         </span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">&amp;(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background_1</span><span class="symbol">),</span>
<span class="normal">         png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_table</span><span class="symbol">,</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_from_1</span><span class="symbol">,</span>
<span class="normal">         png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_to_1</span><span class="symbol">,</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_16_table</span><span class="symbol">,</span>
<span class="normal">         png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_16_from_1</span><span class="symbol">,</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_16_to_1</span><span class="symbol">,</span>
<span class="normal">         png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_shift</span>
<span class="preproc">#endif</span>
<span class="symbol">);</span>
<span class="preproc">#endif</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_GAMMA_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">&amp;</span><span class="normal"> PNG_GAMMA</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_BACKGROUND_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">      </span><span class="symbol">!((</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">&amp;</span><span class="normal"> PNG_BACKGROUND</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span>
<span class="normal">      </span><span class="symbol">((</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">num_trans </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">||</span>
<span class="normal">      </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">color_type </span><span class="symbol">&amp;</span><span class="normal"> PNG_COLOR_MASK_ALPHA</span><span class="symbol">)))</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span>
<span class="preproc">#endif</span>
<span class="normal">      </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">color_type </span><span class="symbol">!=</span><span class="normal"> PNG_COLOR_TYPE_PALETTE</span><span class="symbol">))</span>
<span class="normal">      </span><span class="function">png_do_gamma</span><span class="symbol">(&amp;(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_info</span><span class="symbol">),</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_buf </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span>
<span class="normal">         png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_table</span><span class="symbol">,</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_16_table</span><span class="symbol">,</span>
<span class="normal">         png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_shift</span><span class="symbol">);</span>
<span class="preproc">#endif</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_16_TO_8_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">&amp;</span><span class="normal"> PNG_16_TO_8</span><span class="symbol">)</span>
<span class="normal">      </span><span class="function">png_do_chop</span><span class="symbol">(&amp;(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_info</span><span class="symbol">),</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_buf </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="preproc">#endif</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_DITHER_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">&amp;</span><span class="normal"> PNG_DITHER</span><span class="symbol">)</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="function">png_do_dither</span><span class="symbol">((</span><span class="normal">png_row_infop</span><span class="symbol">)&amp;(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_info</span><span class="symbol">),</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_buf </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span>
<span class="normal">         png_ptr</span><span class="symbol">-&gt;</span><span class="normal">palette_lookup</span><span class="symbol">,</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">dither_index</span><span class="symbol">);</span>
<span class="normal">      </span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_info</span><span class="symbol">.</span><span class="normal">rowbytes </span><span class="symbol">==</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_32</span><span class="symbol">)</span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">         </span><span class="function">png_error</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"png_do_dither returned rowbytes=0"</span><span class="symbol">);</span>
<span class="normal">   </span><span class="cbracket">}</span>
<span class="preproc">#endif</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_INVERT_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">&amp;</span><span class="normal"> PNG_INVERT_MONO</span><span class="symbol">)</span>
<span class="normal">      </span><span class="function">png_do_invert</span><span class="symbol">(&amp;(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_info</span><span class="symbol">),</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_buf </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="preproc">#endif</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_SHIFT_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">&amp;</span><span class="normal"> PNG_SHIFT</span><span class="symbol">)</span>
<span class="normal">      </span><span class="function">png_do_unshift</span><span class="symbol">(&amp;(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_info</span><span class="symbol">),</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_buf </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span>
<span class="normal">         </span><span class="symbol">&amp;(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">shift</span><span class="symbol">));</span>
<span class="preproc">#endif</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_PACK_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">&amp;</span><span class="normal"> PNG_PACK</span><span class="symbol">)</span>
<span class="normal">      </span><span class="function">png_do_unpack</span><span class="symbol">(&amp;(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_info</span><span class="symbol">),</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_buf </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="preproc">#endif</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_BGR_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">&amp;</span><span class="normal"> PNG_BGR</span><span class="symbol">)</span>
<span class="normal">      </span><span class="function">png_do_bgr</span><span class="symbol">(&amp;(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_info</span><span class="symbol">),</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_buf </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="preproc">#endif</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_PACKSWAP_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">&amp;</span><span class="normal"> PNG_PACKSWAP</span><span class="symbol">)</span>
<span class="normal">      </span><span class="function">png_do_packswap</span><span class="symbol">(&amp;(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_info</span><span class="symbol">),</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_buf </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="preproc">#endif</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_GRAY_TO_RGB_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="comment">/* if gray -&gt; RGB, do so now only if we did not do so above */</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">&amp;</span><span class="normal"> PNG_GRAY_TO_RGB</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span>
<span class="normal">       </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">mode </span><span class="symbol">&amp;</span><span class="normal"> PNG_BACKGROUND_IS_GRAY</span><span class="symbol">))</span>
<span class="normal">      </span><span class="function">png_do_gray_to_rgb</span><span class="symbol">(&amp;(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_info</span><span class="symbol">),</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_buf </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="preproc">#endif</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_FILLER_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">&amp;</span><span class="normal"> PNG_FILLER</span><span class="symbol">)</span>
<span class="normal">      </span><span class="function">png_do_read_filler</span><span class="symbol">(&amp;(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_info</span><span class="symbol">),</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_buf </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span>
<span class="normal">         </span><span class="symbol">(</span><span class="normal">png_uint_32</span><span class="symbol">)</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">filler</span><span class="symbol">,</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">flags</span><span class="symbol">);</span>
<span class="preproc">#endif</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_INVERT_ALPHA_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">&amp;</span><span class="normal"> PNG_INVERT_ALPHA</span><span class="symbol">)</span>
<span class="normal">      </span><span class="function">png_do_read_invert_alpha</span><span class="symbol">(&amp;(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_info</span><span class="symbol">),</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_buf </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="preproc">#endif</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_SWAP_ALPHA_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">&amp;</span><span class="normal"> PNG_SWAP_ALPHA</span><span class="symbol">)</span>
<span class="normal">      </span><span class="function">png_do_read_swap_alpha</span><span class="symbol">(&amp;(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_info</span><span class="symbol">),</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_buf </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="preproc">#endif</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_SWAP_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">&amp;</span><span class="normal"> PNG_SWAP_BYTES</span><span class="symbol">)</span>
<span class="normal">      </span><span class="function">png_do_swap</span><span class="symbol">(&amp;(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_info</span><span class="symbol">),</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_buf </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="preproc">#endif</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_USER_TRANSFORM_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">&amp;</span><span class="normal"> PNG_USER_TRANSFORM</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">read_user_transform_fn </span><span class="symbol">!=</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">        </span><span class="symbol">(*(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">read_user_transform_fn</span><span class="symbol">))</span><span class="normal"> </span><span class="comment">/* user read transform function */</span>
<span class="normal">          </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span><span class="normal">                    </span><span class="comment">/* png_ptr */</span>
<span class="normal">           </span><span class="symbol">&amp;(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_info</span><span class="symbol">),</span><span class="normal">       </span><span class="comment">/* row_info:     */</span>
<span class="normal">             </span><span class="comment">/*  png_uint_32 width;          width of row */</span>
<span class="normal">             </span><span class="comment">/*  png_uint_32 rowbytes;       number of bytes in row */</span>
<span class="normal">             </span><span class="comment">/*  png_byte color_type;        color type of pixels */</span>
<span class="normal">             </span><span class="comment">/*  png_byte bit_depth;         bit depth of samples */</span>
<span class="normal">             </span><span class="comment">/*  png_byte channels;          number of channels (1-4) */</span>
<span class="normal">             </span><span class="comment">/*  png_byte pixel_depth;       bits per pixel (depth*channels) */</span>
<span class="normal">           png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_buf </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span><span class="normal">      </span><span class="comment">/* start of pixel data for row */</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_USER_TRANSFORM_PTR_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">      </span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">user_transform_depth</span><span class="symbol">)</span>
<span class="normal">         png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_info</span><span class="symbol">.</span><span class="normal">bit_depth </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">user_transform_depth</span><span class="symbol">;</span>
<span class="normal">      </span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">user_transform_channels</span><span class="symbol">)</span>
<span class="normal">         png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_info</span><span class="symbol">.</span><span class="normal">channels </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">user_transform_channels</span><span class="symbol">;</span>
<span class="preproc">#endif</span>
<span class="normal">      png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_info</span><span class="symbol">.</span><span class="normal">pixel_depth </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_info</span><span class="symbol">.</span><span class="normal">bit_depth </span><span class="symbol">*</span>
<span class="normal">         png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_info</span><span class="symbol">.</span><span class="normal">channels</span><span class="symbol">);</span>
<span class="normal">      png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_info</span><span class="symbol">.</span><span class="normal">rowbytes </span><span class="symbol">=</span><span class="normal"> </span><span class="function">PNG_ROWBYTES</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_info</span><span class="symbol">.</span><span class="normal">pixel_depth</span><span class="symbol">,</span>
<span class="normal">         png_ptr</span><span class="symbol">-&gt;</span><span class="normal">row_info</span><span class="symbol">.</span><span class="normal">width</span><span class="symbol">);</span>
<span class="normal">   </span><span class="cbracket">}</span>
<span class="preproc">#endif</span>

<span class="cbracket">}</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_PACK_SUPPORTED</span><span class="symbol">)</span>
<span class="comment">/* Unpack pixels of 1, 2, or 4 bits per pixel into 1 byte per pixel,</span>
<span class="comment"> * without changing the actual values.  Thus, if you had a row with</span>
<span class="comment"> * a bit depth of 1, you would end up with bytes that only contained</span>
<span class="comment"> * the numbers 0 or 1.  If you would rather they contain 0 and 255, use</span>
<span class="comment"> * png_do_shift() after this.</span>
<span class="comment"> */</span>
<span class="type">void</span><span class="normal"> </span><span class="comment">/* PRIVATE */</span>
<span class="function">png_do_unpack</span><span class="symbol">(</span><span class="usertype">png_row_infop</span><span class="normal"> row_info</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">png_bytep</span><span class="normal"> row</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">   </span><span class="function">png_debug</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"in png_do_unpack</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_USELESS_TESTS_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row </span><span class="symbol">!=</span><span class="normal"> NULL </span><span class="symbol">&amp;&amp;</span><span class="normal"> row_info </span><span class="symbol">!=</span><span class="normal"> NULL </span><span class="symbol">&amp;&amp;</span><span class="normal"> row_info</span><span class="symbol">-&gt;</span><span class="normal">bit_depth </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span>
<span class="preproc">#else</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">bit_depth </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span>
<span class="preproc">#endif</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="usertype">png_uint_32</span><span class="normal"> i</span><span class="symbol">;</span>
<span class="normal">      </span><span class="usertype">png_uint_32</span><span class="normal"> row_width</span><span class="symbol">=</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">width</span><span class="symbol">;</span>

<span class="normal">      </span><span class="keyword">switch</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">bit_depth</span><span class="symbol">)</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         </span><span class="keyword">case</span><span class="normal"> </span><span class="number">1</span><span class="symbol">:</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> sp </span><span class="symbol">=</span><span class="normal"> row </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_size_t</span><span class="symbol">)((</span><span class="normal">row_width </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">3</span><span class="symbol">);</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> dp </span><span class="symbol">=</span><span class="normal"> row </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_size_t</span><span class="symbol">)</span><span class="normal">row_width </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_uint_32</span><span class="normal"> shift </span><span class="symbol">=</span><span class="normal"> </span><span class="number">7</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="symbol">)((</span><span class="normal">row_width </span><span class="symbol">+</span><span class="normal"> </span><span class="number">7</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x07</span><span class="symbol">);</span>
<span class="normal">            </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="symbol">*</span><span class="normal">dp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((*</span><span class="normal">sp </span><span class="symbol">&gt;&gt;</span><span class="normal"> shift</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x01</span><span class="symbol">);</span>
<span class="normal">               </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">shift </span><span class="symbol">==</span><span class="normal"> </span><span class="number">7</span><span class="symbol">)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  shift </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">                  sp</span><span class="symbol">--;</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="keyword">else</span>
<span class="normal">                  shift</span><span class="symbol">++;</span>

<span class="normal">               dp</span><span class="symbol">--;</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">         </span><span class="keyword">case</span><span class="normal"> </span><span class="number">2</span><span class="symbol">:</span>
<span class="normal">         </span><span class="cbracket">{</span>

<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> sp </span><span class="symbol">=</span><span class="normal"> row </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_size_t</span><span class="symbol">)((</span><span class="normal">row_width </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">2</span><span class="symbol">);</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> dp </span><span class="symbol">=</span><span class="normal"> row </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_size_t</span><span class="symbol">)</span><span class="normal">row_width </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_uint_32</span><span class="normal"> shift </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="symbol">)((</span><span class="number">3</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">row_width </span><span class="symbol">+</span><span class="normal"> </span><span class="number">3</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x03</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">            </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="symbol">*</span><span class="normal">dp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((*</span><span class="normal">sp </span><span class="symbol">&gt;&gt;</span><span class="normal"> shift</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x03</span><span class="symbol">);</span>
<span class="normal">               </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">shift </span><span class="symbol">==</span><span class="normal"> </span><span class="number">6</span><span class="symbol">)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  shift </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">                  sp</span><span class="symbol">--;</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="keyword">else</span>
<span class="normal">                  shift </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>

<span class="normal">               dp</span><span class="symbol">--;</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">         </span><span class="keyword">case</span><span class="normal"> </span><span class="number">4</span><span class="symbol">:</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> sp </span><span class="symbol">=</span><span class="normal"> row </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_size_t</span><span class="symbol">)((</span><span class="normal">row_width </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> dp </span><span class="symbol">=</span><span class="normal"> row </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_size_t</span><span class="symbol">)</span><span class="normal">row_width </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_uint_32</span><span class="normal"> shift </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="symbol">)((</span><span class="number">1</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">row_width </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x01</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">2</span><span class="symbol">);</span>
<span class="normal">            </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="symbol">*</span><span class="normal">dp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((*</span><span class="normal">sp </span><span class="symbol">&gt;&gt;</span><span class="normal"> shift</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x0f</span><span class="symbol">);</span>
<span class="normal">               </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">shift </span><span class="symbol">==</span><span class="normal"> </span><span class="number">4</span><span class="symbol">)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  shift </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">                  sp</span><span class="symbol">--;</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="keyword">else</span>
<span class="normal">                  shift </span><span class="symbol">=</span><span class="normal"> </span><span class="number">4</span><span class="symbol">;</span>

<span class="normal">               dp</span><span class="symbol">--;</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">      row_info</span><span class="symbol">-&gt;</span><span class="normal">bit_depth </span><span class="symbol">=</span><span class="normal"> </span><span class="number">8</span><span class="symbol">;</span>
<span class="normal">      row_info</span><span class="symbol">-&gt;</span><span class="normal">pixel_depth </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="number">8</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> row_info</span><span class="symbol">-&gt;</span><span class="normal">channels</span><span class="symbol">);</span>
<span class="normal">      row_info</span><span class="symbol">-&gt;</span><span class="normal">rowbytes </span><span class="symbol">=</span><span class="normal"> row_width </span><span class="symbol">*</span><span class="normal"> row_info</span><span class="symbol">-&gt;</span><span class="normal">channels</span><span class="symbol">;</span>
<span class="normal">   </span><span class="cbracket">}</span>
<span class="cbracket">}</span>
<span class="preproc">#endif</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_SHIFT_SUPPORTED</span><span class="symbol">)</span>
<span class="comment">/* Reverse the effects of png_do_shift.  This routine merely shifts the</span>
<span class="comment"> * pixels back to their significant bits values.  Thus, if you have</span>
<span class="comment"> * a row of bit depth 8, but only 5 are significant, this will shift</span>
<span class="comment"> * the values back to 0 through 31.</span>
<span class="comment"> */</span>
<span class="type">void</span><span class="normal"> </span><span class="comment">/* PRIVATE */</span>
<span class="function">png_do_unshift</span><span class="symbol">(</span><span class="usertype">png_row_infop</span><span class="normal"> row_info</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">png_bytep</span><span class="normal"> row</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">png_color_8p</span><span class="normal"> sig_bits</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">   </span><span class="function">png_debug</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"in png_do_unshift</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_USELESS_TESTS_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">       row </span><span class="symbol">!=</span><span class="normal"> NULL </span><span class="symbol">&amp;&amp;</span><span class="normal"> row_info </span><span class="symbol">!=</span><span class="normal"> NULL </span><span class="symbol">&amp;&amp;</span><span class="normal"> sig_bits </span><span class="symbol">!=</span><span class="normal"> NULL </span><span class="symbol">&amp;&amp;</span>
<span class="preproc">#endif</span>
<span class="normal">       row_info</span><span class="symbol">-&gt;</span><span class="normal">color_type </span><span class="symbol">!=</span><span class="normal"> PNG_COLOR_TYPE_PALETTE</span><span class="symbol">)</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="type">int</span><span class="normal"> shift</span><span class="symbol">[</span><span class="number">4</span><span class="symbol">];</span>
<span class="normal">      </span><span class="type">int</span><span class="normal"> channels </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">      </span><span class="type">int</span><span class="normal"> c</span><span class="symbol">;</span>
<span class="normal">      </span><span class="usertype">png_uint_16</span><span class="normal"> value </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">      </span><span class="usertype">png_uint_32</span><span class="normal"> row_width </span><span class="symbol">=</span><span class="normal"> row_info</span><span class="symbol">-&gt;</span><span class="normal">width</span><span class="symbol">;</span>

<span class="normal">      </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">color_type </span><span class="symbol">&amp;</span><span class="normal"> PNG_COLOR_MASK_COLOR</span><span class="symbol">)</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         shift</span><span class="symbol">[</span><span class="normal">channels</span><span class="symbol">++]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> row_info</span><span class="symbol">-&gt;</span><span class="normal">bit_depth </span><span class="symbol">-</span><span class="normal"> sig_bits</span><span class="symbol">-&gt;</span><span class="normal">red</span><span class="symbol">;</span>
<span class="normal">         shift</span><span class="symbol">[</span><span class="normal">channels</span><span class="symbol">++]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> row_info</span><span class="symbol">-&gt;</span><span class="normal">bit_depth </span><span class="symbol">-</span><span class="normal"> sig_bits</span><span class="symbol">-&gt;</span><span class="normal">green</span><span class="symbol">;</span>
<span class="normal">         shift</span><span class="symbol">[</span><span class="normal">channels</span><span class="symbol">++]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> row_info</span><span class="symbol">-&gt;</span><span class="normal">bit_depth </span><span class="symbol">-</span><span class="normal"> sig_bits</span><span class="symbol">-&gt;</span><span class="normal">blue</span><span class="symbol">;</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="keyword">else</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         shift</span><span class="symbol">[</span><span class="normal">channels</span><span class="symbol">++]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> row_info</span><span class="symbol">-&gt;</span><span class="normal">bit_depth </span><span class="symbol">-</span><span class="normal"> sig_bits</span><span class="symbol">-&gt;</span><span class="normal">gray</span><span class="symbol">;</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">color_type </span><span class="symbol">&amp;</span><span class="normal"> PNG_COLOR_MASK_ALPHA</span><span class="symbol">)</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         shift</span><span class="symbol">[</span><span class="normal">channels</span><span class="symbol">++]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> row_info</span><span class="symbol">-&gt;</span><span class="normal">bit_depth </span><span class="symbol">-</span><span class="normal"> sig_bits</span><span class="symbol">-&gt;</span><span class="normal">alpha</span><span class="symbol">;</span>
<span class="normal">      </span><span class="cbracket">}</span>

<span class="normal">      </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">c </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> c </span><span class="symbol">&lt;</span><span class="normal"> channels</span><span class="symbol">;</span><span class="normal"> c</span><span class="symbol">++)</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">shift</span><span class="symbol">[</span><span class="normal">c</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">&lt;=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">            shift</span><span class="symbol">[</span><span class="normal">c</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">         </span><span class="keyword">else</span>
<span class="normal">            value </span><span class="symbol">=</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">      </span><span class="cbracket">}</span>

<span class="normal">      </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">value</span><span class="symbol">)</span>
<span class="normal">         </span><span class="keyword">return</span><span class="symbol">;</span>

<span class="normal">      </span><span class="keyword">switch</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">bit_depth</span><span class="symbol">)</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         </span><span class="keyword">case</span><span class="normal"> </span><span class="number">2</span><span class="symbol">:</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> bp</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_uint_32</span><span class="normal"> i</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_uint_32</span><span class="normal"> istop </span><span class="symbol">=</span><span class="normal"> row_info</span><span class="symbol">-&gt;</span><span class="normal">rowbytes</span><span class="symbol">;</span>

<span class="normal">            </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">bp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">,</span><span class="normal"> i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> istop</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="symbol">*</span><span class="normal">bp </span><span class="symbol">&gt;&gt;=</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">               </span><span class="symbol">*</span><span class="normal">bp</span><span class="symbol">++</span><span class="normal"> </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="number">0x55</span><span class="symbol">;</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">         </span><span class="keyword">case</span><span class="normal"> </span><span class="number">4</span><span class="symbol">:</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> bp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_uint_32</span><span class="normal"> i</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_uint_32</span><span class="normal"> istop </span><span class="symbol">=</span><span class="normal"> row_info</span><span class="symbol">-&gt;</span><span class="normal">rowbytes</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_byte</span><span class="normal"> mask </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((((</span><span class="type">int</span><span class="symbol">)</span><span class="number">0xf0</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> shift</span><span class="symbol">[</span><span class="number">0</span><span class="symbol">])</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="symbol">)</span><span class="number">0xf0</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">|</span>
<span class="normal">               </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((</span><span class="type">int</span><span class="symbol">)</span><span class="number">0xf</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> shift</span><span class="symbol">[</span><span class="number">0</span><span class="symbol">]));</span>

<span class="normal">            </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> istop</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="symbol">*</span><span class="normal">bp </span><span class="symbol">&gt;&gt;=</span><span class="normal"> shift</span><span class="symbol">[</span><span class="number">0</span><span class="symbol">];</span>
<span class="normal">               </span><span class="symbol">*</span><span class="normal">bp</span><span class="symbol">++</span><span class="normal"> </span><span class="symbol">&amp;=</span><span class="normal"> mask</span><span class="symbol">;</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">         </span><span class="keyword">case</span><span class="normal"> </span><span class="number">8</span><span class="symbol">:</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> bp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_uint_32</span><span class="normal"> i</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_uint_32</span><span class="normal"> istop </span><span class="symbol">=</span><span class="normal"> row_width </span><span class="symbol">*</span><span class="normal"> channels</span><span class="symbol">;</span>

<span class="normal">            </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> istop</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="symbol">*</span><span class="normal">bp</span><span class="symbol">++</span><span class="normal"> </span><span class="symbol">&gt;&gt;=</span><span class="normal"> shift</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">%</span><span class="normal">channels</span><span class="symbol">];</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">         </span><span class="keyword">case</span><span class="normal"> </span><span class="number">16</span><span class="symbol">:</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> bp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_uint_32</span><span class="normal"> i</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_uint_32</span><span class="normal"> istop </span><span class="symbol">=</span><span class="normal"> channels </span><span class="symbol">*</span><span class="normal"> row_width</span><span class="symbol">;</span>

<span class="normal">            </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> istop</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               value </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)((*</span><span class="normal">bp </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">bp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">));</span>
<span class="normal">               value </span><span class="symbol">&gt;&gt;=</span><span class="normal"> shift</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">%</span><span class="normal">channels</span><span class="symbol">];</span>
<span class="normal">               </span><span class="symbol">*</span><span class="normal">bp</span><span class="symbol">++</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">value </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">);</span>
<span class="normal">               </span><span class="symbol">*</span><span class="normal">bp</span><span class="symbol">++</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">value </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">   </span><span class="cbracket">}</span>
<span class="cbracket">}</span>
<span class="preproc">#endif</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_16_TO_8_SUPPORTED</span><span class="symbol">)</span>
<span class="comment">/* chop rows of bit depth 16 down to 8 */</span>
<span class="type">void</span><span class="normal"> </span><span class="comment">/* PRIVATE */</span>
<span class="function">png_do_chop</span><span class="symbol">(</span><span class="usertype">png_row_infop</span><span class="normal"> row_info</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">png_bytep</span><span class="normal"> row</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">   </span><span class="function">png_debug</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"in png_do_chop</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_USELESS_TESTS_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row </span><span class="symbol">!=</span><span class="normal"> NULL </span><span class="symbol">&amp;&amp;</span><span class="normal"> row_info </span><span class="symbol">!=</span><span class="normal"> NULL </span><span class="symbol">&amp;&amp;</span><span class="normal"> row_info</span><span class="symbol">-&gt;</span><span class="normal">bit_depth </span><span class="symbol">==</span><span class="normal"> </span><span class="number">16</span><span class="symbol">)</span>
<span class="preproc">#else</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">bit_depth </span><span class="symbol">==</span><span class="normal"> </span><span class="number">16</span><span class="symbol">)</span>
<span class="preproc">#endif</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="usertype">png_bytep</span><span class="normal"> sp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">      </span><span class="usertype">png_bytep</span><span class="normal"> dp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">      </span><span class="usertype">png_uint_32</span><span class="normal"> i</span><span class="symbol">;</span>
<span class="normal">      </span><span class="usertype">png_uint_32</span><span class="normal"> istop </span><span class="symbol">=</span><span class="normal"> row_info</span><span class="symbol">-&gt;</span><span class="normal">width </span><span class="symbol">*</span><span class="normal"> row_info</span><span class="symbol">-&gt;</span><span class="normal">channels</span><span class="symbol">;</span>

<span class="normal">      </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">&lt;</span><span class="normal">istop</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++,</span><span class="normal"> sp </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">,</span><span class="normal"> dp</span><span class="symbol">++)</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_16_TO_8_ACCURATE_SCALE_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">      </span><span class="comment">/* This does a more accurate scaling of the 16-bit color</span>
<span class="comment">       * value, rather than a simple low-byte truncation.</span>
<span class="comment">       *</span>
<span class="comment">       * What the ideal calculation should be:</span>
<span class="comment">       *   *dp = (((((png_uint_32)(*sp) &lt;&lt; 8) |</span>
<span class="comment">       *          (png_uint_32)(*(sp + 1))) * 255 + 127) / (png_uint_32)65535L;</span>
<span class="comment">       *</span>
<span class="comment">       * GRR: no, I think this is what it really should be:</span>
<span class="comment">       *   *dp = (((((png_uint_32)(*sp) &lt;&lt; 8) |</span>
<span class="comment">       *           (png_uint_32)(*(sp + 1))) + 128L) / (png_uint_32)257L;</span>
<span class="comment">       *</span>
<span class="comment">       * GRR: here's the exact calculation with shifts:</span>
<span class="comment">       *   temp = (((png_uint_32)(*sp) &lt;&lt; 8) | (png_uint_32)(*(sp + 1))) + 128L;</span>
<span class="comment">       *   *dp = (temp - (temp &gt;&gt; 8)) &gt;&gt; 8;</span>
<span class="comment">       *</span>
<span class="comment">       * Approximate calculation with shift/add instead of multiply/divide:</span>
<span class="comment">       *   *dp = ((((png_uint_32)(*sp) &lt;&lt; 8) |</span>
<span class="comment">       *          (png_uint_32)((int)(*(sp + 1)) - *sp)) + 128) &gt;&gt; 8;</span>
<span class="comment">       *</span>
<span class="comment">       * What we actually do to avoid extra shifting and conversion:</span>
<span class="comment">       */</span>

<span class="normal">         </span><span class="symbol">*</span><span class="normal">dp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">((((</span><span class="type">int</span><span class="symbol">)(*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">sp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">128</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">?</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">:</span><span class="normal"> </span><span class="number">0</span><span class="symbol">);</span>
<span class="preproc">#else</span>
<span class="normal">       </span><span class="comment">/* Simply discard the low order byte */</span>
<span class="normal">         </span><span class="symbol">*</span><span class="normal">dp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">sp</span><span class="symbol">;</span>
<span class="preproc">#endif</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">      row_info</span><span class="symbol">-&gt;</span><span class="normal">bit_depth </span><span class="symbol">=</span><span class="normal"> </span><span class="number">8</span><span class="symbol">;</span>
<span class="normal">      row_info</span><span class="symbol">-&gt;</span><span class="normal">pixel_depth </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="number">8</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> row_info</span><span class="symbol">-&gt;</span><span class="normal">channels</span><span class="symbol">);</span>
<span class="normal">      row_info</span><span class="symbol">-&gt;</span><span class="normal">rowbytes </span><span class="symbol">=</span><span class="normal"> row_info</span><span class="symbol">-&gt;</span><span class="normal">width </span><span class="symbol">*</span><span class="normal"> row_info</span><span class="symbol">-&gt;</span><span class="normal">channels</span><span class="symbol">;</span>
<span class="normal">   </span><span class="cbracket">}</span>
<span class="cbracket">}</span>
<span class="preproc">#endif</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_SWAP_ALPHA_SUPPORTED</span><span class="symbol">)</span>
<span class="type">void</span><span class="normal"> </span><span class="comment">/* PRIVATE */</span>
<span class="function">png_do_read_swap_alpha</span><span class="symbol">(</span><span class="usertype">png_row_infop</span><span class="normal"> row_info</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">png_bytep</span><span class="normal"> row</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">   </span><span class="function">png_debug</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"in png_do_read_swap_alpha</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_USELESS_TESTS_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row </span><span class="symbol">!=</span><span class="normal"> NULL </span><span class="symbol">&amp;&amp;</span><span class="normal"> row_info </span><span class="symbol">!=</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="preproc">#endif</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="usertype">png_uint_32</span><span class="normal"> row_width </span><span class="symbol">=</span><span class="normal"> row_info</span><span class="symbol">-&gt;</span><span class="normal">width</span><span class="symbol">;</span>
<span class="normal">      </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">color_type </span><span class="symbol">==</span><span class="normal"> PNG_COLOR_TYPE_RGB_ALPHA</span><span class="symbol">)</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         </span><span class="comment">/* This converts from RGBA to ARGB */</span>
<span class="normal">         </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">bit_depth </span><span class="symbol">==</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> sp </span><span class="symbol">=</span><span class="normal"> row </span><span class="symbol">+</span><span class="normal"> row_info</span><span class="symbol">-&gt;</span><span class="normal">rowbytes</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> dp </span><span class="symbol">=</span><span class="normal"> sp</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_byte</span><span class="normal"> save</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_uint_32</span><span class="normal"> i</span><span class="symbol">;</span>

<span class="normal">            </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               save </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(--</span><span class="normal">sp</span><span class="symbol">);</span>
<span class="normal">               </span><span class="symbol">*(--</span><span class="normal">dp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(--</span><span class="normal">sp</span><span class="symbol">);</span>
<span class="normal">               </span><span class="symbol">*(--</span><span class="normal">dp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(--</span><span class="normal">sp</span><span class="symbol">);</span>
<span class="normal">               </span><span class="symbol">*(--</span><span class="normal">dp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(--</span><span class="normal">sp</span><span class="symbol">);</span>
<span class="normal">               </span><span class="symbol">*(--</span><span class="normal">dp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> save</span><span class="symbol">;</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">         </span><span class="comment">/* This converts from RRGGBBAA to AARRGGBB */</span>
<span class="normal">         </span><span class="keyword">else</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> sp </span><span class="symbol">=</span><span class="normal"> row </span><span class="symbol">+</span><span class="normal"> row_info</span><span class="symbol">-&gt;</span><span class="normal">rowbytes</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> dp </span><span class="symbol">=</span><span class="normal"> sp</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_byte</span><span class="normal"> save</span><span class="symbol">[</span><span class="number">2</span><span class="symbol">];</span>
<span class="normal">            </span><span class="usertype">png_uint_32</span><span class="normal"> i</span><span class="symbol">;</span>

<span class="normal">            </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               save</span><span class="symbol">[</span><span class="number">0</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(--</span><span class="normal">sp</span><span class="symbol">);</span>
<span class="normal">               save</span><span class="symbol">[</span><span class="number">1</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(--</span><span class="normal">sp</span><span class="symbol">);</span>
<span class="normal">               </span><span class="symbol">*(--</span><span class="normal">dp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(--</span><span class="normal">sp</span><span class="symbol">);</span>
<span class="normal">               </span><span class="symbol">*(--</span><span class="normal">dp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(--</span><span class="normal">sp</span><span class="symbol">);</span>
<span class="normal">               </span><span class="symbol">*(--</span><span class="normal">dp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(--</span><span class="normal">sp</span><span class="symbol">);</span>
<span class="normal">               </span><span class="symbol">*(--</span><span class="normal">dp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(--</span><span class="normal">sp</span><span class="symbol">);</span>
<span class="normal">               </span><span class="symbol">*(--</span><span class="normal">dp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(--</span><span class="normal">sp</span><span class="symbol">);</span>
<span class="normal">               </span><span class="symbol">*(--</span><span class="normal">dp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(--</span><span class="normal">sp</span><span class="symbol">);</span>
<span class="normal">               </span><span class="symbol">*(--</span><span class="normal">dp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> save</span><span class="symbol">[</span><span class="number">0</span><span class="symbol">];</span>
<span class="normal">               </span><span class="symbol">*(--</span><span class="normal">dp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> save</span><span class="symbol">[</span><span class="number">1</span><span class="symbol">];</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">color_type </span><span class="symbol">==</span><span class="normal"> PNG_COLOR_TYPE_GRAY_ALPHA</span><span class="symbol">)</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         </span><span class="comment">/* This converts from GA to AG */</span>
<span class="normal">         </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">bit_depth </span><span class="symbol">==</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> sp </span><span class="symbol">=</span><span class="normal"> row </span><span class="symbol">+</span><span class="normal"> row_info</span><span class="symbol">-&gt;</span><span class="normal">rowbytes</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> dp </span><span class="symbol">=</span><span class="normal"> sp</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_byte</span><span class="normal"> save</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_uint_32</span><span class="normal"> i</span><span class="symbol">;</span>

<span class="normal">            </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               save </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(--</span><span class="normal">sp</span><span class="symbol">);</span>
<span class="normal">               </span><span class="symbol">*(--</span><span class="normal">dp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(--</span><span class="normal">sp</span><span class="symbol">);</span>
<span class="normal">               </span><span class="symbol">*(--</span><span class="normal">dp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> save</span><span class="symbol">;</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">         </span><span class="comment">/* This converts from GGAA to AAGG */</span>
<span class="normal">         </span><span class="keyword">else</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> sp </span><span class="symbol">=</span><span class="normal"> row </span><span class="symbol">+</span><span class="normal"> row_info</span><span class="symbol">-&gt;</span><span class="normal">rowbytes</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> dp </span><span class="symbol">=</span><span class="normal"> sp</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_byte</span><span class="normal"> save</span><span class="symbol">[</span><span class="number">2</span><span class="symbol">];</span>
<span class="normal">            </span><span class="usertype">png_uint_32</span><span class="normal"> i</span><span class="symbol">;</span>

<span class="normal">            </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               save</span><span class="symbol">[</span><span class="number">0</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(--</span><span class="normal">sp</span><span class="symbol">);</span>
<span class="normal">               save</span><span class="symbol">[</span><span class="number">1</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(--</span><span class="normal">sp</span><span class="symbol">);</span>
<span class="normal">               </span><span class="symbol">*(--</span><span class="normal">dp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(--</span><span class="normal">sp</span><span class="symbol">);</span>
<span class="normal">               </span><span class="symbol">*(--</span><span class="normal">dp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(--</span><span class="normal">sp</span><span class="symbol">);</span>
<span class="normal">               </span><span class="symbol">*(--</span><span class="normal">dp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> save</span><span class="symbol">[</span><span class="number">0</span><span class="symbol">];</span>
<span class="normal">               </span><span class="symbol">*(--</span><span class="normal">dp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> save</span><span class="symbol">[</span><span class="number">1</span><span class="symbol">];</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">   </span><span class="cbracket">}</span>
<span class="cbracket">}</span>
<span class="preproc">#endif</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_INVERT_ALPHA_SUPPORTED</span><span class="symbol">)</span>
<span class="type">void</span><span class="normal"> </span><span class="comment">/* PRIVATE */</span>
<span class="function">png_do_read_invert_alpha</span><span class="symbol">(</span><span class="usertype">png_row_infop</span><span class="normal"> row_info</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">png_bytep</span><span class="normal"> row</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">   </span><span class="function">png_debug</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"in png_do_read_invert_alpha</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_USELESS_TESTS_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row </span><span class="symbol">!=</span><span class="normal"> NULL </span><span class="symbol">&amp;&amp;</span><span class="normal"> row_info </span><span class="symbol">!=</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="preproc">#endif</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="usertype">png_uint_32</span><span class="normal"> row_width </span><span class="symbol">=</span><span class="normal"> row_info</span><span class="symbol">-&gt;</span><span class="normal">width</span><span class="symbol">;</span>
<span class="normal">      </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">color_type </span><span class="symbol">==</span><span class="normal"> PNG_COLOR_TYPE_RGB_ALPHA</span><span class="symbol">)</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         </span><span class="comment">/* This inverts the alpha channel in RGBA */</span>
<span class="normal">         </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">bit_depth </span><span class="symbol">==</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> sp </span><span class="symbol">=</span><span class="normal"> row </span><span class="symbol">+</span><span class="normal"> row_info</span><span class="symbol">-&gt;</span><span class="normal">rowbytes</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> dp </span><span class="symbol">=</span><span class="normal"> sp</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_uint_32</span><span class="normal"> i</span><span class="symbol">;</span>

<span class="normal">            </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="symbol">*(--</span><span class="normal">dp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="number">255</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="symbol">*(--</span><span class="normal">sp</span><span class="symbol">));</span>

<span class="comment">/*             This does nothing:</span>
<span class="comment">               *(--dp) = *(--sp);</span>
<span class="comment">               *(--dp) = *(--sp);</span>
<span class="comment">               *(--dp) = *(--sp);</span>
<span class="comment">               We can replace it with:</span>
<span class="comment">*/</span>
<span class="normal">               sp</span><span class="symbol">-=</span><span class="number">3</span><span class="symbol">;</span>
<span class="normal">               dp</span><span class="symbol">=</span><span class="normal">sp</span><span class="symbol">;</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">         </span><span class="comment">/* This inverts the alpha channel in RRGGBBAA */</span>
<span class="normal">         </span><span class="keyword">else</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> sp </span><span class="symbol">=</span><span class="normal"> row </span><span class="symbol">+</span><span class="normal"> row_info</span><span class="symbol">-&gt;</span><span class="normal">rowbytes</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> dp </span><span class="symbol">=</span><span class="normal"> sp</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_uint_32</span><span class="normal"> i</span><span class="symbol">;</span>

<span class="normal">            </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="symbol">*(--</span><span class="normal">dp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="number">255</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="symbol">*(--</span><span class="normal">sp</span><span class="symbol">));</span>
<span class="normal">               </span><span class="symbol">*(--</span><span class="normal">dp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="number">255</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="symbol">*(--</span><span class="normal">sp</span><span class="symbol">));</span>

<span class="comment">/*             This does nothing:</span>
<span class="comment">               *(--dp) = *(--sp);</span>
<span class="comment">               *(--dp) = *(--sp);</span>
<span class="comment">               *(--dp) = *(--sp);</span>
<span class="comment">               *(--dp) = *(--sp);</span>
<span class="comment">               *(--dp) = *(--sp);</span>
<span class="comment">               *(--dp) = *(--sp);</span>
<span class="comment">               We can replace it with:</span>
<span class="comment">*/</span>
<span class="normal">               sp</span><span class="symbol">-=</span><span class="number">6</span><span class="symbol">;</span>
<span class="normal">               dp</span><span class="symbol">=</span><span class="normal">sp</span><span class="symbol">;</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">color_type </span><span class="symbol">==</span><span class="normal"> PNG_COLOR_TYPE_GRAY_ALPHA</span><span class="symbol">)</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         </span><span class="comment">/* This inverts the alpha channel in GA */</span>
<span class="normal">         </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">bit_depth </span><span class="symbol">==</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> sp </span><span class="symbol">=</span><span class="normal"> row </span><span class="symbol">+</span><span class="normal"> row_info</span><span class="symbol">-&gt;</span><span class="normal">rowbytes</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> dp </span><span class="symbol">=</span><span class="normal"> sp</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_uint_32</span><span class="normal"> i</span><span class="symbol">;</span>

<span class="normal">            </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="symbol">*(--</span><span class="normal">dp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="number">255</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="symbol">*(--</span><span class="normal">sp</span><span class="symbol">));</span>
<span class="normal">               </span><span class="symbol">*(--</span><span class="normal">dp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(--</span><span class="normal">sp</span><span class="symbol">);</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">         </span><span class="comment">/* This inverts the alpha channel in GGAA */</span>
<span class="normal">         </span><span class="keyword">else</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> sp  </span><span class="symbol">=</span><span class="normal"> row </span><span class="symbol">+</span><span class="normal"> row_info</span><span class="symbol">-&gt;</span><span class="normal">rowbytes</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> dp </span><span class="symbol">=</span><span class="normal"> sp</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_uint_32</span><span class="normal"> i</span><span class="symbol">;</span>

<span class="normal">            </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="symbol">*(--</span><span class="normal">dp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="number">255</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="symbol">*(--</span><span class="normal">sp</span><span class="symbol">));</span>
<span class="normal">               </span><span class="symbol">*(--</span><span class="normal">dp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="number">255</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="symbol">*(--</span><span class="normal">sp</span><span class="symbol">));</span>
<span class="comment">/*</span>
<span class="comment">               *(--dp) = *(--sp);</span>
<span class="comment">               *(--dp) = *(--sp);</span>
<span class="comment">*/</span>
<span class="normal">               sp</span><span class="symbol">-=</span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">               dp</span><span class="symbol">=</span><span class="normal">sp</span><span class="symbol">;</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">   </span><span class="cbracket">}</span>
<span class="cbracket">}</span>
<span class="preproc">#endif</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_FILLER_SUPPORTED</span><span class="symbol">)</span>
<span class="comment">/* Add filler channel if we have RGB color */</span>
<span class="type">void</span><span class="normal"> </span><span class="comment">/* PRIVATE */</span>
<span class="function">png_do_read_filler</span><span class="symbol">(</span><span class="usertype">png_row_infop</span><span class="normal"> row_info</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">png_bytep</span><span class="normal"> row</span><span class="symbol">,</span>
<span class="normal">   </span><span class="usertype">png_uint_32</span><span class="normal"> filler</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">png_uint_32</span><span class="normal"> flags</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">   </span><span class="usertype">png_uint_32</span><span class="normal"> i</span><span class="symbol">;</span>
<span class="normal">   </span><span class="usertype">png_uint_32</span><span class="normal"> row_width </span><span class="symbol">=</span><span class="normal"> row_info</span><span class="symbol">-&gt;</span><span class="normal">width</span><span class="symbol">;</span>

<span class="normal">   </span><span class="usertype">png_byte</span><span class="normal"> hi_filler </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((</span><span class="normal">filler</span><span class="symbol">&gt;&gt;</span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">   </span><span class="usertype">png_byte</span><span class="normal"> lo_filler </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">filler </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>

<span class="normal">   </span><span class="function">png_debug</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"in png_do_read_filler</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_USELESS_TESTS_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">       row </span><span class="symbol">!=</span><span class="normal"> NULL  </span><span class="symbol">&amp;&amp;</span><span class="normal"> row_info </span><span class="symbol">!=</span><span class="normal"> NULL </span><span class="symbol">&amp;&amp;</span>
<span class="preproc">#endif</span>
<span class="normal">       row_info</span><span class="symbol">-&gt;</span><span class="normal">color_type </span><span class="symbol">==</span><span class="normal"> PNG_COLOR_TYPE_GRAY</span><span class="symbol">)</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">bit_depth </span><span class="symbol">==</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         </span><span class="comment">/* This changes the data from G to GX */</span>
<span class="normal">         </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">flags </span><span class="symbol">&amp;</span><span class="normal"> PNG_FLAG_FILLER_AFTER</span><span class="symbol">)</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> sp </span><span class="symbol">=</span><span class="normal"> row </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_size_t</span><span class="symbol">)</span><span class="normal">row_width</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> dp </span><span class="symbol">=</span><span class="normal">  sp </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_size_t</span><span class="symbol">)</span><span class="normal">row_width</span><span class="symbol">;</span>
<span class="normal">            </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="symbol">*(--</span><span class="normal">dp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> lo_filler</span><span class="symbol">;</span>
<span class="normal">               </span><span class="symbol">*(--</span><span class="normal">dp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(--</span><span class="normal">sp</span><span class="symbol">);</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="symbol">*(--</span><span class="normal">dp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> lo_filler</span><span class="symbol">;</span>
<span class="normal">            row_info</span><span class="symbol">-&gt;</span><span class="normal">channels </span><span class="symbol">=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">            row_info</span><span class="symbol">-&gt;</span><span class="normal">pixel_depth </span><span class="symbol">=</span><span class="normal"> </span><span class="number">16</span><span class="symbol">;</span>
<span class="normal">            row_info</span><span class="symbol">-&gt;</span><span class="normal">rowbytes </span><span class="symbol">=</span><span class="normal"> row_width </span><span class="symbol">*</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="comment">/* This changes the data from G to XG */</span>
<span class="normal">         </span><span class="keyword">else</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> sp </span><span class="symbol">=</span><span class="normal"> row </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_size_t</span><span class="symbol">)</span><span class="normal">row_width</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> dp </span><span class="symbol">=</span><span class="normal"> sp  </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_size_t</span><span class="symbol">)</span><span class="normal">row_width</span><span class="symbol">;</span>
<span class="normal">            </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="symbol">*(--</span><span class="normal">dp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(--</span><span class="normal">sp</span><span class="symbol">);</span>
<span class="normal">               </span><span class="symbol">*(--</span><span class="normal">dp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> lo_filler</span><span class="symbol">;</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            row_info</span><span class="symbol">-&gt;</span><span class="normal">channels </span><span class="symbol">=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">            row_info</span><span class="symbol">-&gt;</span><span class="normal">pixel_depth </span><span class="symbol">=</span><span class="normal"> </span><span class="number">16</span><span class="symbol">;</span>
<span class="normal">            row_info</span><span class="symbol">-&gt;</span><span class="normal">rowbytes </span><span class="symbol">=</span><span class="normal"> row_width </span><span class="symbol">*</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">bit_depth </span><span class="symbol">==</span><span class="normal"> </span><span class="number">16</span><span class="symbol">)</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         </span><span class="comment">/* This changes the data from GG to GGXX */</span>
<span class="normal">         </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">flags </span><span class="symbol">&amp;</span><span class="normal"> PNG_FLAG_FILLER_AFTER</span><span class="symbol">)</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> sp </span><span class="symbol">=</span><span class="normal"> row </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_size_t</span><span class="symbol">)</span><span class="normal">row_width </span><span class="symbol">*</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> dp </span><span class="symbol">=</span><span class="normal"> sp  </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_size_t</span><span class="symbol">)</span><span class="normal">row_width </span><span class="symbol">*</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">            </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="symbol">*(--</span><span class="normal">dp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> hi_filler</span><span class="symbol">;</span>
<span class="normal">               </span><span class="symbol">*(--</span><span class="normal">dp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> lo_filler</span><span class="symbol">;</span>
<span class="normal">               </span><span class="symbol">*(--</span><span class="normal">dp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(--</span><span class="normal">sp</span><span class="symbol">);</span>
<span class="normal">               </span><span class="symbol">*(--</span><span class="normal">dp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(--</span><span class="normal">sp</span><span class="symbol">);</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="symbol">*(--</span><span class="normal">dp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> hi_filler</span><span class="symbol">;</span>
<span class="normal">            </span><span class="symbol">*(--</span><span class="normal">dp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> lo_filler</span><span class="symbol">;</span>
<span class="normal">            row_info</span><span class="symbol">-&gt;</span><span class="normal">channels </span><span class="symbol">=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">            row_info</span><span class="symbol">-&gt;</span><span class="normal">pixel_depth </span><span class="symbol">=</span><span class="normal"> </span><span class="number">32</span><span class="symbol">;</span>
<span class="normal">            row_info</span><span class="symbol">-&gt;</span><span class="normal">rowbytes </span><span class="symbol">=</span><span class="normal"> row_width </span><span class="symbol">*</span><span class="normal"> </span><span class="number">4</span><span class="symbol">;</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">         </span><span class="comment">/* This changes the data from GG to XXGG */</span>
<span class="normal">         </span><span class="keyword">else</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> sp </span><span class="symbol">=</span><span class="normal"> row </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_size_t</span><span class="symbol">)</span><span class="normal">row_width </span><span class="symbol">*</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> dp </span><span class="symbol">=</span><span class="normal"> sp  </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_size_t</span><span class="symbol">)</span><span class="normal">row_width </span><span class="symbol">*</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">            </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="symbol">*(--</span><span class="normal">dp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(--</span><span class="normal">sp</span><span class="symbol">);</span>
<span class="normal">               </span><span class="symbol">*(--</span><span class="normal">dp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(--</span><span class="normal">sp</span><span class="symbol">);</span>
<span class="normal">               </span><span class="symbol">*(--</span><span class="normal">dp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> hi_filler</span><span class="symbol">;</span>
<span class="normal">               </span><span class="symbol">*(--</span><span class="normal">dp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> lo_filler</span><span class="symbol">;</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            row_info</span><span class="symbol">-&gt;</span><span class="normal">channels </span><span class="symbol">=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">            row_info</span><span class="symbol">-&gt;</span><span class="normal">pixel_depth </span><span class="symbol">=</span><span class="normal"> </span><span class="number">32</span><span class="symbol">;</span>
<span class="normal">            row_info</span><span class="symbol">-&gt;</span><span class="normal">rowbytes </span><span class="symbol">=</span><span class="normal"> row_width </span><span class="symbol">*</span><span class="normal"> </span><span class="number">4</span><span class="symbol">;</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">   </span><span class="cbracket">}</span><span class="normal"> </span><span class="comment">/* COLOR_TYPE == GRAY */</span>
<span class="normal">   </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">color_type </span><span class="symbol">==</span><span class="normal"> PNG_COLOR_TYPE_RGB</span><span class="symbol">)</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">bit_depth </span><span class="symbol">==</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         </span><span class="comment">/* This changes the data from RGB to RGBX */</span>
<span class="normal">         </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">flags </span><span class="symbol">&amp;</span><span class="normal"> PNG_FLAG_FILLER_AFTER</span><span class="symbol">)</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> sp </span><span class="symbol">=</span><span class="normal"> row </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_size_t</span><span class="symbol">)</span><span class="normal">row_width </span><span class="symbol">*</span><span class="normal"> </span><span class="number">3</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> dp </span><span class="symbol">=</span><span class="normal"> sp  </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_size_t</span><span class="symbol">)</span><span class="normal">row_width</span><span class="symbol">;</span>
<span class="normal">            </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="symbol">*(--</span><span class="normal">dp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> lo_filler</span><span class="symbol">;</span>
<span class="normal">               </span><span class="symbol">*(--</span><span class="normal">dp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(--</span><span class="normal">sp</span><span class="symbol">);</span>
<span class="normal">               </span><span class="symbol">*(--</span><span class="normal">dp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(--</span><span class="normal">sp</span><span class="symbol">);</span>
<span class="normal">               </span><span class="symbol">*(--</span><span class="normal">dp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(--</span><span class="normal">sp</span><span class="symbol">);</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="symbol">*(--</span><span class="normal">dp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> lo_filler</span><span class="symbol">;</span>
<span class="normal">            row_info</span><span class="symbol">-&gt;</span><span class="normal">channels </span><span class="symbol">=</span><span class="normal"> </span><span class="number">4</span><span class="symbol">;</span>
<span class="normal">            row_info</span><span class="symbol">-&gt;</span><span class="normal">pixel_depth </span><span class="symbol">=</span><span class="normal"> </span><span class="number">32</span><span class="symbol">;</span>
<span class="normal">            row_info</span><span class="symbol">-&gt;</span><span class="normal">rowbytes </span><span class="symbol">=</span><span class="normal"> row_width </span><span class="symbol">*</span><span class="normal"> </span><span class="number">4</span><span class="symbol">;</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="comment">/* This changes the data from RGB to XRGB */</span>
<span class="normal">         </span><span class="keyword">else</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> sp </span><span class="symbol">=</span><span class="normal"> row </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_size_t</span><span class="symbol">)</span><span class="normal">row_width </span><span class="symbol">*</span><span class="normal"> </span><span class="number">3</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> dp </span><span class="symbol">=</span><span class="normal"> sp </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_size_t</span><span class="symbol">)</span><span class="normal">row_width</span><span class="symbol">;</span>
<span class="normal">            </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="symbol">*(--</span><span class="normal">dp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(--</span><span class="normal">sp</span><span class="symbol">);</span>
<span class="normal">               </span><span class="symbol">*(--</span><span class="normal">dp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(--</span><span class="normal">sp</span><span class="symbol">);</span>
<span class="normal">               </span><span class="symbol">*(--</span><span class="normal">dp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(--</span><span class="normal">sp</span><span class="symbol">);</span>
<span class="normal">               </span><span class="symbol">*(--</span><span class="normal">dp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> lo_filler</span><span class="symbol">;</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            row_info</span><span class="symbol">-&gt;</span><span class="normal">channels </span><span class="symbol">=</span><span class="normal"> </span><span class="number">4</span><span class="symbol">;</span>
<span class="normal">            row_info</span><span class="symbol">-&gt;</span><span class="normal">pixel_depth </span><span class="symbol">=</span><span class="normal"> </span><span class="number">32</span><span class="symbol">;</span>
<span class="normal">            row_info</span><span class="symbol">-&gt;</span><span class="normal">rowbytes </span><span class="symbol">=</span><span class="normal"> row_width </span><span class="symbol">*</span><span class="normal"> </span><span class="number">4</span><span class="symbol">;</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">bit_depth </span><span class="symbol">==</span><span class="normal"> </span><span class="number">16</span><span class="symbol">)</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         </span><span class="comment">/* This changes the data from RRGGBB to RRGGBBXX */</span>
<span class="normal">         </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">flags </span><span class="symbol">&amp;</span><span class="normal"> PNG_FLAG_FILLER_AFTER</span><span class="symbol">)</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> sp </span><span class="symbol">=</span><span class="normal"> row </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_size_t</span><span class="symbol">)</span><span class="normal">row_width </span><span class="symbol">*</span><span class="normal"> </span><span class="number">6</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> dp </span><span class="symbol">=</span><span class="normal"> sp  </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_size_t</span><span class="symbol">)</span><span class="normal">row_width </span><span class="symbol">*</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">            </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="symbol">*(--</span><span class="normal">dp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> hi_filler</span><span class="symbol">;</span>
<span class="normal">               </span><span class="symbol">*(--</span><span class="normal">dp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> lo_filler</span><span class="symbol">;</span>
<span class="normal">               </span><span class="symbol">*(--</span><span class="normal">dp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(--</span><span class="normal">sp</span><span class="symbol">);</span>
<span class="normal">               </span><span class="symbol">*(--</span><span class="normal">dp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(--</span><span class="normal">sp</span><span class="symbol">);</span>
<span class="normal">               </span><span class="symbol">*(--</span><span class="normal">dp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(--</span><span class="normal">sp</span><span class="symbol">);</span>
<span class="normal">               </span><span class="symbol">*(--</span><span class="normal">dp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(--</span><span class="normal">sp</span><span class="symbol">);</span>
<span class="normal">               </span><span class="symbol">*(--</span><span class="normal">dp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(--</span><span class="normal">sp</span><span class="symbol">);</span>
<span class="normal">               </span><span class="symbol">*(--</span><span class="normal">dp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(--</span><span class="normal">sp</span><span class="symbol">);</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="symbol">*(--</span><span class="normal">dp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> hi_filler</span><span class="symbol">;</span>
<span class="normal">            </span><span class="symbol">*(--</span><span class="normal">dp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> lo_filler</span><span class="symbol">;</span>
<span class="normal">            row_info</span><span class="symbol">-&gt;</span><span class="normal">channels </span><span class="symbol">=</span><span class="normal"> </span><span class="number">4</span><span class="symbol">;</span>
<span class="normal">            row_info</span><span class="symbol">-&gt;</span><span class="normal">pixel_depth </span><span class="symbol">=</span><span class="normal"> </span><span class="number">64</span><span class="symbol">;</span>
<span class="normal">            row_info</span><span class="symbol">-&gt;</span><span class="normal">rowbytes </span><span class="symbol">=</span><span class="normal"> row_width </span><span class="symbol">*</span><span class="normal"> </span><span class="number">8</span><span class="symbol">;</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">         </span><span class="comment">/* This changes the data from RRGGBB to XXRRGGBB */</span>
<span class="normal">         </span><span class="keyword">else</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> sp </span><span class="symbol">=</span><span class="normal"> row </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_size_t</span><span class="symbol">)</span><span class="normal">row_width </span><span class="symbol">*</span><span class="normal"> </span><span class="number">6</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> dp </span><span class="symbol">=</span><span class="normal"> sp  </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_size_t</span><span class="symbol">)</span><span class="normal">row_width </span><span class="symbol">*</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">            </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="symbol">*(--</span><span class="normal">dp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(--</span><span class="normal">sp</span><span class="symbol">);</span>
<span class="normal">               </span><span class="symbol">*(--</span><span class="normal">dp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(--</span><span class="normal">sp</span><span class="symbol">);</span>
<span class="normal">               </span><span class="symbol">*(--</span><span class="normal">dp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(--</span><span class="normal">sp</span><span class="symbol">);</span>
<span class="normal">               </span><span class="symbol">*(--</span><span class="normal">dp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(--</span><span class="normal">sp</span><span class="symbol">);</span>
<span class="normal">               </span><span class="symbol">*(--</span><span class="normal">dp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(--</span><span class="normal">sp</span><span class="symbol">);</span>
<span class="normal">               </span><span class="symbol">*(--</span><span class="normal">dp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(--</span><span class="normal">sp</span><span class="symbol">);</span>
<span class="normal">               </span><span class="symbol">*(--</span><span class="normal">dp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> hi_filler</span><span class="symbol">;</span>
<span class="normal">               </span><span class="symbol">*(--</span><span class="normal">dp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> lo_filler</span><span class="symbol">;</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            row_info</span><span class="symbol">-&gt;</span><span class="normal">channels </span><span class="symbol">=</span><span class="normal"> </span><span class="number">4</span><span class="symbol">;</span>
<span class="normal">            row_info</span><span class="symbol">-&gt;</span><span class="normal">pixel_depth </span><span class="symbol">=</span><span class="normal"> </span><span class="number">64</span><span class="symbol">;</span>
<span class="normal">            row_info</span><span class="symbol">-&gt;</span><span class="normal">rowbytes </span><span class="symbol">=</span><span class="normal"> row_width </span><span class="symbol">*</span><span class="normal"> </span><span class="number">8</span><span class="symbol">;</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">   </span><span class="cbracket">}</span><span class="normal"> </span><span class="comment">/* COLOR_TYPE == RGB */</span>
<span class="cbracket">}</span>
<span class="preproc">#endif</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_GRAY_TO_RGB_SUPPORTED</span><span class="symbol">)</span>
<span class="comment">/* expand grayscale files to RGB, with or without alpha */</span>
<span class="type">void</span><span class="normal"> </span><span class="comment">/* PRIVATE */</span>
<span class="function">png_do_gray_to_rgb</span><span class="symbol">(</span><span class="usertype">png_row_infop</span><span class="normal"> row_info</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">png_bytep</span><span class="normal"> row</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">   </span><span class="usertype">png_uint_32</span><span class="normal"> i</span><span class="symbol">;</span>
<span class="normal">   </span><span class="usertype">png_uint_32</span><span class="normal"> row_width </span><span class="symbol">=</span><span class="normal"> row_info</span><span class="symbol">-&gt;</span><span class="normal">width</span><span class="symbol">;</span>

<span class="normal">   </span><span class="function">png_debug</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"in png_do_gray_to_rgb</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">bit_depth </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">8</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_USELESS_TESTS_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">       row </span><span class="symbol">!=</span><span class="normal"> NULL </span><span class="symbol">&amp;&amp;</span><span class="normal"> row_info </span><span class="symbol">!=</span><span class="normal"> NULL </span><span class="symbol">&amp;&amp;</span>
<span class="preproc">#endif</span>
<span class="normal">      </span><span class="symbol">!(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">color_type </span><span class="symbol">&amp;</span><span class="normal"> PNG_COLOR_MASK_COLOR</span><span class="symbol">))</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">color_type </span><span class="symbol">==</span><span class="normal"> PNG_COLOR_TYPE_GRAY</span><span class="symbol">)</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">bit_depth </span><span class="symbol">==</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> sp </span><span class="symbol">=</span><span class="normal"> row </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_size_t</span><span class="symbol">)</span><span class="normal">row_width </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> dp </span><span class="symbol">=</span><span class="normal"> sp  </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_size_t</span><span class="symbol">)</span><span class="normal">row_width </span><span class="symbol">*</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">            </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="symbol">*(</span><span class="normal">dp</span><span class="symbol">--)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">sp</span><span class="symbol">;</span>
<span class="normal">               </span><span class="symbol">*(</span><span class="normal">dp</span><span class="symbol">--)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">sp</span><span class="symbol">;</span>
<span class="normal">               </span><span class="symbol">*(</span><span class="normal">dp</span><span class="symbol">--)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">sp</span><span class="symbol">--);</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">         </span><span class="keyword">else</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> sp </span><span class="symbol">=</span><span class="normal"> row </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_size_t</span><span class="symbol">)</span><span class="normal">row_width </span><span class="symbol">*</span><span class="normal"> </span><span class="number">2</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> dp </span><span class="symbol">=</span><span class="normal"> sp  </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_size_t</span><span class="symbol">)</span><span class="normal">row_width </span><span class="symbol">*</span><span class="normal"> </span><span class="number">4</span><span class="symbol">;</span>
<span class="normal">            </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="symbol">*(</span><span class="normal">dp</span><span class="symbol">--)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">sp</span><span class="symbol">;</span>
<span class="normal">               </span><span class="symbol">*(</span><span class="normal">dp</span><span class="symbol">--)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">sp </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">               </span><span class="symbol">*(</span><span class="normal">dp</span><span class="symbol">--)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">sp</span><span class="symbol">;</span>
<span class="normal">               </span><span class="symbol">*(</span><span class="normal">dp</span><span class="symbol">--)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">sp </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">               </span><span class="symbol">*(</span><span class="normal">dp</span><span class="symbol">--)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">sp</span><span class="symbol">--);</span>
<span class="normal">               </span><span class="symbol">*(</span><span class="normal">dp</span><span class="symbol">--)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">sp</span><span class="symbol">--);</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">color_type </span><span class="symbol">==</span><span class="normal"> PNG_COLOR_TYPE_GRAY_ALPHA</span><span class="symbol">)</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">bit_depth </span><span class="symbol">==</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> sp </span><span class="symbol">=</span><span class="normal"> row </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_size_t</span><span class="symbol">)</span><span class="normal">row_width </span><span class="symbol">*</span><span class="normal"> </span><span class="number">2</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> dp </span><span class="symbol">=</span><span class="normal"> sp  </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_size_t</span><span class="symbol">)</span><span class="normal">row_width </span><span class="symbol">*</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">            </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="symbol">*(</span><span class="normal">dp</span><span class="symbol">--)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">sp</span><span class="symbol">--);</span>
<span class="normal">               </span><span class="symbol">*(</span><span class="normal">dp</span><span class="symbol">--)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">sp</span><span class="symbol">;</span>
<span class="normal">               </span><span class="symbol">*(</span><span class="normal">dp</span><span class="symbol">--)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">sp</span><span class="symbol">;</span>
<span class="normal">               </span><span class="symbol">*(</span><span class="normal">dp</span><span class="symbol">--)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">sp</span><span class="symbol">--);</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">         </span><span class="keyword">else</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> sp </span><span class="symbol">=</span><span class="normal"> row </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_size_t</span><span class="symbol">)</span><span class="normal">row_width </span><span class="symbol">*</span><span class="normal"> </span><span class="number">4</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">            </span><span class="usertype">png_bytep</span><span class="normal"> dp </span><span class="symbol">=</span><span class="normal"> sp  </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_size_t</span><span class="symbol">)</span><span class="normal">row_width </span><span class="symbol">*</span><span class="normal"> </span><span class="number">4</span><span class="symbol">;</span>
<span class="normal">            </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="symbol">*(</span><span class="normal">dp</span><span class="symbol">--)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">sp</span><span class="symbol">--);</span>
<span class="normal">               </span><span class="symbol">*(</span><span class="normal">dp</span><span class="symbol">--)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">sp</span><span class="symbol">--);</span>
<span class="normal">               </span><span class="symbol">*(</span><span class="normal">dp</span><span class="symbol">--)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">sp</span><span class="symbol">;</span>
<span class="normal">               </span><span class="symbol">*(</span><span class="normal">dp</span><span class="symbol">--)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">sp </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">               </span><span class="symbol">*(</span><span class="normal">dp</span><span class="symbol">--)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">sp</span><span class="symbol">;</span>
<span class="normal">               </span><span class="symbol">*(</span><span class="normal">dp</span><span class="symbol">--)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">sp </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">               </span><span class="symbol">*(</span><span class="normal">dp</span><span class="symbol">--)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">sp</span><span class="symbol">--);</span>
<span class="normal">               </span><span class="symbol">*(</span><span class="normal">dp</span><span class="symbol">--)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">sp</span><span class="symbol">--);</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">      row_info</span><span class="symbol">-&gt;</span><span class="normal">channels </span><span class="symbol">+=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)</span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">      row_info</span><span class="symbol">-&gt;</span><span class="normal">color_type </span><span class="symbol">|=</span><span class="normal"> PNG_COLOR_MASK_COLOR</span><span class="symbol">;</span>
<span class="normal">      row_info</span><span class="symbol">-&gt;</span><span class="normal">pixel_depth </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">channels </span><span class="symbol">*</span>
<span class="normal">         row_info</span><span class="symbol">-&gt;</span><span class="normal">bit_depth</span><span class="symbol">);</span>
<span class="normal">      row_info</span><span class="symbol">-&gt;</span><span class="normal">rowbytes </span><span class="symbol">=</span><span class="normal"> </span><span class="function">PNG_ROWBYTES</span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">pixel_depth</span><span class="symbol">,</span><span class="normal">row_width</span><span class="symbol">);</span>
<span class="normal">   </span><span class="cbracket">}</span>
<span class="cbracket">}</span>
<span class="preproc">#endif</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_RGB_TO_GRAY_SUPPORTED</span><span class="symbol">)</span>
<span class="comment">/* reduce RGB files to grayscale, with or without alpha</span>
<span class="comment"> * using the equation given in Poynton's ColorFAQ at</span>
<span class="comment"> * </span><span class="url">&lt;http://www.inforamp.net/~poynton/&gt;</span>
<span class="comment"> * Copyright (c) 1998-01-04 Charles Poynton poynton at inforamp.net</span>
<span class="comment"> *</span>
<span class="comment"> *     Y = 0.212671 * R + 0.715160 * G + 0.072169 * B</span>
<span class="comment"> *</span>
<span class="comment"> *  We approximate this with</span>
<span class="comment"> *</span>
<span class="comment"> *     Y = 0.21268 * R    + 0.7151 * G    + 0.07217 * B</span>
<span class="comment"> *</span>
<span class="comment"> *  which can be expressed with integers as</span>
<span class="comment"> *</span>
<span class="comment"> *     Y = (6969 * R + 23434 * G + 2365 * B)/32768</span>
<span class="comment"> *</span>
<span class="comment"> *  The calculation is to be done in a linear colorspace.</span>
<span class="comment"> *</span>
<span class="comment"> *  Other integer coefficents can be used via png_set_rgb_to_gray().</span>
<span class="comment"> */</span>
<span class="type">int</span><span class="normal"> </span><span class="comment">/* PRIVATE */</span>
<span class="function">png_do_rgb_to_gray</span><span class="symbol">(</span><span class="usertype">png_structp</span><span class="normal"> png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">png_row_infop</span><span class="normal"> row_info</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">png_bytep</span><span class="normal"> row</span><span class="symbol">)</span>

<span class="cbracket">{</span>
<span class="normal">   </span><span class="usertype">png_uint_32</span><span class="normal"> i</span><span class="symbol">;</span>

<span class="normal">   </span><span class="usertype">png_uint_32</span><span class="normal"> row_width </span><span class="symbol">=</span><span class="normal"> row_info</span><span class="symbol">-&gt;</span><span class="normal">width</span><span class="symbol">;</span>
<span class="normal">   </span><span class="type">int</span><span class="normal"> rgb_error </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">   </span><span class="function">png_debug</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"in png_do_rgb_to_gray</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_USELESS_TESTS_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">       row </span><span class="symbol">!=</span><span class="normal"> NULL </span><span class="symbol">&amp;&amp;</span><span class="normal"> row_info </span><span class="symbol">!=</span><span class="normal"> NULL </span><span class="symbol">&amp;&amp;</span>
<span class="preproc">#endif</span>
<span class="normal">      </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">color_type </span><span class="symbol">&amp;</span><span class="normal"> PNG_COLOR_MASK_COLOR</span><span class="symbol">))</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="usertype">png_uint_32</span><span class="normal"> rc </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">rgb_to_gray_red_coeff</span><span class="symbol">;</span>
<span class="normal">      </span><span class="usertype">png_uint_32</span><span class="normal"> gc </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">rgb_to_gray_green_coeff</span><span class="symbol">;</span>
<span class="normal">      </span><span class="usertype">png_uint_32</span><span class="normal"> bc </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">rgb_to_gray_blue_coeff</span><span class="symbol">;</span>

<span class="normal">      </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">color_type </span><span class="symbol">==</span><span class="normal"> PNG_COLOR_TYPE_RGB</span><span class="symbol">)</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">bit_depth </span><span class="symbol">==</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_GAMMA_SUPPORTED</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_BACKGROUND_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">            </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_from_1 </span><span class="symbol">!=</span><span class="normal"> NULL </span><span class="symbol">&amp;&amp;</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_to_1 </span><span class="symbol">!=</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="usertype">png_bytep</span><span class="normal"> sp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">               </span><span class="usertype">png_bytep</span><span class="normal"> dp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>

<span class="normal">               </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  </span><span class="usertype">png_byte</span><span class="normal"> red   </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_to_1</span><span class="symbol">[*(</span><span class="normal">sp</span><span class="symbol">++)];</span>
<span class="normal">                  </span><span class="usertype">png_byte</span><span class="normal"> green </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_to_1</span><span class="symbol">[*(</span><span class="normal">sp</span><span class="symbol">++)];</span>
<span class="normal">                  </span><span class="usertype">png_byte</span><span class="normal"> blue  </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_to_1</span><span class="symbol">[*(</span><span class="normal">sp</span><span class="symbol">++)];</span>
<span class="normal">                  </span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">red </span><span class="symbol">!=</span><span class="normal"> green </span><span class="symbol">||</span><span class="normal"> red </span><span class="symbol">!=</span><span class="normal"> blue</span><span class="symbol">)</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     rgb_error </span><span class="symbol">|=</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">                     </span><span class="symbol">*(</span><span class="normal">dp</span><span class="symbol">++)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_from_1</span><span class="symbol">[</span>
<span class="normal">                       </span><span class="symbol">(</span><span class="normal">rc</span><span class="symbol">*</span><span class="normal">red</span><span class="symbol">+</span><span class="normal">gc</span><span class="symbol">*</span><span class="normal">green</span><span class="symbol">+</span><span class="normal">bc</span><span class="symbol">*</span><span class="normal">blue</span><span class="symbol">)&gt;&gt;</span><span class="number">15</span><span class="symbol">];</span>
<span class="normal">                  </span><span class="cbracket">}</span>
<span class="normal">                  </span><span class="keyword">else</span>
<span class="normal">                     </span><span class="symbol">*(</span><span class="normal">dp</span><span class="symbol">++)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">sp</span><span class="symbol">-</span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="keyword">else</span>
<span class="preproc">#endif</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="usertype">png_bytep</span><span class="normal"> sp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">               </span><span class="usertype">png_bytep</span><span class="normal"> dp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">               </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  </span><span class="usertype">png_byte</span><span class="normal"> red   </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">sp</span><span class="symbol">++);</span>
<span class="normal">                  </span><span class="usertype">png_byte</span><span class="normal"> green </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">sp</span><span class="symbol">++);</span>
<span class="normal">                  </span><span class="usertype">png_byte</span><span class="normal"> blue  </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">sp</span><span class="symbol">++);</span>
<span class="normal">                  </span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">red </span><span class="symbol">!=</span><span class="normal"> green </span><span class="symbol">||</span><span class="normal"> red </span><span class="symbol">!=</span><span class="normal"> blue</span><span class="symbol">)</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     rgb_error </span><span class="symbol">|=</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">                     </span><span class="symbol">*(</span><span class="normal">dp</span><span class="symbol">++)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((</span><span class="normal">rc</span><span class="symbol">*</span><span class="normal">red</span><span class="symbol">+</span><span class="normal">gc</span><span class="symbol">*</span><span class="normal">green</span><span class="symbol">+</span><span class="normal">bc</span><span class="symbol">*</span><span class="normal">blue</span><span class="symbol">)&gt;&gt;</span><span class="number">15</span><span class="symbol">);</span>
<span class="normal">                  </span><span class="cbracket">}</span>
<span class="normal">                  </span><span class="keyword">else</span>
<span class="normal">                     </span><span class="symbol">*(</span><span class="normal">dp</span><span class="symbol">++)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">sp</span><span class="symbol">-</span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">         </span><span class="cbracket">}</span>

<span class="normal">         </span><span class="keyword">else</span><span class="normal"> </span><span class="comment">/* RGB bit_depth == 16 */</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_GAMMA_SUPPORTED</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_BACKGROUND_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">            </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_16_to_1 </span><span class="symbol">!=</span><span class="normal"> NULL </span><span class="symbol">&amp;&amp;</span>
<span class="normal">                png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_16_from_1 </span><span class="symbol">!=</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="usertype">png_bytep</span><span class="normal"> sp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">               </span><span class="usertype">png_bytep</span><span class="normal"> dp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">               </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  </span><span class="usertype">png_uint_16</span><span class="normal"> red</span><span class="symbol">,</span><span class="normal"> green</span><span class="symbol">,</span><span class="normal"> blue</span><span class="symbol">,</span><span class="normal"> w</span><span class="symbol">;</span>

<span class="normal">                  red   </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)(((*(</span><span class="normal">sp</span><span class="symbol">))&lt;&lt;</span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">|</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">sp</span><span class="symbol">+</span><span class="number">1</span><span class="symbol">));</span><span class="normal"> sp</span><span class="symbol">+=</span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">                  green </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)(((*(</span><span class="normal">sp</span><span class="symbol">))&lt;&lt;</span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">|</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">sp</span><span class="symbol">+</span><span class="number">1</span><span class="symbol">));</span><span class="normal"> sp</span><span class="symbol">+=</span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">                  blue  </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)(((*(</span><span class="normal">sp</span><span class="symbol">))&lt;&lt;</span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">|</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">sp</span><span class="symbol">+</span><span class="number">1</span><span class="symbol">));</span><span class="normal"> sp</span><span class="symbol">+=</span><span class="number">2</span><span class="symbol">;</span>

<span class="normal">                  </span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">red </span><span class="symbol">==</span><span class="normal"> green </span><span class="symbol">&amp;&amp;</span><span class="normal"> red </span><span class="symbol">==</span><span class="normal"> blue</span><span class="symbol">)</span>
<span class="normal">                     w </span><span class="symbol">=</span><span class="normal"> red</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="keyword">else</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     </span><span class="usertype">png_uint_16</span><span class="normal"> red_1   </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_16_to_1</span><span class="symbol">[(</span><span class="normal">red</span><span class="symbol">&amp;</span><span class="number">0xff</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span>
<span class="normal">                                  png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_shift</span><span class="symbol">][</span><span class="normal">red</span><span class="symbol">&gt;&gt;</span><span class="number">8</span><span class="symbol">];</span>
<span class="normal">                     </span><span class="usertype">png_uint_16</span><span class="normal"> green_1 </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_16_to_1</span><span class="symbol">[(</span><span class="normal">green</span><span class="symbol">&amp;</span><span class="number">0xff</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span>
<span class="normal">                                  png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_shift</span><span class="symbol">][</span><span class="normal">green</span><span class="symbol">&gt;&gt;</span><span class="number">8</span><span class="symbol">];</span>
<span class="normal">                     </span><span class="usertype">png_uint_16</span><span class="normal"> blue_1  </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_16_to_1</span><span class="symbol">[(</span><span class="normal">blue</span><span class="symbol">&amp;</span><span class="number">0xff</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span>
<span class="normal">                                  png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_shift</span><span class="symbol">][</span><span class="normal">blue</span><span class="symbol">&gt;&gt;</span><span class="number">8</span><span class="symbol">];</span>
<span class="normal">                     </span><span class="usertype">png_uint_16</span><span class="normal"> gray16  </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)((</span><span class="normal">rc</span><span class="symbol">*</span><span class="normal">red_1 </span><span class="symbol">+</span><span class="normal"> gc</span><span class="symbol">*</span><span class="normal">green_1</span>
<span class="normal">                                  </span><span class="symbol">+</span><span class="normal"> bc</span><span class="symbol">*</span><span class="normal">blue_1</span><span class="symbol">)&gt;&gt;</span><span class="number">15</span><span class="symbol">);</span>
<span class="normal">                     w </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_16_from_1</span><span class="symbol">[(</span><span class="normal">gray16</span><span class="symbol">&amp;</span><span class="number">0xff</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span>
<span class="normal">                         png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_shift</span><span class="symbol">][</span><span class="normal">gray16 </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">];</span>
<span class="normal">                     rgb_error </span><span class="symbol">|=</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="cbracket">}</span>

<span class="normal">                  </span><span class="symbol">*(</span><span class="normal">dp</span><span class="symbol">++)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((</span><span class="normal">w</span><span class="symbol">&gt;&gt;</span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                  </span><span class="symbol">*(</span><span class="normal">dp</span><span class="symbol">++)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">w </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="keyword">else</span>
<span class="preproc">#endif</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="usertype">png_bytep</span><span class="normal"> sp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">               </span><span class="usertype">png_bytep</span><span class="normal"> dp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">               </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  </span><span class="usertype">png_uint_16</span><span class="normal"> red</span><span class="symbol">,</span><span class="normal"> green</span><span class="symbol">,</span><span class="normal"> blue</span><span class="symbol">,</span><span class="normal"> gray16</span><span class="symbol">;</span>

<span class="normal">                  red   </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)(((*(</span><span class="normal">sp</span><span class="symbol">))&lt;&lt;</span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">|</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">sp</span><span class="symbol">+</span><span class="number">1</span><span class="symbol">));</span><span class="normal"> sp</span><span class="symbol">+=</span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">                  green </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)(((*(</span><span class="normal">sp</span><span class="symbol">))&lt;&lt;</span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">|</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">sp</span><span class="symbol">+</span><span class="number">1</span><span class="symbol">));</span><span class="normal"> sp</span><span class="symbol">+=</span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">                  blue  </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)(((*(</span><span class="normal">sp</span><span class="symbol">))&lt;&lt;</span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">|</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">sp</span><span class="symbol">+</span><span class="number">1</span><span class="symbol">));</span><span class="normal"> sp</span><span class="symbol">+=</span><span class="number">2</span><span class="symbol">;</span>

<span class="normal">                  </span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">red </span><span class="symbol">!=</span><span class="normal"> green </span><span class="symbol">||</span><span class="normal"> red </span><span class="symbol">!=</span><span class="normal"> blue</span><span class="symbol">)</span>
<span class="normal">                     rgb_error </span><span class="symbol">|=</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">                  gray16  </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)((</span><span class="normal">rc</span><span class="symbol">*</span><span class="normal">red </span><span class="symbol">+</span><span class="normal"> gc</span><span class="symbol">*</span><span class="normal">green </span><span class="symbol">+</span><span class="normal"> bc</span><span class="symbol">*</span><span class="normal">blue</span><span class="symbol">)&gt;&gt;</span><span class="number">15</span><span class="symbol">);</span>
<span class="normal">                  </span><span class="symbol">*(</span><span class="normal">dp</span><span class="symbol">++)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((</span><span class="normal">gray16</span><span class="symbol">&gt;&gt;</span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                  </span><span class="symbol">*(</span><span class="normal">dp</span><span class="symbol">++)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">gray16 </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">color_type </span><span class="symbol">==</span><span class="normal"> PNG_COLOR_TYPE_RGB_ALPHA</span><span class="symbol">)</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">bit_depth </span><span class="symbol">==</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_GAMMA_SUPPORTED</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_BACKGROUND_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">            </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_from_1 </span><span class="symbol">!=</span><span class="normal"> NULL </span><span class="symbol">&amp;&amp;</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_to_1 </span><span class="symbol">!=</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="usertype">png_bytep</span><span class="normal"> sp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">               </span><span class="usertype">png_bytep</span><span class="normal"> dp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">               </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  </span><span class="usertype">png_byte</span><span class="normal"> red   </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_to_1</span><span class="symbol">[*(</span><span class="normal">sp</span><span class="symbol">++)];</span>
<span class="normal">                  </span><span class="usertype">png_byte</span><span class="normal"> green </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_to_1</span><span class="symbol">[*(</span><span class="normal">sp</span><span class="symbol">++)];</span>
<span class="normal">                  </span><span class="usertype">png_byte</span><span class="normal"> blue  </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_to_1</span><span class="symbol">[*(</span><span class="normal">sp</span><span class="symbol">++)];</span>
<span class="normal">                  </span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">red </span><span class="symbol">!=</span><span class="normal"> green </span><span class="symbol">||</span><span class="normal"> red </span><span class="symbol">!=</span><span class="normal"> blue</span><span class="symbol">)</span>
<span class="normal">                     rgb_error </span><span class="symbol">|=</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="symbol">*(</span><span class="normal">dp</span><span class="symbol">++)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal">  png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_from_1</span>
<span class="normal">                             </span><span class="symbol">[(</span><span class="normal">rc</span><span class="symbol">*</span><span class="normal">red </span><span class="symbol">+</span><span class="normal"> gc</span><span class="symbol">*</span><span class="normal">green </span><span class="symbol">+</span><span class="normal"> bc</span><span class="symbol">*</span><span class="normal">blue</span><span class="symbol">)&gt;&gt;</span><span class="number">15</span><span class="symbol">];</span>
<span class="normal">                  </span><span class="symbol">*(</span><span class="normal">dp</span><span class="symbol">++)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">sp</span><span class="symbol">++);</span><span class="normal">  </span><span class="comment">/* alpha */</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="keyword">else</span>
<span class="preproc">#endif</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="usertype">png_bytep</span><span class="normal"> sp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">               </span><span class="usertype">png_bytep</span><span class="normal"> dp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">               </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  </span><span class="usertype">png_byte</span><span class="normal"> red   </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">sp</span><span class="symbol">++);</span>
<span class="normal">                  </span><span class="usertype">png_byte</span><span class="normal"> green </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">sp</span><span class="symbol">++);</span>
<span class="normal">                  </span><span class="usertype">png_byte</span><span class="normal"> blue  </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">sp</span><span class="symbol">++);</span>
<span class="normal">                  </span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">red </span><span class="symbol">!=</span><span class="normal"> green </span><span class="symbol">||</span><span class="normal"> red </span><span class="symbol">!=</span><span class="normal"> blue</span><span class="symbol">)</span>
<span class="normal">                     rgb_error </span><span class="symbol">|=</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="symbol">*(</span><span class="normal">dp</span><span class="symbol">++)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal">  </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((</span><span class="normal">rc</span><span class="symbol">*</span><span class="normal">red </span><span class="symbol">+</span><span class="normal"> gc</span><span class="symbol">*</span><span class="normal">green </span><span class="symbol">+</span><span class="normal"> bc</span><span class="symbol">*</span><span class="normal">blue</span><span class="symbol">)&gt;&gt;</span><span class="number">15</span><span class="symbol">);</span>
<span class="normal">                  </span><span class="symbol">*(</span><span class="normal">dp</span><span class="symbol">++)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">sp</span><span class="symbol">++);</span><span class="normal">  </span><span class="comment">/* alpha */</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">         </span><span class="keyword">else</span><span class="normal"> </span><span class="comment">/* RGBA bit_depth == 16 */</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_GAMMA_SUPPORTED</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_BACKGROUND_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">            </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_16_to_1 </span><span class="symbol">!=</span><span class="normal"> NULL </span><span class="symbol">&amp;&amp;</span>
<span class="normal">                png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_16_from_1 </span><span class="symbol">!=</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="usertype">png_bytep</span><span class="normal"> sp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">               </span><span class="usertype">png_bytep</span><span class="normal"> dp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">               </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  </span><span class="usertype">png_uint_16</span><span class="normal"> red</span><span class="symbol">,</span><span class="normal"> green</span><span class="symbol">,</span><span class="normal"> blue</span><span class="symbol">,</span><span class="normal"> w</span><span class="symbol">;</span>

<span class="normal">                  red   </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)(((*(</span><span class="normal">sp</span><span class="symbol">))&lt;&lt;</span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">|</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">sp</span><span class="symbol">+</span><span class="number">1</span><span class="symbol">));</span><span class="normal"> sp</span><span class="symbol">+=</span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">                  green </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)(((*(</span><span class="normal">sp</span><span class="symbol">))&lt;&lt;</span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">|</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">sp</span><span class="symbol">+</span><span class="number">1</span><span class="symbol">));</span><span class="normal"> sp</span><span class="symbol">+=</span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">                  blue  </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)(((*(</span><span class="normal">sp</span><span class="symbol">))&lt;&lt;</span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">|</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">sp</span><span class="symbol">+</span><span class="number">1</span><span class="symbol">));</span><span class="normal"> sp</span><span class="symbol">+=</span><span class="number">2</span><span class="symbol">;</span>

<span class="normal">                  </span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">red </span><span class="symbol">==</span><span class="normal"> green </span><span class="symbol">&amp;&amp;</span><span class="normal"> red </span><span class="symbol">==</span><span class="normal"> blue</span><span class="symbol">)</span>
<span class="normal">                     w </span><span class="symbol">=</span><span class="normal"> red</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="keyword">else</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     </span><span class="usertype">png_uint_16</span><span class="normal"> red_1   </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_16_to_1</span><span class="symbol">[(</span><span class="normal">red</span><span class="symbol">&amp;</span><span class="number">0xff</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span>
<span class="normal">                                  png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_shift</span><span class="symbol">][</span><span class="normal">red</span><span class="symbol">&gt;&gt;</span><span class="number">8</span><span class="symbol">];</span>
<span class="normal">                     </span><span class="usertype">png_uint_16</span><span class="normal"> green_1 </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_16_to_1</span><span class="symbol">[(</span><span class="normal">green</span><span class="symbol">&amp;</span><span class="number">0xff</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span>
<span class="normal">                                  png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_shift</span><span class="symbol">][</span><span class="normal">green</span><span class="symbol">&gt;&gt;</span><span class="number">8</span><span class="symbol">];</span>
<span class="normal">                     </span><span class="usertype">png_uint_16</span><span class="normal"> blue_1  </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_16_to_1</span><span class="symbol">[(</span><span class="normal">blue</span><span class="symbol">&amp;</span><span class="number">0xff</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span>
<span class="normal">                                  png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_shift</span><span class="symbol">][</span><span class="normal">blue</span><span class="symbol">&gt;&gt;</span><span class="number">8</span><span class="symbol">];</span>
<span class="normal">                     </span><span class="usertype">png_uint_16</span><span class="normal"> gray16  </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)((</span><span class="normal">rc </span><span class="symbol">*</span><span class="normal"> red_1</span>
<span class="normal">                                  </span><span class="symbol">+</span><span class="normal"> gc </span><span class="symbol">*</span><span class="normal"> green_1 </span><span class="symbol">+</span><span class="normal"> bc </span><span class="symbol">*</span><span class="normal"> blue_1</span><span class="symbol">)&gt;&gt;</span><span class="number">15</span><span class="symbol">);</span>
<span class="normal">                     w </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_16_from_1</span><span class="symbol">[(</span><span class="normal">gray16</span><span class="symbol">&amp;</span><span class="number">0xff</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span>
<span class="normal">                         png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_shift</span><span class="symbol">][</span><span class="normal">gray16 </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">];</span>
<span class="normal">                     rgb_error </span><span class="symbol">|=</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="cbracket">}</span>

<span class="normal">                  </span><span class="symbol">*(</span><span class="normal">dp</span><span class="symbol">++)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((</span><span class="normal">w</span><span class="symbol">&gt;&gt;</span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                  </span><span class="symbol">*(</span><span class="normal">dp</span><span class="symbol">++)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">w </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                  </span><span class="symbol">*(</span><span class="normal">dp</span><span class="symbol">++)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">sp</span><span class="symbol">++);</span><span class="normal">  </span><span class="comment">/* alpha */</span>
<span class="normal">                  </span><span class="symbol">*(</span><span class="normal">dp</span><span class="symbol">++)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">sp</span><span class="symbol">++);</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="keyword">else</span>
<span class="preproc">#endif</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="usertype">png_bytep</span><span class="normal"> sp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">               </span><span class="usertype">png_bytep</span><span class="normal"> dp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">               </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  </span><span class="usertype">png_uint_16</span><span class="normal"> red</span><span class="symbol">,</span><span class="normal"> green</span><span class="symbol">,</span><span class="normal"> blue</span><span class="symbol">,</span><span class="normal"> gray16</span><span class="symbol">;</span>
<span class="normal">                  red   </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)((*(</span><span class="normal">sp</span><span class="symbol">)&lt;&lt;</span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">|</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">sp</span><span class="symbol">+</span><span class="number">1</span><span class="symbol">));</span><span class="normal"> sp</span><span class="symbol">+=</span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">                  green </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)((*(</span><span class="normal">sp</span><span class="symbol">)&lt;&lt;</span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">|</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">sp</span><span class="symbol">+</span><span class="number">1</span><span class="symbol">));</span><span class="normal"> sp</span><span class="symbol">+=</span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">                  blue  </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)((*(</span><span class="normal">sp</span><span class="symbol">)&lt;&lt;</span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">|</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">sp</span><span class="symbol">+</span><span class="number">1</span><span class="symbol">));</span><span class="normal"> sp</span><span class="symbol">+=</span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">red </span><span class="symbol">!=</span><span class="normal"> green </span><span class="symbol">||</span><span class="normal"> red </span><span class="symbol">!=</span><span class="normal"> blue</span><span class="symbol">)</span>
<span class="normal">                     rgb_error </span><span class="symbol">|=</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">                  gray16  </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)((</span><span class="normal">rc</span><span class="symbol">*</span><span class="normal">red </span><span class="symbol">+</span><span class="normal"> gc</span><span class="symbol">*</span><span class="normal">green </span><span class="symbol">+</span><span class="normal"> bc</span><span class="symbol">*</span><span class="normal">blue</span><span class="symbol">)&gt;&gt;</span><span class="number">15</span><span class="symbol">);</span>
<span class="normal">                  </span><span class="symbol">*(</span><span class="normal">dp</span><span class="symbol">++)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((</span><span class="normal">gray16</span><span class="symbol">&gt;&gt;</span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                  </span><span class="symbol">*(</span><span class="normal">dp</span><span class="symbol">++)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">gray16 </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                  </span><span class="symbol">*(</span><span class="normal">dp</span><span class="symbol">++)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">sp</span><span class="symbol">++);</span><span class="normal">  </span><span class="comment">/* alpha */</span>
<span class="normal">                  </span><span class="symbol">*(</span><span class="normal">dp</span><span class="symbol">++)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">sp</span><span class="symbol">++);</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">   row_info</span><span class="symbol">-&gt;</span><span class="normal">channels </span><span class="symbol">-=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)</span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">      row_info</span><span class="symbol">-&gt;</span><span class="normal">color_type </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="symbol">~</span><span class="normal">PNG_COLOR_MASK_COLOR</span><span class="symbol">;</span>
<span class="normal">      row_info</span><span class="symbol">-&gt;</span><span class="normal">pixel_depth </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">channels </span><span class="symbol">*</span>
<span class="normal">         row_info</span><span class="symbol">-&gt;</span><span class="normal">bit_depth</span><span class="symbol">);</span>
<span class="normal">      row_info</span><span class="symbol">-&gt;</span><span class="normal">rowbytes </span><span class="symbol">=</span><span class="normal"> </span><span class="function">PNG_ROWBYTES</span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">pixel_depth</span><span class="symbol">,</span><span class="normal">row_width</span><span class="symbol">);</span>
<span class="normal">   </span><span class="cbracket">}</span>
<span class="normal">   </span><span class="keyword">return</span><span class="normal"> rgb_error</span><span class="symbol">;</span>
<span class="cbracket">}</span>
<span class="preproc">#endif</span>

<span class="comment">/* Build a grayscale palette.  Palette is assumed to be 1 &lt;&lt; bit_depth</span>
<span class="comment"> * large of png_color.  This lets grayscale images be treated as</span>
<span class="comment"> * paletted.  Most useful for gamma correction and simplification</span>
<span class="comment"> * of code.</span>
<span class="comment"> */</span>
<span class="type">void</span><span class="normal"> PNGAPI</span>
<span class="function">png_build_grayscale_palette</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> bit_depth</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">png_colorp</span><span class="normal"> palette</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">   </span><span class="type">int</span><span class="normal"> num_palette</span><span class="symbol">;</span>
<span class="normal">   </span><span class="type">int</span><span class="normal"> color_inc</span><span class="symbol">;</span>
<span class="normal">   </span><span class="type">int</span><span class="normal"> i</span><span class="symbol">;</span>
<span class="normal">   </span><span class="type">int</span><span class="normal"> v</span><span class="symbol">;</span>

<span class="normal">   </span><span class="function">png_debug</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"in png_do_build_grayscale_palette</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">palette </span><span class="symbol">==</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">      </span><span class="keyword">return</span><span class="symbol">;</span>

<span class="normal">   </span><span class="keyword">switch</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">bit_depth</span><span class="symbol">)</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="keyword">case</span><span class="normal"> </span><span class="number">1</span><span class="symbol">:</span>
<span class="normal">         num_palette </span><span class="symbol">=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">         color_inc </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">;</span>
<span class="normal">         </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">      </span><span class="keyword">case</span><span class="normal"> </span><span class="number">2</span><span class="symbol">:</span>
<span class="normal">         num_palette </span><span class="symbol">=</span><span class="normal"> </span><span class="number">4</span><span class="symbol">;</span>
<span class="normal">         color_inc </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0x55</span><span class="symbol">;</span>
<span class="normal">         </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">      </span><span class="keyword">case</span><span class="normal"> </span><span class="number">4</span><span class="symbol">:</span>
<span class="normal">         num_palette </span><span class="symbol">=</span><span class="normal"> </span><span class="number">16</span><span class="symbol">;</span>
<span class="normal">         color_inc </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0x11</span><span class="symbol">;</span>
<span class="normal">         </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">      </span><span class="keyword">case</span><span class="normal"> </span><span class="number">8</span><span class="symbol">:</span>
<span class="normal">         num_palette </span><span class="symbol">=</span><span class="normal"> </span><span class="number">256</span><span class="symbol">;</span>
<span class="normal">         color_inc </span><span class="symbol">=</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">         </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="label">      default:</span>
<span class="normal">         num_palette </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">         color_inc </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">         </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">   </span><span class="cbracket">}</span>

<span class="normal">   </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> v </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> num_palette</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++,</span><span class="normal"> v </span><span class="symbol">+=</span><span class="normal"> color_inc</span><span class="symbol">)</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">red </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)</span><span class="normal">v</span><span class="symbol">;</span>
<span class="normal">      palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">green </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)</span><span class="normal">v</span><span class="symbol">;</span>
<span class="normal">      palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">blue </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)</span><span class="normal">v</span><span class="symbol">;</span>
<span class="normal">   </span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="comment">/* This function is currently unused.  Do we really need it? */</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_DITHER_SUPPORTED</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_CORRECT_PALETTE_SUPPORTED</span><span class="symbol">)</span>
<span class="type">void</span><span class="normal"> </span><span class="comment">/* PRIVATE */</span>
<span class="function">png_correct_palette</span><span class="symbol">(</span><span class="usertype">png_structp</span><span class="normal"> png_ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">png_colorp</span><span class="normal"> palette</span><span class="symbol">,</span>
<span class="normal">   </span><span class="type">int</span><span class="normal"> num_palette</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">   </span><span class="function">png_debug</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"in png_correct_palette</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_BACKGROUND_SUPPORTED</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">    </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_GAMMA_SUPPORTED</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_FLOATING_POINT_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">PNG_GAMMA </span><span class="symbol">|</span><span class="normal"> PNG_BACKGROUND</span><span class="symbol">))</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="usertype">png_color</span><span class="normal"> back</span><span class="symbol">,</span><span class="normal"> back_1</span><span class="symbol">;</span>

<span class="normal">      </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background_gamma_type </span><span class="symbol">==</span><span class="normal"> PNG_BACKGROUND_GAMMA_FILE</span><span class="symbol">)</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         back</span><span class="symbol">.</span><span class="normal">red </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_table</span><span class="symbol">[</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">red</span><span class="symbol">];</span>
<span class="normal">         back</span><span class="symbol">.</span><span class="normal">green </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_table</span><span class="symbol">[</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">green</span><span class="symbol">];</span>
<span class="normal">         back</span><span class="symbol">.</span><span class="normal">blue </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_table</span><span class="symbol">[</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">blue</span><span class="symbol">];</span>

<span class="normal">         back_1</span><span class="symbol">.</span><span class="normal">red </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_to_1</span><span class="symbol">[</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">red</span><span class="symbol">];</span>
<span class="normal">         back_1</span><span class="symbol">.</span><span class="normal">green </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_to_1</span><span class="symbol">[</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">green</span><span class="symbol">];</span>
<span class="normal">         back_1</span><span class="symbol">.</span><span class="normal">blue </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_to_1</span><span class="symbol">[</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">blue</span><span class="symbol">];</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="keyword">else</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         </span><span class="type">double</span><span class="normal"> g</span><span class="symbol">;</span>

<span class="normal">         g </span><span class="symbol">=</span><span class="normal"> </span><span class="number">1.0</span><span class="normal"> </span><span class="symbol">/</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background_gamma </span><span class="symbol">*</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">screen_gamma</span><span class="symbol">);</span>

<span class="normal">         </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background_gamma_type </span><span class="symbol">==</span><span class="normal"> PNG_BACKGROUND_GAMMA_SCREEN </span><span class="symbol">||</span>
<span class="normal">             </span><span class="function">fabs</span><span class="symbol">(</span><span class="normal">g </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1.0</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&lt;</span><span class="normal"> PNG_GAMMA_THRESHOLD</span><span class="symbol">)</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            back</span><span class="symbol">.</span><span class="normal">red </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">red</span><span class="symbol">;</span>
<span class="normal">            back</span><span class="symbol">.</span><span class="normal">green </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">green</span><span class="symbol">;</span>
<span class="normal">            back</span><span class="symbol">.</span><span class="normal">blue </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">blue</span><span class="symbol">;</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">         </span><span class="keyword">else</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            back</span><span class="symbol">.</span><span class="normal">red </span><span class="symbol">=</span>
<span class="normal">               </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="function">pow</span><span class="symbol">((</span><span class="type">double</span><span class="symbol">)</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">red</span><span class="symbol">/</span><span class="number">255</span><span class="symbol">,</span><span class="normal"> g</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span>
<span class="normal">                </span><span class="number">255.0</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="number">0.5</span><span class="symbol">);</span>
<span class="normal">            back</span><span class="symbol">.</span><span class="normal">green </span><span class="symbol">=</span>
<span class="normal">               </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="function">pow</span><span class="symbol">((</span><span class="type">double</span><span class="symbol">)</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">green</span><span class="symbol">/</span><span class="number">255</span><span class="symbol">,</span><span class="normal"> g</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span>
<span class="normal">                </span><span class="number">255.0</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="number">0.5</span><span class="symbol">);</span>
<span class="normal">            back</span><span class="symbol">.</span><span class="normal">blue </span><span class="symbol">=</span>
<span class="normal">               </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="function">pow</span><span class="symbol">((</span><span class="type">double</span><span class="symbol">)</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">blue</span><span class="symbol">/</span><span class="number">255</span><span class="symbol">,</span><span class="normal"> g</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span>
<span class="normal">                </span><span class="number">255.0</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="number">0.5</span><span class="symbol">);</span>
<span class="normal">         </span><span class="cbracket">}</span>

<span class="normal">         g </span><span class="symbol">=</span><span class="normal"> </span><span class="number">1.0</span><span class="normal"> </span><span class="symbol">/</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background_gamma</span><span class="symbol">;</span>

<span class="normal">         back_1</span><span class="symbol">.</span><span class="normal">red </span><span class="symbol">=</span>
<span class="normal">            </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="function">pow</span><span class="symbol">((</span><span class="type">double</span><span class="symbol">)</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">red</span><span class="symbol">/</span><span class="number">255</span><span class="symbol">,</span><span class="normal"> g</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span>
<span class="normal">             </span><span class="number">255.0</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="number">0.5</span><span class="symbol">);</span>
<span class="normal">         back_1</span><span class="symbol">.</span><span class="normal">green </span><span class="symbol">=</span>
<span class="normal">            </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="function">pow</span><span class="symbol">((</span><span class="type">double</span><span class="symbol">)</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">green</span><span class="symbol">/</span><span class="number">255</span><span class="symbol">,</span><span class="normal"> g</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span>
<span class="normal">             </span><span class="number">255.0</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="number">0.5</span><span class="symbol">);</span>
<span class="normal">         back_1</span><span class="symbol">.</span><span class="normal">blue </span><span class="symbol">=</span>
<span class="normal">            </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="function">pow</span><span class="symbol">((</span><span class="type">double</span><span class="symbol">)</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">blue</span><span class="symbol">/</span><span class="number">255</span><span class="symbol">,</span><span class="normal"> g</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span>
<span class="normal">             </span><span class="number">255.0</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="number">0.5</span><span class="symbol">);</span>
<span class="normal">      </span><span class="cbracket">}</span>

<span class="normal">      </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">color_type </span><span class="symbol">==</span><span class="normal"> PNG_COLOR_TYPE_PALETTE</span><span class="symbol">)</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         </span><span class="usertype">png_uint_32</span><span class="normal"> i</span><span class="symbol">;</span>

<span class="normal">         </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_32</span><span class="symbol">)</span><span class="normal">num_palette</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">&lt;</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">num_trans </span><span class="symbol">&amp;&amp;</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">trans</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> back</span><span class="symbol">;</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">&lt;</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">num_trans </span><span class="symbol">&amp;&amp;</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">trans</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="usertype">png_byte</span><span class="normal"> v</span><span class="symbol">,</span><span class="normal"> w</span><span class="symbol">;</span>

<span class="normal">               v </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_to_1</span><span class="symbol">[</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">red</span><span class="symbol">];</span>
<span class="normal">               </span><span class="function">png_composite</span><span class="symbol">(</span><span class="normal">w</span><span class="symbol">,</span><span class="normal"> v</span><span class="symbol">,</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">trans</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">],</span><span class="normal"> back_1</span><span class="symbol">.</span><span class="normal">red</span><span class="symbol">);</span>
<span class="normal">               palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">red </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_from_1</span><span class="symbol">[</span><span class="normal">w</span><span class="symbol">];</span>

<span class="normal">               v </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_to_1</span><span class="symbol">[</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">green</span><span class="symbol">];</span>
<span class="normal">               </span><span class="function">png_composite</span><span class="symbol">(</span><span class="normal">w</span><span class="symbol">,</span><span class="normal"> v</span><span class="symbol">,</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">trans</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">],</span><span class="normal"> back_1</span><span class="symbol">.</span><span class="normal">green</span><span class="symbol">);</span>
<span class="normal">               palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">green </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_from_1</span><span class="symbol">[</span><span class="normal">w</span><span class="symbol">];</span>

<span class="normal">               v </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_to_1</span><span class="symbol">[</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">blue</span><span class="symbol">];</span>
<span class="normal">               </span><span class="function">png_composite</span><span class="symbol">(</span><span class="normal">w</span><span class="symbol">,</span><span class="normal"> v</span><span class="symbol">,</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">trans</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">],</span><span class="normal"> back_1</span><span class="symbol">.</span><span class="normal">blue</span><span class="symbol">);</span>
<span class="normal">               palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">blue </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_from_1</span><span class="symbol">[</span><span class="normal">w</span><span class="symbol">];</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="keyword">else</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">red </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_table</span><span class="symbol">[</span><span class="normal">palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">red</span><span class="symbol">];</span>
<span class="normal">               palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">green </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_table</span><span class="symbol">[</span><span class="normal">palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">green</span><span class="symbol">];</span>
<span class="normal">               palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">blue </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_table</span><span class="symbol">[</span><span class="normal">palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">blue</span><span class="symbol">];</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="keyword">else</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         </span><span class="type">int</span><span class="normal"> i</span><span class="symbol">;</span>

<span class="normal">         </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> num_palette</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">red </span><span class="symbol">==</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">trans_values</span><span class="symbol">.</span><span class="normal">gray</span><span class="symbol">)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> back</span><span class="symbol">;</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="keyword">else</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">red </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_table</span><span class="symbol">[</span><span class="normal">palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">red</span><span class="symbol">];</span>
<span class="normal">               palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">green </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_table</span><span class="symbol">[</span><span class="normal">palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">green</span><span class="symbol">];</span>
<span class="normal">               palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">blue </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_table</span><span class="symbol">[</span><span class="normal">palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">blue</span><span class="symbol">];</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">   </span><span class="cbracket">}</span>
<span class="normal">   </span><span class="keyword">else</span>
<span class="preproc">#endif</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_GAMMA_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">&amp;</span><span class="normal"> PNG_GAMMA</span><span class="symbol">)</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="type">int</span><span class="normal"> i</span><span class="symbol">;</span>

<span class="normal">      </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> num_palette</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">red </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_table</span><span class="symbol">[</span><span class="normal">palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">red</span><span class="symbol">];</span>
<span class="normal">         palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">green </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_table</span><span class="symbol">[</span><span class="normal">palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">green</span><span class="symbol">];</span>
<span class="normal">         palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">blue </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_table</span><span class="symbol">[</span><span class="normal">palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">blue</span><span class="symbol">];</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">   </span><span class="cbracket">}</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_BACKGROUND_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">else</span>
<span class="preproc">#endif</span>
<span class="preproc">#endif</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_BACKGROUND_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">&amp;</span><span class="normal"> PNG_BACKGROUND</span><span class="symbol">)</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">color_type </span><span class="symbol">==</span><span class="normal"> PNG_COLOR_TYPE_PALETTE</span><span class="symbol">)</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         </span><span class="usertype">png_color</span><span class="normal"> back</span><span class="symbol">;</span>

<span class="normal">         back</span><span class="symbol">.</span><span class="normal">red   </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">red</span><span class="symbol">;</span>
<span class="normal">         back</span><span class="symbol">.</span><span class="normal">green </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">green</span><span class="symbol">;</span>
<span class="normal">         back</span><span class="symbol">.</span><span class="normal">blue  </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">blue</span><span class="symbol">;</span>

<span class="normal">         </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="symbol">)</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">num_trans</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">trans</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">red </span><span class="symbol">=</span><span class="normal"> back</span><span class="symbol">.</span><span class="normal">red</span><span class="symbol">;</span>
<span class="normal">               palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">green </span><span class="symbol">=</span><span class="normal"> back</span><span class="symbol">.</span><span class="normal">green</span><span class="symbol">;</span>
<span class="normal">               palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">blue </span><span class="symbol">=</span><span class="normal"> back</span><span class="symbol">.</span><span class="normal">blue</span><span class="symbol">;</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">trans</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="function">png_composite</span><span class="symbol">(</span><span class="normal">palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">red</span><span class="symbol">,</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">red</span><span class="symbol">,</span>
<span class="normal">                  png_ptr</span><span class="symbol">-&gt;</span><span class="normal">trans</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">],</span><span class="normal"> back</span><span class="symbol">.</span><span class="normal">red</span><span class="symbol">);</span>
<span class="normal">               </span><span class="function">png_composite</span><span class="symbol">(</span><span class="normal">palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">green</span><span class="symbol">,</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">green</span><span class="symbol">,</span>
<span class="normal">                  png_ptr</span><span class="symbol">-&gt;</span><span class="normal">trans</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">],</span><span class="normal"> back</span><span class="symbol">.</span><span class="normal">green</span><span class="symbol">);</span>
<span class="normal">               </span><span class="function">png_composite</span><span class="symbol">(</span><span class="normal">palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">blue</span><span class="symbol">,</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">blue</span><span class="symbol">,</span>
<span class="normal">                  png_ptr</span><span class="symbol">-&gt;</span><span class="normal">trans</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">],</span><span class="normal"> back</span><span class="symbol">.</span><span class="normal">blue</span><span class="symbol">);</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="keyword">else</span><span class="normal"> </span><span class="comment">/* assume grayscale palette (what else could it be?) */</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         </span><span class="type">int</span><span class="normal"> i</span><span class="symbol">;</span>

<span class="normal">         </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> num_palette</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">==</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">trans_values</span><span class="symbol">.</span><span class="normal">gray</span><span class="symbol">)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">red </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">red</span><span class="symbol">;</span>
<span class="normal">               palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">green </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">green</span><span class="symbol">;</span>
<span class="normal">               palette</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">blue </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">background</span><span class="symbol">.</span><span class="normal">blue</span><span class="symbol">;</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">   </span><span class="cbracket">}</span>
<span class="preproc">#endif</span>
<span class="cbracket">}</span>
<span class="preproc">#endif</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_BACKGROUND_SUPPORTED</span><span class="symbol">)</span>
<span class="comment">/* Replace any alpha or transparency with the supplied background color.</span>
<span class="comment"> * "background" is already in the screen gamma, while "background_1" is</span>
<span class="comment"> * at a gamma of 1.0.  Paletted files have already been taken care of.</span>
<span class="comment"> */</span>
<span class="type">void</span><span class="normal"> </span><span class="comment">/* PRIVATE */</span>
<span class="function">png_do_background</span><span class="symbol">(</span><span class="usertype">png_row_infop</span><span class="normal"> row_info</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">png_bytep</span><span class="normal"> row</span><span class="symbol">,</span>
<span class="normal">   </span><span class="usertype">png_color_16p</span><span class="normal"> trans_values</span><span class="symbol">,</span><span class="normal"> png_color_16p background</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_GAMMA_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">png_color_16p</span><span class="normal"> background_1</span><span class="symbol">,</span>
<span class="normal">   </span><span class="usertype">png_bytep</span><span class="normal"> gamma_table</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">png_bytep</span><span class="normal"> gamma_from_1</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">png_bytep</span><span class="normal"> gamma_to_1</span><span class="symbol">,</span>
<span class="normal">   </span><span class="usertype">png_uint_16pp</span><span class="normal"> gamma_16</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">png_uint_16pp</span><span class="normal"> gamma_16_from_1</span><span class="symbol">,</span>
<span class="normal">   </span><span class="usertype">png_uint_16pp</span><span class="normal"> gamma_16_to_1</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> gamma_shift</span>
<span class="preproc">#endif</span>
<span class="normal">   </span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">   </span><span class="usertype">png_bytep</span><span class="normal"> sp</span><span class="symbol">,</span><span class="normal"> dp</span><span class="symbol">;</span>
<span class="normal">   </span><span class="usertype">png_uint_32</span><span class="normal"> i</span><span class="symbol">;</span>
<span class="normal">   </span><span class="usertype">png_uint_32</span><span class="normal"> row_width</span><span class="symbol">=</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">width</span><span class="symbol">;</span>
<span class="normal">   </span><span class="type">int</span><span class="normal"> shift</span><span class="symbol">;</span>

<span class="normal">   </span><span class="function">png_debug</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"in png_do_background</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">background </span><span class="symbol">!=</span><span class="normal"> NULL </span><span class="symbol">&amp;&amp;</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_USELESS_TESTS_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">       row </span><span class="symbol">!=</span><span class="normal"> NULL </span><span class="symbol">&amp;&amp;</span><span class="normal"> row_info </span><span class="symbol">!=</span><span class="normal"> NULL </span><span class="symbol">&amp;&amp;</span>
<span class="preproc">#endif</span>
<span class="normal">      </span><span class="symbol">(!(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">color_type </span><span class="symbol">&amp;</span><span class="normal"> PNG_COLOR_MASK_ALPHA</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">||</span>
<span class="normal">      </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">color_type </span><span class="symbol">!=</span><span class="normal"> PNG_COLOR_TYPE_PALETTE </span><span class="symbol">&amp;&amp;</span><span class="normal"> trans_values</span><span class="symbol">)))</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="keyword">switch</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">color_type</span><span class="symbol">)</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         </span><span class="keyword">case</span><span class="normal"> PNG_COLOR_TYPE_GRAY</span><span class="symbol">:</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="keyword">switch</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">bit_depth</span><span class="symbol">)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="keyword">case</span><span class="normal"> </span><span class="number">1</span><span class="symbol">:</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  sp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">                  shift </span><span class="symbol">=</span><span class="normal"> </span><span class="number">7</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">png_uint_16</span><span class="symbol">)((*</span><span class="normal">sp </span><span class="symbol">&gt;&gt;</span><span class="normal"> shift</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x01</span><span class="symbol">)</span>
<span class="normal">                        </span><span class="symbol">==</span><span class="normal"> trans_values</span><span class="symbol">-&gt;</span><span class="normal">gray</span><span class="symbol">)</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="symbol">*</span><span class="normal">sp </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((</span><span class="number">0x7f7f</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="symbol">(</span><span class="number">7</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> shift</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="symbol">*</span><span class="normal">sp </span><span class="symbol">|=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">background</span><span class="symbol">-&gt;</span><span class="normal">gray </span><span class="symbol">&lt;&lt;</span><span class="normal"> shift</span><span class="symbol">);</span>
<span class="normal">                     </span><span class="cbracket">}</span>
<span class="normal">                     </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">shift</span><span class="symbol">)</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        shift </span><span class="symbol">=</span><span class="normal"> </span><span class="number">7</span><span class="symbol">;</span>
<span class="normal">                        sp</span><span class="symbol">++;</span>
<span class="normal">                     </span><span class="cbracket">}</span>
<span class="normal">                     </span><span class="keyword">else</span>
<span class="normal">                        shift</span><span class="symbol">--;</span>
<span class="normal">                  </span><span class="cbracket">}</span>
<span class="normal">                  </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="keyword">case</span><span class="normal"> </span><span class="number">2</span><span class="symbol">:</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_GAMMA_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">                  </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gamma_table </span><span class="symbol">!=</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     sp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">                     shift </span><span class="symbol">=</span><span class="normal"> </span><span class="number">6</span><span class="symbol">;</span>
<span class="normal">                     </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">png_uint_16</span><span class="symbol">)((*</span><span class="normal">sp </span><span class="symbol">&gt;&gt;</span><span class="normal"> shift</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x03</span><span class="symbol">)</span>
<span class="normal">                            </span><span class="symbol">==</span><span class="normal"> trans_values</span><span class="symbol">-&gt;</span><span class="normal">gray</span><span class="symbol">)</span>
<span class="normal">                        </span><span class="cbracket">{</span>
<span class="normal">                           </span><span class="symbol">*</span><span class="normal">sp </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((</span><span class="number">0x3f3f</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="symbol">(</span><span class="number">6</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> shift</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                           </span><span class="symbol">*</span><span class="normal">sp </span><span class="symbol">|=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">background</span><span class="symbol">-&gt;</span><span class="normal">gray </span><span class="symbol">&lt;&lt;</span><span class="normal"> shift</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="cbracket">}</span>
<span class="normal">                        </span><span class="keyword">else</span>
<span class="normal">                        </span><span class="cbracket">{</span>
<span class="normal">                           </span><span class="usertype">png_byte</span><span class="normal"> p </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((*</span><span class="normal">sp </span><span class="symbol">&gt;&gt;</span><span class="normal"> shift</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x03</span><span class="symbol">);</span>
<span class="normal">                           </span><span class="usertype">png_byte</span><span class="normal"> g </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((</span><span class="normal">gamma_table </span><span class="symbol">[</span><span class="normal">p </span><span class="symbol">|</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">p </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">|</span>
<span class="normal">                               </span><span class="symbol">(</span><span class="normal">p </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">4</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">|</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">p </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">6</span><span class="symbol">)]</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">6</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x03</span><span class="symbol">);</span>
<span class="normal">                           </span><span class="symbol">*</span><span class="normal">sp </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((</span><span class="number">0x3f3f</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="symbol">(</span><span class="number">6</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> shift</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                           </span><span class="symbol">*</span><span class="normal">sp </span><span class="symbol">|=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">g </span><span class="symbol">&lt;&lt;</span><span class="normal"> shift</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="cbracket">}</span>
<span class="normal">                        </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">shift</span><span class="symbol">)</span>
<span class="normal">                        </span><span class="cbracket">{</span>
<span class="normal">                           shift </span><span class="symbol">=</span><span class="normal"> </span><span class="number">6</span><span class="symbol">;</span>
<span class="normal">                           sp</span><span class="symbol">++;</span>
<span class="normal">                        </span><span class="cbracket">}</span>
<span class="normal">                        </span><span class="keyword">else</span>
<span class="normal">                           shift </span><span class="symbol">-=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">                     </span><span class="cbracket">}</span>
<span class="normal">                  </span><span class="cbracket">}</span>
<span class="normal">                  </span><span class="keyword">else</span>
<span class="preproc">#endif</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     sp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">                     shift </span><span class="symbol">=</span><span class="normal"> </span><span class="number">6</span><span class="symbol">;</span>
<span class="normal">                     </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">png_uint_16</span><span class="symbol">)((*</span><span class="normal">sp </span><span class="symbol">&gt;&gt;</span><span class="normal"> shift</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x03</span><span class="symbol">)</span>
<span class="normal">                            </span><span class="symbol">==</span><span class="normal"> trans_values</span><span class="symbol">-&gt;</span><span class="normal">gray</span><span class="symbol">)</span>
<span class="normal">                        </span><span class="cbracket">{</span>
<span class="normal">                           </span><span class="symbol">*</span><span class="normal">sp </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((</span><span class="number">0x3f3f</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="symbol">(</span><span class="number">6</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> shift</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                           </span><span class="symbol">*</span><span class="normal">sp </span><span class="symbol">|=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">background</span><span class="symbol">-&gt;</span><span class="normal">gray </span><span class="symbol">&lt;&lt;</span><span class="normal"> shift</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="cbracket">}</span>
<span class="normal">                        </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">shift</span><span class="symbol">)</span>
<span class="normal">                        </span><span class="cbracket">{</span>
<span class="normal">                           shift </span><span class="symbol">=</span><span class="normal"> </span><span class="number">6</span><span class="symbol">;</span>
<span class="normal">                           sp</span><span class="symbol">++;</span>
<span class="normal">                        </span><span class="cbracket">}</span>
<span class="normal">                        </span><span class="keyword">else</span>
<span class="normal">                           shift </span><span class="symbol">-=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">                     </span><span class="cbracket">}</span>
<span class="normal">                  </span><span class="cbracket">}</span>
<span class="normal">                  </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="keyword">case</span><span class="normal"> </span><span class="number">4</span><span class="symbol">:</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_GAMMA_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">                  </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gamma_table </span><span class="symbol">!=</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     sp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">                     shift </span><span class="symbol">=</span><span class="normal"> </span><span class="number">4</span><span class="symbol">;</span>
<span class="normal">                     </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">png_uint_16</span><span class="symbol">)((*</span><span class="normal">sp </span><span class="symbol">&gt;&gt;</span><span class="normal"> shift</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x0f</span><span class="symbol">)</span>
<span class="normal">                            </span><span class="symbol">==</span><span class="normal"> trans_values</span><span class="symbol">-&gt;</span><span class="normal">gray</span><span class="symbol">)</span>
<span class="normal">                        </span><span class="cbracket">{</span>
<span class="normal">                           </span><span class="symbol">*</span><span class="normal">sp </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((</span><span class="number">0xf0f</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="symbol">(</span><span class="number">4</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> shift</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                           </span><span class="symbol">*</span><span class="normal">sp </span><span class="symbol">|=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">background</span><span class="symbol">-&gt;</span><span class="normal">gray </span><span class="symbol">&lt;&lt;</span><span class="normal"> shift</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="cbracket">}</span>
<span class="normal">                        </span><span class="keyword">else</span>
<span class="normal">                        </span><span class="cbracket">{</span>
<span class="normal">                           </span><span class="usertype">png_byte</span><span class="normal"> p </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((*</span><span class="normal">sp </span><span class="symbol">&gt;&gt;</span><span class="normal"> shift</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x0f</span><span class="symbol">);</span>
<span class="normal">                           </span><span class="usertype">png_byte</span><span class="normal"> g </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((</span><span class="normal">gamma_table</span><span class="symbol">[</span><span class="normal">p </span><span class="symbol">|</span>
<span class="normal">                             </span><span class="symbol">(</span><span class="normal">p </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">4</span><span class="symbol">)]</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">4</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x0f</span><span class="symbol">);</span>
<span class="normal">                           </span><span class="symbol">*</span><span class="normal">sp </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((</span><span class="number">0xf0f</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="symbol">(</span><span class="number">4</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> shift</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                           </span><span class="symbol">*</span><span class="normal">sp </span><span class="symbol">|=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">g </span><span class="symbol">&lt;&lt;</span><span class="normal"> shift</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="cbracket">}</span>
<span class="normal">                        </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">shift</span><span class="symbol">)</span>
<span class="normal">                        </span><span class="cbracket">{</span>
<span class="normal">                           shift </span><span class="symbol">=</span><span class="normal"> </span><span class="number">4</span><span class="symbol">;</span>
<span class="normal">                           sp</span><span class="symbol">++;</span>
<span class="normal">                        </span><span class="cbracket">}</span>
<span class="normal">                        </span><span class="keyword">else</span>
<span class="normal">                           shift </span><span class="symbol">-=</span><span class="normal"> </span><span class="number">4</span><span class="symbol">;</span>
<span class="normal">                     </span><span class="cbracket">}</span>
<span class="normal">                  </span><span class="cbracket">}</span>
<span class="normal">                  </span><span class="keyword">else</span>
<span class="preproc">#endif</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     sp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">                     shift </span><span class="symbol">=</span><span class="normal"> </span><span class="number">4</span><span class="symbol">;</span>
<span class="normal">                     </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">png_uint_16</span><span class="symbol">)((*</span><span class="normal">sp </span><span class="symbol">&gt;&gt;</span><span class="normal"> shift</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x0f</span><span class="symbol">)</span>
<span class="normal">                            </span><span class="symbol">==</span><span class="normal"> trans_values</span><span class="symbol">-&gt;</span><span class="normal">gray</span><span class="symbol">)</span>
<span class="normal">                        </span><span class="cbracket">{</span>
<span class="normal">                           </span><span class="symbol">*</span><span class="normal">sp </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((</span><span class="number">0xf0f</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="symbol">(</span><span class="number">4</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> shift</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                           </span><span class="symbol">*</span><span class="normal">sp </span><span class="symbol">|=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">background</span><span class="symbol">-&gt;</span><span class="normal">gray </span><span class="symbol">&lt;&lt;</span><span class="normal"> shift</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="cbracket">}</span>
<span class="normal">                        </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">shift</span><span class="symbol">)</span>
<span class="normal">                        </span><span class="cbracket">{</span>
<span class="normal">                           shift </span><span class="symbol">=</span><span class="normal"> </span><span class="number">4</span><span class="symbol">;</span>
<span class="normal">                           sp</span><span class="symbol">++;</span>
<span class="normal">                        </span><span class="cbracket">}</span>
<span class="normal">                        </span><span class="keyword">else</span>
<span class="normal">                           shift </span><span class="symbol">-=</span><span class="normal"> </span><span class="number">4</span><span class="symbol">;</span>
<span class="normal">                     </span><span class="cbracket">}</span>
<span class="normal">                  </span><span class="cbracket">}</span>
<span class="normal">                  </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="keyword">case</span><span class="normal"> </span><span class="number">8</span><span class="symbol">:</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_GAMMA_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">                  </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gamma_table </span><span class="symbol">!=</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     sp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">                     </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++,</span><span class="normal"> sp</span><span class="symbol">++)</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(*</span><span class="normal">sp </span><span class="symbol">==</span><span class="normal"> trans_values</span><span class="symbol">-&gt;</span><span class="normal">gray</span><span class="symbol">)</span>
<span class="normal">                        </span><span class="cbracket">{</span>
<span class="normal">                           </span><span class="symbol">*</span><span class="normal">sp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)</span><span class="normal">background</span><span class="symbol">-&gt;</span><span class="normal">gray</span><span class="symbol">;</span>
<span class="normal">                        </span><span class="cbracket">}</span>
<span class="normal">                        </span><span class="keyword">else</span>
<span class="normal">                        </span><span class="cbracket">{</span>
<span class="normal">                           </span><span class="symbol">*</span><span class="normal">sp </span><span class="symbol">=</span><span class="normal"> gamma_table</span><span class="symbol">[*</span><span class="normal">sp</span><span class="symbol">];</span>
<span class="normal">                        </span><span class="cbracket">}</span>
<span class="normal">                     </span><span class="cbracket">}</span>
<span class="normal">                  </span><span class="cbracket">}</span>
<span class="normal">                  </span><span class="keyword">else</span>
<span class="preproc">#endif</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     sp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">                     </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++,</span><span class="normal"> sp</span><span class="symbol">++)</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(*</span><span class="normal">sp </span><span class="symbol">==</span><span class="normal"> trans_values</span><span class="symbol">-&gt;</span><span class="normal">gray</span><span class="symbol">)</span>
<span class="normal">                        </span><span class="cbracket">{</span>
<span class="normal">                           </span><span class="symbol">*</span><span class="normal">sp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)</span><span class="normal">background</span><span class="symbol">-&gt;</span><span class="normal">gray</span><span class="symbol">;</span>
<span class="normal">                        </span><span class="cbracket">}</span>
<span class="normal">                     </span><span class="cbracket">}</span>
<span class="normal">                  </span><span class="cbracket">}</span>
<span class="normal">                  </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="keyword">case</span><span class="normal"> </span><span class="number">16</span><span class="symbol">:</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_GAMMA_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">                  </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gamma_16 </span><span class="symbol">!=</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     sp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">                     </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++,</span><span class="normal"> sp </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="usertype">png_uint_16</span><span class="normal"> v</span><span class="symbol">;</span>

<span class="normal">                        v </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)(((*</span><span class="normal">sp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">));</span>
<span class="normal">                        </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">v </span><span class="symbol">==</span><span class="normal"> trans_values</span><span class="symbol">-&gt;</span><span class="normal">gray</span><span class="symbol">)</span>
<span class="normal">                        </span><span class="cbracket">{</span>
<span class="normal">                           </span><span class="comment">/* background is already in screen gamma */</span>
<span class="normal">                           </span><span class="symbol">*</span><span class="normal">sp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((</span><span class="normal">background</span><span class="symbol">-&gt;</span><span class="normal">gray </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                           </span><span class="symbol">*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">background</span><span class="symbol">-&gt;</span><span class="normal">gray </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="cbracket">}</span>
<span class="normal">                        </span><span class="keyword">else</span>
<span class="normal">                        </span><span class="cbracket">{</span>
<span class="normal">                           v </span><span class="symbol">=</span><span class="normal"> gamma_16</span><span class="symbol">[*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> gamma_shift</span><span class="symbol">][*</span><span class="normal">sp</span><span class="symbol">];</span>
<span class="normal">                           </span><span class="symbol">*</span><span class="normal">sp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((</span><span class="normal">v </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                           </span><span class="symbol">*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">v </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="cbracket">}</span>
<span class="normal">                     </span><span class="cbracket">}</span>
<span class="normal">                  </span><span class="cbracket">}</span>
<span class="normal">                  </span><span class="keyword">else</span>
<span class="preproc">#endif</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     sp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">                     </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++,</span><span class="normal"> sp </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="usertype">png_uint_16</span><span class="normal"> v</span><span class="symbol">;</span>

<span class="normal">                        v </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)(((*</span><span class="normal">sp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">));</span>
<span class="normal">                        </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">v </span><span class="symbol">==</span><span class="normal"> trans_values</span><span class="symbol">-&gt;</span><span class="normal">gray</span><span class="symbol">)</span>
<span class="normal">                        </span><span class="cbracket">{</span>
<span class="normal">                           </span><span class="symbol">*</span><span class="normal">sp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((</span><span class="normal">background</span><span class="symbol">-&gt;</span><span class="normal">gray </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                           </span><span class="symbol">*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">background</span><span class="symbol">-&gt;</span><span class="normal">gray </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="cbracket">}</span>
<span class="normal">                     </span><span class="cbracket">}</span>
<span class="normal">                  </span><span class="cbracket">}</span>
<span class="normal">                  </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">         </span><span class="keyword">case</span><span class="normal"> PNG_COLOR_TYPE_RGB</span><span class="symbol">:</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">bit_depth </span><span class="symbol">==</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_GAMMA_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">               </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gamma_table </span><span class="symbol">!=</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  sp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++,</span><span class="normal"> sp </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">3</span><span class="symbol">)</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(*</span><span class="normal">sp </span><span class="symbol">==</span><span class="normal"> trans_values</span><span class="symbol">-&gt;</span><span class="normal">red </span><span class="symbol">&amp;&amp;</span>
<span class="normal">                        </span><span class="symbol">*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> trans_values</span><span class="symbol">-&gt;</span><span class="normal">green </span><span class="symbol">&amp;&amp;</span>
<span class="normal">                        </span><span class="symbol">*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> trans_values</span><span class="symbol">-&gt;</span><span class="normal">blue</span><span class="symbol">)</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="symbol">*</span><span class="normal">sp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)</span><span class="normal">background</span><span class="symbol">-&gt;</span><span class="normal">red</span><span class="symbol">;</span>
<span class="normal">                        </span><span class="symbol">*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)</span><span class="normal">background</span><span class="symbol">-&gt;</span><span class="normal">green</span><span class="symbol">;</span>
<span class="normal">                        </span><span class="symbol">*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)</span><span class="normal">background</span><span class="symbol">-&gt;</span><span class="normal">blue</span><span class="symbol">;</span>
<span class="normal">                     </span><span class="cbracket">}</span>
<span class="normal">                     </span><span class="keyword">else</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="symbol">*</span><span class="normal">sp </span><span class="symbol">=</span><span class="normal"> gamma_table</span><span class="symbol">[*</span><span class="normal">sp</span><span class="symbol">];</span>
<span class="normal">                        </span><span class="symbol">*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> gamma_table</span><span class="symbol">[*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)];</span>
<span class="normal">                        </span><span class="symbol">*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> gamma_table</span><span class="symbol">[*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)];</span>
<span class="normal">                     </span><span class="cbracket">}</span>
<span class="normal">                  </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="keyword">else</span>
<span class="preproc">#endif</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  sp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++,</span><span class="normal"> sp </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">3</span><span class="symbol">)</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(*</span><span class="normal">sp </span><span class="symbol">==</span><span class="normal"> trans_values</span><span class="symbol">-&gt;</span><span class="normal">red </span><span class="symbol">&amp;&amp;</span>
<span class="normal">                        </span><span class="symbol">*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> trans_values</span><span class="symbol">-&gt;</span><span class="normal">green </span><span class="symbol">&amp;&amp;</span>
<span class="normal">                        </span><span class="symbol">*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> trans_values</span><span class="symbol">-&gt;</span><span class="normal">blue</span><span class="symbol">)</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="symbol">*</span><span class="normal">sp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)</span><span class="normal">background</span><span class="symbol">-&gt;</span><span class="normal">red</span><span class="symbol">;</span>
<span class="normal">                        </span><span class="symbol">*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)</span><span class="normal">background</span><span class="symbol">-&gt;</span><span class="normal">green</span><span class="symbol">;</span>
<span class="normal">                        </span><span class="symbol">*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)</span><span class="normal">background</span><span class="symbol">-&gt;</span><span class="normal">blue</span><span class="symbol">;</span>
<span class="normal">                     </span><span class="cbracket">}</span>
<span class="normal">                  </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="keyword">else</span><span class="normal"> </span><span class="comment">/* if (row_info-&gt;bit_depth == 16) */</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_GAMMA_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">               </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gamma_16 </span><span class="symbol">!=</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  sp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++,</span><span class="normal"> sp </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">6</span><span class="symbol">)</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     </span><span class="usertype">png_uint_16</span><span class="normal"> r </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)(((*</span><span class="normal">sp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">));</span>
<span class="normal">                     </span><span class="usertype">png_uint_16</span><span class="normal"> g </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)(((*(</span><span class="normal">sp</span><span class="symbol">+</span><span class="number">2</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">sp</span><span class="symbol">+</span><span class="number">3</span><span class="symbol">));</span>
<span class="normal">                     </span><span class="usertype">png_uint_16</span><span class="normal"> b </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)(((*(</span><span class="normal">sp</span><span class="symbol">+</span><span class="number">4</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">sp</span><span class="symbol">+</span><span class="number">5</span><span class="symbol">));</span>
<span class="normal">                     </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">r </span><span class="symbol">==</span><span class="normal"> trans_values</span><span class="symbol">-&gt;</span><span class="normal">red </span><span class="symbol">&amp;&amp;</span><span class="normal"> g </span><span class="symbol">==</span><span class="normal"> trans_values</span><span class="symbol">-&gt;</span><span class="normal">green </span><span class="symbol">&amp;&amp;</span>
<span class="normal">                        b </span><span class="symbol">==</span><span class="normal"> trans_values</span><span class="symbol">-&gt;</span><span class="normal">blue</span><span class="symbol">)</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="comment">/* background is already in screen gamma */</span>
<span class="normal">                        </span><span class="symbol">*</span><span class="normal">sp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((</span><span class="normal">background</span><span class="symbol">-&gt;</span><span class="normal">red </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="symbol">*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">background</span><span class="symbol">-&gt;</span><span class="normal">red </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="symbol">*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((</span><span class="normal">background</span><span class="symbol">-&gt;</span><span class="normal">green </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="symbol">*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">3</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">background</span><span class="symbol">-&gt;</span><span class="normal">green </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="symbol">*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">4</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((</span><span class="normal">background</span><span class="symbol">-&gt;</span><span class="normal">blue </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="symbol">*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">5</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">background</span><span class="symbol">-&gt;</span><span class="normal">blue </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                     </span><span class="cbracket">}</span>
<span class="normal">                     </span><span class="keyword">else</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="usertype">png_uint_16</span><span class="normal"> v </span><span class="symbol">=</span><span class="normal"> gamma_16</span><span class="symbol">[*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> gamma_shift</span><span class="symbol">][*</span><span class="normal">sp</span><span class="symbol">];</span>
<span class="normal">                        </span><span class="symbol">*</span><span class="normal">sp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((</span><span class="normal">v </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="symbol">*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">v </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                        v </span><span class="symbol">=</span><span class="normal"> gamma_16</span><span class="symbol">[*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">3</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> gamma_shift</span><span class="symbol">][*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)];</span>
<span class="normal">                        </span><span class="symbol">*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((</span><span class="normal">v </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="symbol">*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">3</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">v </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                        v </span><span class="symbol">=</span><span class="normal"> gamma_16</span><span class="symbol">[*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">5</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> gamma_shift</span><span class="symbol">][*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">4</span><span class="symbol">)];</span>
<span class="normal">                        </span><span class="symbol">*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">4</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((</span><span class="normal">v </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="symbol">*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">5</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">v </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                     </span><span class="cbracket">}</span>
<span class="normal">                  </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="keyword">else</span>
<span class="preproc">#endif</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  sp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++,</span><span class="normal"> sp </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">6</span><span class="symbol">)</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     </span><span class="usertype">png_uint_16</span><span class="normal"> r </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)(((*</span><span class="normal">sp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">sp</span><span class="symbol">+</span><span class="number">1</span><span class="symbol">));</span>
<span class="normal">                     </span><span class="usertype">png_uint_16</span><span class="normal"> g </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)(((*(</span><span class="normal">sp</span><span class="symbol">+</span><span class="number">2</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">sp</span><span class="symbol">+</span><span class="number">3</span><span class="symbol">));</span>
<span class="normal">                     </span><span class="usertype">png_uint_16</span><span class="normal"> b </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)(((*(</span><span class="normal">sp</span><span class="symbol">+</span><span class="number">4</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">sp</span><span class="symbol">+</span><span class="number">5</span><span class="symbol">));</span>

<span class="normal">                     </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">r </span><span class="symbol">==</span><span class="normal"> trans_values</span><span class="symbol">-&gt;</span><span class="normal">red </span><span class="symbol">&amp;&amp;</span><span class="normal"> g </span><span class="symbol">==</span><span class="normal"> trans_values</span><span class="symbol">-&gt;</span><span class="normal">green </span><span class="symbol">&amp;&amp;</span>
<span class="normal">                        b </span><span class="symbol">==</span><span class="normal"> trans_values</span><span class="symbol">-&gt;</span><span class="normal">blue</span><span class="symbol">)</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="symbol">*</span><span class="normal">sp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((</span><span class="normal">background</span><span class="symbol">-&gt;</span><span class="normal">red </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="symbol">*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">background</span><span class="symbol">-&gt;</span><span class="normal">red </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="symbol">*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((</span><span class="normal">background</span><span class="symbol">-&gt;</span><span class="normal">green </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="symbol">*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">3</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">background</span><span class="symbol">-&gt;</span><span class="normal">green </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="symbol">*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">4</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((</span><span class="normal">background</span><span class="symbol">-&gt;</span><span class="normal">blue </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="symbol">*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">5</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">background</span><span class="symbol">-&gt;</span><span class="normal">blue </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                     </span><span class="cbracket">}</span>
<span class="normal">                  </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">         </span><span class="keyword">case</span><span class="normal"> PNG_COLOR_TYPE_GRAY_ALPHA</span><span class="symbol">:</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">bit_depth </span><span class="symbol">==</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_GAMMA_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">               </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gamma_to_1 </span><span class="symbol">!=</span><span class="normal"> NULL </span><span class="symbol">&amp;&amp;</span><span class="normal"> gamma_from_1 </span><span class="symbol">!=</span><span class="normal"> NULL </span><span class="symbol">&amp;&amp;</span>
<span class="normal">                   gamma_table </span><span class="symbol">!=</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  sp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">                  dp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++,</span><span class="normal"> sp </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">,</span><span class="normal"> dp</span><span class="symbol">++)</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     </span><span class="usertype">png_uint_16</span><span class="normal"> a </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>

<span class="normal">                     </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">a </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">)</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="symbol">*</span><span class="normal">dp </span><span class="symbol">=</span><span class="normal"> gamma_table</span><span class="symbol">[*</span><span class="normal">sp</span><span class="symbol">];</span>
<span class="normal">                     </span><span class="cbracket">}</span>
<span class="normal">                     </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">a </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="comment">/* background is already in screen gamma */</span>
<span class="normal">                        </span><span class="symbol">*</span><span class="normal">dp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)</span><span class="normal">background</span><span class="symbol">-&gt;</span><span class="normal">gray</span><span class="symbol">;</span>
<span class="normal">                     </span><span class="cbracket">}</span>
<span class="normal">                     </span><span class="keyword">else</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="usertype">png_byte</span><span class="normal"> v</span><span class="symbol">,</span><span class="normal"> w</span><span class="symbol">;</span>

<span class="normal">                        v </span><span class="symbol">=</span><span class="normal"> gamma_to_1</span><span class="symbol">[*</span><span class="normal">sp</span><span class="symbol">];</span>
<span class="normal">                        </span><span class="function">png_composite</span><span class="symbol">(</span><span class="normal">w</span><span class="symbol">,</span><span class="normal"> v</span><span class="symbol">,</span><span class="normal"> a</span><span class="symbol">,</span><span class="normal"> background_1</span><span class="symbol">-&gt;</span><span class="normal">gray</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="symbol">*</span><span class="normal">dp </span><span class="symbol">=</span><span class="normal"> gamma_from_1</span><span class="symbol">[</span><span class="normal">w</span><span class="symbol">];</span>
<span class="normal">                     </span><span class="cbracket">}</span>
<span class="normal">                  </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="keyword">else</span>
<span class="preproc">#endif</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  sp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">                  dp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++,</span><span class="normal"> sp </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">,</span><span class="normal"> dp</span><span class="symbol">++)</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     </span><span class="usertype">png_byte</span><span class="normal"> a </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>

<span class="normal">                     </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">a </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">)</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="symbol">*</span><span class="normal">dp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">sp</span><span class="symbol">;</span>
<span class="normal">                     </span><span class="cbracket">}</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_GAMMA_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">                     </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">a </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="symbol">*</span><span class="normal">dp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)</span><span class="normal">background</span><span class="symbol">-&gt;</span><span class="normal">gray</span><span class="symbol">;</span>
<span class="normal">                     </span><span class="cbracket">}</span>
<span class="normal">                     </span><span class="keyword">else</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="function">png_composite</span><span class="symbol">(*</span><span class="normal">dp</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">sp</span><span class="symbol">,</span><span class="normal"> a</span><span class="symbol">,</span><span class="normal"> background_1</span><span class="symbol">-&gt;</span><span class="normal">gray</span><span class="symbol">);</span>
<span class="normal">                     </span><span class="cbracket">}</span>
<span class="preproc">#else</span>
<span class="normal">                     </span><span class="symbol">*</span><span class="normal">dp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)</span><span class="normal">background</span><span class="symbol">-&gt;</span><span class="normal">gray</span><span class="symbol">;</span>
<span class="preproc">#endif</span>
<span class="normal">                  </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="keyword">else</span><span class="normal"> </span><span class="comment">/* if (png_ptr-&gt;bit_depth == 16) */</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_GAMMA_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">               </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gamma_16 </span><span class="symbol">!=</span><span class="normal"> NULL </span><span class="symbol">&amp;&amp;</span><span class="normal"> gamma_16_from_1 </span><span class="symbol">!=</span><span class="normal"> NULL </span><span class="symbol">&amp;&amp;</span>
<span class="normal">                   gamma_16_to_1 </span><span class="symbol">!=</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  sp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">                  dp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++,</span><span class="normal"> sp </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">4</span><span class="symbol">,</span><span class="normal"> dp </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     </span><span class="usertype">png_uint_16</span><span class="normal"> a </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)(((*(</span><span class="normal">sp</span><span class="symbol">+</span><span class="number">2</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">sp</span><span class="symbol">+</span><span class="number">3</span><span class="symbol">));</span>

<span class="normal">                     </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">a </span><span class="symbol">==</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)</span><span class="number">0xffff</span><span class="symbol">)</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="usertype">png_uint_16</span><span class="normal"> v</span><span class="symbol">;</span>

<span class="normal">                        v </span><span class="symbol">=</span><span class="normal"> gamma_16</span><span class="symbol">[*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> gamma_shift</span><span class="symbol">][*</span><span class="normal">sp</span><span class="symbol">];</span>
<span class="normal">                        </span><span class="symbol">*</span><span class="normal">dp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((</span><span class="normal">v </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="symbol">*(</span><span class="normal">dp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">v </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                     </span><span class="cbracket">}</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_GAMMA_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">                     </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">a </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="preproc">#else</span>
<span class="normal">                     </span><span class="keyword">else</span>
<span class="preproc">#endif</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="comment">/* background is already in screen gamma */</span>
<span class="normal">                        </span><span class="symbol">*</span><span class="normal">dp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((</span><span class="normal">background</span><span class="symbol">-&gt;</span><span class="normal">gray </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="symbol">*(</span><span class="normal">dp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">background</span><span class="symbol">-&gt;</span><span class="normal">gray </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                     </span><span class="cbracket">}</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_GAMMA_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">                     </span><span class="keyword">else</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="usertype">png_uint_16</span><span class="normal"> g</span><span class="symbol">,</span><span class="normal"> v</span><span class="symbol">,</span><span class="normal"> w</span><span class="symbol">;</span>

<span class="normal">                        g </span><span class="symbol">=</span><span class="normal"> gamma_16_to_1</span><span class="symbol">[*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> gamma_shift</span><span class="symbol">][*</span><span class="normal">sp</span><span class="symbol">];</span>
<span class="normal">                        </span><span class="function">png_composite_16</span><span class="symbol">(</span><span class="normal">v</span><span class="symbol">,</span><span class="normal"> g</span><span class="symbol">,</span><span class="normal"> a</span><span class="symbol">,</span><span class="normal"> background_1</span><span class="symbol">-&gt;</span><span class="normal">gray</span><span class="symbol">);</span>
<span class="normal">                        w </span><span class="symbol">=</span><span class="normal"> gamma_16_from_1</span><span class="symbol">[(</span><span class="normal">v</span><span class="symbol">&amp;</span><span class="number">0xff</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> gamma_shift</span><span class="symbol">][</span><span class="normal">v </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">];</span>
<span class="normal">                        </span><span class="symbol">*</span><span class="normal">dp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((</span><span class="normal">w </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="symbol">*(</span><span class="normal">dp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">w </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                     </span><span class="cbracket">}</span>
<span class="preproc">#endif</span>
<span class="normal">                  </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="keyword">else</span>
<span class="preproc">#endif</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  sp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">                  dp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++,</span><span class="normal"> sp </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">4</span><span class="symbol">,</span><span class="normal"> dp </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     </span><span class="usertype">png_uint_16</span><span class="normal"> a </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)(((*(</span><span class="normal">sp</span><span class="symbol">+</span><span class="number">2</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">sp</span><span class="symbol">+</span><span class="number">3</span><span class="symbol">));</span>
<span class="normal">                     </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">a </span><span class="symbol">==</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)</span><span class="number">0xffff</span><span class="symbol">)</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="function">png_memcpy</span><span class="symbol">(</span><span class="normal">dp</span><span class="symbol">,</span><span class="normal"> sp</span><span class="symbol">,</span><span class="normal"> </span><span class="number">2</span><span class="symbol">);</span>
<span class="normal">                     </span><span class="cbracket">}</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_GAMMA_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">                     </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">a </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="preproc">#else</span>
<span class="normal">                     </span><span class="keyword">else</span>
<span class="preproc">#endif</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="symbol">*</span><span class="normal">dp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((</span><span class="normal">background</span><span class="symbol">-&gt;</span><span class="normal">gray </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="symbol">*(</span><span class="normal">dp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">background</span><span class="symbol">-&gt;</span><span class="normal">gray </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                     </span><span class="cbracket">}</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_GAMMA_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">                     </span><span class="keyword">else</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="usertype">png_uint_16</span><span class="normal"> g</span><span class="symbol">,</span><span class="normal"> v</span><span class="symbol">;</span>

<span class="normal">                        g </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)(((*</span><span class="normal">sp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">));</span>
<span class="normal">                        </span><span class="function">png_composite_16</span><span class="symbol">(</span><span class="normal">v</span><span class="symbol">,</span><span class="normal"> g</span><span class="symbol">,</span><span class="normal"> a</span><span class="symbol">,</span><span class="normal"> background_1</span><span class="symbol">-&gt;</span><span class="normal">gray</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="symbol">*</span><span class="normal">dp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((</span><span class="normal">v </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="symbol">*(</span><span class="normal">dp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">v </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                     </span><span class="cbracket">}</span>
<span class="preproc">#endif</span>
<span class="normal">                  </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">         </span><span class="keyword">case</span><span class="normal"> PNG_COLOR_TYPE_RGB_ALPHA</span><span class="symbol">:</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">bit_depth </span><span class="symbol">==</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_GAMMA_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">               </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gamma_to_1 </span><span class="symbol">!=</span><span class="normal"> NULL </span><span class="symbol">&amp;&amp;</span><span class="normal"> gamma_from_1 </span><span class="symbol">!=</span><span class="normal"> NULL </span><span class="symbol">&amp;&amp;</span>
<span class="normal">                   gamma_table </span><span class="symbol">!=</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  sp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">                  dp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++,</span><span class="normal"> sp </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">4</span><span class="symbol">,</span><span class="normal"> dp </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">3</span><span class="symbol">)</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     </span><span class="usertype">png_byte</span><span class="normal"> a </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">3</span><span class="symbol">);</span>

<span class="normal">                     </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">a </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">)</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="symbol">*</span><span class="normal">dp </span><span class="symbol">=</span><span class="normal"> gamma_table</span><span class="symbol">[*</span><span class="normal">sp</span><span class="symbol">];</span>
<span class="normal">                        </span><span class="symbol">*(</span><span class="normal">dp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> gamma_table</span><span class="symbol">[*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)];</span>
<span class="normal">                        </span><span class="symbol">*(</span><span class="normal">dp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> gamma_table</span><span class="symbol">[*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)];</span>
<span class="normal">                     </span><span class="cbracket">}</span>
<span class="normal">                     </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">a </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="comment">/* background is already in screen gamma */</span>
<span class="normal">                        </span><span class="symbol">*</span><span class="normal">dp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)</span><span class="normal">background</span><span class="symbol">-&gt;</span><span class="normal">red</span><span class="symbol">;</span>
<span class="normal">                        </span><span class="symbol">*(</span><span class="normal">dp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)</span><span class="normal">background</span><span class="symbol">-&gt;</span><span class="normal">green</span><span class="symbol">;</span>
<span class="normal">                        </span><span class="symbol">*(</span><span class="normal">dp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)</span><span class="normal">background</span><span class="symbol">-&gt;</span><span class="normal">blue</span><span class="symbol">;</span>
<span class="normal">                     </span><span class="cbracket">}</span>
<span class="normal">                     </span><span class="keyword">else</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="usertype">png_byte</span><span class="normal"> v</span><span class="symbol">,</span><span class="normal"> w</span><span class="symbol">;</span>

<span class="normal">                        v </span><span class="symbol">=</span><span class="normal"> gamma_to_1</span><span class="symbol">[*</span><span class="normal">sp</span><span class="symbol">];</span>
<span class="normal">                        </span><span class="function">png_composite</span><span class="symbol">(</span><span class="normal">w</span><span class="symbol">,</span><span class="normal"> v</span><span class="symbol">,</span><span class="normal"> a</span><span class="symbol">,</span><span class="normal"> background_1</span><span class="symbol">-&gt;</span><span class="normal">red</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="symbol">*</span><span class="normal">dp </span><span class="symbol">=</span><span class="normal"> gamma_from_1</span><span class="symbol">[</span><span class="normal">w</span><span class="symbol">];</span>
<span class="normal">                        v </span><span class="symbol">=</span><span class="normal"> gamma_to_1</span><span class="symbol">[*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)];</span>
<span class="normal">                        </span><span class="function">png_composite</span><span class="symbol">(</span><span class="normal">w</span><span class="symbol">,</span><span class="normal"> v</span><span class="symbol">,</span><span class="normal"> a</span><span class="symbol">,</span><span class="normal"> background_1</span><span class="symbol">-&gt;</span><span class="normal">green</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="symbol">*(</span><span class="normal">dp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> gamma_from_1</span><span class="symbol">[</span><span class="normal">w</span><span class="symbol">];</span>
<span class="normal">                        v </span><span class="symbol">=</span><span class="normal"> gamma_to_1</span><span class="symbol">[*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)];</span>
<span class="normal">                        </span><span class="function">png_composite</span><span class="symbol">(</span><span class="normal">w</span><span class="symbol">,</span><span class="normal"> v</span><span class="symbol">,</span><span class="normal"> a</span><span class="symbol">,</span><span class="normal"> background_1</span><span class="symbol">-&gt;</span><span class="normal">blue</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="symbol">*(</span><span class="normal">dp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> gamma_from_1</span><span class="symbol">[</span><span class="normal">w</span><span class="symbol">];</span>
<span class="normal">                     </span><span class="cbracket">}</span>
<span class="normal">                  </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="keyword">else</span>
<span class="preproc">#endif</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  sp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">                  dp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++,</span><span class="normal"> sp </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">4</span><span class="symbol">,</span><span class="normal"> dp </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">3</span><span class="symbol">)</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     </span><span class="usertype">png_byte</span><span class="normal"> a </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">3</span><span class="symbol">);</span>

<span class="normal">                     </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">a </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">)</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="symbol">*</span><span class="normal">dp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">sp</span><span class="symbol">;</span>
<span class="normal">                        </span><span class="symbol">*(</span><span class="normal">dp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="symbol">*(</span><span class="normal">dp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">2</span><span class="symbol">);</span>
<span class="normal">                     </span><span class="cbracket">}</span>
<span class="normal">                     </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">a </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="symbol">*</span><span class="normal">dp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)</span><span class="normal">background</span><span class="symbol">-&gt;</span><span class="normal">red</span><span class="symbol">;</span>
<span class="normal">                        </span><span class="symbol">*(</span><span class="normal">dp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)</span><span class="normal">background</span><span class="symbol">-&gt;</span><span class="normal">green</span><span class="symbol">;</span>
<span class="normal">                        </span><span class="symbol">*(</span><span class="normal">dp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)</span><span class="normal">background</span><span class="symbol">-&gt;</span><span class="normal">blue</span><span class="symbol">;</span>
<span class="normal">                     </span><span class="cbracket">}</span>
<span class="normal">                     </span><span class="keyword">else</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="function">png_composite</span><span class="symbol">(*</span><span class="normal">dp</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">sp</span><span class="symbol">,</span><span class="normal"> a</span><span class="symbol">,</span><span class="normal"> background</span><span class="symbol">-&gt;</span><span class="normal">red</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="function">png_composite</span><span class="symbol">(*(</span><span class="normal">dp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">),</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">),</span><span class="normal"> a</span><span class="symbol">,</span>
<span class="normal">                           background</span><span class="symbol">-&gt;</span><span class="normal">green</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="function">png_composite</span><span class="symbol">(*(</span><span class="normal">dp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">2</span><span class="symbol">),</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">2</span><span class="symbol">),</span><span class="normal"> a</span><span class="symbol">,</span>
<span class="normal">                           background</span><span class="symbol">-&gt;</span><span class="normal">blue</span><span class="symbol">);</span>
<span class="normal">                     </span><span class="cbracket">}</span>
<span class="normal">                  </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="keyword">else</span><span class="normal"> </span><span class="comment">/* if (row_info-&gt;bit_depth == 16) */</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_GAMMA_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">               </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gamma_16 </span><span class="symbol">!=</span><span class="normal"> NULL </span><span class="symbol">&amp;&amp;</span><span class="normal"> gamma_16_from_1 </span><span class="symbol">!=</span><span class="normal"> NULL </span><span class="symbol">&amp;&amp;</span>
<span class="normal">                   gamma_16_to_1 </span><span class="symbol">!=</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  sp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">                  dp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++,</span><span class="normal"> sp </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">8</span><span class="symbol">,</span><span class="normal"> dp </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">6</span><span class="symbol">)</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     </span><span class="usertype">png_uint_16</span><span class="normal"> a </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)(((</span><span class="normal">png_uint_16</span><span class="symbol">)(*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">6</span><span class="symbol">))</span>
<span class="normal">                         </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)(*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">7</span><span class="symbol">)));</span>
<span class="normal">                     </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">a </span><span class="symbol">==</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)</span><span class="number">0xffff</span><span class="symbol">)</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="usertype">png_uint_16</span><span class="normal"> v</span><span class="symbol">;</span>

<span class="normal">                        v </span><span class="symbol">=</span><span class="normal"> gamma_16</span><span class="symbol">[*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> gamma_shift</span><span class="symbol">][*</span><span class="normal">sp</span><span class="symbol">];</span>
<span class="normal">                        </span><span class="symbol">*</span><span class="normal">dp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((</span><span class="normal">v </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="symbol">*(</span><span class="normal">dp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">v </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                        v </span><span class="symbol">=</span><span class="normal"> gamma_16</span><span class="symbol">[*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">3</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> gamma_shift</span><span class="symbol">][*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)];</span>
<span class="normal">                        </span><span class="symbol">*(</span><span class="normal">dp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((</span><span class="normal">v </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="symbol">*(</span><span class="normal">dp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">3</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">v </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                        v </span><span class="symbol">=</span><span class="normal"> gamma_16</span><span class="symbol">[*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">5</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> gamma_shift</span><span class="symbol">][*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">4</span><span class="symbol">)];</span>
<span class="normal">                        </span><span class="symbol">*(</span><span class="normal">dp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">4</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((</span><span class="normal">v </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="symbol">*(</span><span class="normal">dp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">5</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">v </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                     </span><span class="cbracket">}</span>
<span class="normal">                     </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">a </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="comment">/* background is already in screen gamma */</span>
<span class="normal">                        </span><span class="symbol">*</span><span class="normal">dp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((</span><span class="normal">background</span><span class="symbol">-&gt;</span><span class="normal">red </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="symbol">*(</span><span class="normal">dp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">background</span><span class="symbol">-&gt;</span><span class="normal">red </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="symbol">*(</span><span class="normal">dp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((</span><span class="normal">background</span><span class="symbol">-&gt;</span><span class="normal">green </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="symbol">*(</span><span class="normal">dp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">3</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">background</span><span class="symbol">-&gt;</span><span class="normal">green </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="symbol">*(</span><span class="normal">dp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">4</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((</span><span class="normal">background</span><span class="symbol">-&gt;</span><span class="normal">blue </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="symbol">*(</span><span class="normal">dp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">5</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">background</span><span class="symbol">-&gt;</span><span class="normal">blue </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                     </span><span class="cbracket">}</span>
<span class="normal">                     </span><span class="keyword">else</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="usertype">png_uint_16</span><span class="normal"> v</span><span class="symbol">,</span><span class="normal"> w</span><span class="symbol">,</span><span class="normal"> x</span><span class="symbol">;</span>

<span class="normal">                        v </span><span class="symbol">=</span><span class="normal"> gamma_16_to_1</span><span class="symbol">[*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> gamma_shift</span><span class="symbol">][*</span><span class="normal">sp</span><span class="symbol">];</span>
<span class="normal">                        </span><span class="function">png_composite_16</span><span class="symbol">(</span><span class="normal">w</span><span class="symbol">,</span><span class="normal"> v</span><span class="symbol">,</span><span class="normal"> a</span><span class="symbol">,</span><span class="normal"> background_1</span><span class="symbol">-&gt;</span><span class="normal">red</span><span class="symbol">);</span>
<span class="normal">                        x </span><span class="symbol">=</span><span class="normal"> gamma_16_from_1</span><span class="symbol">[((</span><span class="normal">w</span><span class="symbol">&amp;</span><span class="number">0xff</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> gamma_shift</span><span class="symbol">)][</span><span class="normal">w </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">];</span>
<span class="normal">                        </span><span class="symbol">*</span><span class="normal">dp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((</span><span class="normal">x </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="symbol">*(</span><span class="normal">dp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">x </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                        v </span><span class="symbol">=</span><span class="normal"> gamma_16_to_1</span><span class="symbol">[*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">3</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> gamma_shift</span><span class="symbol">][*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)];</span>
<span class="normal">                        </span><span class="function">png_composite_16</span><span class="symbol">(</span><span class="normal">w</span><span class="symbol">,</span><span class="normal"> v</span><span class="symbol">,</span><span class="normal"> a</span><span class="symbol">,</span><span class="normal"> background_1</span><span class="symbol">-&gt;</span><span class="normal">green</span><span class="symbol">);</span>
<span class="normal">                        x </span><span class="symbol">=</span><span class="normal"> gamma_16_from_1</span><span class="symbol">[((</span><span class="normal">w</span><span class="symbol">&amp;</span><span class="number">0xff</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> gamma_shift</span><span class="symbol">)][</span><span class="normal">w </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">];</span>
<span class="normal">                        </span><span class="symbol">*(</span><span class="normal">dp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((</span><span class="normal">x </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="symbol">*(</span><span class="normal">dp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">3</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">x </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                        v </span><span class="symbol">=</span><span class="normal"> gamma_16_to_1</span><span class="symbol">[*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">5</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> gamma_shift</span><span class="symbol">][*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">4</span><span class="symbol">)];</span>
<span class="normal">                        </span><span class="function">png_composite_16</span><span class="symbol">(</span><span class="normal">w</span><span class="symbol">,</span><span class="normal"> v</span><span class="symbol">,</span><span class="normal"> a</span><span class="symbol">,</span><span class="normal"> background_1</span><span class="symbol">-&gt;</span><span class="normal">blue</span><span class="symbol">);</span>
<span class="normal">                        x </span><span class="symbol">=</span><span class="normal"> gamma_16_from_1</span><span class="symbol">[(</span><span class="normal">w </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> gamma_shift</span><span class="symbol">][</span><span class="normal">w </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">];</span>
<span class="normal">                        </span><span class="symbol">*(</span><span class="normal">dp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">4</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((</span><span class="normal">x </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="symbol">*(</span><span class="normal">dp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">5</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">x </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                     </span><span class="cbracket">}</span>
<span class="normal">                  </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="keyword">else</span>
<span class="preproc">#endif</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  sp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">                  dp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++,</span><span class="normal"> sp </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">8</span><span class="symbol">,</span><span class="normal"> dp </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">6</span><span class="symbol">)</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     </span><span class="usertype">png_uint_16</span><span class="normal"> a </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)(((</span><span class="normal">png_uint_16</span><span class="symbol">)(*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">6</span><span class="symbol">))</span>
<span class="normal">                        </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)(*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">7</span><span class="symbol">)));</span>
<span class="normal">                     </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">a </span><span class="symbol">==</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)</span><span class="number">0xffff</span><span class="symbol">)</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="function">png_memcpy</span><span class="symbol">(</span><span class="normal">dp</span><span class="symbol">,</span><span class="normal"> sp</span><span class="symbol">,</span><span class="normal"> </span><span class="number">6</span><span class="symbol">);</span>
<span class="normal">                     </span><span class="cbracket">}</span>
<span class="normal">                     </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">a </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="symbol">*</span><span class="normal">dp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((</span><span class="normal">background</span><span class="symbol">-&gt;</span><span class="normal">red </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="symbol">*(</span><span class="normal">dp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">background</span><span class="symbol">-&gt;</span><span class="normal">red </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="symbol">*(</span><span class="normal">dp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((</span><span class="normal">background</span><span class="symbol">-&gt;</span><span class="normal">green </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="symbol">*(</span><span class="normal">dp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">3</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">background</span><span class="symbol">-&gt;</span><span class="normal">green </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="symbol">*(</span><span class="normal">dp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">4</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((</span><span class="normal">background</span><span class="symbol">-&gt;</span><span class="normal">blue </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="symbol">*(</span><span class="normal">dp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">5</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">background</span><span class="symbol">-&gt;</span><span class="normal">blue </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                     </span><span class="cbracket">}</span>
<span class="normal">                     </span><span class="keyword">else</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        </span><span class="usertype">png_uint_16</span><span class="normal"> v</span><span class="symbol">;</span>

<span class="normal">                        </span><span class="usertype">png_uint_16</span><span class="normal"> r </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)(((*</span><span class="normal">sp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">));</span>
<span class="normal">                        </span><span class="usertype">png_uint_16</span><span class="normal"> g </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)(((*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">2</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span>
<span class="normal">                            </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">3</span><span class="symbol">));</span>
<span class="normal">                        </span><span class="usertype">png_uint_16</span><span class="normal"> b </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)(((*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">4</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span>
<span class="normal">                            </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">5</span><span class="symbol">));</span>

<span class="normal">                        </span><span class="function">png_composite_16</span><span class="symbol">(</span><span class="normal">v</span><span class="symbol">,</span><span class="normal"> r</span><span class="symbol">,</span><span class="normal"> a</span><span class="symbol">,</span><span class="normal"> background</span><span class="symbol">-&gt;</span><span class="normal">red</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="symbol">*</span><span class="normal">dp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((</span><span class="normal">v </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="symbol">*(</span><span class="normal">dp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">v </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="function">png_composite_16</span><span class="symbol">(</span><span class="normal">v</span><span class="symbol">,</span><span class="normal"> g</span><span class="symbol">,</span><span class="normal"> a</span><span class="symbol">,</span><span class="normal"> background</span><span class="symbol">-&gt;</span><span class="normal">green</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="symbol">*(</span><span class="normal">dp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((</span><span class="normal">v </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="symbol">*(</span><span class="normal">dp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">3</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">v </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="function">png_composite_16</span><span class="symbol">(</span><span class="normal">v</span><span class="symbol">,</span><span class="normal"> b</span><span class="symbol">,</span><span class="normal"> a</span><span class="symbol">,</span><span class="normal"> background</span><span class="symbol">-&gt;</span><span class="normal">blue</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="symbol">*(</span><span class="normal">dp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">4</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((</span><span class="normal">v </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                        </span><span class="symbol">*(</span><span class="normal">dp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">5</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">v </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                     </span><span class="cbracket">}</span>
<span class="normal">                  </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="cbracket">}</span>

<span class="normal">      </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">color_type </span><span class="symbol">&amp;</span><span class="normal"> PNG_COLOR_MASK_ALPHA</span><span class="symbol">)</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         row_info</span><span class="symbol">-&gt;</span><span class="normal">color_type </span><span class="symbol">&amp;=</span><span class="normal"> </span><span class="symbol">~</span><span class="normal">PNG_COLOR_MASK_ALPHA</span><span class="symbol">;</span>
<span class="normal">         row_info</span><span class="symbol">-&gt;</span><span class="normal">channels</span><span class="symbol">--;</span>
<span class="normal">         row_info</span><span class="symbol">-&gt;</span><span class="normal">pixel_depth </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">channels </span><span class="symbol">*</span>
<span class="normal">            row_info</span><span class="symbol">-&gt;</span><span class="normal">bit_depth</span><span class="symbol">);</span>
<span class="normal">         row_info</span><span class="symbol">-&gt;</span><span class="normal">rowbytes </span><span class="symbol">=</span><span class="normal"> </span><span class="function">PNG_ROWBYTES</span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">pixel_depth</span><span class="symbol">,</span><span class="normal">row_width</span><span class="symbol">);</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">   </span><span class="cbracket">}</span>
<span class="cbracket">}</span>
<span class="preproc">#endif</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_GAMMA_SUPPORTED</span><span class="symbol">)</span>
<span class="comment">/* Gamma correct the image, avoiding the alpha channel.  Make sure</span>
<span class="comment"> * you do this after you deal with the transparency issue on grayscale</span>
<span class="comment"> * or RGB images. If your bit depth is 8, use gamma_table, if it</span>
<span class="comment"> * is 16, use gamma_16_table and gamma_shift.  Build these with</span>
<span class="comment"> * build_gamma_table().</span>
<span class="comment"> */</span>
<span class="type">void</span><span class="normal"> </span><span class="comment">/* PRIVATE */</span>
<span class="function">png_do_gamma</span><span class="symbol">(</span><span class="usertype">png_row_infop</span><span class="normal"> row_info</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">png_bytep</span><span class="normal"> row</span><span class="symbol">,</span>
<span class="normal">   </span><span class="usertype">png_bytep</span><span class="normal"> gamma_table</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">png_uint_16pp</span><span class="normal"> gamma_16_table</span><span class="symbol">,</span>
<span class="normal">   </span><span class="type">int</span><span class="normal"> gamma_shift</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">   </span><span class="usertype">png_bytep</span><span class="normal"> sp</span><span class="symbol">;</span>
<span class="normal">   </span><span class="usertype">png_uint_32</span><span class="normal"> i</span><span class="symbol">;</span>
<span class="normal">   </span><span class="usertype">png_uint_32</span><span class="normal"> row_width</span><span class="symbol">=</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">width</span><span class="symbol">;</span>

<span class="normal">   </span><span class="function">png_debug</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"in png_do_gamma</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_USELESS_TESTS_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">       row </span><span class="symbol">!=</span><span class="normal"> NULL </span><span class="symbol">&amp;&amp;</span><span class="normal"> row_info </span><span class="symbol">!=</span><span class="normal"> NULL </span><span class="symbol">&amp;&amp;</span>
<span class="preproc">#endif</span>
<span class="normal">       </span><span class="symbol">((</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">bit_depth </span><span class="symbol">&lt;=</span><span class="normal"> </span><span class="number">8</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> gamma_table </span><span class="symbol">!=</span><span class="normal"> NULL</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">||</span>
<span class="normal">        </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">bit_depth </span><span class="symbol">==</span><span class="normal"> </span><span class="number">16</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> gamma_16_table </span><span class="symbol">!=</span><span class="normal"> NULL</span><span class="symbol">)))</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="keyword">switch</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">color_type</span><span class="symbol">)</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         </span><span class="keyword">case</span><span class="normal"> PNG_COLOR_TYPE_RGB</span><span class="symbol">:</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">bit_depth </span><span class="symbol">==</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               sp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">               </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  </span><span class="symbol">*</span><span class="normal">sp </span><span class="symbol">=</span><span class="normal"> gamma_table</span><span class="symbol">[*</span><span class="normal">sp</span><span class="symbol">];</span>
<span class="normal">                  sp</span><span class="symbol">++;</span>
<span class="normal">                  </span><span class="symbol">*</span><span class="normal">sp </span><span class="symbol">=</span><span class="normal"> gamma_table</span><span class="symbol">[*</span><span class="normal">sp</span><span class="symbol">];</span>
<span class="normal">                  sp</span><span class="symbol">++;</span>
<span class="normal">                  </span><span class="symbol">*</span><span class="normal">sp </span><span class="symbol">=</span><span class="normal"> gamma_table</span><span class="symbol">[*</span><span class="normal">sp</span><span class="symbol">];</span>
<span class="normal">                  sp</span><span class="symbol">++;</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="keyword">else</span><span class="normal"> </span><span class="comment">/* if (row_info-&gt;bit_depth == 16) */</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               sp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">               </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  </span><span class="usertype">png_uint_16</span><span class="normal"> v</span><span class="symbol">;</span>

<span class="normal">                  v </span><span class="symbol">=</span><span class="normal"> gamma_16_table</span><span class="symbol">[*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> gamma_shift</span><span class="symbol">][*</span><span class="normal">sp</span><span class="symbol">];</span>
<span class="normal">                  </span><span class="symbol">*</span><span class="normal">sp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((</span><span class="normal">v </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                  </span><span class="symbol">*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">v </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                  sp </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">                  v </span><span class="symbol">=</span><span class="normal"> gamma_16_table</span><span class="symbol">[*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> gamma_shift</span><span class="symbol">][*</span><span class="normal">sp</span><span class="symbol">];</span>
<span class="normal">                  </span><span class="symbol">*</span><span class="normal">sp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((</span><span class="normal">v </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                  </span><span class="symbol">*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">v </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                  sp </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">                  v </span><span class="symbol">=</span><span class="normal"> gamma_16_table</span><span class="symbol">[*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> gamma_shift</span><span class="symbol">][*</span><span class="normal">sp</span><span class="symbol">];</span>
<span class="normal">                  </span><span class="symbol">*</span><span class="normal">sp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((</span><span class="normal">v </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                  </span><span class="symbol">*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">v </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                  sp </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">         </span><span class="keyword">case</span><span class="normal"> PNG_COLOR_TYPE_RGB_ALPHA</span><span class="symbol">:</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">bit_depth </span><span class="symbol">==</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               sp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">               </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  </span><span class="symbol">*</span><span class="normal">sp </span><span class="symbol">=</span><span class="normal"> gamma_table</span><span class="symbol">[*</span><span class="normal">sp</span><span class="symbol">];</span>
<span class="normal">                  sp</span><span class="symbol">++;</span>
<span class="normal">                  </span><span class="symbol">*</span><span class="normal">sp </span><span class="symbol">=</span><span class="normal"> gamma_table</span><span class="symbol">[*</span><span class="normal">sp</span><span class="symbol">];</span>
<span class="normal">                  sp</span><span class="symbol">++;</span>
<span class="normal">                  </span><span class="symbol">*</span><span class="normal">sp </span><span class="symbol">=</span><span class="normal"> gamma_table</span><span class="symbol">[*</span><span class="normal">sp</span><span class="symbol">];</span>
<span class="normal">                  sp</span><span class="symbol">++;</span>
<span class="normal">                  sp</span><span class="symbol">++;</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="keyword">else</span><span class="normal"> </span><span class="comment">/* if (row_info-&gt;bit_depth == 16) */</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               sp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">               </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  </span><span class="usertype">png_uint_16</span><span class="normal"> v </span><span class="symbol">=</span><span class="normal"> gamma_16_table</span><span class="symbol">[*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> gamma_shift</span><span class="symbol">][*</span><span class="normal">sp</span><span class="symbol">];</span>
<span class="normal">                  </span><span class="symbol">*</span><span class="normal">sp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((</span><span class="normal">v </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                  </span><span class="symbol">*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">v </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                  sp </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">                  v </span><span class="symbol">=</span><span class="normal"> gamma_16_table</span><span class="symbol">[*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> gamma_shift</span><span class="symbol">][*</span><span class="normal">sp</span><span class="symbol">];</span>
<span class="normal">                  </span><span class="symbol">*</span><span class="normal">sp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((</span><span class="normal">v </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                  </span><span class="symbol">*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">v </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                  sp </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">                  v </span><span class="symbol">=</span><span class="normal"> gamma_16_table</span><span class="symbol">[*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> gamma_shift</span><span class="symbol">][*</span><span class="normal">sp</span><span class="symbol">];</span>
<span class="normal">                  </span><span class="symbol">*</span><span class="normal">sp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((</span><span class="normal">v </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                  </span><span class="symbol">*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">v </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                  sp </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">4</span><span class="symbol">;</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">         </span><span class="keyword">case</span><span class="normal"> PNG_COLOR_TYPE_GRAY_ALPHA</span><span class="symbol">:</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">bit_depth </span><span class="symbol">==</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               sp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">               </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  </span><span class="symbol">*</span><span class="normal">sp </span><span class="symbol">=</span><span class="normal"> gamma_table</span><span class="symbol">[*</span><span class="normal">sp</span><span class="symbol">];</span>
<span class="normal">                  sp </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="keyword">else</span><span class="normal"> </span><span class="comment">/* if (row_info-&gt;bit_depth == 16) */</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               sp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">               </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  </span><span class="usertype">png_uint_16</span><span class="normal"> v </span><span class="symbol">=</span><span class="normal"> gamma_16_table</span><span class="symbol">[*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> gamma_shift</span><span class="symbol">][*</span><span class="normal">sp</span><span class="symbol">];</span>
<span class="normal">                  </span><span class="symbol">*</span><span class="normal">sp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((</span><span class="normal">v </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                  </span><span class="symbol">*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">v </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                  sp </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">4</span><span class="symbol">;</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">         </span><span class="keyword">case</span><span class="normal"> PNG_COLOR_TYPE_GRAY</span><span class="symbol">:</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">bit_depth </span><span class="symbol">==</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               sp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">               </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">4</span><span class="symbol">)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  </span><span class="type">int</span><span class="normal"> a </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">sp </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xc0</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="type">int</span><span class="normal"> b </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">sp </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x30</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="type">int</span><span class="normal"> c </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">sp </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x0c</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="type">int</span><span class="normal"> d </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">sp </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x03</span><span class="symbol">;</span>

<span class="normal">                  </span><span class="symbol">*</span><span class="normal">sp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span>
<span class="normal">                        </span><span class="symbol">((((</span><span class="type">int</span><span class="symbol">)</span><span class="normal">gamma_table</span><span class="symbol">[</span><span class="normal">a</span><span class="symbol">|(</span><span class="normal">a</span><span class="symbol">&gt;&gt;</span><span class="number">2</span><span class="symbol">)|(</span><span class="normal">a</span><span class="symbol">&gt;&gt;</span><span class="number">4</span><span class="symbol">)|(</span><span class="normal">a</span><span class="symbol">&gt;&gt;</span><span class="number">6</span><span class="symbol">)])</span><span class="normal">   </span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xc0</span><span class="symbol">)|</span>
<span class="normal">                        </span><span class="symbol">((((</span><span class="type">int</span><span class="symbol">)</span><span class="normal">gamma_table</span><span class="symbol">[(</span><span class="normal">b</span><span class="symbol">&lt;&lt;</span><span class="number">2</span><span class="symbol">)|</span><span class="normal">b</span><span class="symbol">|(</span><span class="normal">b</span><span class="symbol">&gt;&gt;</span><span class="number">2</span><span class="symbol">)|(</span><span class="normal">b</span><span class="symbol">&gt;&gt;</span><span class="number">4</span><span class="symbol">)])&gt;&gt;</span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x30</span><span class="symbol">)|</span>
<span class="normal">                        </span><span class="symbol">((((</span><span class="type">int</span><span class="symbol">)</span><span class="normal">gamma_table</span><span class="symbol">[(</span><span class="normal">c</span><span class="symbol">&lt;&lt;</span><span class="number">4</span><span class="symbol">)|(</span><span class="normal">c</span><span class="symbol">&lt;&lt;</span><span class="number">2</span><span class="symbol">)|</span><span class="normal">c</span><span class="symbol">|(</span><span class="normal">c</span><span class="symbol">&gt;&gt;</span><span class="number">2</span><span class="symbol">)])&gt;&gt;</span><span class="number">4</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x0c</span><span class="symbol">)|</span>
<span class="normal">                        </span><span class="symbol">((((</span><span class="type">int</span><span class="symbol">)</span><span class="normal">gamma_table</span><span class="symbol">[(</span><span class="normal">d</span><span class="symbol">&lt;&lt;</span><span class="number">6</span><span class="symbol">)|(</span><span class="normal">d</span><span class="symbol">&lt;&lt;</span><span class="number">4</span><span class="symbol">)|(</span><span class="normal">d</span><span class="symbol">&lt;&lt;</span><span class="number">2</span><span class="symbol">)|</span><span class="normal">d</span><span class="symbol">])&gt;&gt;</span><span class="number">6</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">));</span>
<span class="normal">                  sp</span><span class="symbol">++;</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">bit_depth </span><span class="symbol">==</span><span class="normal"> </span><span class="number">4</span><span class="symbol">)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               sp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">               </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  </span><span class="type">int</span><span class="normal"> msb </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">sp </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xf0</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="type">int</span><span class="normal"> lsb </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">sp </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x0f</span><span class="symbol">;</span>

<span class="normal">                  </span><span class="symbol">*</span><span class="normal">sp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((((</span><span class="type">int</span><span class="symbol">)</span><span class="normal">gamma_table</span><span class="symbol">[</span><span class="normal">msb </span><span class="symbol">|</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">msb </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">4</span><span class="symbol">)])</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xf0</span><span class="symbol">)</span>
<span class="normal">                          </span><span class="symbol">|</span><span class="normal"> </span><span class="symbol">(((</span><span class="type">int</span><span class="symbol">)</span><span class="normal">gamma_table</span><span class="symbol">[(</span><span class="normal">lsb </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">4</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">|</span><span class="normal"> lsb</span><span class="symbol">])</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">4</span><span class="symbol">));</span>
<span class="normal">                  sp</span><span class="symbol">++;</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">bit_depth </span><span class="symbol">==</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               sp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">               </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  </span><span class="symbol">*</span><span class="normal">sp </span><span class="symbol">=</span><span class="normal"> gamma_table</span><span class="symbol">[*</span><span class="normal">sp</span><span class="symbol">];</span>
<span class="normal">                  sp</span><span class="symbol">++;</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">bit_depth </span><span class="symbol">==</span><span class="normal"> </span><span class="number">16</span><span class="symbol">)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               sp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">               </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  </span><span class="usertype">png_uint_16</span><span class="normal"> v </span><span class="symbol">=</span><span class="normal"> gamma_16_table</span><span class="symbol">[*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> gamma_shift</span><span class="symbol">][*</span><span class="normal">sp</span><span class="symbol">];</span>
<span class="normal">                  </span><span class="symbol">*</span><span class="normal">sp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((</span><span class="normal">v </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                  </span><span class="symbol">*(</span><span class="normal">sp </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">v </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                  sp </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">   </span><span class="cbracket">}</span>
<span class="cbracket">}</span>
<span class="preproc">#endif</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_EXPAND_SUPPORTED</span><span class="symbol">)</span>
<span class="comment">/* Expands a palette row to an RGB or RGBA row depending</span>
<span class="comment"> * upon whether you supply trans and num_trans.</span>
<span class="comment"> */</span>
<span class="type">void</span><span class="normal"> </span><span class="comment">/* PRIVATE */</span>
<span class="function">png_do_expand_palette</span><span class="symbol">(</span><span class="usertype">png_row_infop</span><span class="normal"> row_info</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">png_bytep</span><span class="normal"> row</span><span class="symbol">,</span>
<span class="normal">   </span><span class="usertype">png_colorp</span><span class="normal"> palette</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">png_bytep</span><span class="normal"> trans</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> num_trans</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">   </span><span class="type">int</span><span class="normal"> shift</span><span class="symbol">,</span><span class="normal"> value</span><span class="symbol">;</span>
<span class="normal">   </span><span class="usertype">png_bytep</span><span class="normal"> sp</span><span class="symbol">,</span><span class="normal"> dp</span><span class="symbol">;</span>
<span class="normal">   </span><span class="usertype">png_uint_32</span><span class="normal"> i</span><span class="symbol">;</span>
<span class="normal">   </span><span class="usertype">png_uint_32</span><span class="normal"> row_width</span><span class="symbol">=</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">width</span><span class="symbol">;</span>

<span class="normal">   </span><span class="function">png_debug</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"in png_do_expand_palette</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_USELESS_TESTS_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">       row </span><span class="symbol">!=</span><span class="normal"> NULL </span><span class="symbol">&amp;&amp;</span><span class="normal"> row_info </span><span class="symbol">!=</span><span class="normal"> NULL </span><span class="symbol">&amp;&amp;</span>
<span class="preproc">#endif</span>
<span class="normal">       row_info</span><span class="symbol">-&gt;</span><span class="normal">color_type </span><span class="symbol">==</span><span class="normal"> PNG_COLOR_TYPE_PALETTE</span><span class="symbol">)</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">bit_depth </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         </span><span class="keyword">switch</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">bit_depth</span><span class="symbol">)</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="keyword">case</span><span class="normal"> </span><span class="number">1</span><span class="symbol">:</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               sp </span><span class="symbol">=</span><span class="normal"> row </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_size_t</span><span class="symbol">)((</span><span class="normal">row_width </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">3</span><span class="symbol">);</span>
<span class="normal">               dp </span><span class="symbol">=</span><span class="normal"> row </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_size_t</span><span class="symbol">)</span><span class="normal">row_width </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">               shift </span><span class="symbol">=</span><span class="normal"> </span><span class="number">7</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="symbol">)((</span><span class="normal">row_width </span><span class="symbol">+</span><span class="normal"> </span><span class="number">7</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x07</span><span class="symbol">);</span>
<span class="normal">               </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((*</span><span class="normal">sp </span><span class="symbol">&gt;&gt;</span><span class="normal"> shift</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x01</span><span class="symbol">)</span>
<span class="normal">                     </span><span class="symbol">*</span><span class="normal">dp </span><span class="symbol">=</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="keyword">else</span>
<span class="normal">                     </span><span class="symbol">*</span><span class="normal">dp </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">shift </span><span class="symbol">==</span><span class="normal"> </span><span class="number">7</span><span class="symbol">)</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     shift </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">                     sp</span><span class="symbol">--;</span>
<span class="normal">                  </span><span class="cbracket">}</span>
<span class="normal">                  </span><span class="keyword">else</span>
<span class="normal">                     shift</span><span class="symbol">++;</span>

<span class="normal">                  dp</span><span class="symbol">--;</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="keyword">case</span><span class="normal"> </span><span class="number">2</span><span class="symbol">:</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               sp </span><span class="symbol">=</span><span class="normal"> row </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_size_t</span><span class="symbol">)((</span><span class="normal">row_width </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">2</span><span class="symbol">);</span>
<span class="normal">               dp </span><span class="symbol">=</span><span class="normal"> row </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_size_t</span><span class="symbol">)</span><span class="normal">row_width </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">               shift </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="symbol">)((</span><span class="number">3</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">row_width </span><span class="symbol">+</span><span class="normal"> </span><span class="number">3</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x03</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">               </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  value </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(*</span><span class="normal">sp </span><span class="symbol">&gt;&gt;</span><span class="normal"> shift</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x03</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="symbol">*</span><span class="normal">dp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)</span><span class="normal">value</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">shift </span><span class="symbol">==</span><span class="normal"> </span><span class="number">6</span><span class="symbol">)</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     shift </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">                     sp</span><span class="symbol">--;</span>
<span class="normal">                  </span><span class="cbracket">}</span>
<span class="normal">                  </span><span class="keyword">else</span>
<span class="normal">                     shift </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>

<span class="normal">                  dp</span><span class="symbol">--;</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="keyword">case</span><span class="normal"> </span><span class="number">4</span><span class="symbol">:</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               sp </span><span class="symbol">=</span><span class="normal"> row </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_size_t</span><span class="symbol">)((</span><span class="normal">row_width </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">               dp </span><span class="symbol">=</span><span class="normal"> row </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_size_t</span><span class="symbol">)</span><span class="normal">row_width </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">               shift </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="symbol">)((</span><span class="normal">row_width </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x01</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">2</span><span class="symbol">);</span>
<span class="normal">               </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  value </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(*</span><span class="normal">sp </span><span class="symbol">&gt;&gt;</span><span class="normal"> shift</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x0f</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="symbol">*</span><span class="normal">dp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)</span><span class="normal">value</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">shift </span><span class="symbol">==</span><span class="normal"> </span><span class="number">4</span><span class="symbol">)</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     shift </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">                     sp</span><span class="symbol">--;</span>
<span class="normal">                  </span><span class="cbracket">}</span>
<span class="normal">                  </span><span class="keyword">else</span>
<span class="normal">                     shift </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">4</span><span class="symbol">;</span>

<span class="normal">                  dp</span><span class="symbol">--;</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">         row_info</span><span class="symbol">-&gt;</span><span class="normal">bit_depth </span><span class="symbol">=</span><span class="normal"> </span><span class="number">8</span><span class="symbol">;</span>
<span class="normal">         row_info</span><span class="symbol">-&gt;</span><span class="normal">pixel_depth </span><span class="symbol">=</span><span class="normal"> </span><span class="number">8</span><span class="symbol">;</span>
<span class="normal">         row_info</span><span class="symbol">-&gt;</span><span class="normal">rowbytes </span><span class="symbol">=</span><span class="normal"> row_width</span><span class="symbol">;</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="keyword">switch</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">bit_depth</span><span class="symbol">)</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         </span><span class="keyword">case</span><span class="normal"> </span><span class="number">8</span><span class="symbol">:</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">trans </span><span class="symbol">!=</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               sp </span><span class="symbol">=</span><span class="normal"> row </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_size_t</span><span class="symbol">)</span><span class="normal">row_width </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">               dp </span><span class="symbol">=</span><span class="normal"> row </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_size_t</span><span class="symbol">)(</span><span class="normal">row_width </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>

<span class="normal">               </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="type">int</span><span class="symbol">)(*</span><span class="normal">sp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;=</span><span class="normal"> num_trans</span><span class="symbol">)</span>
<span class="normal">                     </span><span class="symbol">*</span><span class="normal">dp</span><span class="symbol">--</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="keyword">else</span>
<span class="normal">                     </span><span class="symbol">*</span><span class="normal">dp</span><span class="symbol">--</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> trans</span><span class="symbol">[*</span><span class="normal">sp</span><span class="symbol">];</span>
<span class="normal">                  </span><span class="symbol">*</span><span class="normal">dp</span><span class="symbol">--</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> palette</span><span class="symbol">[*</span><span class="normal">sp</span><span class="symbol">].</span><span class="normal">blue</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="symbol">*</span><span class="normal">dp</span><span class="symbol">--</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> palette</span><span class="symbol">[*</span><span class="normal">sp</span><span class="symbol">].</span><span class="normal">green</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="symbol">*</span><span class="normal">dp</span><span class="symbol">--</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> palette</span><span class="symbol">[*</span><span class="normal">sp</span><span class="symbol">].</span><span class="normal">red</span><span class="symbol">;</span>
<span class="normal">                  sp</span><span class="symbol">--;</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">               row_info</span><span class="symbol">-&gt;</span><span class="normal">bit_depth </span><span class="symbol">=</span><span class="normal"> </span><span class="number">8</span><span class="symbol">;</span>
<span class="normal">               row_info</span><span class="symbol">-&gt;</span><span class="normal">pixel_depth </span><span class="symbol">=</span><span class="normal"> </span><span class="number">32</span><span class="symbol">;</span>
<span class="normal">               row_info</span><span class="symbol">-&gt;</span><span class="normal">rowbytes </span><span class="symbol">=</span><span class="normal"> row_width </span><span class="symbol">*</span><span class="normal"> </span><span class="number">4</span><span class="symbol">;</span>
<span class="normal">               row_info</span><span class="symbol">-&gt;</span><span class="normal">color_type </span><span class="symbol">=</span><span class="normal"> </span><span class="number">6</span><span class="symbol">;</span>
<span class="normal">               row_info</span><span class="symbol">-&gt;</span><span class="normal">channels </span><span class="symbol">=</span><span class="normal"> </span><span class="number">4</span><span class="symbol">;</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="keyword">else</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               sp </span><span class="symbol">=</span><span class="normal"> row </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_size_t</span><span class="symbol">)</span><span class="normal">row_width </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">               dp </span><span class="symbol">=</span><span class="normal"> row </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_size_t</span><span class="symbol">)(</span><span class="normal">row_width </span><span class="symbol">*</span><span class="normal"> </span><span class="number">3</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>

<span class="normal">               </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  </span><span class="symbol">*</span><span class="normal">dp</span><span class="symbol">--</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> palette</span><span class="symbol">[*</span><span class="normal">sp</span><span class="symbol">].</span><span class="normal">blue</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="symbol">*</span><span class="normal">dp</span><span class="symbol">--</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> palette</span><span class="symbol">[*</span><span class="normal">sp</span><span class="symbol">].</span><span class="normal">green</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="symbol">*</span><span class="normal">dp</span><span class="symbol">--</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> palette</span><span class="symbol">[*</span><span class="normal">sp</span><span class="symbol">].</span><span class="normal">red</span><span class="symbol">;</span>
<span class="normal">                  sp</span><span class="symbol">--;</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">               row_info</span><span class="symbol">-&gt;</span><span class="normal">bit_depth </span><span class="symbol">=</span><span class="normal"> </span><span class="number">8</span><span class="symbol">;</span>
<span class="normal">               row_info</span><span class="symbol">-&gt;</span><span class="normal">pixel_depth </span><span class="symbol">=</span><span class="normal"> </span><span class="number">24</span><span class="symbol">;</span>
<span class="normal">               row_info</span><span class="symbol">-&gt;</span><span class="normal">rowbytes </span><span class="symbol">=</span><span class="normal"> row_width </span><span class="symbol">*</span><span class="normal"> </span><span class="number">3</span><span class="symbol">;</span>
<span class="normal">               row_info</span><span class="symbol">-&gt;</span><span class="normal">color_type </span><span class="symbol">=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">               row_info</span><span class="symbol">-&gt;</span><span class="normal">channels </span><span class="symbol">=</span><span class="normal"> </span><span class="number">3</span><span class="symbol">;</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">   </span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="comment">/* If the bit depth &lt; 8, it is expanded to 8.  Also, if the already</span>
<span class="comment"> * expanded transparency value is supplied, an alpha channel is built.</span>
<span class="comment"> */</span>
<span class="type">void</span><span class="normal"> </span><span class="comment">/* PRIVATE */</span>
<span class="function">png_do_expand</span><span class="symbol">(</span><span class="usertype">png_row_infop</span><span class="normal"> row_info</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">png_bytep</span><span class="normal"> row</span><span class="symbol">,</span>
<span class="normal">   </span><span class="usertype">png_color_16p</span><span class="normal"> trans_value</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">   </span><span class="type">int</span><span class="normal"> shift</span><span class="symbol">,</span><span class="normal"> value</span><span class="symbol">;</span>
<span class="normal">   </span><span class="usertype">png_bytep</span><span class="normal"> sp</span><span class="symbol">,</span><span class="normal"> dp</span><span class="symbol">;</span>
<span class="normal">   </span><span class="usertype">png_uint_32</span><span class="normal"> i</span><span class="symbol">;</span>
<span class="normal">   </span><span class="usertype">png_uint_32</span><span class="normal"> row_width</span><span class="symbol">=</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">width</span><span class="symbol">;</span>

<span class="normal">   </span><span class="function">png_debug</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"in png_do_expand</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_USELESS_TESTS_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row </span><span class="symbol">!=</span><span class="normal"> NULL </span><span class="symbol">&amp;&amp;</span><span class="normal"> row_info </span><span class="symbol">!=</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="preproc">#endif</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">color_type </span><span class="symbol">==</span><span class="normal"> PNG_COLOR_TYPE_GRAY</span><span class="symbol">)</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         </span><span class="usertype">png_uint_16</span><span class="normal"> gray </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)(</span><span class="normal">trans_value </span><span class="symbol">?</span><span class="normal"> trans_value</span><span class="symbol">-&gt;</span><span class="normal">gray </span><span class="symbol">:</span><span class="normal"> </span><span class="number">0</span><span class="symbol">);</span>

<span class="normal">         </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">bit_depth </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="keyword">switch</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">bit_depth</span><span class="symbol">)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="keyword">case</span><span class="normal"> </span><span class="number">1</span><span class="symbol">:</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  gray </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)(</span><span class="normal">gray</span><span class="symbol">*</span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">                  sp </span><span class="symbol">=</span><span class="normal"> row </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_size_t</span><span class="symbol">)((</span><span class="normal">row_width </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">3</span><span class="symbol">);</span>
<span class="normal">                  dp </span><span class="symbol">=</span><span class="normal"> row </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_size_t</span><span class="symbol">)</span><span class="normal">row_width </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">                  shift </span><span class="symbol">=</span><span class="normal"> </span><span class="number">7</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="symbol">)((</span><span class="normal">row_width </span><span class="symbol">+</span><span class="normal"> </span><span class="number">7</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x07</span><span class="symbol">);</span>
<span class="normal">                  </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((*</span><span class="normal">sp </span><span class="symbol">&gt;&gt;</span><span class="normal"> shift</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x01</span><span class="symbol">)</span>
<span class="normal">                        </span><span class="symbol">*</span><span class="normal">dp </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">;</span>
<span class="normal">                     </span><span class="keyword">else</span>
<span class="normal">                        </span><span class="symbol">*</span><span class="normal">dp </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">                     </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">shift </span><span class="symbol">==</span><span class="normal"> </span><span class="number">7</span><span class="symbol">)</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        shift </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">                        sp</span><span class="symbol">--;</span>
<span class="normal">                     </span><span class="cbracket">}</span>
<span class="normal">                     </span><span class="keyword">else</span>
<span class="normal">                        shift</span><span class="symbol">++;</span>

<span class="normal">                     dp</span><span class="symbol">--;</span>
<span class="normal">                  </span><span class="cbracket">}</span>
<span class="normal">                  </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="keyword">case</span><span class="normal"> </span><span class="number">2</span><span class="symbol">:</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  gray </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)(</span><span class="normal">gray</span><span class="symbol">*</span><span class="number">0x55</span><span class="symbol">);</span>
<span class="normal">                  sp </span><span class="symbol">=</span><span class="normal"> row </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_size_t</span><span class="symbol">)((</span><span class="normal">row_width </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">2</span><span class="symbol">);</span>
<span class="normal">                  dp </span><span class="symbol">=</span><span class="normal"> row </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_size_t</span><span class="symbol">)</span><span class="normal">row_width </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">                  shift </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="symbol">)((</span><span class="number">3</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">row_width </span><span class="symbol">+</span><span class="normal"> </span><span class="number">3</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x03</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">                  </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     value </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(*</span><span class="normal">sp </span><span class="symbol">&gt;&gt;</span><span class="normal"> shift</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x03</span><span class="symbol">;</span>
<span class="normal">                     </span><span class="symbol">*</span><span class="normal">dp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">value </span><span class="symbol">|</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">value </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">|</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">value </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">4</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">|</span>
<span class="normal">                        </span><span class="symbol">(</span><span class="normal">value </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">6</span><span class="symbol">));</span>
<span class="normal">                     </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">shift </span><span class="symbol">==</span><span class="normal"> </span><span class="number">6</span><span class="symbol">)</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        shift </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">                        sp</span><span class="symbol">--;</span>
<span class="normal">                     </span><span class="cbracket">}</span>
<span class="normal">                     </span><span class="keyword">else</span>
<span class="normal">                        shift </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>

<span class="normal">                     dp</span><span class="symbol">--;</span>
<span class="normal">                  </span><span class="cbracket">}</span>
<span class="normal">                  </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="keyword">case</span><span class="normal"> </span><span class="number">4</span><span class="symbol">:</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  gray </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)(</span><span class="normal">gray</span><span class="symbol">*</span><span class="number">0x11</span><span class="symbol">);</span>
<span class="normal">                  sp </span><span class="symbol">=</span><span class="normal"> row </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_size_t</span><span class="symbol">)((</span><span class="normal">row_width </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">                  dp </span><span class="symbol">=</span><span class="normal"> row </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_size_t</span><span class="symbol">)</span><span class="normal">row_width </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">                  shift </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="symbol">)((</span><span class="number">1</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">row_width </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x01</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">2</span><span class="symbol">);</span>
<span class="normal">                  </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     value </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(*</span><span class="normal">sp </span><span class="symbol">&gt;&gt;</span><span class="normal"> shift</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x0f</span><span class="symbol">;</span>
<span class="normal">                     </span><span class="symbol">*</span><span class="normal">dp </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">value </span><span class="symbol">|</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">value </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">4</span><span class="symbol">));</span>
<span class="normal">                     </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">shift </span><span class="symbol">==</span><span class="normal"> </span><span class="number">4</span><span class="symbol">)</span>
<span class="normal">                     </span><span class="cbracket">{</span>
<span class="normal">                        shift </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">                        sp</span><span class="symbol">--;</span>
<span class="normal">                     </span><span class="cbracket">}</span>
<span class="normal">                     </span><span class="keyword">else</span>
<span class="normal">                        shift </span><span class="symbol">=</span><span class="normal"> </span><span class="number">4</span><span class="symbol">;</span>

<span class="normal">                     dp</span><span class="symbol">--;</span>
<span class="normal">                  </span><span class="cbracket">}</span>
<span class="normal">                  </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            row_info</span><span class="symbol">-&gt;</span><span class="normal">bit_depth </span><span class="symbol">=</span><span class="normal"> </span><span class="number">8</span><span class="symbol">;</span>
<span class="normal">            row_info</span><span class="symbol">-&gt;</span><span class="normal">pixel_depth </span><span class="symbol">=</span><span class="normal"> </span><span class="number">8</span><span class="symbol">;</span>
<span class="normal">            row_info</span><span class="symbol">-&gt;</span><span class="normal">rowbytes </span><span class="symbol">=</span><span class="normal"> row_width</span><span class="symbol">;</span>
<span class="normal">         </span><span class="cbracket">}</span>

<span class="normal">         </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">trans_value </span><span class="symbol">!=</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">bit_depth </span><span class="symbol">==</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               sp </span><span class="symbol">=</span><span class="normal"> row </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_size_t</span><span class="symbol">)</span><span class="normal">row_width </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">               dp </span><span class="symbol">=</span><span class="normal"> row </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_size_t</span><span class="symbol">)(</span><span class="normal">row_width </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">               </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(*</span><span class="normal">sp </span><span class="symbol">==</span><span class="normal"> gray</span><span class="symbol">)</span>
<span class="normal">                     </span><span class="symbol">*</span><span class="normal">dp</span><span class="symbol">--</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="keyword">else</span>
<span class="normal">                     </span><span class="symbol">*</span><span class="normal">dp</span><span class="symbol">--</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="symbol">*</span><span class="normal">dp</span><span class="symbol">--</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">sp</span><span class="symbol">--;</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">bit_depth </span><span class="symbol">==</span><span class="normal"> </span><span class="number">16</span><span class="symbol">)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               sp </span><span class="symbol">=</span><span class="normal"> row </span><span class="symbol">+</span><span class="normal"> row_info</span><span class="symbol">-&gt;</span><span class="normal">rowbytes </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">               dp </span><span class="symbol">=</span><span class="normal"> row </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">rowbytes </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">               </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(((</span><span class="normal">png_uint_16</span><span class="symbol">)*(</span><span class="normal">sp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">|</span>
<span class="normal">                     </span><span class="symbol">((</span><span class="normal">png_uint_16</span><span class="symbol">)*(</span><span class="normal">sp </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> gray</span><span class="symbol">)</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     </span><span class="symbol">*</span><span class="normal">dp</span><span class="symbol">--</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">                     </span><span class="symbol">*</span><span class="normal">dp</span><span class="symbol">--</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="cbracket">}</span>
<span class="normal">                  </span><span class="keyword">else</span>
<span class="normal">                  </span><span class="cbracket">{</span>
<span class="normal">                     </span><span class="symbol">*</span><span class="normal">dp</span><span class="symbol">--</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">;</span>
<span class="normal">                     </span><span class="symbol">*</span><span class="normal">dp</span><span class="symbol">--</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="cbracket">}</span>
<span class="normal">                  </span><span class="symbol">*</span><span class="normal">dp</span><span class="symbol">--</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">sp</span><span class="symbol">--;</span>
<span class="normal">                  </span><span class="symbol">*</span><span class="normal">dp</span><span class="symbol">--</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">sp</span><span class="symbol">--;</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            row_info</span><span class="symbol">-&gt;</span><span class="normal">color_type </span><span class="symbol">=</span><span class="normal"> PNG_COLOR_TYPE_GRAY_ALPHA</span><span class="symbol">;</span>
<span class="normal">            row_info</span><span class="symbol">-&gt;</span><span class="normal">channels </span><span class="symbol">=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">            row_info</span><span class="symbol">-&gt;</span><span class="normal">pixel_depth </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">bit_depth </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">            row_info</span><span class="symbol">-&gt;</span><span class="normal">rowbytes </span><span class="symbol">=</span><span class="normal"> </span><span class="function">PNG_ROWBYTES</span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">pixel_depth</span><span class="symbol">,</span>
<span class="normal">               row_width</span><span class="symbol">);</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">color_type </span><span class="symbol">==</span><span class="normal"> PNG_COLOR_TYPE_RGB </span><span class="symbol">&amp;&amp;</span><span class="normal"> trans_value</span><span class="symbol">)</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">bit_depth </span><span class="symbol">==</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            sp </span><span class="symbol">=</span><span class="normal"> row </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_size_t</span><span class="symbol">)</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">rowbytes </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">            dp </span><span class="symbol">=</span><span class="normal"> row </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_size_t</span><span class="symbol">)(</span><span class="normal">row_width </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">            </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(*(</span><span class="normal">sp </span><span class="symbol">-</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> trans_value</span><span class="symbol">-&gt;</span><span class="normal">red </span><span class="symbol">&amp;&amp;</span>
<span class="normal">                  </span><span class="symbol">*(</span><span class="normal">sp </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> trans_value</span><span class="symbol">-&gt;</span><span class="normal">green </span><span class="symbol">&amp;&amp;</span>
<span class="normal">                  </span><span class="symbol">*(</span><span class="normal">sp </span><span class="symbol">-</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> trans_value</span><span class="symbol">-&gt;</span><span class="normal">blue</span><span class="symbol">)</span>
<span class="normal">                  </span><span class="symbol">*</span><span class="normal">dp</span><span class="symbol">--</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">               </span><span class="keyword">else</span>
<span class="normal">                  </span><span class="symbol">*</span><span class="normal">dp</span><span class="symbol">--</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">;</span>
<span class="normal">               </span><span class="symbol">*</span><span class="normal">dp</span><span class="symbol">--</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">sp</span><span class="symbol">--;</span>
<span class="normal">               </span><span class="symbol">*</span><span class="normal">dp</span><span class="symbol">--</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">sp</span><span class="symbol">--;</span>
<span class="normal">               </span><span class="symbol">*</span><span class="normal">dp</span><span class="symbol">--</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">sp</span><span class="symbol">--;</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">         </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">bit_depth </span><span class="symbol">==</span><span class="normal"> </span><span class="number">16</span><span class="symbol">)</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            sp </span><span class="symbol">=</span><span class="normal"> row </span><span class="symbol">+</span><span class="normal"> row_info</span><span class="symbol">-&gt;</span><span class="normal">rowbytes </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">            dp </span><span class="symbol">=</span><span class="normal"> row </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_size_t</span><span class="symbol">)(</span><span class="normal">row_width </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">3</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">            </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">               </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((((</span><span class="normal">png_uint_16</span><span class="symbol">)*(</span><span class="normal">sp </span><span class="symbol">-</span><span class="normal"> </span><span class="number">4</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">|</span>
<span class="normal">                  </span><span class="symbol">((</span><span class="normal">png_uint_16</span><span class="symbol">)*(</span><span class="normal">sp </span><span class="symbol">-</span><span class="normal"> </span><span class="number">5</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> trans_value</span><span class="symbol">-&gt;</span><span class="normal">red</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span>
<span class="normal">                  </span><span class="symbol">(((</span><span class="normal">png_uint_16</span><span class="symbol">)*(</span><span class="normal">sp </span><span class="symbol">-</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">|</span>
<span class="normal">                  </span><span class="symbol">((</span><span class="normal">png_uint_16</span><span class="symbol">)*(</span><span class="normal">sp </span><span class="symbol">-</span><span class="normal"> </span><span class="number">3</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> trans_value</span><span class="symbol">-&gt;</span><span class="normal">green</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span>
<span class="normal">                  </span><span class="symbol">(((</span><span class="normal">png_uint_16</span><span class="symbol">)*(</span><span class="normal">sp </span><span class="symbol">-</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">|</span>
<span class="normal">                  </span><span class="symbol">((</span><span class="normal">png_uint_16</span><span class="symbol">)*(</span><span class="normal">sp </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> trans_value</span><span class="symbol">-&gt;</span><span class="normal">blue</span><span class="symbol">))</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  </span><span class="symbol">*</span><span class="normal">dp</span><span class="symbol">--</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="symbol">*</span><span class="normal">dp</span><span class="symbol">--</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="keyword">else</span>
<span class="normal">               </span><span class="cbracket">{</span>
<span class="normal">                  </span><span class="symbol">*</span><span class="normal">dp</span><span class="symbol">--</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">;</span>
<span class="normal">                  </span><span class="symbol">*</span><span class="normal">dp</span><span class="symbol">--</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">;</span>
<span class="normal">               </span><span class="cbracket">}</span>
<span class="normal">               </span><span class="symbol">*</span><span class="normal">dp</span><span class="symbol">--</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">sp</span><span class="symbol">--;</span>
<span class="normal">               </span><span class="symbol">*</span><span class="normal">dp</span><span class="symbol">--</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">sp</span><span class="symbol">--;</span>
<span class="normal">               </span><span class="symbol">*</span><span class="normal">dp</span><span class="symbol">--</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">sp</span><span class="symbol">--;</span>
<span class="normal">               </span><span class="symbol">*</span><span class="normal">dp</span><span class="symbol">--</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">sp</span><span class="symbol">--;</span>
<span class="normal">               </span><span class="symbol">*</span><span class="normal">dp</span><span class="symbol">--</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">sp</span><span class="symbol">--;</span>
<span class="normal">               </span><span class="symbol">*</span><span class="normal">dp</span><span class="symbol">--</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">sp</span><span class="symbol">--;</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">         row_info</span><span class="symbol">-&gt;</span><span class="normal">color_type </span><span class="symbol">=</span><span class="normal"> PNG_COLOR_TYPE_RGB_ALPHA</span><span class="symbol">;</span>
<span class="normal">         row_info</span><span class="symbol">-&gt;</span><span class="normal">channels </span><span class="symbol">=</span><span class="normal"> </span><span class="number">4</span><span class="symbol">;</span>
<span class="normal">         row_info</span><span class="symbol">-&gt;</span><span class="normal">pixel_depth </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">bit_depth </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">2</span><span class="symbol">);</span>
<span class="normal">         row_info</span><span class="symbol">-&gt;</span><span class="normal">rowbytes </span><span class="symbol">=</span><span class="normal"> </span><span class="function">PNG_ROWBYTES</span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">pixel_depth</span><span class="symbol">,</span><span class="normal">row_width</span><span class="symbol">);</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">   </span><span class="cbracket">}</span>
<span class="cbracket">}</span>
<span class="preproc">#endif</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_DITHER_SUPPORTED</span><span class="symbol">)</span>
<span class="type">void</span><span class="normal"> </span><span class="comment">/* PRIVATE */</span>
<span class="function">png_do_dither</span><span class="symbol">(</span><span class="usertype">png_row_infop</span><span class="normal"> row_info</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">png_bytep</span><span class="normal"> row</span><span class="symbol">,</span>
<span class="normal">    </span><span class="usertype">png_bytep</span><span class="normal"> palette_lookup</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">png_bytep</span><span class="normal"> dither_lookup</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">   </span><span class="usertype">png_bytep</span><span class="normal"> sp</span><span class="symbol">,</span><span class="normal"> dp</span><span class="symbol">;</span>
<span class="normal">   </span><span class="usertype">png_uint_32</span><span class="normal"> i</span><span class="symbol">;</span>
<span class="normal">   </span><span class="usertype">png_uint_32</span><span class="normal"> row_width</span><span class="symbol">=</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">width</span><span class="symbol">;</span>

<span class="normal">   </span><span class="function">png_debug</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"in png_do_dither</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_USELESS_TESTS_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row </span><span class="symbol">!=</span><span class="normal"> NULL </span><span class="symbol">&amp;&amp;</span><span class="normal"> row_info </span><span class="symbol">!=</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="preproc">#endif</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">color_type </span><span class="symbol">==</span><span class="normal"> PNG_COLOR_TYPE_RGB </span><span class="symbol">&amp;&amp;</span>
<span class="normal">         palette_lookup </span><span class="symbol">&amp;&amp;</span><span class="normal"> row_info</span><span class="symbol">-&gt;</span><span class="normal">bit_depth </span><span class="symbol">==</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         </span><span class="type">int</span><span class="normal"> r</span><span class="symbol">,</span><span class="normal"> g</span><span class="symbol">,</span><span class="normal"> b</span><span class="symbol">,</span><span class="normal"> p</span><span class="symbol">;</span>
<span class="normal">         sp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">         dp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">         </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            r </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">sp</span><span class="symbol">++;</span>
<span class="normal">            g </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">sp</span><span class="symbol">++;</span>
<span class="normal">            b </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">sp</span><span class="symbol">++;</span>

<span class="normal">            </span><span class="comment">/* this looks real messy, but the compiler will reduce</span>
<span class="comment">               it down to a reasonable formula.  For example, with</span>
<span class="comment">               5 bits per color, we get:</span>
<span class="comment">               p = (((r &gt;&gt; 3) &amp; 0x1f) &lt;&lt; 10) |</span>
<span class="comment">                  (((g &gt;&gt; 3) &amp; 0x1f) &lt;&lt; 5) |</span>
<span class="comment">                  ((b &gt;&gt; 3) &amp; 0x1f);</span>
<span class="comment">               */</span>
<span class="normal">            p </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(((</span><span class="normal">r </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="symbol">(</span><span class="number">8</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> PNG_DITHER_RED_BITS</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&amp;</span>
<span class="normal">               </span><span class="symbol">((</span><span class="number">1</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> PNG_DITHER_RED_BITS</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span>
<span class="normal">               </span><span class="symbol">(</span><span class="normal">PNG_DITHER_GREEN_BITS </span><span class="symbol">+</span><span class="normal"> PNG_DITHER_BLUE_BITS</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">|</span>
<span class="normal">               </span><span class="symbol">(((</span><span class="normal">g </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="symbol">(</span><span class="number">8</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> PNG_DITHER_GREEN_BITS</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&amp;</span>
<span class="normal">               </span><span class="symbol">((</span><span class="number">1</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> PNG_DITHER_GREEN_BITS</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span>
<span class="normal">               </span><span class="symbol">(</span><span class="normal">PNG_DITHER_BLUE_BITS</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">|</span>
<span class="normal">               </span><span class="symbol">((</span><span class="normal">b </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="symbol">(</span><span class="number">8</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> PNG_DITHER_BLUE_BITS</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&amp;</span>
<span class="normal">               </span><span class="symbol">((</span><span class="number">1</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> PNG_DITHER_BLUE_BITS</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">));</span>

<span class="normal">            </span><span class="symbol">*</span><span class="normal">dp</span><span class="symbol">++</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> palette_lookup</span><span class="symbol">[</span><span class="normal">p</span><span class="symbol">];</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">         row_info</span><span class="symbol">-&gt;</span><span class="normal">color_type </span><span class="symbol">=</span><span class="normal"> PNG_COLOR_TYPE_PALETTE</span><span class="symbol">;</span>
<span class="normal">         row_info</span><span class="symbol">-&gt;</span><span class="normal">channels </span><span class="symbol">=</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">         row_info</span><span class="symbol">-&gt;</span><span class="normal">pixel_depth </span><span class="symbol">=</span><span class="normal"> row_info</span><span class="symbol">-&gt;</span><span class="normal">bit_depth</span><span class="symbol">;</span>
<span class="normal">         row_info</span><span class="symbol">-&gt;</span><span class="normal">rowbytes </span><span class="symbol">=</span><span class="normal"> </span><span class="function">PNG_ROWBYTES</span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">pixel_depth</span><span class="symbol">,</span><span class="normal">row_width</span><span class="symbol">);</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">color_type </span><span class="symbol">==</span><span class="normal"> PNG_COLOR_TYPE_RGB_ALPHA </span><span class="symbol">&amp;&amp;</span>
<span class="normal">         palette_lookup </span><span class="symbol">!=</span><span class="normal"> NULL </span><span class="symbol">&amp;&amp;</span><span class="normal"> row_info</span><span class="symbol">-&gt;</span><span class="normal">bit_depth </span><span class="symbol">==</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         </span><span class="type">int</span><span class="normal"> r</span><span class="symbol">,</span><span class="normal"> g</span><span class="symbol">,</span><span class="normal"> b</span><span class="symbol">,</span><span class="normal"> p</span><span class="symbol">;</span>
<span class="normal">         sp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">         dp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">         </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            r </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">sp</span><span class="symbol">++;</span>
<span class="normal">            g </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">sp</span><span class="symbol">++;</span>
<span class="normal">            b </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">sp</span><span class="symbol">++;</span>
<span class="normal">            sp</span><span class="symbol">++;</span>

<span class="normal">            p </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(((</span><span class="normal">r </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="symbol">(</span><span class="number">8</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> PNG_DITHER_RED_BITS</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&amp;</span>
<span class="normal">               </span><span class="symbol">((</span><span class="number">1</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> PNG_DITHER_RED_BITS</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span>
<span class="normal">               </span><span class="symbol">(</span><span class="normal">PNG_DITHER_GREEN_BITS </span><span class="symbol">+</span><span class="normal"> PNG_DITHER_BLUE_BITS</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">|</span>
<span class="normal">               </span><span class="symbol">(((</span><span class="normal">g </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="symbol">(</span><span class="number">8</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> PNG_DITHER_GREEN_BITS</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&amp;</span>
<span class="normal">               </span><span class="symbol">((</span><span class="number">1</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> PNG_DITHER_GREEN_BITS</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span>
<span class="normal">               </span><span class="symbol">(</span><span class="normal">PNG_DITHER_BLUE_BITS</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">|</span>
<span class="normal">               </span><span class="symbol">((</span><span class="normal">b </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="symbol">(</span><span class="number">8</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> PNG_DITHER_BLUE_BITS</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&amp;</span>
<span class="normal">               </span><span class="symbol">((</span><span class="number">1</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> PNG_DITHER_BLUE_BITS</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">));</span>

<span class="normal">            </span><span class="symbol">*</span><span class="normal">dp</span><span class="symbol">++</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> palette_lookup</span><span class="symbol">[</span><span class="normal">p</span><span class="symbol">];</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">         row_info</span><span class="symbol">-&gt;</span><span class="normal">color_type </span><span class="symbol">=</span><span class="normal"> PNG_COLOR_TYPE_PALETTE</span><span class="symbol">;</span>
<span class="normal">         row_info</span><span class="symbol">-&gt;</span><span class="normal">channels </span><span class="symbol">=</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">         row_info</span><span class="symbol">-&gt;</span><span class="normal">pixel_depth </span><span class="symbol">=</span><span class="normal"> row_info</span><span class="symbol">-&gt;</span><span class="normal">bit_depth</span><span class="symbol">;</span>
<span class="normal">         row_info</span><span class="symbol">-&gt;</span><span class="normal">rowbytes </span><span class="symbol">=</span><span class="normal"> </span><span class="function">PNG_ROWBYTES</span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">pixel_depth</span><span class="symbol">,</span><span class="normal">row_width</span><span class="symbol">);</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">color_type </span><span class="symbol">==</span><span class="normal"> PNG_COLOR_TYPE_PALETTE </span><span class="symbol">&amp;&amp;</span>
<span class="normal">         dither_lookup </span><span class="symbol">&amp;&amp;</span><span class="normal"> row_info</span><span class="symbol">-&gt;</span><span class="normal">bit_depth </span><span class="symbol">==</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         sp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span>
<span class="normal">         </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++,</span><span class="normal"> sp</span><span class="symbol">++)</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="symbol">*</span><span class="normal">sp </span><span class="symbol">=</span><span class="normal"> dither_lookup</span><span class="symbol">[*</span><span class="normal">sp</span><span class="symbol">];</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">   </span><span class="cbracket">}</span>
<span class="cbracket">}</span>
<span class="preproc">#endif</span>

<span class="preproc">#ifdef</span><span class="normal"> PNG_FLOATING_POINT_SUPPORTED</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_GAMMA_SUPPORTED</span><span class="symbol">)</span>
<span class="keyword">static</span><span class="normal"> </span><span class="type">int</span><span class="normal"> png_gamma_shift</span><span class="symbol">[]</span><span class="normal"> </span><span class="symbol">=</span>
<span class="normal">   </span><span class="cbracket">{</span><span class="number">0x10</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x21</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x42</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x84</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x110</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x248</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x550</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0xff0</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0x00</span><span class="cbracket">}</span><span class="symbol">;</span>

<span class="comment">/* We build the 8- or 16-bit gamma tables here.  Note that for 16-bit</span>
<span class="comment"> * tables, we don't make a full table if we are reducing to 8-bit in</span>
<span class="comment"> * the future.  Note also how the gamma_16 tables are segmented so that</span>
<span class="comment"> * we don't need to allocate &gt; 64K chunks for a full 16-bit table.</span>
<span class="comment"> */</span>
<span class="type">void</span><span class="normal"> </span><span class="comment">/* PRIVATE */</span>
<span class="function">png_build_gamma_table</span><span class="symbol">(</span><span class="usertype">png_structp</span><span class="normal"> png_ptr</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">  </span><span class="function">png_debug</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"in png_build_gamma_table</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>

<span class="normal">  </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">bit_depth </span><span class="symbol">&lt;=</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span>
<span class="normal">  </span><span class="cbracket">{</span>
<span class="normal">     </span><span class="type">int</span><span class="normal"> i</span><span class="symbol">;</span>
<span class="normal">     </span><span class="type">double</span><span class="normal"> g</span><span class="symbol">;</span>

<span class="normal">     </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">screen_gamma </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="symbol">.</span><span class="number">000001</span><span class="symbol">)</span>
<span class="normal">        g </span><span class="symbol">=</span><span class="normal"> </span><span class="number">1.0</span><span class="normal"> </span><span class="symbol">/</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma </span><span class="symbol">*</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">screen_gamma</span><span class="symbol">);</span>
<span class="normal">     </span><span class="keyword">else</span>
<span class="normal">        g </span><span class="symbol">=</span><span class="normal"> </span><span class="number">1.0</span><span class="symbol">;</span>

<span class="normal">     png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_table </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_bytep</span><span class="symbol">)</span><span class="function">png_malloc</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span>
<span class="normal">        </span><span class="symbol">(</span><span class="normal">png_uint_32</span><span class="symbol">)</span><span class="number">256</span><span class="symbol">);</span>

<span class="normal">     </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">256</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">     </span><span class="cbracket">{</span>
<span class="normal">        png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_table</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="function">pow</span><span class="symbol">((</span><span class="type">double</span><span class="symbol">)</span><span class="normal">i </span><span class="symbol">/</span><span class="normal"> </span><span class="number">255.0</span><span class="symbol">,</span>
<span class="normal">           g</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> </span><span class="number">255.0</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">.</span><span class="number">5</span><span class="symbol">);</span>
<span class="normal">     </span><span class="cbracket">}</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_BACKGROUND_SUPPORTED</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">   </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_RGB_TO_GRAY_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">     </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">PNG_BACKGROUND</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">|</span><span class="normal"> PNG_RGB_TO_GRAY</span><span class="symbol">))</span>
<span class="normal">     </span><span class="cbracket">{</span>

<span class="normal">        g </span><span class="symbol">=</span><span class="normal"> </span><span class="number">1.0</span><span class="normal"> </span><span class="symbol">/</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma</span><span class="symbol">);</span>

<span class="normal">        png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_to_1 </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_bytep</span><span class="symbol">)</span><span class="function">png_malloc</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span>
<span class="normal">           </span><span class="symbol">(</span><span class="normal">png_uint_32</span><span class="symbol">)</span><span class="number">256</span><span class="symbol">);</span>

<span class="normal">        </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">256</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">        </span><span class="cbracket">{</span>
<span class="normal">           png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_to_1</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="function">pow</span><span class="symbol">((</span><span class="type">double</span><span class="symbol">)</span><span class="normal">i </span><span class="symbol">/</span><span class="normal"> </span><span class="number">255.0</span><span class="symbol">,</span>
<span class="normal">              g</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> </span><span class="number">255.0</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">.</span><span class="number">5</span><span class="symbol">);</span>
<span class="normal">        </span><span class="cbracket">}</span>


<span class="normal">        png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_from_1 </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_bytep</span><span class="symbol">)</span><span class="function">png_malloc</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span>
<span class="normal">           </span><span class="symbol">(</span><span class="normal">png_uint_32</span><span class="symbol">)</span><span class="number">256</span><span class="symbol">);</span>

<span class="normal">        </span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">screen_gamma </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">0.000001</span><span class="symbol">)</span>
<span class="normal">           g </span><span class="symbol">=</span><span class="normal"> </span><span class="number">1.0</span><span class="normal"> </span><span class="symbol">/</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">screen_gamma</span><span class="symbol">;</span>
<span class="normal">        </span><span class="keyword">else</span>
<span class="normal">           g </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma</span><span class="symbol">;</span><span class="normal">   </span><span class="comment">/* probably doing rgb_to_gray */</span>

<span class="normal">        </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">256</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">        </span><span class="cbracket">{</span>
<span class="normal">           png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_from_1</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="function">pow</span><span class="symbol">((</span><span class="type">double</span><span class="symbol">)</span><span class="normal">i </span><span class="symbol">/</span><span class="normal"> </span><span class="number">255.0</span><span class="symbol">,</span>
<span class="normal">              g</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> </span><span class="number">255.0</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">.</span><span class="number">5</span><span class="symbol">);</span>

<span class="normal">        </span><span class="cbracket">}</span>
<span class="normal">     </span><span class="cbracket">}</span>
<span class="preproc">#endif</span><span class="normal"> </span><span class="comment">/* PNG_READ_BACKGROUND_SUPPORTED || PNG_RGB_TO_GRAY_SUPPORTED */</span>
<span class="normal">  </span><span class="cbracket">}</span>
<span class="normal">  </span><span class="keyword">else</span>
<span class="normal">  </span><span class="cbracket">{</span>
<span class="normal">     </span><span class="type">double</span><span class="normal"> g</span><span class="symbol">;</span>
<span class="normal">     </span><span class="type">int</span><span class="normal"> i</span><span class="symbol">,</span><span class="normal"> j</span><span class="symbol">,</span><span class="normal"> shift</span><span class="symbol">,</span><span class="normal"> num</span><span class="symbol">;</span>
<span class="normal">     </span><span class="type">int</span><span class="normal"> sig_bit</span><span class="symbol">;</span>
<span class="normal">     </span><span class="usertype">png_uint_32</span><span class="normal"> ig</span><span class="symbol">;</span>

<span class="normal">     </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">color_type </span><span class="symbol">&amp;</span><span class="normal"> PNG_COLOR_MASK_COLOR</span><span class="symbol">)</span>
<span class="normal">     </span><span class="cbracket">{</span>
<span class="normal">        sig_bit </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="symbol">)</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">sig_bit</span><span class="symbol">.</span><span class="normal">red</span><span class="symbol">;</span>
<span class="normal">        </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="type">int</span><span class="symbol">)</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">sig_bit</span><span class="symbol">.</span><span class="normal">green </span><span class="symbol">&gt;</span><span class="normal"> sig_bit</span><span class="symbol">)</span>
<span class="normal">           sig_bit </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">sig_bit</span><span class="symbol">.</span><span class="normal">green</span><span class="symbol">;</span>
<span class="normal">        </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="type">int</span><span class="symbol">)</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">sig_bit</span><span class="symbol">.</span><span class="normal">blue </span><span class="symbol">&gt;</span><span class="normal"> sig_bit</span><span class="symbol">)</span>
<span class="normal">           sig_bit </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">sig_bit</span><span class="symbol">.</span><span class="normal">blue</span><span class="symbol">;</span>
<span class="normal">     </span><span class="cbracket">}</span>
<span class="normal">     </span><span class="keyword">else</span>
<span class="normal">     </span><span class="cbracket">{</span>
<span class="normal">        sig_bit </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="symbol">)</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">sig_bit</span><span class="symbol">.</span><span class="normal">gray</span><span class="symbol">;</span>
<span class="normal">     </span><span class="cbracket">}</span>

<span class="normal">     </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">sig_bit </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">        shift </span><span class="symbol">=</span><span class="normal"> </span><span class="number">16</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> sig_bit</span><span class="symbol">;</span>
<span class="normal">     </span><span class="keyword">else</span>
<span class="normal">        shift </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">     </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">&amp;</span><span class="normal"> PNG_16_TO_8</span><span class="symbol">)</span>
<span class="normal">     </span><span class="cbracket">{</span>
<span class="normal">        </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">shift </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="symbol">(</span><span class="number">16</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> PNG_MAX_GAMMA_8</span><span class="symbol">))</span>
<span class="normal">           shift </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="number">16</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> PNG_MAX_GAMMA_8</span><span class="symbol">);</span>
<span class="normal">     </span><span class="cbracket">}</span>

<span class="normal">     </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">shift </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span>
<span class="normal">        shift </span><span class="symbol">=</span><span class="normal"> </span><span class="number">8</span><span class="symbol">;</span>
<span class="normal">     </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">shift </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">        shift </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">     png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_shift </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)</span><span class="normal">shift</span><span class="symbol">;</span>

<span class="normal">     num </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="number">1</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="symbol">(</span><span class="number">8</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> shift</span><span class="symbol">));</span>

<span class="normal">     </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">screen_gamma </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="symbol">.</span><span class="number">000001</span><span class="symbol">)</span>
<span class="normal">        g </span><span class="symbol">=</span><span class="normal"> </span><span class="number">1.0</span><span class="normal"> </span><span class="symbol">/</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma </span><span class="symbol">*</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">screen_gamma</span><span class="symbol">);</span>
<span class="normal">     </span><span class="keyword">else</span>
<span class="normal">        g </span><span class="symbol">=</span><span class="normal"> </span><span class="number">1.0</span><span class="symbol">;</span>

<span class="normal">     png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_16_table </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16pp</span><span class="symbol">)</span><span class="function">png_malloc</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span>
<span class="normal">        </span><span class="symbol">(</span><span class="normal">png_uint_32</span><span class="symbol">)(</span><span class="normal">num </span><span class="symbol">*</span><span class="normal"> </span><span class="function">png_sizeof</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16p</span><span class="symbol">)));</span>

<span class="normal">     </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">PNG_16_TO_8 </span><span class="symbol">|</span><span class="normal"> PNG_BACKGROUND</span><span class="symbol">))</span>
<span class="normal">     </span><span class="cbracket">{</span>
<span class="normal">        </span><span class="type">double</span><span class="normal"> fin</span><span class="symbol">,</span><span class="normal"> fout</span><span class="symbol">;</span>
<span class="normal">        </span><span class="usertype">png_uint_32</span><span class="normal"> last</span><span class="symbol">,</span><span class="normal"> max</span><span class="symbol">;</span>

<span class="normal">        </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> num</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">        </span><span class="cbracket">{</span>
<span class="normal">           png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_16_table</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16p</span><span class="symbol">)</span><span class="function">png_malloc</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span>
<span class="normal">              </span><span class="symbol">(</span><span class="normal">png_uint_32</span><span class="symbol">)(</span><span class="number">256</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> </span><span class="function">png_sizeof</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)));</span>
<span class="normal">        </span><span class="cbracket">}</span>

<span class="normal">        g </span><span class="symbol">=</span><span class="normal"> </span><span class="number">1.0</span><span class="normal"> </span><span class="symbol">/</span><span class="normal"> g</span><span class="symbol">;</span>
<span class="normal">        last </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">        </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">256</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">        </span><span class="cbracket">{</span>
<span class="normal">           fout </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">((</span><span class="type">double</span><span class="symbol">)</span><span class="normal">i </span><span class="symbol">+</span><span class="normal"> </span><span class="number">0.5</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">/</span><span class="normal"> </span><span class="number">256.0</span><span class="symbol">;</span>
<span class="normal">           fin </span><span class="symbol">=</span><span class="normal"> </span><span class="function">pow</span><span class="symbol">(</span><span class="normal">fout</span><span class="symbol">,</span><span class="normal"> g</span><span class="symbol">);</span>
<span class="normal">           max </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_32</span><span class="symbol">)(</span><span class="normal">fin </span><span class="symbol">*</span><span class="normal"> </span><span class="symbol">(</span><span class="type">double</span><span class="symbol">)((</span><span class="normal">png_uint_32</span><span class="symbol">)</span><span class="normal">num </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">));</span>
<span class="normal">           </span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">last </span><span class="symbol">&lt;=</span><span class="normal"> max</span><span class="symbol">)</span>
<span class="normal">           </span><span class="cbracket">{</span>
<span class="normal">              png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_16_table</span><span class="symbol">[(</span><span class="type">int</span><span class="symbol">)(</span><span class="normal">last </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="number">0xff</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> shift</span><span class="symbol">))]</span>
<span class="normal">                 </span><span class="symbol">[(</span><span class="type">int</span><span class="symbol">)(</span><span class="normal">last </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="symbol">(</span><span class="number">8</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> shift</span><span class="symbol">))]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)(</span>
<span class="normal">                 </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)</span><span class="normal">i </span><span class="symbol">|</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">png_uint_16</span><span class="symbol">)</span><span class="normal">i </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">));</span>
<span class="normal">              last</span><span class="symbol">++;</span>
<span class="normal">           </span><span class="cbracket">}</span>
<span class="normal">        </span><span class="cbracket">}</span>
<span class="normal">        </span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">last </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">png_uint_32</span><span class="symbol">)</span><span class="normal">num </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">))</span>
<span class="normal">        </span><span class="cbracket">{</span>
<span class="normal">           png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_16_table</span><span class="symbol">[(</span><span class="type">int</span><span class="symbol">)(</span><span class="normal">last </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="number">0xff</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> shift</span><span class="symbol">))]</span>
<span class="normal">              </span><span class="symbol">[(</span><span class="type">int</span><span class="symbol">)(</span><span class="normal">last </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="symbol">(</span><span class="number">8</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> shift</span><span class="symbol">))]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)</span><span class="number">65535L</span><span class="symbol">;</span>
<span class="normal">           last</span><span class="symbol">++;</span>
<span class="normal">        </span><span class="cbracket">}</span>
<span class="normal">     </span><span class="cbracket">}</span>
<span class="normal">     </span><span class="keyword">else</span>
<span class="normal">     </span><span class="cbracket">{</span>
<span class="normal">        </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> num</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">        </span><span class="cbracket">{</span>
<span class="normal">           png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_16_table</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16p</span><span class="symbol">)</span><span class="function">png_malloc</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span>
<span class="normal">              </span><span class="symbol">(</span><span class="normal">png_uint_32</span><span class="symbol">)(</span><span class="number">256</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> </span><span class="function">png_sizeof</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)));</span>

<span class="normal">           ig </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(((</span><span class="normal">png_uint_32</span><span class="symbol">)</span><span class="normal">i </span><span class="symbol">*</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_32</span><span class="symbol">)</span><span class="normal">png_gamma_shift</span><span class="symbol">[</span><span class="normal">shift</span><span class="symbol">])</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">4</span><span class="symbol">);</span>
<span class="normal">           </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">j </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> j </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">256</span><span class="symbol">;</span><span class="normal"> j</span><span class="symbol">++)</span>
<span class="normal">           </span><span class="cbracket">{</span>
<span class="normal">              png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_16_table</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">][</span><span class="normal">j</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span>
<span class="normal">                 </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)(</span><span class="function">pow</span><span class="symbol">((</span><span class="type">double</span><span class="symbol">)(</span><span class="normal">ig </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">png_uint_32</span><span class="symbol">)</span><span class="normal">j </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">/</span>
<span class="normal">                    </span><span class="number">65535.0</span><span class="symbol">,</span><span class="normal"> g</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> </span><span class="number">65535.0</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">.</span><span class="number">5</span><span class="symbol">);</span>
<span class="normal">           </span><span class="cbracket">}</span>
<span class="normal">        </span><span class="cbracket">}</span>
<span class="normal">     </span><span class="cbracket">}</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_BACKGROUND_SUPPORTED</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">   </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_READ_RGB_TO_GRAY_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">     </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">transformations </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">PNG_BACKGROUND </span><span class="symbol">|</span><span class="normal"> PNG_RGB_TO_GRAY</span><span class="symbol">))</span>
<span class="normal">     </span><span class="cbracket">{</span>

<span class="normal">        g </span><span class="symbol">=</span><span class="normal"> </span><span class="number">1.0</span><span class="normal"> </span><span class="symbol">/</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma</span><span class="symbol">);</span>

<span class="normal">        png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_16_to_1 </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16pp</span><span class="symbol">)</span><span class="function">png_malloc</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span>
<span class="normal">           </span><span class="symbol">(</span><span class="normal">png_uint_32</span><span class="symbol">)(</span><span class="normal">num </span><span class="symbol">*</span><span class="normal"> </span><span class="function">png_sizeof</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16p </span><span class="symbol">)));</span>

<span class="normal">        </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> num</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">        </span><span class="cbracket">{</span>
<span class="normal">           png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_16_to_1</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16p</span><span class="symbol">)</span><span class="function">png_malloc</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span>
<span class="normal">              </span><span class="symbol">(</span><span class="normal">png_uint_32</span><span class="symbol">)(</span><span class="number">256</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> </span><span class="function">png_sizeof</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)));</span>

<span class="normal">           ig </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(((</span><span class="normal">png_uint_32</span><span class="symbol">)</span><span class="normal">i </span><span class="symbol">*</span>
<span class="normal">              </span><span class="symbol">(</span><span class="normal">png_uint_32</span><span class="symbol">)</span><span class="normal">png_gamma_shift</span><span class="symbol">[</span><span class="normal">shift</span><span class="symbol">])</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">4</span><span class="symbol">);</span>
<span class="normal">           </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">j </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> j </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">256</span><span class="symbol">;</span><span class="normal"> j</span><span class="symbol">++)</span>
<span class="normal">           </span><span class="cbracket">{</span>
<span class="normal">              png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_16_to_1</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">][</span><span class="normal">j</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span>
<span class="normal">                 </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)(</span><span class="function">pow</span><span class="symbol">((</span><span class="type">double</span><span class="symbol">)(</span><span class="normal">ig </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">png_uint_32</span><span class="symbol">)</span><span class="normal">j </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">/</span>
<span class="normal">                    </span><span class="number">65535.0</span><span class="symbol">,</span><span class="normal"> g</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> </span><span class="number">65535.0</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">.</span><span class="number">5</span><span class="symbol">);</span>
<span class="normal">           </span><span class="cbracket">}</span>
<span class="normal">        </span><span class="cbracket">}</span>

<span class="normal">        </span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">-&gt;</span><span class="normal">screen_gamma </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">0.000001</span><span class="symbol">)</span>
<span class="normal">           g </span><span class="symbol">=</span><span class="normal"> </span><span class="number">1.0</span><span class="normal"> </span><span class="symbol">/</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">screen_gamma</span><span class="symbol">;</span>
<span class="normal">        </span><span class="keyword">else</span>
<span class="normal">           g </span><span class="symbol">=</span><span class="normal"> png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma</span><span class="symbol">;</span><span class="normal">   </span><span class="comment">/* probably doing rgb_to_gray */</span>

<span class="normal">        png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_16_from_1 </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16pp</span><span class="symbol">)</span><span class="function">png_malloc</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span>
<span class="normal">           </span><span class="symbol">(</span><span class="normal">png_uint_32</span><span class="symbol">)(</span><span class="normal">num </span><span class="symbol">*</span><span class="normal"> </span><span class="function">png_sizeof</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16p</span><span class="symbol">)));</span>

<span class="normal">        </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> num</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span>
<span class="normal">        </span><span class="cbracket">{</span>
<span class="normal">           png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_16_from_1</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16p</span><span class="symbol">)</span><span class="function">png_malloc</span><span class="symbol">(</span><span class="normal">png_ptr</span><span class="symbol">,</span>
<span class="normal">              </span><span class="symbol">(</span><span class="normal">png_uint_32</span><span class="symbol">)(</span><span class="number">256</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> </span><span class="function">png_sizeof</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)));</span>

<span class="normal">           ig </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(((</span><span class="normal">png_uint_32</span><span class="symbol">)</span><span class="normal">i </span><span class="symbol">*</span>
<span class="normal">              </span><span class="symbol">(</span><span class="normal">png_uint_32</span><span class="symbol">)</span><span class="normal">png_gamma_shift</span><span class="symbol">[</span><span class="normal">shift</span><span class="symbol">])</span><span class="normal"> </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">4</span><span class="symbol">);</span>
<span class="normal">           </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">j </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> j </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">256</span><span class="symbol">;</span><span class="normal"> j</span><span class="symbol">++)</span>
<span class="normal">           </span><span class="cbracket">{</span>
<span class="normal">              png_ptr</span><span class="symbol">-&gt;</span><span class="normal">gamma_16_from_1</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">][</span><span class="normal">j</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span>
<span class="normal">                 </span><span class="symbol">(</span><span class="normal">png_uint_16</span><span class="symbol">)(</span><span class="function">pow</span><span class="symbol">((</span><span class="type">double</span><span class="symbol">)(</span><span class="normal">ig </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">png_uint_32</span><span class="symbol">)</span><span class="normal">j </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">/</span>
<span class="normal">                    </span><span class="number">65535.0</span><span class="symbol">,</span><span class="normal"> g</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> </span><span class="number">65535.0</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">.</span><span class="number">5</span><span class="symbol">);</span>
<span class="normal">           </span><span class="cbracket">}</span>
<span class="normal">        </span><span class="cbracket">}</span>
<span class="normal">     </span><span class="cbracket">}</span>
<span class="preproc">#endif</span><span class="normal"> </span><span class="comment">/* PNG_READ_BACKGROUND_SUPPORTED || PNG_RGB_TO_GRAY_SUPPORTED */</span>
<span class="normal">  </span><span class="cbracket">}</span>
<span class="cbracket">}</span>
<span class="preproc">#endif</span>
<span class="comment">/* To do: install integer version of png_build_gamma_table here */</span>
<span class="preproc">#endif</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_MNG_FEATURES_SUPPORTED</span><span class="symbol">)</span>
<span class="comment">/* undoes intrapixel differencing  */</span>
<span class="type">void</span><span class="normal"> </span><span class="comment">/* PRIVATE */</span>
<span class="function">png_do_read_intrapixel</span><span class="symbol">(</span><span class="usertype">png_row_infop</span><span class="normal"> row_info</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">png_bytep</span><span class="normal"> row</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">   </span><span class="function">png_debug</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"in png_do_read_intrapixel</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">   </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="function">defined</span><span class="symbol">(</span><span class="normal">PNG_USELESS_TESTS_SUPPORTED</span><span class="symbol">)</span>
<span class="normal">       row </span><span class="symbol">!=</span><span class="normal"> NULL </span><span class="symbol">&amp;&amp;</span><span class="normal"> row_info </span><span class="symbol">!=</span><span class="normal"> NULL </span><span class="symbol">&amp;&amp;</span>
<span class="preproc">#endif</span>
<span class="normal">       </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">color_type </span><span class="symbol">&amp;</span><span class="normal"> PNG_COLOR_MASK_COLOR</span><span class="symbol">))</span>
<span class="normal">   </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="type">int</span><span class="normal"> bytes_per_pixel</span><span class="symbol">;</span>
<span class="normal">      </span><span class="usertype">png_uint_32</span><span class="normal"> row_width </span><span class="symbol">=</span><span class="normal"> row_info</span><span class="symbol">-&gt;</span><span class="normal">width</span><span class="symbol">;</span>
<span class="normal">      </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">bit_depth </span><span class="symbol">==</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         </span><span class="usertype">png_bytep</span><span class="normal"> rp</span><span class="symbol">;</span>
<span class="normal">         </span><span class="usertype">png_uint_32</span><span class="normal"> i</span><span class="symbol">;</span>

<span class="normal">         </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">color_type </span><span class="symbol">==</span><span class="normal"> PNG_COLOR_TYPE_RGB</span><span class="symbol">)</span>
<span class="normal">            bytes_per_pixel </span><span class="symbol">=</span><span class="normal"> </span><span class="number">3</span><span class="symbol">;</span>
<span class="normal">         </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">color_type </span><span class="symbol">==</span><span class="normal"> PNG_COLOR_TYPE_RGB_ALPHA</span><span class="symbol">)</span>
<span class="normal">            bytes_per_pixel </span><span class="symbol">=</span><span class="normal"> </span><span class="number">4</span><span class="symbol">;</span>
<span class="normal">         </span><span class="keyword">else</span>
<span class="normal">            </span><span class="keyword">return</span><span class="symbol">;</span>

<span class="normal">         </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> rp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++,</span><span class="normal"> rp </span><span class="symbol">+=</span><span class="normal"> bytes_per_pixel</span><span class="symbol">)</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="symbol">*(</span><span class="normal">rp</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((</span><span class="number">256</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">rp </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">rp</span><span class="symbol">+</span><span class="number">1</span><span class="symbol">))&amp;</span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">            </span><span class="symbol">*(</span><span class="normal">rp</span><span class="symbol">+</span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((</span><span class="number">256</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">rp</span><span class="symbol">+</span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">rp</span><span class="symbol">+</span><span class="number">1</span><span class="symbol">))&amp;</span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">bit_depth </span><span class="symbol">==</span><span class="normal"> </span><span class="number">16</span><span class="symbol">)</span>
<span class="normal">      </span><span class="cbracket">{</span>
<span class="normal">         </span><span class="usertype">png_bytep</span><span class="normal"> rp</span><span class="symbol">;</span>
<span class="normal">         </span><span class="usertype">png_uint_32</span><span class="normal"> i</span><span class="symbol">;</span>

<span class="normal">         </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">color_type </span><span class="symbol">==</span><span class="normal"> PNG_COLOR_TYPE_RGB</span><span class="symbol">)</span>
<span class="normal">            bytes_per_pixel </span><span class="symbol">=</span><span class="normal"> </span><span class="number">6</span><span class="symbol">;</span>
<span class="normal">         </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">row_info</span><span class="symbol">-&gt;</span><span class="normal">color_type </span><span class="symbol">==</span><span class="normal"> PNG_COLOR_TYPE_RGB_ALPHA</span><span class="symbol">)</span>
<span class="normal">            bytes_per_pixel </span><span class="symbol">=</span><span class="normal"> </span><span class="number">8</span><span class="symbol">;</span>
<span class="normal">         </span><span class="keyword">else</span>
<span class="normal">            </span><span class="keyword">return</span><span class="symbol">;</span>

<span class="normal">         </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> rp </span><span class="symbol">=</span><span class="normal"> row</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> row_width</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++,</span><span class="normal"> rp </span><span class="symbol">+=</span><span class="normal"> bytes_per_pixel</span><span class="symbol">)</span>
<span class="normal">         </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="usertype">png_uint_32</span><span class="normal"> s0   </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(*(</span><span class="normal">rp  </span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">|</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">rp</span><span class="symbol">+</span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">            </span><span class="usertype">png_uint_32</span><span class="normal"> s1   </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(*(</span><span class="normal">rp</span><span class="symbol">+</span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">|</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">rp</span><span class="symbol">+</span><span class="number">3</span><span class="symbol">);</span>
<span class="normal">            </span><span class="usertype">png_uint_32</span><span class="normal"> s2   </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(*(</span><span class="normal">rp</span><span class="symbol">+</span><span class="number">4</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">|</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">rp</span><span class="symbol">+</span><span class="number">5</span><span class="symbol">);</span>
<span class="normal">            </span><span class="usertype">png_uint_32</span><span class="normal"> red  </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_32</span><span class="symbol">)((</span><span class="normal">s0</span><span class="symbol">+</span><span class="normal">s1</span><span class="symbol">+</span><span class="number">65536L</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xffffL</span><span class="symbol">);</span>
<span class="normal">            </span><span class="usertype">png_uint_32</span><span class="normal"> blue </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_uint_32</span><span class="symbol">)((</span><span class="normal">s2</span><span class="symbol">+</span><span class="normal">s1</span><span class="symbol">+</span><span class="number">65536L</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xffffL</span><span class="symbol">);</span>
<span class="normal">            </span><span class="symbol">*(</span><span class="normal">rp  </span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((</span><span class="normal">red </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">            </span><span class="symbol">*(</span><span class="normal">rp</span><span class="symbol">+</span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">red </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">            </span><span class="symbol">*(</span><span class="normal">rp</span><span class="symbol">+</span><span class="number">4</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)((</span><span class="normal">blue </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">            </span><span class="symbol">*(</span><span class="normal">rp</span><span class="symbol">+</span><span class="number">5</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">png_byte</span><span class="symbol">)(</span><span class="normal">blue </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">         </span><span class="cbracket">}</span>
<span class="normal">      </span><span class="cbracket">}</span>
<span class="normal">   </span><span class="cbracket">}</span>
<span class="cbracket">}</span>
<span class="preproc">#endif</span><span class="normal"> </span><span class="comment">/* PNG_MNG_FEATURES_SUPPORTED */</span>
<span class="preproc">#endif</span><span class="normal"> </span><span class="comment">/* PNG_READ_SUPPORTED */</span>
</tt></pre></div><footer><div style="text-align: right; padding: 8pt; font-size: 13px"><a href="/xmlfeed/weblog-rss20.xml"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAAAPAgMAAAAOp6AcAAAADFBMVEVmZmb/ZgD///+JjnlbTUWmAAAACXBIWXMAAABIAAAASABGyWs+AAAACXZwQWcAAABQAAAADwCexKkxAAAAWUlEQVQYlWNgwAa0VmGAFQyqoSCQ/x8J/CBFMCt0ZdTU/F/7/+1HEkydFpoKVPn+93sUlUujQvP/7UcRTAuNDJ2a//s/imDqtKVZofm/1qGYSZk7sfodGwAAiobBJtffoNAAAAAASUVORK5CYII=" alt="RSS 2.0 Weblog Feed" width="80" height="15"/></a> <a href="/xmlfeed/weblog-atom10.xml"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAAAPAgMAAAAOp6AcAAAADFBMVEVmZmb/ZgD///+JjnlbTUWmAAAAaklEQVQYlWNgwAa0VmGAFQyqoSCQ/x8J/CBFMDV16rTQ/H/7V//69+//v/3/9oMEI6cuAwr+fv/+/b5d///v//0eJBgWOhMo+Gs9UPAdXDBy6lSYyn9wQZCZS0GCYDPXQcykzJ1Y/Y4NAABKvL80wyoMPgAAAABJRU5ErkJggg==" alt="Atom 1.0 Weblog Feed" width="80" height="15"/></a> <a href="http://validator.w3.org/check?uri=referer"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAAAPCAMAAABEF7i9AAAB1FBMVEUHQIgIRY0MN4QNRYoSRYsXUpIYVJQeUpUhWpgjUJMjWpgmU5QnXJkuYZ0uYpwwV5YyZJ4zaKM3ZaA5aaI6aqM6a6E8ZqA8Z6BAbaRBbqdCbaVHd61KSkpKcaZQUFBUf69UgbBVVVVXfq9Yg7NZhbJZh7RagrNeXVxeh7RfjLdgYGBiiLZmZmZnZ2doirhpkbt0m8F3m8B3ncJ5lb55ocR+ocSDgX+Do8eEpMqGhoaHp8iIpMeJjnmJpseKqMeOqsqPsdCQrcyVlZWVsM2Zs9CZtNCfu9ahoaGhuNShudSivNSjtMWjvNSmpqWnpqSrw9qvxNqyxdmyxdyzsK6zs7Ozx9y0xt21yN22tra4y+K80eK/v7/AwMDExMTEy9DH2ejK2+jM2ujN3uvP0dLR0NDR3uvS3uvS3+zU4u3V1dXY2dnY4u7Y4+3b5e/d3d3d5u/d5/De3t7f39/h4uLj4uHj6/Ll7PXm7fTn7/Xo7/Tp7/bq7Ozr6unr8ffw8PDw9vvx9fny+P7z8/Pz9vnz9vv3+fv4+vz5+vz6+vr6+/36/P36///7+/77/Pz7/f37/f78/Pz8/f38/f79/f39/f79/f/9/v79///+/v7+/v////3///+tYR2LAAABKklEQVQ4y2PQoTJg0JlNVYDPQBsyAMTAqaFes8tdsmdPCtA3MDStr3GKKK6myMAprgJ9pcpWs/MlRExYJBvNZLR0sigycHYOV1S7mtjsQJ4gf+HIFPXoWMs6qIGzIRiKZs9GFoEaMRuZhhrYqqJXy8uZYauRxC/VHew7e3YTPAxnI5swG6JxNrKBNjB1EFmIgV0+HA6C8pqqzhXG7BbJJROQIwViMYQ7G2oDQQNn57JyG7kxiCfObrBmS5+BHMuYLkTzMnYDm5WY4lOZZRPKZocxes+aPbuwCFsYohiICLvZsKBAMrDTQ7K/StveU8icTzrOL8JdLpOyWJ49u8Bx9ozw8DY7UYW03hhdxZAOSg2c3jN79rSJs1vSKmfOnpFXNJmynELlvExlAADnaZpLFGEC2wAAAABJRU5ErkJggg==" alt="Valid XHTML 1.1" width="80" height="15"/></a> <a href="http://jigsaw.w3.org/css-validator/check/referer"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAAAPCAMAAABEF7i9AAAB1FBMVEUHQIgIRY0MN4QNRYoSRYsXUpIYVJQeUpUhWpgjUJMjWpgmU5QnXJkuYZ0uYpwwV5YyZJ4zaKM3ZaA5aaI6aqM6a6E8ZqA8Z6BAbaRBbqdCbaVHd61KSkpKcaZQUFBUf69UgbBVVVVXfq9Yg7NZhbJZh7RagrNeXVxeh7RfjLdgYGBiiLZmZmZnZ2doirhpkbt0m8F3m8B3ncJ5lb55ocR+ocSDgX+Do8eEpMqGhoaHp8iIpMeJjnmJpseKqMeOqsqPsdCQrcyVlZWVsM2Zs9CZtNCfu9ahoaGhuNShudSivNSjtMWjvNSmpqWnpqSrw9qvxNqyxdmyxdyzsK6zs7Ozx9y0xt21yN22tra4y+K80eK/v7/AwMDExMTEy9DH2ejK2+jM2ujN3uvP0dLR0NDR3uvS3uvS3+zU4u3V1dXY2dnY4u7Y4+3b5e/d3d3d5u/d5/De3t7f39/h4uLj4uHj6/Ll7PXm7fTn7/Xo7/Tp7/bq7Ozr6unr8ffw8PDw9vvx9fny+P7z8/Pz9vnz9vv3+fv4+vz5+vz6+vr6+/36/P36///7+/77/Pz7/f37/f78/Pz8/f38/f79/f39/f79/f/9/v79///+/v7+/v////3///+tYR2LAAABEUlEQVQ4y2PQoTJg0JlNVYDPQBsyAMTAqaFes8tdsmdPCtA3MDStr3GKKK6myMAprgJ9pcpWs/MlRExYJBvNZLR0sigycHYOV1S7mtjsQJ4gf+HIFPXoWMs6mIEQCsIjwhKoga0qerW8nBm2Gkn8Ut3BvrNnN8HCcDYM2cBIogzs8uFwEJTXVHWuMGa3SC6ZgIgUqCEwdxJr4OxcVm4jNwbxxNkN1mzpM2ajGIjsPGK9PLtZiSk+lVk2oWx2GKP3rNmzC4tQwpDoIIQb2Okh2V+lbe8pZM4nHecX4S6XSVksz55d4Dh7Rnh4m52oQlpvjK5iSAelBk7vmT172sTZLWmVM2fPyCuaTFlOoXJepjIAANlljDGY/l5pAAAAAElFTkSuQmCC" alt="Valid CSS (2.1)" width="80" height="15"/></a><br/>Copyright 2005-2020 <a href="/about/">Timo Bingmann</a> - <a href="/about/impressum.html">Impressum</a></div></footer></body></html>