<?xml version="1.0" encoding="iso-8859-1"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta content="text/html; charset=iso-8859-1" http-equiv="content-type" /><meta name="viewport" content="initial-scale=1"><title>/2009/cryptote/cryptote-0.5.390/libstc/scintilla/src/Editor.cxx - panthema.net</title><link rel="stylesheet" type="text/css" href="/css/base.css" /><link rel="stylesheet" type="text/css" href="/css/fonts.css" /><link rel="alternate" type="application/rss+xml" title="panthema.net Weblog Feed RSS 2.0" href="http://panthema.net/xmlfeed/weblog-rss20.xml" /><link rel="alternate" type="application/atom+xml" title="panthema.net Weblog Feed Atom 1.0" href="http://panthema.net/xmlfeed/weblog-atom10.xml" /><script type="text/javascript" src="/js/base.js"></script><script type="text/javascript">/* <!-- */makeIEHover = function() {var lis = document.getElementById('ptnav').getElementsByTagName('li');for (var i = 0; i < lis.length; i++) {lis[i].onmouseover = function() {this.className += ' sfhover';};lis[i].onmouseout = function() {this.className = this.className.replace(new RegExp(' sfhover\b'), '');};}};if (window.attachEvent) window.attachEvent('onload', makeIEHover);/* --> */</script></head><body style="background-image: url(/img/bgfractal2.jpg)"><div class="pttopbar"><div style="float: right"><ul id="ptnav"><li class="top"><a class="ni" href="/"><i class="icon-book"></i> Weblog</a><ul style="margin-left: -6px; margin-top: 4px" class="nx"><li><a href="/2018/">2018</a></li><li><a href="/2017/">2017</a></li><li><a href="/2016/">2016</a></li><li><a href="/2015/">2015</a></li><li><a href="/2014/">2014</a></li><li><a href="/2013/">2013</a></li><li><a href="/2012/">2012</a></li><li><a href="/2011/">2011</a></li><li><a href="/2010/">2010</a></li><li><a href="/2009/">2009</a></li><li><a href="/2008/">2008</a></li><li><a href="/2007/">2007</a></li><li><a href="/2006/">2006</a></li><li class="nt"><a href="/2005/">2005</a></li><li class="ns"><a href="/xmlfeed/weblog-rss20.xml">RSS Feed</a></li><li class="nt"><a href="/xmlfeed/weblog-atom10.xml">XML Atom</a></li><li class="ns"><a href="/search.html">Search</a></li></ul></li><li class="top"><a class="ni" href="/tags/"><i class="icon-tags"></i> Tags</a><div style="width: 14em; margin-left: -9em; margin-top: 4px"><a style="font-size: 10pt" href="/tags/algebra.html">algebra</a> <a style="font-size: 16pt" href="/tags/c++.html">c++</a> <a style="font-size: 12pt" href="/tags/code-example.html">code-example</a> <a style="font-size: 14pt" href="/tags/code-snippet.html">code-snippet</a> <a style="font-size: 11pt" href="/tags/coding_tricks.html">coding tricks</a> <a style="font-size: 10pt" href="/tags/compsci.html">compsci</a> <a style="font-size: 10pt" href="/tags/compsci_study_thesis.html">compsci study thesis</a> <a style="font-size: 9pt" href="/tags/crypto-speedtest.html">crypto-speedtest</a> <a style="font-size: 10pt" href="/tags/cryptography.html">cryptography</a> <a style="font-size: 9pt" href="/tags/cryptote.html">cryptote</a> <a style="font-size: 9pt" href="/tags/dissertation.html">dissertation</a> <a style="font-size: 12pt" href="/tags/flex-bison-cpp-example.html">flex-bison-cpp-example</a> <a style="font-size: 16pt" href="/tags/frontpage.html">frontpage</a> <a style="font-size: 14pt" href="/tags/fun.html">fun</a> <a style="font-size: 10pt" href="/tags/graphviz.html">graphviz</a> <a style="font-size: 9pt" href="http://www.hmtg.de">hartmetall</a> <a style="font-size: 9pt" href="/tags/helppc.html">helppc</a> <a style="font-size: 9pt" href="/tags/hifi_selbstbau.html">hifi selbstbau</a> <a style="font-size: 10pt" href="/tags/latex.html">latex</a> <a style="font-size: 10pt" href="/tags/librivox.html">librivox</a> <a style="font-size: 10pt" href="/tags/linux.html">linux</a> <a style="font-size: 9pt" href="/tags/massive-sorting.html">massive-sorting</a> <a style="font-size: 11pt" href="/tags/maths.html">maths</a> <a style="font-size: 9pt" href="/tags/music.html">music</a> <a style="font-size: 10pt" href="/tags/netfundamentals.html">netfundamentals</a> <a style="font-size: 11pt" href="/tags/ns-3.html">ns-3</a> <a style="font-size: 10pt" href="/tags/parallel-string-sorting.html">parallel-string-sorting</a> <a style="font-size: 14pt" href="/tags/parsing.html">parsing</a> <a style="font-size: 9pt" href="/tags/qtsqlview.html">qtsqlview</a> <a style="font-size: 14pt" href="/tags/research.html">research</a> <a style="font-size: 11pt" href="/tags/sdios06.html">sdios06</a> <a style="font-size: 9pt" href="/tags/sdlfractal.html">sdlfractal</a> <a style="font-size: 14pt" href="/tags/sorting.html">sorting</a> <a style="font-size: 11pt" href="/tags/sound_of_sorting.html">sound of sorting</a> <a style="font-size: 10pt" href="/tags/stringology.html">stringology</a> <a style="font-size: 16pt" href="/tags/stx-btree.html">stx-btree</a> <a style="font-size: 15pt" href="/tags/stxxl.html">stxxl</a> <a style="font-size: 16pt" href="/tags/talk.html">talk</a> <a style="font-size: 13pt" href="/tags/thrill.html">thrill</a> <a style="font-size: 10pt" href="/tags/tutorium.html">tutorium</a> <a style="font-size: 16pt" href="/tags/university.html">university</a> <a style="font-size: 13pt" href="/tags/utilities.html">utilities</a> <a style="font-size: 10pt" href="/tags/vncrec.html">vncrec</a> <a style="font-size: 9pt" href="/tags/webdesign.html">webdesign</a> </div></li><li class="top"> <a class="ni" href="#"><i class="icon-cubes"></i> Projects</a> <ul style="margin-left: -8em; margin-top: 4px;" class="nx"> <li><a href="/2009/cryptote/">CryptoTE</a></li> <li><a href="/2009/digup/">digup</a></li> <li><a href="/2013/disk-filltest/">disk-filltest</a></li> <li><a href="/2012/1119-eSAIS-Inducing-Suffix-and-LCP-Arrays-in-External-Memory/">eSAIS-LCP</a></li> <li><a href="/2007/flex-bison-cpp-example/">Flex Bison C++ Example</a></li> <li><a href="/2013/malloc_count/">malloc_count</a></li> <li><a href="/2013/parallel-string-sorting/">parallel-string-sorting</a></li> <li><a href="/2013/pmbw/">Parallel Memory Bandwidth</a></li> <li><a href="/2014/sqlplot-tools/">SqlPlotTools</a></li> <li><a href="/2013/sound-of-sorting/">The Sound of Sorting</a></li> <li><a href="/2007/stx-btree/">STX B+ Tree</a></li> <li><a href="/2010/stx-cbtreedb/">STX Constant BTreeDB</a></li> <li><a href="/2010/stx-execpipe/">STX ExecPipe</a></li> <li><a href="/2007/stx-exparser/">STX Expression Parser</a></li> <li><a href="/tags/stxxl.html">STXXL 1.4</a></li> <li class="nt"><a href="/2014/vncrec-rgb/">VNCrec RGB 0.4</a></li> <li class="ns"><a href="/search.html">Search</a></li> </ul></li><li class="top"> <a class="ni" href="#"><i class="icon-graduation-cap"></i> Research</a> <ul style="margin-left: -16em; margin-top: 4px" class="nx"> <li><a href="/2012/1119-eSAIS-Inducing-Suffix-and-LCP-Arrays-in-External-Memory/">eSAIS-LCP - External Memory Suffix Sorting</a></li> <li><a href="/2016/0114-diploma-thesis/">On Bispanning Graphs</a></li> <li><a href="/2013/parallel-string-sorting/">Parallel String Sorting</a></li> <li><a href="/tags/massive-sorting.html">Practical Massively Parallel Sorting</a></li> <li><a href="/tags/stxxl.html">STXXL - External Memory Algorithms</a></li> <li><a href="/tags/thrill.html">Thrill - Distributed Batch Big Data Processing</a></li> <li class="ns"><a href="/search.html">Search</a></li> </ul></li><li class="top"> <a class="ni" href="/about/"><i class="icon-info-circled"></i> About</a> <ul style="margin-left: -6em; margin-top: 4px" class="nx"> <li><a href="/about/">Timo Bingmann</a></li> <li><a href="/about/impressum.html">Impressum</a></li> </ul></li><li class="top"> <a class="ni" href="/subscribe.html"><i class="icon-rss-squared"></i> Subscribe</a></li></ul></div><div style="padding: 6px"><a href="/">panthema</a>  / <a href="/2009/">2009</a> / <a href="/2009/cryptote/">cryptote</a> / <a href="/2009/cryptote/cryptote-0.5.390/">cryptote-0.5.390</a> / <a href="/2009/cryptote/cryptote-0.5.390/libstc/">libstc</a> / <a href="/2009/cryptote/cryptote-0.5.390/libstc/scintilla/">scintilla</a> / <a href="/2009/cryptote/cryptote-0.5.390/libstc/scintilla/src/">src</a> / <a href="/2009/cryptote/cryptote-0.5.390/libstc/scintilla/src/Editor.cxx.html">Editor.cxx</a> (<a href="/2009/cryptote/cryptote-0.5.390/libstc/scintilla/src/Editor.cxx">Download File</a>)</div></div><div class="ptfullwidth"><pre class="codesnippet" style="font-family: monospace"><tt><span class="comment">// Scintilla source code edit control</span>
<span class="comment">/** </span><span class="type">@file</span><span class="comment"> Editor.cxx</span>
<span class="comment"> ** Main code for the edit control.</span>
<span class="comment"> **/</span>
<span class="comment">// Copyright 1998-2004 by Neil Hodgson &lt;neilh@scintilla.org&gt;</span>
<span class="comment">// The License.txt file describes the conditions under which this software may be distributed.</span>

<span class="preproc">#include</span><span class="normal"> </span><span class="string">&lt;stdlib.h&gt;</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">&lt;string.h&gt;</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">&lt;stdio.h&gt;</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">&lt;ctype.h&gt;</span>

<span class="preproc">#include</span><span class="normal"> </span><span class="string">"Platform.h"</span>

<span class="preproc">#include</span><span class="normal"> </span><span class="string">"Scintilla.h"</span>

<span class="preproc">#include</span><span class="normal"> </span><span class="string">"SplitVector.h"</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">"Partitioning.h"</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">"RunStyles.h"</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">"ContractionState.h"</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">"CellBuffer.h"</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">"KeyMap.h"</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">"Indicator.h"</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">"XPM.h"</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">"LineMarker.h"</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">"Style.h"</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">"ViewStyle.h"</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">"CharClassify.h"</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">"Decoration.h"</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">"Document.h"</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">"PositionCache.h"</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">"Editor.h"</span>

<span class="preproc">#ifdef</span><span class="normal"> SCI_NAMESPACE</span>
<span class="keyword">using</span><span class="normal"> </span><span class="keyword">namespace</span><span class="normal"> Scintilla</span><span class="symbol">;</span>
<span class="preproc">#endif</span>

<span class="comment">/*</span>
<span class="comment">	return whether this modification represents an operation that</span>
<span class="comment">	may reasonably be deferred (not done now OR [possibly] at all)</span>
<span class="comment">*/</span>
<span class="keyword">static</span><span class="normal"> </span><span class="type">bool</span><span class="normal"> </span><span class="function">CanDeferToLastStep</span><span class="symbol">(</span><span class="keyword">const</span><span class="normal"> DocModification</span><span class="symbol">&amp;</span><span class="normal"> mh</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">mh</span><span class="symbol">.</span><span class="normal">modificationType </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">SC_MOD_BEFOREINSERT </span><span class="symbol">|</span><span class="normal"> SC_MOD_BEFOREDELETE</span><span class="symbol">))</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span><span class="normal">	</span><span class="comment">// CAN skip</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!(</span><span class="normal">mh</span><span class="symbol">.</span><span class="normal">modificationType </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">SC_PERFORMED_UNDO </span><span class="symbol">|</span><span class="normal"> SC_PERFORMED_REDO</span><span class="symbol">)))</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span><span class="normal">	</span><span class="comment">// MUST do</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">mh</span><span class="symbol">.</span><span class="normal">modificationType </span><span class="symbol">&amp;</span><span class="normal"> SC_MULTISTEPUNDOREDO</span><span class="symbol">)</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span><span class="normal">	</span><span class="comment">// CAN skip</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span><span class="normal">		</span><span class="comment">// PRESUMABLY must do</span>
<span class="cbracket">}</span>

<span class="keyword">static</span><span class="normal"> </span><span class="type">bool</span><span class="normal"> </span><span class="function">CanEliminate</span><span class="symbol">(</span><span class="keyword">const</span><span class="normal"> DocModification</span><span class="symbol">&amp;</span><span class="normal"> mh</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">return</span>
<span class="normal">	    </span><span class="symbol">(</span><span class="normal">mh</span><span class="symbol">.</span><span class="normal">modificationType </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">SC_MOD_BEFOREINSERT </span><span class="symbol">|</span><span class="normal"> SC_MOD_BEFOREDELETE</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="comment">/*</span>
<span class="comment">	return whether this modification represents the FINAL step</span>
<span class="comment">	in a [possibly lengthy] multi-step Undo/Redo sequence</span>
<span class="comment">*/</span>
<span class="keyword">static</span><span class="normal"> </span><span class="type">bool</span><span class="normal"> </span><span class="function">IsLastStep</span><span class="symbol">(</span><span class="keyword">const</span><span class="normal"> DocModification</span><span class="symbol">&amp;</span><span class="normal"> mh</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">return</span>
<span class="normal">	    </span><span class="symbol">(</span><span class="normal">mh</span><span class="symbol">.</span><span class="normal">modificationType </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">SC_PERFORMED_UNDO </span><span class="symbol">|</span><span class="normal"> SC_PERFORMED_REDO</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span>
<span class="normal">	    </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">mh</span><span class="symbol">.</span><span class="normal">modificationType </span><span class="symbol">&amp;</span><span class="normal"> SC_MULTISTEPUNDOREDO</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span>
<span class="normal">	    </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">mh</span><span class="symbol">.</span><span class="normal">modificationType </span><span class="symbol">&amp;</span><span class="normal"> SC_LASTSTEPINUNDOREDO</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span>
<span class="normal">	    </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">mh</span><span class="symbol">.</span><span class="normal">modificationType </span><span class="symbol">&amp;</span><span class="normal"> SC_MULTILINEUNDOREDO</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="normal">Caret</span><span class="symbol">::</span><span class="function">Caret</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">active</span><span class="symbol">(</span><span class="keyword">false</span><span class="symbol">),</span><span class="normal"> </span><span class="function">on</span><span class="symbol">(</span><span class="keyword">false</span><span class="symbol">),</span><span class="normal"> </span><span class="function">period</span><span class="symbol">(</span><span class="number">500</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{}</span>

<span class="normal">Timer</span><span class="symbol">::</span><span class="function">Timer</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">ticking</span><span class="symbol">(</span><span class="keyword">false</span><span class="symbol">),</span><span class="normal"> </span><span class="function">ticksToWait</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">),</span><span class="normal"> </span><span class="function">tickerID</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{}</span>

<span class="normal">Idler</span><span class="symbol">::</span><span class="function">Idler</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">state</span><span class="symbol">(</span><span class="keyword">false</span><span class="symbol">),</span><span class="normal"> </span><span class="function">idlerID</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{}</span>

<span class="keyword">static</span><span class="normal"> </span><span class="keyword">inline</span><span class="normal"> </span><span class="type">bool</span><span class="normal"> </span><span class="function">IsControlCharacter</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> ch</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="comment">// iscntrl returns true for lots of chars &gt; 127 which are displayable</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> ch </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">0</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> ch </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="string">' '</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="normal">Editor</span><span class="symbol">::</span><span class="function">Editor</span><span class="symbol">()</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	ctrlID </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">	stylesValid </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>

<span class="normal">	printMagnification </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">	printColourMode </span><span class="symbol">=</span><span class="normal"> SC_PRINT_NORMAL</span><span class="symbol">;</span>
<span class="normal">	printWrapState </span><span class="symbol">=</span><span class="normal"> eWrapWord</span><span class="symbol">;</span>
<span class="normal">	cursorMode </span><span class="symbol">=</span><span class="normal"> SC_CURSORNORMAL</span><span class="symbol">;</span>
<span class="normal">	controlCharSymbol </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal">	</span><span class="comment">/* Draw the control characters */</span>

<span class="normal">	hasFocus </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="normal">	hideSelection </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="normal">	inOverstrike </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="normal">	errorStatus </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">	mouseDownCaptures </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>

<span class="normal">	bufferedDraw </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>
<span class="normal">	twoPhaseDraw </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>

<span class="normal">	lastClickTime </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">	dwellDelay </span><span class="symbol">=</span><span class="normal"> SC_TIME_FOREVER</span><span class="symbol">;</span>
<span class="normal">	ticksToDwell </span><span class="symbol">=</span><span class="normal"> SC_TIME_FOREVER</span><span class="symbol">;</span>
<span class="normal">	dwelling </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="normal">	ptMouseLast</span><span class="symbol">.</span><span class="normal">x </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">	ptMouseLast</span><span class="symbol">.</span><span class="normal">y </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">	inDragDrop </span><span class="symbol">=</span><span class="normal"> ddNone</span><span class="symbol">;</span>
<span class="normal">	dropWentOutside </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="normal">	posDrag </span><span class="symbol">=</span><span class="normal"> invalidPosition</span><span class="symbol">;</span>
<span class="normal">	posDrop </span><span class="symbol">=</span><span class="normal"> invalidPosition</span><span class="symbol">;</span>
<span class="normal">	selectionType </span><span class="symbol">=</span><span class="normal"> selChar</span><span class="symbol">;</span>

<span class="normal">	lastXChosen </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">	lineAnchor </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">	originalAnchorPos </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">	selType </span><span class="symbol">=</span><span class="normal"> selStream</span><span class="symbol">;</span>
<span class="normal">	moveExtendsSelection </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="normal">	xStartSelect </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">	xEndSelect </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">	primarySelection </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>

<span class="normal">	caretXPolicy </span><span class="symbol">=</span><span class="normal"> CARET_SLOP </span><span class="symbol">|</span><span class="normal"> CARET_EVEN</span><span class="symbol">;</span>
<span class="normal">	caretXSlop </span><span class="symbol">=</span><span class="normal"> </span><span class="number">50</span><span class="symbol">;</span>

<span class="normal">	caretYPolicy </span><span class="symbol">=</span><span class="normal"> CARET_EVEN</span><span class="symbol">;</span>
<span class="normal">	caretYSlop </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">	searchAnchor </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">	xOffset </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">	xCaretMargin </span><span class="symbol">=</span><span class="normal"> </span><span class="number">50</span><span class="symbol">;</span>
<span class="normal">	horizontalScrollBarVisible </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>
<span class="normal">	scrollWidth </span><span class="symbol">=</span><span class="normal"> </span><span class="number">2000</span><span class="symbol">;</span>
<span class="normal">	trackLineWidth </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="normal">	lineWidthMaxSeen </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">	verticalScrollBarVisible </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>
<span class="normal">	endAtLastLine </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>
<span class="normal">	caretSticky </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>

<span class="normal">	pixmapLine </span><span class="symbol">=</span><span class="normal"> Surface</span><span class="symbol">::</span><span class="function">Allocate</span><span class="symbol">();</span>
<span class="normal">	pixmapSelMargin </span><span class="symbol">=</span><span class="normal"> Surface</span><span class="symbol">::</span><span class="function">Allocate</span><span class="symbol">();</span>
<span class="normal">	pixmapSelPattern </span><span class="symbol">=</span><span class="normal"> Surface</span><span class="symbol">::</span><span class="function">Allocate</span><span class="symbol">();</span>
<span class="normal">	pixmapIndentGuide </span><span class="symbol">=</span><span class="normal"> Surface</span><span class="symbol">::</span><span class="function">Allocate</span><span class="symbol">();</span>
<span class="normal">	pixmapIndentGuideHighlight </span><span class="symbol">=</span><span class="normal"> Surface</span><span class="symbol">::</span><span class="function">Allocate</span><span class="symbol">();</span>

<span class="normal">	currentPos </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">	anchor </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">	targetStart </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">	targetEnd </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">	searchFlags </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">	topLine </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">	posTopLine </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">	lengthForEncode </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">;</span>

<span class="normal">	needUpdateUI </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>
<span class="normal">	braces</span><span class="symbol">[</span><span class="number">0</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> invalidPosition</span><span class="symbol">;</span>
<span class="normal">	braces</span><span class="symbol">[</span><span class="number">1</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> invalidPosition</span><span class="symbol">;</span>
<span class="normal">	bracesMatchStyle </span><span class="symbol">=</span><span class="normal"> STYLE_BRACEBAD</span><span class="symbol">;</span>
<span class="normal">	highlightGuideColumn </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">	theEdge </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">	paintState </span><span class="symbol">=</span><span class="normal"> notPainting</span><span class="symbol">;</span>

<span class="normal">	modEventMask </span><span class="symbol">=</span><span class="normal"> SC_MODEVENTMASKALL</span><span class="symbol">;</span>

<span class="normal">	pdoc </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">new</span><span class="normal"> </span><span class="function">Document</span><span class="symbol">();</span>
<span class="normal">	pdoc</span><span class="symbol">-&gt;</span><span class="function">AddRef</span><span class="symbol">();</span>
<span class="normal">	pdoc</span><span class="symbol">-&gt;</span><span class="function">AddWatcher</span><span class="symbol">(</span><span class="keyword">this</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">);</span>

<span class="normal">	recordingMacro </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="normal">	foldFlags </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">	wrapState </span><span class="symbol">=</span><span class="normal"> eWrapNone</span><span class="symbol">;</span>
<span class="normal">	wrapWidth </span><span class="symbol">=</span><span class="normal"> LineLayout</span><span class="symbol">::</span><span class="normal">wrapWidthInfinite</span><span class="symbol">;</span>
<span class="normal">	wrapStart </span><span class="symbol">=</span><span class="normal"> wrapLineLarge</span><span class="symbol">;</span>
<span class="normal">	wrapEnd </span><span class="symbol">=</span><span class="normal"> wrapLineLarge</span><span class="symbol">;</span>
<span class="normal">	wrapVisualFlags </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">	wrapVisualFlagsLocation </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">	wrapVisualStartIndent </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">	wrapIndentMode </span><span class="symbol">=</span><span class="normal"> SC_WRAPINDENT_FIXED</span><span class="symbol">;</span>
<span class="normal">	wrapAddIndent </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">	convertPastes </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>

<span class="normal">	hsStart </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">	hsEnd </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">;</span>

<span class="normal">	llc</span><span class="symbol">.</span><span class="function">SetLevel</span><span class="symbol">(</span><span class="normal">LineLayoutCache</span><span class="symbol">::</span><span class="normal">llcCaret</span><span class="symbol">);</span>
<span class="normal">	posCache</span><span class="symbol">.</span><span class="function">SetSize</span><span class="symbol">(</span><span class="number">0x400</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="normal">Editor</span><span class="symbol">::~</span><span class="function">Editor</span><span class="symbol">()</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	pdoc</span><span class="symbol">-&gt;</span><span class="function">RemoveWatcher</span><span class="symbol">(</span><span class="keyword">this</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">);</span>
<span class="normal">	pdoc</span><span class="symbol">-&gt;</span><span class="function">Release</span><span class="symbol">();</span>
<span class="normal">	pdoc </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">	</span><span class="function">DropGraphics</span><span class="symbol">();</span>
<span class="normal">	</span><span class="keyword">delete</span><span class="normal"> pixmapLine</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">delete</span><span class="normal"> pixmapSelMargin</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">delete</span><span class="normal"> pixmapSelPattern</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">delete</span><span class="normal"> pixmapIndentGuide</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">delete</span><span class="normal"> pixmapIndentGuideHighlight</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">Finalise</span><span class="symbol">()</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="function">SetIdle</span><span class="symbol">(</span><span class="keyword">false</span><span class="symbol">);</span>
<span class="normal">	</span><span class="function">CancelModes</span><span class="symbol">();</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">DropGraphics</span><span class="symbol">()</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	pixmapLine</span><span class="symbol">-&gt;</span><span class="function">Release</span><span class="symbol">();</span>
<span class="normal">	pixmapSelMargin</span><span class="symbol">-&gt;</span><span class="function">Release</span><span class="symbol">();</span>
<span class="normal">	pixmapSelPattern</span><span class="symbol">-&gt;</span><span class="function">Release</span><span class="symbol">();</span>
<span class="normal">	pixmapIndentGuide</span><span class="symbol">-&gt;</span><span class="function">Release</span><span class="symbol">();</span>
<span class="normal">	pixmapIndentGuideHighlight</span><span class="symbol">-&gt;</span><span class="function">Release</span><span class="symbol">();</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">InvalidateStyleData</span><span class="symbol">()</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	stylesValid </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="normal">	</span><span class="function">DropGraphics</span><span class="symbol">();</span>
<span class="normal">	palette</span><span class="symbol">.</span><span class="function">Release</span><span class="symbol">();</span>
<span class="normal">	llc</span><span class="symbol">.</span><span class="function">Invalidate</span><span class="symbol">(</span><span class="normal">LineLayout</span><span class="symbol">::</span><span class="normal">llInvalid</span><span class="symbol">);</span>
<span class="normal">	posCache</span><span class="symbol">.</span><span class="function">Clear</span><span class="symbol">();</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">selType </span><span class="symbol">==</span><span class="normal"> selRectangle</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		xStartSelect </span><span class="symbol">=</span><span class="normal"> </span><span class="function">XFromPosition</span><span class="symbol">(</span><span class="normal">anchor</span><span class="symbol">);</span>
<span class="normal">		xEndSelect </span><span class="symbol">=</span><span class="normal"> </span><span class="function">XFromPosition</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">InvalidateStyleRedraw</span><span class="symbol">()</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="function">NeedWrapping</span><span class="symbol">();</span>
<span class="normal">	</span><span class="function">InvalidateStyleData</span><span class="symbol">();</span>
<span class="normal">	</span><span class="function">Redraw</span><span class="symbol">();</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">RefreshColourPalette</span><span class="symbol">(</span><span class="usertype">Palette</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">pal</span><span class="symbol">,</span><span class="normal"> </span><span class="type">bool</span><span class="normal"> want</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	vs</span><span class="symbol">.</span><span class="function">RefreshColourPalette</span><span class="symbol">(</span><span class="normal">pal</span><span class="symbol">,</span><span class="normal"> want</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">RefreshStyleData</span><span class="symbol">()</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">stylesValid</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		stylesValid </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>
<span class="normal">		</span><span class="usertype">AutoSurface</span><span class="normal"> </span><span class="function">surface</span><span class="symbol">(</span><span class="keyword">this</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">surface</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			vs</span><span class="symbol">.</span><span class="function">Refresh</span><span class="symbol">(*</span><span class="normal">surface</span><span class="symbol">);</span>
<span class="normal">			</span><span class="function">RefreshColourPalette</span><span class="symbol">(</span><span class="normal">palette</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">);</span>
<span class="normal">			palette</span><span class="symbol">.</span><span class="function">Allocate</span><span class="symbol">(</span><span class="normal">wMain</span><span class="symbol">);</span>
<span class="normal">			</span><span class="function">RefreshColourPalette</span><span class="symbol">(</span><span class="normal">palette</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">);</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">wrapIndentMode </span><span class="symbol">==</span><span class="normal"> SC_WRAPINDENT_INDENT</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			wrapAddIndent </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">IndentSize</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">spaceWidth</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">wrapIndentMode </span><span class="symbol">==</span><span class="normal"> SC_WRAPINDENT_SAME</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			wrapAddIndent </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal"> </span><span class="comment">//SC_WRAPINDENT_FIXED</span>
<span class="normal">			wrapAddIndent </span><span class="symbol">=</span><span class="normal"> wrapVisualStartIndent </span><span class="symbol">*</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">aveCharWidth</span><span class="symbol">;</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">wrapVisualFlags </span><span class="symbol">&amp;</span><span class="normal"> SC_WRAPVISUALFLAG_START</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">wrapAddIndent </span><span class="symbol">&lt;=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">))</span>
<span class="normal">				wrapAddIndent </span><span class="symbol">=</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">aveCharWidth</span><span class="symbol">;</span><span class="normal"> </span><span class="comment">// must indent to show start visual</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="function">SetScrollBars</span><span class="symbol">();</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="usertype">PRectangle</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">GetClientRectangle</span><span class="symbol">()</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> wMain</span><span class="symbol">.</span><span class="function">GetClientPosition</span><span class="symbol">();</span>
<span class="cbracket">}</span>

<span class="usertype">PRectangle</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">GetTextRectangle</span><span class="symbol">()</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="usertype">PRectangle</span><span class="normal"> rc </span><span class="symbol">=</span><span class="normal"> </span><span class="function">GetClientRectangle</span><span class="symbol">();</span>
<span class="normal">	rc</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">+=</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">fixedColumnWidth</span><span class="symbol">;</span>
<span class="normal">	rc</span><span class="symbol">.</span><span class="normal">right </span><span class="symbol">-=</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">rightMarginWidth</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> rc</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="type">int</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">LinesOnScreen</span><span class="symbol">()</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="usertype">PRectangle</span><span class="normal"> rcClient </span><span class="symbol">=</span><span class="normal"> </span><span class="function">GetClientRectangle</span><span class="symbol">();</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> htClient </span><span class="symbol">=</span><span class="normal"> rcClient</span><span class="symbol">.</span><span class="normal">bottom </span><span class="symbol">-</span><span class="normal"> rcClient</span><span class="symbol">.</span><span class="normal">top</span><span class="symbol">;</span>
<span class="normal">	</span><span class="comment">//Platform::DebugPrintf("lines on screen = %d\n", htClient / lineHeight + 1);</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> htClient </span><span class="symbol">/</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">lineHeight</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="type">int</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">LinesToScroll</span><span class="symbol">()</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> retVal </span><span class="symbol">=</span><span class="normal"> </span><span class="function">LinesOnScreen</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">retVal </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">else</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> retVal</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="type">int</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">MaxScrollPos</span><span class="symbol">()</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="comment">//Platform::DebugPrintf("Lines %d screen = %d maxScroll = %d\n",</span>
<span class="normal">	</span><span class="comment">//LinesTotal(), LinesOnScreen(), LinesTotal() - LinesOnScreen() + 1);</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> retVal </span><span class="symbol">=</span><span class="normal"> cs</span><span class="symbol">.</span><span class="function">LinesDisplayed</span><span class="symbol">();</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">endAtLastLine</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		retVal </span><span class="symbol">-=</span><span class="normal"> </span><span class="function">LinesOnScreen</span><span class="symbol">();</span>
<span class="normal">	</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		retVal</span><span class="symbol">--;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">retVal </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> retVal</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="keyword">const</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="function">ControlCharacterString</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> ch</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">const</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">reps</span><span class="symbol">[]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="string">"NUL"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"SOH"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"STX"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"ETX"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"EOT"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"ENQ"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"ACK"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"BEL"</span><span class="symbol">,</span>
<span class="normal">		</span><span class="string">"BS"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"HT"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"LF"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"VT"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"FF"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"CR"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"SO"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"SI"</span><span class="symbol">,</span>
<span class="normal">		</span><span class="string">"DLE"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"DC1"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"DC2"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"DC3"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"DC4"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"NAK"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"SYN"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"ETB"</span><span class="symbol">,</span>
<span class="normal">		</span><span class="string">"CAN"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"EM"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"SUB"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"ESC"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"FS"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"GS"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"RS"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"US"</span>
<span class="normal">	</span><span class="cbracket">}</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ch </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="symbol">(</span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="normal">reps</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">/</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="normal">reps</span><span class="symbol">[</span><span class="number">0</span><span class="symbol">])))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> reps</span><span class="symbol">[</span><span class="normal">ch</span><span class="symbol">];</span>
<span class="normal">	</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="string">"BAD"</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="comment">/**</span>
<span class="comment"> * Convenience class to ensure LineLayout objects are always disposed.</span>
<span class="comment"> */</span>
<span class="keyword">class</span><span class="normal"> </span><span class="classname">AutoLineLayout</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="usertype">LineLayoutCache</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">llc</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">LineLayout</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">ll</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">AutoLineLayout</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="keyword">operator</span><span class="symbol">=(</span><span class="keyword">const</span><span class="normal"> AutoLineLayout </span><span class="symbol">&amp;)</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal"> </span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> </span><span class="keyword">this</span><span class="symbol">;</span><span class="normal"> </span><span class="cbracket">}</span>
<span class="keyword">public</span><span class="symbol">:</span>
<span class="normal">	</span><span class="function">AutoLineLayout</span><span class="symbol">(</span><span class="usertype">LineLayoutCache</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">llc_</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">LineLayout</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">ll_</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">:</span><span class="normal"> </span><span class="function">llc</span><span class="symbol">(</span><span class="normal">llc_</span><span class="symbol">),</span><span class="normal"> </span><span class="function">ll</span><span class="symbol">(</span><span class="normal">ll_</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{}</span>
<span class="normal">	</span><span class="symbol">~</span><span class="function">AutoLineLayout</span><span class="symbol">()</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		llc</span><span class="symbol">.</span><span class="function">Dispose</span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">);</span>
<span class="normal">		ll </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="usertype">LineLayout</span><span class="normal"> </span><span class="symbol">*</span><span class="keyword">operator</span><span class="symbol">-&gt;()</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> ll</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">operator</span><span class="normal"> LineLayout </span><span class="symbol">*()</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> ll</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="type">void</span><span class="normal"> </span><span class="function">Set</span><span class="symbol">(</span><span class="usertype">LineLayout</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">ll_</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		llc</span><span class="symbol">.</span><span class="function">Dispose</span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">);</span>
<span class="normal">		ll </span><span class="symbol">=</span><span class="normal"> ll_</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span><span class="symbol">;</span>

<span class="preproc">#ifdef</span><span class="normal"> SCI_NAMESPACE</span>
<span class="keyword">namespace</span><span class="normal"> Scintilla </span><span class="cbracket">{</span>
<span class="preproc">#endif</span>

<span class="comment">/**</span>
<span class="comment"> * Allows to iterate through the lines of a selection.</span>
<span class="comment"> * Althought it can be called for a stream selection, in most cases</span>
<span class="comment"> * it is inefficient and it should be used only for</span>
<span class="comment"> * a rectangular or a line selection.</span>
<span class="comment"> */</span>
<span class="keyword">class</span><span class="normal"> </span><span class="classname">SelectionLineIterator</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="keyword">private</span><span class="symbol">:</span>
<span class="normal">	</span><span class="usertype">Editor</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">ed</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> line</span><span class="symbol">;</span><span class="normal">	</span><span class="comment">///&lt; Current line within the iteration.</span>
<span class="normal">	</span><span class="type">bool</span><span class="normal"> forward</span><span class="symbol">;</span><span class="normal">	</span><span class="comment">///&lt; True if iterating by increasing line number, false otherwise.</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> selStart</span><span class="symbol">,</span><span class="normal"> selEnd</span><span class="symbol">;</span><span class="normal">	</span><span class="comment">///&lt; Positions of the start and end of the selection relative to the start of the document.</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> minX</span><span class="symbol">,</span><span class="normal"> maxX</span><span class="symbol">;</span><span class="normal">	</span><span class="comment">///&lt; Left and right of selection rectangle.</span>

<span class="keyword">public</span><span class="symbol">:</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> lineStart</span><span class="symbol">,</span><span class="normal"> lineEnd</span><span class="symbol">;</span><span class="normal">	</span><span class="comment">///&lt; Line numbers, first and last lines of the selection.</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> startPos</span><span class="symbol">,</span><span class="normal"> endPos</span><span class="symbol">;</span><span class="normal">	</span><span class="comment">///&lt; Positions of the beginning and end of the selection on the current line.</span>

<span class="normal">	</span><span class="type">void</span><span class="normal"> </span><span class="function">Reset</span><span class="symbol">()</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">forward</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			line </span><span class="symbol">=</span><span class="normal"> lineStart</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			line </span><span class="symbol">=</span><span class="normal"> lineEnd</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="function">SelectionLineIterator</span><span class="symbol">(</span><span class="usertype">Editor</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">ed_</span><span class="symbol">,</span><span class="normal"> </span><span class="type">bool</span><span class="normal"> forward_ </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">:</span><span class="normal"> </span><span class="function">line</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">),</span><span class="normal"> </span><span class="function">startPos</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">),</span><span class="normal"> </span><span class="function">endPos</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		ed </span><span class="symbol">=</span><span class="normal"> ed_</span><span class="symbol">;</span>
<span class="normal">		forward </span><span class="symbol">=</span><span class="normal"> forward_</span><span class="symbol">;</span>
<span class="normal">		selStart </span><span class="symbol">=</span><span class="normal"> ed</span><span class="symbol">-&gt;</span><span class="function">SelectionStart</span><span class="symbol">();</span>
<span class="normal">		selEnd </span><span class="symbol">=</span><span class="normal"> ed</span><span class="symbol">-&gt;</span><span class="function">SelectionEnd</span><span class="symbol">();</span>
<span class="normal">		lineStart </span><span class="symbol">=</span><span class="normal"> ed</span><span class="symbol">-&gt;</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">LineFromPosition</span><span class="symbol">(</span><span class="normal">selStart</span><span class="symbol">);</span>
<span class="normal">		lineEnd </span><span class="symbol">=</span><span class="normal"> ed</span><span class="symbol">-&gt;</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">LineFromPosition</span><span class="symbol">(</span><span class="normal">selEnd</span><span class="symbol">);</span>
<span class="normal">		</span><span class="comment">// Left of rectangle</span>
<span class="normal">		minX </span><span class="symbol">=</span><span class="normal"> Platform</span><span class="symbol">::</span><span class="function">Minimum</span><span class="symbol">(</span><span class="normal">ed</span><span class="symbol">-&gt;</span><span class="normal">xStartSelect</span><span class="symbol">,</span><span class="normal"> ed</span><span class="symbol">-&gt;</span><span class="normal">xEndSelect</span><span class="symbol">);</span>
<span class="normal">		</span><span class="comment">// Right of rectangle</span>
<span class="normal">		maxX </span><span class="symbol">=</span><span class="normal"> Platform</span><span class="symbol">::</span><span class="function">Maximum</span><span class="symbol">(</span><span class="normal">ed</span><span class="symbol">-&gt;</span><span class="normal">xStartSelect</span><span class="symbol">,</span><span class="normal"> ed</span><span class="symbol">-&gt;</span><span class="normal">xEndSelect</span><span class="symbol">);</span>
<span class="normal">		</span><span class="function">Reset</span><span class="symbol">();</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="symbol">~</span><span class="function">SelectionLineIterator</span><span class="symbol">()</span><span class="normal"> </span><span class="cbracket">{}</span>

<span class="normal">	</span><span class="type">void</span><span class="normal"> </span><span class="function">SetAt</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> line</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">line </span><span class="symbol">&lt;</span><span class="normal"> lineStart </span><span class="symbol">||</span><span class="normal"> line </span><span class="symbol">&gt;</span><span class="normal"> lineEnd</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			startPos </span><span class="symbol">=</span><span class="normal"> endPos </span><span class="symbol">=</span><span class="normal"> INVALID_POSITION</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ed</span><span class="symbol">-&gt;</span><span class="normal">selType </span><span class="symbol">==</span><span class="normal"> ed</span><span class="symbol">-&gt;</span><span class="normal">selRectangle</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="comment">// Measure line and return character closest to minX</span>
<span class="normal">				startPos </span><span class="symbol">=</span><span class="normal"> ed</span><span class="symbol">-&gt;</span><span class="function">PositionFromLineX</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">,</span><span class="normal"> minX</span><span class="symbol">);</span>
<span class="normal">				</span><span class="comment">// Measure line and return character closest to maxX</span>
<span class="normal">				endPos </span><span class="symbol">=</span><span class="normal"> ed</span><span class="symbol">-&gt;</span><span class="function">PositionFromLineX</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">,</span><span class="normal"> maxX</span><span class="symbol">);</span>
<span class="normal">			</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ed</span><span class="symbol">-&gt;</span><span class="normal">selType </span><span class="symbol">==</span><span class="normal"> ed</span><span class="symbol">-&gt;</span><span class="normal">selLines</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				startPos </span><span class="symbol">=</span><span class="normal"> ed</span><span class="symbol">-&gt;</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">);</span>
<span class="normal">				endPos </span><span class="symbol">=</span><span class="normal"> ed</span><span class="symbol">-&gt;</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">line </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">			</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal">	</span><span class="comment">// Stream selection, here only for completion</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">line </span><span class="symbol">==</span><span class="normal"> lineStart</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					startPos </span><span class="symbol">=</span><span class="normal"> selStart</span><span class="symbol">;</span>
<span class="normal">				</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					startPos </span><span class="symbol">=</span><span class="normal"> ed</span><span class="symbol">-&gt;</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">);</span>
<span class="normal">				</span><span class="cbracket">}</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">line </span><span class="symbol">==</span><span class="normal"> lineEnd</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					endPos </span><span class="symbol">=</span><span class="normal"> selEnd</span><span class="symbol">;</span>
<span class="normal">				</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					endPos </span><span class="symbol">=</span><span class="normal"> ed</span><span class="symbol">-&gt;</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">line </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">				</span><span class="cbracket">}</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="type">bool</span><span class="normal"> </span><span class="function">Iterate</span><span class="symbol">()</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">SetAt</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">forward</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			line</span><span class="symbol">++;</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			line</span><span class="symbol">--;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> startPos </span><span class="symbol">!=</span><span class="normal"> INVALID_POSITION</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span><span class="symbol">;</span>

<span class="preproc">#ifdef</span><span class="normal"> SCI_NAMESPACE</span>
<span class="cbracket">}</span>
<span class="preproc">#endif</span>

<span class="usertype">Point</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">LocationFromPosition</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> pos</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="usertype">Point</span><span class="normal"> pt</span><span class="symbol">;</span>
<span class="normal">	</span><span class="function">RefreshStyleData</span><span class="symbol">();</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pos </span><span class="symbol">==</span><span class="normal"> INVALID_POSITION</span><span class="symbol">)</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> pt</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> line </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineFromPosition</span><span class="symbol">(</span><span class="normal">pos</span><span class="symbol">);</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> lineVisible </span><span class="symbol">=</span><span class="normal"> cs</span><span class="symbol">.</span><span class="function">DisplayFromDoc</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">);</span>
<span class="normal">	</span><span class="comment">//Platform::DebugPrintf("line=%d\n", line);</span>
<span class="normal">	</span><span class="usertype">AutoSurface</span><span class="normal"> </span><span class="function">surface</span><span class="symbol">(</span><span class="keyword">this</span><span class="symbol">);</span>
<span class="normal">	</span><span class="usertype">AutoLineLayout</span><span class="normal"> </span><span class="function">ll</span><span class="symbol">(</span><span class="normal">llc</span><span class="symbol">,</span><span class="normal"> </span><span class="function">RetrieveLineLayout</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">));</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">surface </span><span class="symbol">&amp;&amp;</span><span class="normal"> ll</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="comment">// -1 because of adding in for visible lines in following loop.</span>
<span class="normal">		pt</span><span class="symbol">.</span><span class="normal">y </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lineVisible </span><span class="symbol">-</span><span class="normal"> topLine </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">lineHeight</span><span class="symbol">;</span>
<span class="normal">		pt</span><span class="symbol">.</span><span class="normal">x </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> posLineStart </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">);</span>
<span class="normal">		</span><span class="function">LayoutLine</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">,</span><span class="normal"> surface</span><span class="symbol">,</span><span class="normal"> vs</span><span class="symbol">,</span><span class="normal"> ll</span><span class="symbol">,</span><span class="normal"> wrapWidth</span><span class="symbol">);</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> posInLine </span><span class="symbol">=</span><span class="normal"> pos </span><span class="symbol">-</span><span class="normal"> posLineStart</span><span class="symbol">;</span>
<span class="normal">		</span><span class="comment">// In case of very long line put x at arbitrary large position</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">posInLine </span><span class="symbol">&gt;</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">maxLineLength</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			pt</span><span class="symbol">.</span><span class="normal">x </span><span class="symbol">=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">positions</span><span class="symbol">[</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">maxLineLength</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">positions</span><span class="symbol">[</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">lines</span><span class="symbol">)];</span>
<span class="normal">		</span><span class="cbracket">}</span>

<span class="normal">		</span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="normal"> subLine </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> subLine </span><span class="symbol">&lt;</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">lines</span><span class="symbol">;</span><span class="normal"> subLine</span><span class="symbol">++)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">posInLine </span><span class="symbol">&gt;=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">subLine</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">posInLine </span><span class="symbol">&lt;=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">subLine </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				pt</span><span class="symbol">.</span><span class="normal">x </span><span class="symbol">=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">positions</span><span class="symbol">[</span><span class="normal">posInLine</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">positions</span><span class="symbol">[</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">subLine</span><span class="symbol">)];</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">wrapIndent </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="type">int</span><span class="normal"> lineStart </span><span class="symbol">=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">subLine</span><span class="symbol">);</span>
<span class="normal">					</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lineStart </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal">	</span><span class="comment">// Wrapped</span>
<span class="normal">						pt</span><span class="symbol">.</span><span class="normal">x </span><span class="symbol">+=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">wrapIndent</span><span class="symbol">;</span>
<span class="normal">				</span><span class="cbracket">}</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">posInLine </span><span class="symbol">&gt;=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">subLine</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				pt</span><span class="symbol">.</span><span class="normal">y </span><span class="symbol">+=</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">lineHeight</span><span class="symbol">;</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		pt</span><span class="symbol">.</span><span class="normal">x </span><span class="symbol">+=</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">fixedColumnWidth </span><span class="symbol">-</span><span class="normal"> xOffset</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> pt</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="type">int</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">XFromPosition</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> pos</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="usertype">Point</span><span class="normal"> pt </span><span class="symbol">=</span><span class="normal"> </span><span class="function">LocationFromPosition</span><span class="symbol">(</span><span class="normal">pos</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> pt</span><span class="symbol">.</span><span class="normal">x </span><span class="symbol">-</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">fixedColumnWidth </span><span class="symbol">+</span><span class="normal"> xOffset</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="type">int</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">LineFromLocation</span><span class="symbol">(</span><span class="usertype">Point</span><span class="normal"> pt</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> cs</span><span class="symbol">.</span><span class="function">DocFromDisplay</span><span class="symbol">(</span><span class="normal">pt</span><span class="symbol">.</span><span class="normal">y </span><span class="symbol">/</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">lineHeight </span><span class="symbol">+</span><span class="normal"> topLine</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">SetTopLine</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> topLineNew</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	topLine </span><span class="symbol">=</span><span class="normal"> topLineNew</span><span class="symbol">;</span>
<span class="normal">	posTopLine </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">cs</span><span class="symbol">.</span><span class="function">DocFromDisplay</span><span class="symbol">(</span><span class="normal">topLine</span><span class="symbol">));</span>
<span class="cbracket">}</span>

<span class="type">int</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">PositionFromLocation</span><span class="symbol">(</span><span class="usertype">Point</span><span class="normal"> pt</span><span class="symbol">,</span><span class="normal"> </span><span class="type">bool</span><span class="normal"> canReturnInvalid</span><span class="symbol">,</span><span class="normal"> </span><span class="type">bool</span><span class="normal"> charPosition</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="function">RefreshStyleData</span><span class="symbol">();</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">canReturnInvalid</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="usertype">PRectangle</span><span class="normal"> rcClient </span><span class="symbol">=</span><span class="normal"> </span><span class="function">GetTextRectangle</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">rcClient</span><span class="symbol">.</span><span class="function">Contains</span><span class="symbol">(</span><span class="normal">pt</span><span class="symbol">))</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> INVALID_POSITION</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pt</span><span class="symbol">.</span><span class="normal">x </span><span class="symbol">&lt;</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">fixedColumnWidth</span><span class="symbol">)</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> INVALID_POSITION</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pt</span><span class="symbol">.</span><span class="normal">y </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> INVALID_POSITION</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	pt</span><span class="symbol">.</span><span class="normal">x </span><span class="symbol">=</span><span class="normal"> pt</span><span class="symbol">.</span><span class="normal">x </span><span class="symbol">-</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">fixedColumnWidth </span><span class="symbol">+</span><span class="normal"> xOffset</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> visibleLine </span><span class="symbol">=</span><span class="normal"> pt</span><span class="symbol">.</span><span class="normal">y </span><span class="symbol">/</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">lineHeight </span><span class="symbol">+</span><span class="normal"> topLine</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pt</span><span class="symbol">.</span><span class="normal">y </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal">	</span><span class="comment">// Division rounds towards 0</span>
<span class="normal">		visibleLine </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pt</span><span class="symbol">.</span><span class="normal">y </span><span class="symbol">-</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vs</span><span class="symbol">.</span><span class="normal">lineHeight </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">/</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">lineHeight </span><span class="symbol">+</span><span class="normal"> topLine</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">canReturnInvalid </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">visibleLine </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">))</span>
<span class="normal">		visibleLine </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> lineDoc </span><span class="symbol">=</span><span class="normal"> cs</span><span class="symbol">.</span><span class="function">DocFromDisplay</span><span class="symbol">(</span><span class="normal">visibleLine</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">canReturnInvalid </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lineDoc </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">))</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> INVALID_POSITION</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lineDoc </span><span class="symbol">&gt;=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LinesTotal</span><span class="symbol">())</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> canReturnInvalid </span><span class="symbol">?</span><span class="normal"> INVALID_POSITION </span><span class="symbol">:</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">Length</span><span class="symbol">();</span>
<span class="normal">	</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> posLineStart </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">lineDoc</span><span class="symbol">);</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> retVal </span><span class="symbol">=</span><span class="normal"> canReturnInvalid </span><span class="symbol">?</span><span class="normal"> INVALID_POSITION </span><span class="symbol">:</span><span class="normal"> </span><span class="keyword">static_cast</span><span class="symbol">&lt;</span><span class="type">int</span><span class="symbol">&gt;(</span><span class="normal">posLineStart</span><span class="symbol">);</span>
<span class="normal">	</span><span class="usertype">AutoSurface</span><span class="normal"> </span><span class="function">surface</span><span class="symbol">(</span><span class="keyword">this</span><span class="symbol">);</span>
<span class="normal">	</span><span class="usertype">AutoLineLayout</span><span class="normal"> </span><span class="function">ll</span><span class="symbol">(</span><span class="normal">llc</span><span class="symbol">,</span><span class="normal"> </span><span class="function">RetrieveLineLayout</span><span class="symbol">(</span><span class="normal">lineDoc</span><span class="symbol">));</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">surface </span><span class="symbol">&amp;&amp;</span><span class="normal"> ll</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">LayoutLine</span><span class="symbol">(</span><span class="normal">lineDoc</span><span class="symbol">,</span><span class="normal"> surface</span><span class="symbol">,</span><span class="normal"> vs</span><span class="symbol">,</span><span class="normal"> ll</span><span class="symbol">,</span><span class="normal"> wrapWidth</span><span class="symbol">);</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> lineStartSet </span><span class="symbol">=</span><span class="normal"> cs</span><span class="symbol">.</span><span class="function">DisplayFromDoc</span><span class="symbol">(</span><span class="normal">lineDoc</span><span class="symbol">);</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> subLine </span><span class="symbol">=</span><span class="normal"> visibleLine </span><span class="symbol">-</span><span class="normal"> lineStartSet</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">subLine </span><span class="symbol">&lt;</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">lines</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> lineStart </span><span class="symbol">=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">subLine</span><span class="symbol">);</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> lineEnd </span><span class="symbol">=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="function">LineLastVisible</span><span class="symbol">(</span><span class="normal">subLine</span><span class="symbol">);</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> subLineStart </span><span class="symbol">=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">positions</span><span class="symbol">[</span><span class="normal">lineStart</span><span class="symbol">];</span>

<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">wrapIndent </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lineStart </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal">	</span><span class="comment">// Wrapped</span>
<span class="normal">					pt</span><span class="symbol">.</span><span class="normal">x </span><span class="symbol">-=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">wrapIndent</span><span class="symbol">;</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> i </span><span class="symbol">=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="function">FindBefore</span><span class="symbol">(</span><span class="normal">pt</span><span class="symbol">.</span><span class="normal">x </span><span class="symbol">+</span><span class="normal"> subLineStart</span><span class="symbol">,</span><span class="normal"> lineStart</span><span class="symbol">,</span><span class="normal"> lineEnd</span><span class="symbol">);</span>
<span class="normal">			</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">&lt;</span><span class="normal"> lineEnd</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">charPosition</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">pt</span><span class="symbol">.</span><span class="normal">x </span><span class="symbol">+</span><span class="normal"> subLineStart</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">positions</span><span class="symbol">[</span><span class="normal">i </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">]))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">						</span><span class="keyword">return</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">MovePositionOutsideChar</span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">+</span><span class="normal"> posLineStart</span><span class="symbol">,</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">					</span><span class="cbracket">}</span>
<span class="normal">				</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">pt</span><span class="symbol">.</span><span class="normal">x </span><span class="symbol">+</span><span class="normal"> subLineStart</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">positions</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">positions</span><span class="symbol">[</span><span class="normal">i </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">])</span><span class="normal"> </span><span class="symbol">/</span><span class="normal"> </span><span class="number">2</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">						</span><span class="keyword">return</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">MovePositionOutsideChar</span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">+</span><span class="normal"> posLineStart</span><span class="symbol">,</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">					</span><span class="cbracket">}</span>
<span class="normal">				</span><span class="cbracket">}</span>
<span class="normal">				i</span><span class="symbol">++;</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">canReturnInvalid</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pt</span><span class="symbol">.</span><span class="normal">x </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">positions</span><span class="symbol">[</span><span class="normal">lineEnd</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> subLineStart</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="keyword">return</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">MovePositionOutsideChar</span><span class="symbol">(</span><span class="normal">lineEnd </span><span class="symbol">+</span><span class="normal"> posLineStart</span><span class="symbol">,</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">				</span><span class="cbracket">}</span>
<span class="normal">			</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="keyword">return</span><span class="normal"> lineEnd </span><span class="symbol">+</span><span class="normal"> posLineStart</span><span class="symbol">;</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">canReturnInvalid</span><span class="symbol">)</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">numCharsInLine </span><span class="symbol">+</span><span class="normal"> posLineStart</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> retVal</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="comment">/**</span>
<span class="comment"> * Find the document position corresponding to an x coordinate on a particular document line.</span>
<span class="comment"> * Ensure is between whole characters when document is in multi-byte or UTF-8 mode.</span>
<span class="comment"> */</span>
<span class="type">int</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">PositionFromLineX</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> lineDoc</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> x</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="function">RefreshStyleData</span><span class="symbol">();</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lineDoc </span><span class="symbol">&gt;=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LinesTotal</span><span class="symbol">())</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">Length</span><span class="symbol">();</span>
<span class="normal">	</span><span class="comment">//Platform::DebugPrintf("Position of (%d,%d) line = %d top=%d\n", pt.x, pt.y, line, topLine);</span>
<span class="normal">	</span><span class="usertype">AutoSurface</span><span class="normal"> </span><span class="function">surface</span><span class="symbol">(</span><span class="keyword">this</span><span class="symbol">);</span>
<span class="normal">	</span><span class="usertype">AutoLineLayout</span><span class="normal"> </span><span class="function">ll</span><span class="symbol">(</span><span class="normal">llc</span><span class="symbol">,</span><span class="normal"> </span><span class="function">RetrieveLineLayout</span><span class="symbol">(</span><span class="normal">lineDoc</span><span class="symbol">));</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> retVal </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">surface </span><span class="symbol">&amp;&amp;</span><span class="normal"> ll</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> posLineStart </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">lineDoc</span><span class="symbol">);</span>
<span class="normal">		</span><span class="function">LayoutLine</span><span class="symbol">(</span><span class="normal">lineDoc</span><span class="symbol">,</span><span class="normal"> surface</span><span class="symbol">,</span><span class="normal"> vs</span><span class="symbol">,</span><span class="normal"> ll</span><span class="symbol">,</span><span class="normal"> wrapWidth</span><span class="symbol">);</span>
<span class="normal">		retVal </span><span class="symbol">=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">numCharsInLine </span><span class="symbol">+</span><span class="normal"> posLineStart</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> subLine </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> lineStart </span><span class="symbol">=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">subLine</span><span class="symbol">);</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> lineEnd </span><span class="symbol">=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="function">LineLastVisible</span><span class="symbol">(</span><span class="normal">subLine</span><span class="symbol">);</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> subLineStart </span><span class="symbol">=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">positions</span><span class="symbol">[</span><span class="normal">lineStart</span><span class="symbol">];</span>

<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">wrapIndent </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lineStart </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal">	</span><span class="comment">// Wrapped</span>
<span class="normal">				x </span><span class="symbol">-=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">wrapIndent</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> i </span><span class="symbol">=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="function">FindBefore</span><span class="symbol">(</span><span class="normal">x </span><span class="symbol">+</span><span class="normal"> subLineStart</span><span class="symbol">,</span><span class="normal"> lineStart</span><span class="symbol">,</span><span class="normal"> lineEnd</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">&lt;</span><span class="normal"> lineEnd</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">x </span><span class="symbol">+</span><span class="normal"> subLineStart</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">positions</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">positions</span><span class="symbol">[</span><span class="normal">i </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">])</span><span class="normal"> </span><span class="symbol">/</span><span class="normal"> </span><span class="number">2</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				retVal </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">MovePositionOutsideChar</span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">+</span><span class="normal"> posLineStart</span><span class="symbol">,</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">				</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">			i</span><span class="symbol">++;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> retVal</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="comment">/**</span>
<span class="comment"> * If painting then abandon the painting because a wider redraw is needed.</span>
<span class="comment"> * </span><span class="type">@return</span><span class="comment"> true if calling code should stop drawing.</span>
<span class="comment"> */</span>
<span class="type">bool</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">AbandonPaint</span><span class="symbol">()</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">paintState </span><span class="symbol">==</span><span class="normal"> painting</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">!</span><span class="normal">paintingAllText</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		paintState </span><span class="symbol">=</span><span class="normal"> paintAbandoned</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> paintState </span><span class="symbol">==</span><span class="normal"> paintAbandoned</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">RedrawRect</span><span class="symbol">(</span><span class="usertype">PRectangle</span><span class="normal"> rc</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="comment">//Platform::DebugPrintf("Redraw %0d,%0d - %0d,%0d\n", rc.left, rc.top, rc.right, rc.bottom);</span>

<span class="normal">	</span><span class="comment">// Clip the redraw rectangle into the client area</span>
<span class="normal">	</span><span class="usertype">PRectangle</span><span class="normal"> rcClient </span><span class="symbol">=</span><span class="normal"> </span><span class="function">GetClientRectangle</span><span class="symbol">();</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">rc</span><span class="symbol">.</span><span class="normal">top </span><span class="symbol">&lt;</span><span class="normal"> rcClient</span><span class="symbol">.</span><span class="normal">top</span><span class="symbol">)</span>
<span class="normal">		rc</span><span class="symbol">.</span><span class="normal">top </span><span class="symbol">=</span><span class="normal"> rcClient</span><span class="symbol">.</span><span class="normal">top</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">rc</span><span class="symbol">.</span><span class="normal">bottom </span><span class="symbol">&gt;</span><span class="normal"> rcClient</span><span class="symbol">.</span><span class="normal">bottom</span><span class="symbol">)</span>
<span class="normal">		rc</span><span class="symbol">.</span><span class="normal">bottom </span><span class="symbol">=</span><span class="normal"> rcClient</span><span class="symbol">.</span><span class="normal">bottom</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">rc</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">&lt;</span><span class="normal"> rcClient</span><span class="symbol">.</span><span class="normal">left</span><span class="symbol">)</span>
<span class="normal">		rc</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">=</span><span class="normal"> rcClient</span><span class="symbol">.</span><span class="normal">left</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">rc</span><span class="symbol">.</span><span class="normal">right </span><span class="symbol">&gt;</span><span class="normal"> rcClient</span><span class="symbol">.</span><span class="normal">right</span><span class="symbol">)</span>
<span class="normal">		rc</span><span class="symbol">.</span><span class="normal">right </span><span class="symbol">=</span><span class="normal"> rcClient</span><span class="symbol">.</span><span class="normal">right</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">rc</span><span class="symbol">.</span><span class="normal">bottom </span><span class="symbol">&gt;</span><span class="normal"> rc</span><span class="symbol">.</span><span class="normal">top</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">rc</span><span class="symbol">.</span><span class="normal">right </span><span class="symbol">&gt;</span><span class="normal"> rc</span><span class="symbol">.</span><span class="normal">left</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		wMain</span><span class="symbol">.</span><span class="function">InvalidateRectangle</span><span class="symbol">(</span><span class="normal">rc</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">Redraw</span><span class="symbol">()</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="comment">//Platform::DebugPrintf("Redraw all\n");</span>
<span class="normal">	</span><span class="usertype">PRectangle</span><span class="normal"> rcClient </span><span class="symbol">=</span><span class="normal"> </span><span class="function">GetClientRectangle</span><span class="symbol">();</span>
<span class="normal">	wMain</span><span class="symbol">.</span><span class="function">InvalidateRectangle</span><span class="symbol">(</span><span class="normal">rcClient</span><span class="symbol">);</span>
<span class="normal">	</span><span class="comment">//wMain.InvalidateAll();</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">RedrawSelMargin</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> line</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="function">AbandonPaint</span><span class="symbol">())</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vs</span><span class="symbol">.</span><span class="normal">maskInLine</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="function">Redraw</span><span class="symbol">();</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="usertype">PRectangle</span><span class="normal"> rcSelMargin </span><span class="symbol">=</span><span class="normal"> </span><span class="function">GetClientRectangle</span><span class="symbol">();</span>
<span class="normal">			rcSelMargin</span><span class="symbol">.</span><span class="normal">right </span><span class="symbol">=</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">fixedColumnWidth</span><span class="symbol">;</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">line </span><span class="symbol">!=</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="type">int</span><span class="normal"> position </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">);</span>
<span class="normal">				</span><span class="usertype">PRectangle</span><span class="normal"> rcLine </span><span class="symbol">=</span><span class="normal"> </span><span class="function">RectangleFromRange</span><span class="symbol">(</span><span class="normal">position</span><span class="symbol">,</span><span class="normal"> position</span><span class="symbol">);</span>
<span class="normal">				rcSelMargin</span><span class="symbol">.</span><span class="normal">top </span><span class="symbol">=</span><span class="normal"> rcLine</span><span class="symbol">.</span><span class="normal">top</span><span class="symbol">;</span>
<span class="normal">				rcSelMargin</span><span class="symbol">.</span><span class="normal">bottom </span><span class="symbol">=</span><span class="normal"> rcLine</span><span class="symbol">.</span><span class="normal">bottom</span><span class="symbol">;</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">			wMain</span><span class="symbol">.</span><span class="function">InvalidateRectangle</span><span class="symbol">(</span><span class="normal">rcSelMargin</span><span class="symbol">);</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="usertype">PRectangle</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">RectangleFromRange</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> start</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> end</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> minPos </span><span class="symbol">=</span><span class="normal"> start</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">minPos </span><span class="symbol">&gt;</span><span class="normal"> end</span><span class="symbol">)</span>
<span class="normal">		minPos </span><span class="symbol">=</span><span class="normal"> end</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> maxPos </span><span class="symbol">=</span><span class="normal"> start</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">maxPos </span><span class="symbol">&lt;</span><span class="normal"> end</span><span class="symbol">)</span>
<span class="normal">		maxPos </span><span class="symbol">=</span><span class="normal"> end</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> minLine </span><span class="symbol">=</span><span class="normal"> cs</span><span class="symbol">.</span><span class="function">DisplayFromDoc</span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">LineFromPosition</span><span class="symbol">(</span><span class="normal">minPos</span><span class="symbol">));</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> lineDocMax </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineFromPosition</span><span class="symbol">(</span><span class="normal">maxPos</span><span class="symbol">);</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> maxLine </span><span class="symbol">=</span><span class="normal"> cs</span><span class="symbol">.</span><span class="function">DisplayFromDoc</span><span class="symbol">(</span><span class="normal">lineDocMax</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> cs</span><span class="symbol">.</span><span class="function">GetHeight</span><span class="symbol">(</span><span class="normal">lineDocMax</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">PRectangle</span><span class="normal"> rcClient </span><span class="symbol">=</span><span class="normal"> </span><span class="function">GetTextRectangle</span><span class="symbol">();</span>
<span class="normal">	</span><span class="usertype">PRectangle</span><span class="normal"> rc</span><span class="symbol">;</span>
<span class="normal">	rc</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">=</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">fixedColumnWidth</span><span class="symbol">;</span>
<span class="normal">	rc</span><span class="symbol">.</span><span class="normal">top </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">minLine </span><span class="symbol">-</span><span class="normal"> topLine</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">lineHeight</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">rc</span><span class="symbol">.</span><span class="normal">top </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">		rc</span><span class="symbol">.</span><span class="normal">top </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">	rc</span><span class="symbol">.</span><span class="normal">right </span><span class="symbol">=</span><span class="normal"> rcClient</span><span class="symbol">.</span><span class="normal">right</span><span class="symbol">;</span>
<span class="normal">	rc</span><span class="symbol">.</span><span class="normal">bottom </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">maxLine </span><span class="symbol">-</span><span class="normal"> topLine </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">lineHeight</span><span class="symbol">;</span>
<span class="normal">	</span><span class="comment">// Ensure PRectangle is within 16 bit space</span>
<span class="normal">	rc</span><span class="symbol">.</span><span class="normal">top </span><span class="symbol">=</span><span class="normal"> Platform</span><span class="symbol">::</span><span class="function">Clamp</span><span class="symbol">(</span><span class="normal">rc</span><span class="symbol">.</span><span class="normal">top</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">-</span><span class="number">32000</span><span class="symbol">,</span><span class="normal"> </span><span class="number">32000</span><span class="symbol">);</span>
<span class="normal">	rc</span><span class="symbol">.</span><span class="normal">bottom </span><span class="symbol">=</span><span class="normal"> Platform</span><span class="symbol">::</span><span class="function">Clamp</span><span class="symbol">(</span><span class="normal">rc</span><span class="symbol">.</span><span class="normal">bottom</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">-</span><span class="number">32000</span><span class="symbol">,</span><span class="normal"> </span><span class="number">32000</span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">return</span><span class="normal"> rc</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">InvalidateRange</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> start</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> end</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="function">RedrawRect</span><span class="symbol">(</span><span class="function">RectangleFromRange</span><span class="symbol">(</span><span class="normal">start</span><span class="symbol">,</span><span class="normal"> end</span><span class="symbol">));</span>
<span class="cbracket">}</span>

<span class="type">int</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">CurrentPosition</span><span class="symbol">()</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> currentPos</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="type">bool</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">SelectionEmpty</span><span class="symbol">()</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> anchor </span><span class="symbol">==</span><span class="normal"> currentPos</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="type">int</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">SelectionStart</span><span class="symbol">()</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> Platform</span><span class="symbol">::</span><span class="function">Minimum</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">,</span><span class="normal"> anchor</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="type">int</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">SelectionEnd</span><span class="symbol">()</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> Platform</span><span class="symbol">::</span><span class="function">Maximum</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">,</span><span class="normal"> anchor</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">SetRectangularRange</span><span class="symbol">()</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">selType </span><span class="symbol">==</span><span class="normal"> selRectangle</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		xStartSelect </span><span class="symbol">=</span><span class="normal"> </span><span class="function">XFromPosition</span><span class="symbol">(</span><span class="normal">anchor</span><span class="symbol">);</span>
<span class="normal">		xEndSelect </span><span class="symbol">=</span><span class="normal"> </span><span class="function">XFromPosition</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">InvalidateSelection</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> currentPos_</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> anchor_</span><span class="symbol">,</span><span class="normal"> </span><span class="type">bool</span><span class="normal"> invalidateWholeSelection</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">anchor </span><span class="symbol">!=</span><span class="normal"> anchor_ </span><span class="symbol">||</span><span class="normal"> selType </span><span class="symbol">==</span><span class="normal"> selRectangle</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		invalidateWholeSelection </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> firstAffected </span><span class="symbol">=</span><span class="normal"> currentPos</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">invalidateWholeSelection</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">firstAffected </span><span class="symbol">&gt;</span><span class="normal"> anchor</span><span class="symbol">)</span>
<span class="normal">			firstAffected </span><span class="symbol">=</span><span class="normal"> anchor</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">firstAffected </span><span class="symbol">&gt;</span><span class="normal"> anchor_</span><span class="symbol">)</span>
<span class="normal">			firstAffected </span><span class="symbol">=</span><span class="normal"> anchor_</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">firstAffected </span><span class="symbol">&gt;</span><span class="normal"> currentPos_</span><span class="symbol">)</span>
<span class="normal">		firstAffected </span><span class="symbol">=</span><span class="normal"> currentPos_</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> lastAffected </span><span class="symbol">=</span><span class="normal"> currentPos</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">invalidateWholeSelection</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lastAffected </span><span class="symbol">&lt;</span><span class="normal"> anchor</span><span class="symbol">)</span>
<span class="normal">			lastAffected </span><span class="symbol">=</span><span class="normal"> anchor</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lastAffected </span><span class="symbol">&lt;</span><span class="normal"> anchor_</span><span class="symbol">)</span>
<span class="normal">			lastAffected </span><span class="symbol">=</span><span class="normal"> anchor_</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lastAffected </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">currentPos_ </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">))</span><span class="normal">	</span><span class="comment">// +1 ensures caret repainted</span>
<span class="normal">		lastAffected </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">currentPos_ </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">	needUpdateUI </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>
<span class="normal">	</span><span class="function">InvalidateRange</span><span class="symbol">(</span><span class="normal">firstAffected</span><span class="symbol">,</span><span class="normal"> lastAffected</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">SetSelection</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> currentPos_</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> anchor_</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	currentPos_ </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">ClampPositionIntoDocument</span><span class="symbol">(</span><span class="normal">currentPos_</span><span class="symbol">);</span>
<span class="normal">	anchor_ </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">ClampPositionIntoDocument</span><span class="symbol">(</span><span class="normal">anchor_</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">currentPos </span><span class="symbol">!=</span><span class="normal"> currentPos_</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">anchor </span><span class="symbol">!=</span><span class="normal"> anchor_</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">InvalidateSelection</span><span class="symbol">(</span><span class="normal">currentPos_</span><span class="symbol">,</span><span class="normal"> anchor_</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">);</span>
<span class="normal">		currentPos </span><span class="symbol">=</span><span class="normal"> currentPos_</span><span class="symbol">;</span>
<span class="normal">		anchor </span><span class="symbol">=</span><span class="normal"> anchor_</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="function">SetRectangularRange</span><span class="symbol">();</span>
<span class="normal">	</span><span class="function">ClaimSelection</span><span class="symbol">();</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">SetSelection</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> currentPos_</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	currentPos_ </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">ClampPositionIntoDocument</span><span class="symbol">(</span><span class="normal">currentPos_</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">currentPos </span><span class="symbol">!=</span><span class="normal"> currentPos_</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">InvalidateSelection</span><span class="symbol">(</span><span class="normal">currentPos_</span><span class="symbol">,</span><span class="normal"> anchor</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">);</span>
<span class="normal">		currentPos </span><span class="symbol">=</span><span class="normal"> currentPos_</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="function">SetRectangularRange</span><span class="symbol">();</span>
<span class="normal">	</span><span class="function">ClaimSelection</span><span class="symbol">();</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">SetEmptySelection</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> currentPos_</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	selType </span><span class="symbol">=</span><span class="normal"> selStream</span><span class="symbol">;</span>
<span class="normal">	moveExtendsSelection </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="normal">	</span><span class="function">SetSelection</span><span class="symbol">(</span><span class="normal">currentPos_</span><span class="symbol">,</span><span class="normal"> currentPos_</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="type">bool</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">RangeContainsProtected</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> start</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> end</span><span class="symbol">)</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vs</span><span class="symbol">.</span><span class="function">ProtectionActive</span><span class="symbol">())</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">start </span><span class="symbol">&gt;</span><span class="normal"> end</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> t </span><span class="symbol">=</span><span class="normal"> start</span><span class="symbol">;</span>
<span class="normal">			start </span><span class="symbol">=</span><span class="normal"> end</span><span class="symbol">;</span>
<span class="normal">			end </span><span class="symbol">=</span><span class="normal"> t</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> mask </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="normal">stylingBitsMask</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="normal"> pos </span><span class="symbol">=</span><span class="normal"> start</span><span class="symbol">;</span><span class="normal"> pos </span><span class="symbol">&lt;</span><span class="normal"> end</span><span class="symbol">;</span><span class="normal"> pos</span><span class="symbol">++)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vs</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">StyleAt</span><span class="symbol">(</span><span class="normal">pos</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> mask</span><span class="symbol">].</span><span class="function">IsProtected</span><span class="symbol">())</span>
<span class="normal">				</span><span class="keyword">return</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="type">bool</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">SelectionContainsProtected</span><span class="symbol">()</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="comment">// DONE, but untested...: make support rectangular selection</span>
<span class="normal">	</span><span class="type">bool</span><span class="normal"> scp </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">selType </span><span class="symbol">==</span><span class="normal"> selStream</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		scp </span><span class="symbol">=</span><span class="normal"> </span><span class="function">RangeContainsProtected</span><span class="symbol">(</span><span class="normal">anchor</span><span class="symbol">,</span><span class="normal"> currentPos</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="usertype">SelectionLineIterator</span><span class="normal"> </span><span class="function">lineIterator</span><span class="symbol">(</span><span class="keyword">this</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lineIterator</span><span class="symbol">.</span><span class="function">Iterate</span><span class="symbol">())</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">RangeContainsProtected</span><span class="symbol">(</span><span class="normal">lineIterator</span><span class="symbol">.</span><span class="normal">startPos</span><span class="symbol">,</span><span class="normal"> lineIterator</span><span class="symbol">.</span><span class="normal">endPos</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				scp </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>
<span class="normal">				</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> scp</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="comment">/**</span>
<span class="comment"> * Asks document to find a good position and then moves out of any invisible positions.</span>
<span class="comment"> */</span>
<span class="type">int</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">MovePositionOutsideChar</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> pos</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> moveDir</span><span class="symbol">,</span><span class="normal"> </span><span class="type">bool</span><span class="normal"> checkLineEnd</span><span class="symbol">)</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	pos </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">MovePositionOutsideChar</span><span class="symbol">(</span><span class="normal">pos</span><span class="symbol">,</span><span class="normal"> moveDir</span><span class="symbol">,</span><span class="normal"> checkLineEnd</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vs</span><span class="symbol">.</span><span class="function">ProtectionActive</span><span class="symbol">())</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> mask </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="normal">stylingBitsMask</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">moveDir </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">pos </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">StyleAt</span><span class="symbol">(</span><span class="normal">pos </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> mask</span><span class="symbol">].</span><span class="function">IsProtected</span><span class="symbol">())</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">pos </span><span class="symbol">&lt;</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">Length</span><span class="symbol">())</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span>
<span class="normal">				        </span><span class="symbol">(</span><span class="normal">vs</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">StyleAt</span><span class="symbol">(</span><span class="normal">pos</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> mask</span><span class="symbol">].</span><span class="function">IsProtected</span><span class="symbol">()))</span>
<span class="normal">					pos</span><span class="symbol">++;</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">moveDir </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vs</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">StyleAt</span><span class="symbol">(</span><span class="normal">pos</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> mask</span><span class="symbol">].</span><span class="function">IsProtected</span><span class="symbol">())</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">pos </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span>
<span class="normal">				        </span><span class="symbol">(</span><span class="normal">vs</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">StyleAt</span><span class="symbol">(</span><span class="normal">pos </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> mask</span><span class="symbol">].</span><span class="function">IsProtected</span><span class="symbol">()))</span>
<span class="normal">					pos</span><span class="symbol">--;</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> pos</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="type">int</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">MovePositionTo</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> newPos</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">selTypes</span><span class="normal"> sel</span><span class="symbol">,</span><span class="normal"> </span><span class="type">bool</span><span class="normal"> ensureVisible</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> delta </span><span class="symbol">=</span><span class="normal"> newPos </span><span class="symbol">-</span><span class="normal"> currentPos</span><span class="symbol">;</span>
<span class="normal">	newPos </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">ClampPositionIntoDocument</span><span class="symbol">(</span><span class="normal">newPos</span><span class="symbol">);</span>
<span class="normal">	newPos </span><span class="symbol">=</span><span class="normal"> </span><span class="function">MovePositionOutsideChar</span><span class="symbol">(</span><span class="normal">newPos</span><span class="symbol">,</span><span class="normal"> delta</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">sel </span><span class="symbol">!=</span><span class="normal"> noSel</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		selType </span><span class="symbol">=</span><span class="normal"> sel</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">sel </span><span class="symbol">!=</span><span class="normal"> noSel </span><span class="symbol">||</span><span class="normal"> moveExtendsSelection</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">SetSelection</span><span class="symbol">(</span><span class="normal">newPos</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">SetEmptySelection</span><span class="symbol">(</span><span class="normal">newPos</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="function">ShowCaretAtCurrentPosition</span><span class="symbol">();</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ensureVisible</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">EnsureCaretVisible</span><span class="symbol">();</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="type">int</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">MovePositionSoVisible</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> pos</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> moveDir</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	pos </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">ClampPositionIntoDocument</span><span class="symbol">(</span><span class="normal">pos</span><span class="symbol">);</span>
<span class="normal">	pos </span><span class="symbol">=</span><span class="normal"> </span><span class="function">MovePositionOutsideChar</span><span class="symbol">(</span><span class="normal">pos</span><span class="symbol">,</span><span class="normal"> moveDir</span><span class="symbol">);</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> lineDoc </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineFromPosition</span><span class="symbol">(</span><span class="normal">pos</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">cs</span><span class="symbol">.</span><span class="function">GetVisible</span><span class="symbol">(</span><span class="normal">lineDoc</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> pos</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> lineDisplay </span><span class="symbol">=</span><span class="normal"> cs</span><span class="symbol">.</span><span class="function">DisplayFromDoc</span><span class="symbol">(</span><span class="normal">lineDoc</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">moveDir </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="comment">// lineDisplay is already line before fold as lines in fold use display line of line after fold</span>
<span class="normal">			lineDisplay </span><span class="symbol">=</span><span class="normal"> Platform</span><span class="symbol">::</span><span class="function">Clamp</span><span class="symbol">(</span><span class="normal">lineDisplay</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> cs</span><span class="symbol">.</span><span class="function">LinesDisplayed</span><span class="symbol">());</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">cs</span><span class="symbol">.</span><span class="function">DocFromDisplay</span><span class="symbol">(</span><span class="normal">lineDisplay</span><span class="symbol">));</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			lineDisplay </span><span class="symbol">=</span><span class="normal"> Platform</span><span class="symbol">::</span><span class="function">Clamp</span><span class="symbol">(</span><span class="normal">lineDisplay </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> cs</span><span class="symbol">.</span><span class="function">LinesDisplayed</span><span class="symbol">());</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineEnd</span><span class="symbol">(</span><span class="normal">cs</span><span class="symbol">.</span><span class="function">DocFromDisplay</span><span class="symbol">(</span><span class="normal">lineDisplay</span><span class="symbol">));</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="comment">/**</span>
<span class="comment"> * Choose the x position that the caret will try to stick to</span>
<span class="comment"> * as it moves up and down.</span>
<span class="comment"> */</span>
<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">SetLastXChosen</span><span class="symbol">()</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="usertype">Point</span><span class="normal"> pt </span><span class="symbol">=</span><span class="normal"> </span><span class="function">LocationFromPosition</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">);</span>
<span class="normal">	lastXChosen </span><span class="symbol">=</span><span class="normal"> pt</span><span class="symbol">.</span><span class="normal">x</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">ScrollTo</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> line</span><span class="symbol">,</span><span class="normal"> </span><span class="type">bool</span><span class="normal"> moveThumb</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> topLineNew </span><span class="symbol">=</span><span class="normal"> Platform</span><span class="symbol">::</span><span class="function">Clamp</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="function">MaxScrollPos</span><span class="symbol">());</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">topLineNew </span><span class="symbol">!=</span><span class="normal"> topLine</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="comment">// Try to optimise small scrolls</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> linesToMove </span><span class="symbol">=</span><span class="normal"> topLine </span><span class="symbol">-</span><span class="normal"> topLineNew</span><span class="symbol">;</span>
<span class="normal">		</span><span class="function">SetTopLine</span><span class="symbol">(</span><span class="normal">topLineNew</span><span class="symbol">);</span>
<span class="normal">		</span><span class="function">ShowCaretAtCurrentPosition</span><span class="symbol">();</span>
<span class="normal">		</span><span class="comment">// Perform redraw rather than scroll if many lines would be redrawn anyway.</span>
<span class="preproc">#ifndef</span><span class="normal"> UNDER_CE</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="function">abs</span><span class="symbol">(</span><span class="normal">linesToMove</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&lt;=</span><span class="normal"> </span><span class="number">10</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">paintState </span><span class="symbol">==</span><span class="normal"> notPainting</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="function">ScrollText</span><span class="symbol">(</span><span class="normal">linesToMove</span><span class="symbol">);</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="function">Redraw</span><span class="symbol">();</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="preproc">#else</span>
<span class="normal">		</span><span class="function">Redraw</span><span class="symbol">();</span>
<span class="preproc">#endif</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">moveThumb</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="function">SetVerticalScrollPos</span><span class="symbol">();</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">ScrollText</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> </span><span class="comment">/* linesToMove */</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="comment">//Platform::DebugPrintf("Editor::ScrollText %d\n", linesToMove);</span>
<span class="normal">	</span><span class="function">Redraw</span><span class="symbol">();</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">HorizontalScrollTo</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> xPos</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="comment">//Platform::DebugPrintf("HorizontalScroll %d\n", xPos);</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">xPos </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">		xPos </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">wrapState </span><span class="symbol">==</span><span class="normal"> eWrapNone</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">xOffset </span><span class="symbol">!=</span><span class="normal"> xPos</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		xOffset </span><span class="symbol">=</span><span class="normal"> xPos</span><span class="symbol">;</span>
<span class="normal">		</span><span class="function">SetHorizontalScrollPos</span><span class="symbol">();</span>
<span class="normal">		</span><span class="function">RedrawRect</span><span class="symbol">(</span><span class="function">GetClientRectangle</span><span class="symbol">());</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">MoveCaretInsideView</span><span class="symbol">(</span><span class="type">bool</span><span class="normal"> ensureVisible</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="usertype">PRectangle</span><span class="normal"> rcClient </span><span class="symbol">=</span><span class="normal"> </span><span class="function">GetTextRectangle</span><span class="symbol">();</span>
<span class="normal">	</span><span class="usertype">Point</span><span class="normal"> pt </span><span class="symbol">=</span><span class="normal"> </span><span class="function">LocationFromPosition</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pt</span><span class="symbol">.</span><span class="normal">y </span><span class="symbol">&lt;</span><span class="normal"> rcClient</span><span class="symbol">.</span><span class="normal">top</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">MovePositionTo</span><span class="symbol">(</span><span class="function">PositionFromLocation</span><span class="symbol">(</span>
<span class="normal">		            </span><span class="function">Point</span><span class="symbol">(</span><span class="normal">lastXChosen</span><span class="symbol">,</span><span class="normal"> rcClient</span><span class="symbol">.</span><span class="normal">top</span><span class="symbol">)),</span>
<span class="normal">		        noSel</span><span class="symbol">,</span><span class="normal"> ensureVisible</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">pt</span><span class="symbol">.</span><span class="normal">y </span><span class="symbol">+</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">lineHeight </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;</span><span class="normal"> rcClient</span><span class="symbol">.</span><span class="normal">bottom</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> yOfLastLineFullyDisplayed </span><span class="symbol">=</span><span class="normal"> rcClient</span><span class="symbol">.</span><span class="normal">top </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="function">LinesOnScreen</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">lineHeight</span><span class="symbol">;</span>
<span class="normal">		</span><span class="function">MovePositionTo</span><span class="symbol">(</span><span class="function">PositionFromLocation</span><span class="symbol">(</span>
<span class="normal">		            </span><span class="function">Point</span><span class="symbol">(</span><span class="normal">lastXChosen</span><span class="symbol">,</span><span class="normal"> rcClient</span><span class="symbol">.</span><span class="normal">top </span><span class="symbol">+</span><span class="normal"> yOfLastLineFullyDisplayed</span><span class="symbol">)),</span>
<span class="normal">		        noSel</span><span class="symbol">,</span><span class="normal"> ensureVisible</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="type">int</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">DisplayFromPosition</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> pos</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> lineDoc </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineFromPosition</span><span class="symbol">(</span><span class="normal">pos</span><span class="symbol">);</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> lineDisplay </span><span class="symbol">=</span><span class="normal"> cs</span><span class="symbol">.</span><span class="function">DisplayFromDoc</span><span class="symbol">(</span><span class="normal">lineDoc</span><span class="symbol">);</span>
<span class="normal">	</span><span class="usertype">AutoSurface</span><span class="normal"> </span><span class="function">surface</span><span class="symbol">(</span><span class="keyword">this</span><span class="symbol">);</span>
<span class="normal">	</span><span class="usertype">AutoLineLayout</span><span class="normal"> </span><span class="function">ll</span><span class="symbol">(</span><span class="normal">llc</span><span class="symbol">,</span><span class="normal"> </span><span class="function">RetrieveLineLayout</span><span class="symbol">(</span><span class="normal">lineDoc</span><span class="symbol">));</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">surface </span><span class="symbol">&amp;&amp;</span><span class="normal"> ll</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">LayoutLine</span><span class="symbol">(</span><span class="normal">lineDoc</span><span class="symbol">,</span><span class="normal"> surface</span><span class="symbol">,</span><span class="normal"> vs</span><span class="symbol">,</span><span class="normal"> ll</span><span class="symbol">,</span><span class="normal"> wrapWidth</span><span class="symbol">);</span>
<span class="normal">		</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> posLineStart </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">lineDoc</span><span class="symbol">);</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> posInLine </span><span class="symbol">=</span><span class="normal"> pos </span><span class="symbol">-</span><span class="normal"> posLineStart</span><span class="symbol">;</span>
<span class="normal">		lineDisplay</span><span class="symbol">--;</span><span class="normal"> </span><span class="comment">// To make up for first increment ahead.</span>
<span class="normal">		</span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="normal"> subLine </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> subLine </span><span class="symbol">&lt;</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">lines</span><span class="symbol">;</span><span class="normal"> subLine</span><span class="symbol">++)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">posInLine </span><span class="symbol">&gt;=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">subLine</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				lineDisplay</span><span class="symbol">++;</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> lineDisplay</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="comment">/**</span>
<span class="comment"> * Ensure the caret is reasonably visible in context.</span>
<span class="comment"> *</span>
<span class="comment">Caret policy in SciTE</span>

<span class="comment">If slop is set, we can define a slop value.</span>
<span class="comment">This value defines an unwanted zone (UZ) where the caret is... unwanted.</span>
<span class="comment">This zone is defined as a number of pixels near the vertical margins,</span>
<span class="comment">and as a number of lines near the horizontal margins.</span>
<span class="comment">By keeping the caret away from the edges, it is seen within its context,</span>
<span class="comment">so it is likely that the identifier that the caret is on can be completely seen,</span>
<span class="comment">and that the current line is seen with some of the lines following it which are</span>
<span class="comment">often dependent on that line.</span>

<span class="comment">If strict is set, the policy is enforced... strictly.</span>
<span class="comment">The caret is centred on the display if slop is not set,</span>
<span class="comment">and cannot go in the UZ if slop is set.</span>

<span class="comment">If jumps is set, the display is moved more energetically</span>
<span class="comment">so the caret can move in the same direction longer before the policy is applied again.</span>
<span class="comment">'3UZ' notation is used to indicate three time the size of the UZ as a distance to the margin.</span>

<span class="comment">If even is not set, instead of having symmetrical UZs,</span>
<span class="comment">the left and bottom UZs are extended up to right and top UZs respectively.</span>
<span class="comment">This way, we favour the displaying of useful information: the begining of lines,</span>
<span class="comment">where most code reside, and the lines after the caret, eg. the body of a function.</span>

<span class="comment">     |        |       |      |                                            |</span>
<span class="comment">slop | strict | jumps | even | Caret can go to the margin                 | When reaching limit (caret going out of</span>
<span class="comment">     |        |       |      |                                            | visibility or going into the UZ) display is...</span>
<span class="comment">-----+--------+-------+------+--------------------------------------------+--------------------------------------------------------------</span>
<span class="comment">  0  |   0    |   0   |   0  | Yes                                        | moved to put caret on top/on right</span>
<span class="comment">  0  |   0    |   0   |   1  | Yes                                        | moved by one position</span>
<span class="comment">  0  |   0    |   1   |   0  | Yes                                        | moved to put caret on top/on right</span>
<span class="comment">  0  |   0    |   1   |   1  | Yes                                        | centred on the caret</span>
<span class="comment">  0  |   1    |   -   |   0  | Caret is always on top/on right of display | -</span>
<span class="comment">  0  |   1    |   -   |   1  | No, caret is always centred                | -</span>
<span class="comment">  1  |   0    |   0   |   0  | Yes                                        | moved to put caret out of the asymmetrical UZ</span>
<span class="comment">  1  |   0    |   0   |   1  | Yes                                        | moved to put caret out of the UZ</span>
<span class="comment">  1  |   0    |   1   |   0  | Yes                                        | moved to put caret at 3UZ of the top or right margin</span>
<span class="comment">  1  |   0    |   1   |   1  | Yes                                        | moved to put caret at 3UZ of the margin</span>
<span class="comment">  1  |   1    |   -   |   0  | Caret is always at UZ of top/right margin  | -</span>
<span class="comment">  1  |   1    |   0   |   1  | No, kept out of UZ                         | moved by one position</span>
<span class="comment">  1  |   1    |   1   |   1  | No, kept out of UZ                         | moved to put caret at 3UZ of the margin</span>
<span class="comment">*/</span>
<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">EnsureCaretVisible</span><span class="symbol">(</span><span class="type">bool</span><span class="normal"> useMargin</span><span class="symbol">,</span><span class="normal"> </span><span class="type">bool</span><span class="normal"> vert</span><span class="symbol">,</span><span class="normal"> </span><span class="type">bool</span><span class="normal"> horiz</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="comment">//Platform::DebugPrintf("EnsureCaretVisible %d %s\n", xOffset, useMargin ? " margin" : " ");</span>
<span class="normal">	</span><span class="usertype">PRectangle</span><span class="normal"> rcClient </span><span class="symbol">=</span><span class="normal"> </span><span class="function">GetTextRectangle</span><span class="symbol">();</span>
<span class="normal">	</span><span class="comment">//int rcClientFullWidth = rcClient.Width();</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> posCaret </span><span class="symbol">=</span><span class="normal"> currentPos</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">posDrag </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		posCaret </span><span class="symbol">=</span><span class="normal"> posDrag</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="usertype">Point</span><span class="normal"> pt </span><span class="symbol">=</span><span class="normal"> </span><span class="function">LocationFromPosition</span><span class="symbol">(</span><span class="normal">posCaret</span><span class="symbol">);</span>
<span class="normal">	</span><span class="usertype">Point</span><span class="normal"> ptBottomCaret </span><span class="symbol">=</span><span class="normal"> pt</span><span class="symbol">;</span>
<span class="normal">	ptBottomCaret</span><span class="symbol">.</span><span class="normal">y </span><span class="symbol">+=</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">lineHeight </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> lineCaret </span><span class="symbol">=</span><span class="normal"> </span><span class="function">DisplayFromPosition</span><span class="symbol">(</span><span class="normal">posCaret</span><span class="symbol">);</span>
<span class="normal">	</span><span class="type">bool</span><span class="normal"> bSlop</span><span class="symbol">,</span><span class="normal"> bStrict</span><span class="symbol">,</span><span class="normal"> bJump</span><span class="symbol">,</span><span class="normal"> bEven</span><span class="symbol">;</span>

<span class="normal">	</span><span class="comment">// Vertical positioning</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vert </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pt</span><span class="symbol">.</span><span class="normal">y </span><span class="symbol">&lt;</span><span class="normal"> rcClient</span><span class="symbol">.</span><span class="normal">top </span><span class="symbol">||</span><span class="normal"> ptBottomCaret</span><span class="symbol">.</span><span class="normal">y </span><span class="symbol">&gt;</span><span class="normal"> rcClient</span><span class="symbol">.</span><span class="normal">bottom </span><span class="symbol">||</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">caretYPolicy </span><span class="symbol">&amp;</span><span class="normal"> CARET_STRICT</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> linesOnScreen </span><span class="symbol">=</span><span class="normal"> </span><span class="function">LinesOnScreen</span><span class="symbol">();</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> halfScreen </span><span class="symbol">=</span><span class="normal"> Platform</span><span class="symbol">::</span><span class="function">Maximum</span><span class="symbol">(</span><span class="normal">linesOnScreen </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">/</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> newTopLine </span><span class="symbol">=</span><span class="normal"> topLine</span><span class="symbol">;</span>
<span class="normal">		bSlop </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">caretYPolicy </span><span class="symbol">&amp;</span><span class="normal"> CARET_SLOP</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		bStrict </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">caretYPolicy </span><span class="symbol">&amp;</span><span class="normal"> CARET_STRICT</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		bJump </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">caretYPolicy </span><span class="symbol">&amp;</span><span class="normal"> CARET_JUMPS</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		bEven </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">caretYPolicy </span><span class="symbol">&amp;</span><span class="normal"> CARET_EVEN</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">		</span><span class="comment">// It should be possible to scroll the window to show the caret,</span>
<span class="normal">		</span><span class="comment">// but this fails to remove the caret on GTK+</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">bSlop</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal">	</span><span class="comment">// A margin is defined</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> yMoveT</span><span class="symbol">,</span><span class="normal"> yMoveB</span><span class="symbol">;</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">bStrict</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="type">int</span><span class="normal"> yMarginT</span><span class="symbol">,</span><span class="normal"> yMarginB</span><span class="symbol">;</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">useMargin</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="comment">// In drag mode, avoid moves</span>
<span class="normal">					</span><span class="comment">// otherwise, a double click will select several lines.</span>
<span class="normal">					yMarginT </span><span class="symbol">=</span><span class="normal"> yMarginB </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">				</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="comment">// yMarginT must equal to caretYSlop, with a minimum of 1 and</span>
<span class="normal">					</span><span class="comment">// a maximum of slightly less than half the heigth of the text area.</span>
<span class="normal">					yMarginT </span><span class="symbol">=</span><span class="normal"> Platform</span><span class="symbol">::</span><span class="function">Clamp</span><span class="symbol">(</span><span class="normal">caretYSlop</span><span class="symbol">,</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span><span class="normal"> halfScreen</span><span class="symbol">);</span>
<span class="normal">					</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">bEven</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">						yMarginB </span><span class="symbol">=</span><span class="normal"> yMarginT</span><span class="symbol">;</span>
<span class="normal">					</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">						yMarginB </span><span class="symbol">=</span><span class="normal"> linesOnScreen </span><span class="symbol">-</span><span class="normal"> yMarginT </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">					</span><span class="cbracket">}</span>
<span class="normal">				</span><span class="cbracket">}</span>
<span class="normal">				yMoveT </span><span class="symbol">=</span><span class="normal"> yMarginT</span><span class="symbol">;</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">bEven</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">bJump</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">						yMoveT </span><span class="symbol">=</span><span class="normal"> Platform</span><span class="symbol">::</span><span class="function">Clamp</span><span class="symbol">(</span><span class="normal">caretYSlop </span><span class="symbol">*</span><span class="normal"> </span><span class="number">3</span><span class="symbol">,</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span><span class="normal"> halfScreen</span><span class="symbol">);</span>
<span class="normal">					</span><span class="cbracket">}</span>
<span class="normal">					yMoveB </span><span class="symbol">=</span><span class="normal"> yMoveT</span><span class="symbol">;</span>
<span class="normal">				</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					yMoveB </span><span class="symbol">=</span><span class="normal"> linesOnScreen </span><span class="symbol">-</span><span class="normal"> yMoveT </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">				</span><span class="cbracket">}</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lineCaret </span><span class="symbol">&lt;</span><span class="normal"> topLine </span><span class="symbol">+</span><span class="normal"> yMarginT</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="comment">// Caret goes too high</span>
<span class="normal">					newTopLine </span><span class="symbol">=</span><span class="normal"> lineCaret </span><span class="symbol">-</span><span class="normal"> yMoveT</span><span class="symbol">;</span>
<span class="normal">				</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lineCaret </span><span class="symbol">&gt;</span><span class="normal"> topLine </span><span class="symbol">+</span><span class="normal"> linesOnScreen </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> yMarginB</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="comment">// Caret goes too low</span>
<span class="normal">					newTopLine </span><span class="symbol">=</span><span class="normal"> lineCaret </span><span class="symbol">-</span><span class="normal"> linesOnScreen </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> yMoveB</span><span class="symbol">;</span>
<span class="normal">				</span><span class="cbracket">}</span>
<span class="normal">			</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal">	</span><span class="comment">// Not strict</span>
<span class="normal">				yMoveT </span><span class="symbol">=</span><span class="normal"> bJump </span><span class="symbol">?</span><span class="normal"> caretYSlop </span><span class="symbol">*</span><span class="normal"> </span><span class="number">3</span><span class="normal"> </span><span class="symbol">:</span><span class="normal"> caretYSlop</span><span class="symbol">;</span>
<span class="normal">				yMoveT </span><span class="symbol">=</span><span class="normal"> Platform</span><span class="symbol">::</span><span class="function">Clamp</span><span class="symbol">(</span><span class="normal">yMoveT</span><span class="symbol">,</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span><span class="normal"> halfScreen</span><span class="symbol">);</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">bEven</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					yMoveB </span><span class="symbol">=</span><span class="normal"> yMoveT</span><span class="symbol">;</span>
<span class="normal">				</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					yMoveB </span><span class="symbol">=</span><span class="normal"> linesOnScreen </span><span class="symbol">-</span><span class="normal"> yMoveT </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">				</span><span class="cbracket">}</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lineCaret </span><span class="symbol">&lt;</span><span class="normal"> topLine</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="comment">// Caret goes too high</span>
<span class="normal">					newTopLine </span><span class="symbol">=</span><span class="normal"> lineCaret </span><span class="symbol">-</span><span class="normal"> yMoveT</span><span class="symbol">;</span>
<span class="normal">				</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lineCaret </span><span class="symbol">&gt;</span><span class="normal"> topLine </span><span class="symbol">+</span><span class="normal"> linesOnScreen </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="comment">// Caret goes too low</span>
<span class="normal">					newTopLine </span><span class="symbol">=</span><span class="normal"> lineCaret </span><span class="symbol">-</span><span class="normal"> linesOnScreen </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> yMoveB</span><span class="symbol">;</span>
<span class="normal">				</span><span class="cbracket">}</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal">	</span><span class="comment">// No slop</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">bStrict </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">!</span><span class="normal">bJump</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="comment">// Minimal move</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lineCaret </span><span class="symbol">&lt;</span><span class="normal"> topLine</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="comment">// Caret goes too high</span>
<span class="normal">					newTopLine </span><span class="symbol">=</span><span class="normal"> lineCaret</span><span class="symbol">;</span>
<span class="normal">				</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lineCaret </span><span class="symbol">&gt;</span><span class="normal"> topLine </span><span class="symbol">+</span><span class="normal"> linesOnScreen </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="comment">// Caret goes too low</span>
<span class="normal">					</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">bEven</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">						newTopLine </span><span class="symbol">=</span><span class="normal"> lineCaret </span><span class="symbol">-</span><span class="normal"> linesOnScreen </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">					</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">						newTopLine </span><span class="symbol">=</span><span class="normal"> lineCaret</span><span class="symbol">;</span>
<span class="normal">					</span><span class="cbracket">}</span>
<span class="normal">				</span><span class="cbracket">}</span>
<span class="normal">			</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal">	</span><span class="comment">// Strict or going out of display</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">bEven</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="comment">// Always center caret</span>
<span class="normal">					newTopLine </span><span class="symbol">=</span><span class="normal"> lineCaret </span><span class="symbol">-</span><span class="normal"> halfScreen</span><span class="symbol">;</span>
<span class="normal">				</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="comment">// Always put caret on top of display</span>
<span class="normal">					newTopLine </span><span class="symbol">=</span><span class="normal"> lineCaret</span><span class="symbol">;</span>
<span class="normal">				</span><span class="cbracket">}</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		newTopLine </span><span class="symbol">=</span><span class="normal"> Platform</span><span class="symbol">::</span><span class="function">Clamp</span><span class="symbol">(</span><span class="normal">newTopLine</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="function">MaxScrollPos</span><span class="symbol">());</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">newTopLine </span><span class="symbol">!=</span><span class="normal"> topLine</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="function">Redraw</span><span class="symbol">();</span>
<span class="normal">			</span><span class="function">SetTopLine</span><span class="symbol">(</span><span class="normal">newTopLine</span><span class="symbol">);</span>
<span class="normal">			</span><span class="function">SetVerticalScrollPos</span><span class="symbol">();</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="comment">// Horizontal positioning</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">horiz </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">wrapState </span><span class="symbol">==</span><span class="normal"> eWrapNone</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> halfScreen </span><span class="symbol">=</span><span class="normal"> Platform</span><span class="symbol">::</span><span class="function">Maximum</span><span class="symbol">(</span><span class="normal">rcClient</span><span class="symbol">.</span><span class="function">Width</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="number">4</span><span class="symbol">,</span><span class="normal"> </span><span class="number">4</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">/</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> xOffsetNew </span><span class="symbol">=</span><span class="normal"> xOffset</span><span class="symbol">;</span>
<span class="normal">		bSlop </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">caretXPolicy </span><span class="symbol">&amp;</span><span class="normal"> CARET_SLOP</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		bStrict </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">caretXPolicy </span><span class="symbol">&amp;</span><span class="normal"> CARET_STRICT</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		bJump </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">caretXPolicy </span><span class="symbol">&amp;</span><span class="normal"> CARET_JUMPS</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		bEven </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">caretXPolicy </span><span class="symbol">&amp;</span><span class="normal"> CARET_EVEN</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">bSlop</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal">	</span><span class="comment">// A margin is defined</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> xMoveL</span><span class="symbol">,</span><span class="normal"> xMoveR</span><span class="symbol">;</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">bStrict</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="type">int</span><span class="normal"> xMarginL</span><span class="symbol">,</span><span class="normal"> xMarginR</span><span class="symbol">;</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">useMargin</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="comment">// In drag mode, avoid moves unless very near of the margin</span>
<span class="normal">					</span><span class="comment">// otherwise, a simple click will select text.</span>
<span class="normal">					xMarginL </span><span class="symbol">=</span><span class="normal"> xMarginR </span><span class="symbol">=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">				</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="comment">// xMargin must equal to caretXSlop, with a minimum of 2 and</span>
<span class="normal">					</span><span class="comment">// a maximum of slightly less than half the width of the text area.</span>
<span class="normal">					xMarginR </span><span class="symbol">=</span><span class="normal"> Platform</span><span class="symbol">::</span><span class="function">Clamp</span><span class="symbol">(</span><span class="normal">caretXSlop</span><span class="symbol">,</span><span class="normal"> </span><span class="number">2</span><span class="symbol">,</span><span class="normal"> halfScreen</span><span class="symbol">);</span>
<span class="normal">					</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">bEven</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">						xMarginL </span><span class="symbol">=</span><span class="normal"> xMarginR</span><span class="symbol">;</span>
<span class="normal">					</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">						xMarginL </span><span class="symbol">=</span><span class="normal"> rcClient</span><span class="symbol">.</span><span class="function">Width</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> xMarginR </span><span class="symbol">-</span><span class="normal"> </span><span class="number">4</span><span class="symbol">;</span>
<span class="normal">					</span><span class="cbracket">}</span>
<span class="normal">				</span><span class="cbracket">}</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">bJump </span><span class="symbol">&amp;&amp;</span><span class="normal"> bEven</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="comment">// Jump is used only in even mode</span>
<span class="normal">					xMoveL </span><span class="symbol">=</span><span class="normal"> xMoveR </span><span class="symbol">=</span><span class="normal"> Platform</span><span class="symbol">::</span><span class="function">Clamp</span><span class="symbol">(</span><span class="normal">caretXSlop </span><span class="symbol">*</span><span class="normal"> </span><span class="number">3</span><span class="symbol">,</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span><span class="normal"> halfScreen</span><span class="symbol">);</span>
<span class="normal">				</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					xMoveL </span><span class="symbol">=</span><span class="normal"> xMoveR </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal">	</span><span class="comment">// Not used, avoid a warning</span>
<span class="normal">				</span><span class="cbracket">}</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pt</span><span class="symbol">.</span><span class="normal">x </span><span class="symbol">&lt;</span><span class="normal"> rcClient</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">+</span><span class="normal"> xMarginL</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="comment">// Caret is on the left of the display</span>
<span class="normal">					</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">bJump </span><span class="symbol">&amp;&amp;</span><span class="normal"> bEven</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">						xOffsetNew </span><span class="symbol">-=</span><span class="normal"> xMoveL</span><span class="symbol">;</span>
<span class="normal">					</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">						</span><span class="comment">// Move just enough to allow to display the caret</span>
<span class="normal">						xOffsetNew </span><span class="symbol">-=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">rcClient</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">+</span><span class="normal"> xMarginL</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> pt</span><span class="symbol">.</span><span class="normal">x</span><span class="symbol">;</span>
<span class="normal">					</span><span class="cbracket">}</span>
<span class="normal">				</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pt</span><span class="symbol">.</span><span class="normal">x </span><span class="symbol">&gt;=</span><span class="normal"> rcClient</span><span class="symbol">.</span><span class="normal">right </span><span class="symbol">-</span><span class="normal"> xMarginR</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="comment">// Caret is on the right of the display</span>
<span class="normal">					</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">bJump </span><span class="symbol">&amp;&amp;</span><span class="normal"> bEven</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">						xOffsetNew </span><span class="symbol">+=</span><span class="normal"> xMoveR</span><span class="symbol">;</span>
<span class="normal">					</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">						</span><span class="comment">// Move just enough to allow to display the caret</span>
<span class="normal">						xOffsetNew </span><span class="symbol">+=</span><span class="normal"> pt</span><span class="symbol">.</span><span class="normal">x </span><span class="symbol">-</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">rcClient</span><span class="symbol">.</span><span class="normal">right </span><span class="symbol">-</span><span class="normal"> xMarginR</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">					</span><span class="cbracket">}</span>
<span class="normal">				</span><span class="cbracket">}</span>
<span class="normal">			</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal">	</span><span class="comment">// Not strict</span>
<span class="normal">				xMoveR </span><span class="symbol">=</span><span class="normal"> bJump </span><span class="symbol">?</span><span class="normal"> caretXSlop </span><span class="symbol">*</span><span class="normal"> </span><span class="number">3</span><span class="normal"> </span><span class="symbol">:</span><span class="normal"> caretXSlop</span><span class="symbol">;</span>
<span class="normal">				xMoveR </span><span class="symbol">=</span><span class="normal"> Platform</span><span class="symbol">::</span><span class="function">Clamp</span><span class="symbol">(</span><span class="normal">xMoveR</span><span class="symbol">,</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span><span class="normal"> halfScreen</span><span class="symbol">);</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">bEven</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					xMoveL </span><span class="symbol">=</span><span class="normal"> xMoveR</span><span class="symbol">;</span>
<span class="normal">				</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					xMoveL </span><span class="symbol">=</span><span class="normal"> rcClient</span><span class="symbol">.</span><span class="function">Width</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> xMoveR </span><span class="symbol">-</span><span class="normal"> </span><span class="number">4</span><span class="symbol">;</span>
<span class="normal">				</span><span class="cbracket">}</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pt</span><span class="symbol">.</span><span class="normal">x </span><span class="symbol">&lt;</span><span class="normal"> rcClient</span><span class="symbol">.</span><span class="normal">left</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="comment">// Caret is on the left of the display</span>
<span class="normal">					xOffsetNew </span><span class="symbol">-=</span><span class="normal"> xMoveL</span><span class="symbol">;</span>
<span class="normal">				</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pt</span><span class="symbol">.</span><span class="normal">x </span><span class="symbol">&gt;=</span><span class="normal"> rcClient</span><span class="symbol">.</span><span class="normal">right</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="comment">// Caret is on the right of the display</span>
<span class="normal">					xOffsetNew </span><span class="symbol">+=</span><span class="normal"> xMoveR</span><span class="symbol">;</span>
<span class="normal">				</span><span class="cbracket">}</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal">	</span><span class="comment">// No slop</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">bStrict </span><span class="symbol">||</span>
<span class="normal">			        </span><span class="symbol">(</span><span class="normal">bJump </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pt</span><span class="symbol">.</span><span class="normal">x </span><span class="symbol">&lt;</span><span class="normal"> rcClient</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">||</span><span class="normal"> pt</span><span class="symbol">.</span><span class="normal">x </span><span class="symbol">&gt;=</span><span class="normal"> rcClient</span><span class="symbol">.</span><span class="normal">right</span><span class="symbol">)))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="comment">// Strict or going out of display</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">bEven</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="comment">// Center caret</span>
<span class="normal">					xOffsetNew </span><span class="symbol">+=</span><span class="normal"> pt</span><span class="symbol">.</span><span class="normal">x </span><span class="symbol">-</span><span class="normal"> rcClient</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">-</span><span class="normal"> halfScreen</span><span class="symbol">;</span>
<span class="normal">				</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="comment">// Put caret on right</span>
<span class="normal">					xOffsetNew </span><span class="symbol">+=</span><span class="normal"> pt</span><span class="symbol">.</span><span class="normal">x </span><span class="symbol">-</span><span class="normal"> rcClient</span><span class="symbol">.</span><span class="normal">right </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">				</span><span class="cbracket">}</span>
<span class="normal">			</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="comment">// Move just enough to allow to display the caret</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pt</span><span class="symbol">.</span><span class="normal">x </span><span class="symbol">&lt;</span><span class="normal"> rcClient</span><span class="symbol">.</span><span class="normal">left</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="comment">// Caret is on the left of the display</span>
<span class="normal">					</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">bEven</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">						xOffsetNew </span><span class="symbol">-=</span><span class="normal"> rcClient</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">-</span><span class="normal"> pt</span><span class="symbol">.</span><span class="normal">x</span><span class="symbol">;</span>
<span class="normal">					</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">						xOffsetNew </span><span class="symbol">+=</span><span class="normal"> pt</span><span class="symbol">.</span><span class="normal">x </span><span class="symbol">-</span><span class="normal"> rcClient</span><span class="symbol">.</span><span class="normal">right </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">					</span><span class="cbracket">}</span>
<span class="normal">				</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pt</span><span class="symbol">.</span><span class="normal">x </span><span class="symbol">&gt;=</span><span class="normal"> rcClient</span><span class="symbol">.</span><span class="normal">right</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="comment">// Caret is on the right of the display</span>
<span class="normal">					xOffsetNew </span><span class="symbol">+=</span><span class="normal"> pt</span><span class="symbol">.</span><span class="normal">x </span><span class="symbol">-</span><span class="normal"> rcClient</span><span class="symbol">.</span><span class="normal">right </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">				</span><span class="cbracket">}</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="comment">// In case of a jump (find result) largely out of display, adjust the offset to display the caret</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pt</span><span class="symbol">.</span><span class="normal">x </span><span class="symbol">+</span><span class="normal"> xOffset </span><span class="symbol">&lt;</span><span class="normal"> rcClient</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">+</span><span class="normal"> xOffsetNew</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			xOffsetNew </span><span class="symbol">=</span><span class="normal"> pt</span><span class="symbol">.</span><span class="normal">x </span><span class="symbol">+</span><span class="normal"> xOffset </span><span class="symbol">-</span><span class="normal"> rcClient</span><span class="symbol">.</span><span class="normal">left</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pt</span><span class="symbol">.</span><span class="normal">x </span><span class="symbol">+</span><span class="normal"> xOffset </span><span class="symbol">&gt;=</span><span class="normal"> rcClient</span><span class="symbol">.</span><span class="normal">right </span><span class="symbol">+</span><span class="normal"> xOffsetNew</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			xOffsetNew </span><span class="symbol">=</span><span class="normal"> pt</span><span class="symbol">.</span><span class="normal">x </span><span class="symbol">+</span><span class="normal"> xOffset </span><span class="symbol">-</span><span class="normal"> rcClient</span><span class="symbol">.</span><span class="normal">right </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vs</span><span class="symbol">.</span><span class="normal">caretStyle </span><span class="symbol">==</span><span class="normal"> CARETSTYLE_BLOCK</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="comment">// Ensure we can see a good portion of the block caret</span>
<span class="normal">				xOffsetNew </span><span class="symbol">+=</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">aveCharWidth</span><span class="symbol">;</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">xOffsetNew </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			xOffsetNew </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">xOffset </span><span class="symbol">!=</span><span class="normal"> xOffsetNew</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			xOffset </span><span class="symbol">=</span><span class="normal"> xOffsetNew</span><span class="symbol">;</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">xOffsetNew </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="usertype">PRectangle</span><span class="normal"> rcText </span><span class="symbol">=</span><span class="normal"> </span><span class="function">GetTextRectangle</span><span class="symbol">();</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">horizontalScrollBarVisible </span><span class="symbol">&amp;&amp;</span>
<span class="normal">				        rcText</span><span class="symbol">.</span><span class="function">Width</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> xOffset </span><span class="symbol">&gt;</span><span class="normal"> scrollWidth</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					scrollWidth </span><span class="symbol">=</span><span class="normal"> xOffset </span><span class="symbol">+</span><span class="normal"> rcText</span><span class="symbol">.</span><span class="function">Width</span><span class="symbol">();</span>
<span class="normal">					</span><span class="function">SetScrollBars</span><span class="symbol">();</span>
<span class="normal">				</span><span class="cbracket">}</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">			</span><span class="function">SetHorizontalScrollPos</span><span class="symbol">();</span>
<span class="normal">			</span><span class="function">Redraw</span><span class="symbol">();</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="function">UpdateSystemCaret</span><span class="symbol">();</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">ShowCaretAtCurrentPosition</span><span class="symbol">()</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">hasFocus</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		caret</span><span class="symbol">.</span><span class="normal">active </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>
<span class="normal">		caret</span><span class="symbol">.</span><span class="normal">on </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>
<span class="normal">		</span><span class="function">SetTicking</span><span class="symbol">(</span><span class="keyword">true</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		caret</span><span class="symbol">.</span><span class="normal">active </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="normal">		caret</span><span class="symbol">.</span><span class="normal">on </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="function">InvalidateCaret</span><span class="symbol">();</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">DropCaret</span><span class="symbol">()</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	caret</span><span class="symbol">.</span><span class="normal">active </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="normal">	</span><span class="function">InvalidateCaret</span><span class="symbol">();</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">InvalidateCaret</span><span class="symbol">()</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">posDrag </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">		</span><span class="function">InvalidateRange</span><span class="symbol">(</span><span class="normal">posDrag</span><span class="symbol">,</span><span class="normal"> posDrag </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">else</span>
<span class="normal">		</span><span class="function">InvalidateRange</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">,</span><span class="normal"> currentPos </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">	</span><span class="function">UpdateSystemCaret</span><span class="symbol">();</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">UpdateSystemCaret</span><span class="symbol">()</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">NeedWrapping</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> docLineStart</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> docLineEnd</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	docLineStart </span><span class="symbol">=</span><span class="normal"> Platform</span><span class="symbol">::</span><span class="function">Clamp</span><span class="symbol">(</span><span class="normal">docLineStart</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LinesTotal</span><span class="symbol">());</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">wrapStart </span><span class="symbol">&gt;</span><span class="normal"> docLineStart</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		wrapStart </span><span class="symbol">=</span><span class="normal"> docLineStart</span><span class="symbol">;</span>
<span class="normal">		llc</span><span class="symbol">.</span><span class="function">Invalidate</span><span class="symbol">(</span><span class="normal">LineLayout</span><span class="symbol">::</span><span class="normal">llPositions</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">wrapEnd </span><span class="symbol">&lt;</span><span class="normal"> docLineEnd</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		wrapEnd </span><span class="symbol">=</span><span class="normal"> docLineEnd</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	wrapEnd </span><span class="symbol">=</span><span class="normal"> Platform</span><span class="symbol">::</span><span class="function">Clamp</span><span class="symbol">(</span><span class="normal">wrapEnd</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LinesTotal</span><span class="symbol">());</span>
<span class="normal">	</span><span class="comment">// Wrap lines during idle.</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">wrapState </span><span class="symbol">!=</span><span class="normal"> eWrapNone</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">wrapEnd </span><span class="symbol">!=</span><span class="normal"> wrapStart</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">SetIdle</span><span class="symbol">(</span><span class="keyword">true</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="type">bool</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">WrapOneLine</span><span class="symbol">(</span><span class="usertype">Surface</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">surface</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> lineToWrap</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="usertype">AutoLineLayout</span><span class="normal"> </span><span class="function">ll</span><span class="symbol">(</span><span class="normal">llc</span><span class="symbol">,</span><span class="normal"> </span><span class="function">RetrieveLineLayout</span><span class="symbol">(</span><span class="normal">lineToWrap</span><span class="symbol">));</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> linesWrapped </span><span class="symbol">=</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">LayoutLine</span><span class="symbol">(</span><span class="normal">lineToWrap</span><span class="symbol">,</span><span class="normal"> surface</span><span class="symbol">,</span><span class="normal"> vs</span><span class="symbol">,</span><span class="normal"> ll</span><span class="symbol">,</span><span class="normal"> wrapWidth</span><span class="symbol">);</span>
<span class="normal">		linesWrapped </span><span class="symbol">=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">lines</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> cs</span><span class="symbol">.</span><span class="function">SetHeight</span><span class="symbol">(</span><span class="normal">lineToWrap</span><span class="symbol">,</span><span class="normal"> linesWrapped </span><span class="symbol">+</span><span class="normal"> </span>
<span class="normal">		</span><span class="symbol">(</span><span class="normal">vs</span><span class="symbol">.</span><span class="normal">annotationVisible </span><span class="symbol">?</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">AnnotationLines</span><span class="symbol">(</span><span class="normal">lineToWrap</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">:</span><span class="normal"> </span><span class="number">0</span><span class="symbol">));</span>
<span class="cbracket">}</span>

<span class="comment">// Check if wrapping needed and perform any needed wrapping.</span>
<span class="comment">// fullwrap: if true, all lines which need wrapping will be done,</span>
<span class="comment">//           in this single call.</span>
<span class="comment">// priorityWrapLineStart: If greater than zero, all lines starting from</span>
<span class="comment">//           here to 1 page + 100 lines past will be wrapped (even if there are</span>
<span class="comment">//           more lines under wrapping process in idle).</span>
<span class="comment">// If it is neither fullwrap, nor priorityWrap, then 1 page + 100 lines will be</span>
<span class="comment">// wrapped, if there are any wrapping going on in idle. (Generally this</span>
<span class="comment">// condition is called only from idler).</span>
<span class="comment">// Return true if wrapping occurred.</span>
<span class="type">bool</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">WrapLines</span><span class="symbol">(</span><span class="type">bool</span><span class="normal"> fullWrap</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> priorityWrapLineStart</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="comment">// If there are any pending wraps, do them during idle if possible.</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> linesInOneCall </span><span class="symbol">=</span><span class="normal"> </span><span class="function">LinesOnScreen</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="number">100</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">wrapState </span><span class="symbol">!=</span><span class="normal"> eWrapNone</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">wrapStart </span><span class="symbol">&lt;</span><span class="normal"> wrapEnd</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="function">SetIdle</span><span class="symbol">(</span><span class="keyword">true</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="comment">// Idle processing not supported so full wrap required.</span>
<span class="normal">				fullWrap </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">fullWrap </span><span class="symbol">&amp;&amp;</span><span class="normal"> priorityWrapLineStart </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">0</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span>
<span class="normal">		        </span><span class="comment">// .. and if the paint window is outside pending wraps</span>
<span class="normal">		        </span><span class="symbol">(((</span><span class="normal">priorityWrapLineStart </span><span class="symbol">+</span><span class="normal"> linesInOneCall</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&lt;</span><span class="normal"> wrapStart</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">||</span>
<span class="normal">		         </span><span class="symbol">(</span><span class="normal">priorityWrapLineStart </span><span class="symbol">&gt;</span><span class="normal"> wrapEnd</span><span class="symbol">)))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="comment">// No priority wrap pending</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> goodTopLine </span><span class="symbol">=</span><span class="normal"> topLine</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">bool</span><span class="normal"> wrapOccurred </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">wrapStart </span><span class="symbol">&lt;=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LinesTotal</span><span class="symbol">())</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">wrapState </span><span class="symbol">==</span><span class="normal"> eWrapNone</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">wrapWidth </span><span class="symbol">!=</span><span class="normal"> LineLayout</span><span class="symbol">::</span><span class="normal">wrapWidthInfinite</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				wrapWidth </span><span class="symbol">=</span><span class="normal"> LineLayout</span><span class="symbol">::</span><span class="normal">wrapWidthInfinite</span><span class="symbol">;</span>
<span class="normal">				</span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="normal"> lineDoc </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> lineDoc </span><span class="symbol">&lt;</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LinesTotal</span><span class="symbol">();</span><span class="normal"> lineDoc</span><span class="symbol">++)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					cs</span><span class="symbol">.</span><span class="function">SetHeight</span><span class="symbol">(</span><span class="normal">lineDoc</span><span class="symbol">,</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span>
<span class="normal">						</span><span class="symbol">(</span><span class="normal">vs</span><span class="symbol">.</span><span class="normal">annotationVisible </span><span class="symbol">?</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">AnnotationLines</span><span class="symbol">(</span><span class="normal">lineDoc</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">:</span><span class="normal"> </span><span class="number">0</span><span class="symbol">));</span>
<span class="normal">				</span><span class="cbracket">}</span>
<span class="normal">				wrapOccurred </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">			wrapStart </span><span class="symbol">=</span><span class="normal"> wrapLineLarge</span><span class="symbol">;</span>
<span class="normal">			wrapEnd </span><span class="symbol">=</span><span class="normal"> wrapLineLarge</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">wrapEnd </span><span class="symbol">&gt;=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LinesTotal</span><span class="symbol">())</span>
<span class="normal">				wrapEnd </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LinesTotal</span><span class="symbol">();</span>
<span class="normal">			</span><span class="comment">//ElapsedTime et;</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> lineDocTop </span><span class="symbol">=</span><span class="normal"> cs</span><span class="symbol">.</span><span class="function">DocFromDisplay</span><span class="symbol">(</span><span class="normal">topLine</span><span class="symbol">);</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> subLineTop </span><span class="symbol">=</span><span class="normal"> topLine </span><span class="symbol">-</span><span class="normal"> cs</span><span class="symbol">.</span><span class="function">DisplayFromDoc</span><span class="symbol">(</span><span class="normal">lineDocTop</span><span class="symbol">);</span>
<span class="normal">			</span><span class="usertype">PRectangle</span><span class="normal"> rcTextArea </span><span class="symbol">=</span><span class="normal"> </span><span class="function">GetClientRectangle</span><span class="symbol">();</span>
<span class="normal">			rcTextArea</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">=</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">fixedColumnWidth</span><span class="symbol">;</span>
<span class="normal">			rcTextArea</span><span class="symbol">.</span><span class="normal">right </span><span class="symbol">-=</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">rightMarginWidth</span><span class="symbol">;</span>
<span class="normal">			wrapWidth </span><span class="symbol">=</span><span class="normal"> rcTextArea</span><span class="symbol">.</span><span class="function">Width</span><span class="symbol">();</span>
<span class="normal">			</span><span class="comment">// Ensure all of the document is styled.</span>
<span class="normal">			pdoc</span><span class="symbol">-&gt;</span><span class="function">EnsureStyledTo</span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">Length</span><span class="symbol">());</span>
<span class="normal">			</span><span class="function">RefreshStyleData</span><span class="symbol">();</span>
<span class="normal">			</span><span class="usertype">AutoSurface</span><span class="normal"> </span><span class="function">surface</span><span class="symbol">(</span><span class="keyword">this</span><span class="symbol">);</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">surface</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="type">bool</span><span class="normal"> priorityWrap </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="normal">				</span><span class="type">int</span><span class="normal"> lastLineToWrap </span><span class="symbol">=</span><span class="normal"> wrapEnd</span><span class="symbol">;</span>
<span class="normal">				</span><span class="type">int</span><span class="normal"> lineToWrap </span><span class="symbol">=</span><span class="normal"> wrapStart</span><span class="symbol">;</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">fullWrap</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">priorityWrapLineStart </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">						</span><span class="comment">// This is a priority wrap.</span>
<span class="normal">						lineToWrap </span><span class="symbol">=</span><span class="normal"> priorityWrapLineStart</span><span class="symbol">;</span>
<span class="normal">						lastLineToWrap </span><span class="symbol">=</span><span class="normal"> priorityWrapLineStart </span><span class="symbol">+</span><span class="normal"> linesInOneCall</span><span class="symbol">;</span>
<span class="normal">						priorityWrap </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>
<span class="normal">					</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">						</span><span class="comment">// This is idle wrap.</span>
<span class="normal">						lastLineToWrap </span><span class="symbol">=</span><span class="normal"> wrapStart </span><span class="symbol">+</span><span class="normal"> linesInOneCall</span><span class="symbol">;</span>
<span class="normal">					</span><span class="cbracket">}</span>
<span class="normal">					</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lastLineToWrap </span><span class="symbol">&gt;=</span><span class="normal"> wrapEnd</span><span class="symbol">)</span>
<span class="normal">						lastLineToWrap </span><span class="symbol">=</span><span class="normal"> wrapEnd</span><span class="symbol">;</span>
<span class="normal">				</span><span class="cbracket">}</span><span class="normal"> </span><span class="comment">// else do a fullWrap.</span>

<span class="normal">				</span><span class="comment">// Platform::DebugPrintf("Wraplines: full = %d, priorityStart = %d (wrapping: %d to %d)\n", fullWrap, priorityWrapLineStart, lineToWrap, lastLineToWrap);</span>
<span class="normal">				</span><span class="comment">// Platform::DebugPrintf("Pending wraps: %d to %d\n", wrapStart, wrapEnd);</span>
<span class="normal">				</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lineToWrap </span><span class="symbol">&lt;</span><span class="normal"> lastLineToWrap</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">WrapOneLine</span><span class="symbol">(</span><span class="normal">surface</span><span class="symbol">,</span><span class="normal"> lineToWrap</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">						wrapOccurred </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>
<span class="normal">					</span><span class="cbracket">}</span>
<span class="normal">					lineToWrap</span><span class="symbol">++;</span>
<span class="normal">				</span><span class="cbracket">}</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">priorityWrap</span><span class="symbol">)</span>
<span class="normal">					wrapStart </span><span class="symbol">=</span><span class="normal"> lineToWrap</span><span class="symbol">;</span>
<span class="normal">				</span><span class="comment">// If wrapping is done, bring it to resting position</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">wrapStart </span><span class="symbol">&gt;=</span><span class="normal"> wrapEnd</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					wrapStart </span><span class="symbol">=</span><span class="normal"> wrapLineLarge</span><span class="symbol">;</span>
<span class="normal">					wrapEnd </span><span class="symbol">=</span><span class="normal"> wrapLineLarge</span><span class="symbol">;</span>
<span class="normal">				</span><span class="cbracket">}</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">			goodTopLine </span><span class="symbol">=</span><span class="normal"> cs</span><span class="symbol">.</span><span class="function">DisplayFromDoc</span><span class="symbol">(</span><span class="normal">lineDocTop</span><span class="symbol">);</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">subLineTop </span><span class="symbol">&lt;</span><span class="normal"> cs</span><span class="symbol">.</span><span class="function">GetHeight</span><span class="symbol">(</span><span class="normal">lineDocTop</span><span class="symbol">))</span>
<span class="normal">				goodTopLine </span><span class="symbol">+=</span><span class="normal"> subLineTop</span><span class="symbol">;</span>
<span class="normal">			</span><span class="keyword">else</span>
<span class="normal">				goodTopLine </span><span class="symbol">+=</span><span class="normal"> cs</span><span class="symbol">.</span><span class="function">GetHeight</span><span class="symbol">(</span><span class="normal">lineDocTop</span><span class="symbol">);</span>
<span class="normal">			</span><span class="comment">//double durWrap = et.Duration(true);</span>
<span class="normal">			</span><span class="comment">//Platform::DebugPrintf("Wrap:%9.6g \n", durWrap);</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">wrapOccurred</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">SetScrollBars</span><span class="symbol">();</span>
<span class="normal">		</span><span class="function">SetTopLine</span><span class="symbol">(</span><span class="normal">Platform</span><span class="symbol">::</span><span class="function">Clamp</span><span class="symbol">(</span><span class="normal">goodTopLine</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="function">MaxScrollPos</span><span class="symbol">()));</span>
<span class="normal">		</span><span class="function">SetVerticalScrollPos</span><span class="symbol">();</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> wrapOccurred</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">LinesJoin</span><span class="symbol">()</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="function">RangeContainsProtected</span><span class="symbol">(</span><span class="normal">targetStart</span><span class="symbol">,</span><span class="normal"> targetEnd</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		pdoc</span><span class="symbol">-&gt;</span><span class="function">BeginUndoAction</span><span class="symbol">();</span>
<span class="normal">		</span><span class="type">bool</span><span class="normal"> prevNonWS </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="normal"> pos </span><span class="symbol">=</span><span class="normal"> targetStart</span><span class="symbol">;</span><span class="normal"> pos </span><span class="symbol">&lt;</span><span class="normal"> targetEnd</span><span class="symbol">;</span><span class="normal"> pos</span><span class="symbol">++)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">IsEOLChar</span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">CharAt</span><span class="symbol">(</span><span class="normal">pos</span><span class="symbol">)))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				targetEnd </span><span class="symbol">-=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LenChar</span><span class="symbol">(</span><span class="normal">pos</span><span class="symbol">);</span>
<span class="normal">				pdoc</span><span class="symbol">-&gt;</span><span class="function">DelChar</span><span class="symbol">(</span><span class="normal">pos</span><span class="symbol">);</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">prevNonWS</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="comment">// Ensure at least one space separating previous lines</span>
<span class="normal">					pdoc</span><span class="symbol">-&gt;</span><span class="function">InsertChar</span><span class="symbol">(</span><span class="normal">pos</span><span class="symbol">,</span><span class="normal"> </span><span class="string">' '</span><span class="symbol">);</span>
<span class="normal">					targetEnd</span><span class="symbol">++;</span>
<span class="normal">				</span><span class="cbracket">}</span>
<span class="normal">			</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				prevNonWS </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">CharAt</span><span class="symbol">(</span><span class="normal">pos</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="string">' '</span><span class="symbol">;</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		pdoc</span><span class="symbol">-&gt;</span><span class="function">EndUndoAction</span><span class="symbol">();</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="keyword">const</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">Editor</span><span class="symbol">::</span><span class="function">StringFromEOLMode</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> eolMode</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">eolMode </span><span class="symbol">==</span><span class="normal"> SC_EOL_CRLF</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="string">"</span><span class="specialchar">\r\n</span><span class="string">"</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">eolMode </span><span class="symbol">==</span><span class="normal"> SC_EOL_CR</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="string">"</span><span class="specialchar">\r</span><span class="string">"</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="string">"</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">LinesSplit</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> pixelWidth</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="function">RangeContainsProtected</span><span class="symbol">(</span><span class="normal">targetStart</span><span class="symbol">,</span><span class="normal"> targetEnd</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pixelWidth </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="usertype">PRectangle</span><span class="normal"> rcText </span><span class="symbol">=</span><span class="normal"> </span><span class="function">GetTextRectangle</span><span class="symbol">();</span>
<span class="normal">			pixelWidth </span><span class="symbol">=</span><span class="normal"> rcText</span><span class="symbol">.</span><span class="function">Width</span><span class="symbol">();</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> lineStart </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineFromPosition</span><span class="symbol">(</span><span class="normal">targetStart</span><span class="symbol">);</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> lineEnd </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineFromPosition</span><span class="symbol">(</span><span class="normal">targetEnd</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">const</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">eol </span><span class="symbol">=</span><span class="normal"> </span><span class="function">StringFromEOLMode</span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="normal">eolMode</span><span class="symbol">);</span>
<span class="normal">		pdoc</span><span class="symbol">-&gt;</span><span class="function">BeginUndoAction</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="normal"> line </span><span class="symbol">=</span><span class="normal"> lineStart</span><span class="symbol">;</span><span class="normal"> line </span><span class="symbol">&lt;=</span><span class="normal"> lineEnd</span><span class="symbol">;</span><span class="normal"> line</span><span class="symbol">++)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="usertype">AutoSurface</span><span class="normal"> </span><span class="function">surface</span><span class="symbol">(</span><span class="keyword">this</span><span class="symbol">);</span>
<span class="normal">			</span><span class="usertype">AutoLineLayout</span><span class="normal"> </span><span class="function">ll</span><span class="symbol">(</span><span class="normal">llc</span><span class="symbol">,</span><span class="normal"> </span><span class="function">RetrieveLineLayout</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">));</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">surface </span><span class="symbol">&amp;&amp;</span><span class="normal"> ll</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> posLineStart </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">);</span>
<span class="normal">				</span><span class="function">LayoutLine</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">,</span><span class="normal"> surface</span><span class="symbol">,</span><span class="normal"> vs</span><span class="symbol">,</span><span class="normal"> ll</span><span class="symbol">,</span><span class="normal"> pixelWidth</span><span class="symbol">);</span>
<span class="normal">				</span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="normal"> subLine </span><span class="symbol">=</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span><span class="normal"> subLine </span><span class="symbol">&lt;</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">lines</span><span class="symbol">;</span><span class="normal"> subLine</span><span class="symbol">++)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					pdoc</span><span class="symbol">-&gt;</span><span class="function">InsertCString</span><span class="symbol">(</span><span class="normal">posLineStart </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">subLine </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> </span><span class="function">strlen</span><span class="symbol">(</span><span class="normal">eol</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span>
<span class="normal">					        ll</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">subLine</span><span class="symbol">),</span><span class="normal"> eol</span><span class="symbol">);</span>
<span class="normal">					targetEnd </span><span class="symbol">+=</span><span class="normal"> </span><span class="keyword">static_cast</span><span class="symbol">&lt;</span><span class="type">int</span><span class="symbol">&gt;(</span><span class="function">strlen</span><span class="symbol">(</span><span class="normal">eol</span><span class="symbol">));</span>
<span class="normal">				</span><span class="cbracket">}</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">			lineEnd </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineFromPosition</span><span class="symbol">(</span><span class="normal">targetEnd</span><span class="symbol">);</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		pdoc</span><span class="symbol">-&gt;</span><span class="function">EndUndoAction</span><span class="symbol">();</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="type">int</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">SubstituteMarkerIfEmpty</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> markerCheck</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> markerDefault</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vs</span><span class="symbol">.</span><span class="normal">markers</span><span class="symbol">[</span><span class="normal">markerCheck</span><span class="symbol">].</span><span class="normal">markType </span><span class="symbol">==</span><span class="normal"> SC_MARK_EMPTY</span><span class="symbol">)</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> markerDefault</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> markerCheck</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="comment">// Avoid 64 bit compiler warnings.</span>
<span class="comment">// Scintilla does not support text buffers larger than 2**31</span>
<span class="keyword">static</span><span class="normal"> </span><span class="type">int</span><span class="normal"> </span><span class="function">istrlen</span><span class="symbol">(</span><span class="keyword">const</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">s</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="keyword">static_cast</span><span class="symbol">&lt;</span><span class="type">int</span><span class="symbol">&gt;(</span><span class="function">strlen</span><span class="symbol">(</span><span class="normal">s</span><span class="symbol">));</span>
<span class="cbracket">}</span>

<span class="type">bool</span><span class="normal"> </span><span class="function">ValidStyledText</span><span class="symbol">(</span><span class="usertype">ViewStyle</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">vs</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">size_t</span><span class="normal"> styleOffset</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> </span><span class="usertype">StyledText</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">st</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">st</span><span class="symbol">.</span><span class="normal">multipleStyles</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="usertype">size_t</span><span class="normal"> iStyle</span><span class="symbol">=</span><span class="number">0</span><span class="symbol">;</span><span class="normal">iStyle</span><span class="symbol">&lt;</span><span class="normal">st</span><span class="symbol">.</span><span class="normal">length</span><span class="symbol">;</span><span class="normal"> iStyle</span><span class="symbol">++)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">vs</span><span class="symbol">.</span><span class="function">ValidStyle</span><span class="symbol">(</span><span class="normal">styleOffset </span><span class="symbol">+</span><span class="normal"> st</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">iStyle</span><span class="symbol">]))</span>
<span class="normal">				</span><span class="keyword">return</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">vs</span><span class="symbol">.</span><span class="function">ValidStyle</span><span class="symbol">(</span><span class="normal">styleOffset </span><span class="symbol">+</span><span class="normal"> st</span><span class="symbol">.</span><span class="normal">style</span><span class="symbol">))</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="keyword">static</span><span class="normal"> </span><span class="type">int</span><span class="normal"> </span><span class="function">WidthStyledText</span><span class="symbol">(</span><span class="usertype">Surface</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">surface</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">ViewStyle</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">vs</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> styleOffset</span><span class="symbol">,</span>
<span class="normal">	</span><span class="keyword">const</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">text</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">styles</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">size_t</span><span class="normal"> len</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> width </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">size_t</span><span class="normal"> start </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">start </span><span class="symbol">&lt;</span><span class="normal"> len</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="usertype">size_t</span><span class="normal"> style </span><span class="symbol">=</span><span class="normal"> styles</span><span class="symbol">[</span><span class="normal">start</span><span class="symbol">];</span>
<span class="normal">		</span><span class="usertype">size_t</span><span class="normal"> endSegment </span><span class="symbol">=</span><span class="normal"> start</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">endSegment</span><span class="symbol">+</span><span class="number">1</span><span class="normal"> </span><span class="symbol">&lt;</span><span class="normal"> len</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="keyword">static_cast</span><span class="symbol">&lt;</span><span class="normal">size_t</span><span class="symbol">&gt;(</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">endSegment</span><span class="symbol">+</span><span class="number">1</span><span class="symbol">])</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> style</span><span class="symbol">))</span>
<span class="normal">			endSegment</span><span class="symbol">++;</span>
<span class="normal">		width </span><span class="symbol">+=</span><span class="normal"> surface</span><span class="symbol">-&gt;</span><span class="function">WidthText</span><span class="symbol">(</span><span class="normal">vs</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">style</span><span class="symbol">+</span><span class="normal">styleOffset</span><span class="symbol">].</span><span class="normal">font</span><span class="symbol">,</span><span class="normal"> text </span><span class="symbol">+</span><span class="normal"> start</span><span class="symbol">,</span><span class="normal"> endSegment </span><span class="symbol">-</span><span class="normal"> start </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">		start </span><span class="symbol">=</span><span class="normal"> endSegment </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> width</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="keyword">static</span><span class="normal"> </span><span class="type">int</span><span class="normal"> </span><span class="function">WidestLineWidth</span><span class="symbol">(</span><span class="usertype">Surface</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">surface</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">ViewStyle</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">vs</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> styleOffset</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> </span><span class="usertype">StyledText</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">st</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> widthMax </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">size_t</span><span class="normal"> start </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">start </span><span class="symbol">&lt;</span><span class="normal"> st</span><span class="symbol">.</span><span class="normal">length</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="usertype">size_t</span><span class="normal"> lenLine </span><span class="symbol">=</span><span class="normal"> st</span><span class="symbol">.</span><span class="function">LineLength</span><span class="symbol">(</span><span class="normal">start</span><span class="symbol">);</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> widthSubLine</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">st</span><span class="symbol">.</span><span class="normal">multipleStyles</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			widthSubLine </span><span class="symbol">=</span><span class="normal"> </span><span class="function">WidthStyledText</span><span class="symbol">(</span><span class="normal">surface</span><span class="symbol">,</span><span class="normal"> vs</span><span class="symbol">,</span><span class="normal"> styleOffset</span><span class="symbol">,</span><span class="normal"> st</span><span class="symbol">.</span><span class="normal">text </span><span class="symbol">+</span><span class="normal"> start</span><span class="symbol">,</span><span class="normal"> st</span><span class="symbol">.</span><span class="normal">styles </span><span class="symbol">+</span><span class="normal"> start</span><span class="symbol">,</span><span class="normal"> lenLine</span><span class="symbol">);</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			widthSubLine </span><span class="symbol">=</span><span class="normal"> surface</span><span class="symbol">-&gt;</span><span class="function">WidthText</span><span class="symbol">(</span><span class="normal">vs</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">styleOffset </span><span class="symbol">+</span><span class="normal"> st</span><span class="symbol">.</span><span class="normal">style</span><span class="symbol">].</span><span class="normal">font</span><span class="symbol">,</span><span class="normal"> st</span><span class="symbol">.</span><span class="normal">text </span><span class="symbol">+</span><span class="normal"> start</span><span class="symbol">,</span><span class="normal"> lenLine</span><span class="symbol">);</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">widthSubLine </span><span class="symbol">&gt;</span><span class="normal"> widthMax</span><span class="symbol">)</span>
<span class="normal">			widthMax </span><span class="symbol">=</span><span class="normal"> widthSubLine</span><span class="symbol">;</span>
<span class="normal">		start </span><span class="symbol">+=</span><span class="normal"> lenLine </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> widthMax</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> </span><span class="function">DrawStyledText</span><span class="symbol">(</span><span class="usertype">Surface</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">surface</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">ViewStyle</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">vs</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> styleOffset</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">PRectangle</span><span class="normal"> rcText</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> ascent</span><span class="symbol">,</span><span class="normal"> </span>
<span class="normal">	</span><span class="keyword">const</span><span class="normal"> </span><span class="usertype">StyledText</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">st</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">size_t</span><span class="normal"> start</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">size_t</span><span class="normal"> length</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">st</span><span class="symbol">.</span><span class="normal">multipleStyles</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> x </span><span class="symbol">=</span><span class="normal"> rcText</span><span class="symbol">.</span><span class="normal">left</span><span class="symbol">;</span>
<span class="normal">		</span><span class="usertype">size_t</span><span class="normal"> i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">&lt;</span><span class="normal"> length</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="usertype">size_t</span><span class="normal"> end </span><span class="symbol">=</span><span class="normal"> i</span><span class="symbol">;</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> style </span><span class="symbol">=</span><span class="normal"> st</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">i </span><span class="symbol">+</span><span class="normal"> start</span><span class="symbol">];</span>
<span class="normal">			</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">end </span><span class="symbol">&lt;</span><span class="normal"> length</span><span class="symbol">-</span><span class="number">1</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> st</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">start</span><span class="symbol">+</span><span class="normal">end</span><span class="symbol">+</span><span class="number">1</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> style</span><span class="symbol">)</span>
<span class="normal">				end</span><span class="symbol">++;</span>
<span class="normal">			style </span><span class="symbol">+=</span><span class="normal"> styleOffset</span><span class="symbol">;</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> width </span><span class="symbol">=</span><span class="normal"> surface</span><span class="symbol">-&gt;</span><span class="function">WidthText</span><span class="symbol">(</span><span class="normal">vs</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">style</span><span class="symbol">].</span><span class="normal">font</span><span class="symbol">,</span><span class="normal"> st</span><span class="symbol">.</span><span class="normal">text </span><span class="symbol">+</span><span class="normal"> start </span><span class="symbol">+</span><span class="normal"> i</span><span class="symbol">,</span><span class="normal"> end </span><span class="symbol">-</span><span class="normal"> i </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">			</span><span class="usertype">PRectangle</span><span class="normal"> rcSegment </span><span class="symbol">=</span><span class="normal"> rcText</span><span class="symbol">;</span>
<span class="normal">			rcSegment</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">=</span><span class="normal"> x</span><span class="symbol">;</span>
<span class="normal">			rcSegment</span><span class="symbol">.</span><span class="normal">right </span><span class="symbol">=</span><span class="normal"> x </span><span class="symbol">+</span><span class="normal"> width </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">			surface</span><span class="symbol">-&gt;</span><span class="function">DrawTextNoClip</span><span class="symbol">(</span><span class="normal">rcSegment</span><span class="symbol">,</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">style</span><span class="symbol">].</span><span class="normal">font</span><span class="symbol">,</span>
<span class="normal">					ascent</span><span class="symbol">,</span><span class="normal"> st</span><span class="symbol">.</span><span class="normal">text </span><span class="symbol">+</span><span class="normal"> start </span><span class="symbol">+</span><span class="normal"> i</span><span class="symbol">,</span><span class="normal"> end </span><span class="symbol">-</span><span class="normal"> i </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span>
<span class="normal">					vs</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">style</span><span class="symbol">].</span><span class="normal">fore</span><span class="symbol">.</span><span class="normal">allocated</span><span class="symbol">,</span>
<span class="normal">					vs</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">style</span><span class="symbol">].</span><span class="normal">back</span><span class="symbol">.</span><span class="normal">allocated</span><span class="symbol">);</span>
<span class="normal">			x </span><span class="symbol">+=</span><span class="normal"> width</span><span class="symbol">;</span>
<span class="normal">			i </span><span class="symbol">=</span><span class="normal"> end </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> style </span><span class="symbol">=</span><span class="normal"> st</span><span class="symbol">.</span><span class="normal">style </span><span class="symbol">+</span><span class="normal"> styleOffset</span><span class="symbol">;</span>
<span class="normal">		surface</span><span class="symbol">-&gt;</span><span class="function">DrawTextNoClip</span><span class="symbol">(</span><span class="normal">rcText</span><span class="symbol">,</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">style</span><span class="symbol">].</span><span class="normal">font</span><span class="symbol">,</span>
<span class="normal">				rcText</span><span class="symbol">.</span><span class="normal">top </span><span class="symbol">+</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">maxAscent</span><span class="symbol">,</span><span class="normal"> st</span><span class="symbol">.</span><span class="normal">text </span><span class="symbol">+</span><span class="normal"> start</span><span class="symbol">,</span><span class="normal"> length</span><span class="symbol">,</span>
<span class="normal">				vs</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">style</span><span class="symbol">].</span><span class="normal">fore</span><span class="symbol">.</span><span class="normal">allocated</span><span class="symbol">,</span>
<span class="normal">				vs</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">style</span><span class="symbol">].</span><span class="normal">back</span><span class="symbol">.</span><span class="normal">allocated</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">PaintSelMargin</span><span class="symbol">(</span><span class="usertype">Surface</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">surfWindow</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">PRectangle</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">rc</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vs</span><span class="symbol">.</span><span class="normal">fixedColumnWidth </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">		</span><span class="keyword">return</span><span class="symbol">;</span>

<span class="normal">	</span><span class="usertype">PRectangle</span><span class="normal"> rcMargin </span><span class="symbol">=</span><span class="normal"> </span><span class="function">GetClientRectangle</span><span class="symbol">();</span>
<span class="normal">	rcMargin</span><span class="symbol">.</span><span class="normal">right </span><span class="symbol">=</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">fixedColumnWidth</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">rc</span><span class="symbol">.</span><span class="function">Intersects</span><span class="symbol">(</span><span class="normal">rcMargin</span><span class="symbol">))</span>
<span class="normal">		</span><span class="keyword">return</span><span class="symbol">;</span>

<span class="normal">	</span><span class="usertype">Surface</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">surface</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">bufferedDraw</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		surface </span><span class="symbol">=</span><span class="normal"> pixmapSelMargin</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		surface </span><span class="symbol">=</span><span class="normal"> surfWindow</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="usertype">PRectangle</span><span class="normal"> rcSelMargin </span><span class="symbol">=</span><span class="normal"> rcMargin</span><span class="symbol">;</span>
<span class="normal">	rcSelMargin</span><span class="symbol">.</span><span class="normal">right </span><span class="symbol">=</span><span class="normal"> rcMargin</span><span class="symbol">.</span><span class="normal">left</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="normal"> margin </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> margin </span><span class="symbol">&lt;</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">margins</span><span class="symbol">;</span><span class="normal"> margin</span><span class="symbol">++)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vs</span><span class="symbol">.</span><span class="normal">ms</span><span class="symbol">[</span><span class="normal">margin</span><span class="symbol">].</span><span class="normal">width </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>

<span class="normal">			rcSelMargin</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">=</span><span class="normal"> rcSelMargin</span><span class="symbol">.</span><span class="normal">right</span><span class="symbol">;</span>
<span class="normal">			rcSelMargin</span><span class="symbol">.</span><span class="normal">right </span><span class="symbol">=</span><span class="normal"> rcSelMargin</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">+</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">ms</span><span class="symbol">[</span><span class="normal">margin</span><span class="symbol">].</span><span class="normal">width</span><span class="symbol">;</span>

<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vs</span><span class="symbol">.</span><span class="normal">ms</span><span class="symbol">[</span><span class="normal">margin</span><span class="symbol">].</span><span class="normal">style </span><span class="symbol">!=</span><span class="normal"> SC_MARGIN_NUMBER</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="comment">/* alternate scheme:</span>
<span class="comment">				if (vs.ms[margin].mask &amp; SC_MASK_FOLDERS)</span>
<span class="comment">					surface-&gt;FillRectangle(rcSelMargin, vs.styles[STYLE_DEFAULT].back.allocated);</span>
<span class="comment">				else</span>
<span class="comment">					// Required because of special way brush is created for selection margin</span>
<span class="comment">					surface-&gt;FillRectangle(rcSelMargin, pixmapSelPattern);</span>
<span class="comment">				*/</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vs</span><span class="symbol">.</span><span class="normal">ms</span><span class="symbol">[</span><span class="normal">margin</span><span class="symbol">].</span><span class="normal">mask </span><span class="symbol">&amp;</span><span class="normal"> SC_MASK_FOLDERS</span><span class="symbol">)</span>
<span class="normal">					</span><span class="comment">// Required because of special way brush is created for selection margin</span>
<span class="normal">					surface</span><span class="symbol">-&gt;</span><span class="function">FillRectangle</span><span class="symbol">(</span><span class="normal">rcSelMargin</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">pixmapSelPattern</span><span class="symbol">);</span>
<span class="normal">				</span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="usertype">ColourAllocated</span><span class="normal"> colour</span><span class="symbol">;</span>
<span class="normal">					</span><span class="keyword">switch</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vs</span><span class="symbol">.</span><span class="normal">ms</span><span class="symbol">[</span><span class="normal">margin</span><span class="symbol">].</span><span class="normal">style</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="keyword">case</span><span class="normal"> SC_MARGIN_BACK</span><span class="symbol">:</span>
<span class="normal">						colour </span><span class="symbol">=</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">STYLE_DEFAULT</span><span class="symbol">].</span><span class="normal">back</span><span class="symbol">.</span><span class="normal">allocated</span><span class="symbol">;</span>
<span class="normal">						</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">					</span><span class="keyword">case</span><span class="normal"> SC_MARGIN_FORE</span><span class="symbol">:</span>
<span class="normal">						colour </span><span class="symbol">=</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">STYLE_DEFAULT</span><span class="symbol">].</span><span class="normal">fore</span><span class="symbol">.</span><span class="normal">allocated</span><span class="symbol">;</span>
<span class="normal">						</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="label">					default:</span>
<span class="normal">						colour </span><span class="symbol">=</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">STYLE_LINENUMBER</span><span class="symbol">].</span><span class="normal">back</span><span class="symbol">.</span><span class="normal">allocated</span><span class="symbol">;</span>
<span class="normal">						</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">					</span><span class="cbracket">}</span>
<span class="normal">					surface</span><span class="symbol">-&gt;</span><span class="function">FillRectangle</span><span class="symbol">(</span><span class="normal">rcSelMargin</span><span class="symbol">,</span><span class="normal"> colour</span><span class="symbol">);</span>
<span class="normal">				</span><span class="cbracket">}</span>
<span class="normal">			</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				surface</span><span class="symbol">-&gt;</span><span class="function">FillRectangle</span><span class="symbol">(</span><span class="normal">rcSelMargin</span><span class="symbol">,</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">STYLE_LINENUMBER</span><span class="symbol">].</span><span class="normal">back</span><span class="symbol">.</span><span class="normal">allocated</span><span class="symbol">);</span>
<span class="normal">			</span><span class="cbracket">}</span>

<span class="normal">			</span><span class="type">int</span><span class="normal"> visibleLine </span><span class="symbol">=</span><span class="normal"> topLine</span><span class="symbol">;</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> yposScreen </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">			</span><span class="comment">// Work out whether the top line is whitespace located after a</span>
<span class="normal">			</span><span class="comment">// lessening of fold level which implies a 'fold tail' but which should not</span>
<span class="normal">			</span><span class="comment">// be displayed until the last of a sequence of whitespace.</span>
<span class="normal">			</span><span class="type">bool</span><span class="normal"> needWhiteClosure </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> level </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">GetLevel</span><span class="symbol">(</span><span class="normal">cs</span><span class="symbol">.</span><span class="function">DocFromDisplay</span><span class="symbol">(</span><span class="normal">topLine</span><span class="symbol">));</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">level </span><span class="symbol">&amp;</span><span class="normal"> SC_FOLDLEVELWHITEFLAG</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="type">int</span><span class="normal"> lineBack </span><span class="symbol">=</span><span class="normal"> cs</span><span class="symbol">.</span><span class="function">DocFromDisplay</span><span class="symbol">(</span><span class="normal">topLine</span><span class="symbol">);</span>
<span class="normal">				</span><span class="type">int</span><span class="normal"> levelPrev </span><span class="symbol">=</span><span class="normal"> level</span><span class="symbol">;</span>
<span class="normal">				</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">lineBack </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">levelPrev </span><span class="symbol">&amp;</span><span class="normal"> SC_FOLDLEVELWHITEFLAG</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					lineBack</span><span class="symbol">--;</span>
<span class="normal">					levelPrev </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">GetLevel</span><span class="symbol">(</span><span class="normal">lineBack</span><span class="symbol">);</span>
<span class="normal">				</span><span class="cbracket">}</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!(</span><span class="normal">levelPrev </span><span class="symbol">&amp;</span><span class="normal"> SC_FOLDLEVELHEADERFLAG</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">level </span><span class="symbol">&amp;</span><span class="normal"> SC_FOLDLEVELNUMBERMASK</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">levelPrev </span><span class="symbol">&amp;</span><span class="normal"> SC_FOLDLEVELNUMBERMASK</span><span class="symbol">))</span>
<span class="normal">						needWhiteClosure </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>
<span class="normal">				</span><span class="cbracket">}</span>
<span class="normal">			</span><span class="cbracket">}</span>

<span class="normal">			</span><span class="comment">// Old code does not know about new markers needed to distinguish all cases</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> folderOpenMid </span><span class="symbol">=</span><span class="normal"> </span><span class="function">SubstituteMarkerIfEmpty</span><span class="symbol">(</span><span class="normal">SC_MARKNUM_FOLDEROPENMID</span><span class="symbol">,</span>
<span class="normal">			        SC_MARKNUM_FOLDEROPEN</span><span class="symbol">);</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> folderEnd </span><span class="symbol">=</span><span class="normal"> </span><span class="function">SubstituteMarkerIfEmpty</span><span class="symbol">(</span><span class="normal">SC_MARKNUM_FOLDEREND</span><span class="symbol">,</span>
<span class="normal">			        SC_MARKNUM_FOLDER</span><span class="symbol">);</span>

<span class="normal">			</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">visibleLine </span><span class="symbol">&lt;</span><span class="normal"> cs</span><span class="symbol">.</span><span class="function">LinesDisplayed</span><span class="symbol">())</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> yposScreen </span><span class="symbol">&lt;</span><span class="normal"> rcMargin</span><span class="symbol">.</span><span class="normal">bottom</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>

<span class="normal">				</span><span class="function">PLATFORM_ASSERT</span><span class="symbol">(</span><span class="normal">visibleLine </span><span class="symbol">&lt;</span><span class="normal"> cs</span><span class="symbol">.</span><span class="function">LinesDisplayed</span><span class="symbol">());</span>

<span class="normal">				</span><span class="type">int</span><span class="normal"> lineDoc </span><span class="symbol">=</span><span class="normal"> cs</span><span class="symbol">.</span><span class="function">DocFromDisplay</span><span class="symbol">(</span><span class="normal">visibleLine</span><span class="symbol">);</span>
<span class="normal">				</span><span class="function">PLATFORM_ASSERT</span><span class="symbol">(</span><span class="normal">cs</span><span class="symbol">.</span><span class="function">GetVisible</span><span class="symbol">(</span><span class="normal">lineDoc</span><span class="symbol">));</span>
<span class="normal">				</span><span class="type">bool</span><span class="normal"> firstSubLine </span><span class="symbol">=</span><span class="normal"> visibleLine </span><span class="symbol">==</span><span class="normal"> cs</span><span class="symbol">.</span><span class="function">DisplayFromDoc</span><span class="symbol">(</span><span class="normal">lineDoc</span><span class="symbol">);</span>

<span class="normal">				</span><span class="comment">// Decide which fold indicator should be displayed</span>
<span class="normal">				level </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">GetLevel</span><span class="symbol">(</span><span class="normal">lineDoc</span><span class="symbol">);</span>
<span class="normal">				</span><span class="type">int</span><span class="normal"> levelNext </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">GetLevel</span><span class="symbol">(</span><span class="normal">lineDoc </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">				</span><span class="type">int</span><span class="normal"> marks </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">GetMark</span><span class="symbol">(</span><span class="normal">lineDoc</span><span class="symbol">);</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">firstSubLine</span><span class="symbol">)</span>
<span class="normal">					marks </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">				</span><span class="type">int</span><span class="normal"> levelNum </span><span class="symbol">=</span><span class="normal"> level </span><span class="symbol">&amp;</span><span class="normal"> SC_FOLDLEVELNUMBERMASK</span><span class="symbol">;</span>
<span class="normal">				</span><span class="type">int</span><span class="normal"> levelNextNum </span><span class="symbol">=</span><span class="normal"> levelNext </span><span class="symbol">&amp;</span><span class="normal"> SC_FOLDLEVELNUMBERMASK</span><span class="symbol">;</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">level </span><span class="symbol">&amp;</span><span class="normal"> SC_FOLDLEVELHEADERFLAG</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">firstSubLine</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">						</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">cs</span><span class="symbol">.</span><span class="function">GetExpanded</span><span class="symbol">(</span><span class="normal">lineDoc</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">							</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">levelNum </span><span class="symbol">==</span><span class="normal"> SC_FOLDLEVELBASE</span><span class="symbol">)</span>
<span class="normal">								marks </span><span class="symbol">|=</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> SC_MARKNUM_FOLDEROPEN</span><span class="symbol">;</span>
<span class="normal">							</span><span class="keyword">else</span>
<span class="normal">								marks </span><span class="symbol">|=</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> folderOpenMid</span><span class="symbol">;</span>
<span class="normal">						</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">							</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">levelNum </span><span class="symbol">==</span><span class="normal"> SC_FOLDLEVELBASE</span><span class="symbol">)</span>
<span class="normal">								marks </span><span class="symbol">|=</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> SC_MARKNUM_FOLDER</span><span class="symbol">;</span>
<span class="normal">							</span><span class="keyword">else</span>
<span class="normal">								marks </span><span class="symbol">|=</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> folderEnd</span><span class="symbol">;</span>
<span class="normal">						</span><span class="cbracket">}</span>
<span class="normal">					</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">						marks </span><span class="symbol">|=</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> SC_MARKNUM_FOLDERSUB</span><span class="symbol">;</span>
<span class="normal">					</span><span class="cbracket">}</span>
<span class="normal">					needWhiteClosure </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="normal">				</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">level </span><span class="symbol">&amp;</span><span class="normal"> SC_FOLDLEVELWHITEFLAG</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">needWhiteClosure</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">						</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">levelNext </span><span class="symbol">&amp;</span><span class="normal"> SC_FOLDLEVELWHITEFLAG</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">							marks </span><span class="symbol">|=</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> SC_MARKNUM_FOLDERSUB</span><span class="symbol">;</span>
<span class="normal">						</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">levelNum </span><span class="symbol">&gt;</span><span class="normal"> SC_FOLDLEVELBASE</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">							marks </span><span class="symbol">|=</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> SC_MARKNUM_FOLDERMIDTAIL</span><span class="symbol">;</span>
<span class="normal">							needWhiteClosure </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="normal">						</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">							marks </span><span class="symbol">|=</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> SC_MARKNUM_FOLDERTAIL</span><span class="symbol">;</span>
<span class="normal">							needWhiteClosure </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="normal">						</span><span class="cbracket">}</span>
<span class="normal">					</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">levelNum </span><span class="symbol">&gt;</span><span class="normal"> SC_FOLDLEVELBASE</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">						</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">levelNextNum </span><span class="symbol">&lt;</span><span class="normal"> levelNum</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">							</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">levelNextNum </span><span class="symbol">&gt;</span><span class="normal"> SC_FOLDLEVELBASE</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">								marks </span><span class="symbol">|=</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> SC_MARKNUM_FOLDERMIDTAIL</span><span class="symbol">;</span>
<span class="normal">							</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">								marks </span><span class="symbol">|=</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> SC_MARKNUM_FOLDERTAIL</span><span class="symbol">;</span>
<span class="normal">							</span><span class="cbracket">}</span>
<span class="normal">						</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">							marks </span><span class="symbol">|=</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> SC_MARKNUM_FOLDERSUB</span><span class="symbol">;</span>
<span class="normal">						</span><span class="cbracket">}</span>
<span class="normal">					</span><span class="cbracket">}</span>
<span class="normal">				</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">levelNum </span><span class="symbol">&gt;</span><span class="normal"> SC_FOLDLEVELBASE</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">levelNextNum </span><span class="symbol">&lt;</span><span class="normal"> levelNum</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">						needWhiteClosure </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="normal">						</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">levelNext </span><span class="symbol">&amp;</span><span class="normal"> SC_FOLDLEVELWHITEFLAG</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">							marks </span><span class="symbol">|=</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> SC_MARKNUM_FOLDERSUB</span><span class="symbol">;</span>
<span class="normal">							needWhiteClosure </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>
<span class="normal">						</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">levelNextNum </span><span class="symbol">&gt;</span><span class="normal"> SC_FOLDLEVELBASE</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">							marks </span><span class="symbol">|=</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> SC_MARKNUM_FOLDERMIDTAIL</span><span class="symbol">;</span>
<span class="normal">						</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">							marks </span><span class="symbol">|=</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> SC_MARKNUM_FOLDERTAIL</span><span class="symbol">;</span>
<span class="normal">						</span><span class="cbracket">}</span>
<span class="normal">					</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">						marks </span><span class="symbol">|=</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> SC_MARKNUM_FOLDERSUB</span><span class="symbol">;</span>
<span class="normal">					</span><span class="cbracket">}</span>
<span class="normal">				</span><span class="cbracket">}</span>

<span class="normal">				marks </span><span class="symbol">&amp;=</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">ms</span><span class="symbol">[</span><span class="normal">margin</span><span class="symbol">].</span><span class="normal">mask</span><span class="symbol">;</span>
<span class="normal">				</span><span class="usertype">PRectangle</span><span class="normal"> rcMarker </span><span class="symbol">=</span><span class="normal"> rcSelMargin</span><span class="symbol">;</span>
<span class="normal">				rcMarker</span><span class="symbol">.</span><span class="normal">top </span><span class="symbol">=</span><span class="normal"> yposScreen</span><span class="symbol">;</span>
<span class="normal">				rcMarker</span><span class="symbol">.</span><span class="normal">bottom </span><span class="symbol">=</span><span class="normal"> yposScreen </span><span class="symbol">+</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">lineHeight</span><span class="symbol">;</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vs</span><span class="symbol">.</span><span class="normal">ms</span><span class="symbol">[</span><span class="normal">margin</span><span class="symbol">].</span><span class="normal">style </span><span class="symbol">==</span><span class="normal"> SC_MARGIN_NUMBER</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="type">char</span><span class="normal"> number</span><span class="symbol">[</span><span class="number">100</span><span class="symbol">];</span>
<span class="normal">					number</span><span class="symbol">[</span><span class="number">0</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="string">'</span><span class="specialchar">\0</span><span class="string">'</span><span class="symbol">;</span>
<span class="normal">					</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">firstSubLine</span><span class="symbol">)</span>
<span class="normal">						</span><span class="function">sprintf</span><span class="symbol">(</span><span class="normal">number</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%d"</span><span class="symbol">,</span><span class="normal"> lineDoc </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">					</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">foldFlags </span><span class="symbol">&amp;</span><span class="normal"> SC_FOLDFLAG_LEVELNUMBERS</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">						</span><span class="type">int</span><span class="normal"> lev </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">GetLevel</span><span class="symbol">(</span><span class="normal">lineDoc</span><span class="symbol">);</span>
<span class="normal">						</span><span class="function">sprintf</span><span class="symbol">(</span><span class="normal">number</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%c%c %03X %03X"</span><span class="symbol">,</span>
<span class="normal">						        </span><span class="symbol">(</span><span class="normal">lev </span><span class="symbol">&amp;</span><span class="normal"> SC_FOLDLEVELHEADERFLAG</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">?</span><span class="normal"> </span><span class="string">'H'</span><span class="normal"> </span><span class="symbol">:</span><span class="normal"> </span><span class="string">'_'</span><span class="symbol">,</span>
<span class="normal">						        </span><span class="symbol">(</span><span class="normal">lev </span><span class="symbol">&amp;</span><span class="normal"> SC_FOLDLEVELWHITEFLAG</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">?</span><span class="normal"> </span><span class="string">'W'</span><span class="normal"> </span><span class="symbol">:</span><span class="normal"> </span><span class="string">'_'</span><span class="symbol">,</span>
<span class="normal">						        lev </span><span class="symbol">&amp;</span><span class="normal"> SC_FOLDLEVELNUMBERMASK</span><span class="symbol">,</span>
<span class="normal">						        lev </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">16</span>
<span class="normal">						       </span><span class="symbol">);</span>
<span class="normal">					</span><span class="cbracket">}</span>
<span class="normal">					</span><span class="usertype">PRectangle</span><span class="normal"> rcNumber </span><span class="symbol">=</span><span class="normal"> rcMarker</span><span class="symbol">;</span>
<span class="normal">					</span><span class="comment">// Right justify</span>
<span class="normal">					</span><span class="type">int</span><span class="normal"> width </span><span class="symbol">=</span><span class="normal"> surface</span><span class="symbol">-&gt;</span><span class="function">WidthText</span><span class="symbol">(</span><span class="normal">vs</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">STYLE_LINENUMBER</span><span class="symbol">].</span><span class="normal">font</span><span class="symbol">,</span><span class="normal"> number</span><span class="symbol">,</span><span class="normal"> </span><span class="function">istrlen</span><span class="symbol">(</span><span class="normal">number</span><span class="symbol">));</span>
<span class="normal">					</span><span class="type">int</span><span class="normal"> xpos </span><span class="symbol">=</span><span class="normal"> rcNumber</span><span class="symbol">.</span><span class="normal">right </span><span class="symbol">-</span><span class="normal"> width </span><span class="symbol">-</span><span class="normal"> </span><span class="number">3</span><span class="symbol">;</span>
<span class="normal">					rcNumber</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">=</span><span class="normal"> xpos</span><span class="symbol">;</span>
<span class="normal">					surface</span><span class="symbol">-&gt;</span><span class="function">DrawTextNoClip</span><span class="symbol">(</span><span class="normal">rcNumber</span><span class="symbol">,</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">STYLE_LINENUMBER</span><span class="symbol">].</span><span class="normal">font</span><span class="symbol">,</span>
<span class="normal">					        rcNumber</span><span class="symbol">.</span><span class="normal">top </span><span class="symbol">+</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">maxAscent</span><span class="symbol">,</span><span class="normal"> number</span><span class="symbol">,</span><span class="normal"> </span><span class="function">istrlen</span><span class="symbol">(</span><span class="normal">number</span><span class="symbol">),</span>
<span class="normal">					        vs</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">STYLE_LINENUMBER</span><span class="symbol">].</span><span class="normal">fore</span><span class="symbol">.</span><span class="normal">allocated</span><span class="symbol">,</span>
<span class="normal">					        vs</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">STYLE_LINENUMBER</span><span class="symbol">].</span><span class="normal">back</span><span class="symbol">.</span><span class="normal">allocated</span><span class="symbol">);</span>
<span class="normal">				</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vs</span><span class="symbol">.</span><span class="normal">ms</span><span class="symbol">[</span><span class="normal">margin</span><span class="symbol">].</span><span class="normal">style </span><span class="symbol">==</span><span class="normal"> SC_MARGIN_TEXT </span><span class="symbol">||</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">ms</span><span class="symbol">[</span><span class="normal">margin</span><span class="symbol">].</span><span class="normal">style </span><span class="symbol">==</span><span class="normal"> SC_MARGIN_RTEXT</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">firstSubLine</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">						</span><span class="keyword">const</span><span class="normal"> </span><span class="usertype">StyledText</span><span class="normal"> stMargin  </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">MarginStyledText</span><span class="symbol">(</span><span class="normal">lineDoc</span><span class="symbol">);</span>
<span class="normal">						</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">stMargin</span><span class="symbol">.</span><span class="normal">text </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="function">ValidStyledText</span><span class="symbol">(</span><span class="normal">vs</span><span class="symbol">,</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">marginStyleOffset</span><span class="symbol">,</span><span class="normal"> stMargin</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">							surface</span><span class="symbol">-&gt;</span><span class="function">FillRectangle</span><span class="symbol">(</span><span class="normal">rcMarker</span><span class="symbol">,</span><span class="normal"> </span>
<span class="normal">								vs</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">stMargin</span><span class="symbol">.</span><span class="function">StyleAt</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">)+</span><span class="normal">vs</span><span class="symbol">.</span><span class="normal">marginStyleOffset</span><span class="symbol">].</span><span class="normal">back</span><span class="symbol">.</span><span class="normal">allocated</span><span class="symbol">);</span>
<span class="normal">							</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vs</span><span class="symbol">.</span><span class="normal">ms</span><span class="symbol">[</span><span class="normal">margin</span><span class="symbol">].</span><span class="normal">style </span><span class="symbol">==</span><span class="normal"> SC_MARGIN_RTEXT</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">								</span><span class="type">int</span><span class="normal"> width </span><span class="symbol">=</span><span class="normal"> </span><span class="function">WidestLineWidth</span><span class="symbol">(</span><span class="normal">surface</span><span class="symbol">,</span><span class="normal"> vs</span><span class="symbol">,</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">marginStyleOffset</span><span class="symbol">,</span><span class="normal"> stMargin</span><span class="symbol">);</span>
<span class="normal">								rcMarker</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">=</span><span class="normal"> rcMarker</span><span class="symbol">.</span><span class="normal">right </span><span class="symbol">-</span><span class="normal"> width </span><span class="symbol">-</span><span class="normal"> </span><span class="number">3</span><span class="symbol">;</span>
<span class="normal">							</span><span class="cbracket">}</span>
<span class="normal">							</span><span class="function">DrawStyledText</span><span class="symbol">(</span><span class="normal">surface</span><span class="symbol">,</span><span class="normal"> vs</span><span class="symbol">,</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">marginStyleOffset</span><span class="symbol">,</span><span class="normal"> rcMarker</span><span class="symbol">,</span><span class="normal"> rcMarker</span><span class="symbol">.</span><span class="normal">top </span><span class="symbol">+</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">maxAscent</span><span class="symbol">,</span><span class="normal"> </span>
<span class="normal">								stMargin</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> stMargin</span><span class="symbol">.</span><span class="normal">length</span><span class="symbol">);</span>
<span class="normal">						</span><span class="cbracket">}</span>
<span class="normal">					</span><span class="cbracket">}</span>
<span class="normal">				</span><span class="cbracket">}</span>

<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">marks</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="normal"> markBit </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">markBit </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">32</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> marks</span><span class="symbol">;</span><span class="normal"> markBit</span><span class="symbol">++)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">						</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">marks </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">							vs</span><span class="symbol">.</span><span class="normal">markers</span><span class="symbol">[</span><span class="normal">markBit</span><span class="symbol">].</span><span class="function">Draw</span><span class="symbol">(</span><span class="normal">surface</span><span class="symbol">,</span><span class="normal"> rcMarker</span><span class="symbol">,</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">STYLE_LINENUMBER</span><span class="symbol">].</span><span class="normal">font</span><span class="symbol">);</span>
<span class="normal">						</span><span class="cbracket">}</span>
<span class="normal">						marks </span><span class="symbol">&gt;&gt;=</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">					</span><span class="cbracket">}</span>
<span class="normal">				</span><span class="cbracket">}</span>

<span class="normal">				visibleLine</span><span class="symbol">++;</span>
<span class="normal">				yposScreen </span><span class="symbol">+=</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">lineHeight</span><span class="symbol">;</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="usertype">PRectangle</span><span class="normal"> rcBlankMargin </span><span class="symbol">=</span><span class="normal"> rcMargin</span><span class="symbol">;</span>
<span class="normal">	rcBlankMargin</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">=</span><span class="normal"> rcSelMargin</span><span class="symbol">.</span><span class="normal">right</span><span class="symbol">;</span>
<span class="normal">	surface</span><span class="symbol">-&gt;</span><span class="function">FillRectangle</span><span class="symbol">(</span><span class="normal">rcBlankMargin</span><span class="symbol">,</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">STYLE_DEFAULT</span><span class="symbol">].</span><span class="normal">back</span><span class="symbol">.</span><span class="normal">allocated</span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">bufferedDraw</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		surfWindow</span><span class="symbol">-&gt;</span><span class="function">Copy</span><span class="symbol">(</span><span class="normal">rcMargin</span><span class="symbol">,</span><span class="normal"> </span><span class="function">Point</span><span class="symbol">(),</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">pixmapSelMargin</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> </span><span class="function">DrawTabArrow</span><span class="symbol">(</span><span class="usertype">Surface</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">surface</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">PRectangle</span><span class="normal"> rcTab</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> ymid</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> ydiff </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">rcTab</span><span class="symbol">.</span><span class="normal">bottom </span><span class="symbol">-</span><span class="normal"> rcTab</span><span class="symbol">.</span><span class="normal">top</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">/</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> xhead </span><span class="symbol">=</span><span class="normal"> rcTab</span><span class="symbol">.</span><span class="normal">right </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> ydiff</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">xhead </span><span class="symbol">&lt;=</span><span class="normal"> rcTab</span><span class="symbol">.</span><span class="normal">left</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		ydiff </span><span class="symbol">-=</span><span class="normal"> rcTab</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">-</span><span class="normal"> xhead </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">		xhead </span><span class="symbol">=</span><span class="normal"> rcTab</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">rcTab</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">+</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">rcTab</span><span class="symbol">.</span><span class="normal">right </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">))</span>
<span class="normal">		surface</span><span class="symbol">-&gt;</span><span class="function">MoveTo</span><span class="symbol">(</span><span class="normal">rcTab</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">+</span><span class="normal"> </span><span class="number">2</span><span class="symbol">,</span><span class="normal"> ymid</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">else</span>
<span class="normal">		surface</span><span class="symbol">-&gt;</span><span class="function">MoveTo</span><span class="symbol">(</span><span class="normal">rcTab</span><span class="symbol">.</span><span class="normal">right </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span><span class="normal"> ymid</span><span class="symbol">);</span>
<span class="normal">	surface</span><span class="symbol">-&gt;</span><span class="function">LineTo</span><span class="symbol">(</span><span class="normal">rcTab</span><span class="symbol">.</span><span class="normal">right </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span><span class="normal"> ymid</span><span class="symbol">);</span>
<span class="normal">	surface</span><span class="symbol">-&gt;</span><span class="function">LineTo</span><span class="symbol">(</span><span class="normal">xhead</span><span class="symbol">,</span><span class="normal"> ymid </span><span class="symbol">-</span><span class="normal"> ydiff</span><span class="symbol">);</span>
<span class="normal">	surface</span><span class="symbol">-&gt;</span><span class="function">MoveTo</span><span class="symbol">(</span><span class="normal">rcTab</span><span class="symbol">.</span><span class="normal">right </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span><span class="normal"> ymid</span><span class="symbol">);</span>
<span class="normal">	surface</span><span class="symbol">-&gt;</span><span class="function">LineTo</span><span class="symbol">(</span><span class="normal">xhead</span><span class="symbol">,</span><span class="normal"> ymid </span><span class="symbol">+</span><span class="normal"> ydiff</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="usertype">LineLayout</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">Editor</span><span class="symbol">::</span><span class="function">RetrieveLineLayout</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> lineNumber</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> posLineStart </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">lineNumber</span><span class="symbol">);</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> posLineEnd </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">lineNumber </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">	</span><span class="function">PLATFORM_ASSERT</span><span class="symbol">(</span><span class="normal">posLineEnd </span><span class="symbol">&gt;=</span><span class="normal"> posLineStart</span><span class="symbol">);</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> lineCaret </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineFromPosition</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> llc</span><span class="symbol">.</span><span class="function">Retrieve</span><span class="symbol">(</span><span class="normal">lineNumber</span><span class="symbol">,</span><span class="normal"> lineCaret</span><span class="symbol">,</span>
<span class="normal">	        posLineEnd </span><span class="symbol">-</span><span class="normal"> posLineStart</span><span class="symbol">,</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">GetStyleClock</span><span class="symbol">(),</span>
<span class="normal">	        </span><span class="function">LinesOnScreen</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LinesTotal</span><span class="symbol">());</span>
<span class="cbracket">}</span>

<span class="keyword">static</span><span class="normal"> </span><span class="type">bool</span><span class="normal"> </span><span class="function">GoodTrailByte</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> v</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">v </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">0x80</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">v </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">0xc0</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="type">bool</span><span class="normal"> </span><span class="function">BadUTF</span><span class="symbol">(</span><span class="keyword">const</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">s</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> len</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">trailBytes</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">trailBytes</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		trailBytes</span><span class="symbol">--;</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">const</span><span class="normal"> </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">us </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">reinterpret_cast</span><span class="symbol">&lt;</span><span class="keyword">const</span><span class="normal"> </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*&gt;(</span><span class="normal">s</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(*</span><span class="normal">us </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">0x80</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="comment">// Single bytes easy</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(*</span><span class="normal">us </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">0xF4</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="comment">// Characters longer than 4 bytes not possible in current UTF-8</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(*</span><span class="normal">us </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">0xF0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="comment">// 4 bytes</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">len </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">4</span><span class="symbol">)</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">GoodTrailByte</span><span class="symbol">(</span><span class="normal">us</span><span class="symbol">[</span><span class="number">1</span><span class="symbol">])</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="function">GoodTrailByte</span><span class="symbol">(</span><span class="normal">us</span><span class="symbol">[</span><span class="number">2</span><span class="symbol">])</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="function">GoodTrailByte</span><span class="symbol">(</span><span class="normal">us</span><span class="symbol">[</span><span class="number">3</span><span class="symbol">]))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			trailBytes </span><span class="symbol">=</span><span class="normal"> </span><span class="number">3</span><span class="symbol">;</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(*</span><span class="normal">us </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">0xE0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="comment">// 3 bytes</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">len </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">3</span><span class="symbol">)</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">GoodTrailByte</span><span class="symbol">(</span><span class="normal">us</span><span class="symbol">[</span><span class="number">1</span><span class="symbol">])</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="function">GoodTrailByte</span><span class="symbol">(</span><span class="normal">us</span><span class="symbol">[</span><span class="number">2</span><span class="symbol">]))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			trailBytes </span><span class="symbol">=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(*</span><span class="normal">us </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">0xC2</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="comment">// 2 bytes</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">len </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">GoodTrailByte</span><span class="symbol">(</span><span class="normal">us</span><span class="symbol">[</span><span class="number">1</span><span class="symbol">]))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			trailBytes </span><span class="symbol">=</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(*</span><span class="normal">us </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">0xC0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="comment">// Overlong encoding</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="comment">// Trail byte</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="comment">/**</span>
<span class="comment"> * Fill in the LineLayout data for the given line.</span>
<span class="comment"> * Copy the given </span><span class="type">@a</span><span class="comment"> line and its styles from the document into local arrays.</span>
<span class="comment"> * Also determine the x position at which each character starts.</span>
<span class="comment"> */</span>
<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">LayoutLine</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> line</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">Surface</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">surface</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">ViewStyle</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">vstyle</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">LineLayout</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">ll</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> width</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">ll</span><span class="symbol">)</span>
<span class="normal">		</span><span class="keyword">return</span><span class="symbol">;</span>

<span class="normal">	</span><span class="function">PLATFORM_ASSERT</span><span class="symbol">(</span><span class="normal">line </span><span class="symbol">&lt;</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LinesTotal</span><span class="symbol">());</span>
<span class="normal">	</span><span class="function">PLATFORM_ASSERT</span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">chars </span><span class="symbol">!=</span><span class="normal"> NULL</span><span class="symbol">);</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> posLineStart </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">);</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> posLineEnd </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">line </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">	</span><span class="comment">// If the line is very long, limit the treatment to a length that should fit in the viewport</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">posLineEnd </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">posLineStart </span><span class="symbol">+</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">maxLineLength</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		posLineEnd </span><span class="symbol">=</span><span class="normal"> posLineStart </span><span class="symbol">+</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">maxLineLength</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">validity </span><span class="symbol">==</span><span class="normal"> LineLayout</span><span class="symbol">::</span><span class="normal">llCheckTextAndStyle</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> lineLength </span><span class="symbol">=</span><span class="normal"> posLineEnd </span><span class="symbol">-</span><span class="normal"> posLineStart</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">vstyle</span><span class="symbol">.</span><span class="normal">viewEOL</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> cid </span><span class="symbol">=</span><span class="normal"> posLineEnd </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">			</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">cid </span><span class="symbol">&gt;</span><span class="normal"> posLineStart</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="function">IsEOLChar</span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">CharAt</span><span class="symbol">(</span><span class="normal">cid</span><span class="symbol">)))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				cid</span><span class="symbol">--;</span>
<span class="normal">				lineLength</span><span class="symbol">--;</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lineLength </span><span class="symbol">==</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">numCharsInLine</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="comment">// See if chars, styles, indicators, are all the same</span>
<span class="normal">			</span><span class="type">bool</span><span class="normal"> allSame </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>
<span class="normal">			</span><span class="keyword">const</span><span class="normal"> </span><span class="type">int</span><span class="normal"> styleMask </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="normal">stylingBitsMask</span><span class="symbol">;</span>
<span class="normal">			</span><span class="comment">// Check base line layout</span>
<span class="normal">			</span><span class="type">char</span><span class="normal"> styleByte </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> numCharsInLine </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">			</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">numCharsInLine </span><span class="symbol">&lt;</span><span class="normal"> lineLength</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="type">int</span><span class="normal"> charInDoc </span><span class="symbol">=</span><span class="normal"> numCharsInLine </span><span class="symbol">+</span><span class="normal"> posLineStart</span><span class="symbol">;</span>
<span class="normal">				</span><span class="type">char</span><span class="normal"> chDoc </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">CharAt</span><span class="symbol">(</span><span class="normal">charInDoc</span><span class="symbol">);</span>
<span class="normal">				styleByte </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">StyleAt</span><span class="symbol">(</span><span class="normal">charInDoc</span><span class="symbol">);</span>
<span class="normal">				allSame </span><span class="symbol">=</span><span class="normal"> allSame </span><span class="symbol">&amp;&amp;</span>
<span class="normal">				        </span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">numCharsInLine</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="keyword">static_cast</span><span class="symbol">&lt;</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="symbol">&gt;(</span><span class="normal">styleByte </span><span class="symbol">&amp;</span><span class="normal"> styleMask</span><span class="symbol">));</span>
<span class="normal">				allSame </span><span class="symbol">=</span><span class="normal"> allSame </span><span class="symbol">&amp;&amp;</span>
<span class="normal">				        </span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">indicators</span><span class="symbol">[</span><span class="normal">numCharsInLine</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="keyword">static_cast</span><span class="symbol">&lt;</span><span class="type">char</span><span class="symbol">&gt;(</span><span class="normal">styleByte </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="symbol">~</span><span class="normal">styleMask</span><span class="symbol">));</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vstyle</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">numCharsInLine</span><span class="symbol">]].</span><span class="normal">caseForce </span><span class="symbol">==</span><span class="normal"> Style</span><span class="symbol">::</span><span class="normal">caseMixed</span><span class="symbol">)</span>
<span class="normal">					allSame </span><span class="symbol">=</span><span class="normal"> allSame </span><span class="symbol">&amp;&amp;</span>
<span class="normal">					        </span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">chars</span><span class="symbol">[</span><span class="normal">numCharsInLine</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> chDoc</span><span class="symbol">);</span>
<span class="normal">				</span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vstyle</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">numCharsInLine</span><span class="symbol">]].</span><span class="normal">caseForce </span><span class="symbol">==</span><span class="normal"> Style</span><span class="symbol">::</span><span class="normal">caseLower</span><span class="symbol">)</span>
<span class="normal">					allSame </span><span class="symbol">=</span><span class="normal"> allSame </span><span class="symbol">&amp;&amp;</span>
<span class="normal">					        </span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">chars</span><span class="symbol">[</span><span class="normal">numCharsInLine</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="keyword">static_cast</span><span class="symbol">&lt;</span><span class="type">char</span><span class="symbol">&gt;(</span><span class="function">tolower</span><span class="symbol">(</span><span class="normal">chDoc</span><span class="symbol">)));</span>
<span class="normal">				</span><span class="keyword">else</span><span class="normal">	</span><span class="comment">// Style::caseUpper</span>
<span class="normal">					allSame </span><span class="symbol">=</span><span class="normal"> allSame </span><span class="symbol">&amp;&amp;</span>
<span class="normal">					        </span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">chars</span><span class="symbol">[</span><span class="normal">numCharsInLine</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="keyword">static_cast</span><span class="symbol">&lt;</span><span class="type">char</span><span class="symbol">&gt;(</span><span class="function">toupper</span><span class="symbol">(</span><span class="normal">chDoc</span><span class="symbol">)));</span>
<span class="normal">				numCharsInLine</span><span class="symbol">++;</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">			allSame </span><span class="symbol">=</span><span class="normal"> allSame </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">numCharsInLine</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> styleByte</span><span class="symbol">);</span><span class="normal">	</span><span class="comment">// For eolFilled</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">allSame</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				ll</span><span class="symbol">-&gt;</span><span class="normal">validity </span><span class="symbol">=</span><span class="normal"> LineLayout</span><span class="symbol">::</span><span class="normal">llPositions</span><span class="symbol">;</span>
<span class="normal">			</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				ll</span><span class="symbol">-&gt;</span><span class="normal">validity </span><span class="symbol">=</span><span class="normal"> LineLayout</span><span class="symbol">::</span><span class="normal">llInvalid</span><span class="symbol">;</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			ll</span><span class="symbol">-&gt;</span><span class="normal">validity </span><span class="symbol">=</span><span class="normal"> LineLayout</span><span class="symbol">::</span><span class="normal">llInvalid</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">validity </span><span class="symbol">==</span><span class="normal"> LineLayout</span><span class="symbol">::</span><span class="normal">llInvalid</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		ll</span><span class="symbol">-&gt;</span><span class="normal">widthLine </span><span class="symbol">=</span><span class="normal"> LineLayout</span><span class="symbol">::</span><span class="normal">wrapWidthInfinite</span><span class="symbol">;</span>
<span class="normal">		ll</span><span class="symbol">-&gt;</span><span class="normal">lines </span><span class="symbol">=</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> numCharsInLine </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vstyle</span><span class="symbol">.</span><span class="normal">edgeState </span><span class="symbol">==</span><span class="normal"> EDGE_BACKGROUND</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			ll</span><span class="symbol">-&gt;</span><span class="normal">edgeColumn </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">FindColumn</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">,</span><span class="normal"> theEdge</span><span class="symbol">);</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">edgeColumn </span><span class="symbol">&gt;=</span><span class="normal"> posLineStart</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				ll</span><span class="symbol">-&gt;</span><span class="normal">edgeColumn </span><span class="symbol">-=</span><span class="normal"> posLineStart</span><span class="symbol">;</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			ll</span><span class="symbol">-&gt;</span><span class="normal">edgeColumn </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>

<span class="normal">		</span><span class="type">char</span><span class="normal"> styleByte </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> styleMask </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="normal">stylingBitsMask</span><span class="symbol">;</span>
<span class="normal">		ll</span><span class="symbol">-&gt;</span><span class="normal">styleBitsSet </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		</span><span class="comment">// Fill base line layout</span>
<span class="normal">		</span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="normal"> charInDoc </span><span class="symbol">=</span><span class="normal"> posLineStart</span><span class="symbol">;</span><span class="normal"> charInDoc </span><span class="symbol">&lt;</span><span class="normal"> posLineEnd</span><span class="symbol">;</span><span class="normal"> charInDoc</span><span class="symbol">++)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="type">char</span><span class="normal"> chDoc </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">CharAt</span><span class="symbol">(</span><span class="normal">charInDoc</span><span class="symbol">);</span>
<span class="normal">			styleByte </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">StyleAt</span><span class="symbol">(</span><span class="normal">charInDoc</span><span class="symbol">);</span>
<span class="normal">			ll</span><span class="symbol">-&gt;</span><span class="normal">styleBitsSet </span><span class="symbol">|=</span><span class="normal"> styleByte</span><span class="symbol">;</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vstyle</span><span class="symbol">.</span><span class="normal">viewEOL </span><span class="symbol">||</span><span class="normal"> </span><span class="symbol">(!</span><span class="function">IsEOLChar</span><span class="symbol">(</span><span class="normal">chDoc</span><span class="symbol">)))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				ll</span><span class="symbol">-&gt;</span><span class="normal">chars</span><span class="symbol">[</span><span class="normal">numCharsInLine</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> chDoc</span><span class="symbol">;</span>
<span class="normal">				ll</span><span class="symbol">-&gt;</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">numCharsInLine</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">static_cast</span><span class="symbol">&lt;</span><span class="type">char</span><span class="symbol">&gt;(</span><span class="normal">styleByte </span><span class="symbol">&amp;</span><span class="normal"> styleMask</span><span class="symbol">);</span>
<span class="normal">				ll</span><span class="symbol">-&gt;</span><span class="normal">indicators</span><span class="symbol">[</span><span class="normal">numCharsInLine</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">static_cast</span><span class="symbol">&lt;</span><span class="type">char</span><span class="symbol">&gt;(</span><span class="normal">styleByte </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="symbol">~</span><span class="normal">styleMask</span><span class="symbol">);</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vstyle</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">numCharsInLine</span><span class="symbol">]].</span><span class="normal">caseForce </span><span class="symbol">==</span><span class="normal"> Style</span><span class="symbol">::</span><span class="normal">caseUpper</span><span class="symbol">)</span>
<span class="normal">					ll</span><span class="symbol">-&gt;</span><span class="normal">chars</span><span class="symbol">[</span><span class="normal">numCharsInLine</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">static_cast</span><span class="symbol">&lt;</span><span class="type">char</span><span class="symbol">&gt;(</span><span class="function">toupper</span><span class="symbol">(</span><span class="normal">chDoc</span><span class="symbol">));</span>
<span class="normal">				</span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vstyle</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">numCharsInLine</span><span class="symbol">]].</span><span class="normal">caseForce </span><span class="symbol">==</span><span class="normal"> Style</span><span class="symbol">::</span><span class="normal">caseLower</span><span class="symbol">)</span>
<span class="normal">					ll</span><span class="symbol">-&gt;</span><span class="normal">chars</span><span class="symbol">[</span><span class="normal">numCharsInLine</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">static_cast</span><span class="symbol">&lt;</span><span class="type">char</span><span class="symbol">&gt;(</span><span class="function">tolower</span><span class="symbol">(</span><span class="normal">chDoc</span><span class="symbol">));</span>
<span class="normal">				numCharsInLine</span><span class="symbol">++;</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		ll</span><span class="symbol">-&gt;</span><span class="normal">xHighlightGuide </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		</span><span class="comment">// Extra element at the end of the line to hold end x position and act as</span>
<span class="normal">		ll</span><span class="symbol">-&gt;</span><span class="normal">chars</span><span class="symbol">[</span><span class="normal">numCharsInLine</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal">   </span><span class="comment">// Also triggers processing in the loops as this is a control character</span>
<span class="normal">		ll</span><span class="symbol">-&gt;</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">numCharsInLine</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> styleByte</span><span class="symbol">;</span><span class="normal">	</span><span class="comment">// For eolFilled</span>
<span class="normal">		ll</span><span class="symbol">-&gt;</span><span class="normal">indicators</span><span class="symbol">[</span><span class="normal">numCharsInLine</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">		</span><span class="comment">// Layout the line, determining the position of each character,</span>
<span class="normal">		</span><span class="comment">// with an extra element at the end for the end of the line.</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> startseg </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal">	</span><span class="comment">// Start of the current segment, in char. number</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> startsegx </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal">	</span><span class="comment">// Start of the current segment, in pixels</span>
<span class="normal">		ll</span><span class="symbol">-&gt;</span><span class="normal">positions</span><span class="symbol">[</span><span class="number">0</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> tabWidth </span><span class="symbol">=</span><span class="normal"> vstyle</span><span class="symbol">.</span><span class="normal">spaceWidth </span><span class="symbol">*</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="normal">tabInChars</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">bool</span><span class="normal"> lastSegItalics </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="normal">		</span><span class="usertype">Font</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">ctrlCharsFont </span><span class="symbol">=</span><span class="normal"> vstyle</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">STYLE_CONTROLCHAR</span><span class="symbol">].</span><span class="normal">font</span><span class="symbol">;</span>

<span class="normal">		</span><span class="type">int</span><span class="normal"> ctrlCharWidth</span><span class="symbol">[</span><span class="number">32</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="cbracket">{</span><span class="number">0</span><span class="cbracket">}</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">bool</span><span class="normal"> isControlNext </span><span class="symbol">=</span><span class="normal"> </span><span class="function">IsControlCharacter</span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">chars</span><span class="symbol">[</span><span class="number">0</span><span class="symbol">]);</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> trailBytes </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">bool</span><span class="normal"> isBadUTFNext </span><span class="symbol">=</span><span class="normal"> </span><span class="function">IsUnicodeMode</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="function">BadUTF</span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">chars</span><span class="symbol">,</span><span class="normal"> numCharsInLine</span><span class="symbol">,</span><span class="normal"> trailBytes</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="normal"> charInLine </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> charInLine </span><span class="symbol">&lt;</span><span class="normal"> numCharsInLine</span><span class="symbol">;</span><span class="normal"> charInLine</span><span class="symbol">++)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="type">bool</span><span class="normal"> isControl </span><span class="symbol">=</span><span class="normal"> isControlNext</span><span class="symbol">;</span>
<span class="normal">			isControlNext </span><span class="symbol">=</span><span class="normal"> </span><span class="function">IsControlCharacter</span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">chars</span><span class="symbol">[</span><span class="normal">charInLine </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">]);</span>
<span class="normal">			</span><span class="type">bool</span><span class="normal"> isBadUTF </span><span class="symbol">=</span><span class="normal"> isBadUTFNext</span><span class="symbol">;</span>
<span class="normal">			isBadUTFNext </span><span class="symbol">=</span><span class="normal"> </span><span class="function">IsUnicodeMode</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="function">BadUTF</span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">chars </span><span class="symbol">+</span><span class="normal"> charInLine </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span><span class="normal"> numCharsInLine </span><span class="symbol">-</span><span class="normal"> charInLine </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span><span class="normal"> trailBytes</span><span class="symbol">);</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">charInLine</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">charInLine </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">])</span><span class="normal"> </span><span class="symbol">||</span>
<span class="normal">			        isControl </span><span class="symbol">||</span><span class="normal"> isControlNext </span><span class="symbol">||</span><span class="normal"> isBadUTF </span><span class="symbol">||</span><span class="normal"> isBadUTFNext</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				ll</span><span class="symbol">-&gt;</span><span class="normal">positions</span><span class="symbol">[</span><span class="normal">startseg</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vstyle</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">charInLine</span><span class="symbol">]].</span><span class="normal">visible</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">isControl</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">						</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">chars</span><span class="symbol">[</span><span class="normal">charInLine</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="string">'</span><span class="specialchar">\t</span><span class="string">'</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">							ll</span><span class="symbol">-&gt;</span><span class="normal">positions</span><span class="symbol">[</span><span class="normal">charInLine </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">((((</span><span class="normal">startsegx </span><span class="symbol">+</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">/</span>
<span class="normal">							        tabWidth</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> tabWidth</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> startsegx</span><span class="symbol">;</span>
<span class="normal">						</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">controlCharSymbol </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">32</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">							</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ctrlCharWidth</span><span class="symbol">[</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">chars</span><span class="symbol">[</span><span class="normal">charInLine</span><span class="symbol">]]</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">								</span><span class="keyword">const</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">ctrlChar </span><span class="symbol">=</span><span class="normal"> </span><span class="function">ControlCharacterString</span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">chars</span><span class="symbol">[</span><span class="normal">charInLine</span><span class="symbol">]);</span>
<span class="normal">								</span><span class="comment">// +3 For a blank on front and rounded edge each side:</span>
<span class="normal">								ctrlCharWidth</span><span class="symbol">[</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">chars</span><span class="symbol">[</span><span class="normal">charInLine</span><span class="symbol">]]</span><span class="normal"> </span><span class="symbol">=</span>
<span class="normal">								    surface</span><span class="symbol">-&gt;</span><span class="function">WidthText</span><span class="symbol">(</span><span class="normal">ctrlCharsFont</span><span class="symbol">,</span><span class="normal"> ctrlChar</span><span class="symbol">,</span><span class="normal"> </span><span class="function">istrlen</span><span class="symbol">(</span><span class="normal">ctrlChar</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="number">3</span><span class="symbol">;</span>
<span class="normal">							</span><span class="cbracket">}</span>
<span class="normal">							ll</span><span class="symbol">-&gt;</span><span class="normal">positions</span><span class="symbol">[</span><span class="normal">charInLine </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> ctrlCharWidth</span><span class="symbol">[</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">chars</span><span class="symbol">[</span><span class="normal">charInLine</span><span class="symbol">]];</span>
<span class="normal">						</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">							</span><span class="type">char</span><span class="normal"> cc</span><span class="symbol">[</span><span class="number">2</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal"> </span><span class="keyword">static_cast</span><span class="symbol">&lt;</span><span class="type">char</span><span class="symbol">&gt;(</span><span class="normal">controlCharSymbol</span><span class="symbol">),</span><span class="normal"> </span><span class="string">'</span><span class="specialchar">\0</span><span class="string">'</span><span class="normal"> </span><span class="cbracket">}</span><span class="symbol">;</span>
<span class="normal">							surface</span><span class="symbol">-&gt;</span><span class="function">MeasureWidths</span><span class="symbol">(</span><span class="normal">ctrlCharsFont</span><span class="symbol">,</span><span class="normal"> cc</span><span class="symbol">,</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span>
<span class="normal">							        ll</span><span class="symbol">-&gt;</span><span class="normal">positions </span><span class="symbol">+</span><span class="normal"> startseg </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">						</span><span class="cbracket">}</span>
<span class="normal">						lastSegItalics </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="normal">					</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">isBadUTF</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">						</span><span class="type">char</span><span class="normal"> hexits</span><span class="symbol">[</span><span class="number">3</span><span class="symbol">];</span>
<span class="normal">						</span><span class="function">sprintf</span><span class="symbol">(</span><span class="normal">hexits</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%2X"</span><span class="symbol">,</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">chars</span><span class="symbol">[</span><span class="normal">charInLine</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">						ll</span><span class="symbol">-&gt;</span><span class="normal">positions</span><span class="symbol">[</span><span class="normal">charInLine </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span>
<span class="normal">						    surface</span><span class="symbol">-&gt;</span><span class="function">WidthText</span><span class="symbol">(</span><span class="normal">ctrlCharsFont</span><span class="symbol">,</span><span class="normal"> hexits</span><span class="symbol">,</span><span class="normal"> </span><span class="function">istrlen</span><span class="symbol">(</span><span class="normal">hexits</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="number">3</span><span class="symbol">;</span>
<span class="normal">					</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal">	</span><span class="comment">// Regular character</span>
<span class="normal">						</span><span class="type">int</span><span class="normal"> lenSeg </span><span class="symbol">=</span><span class="normal"> charInLine </span><span class="symbol">-</span><span class="normal"> startseg </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">						</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">lenSeg </span><span class="symbol">==</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="string">' '</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">chars</span><span class="symbol">[</span><span class="normal">startseg</span><span class="symbol">]))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">							lastSegItalics </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="normal">							</span><span class="comment">// Over half the segments are single characters and of these about half are space characters.</span>
<span class="normal">							ll</span><span class="symbol">-&gt;</span><span class="normal">positions</span><span class="symbol">[</span><span class="normal">charInLine </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> vstyle</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">charInLine</span><span class="symbol">]].</span><span class="normal">spaceWidth</span><span class="symbol">;</span>
<span class="normal">						</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">							lastSegItalics </span><span class="symbol">=</span><span class="normal"> vstyle</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">charInLine</span><span class="symbol">]].</span><span class="normal">italic</span><span class="symbol">;</span>
<span class="normal">							posCache</span><span class="symbol">.</span><span class="function">MeasureWidths</span><span class="symbol">(</span><span class="normal">surface</span><span class="symbol">,</span><span class="normal"> vstyle</span><span class="symbol">,</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">charInLine</span><span class="symbol">],</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">chars </span><span class="symbol">+</span><span class="normal"> startseg</span><span class="symbol">,</span>
<span class="normal">							        lenSeg</span><span class="symbol">,</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">positions </span><span class="symbol">+</span><span class="normal"> startseg </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">						</span><span class="cbracket">}</span>
<span class="normal">					</span><span class="cbracket">}</span>
<span class="normal">				</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal">    </span><span class="comment">// invisible</span>
<span class="normal">					</span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="normal"> posToZero </span><span class="symbol">=</span><span class="normal"> startseg</span><span class="symbol">;</span><span class="normal"> posToZero </span><span class="symbol">&lt;=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">charInLine </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span><span class="normal"> posToZero</span><span class="symbol">++)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">						ll</span><span class="symbol">-&gt;</span><span class="normal">positions</span><span class="symbol">[</span><span class="normal">posToZero</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">					</span><span class="cbracket">}</span>
<span class="normal">				</span><span class="cbracket">}</span>
<span class="normal">				</span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="normal"> posToIncrease </span><span class="symbol">=</span><span class="normal"> startseg</span><span class="symbol">;</span><span class="normal"> posToIncrease </span><span class="symbol">&lt;=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">charInLine </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span><span class="normal"> posToIncrease</span><span class="symbol">++)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					ll</span><span class="symbol">-&gt;</span><span class="normal">positions</span><span class="symbol">[</span><span class="normal">posToIncrease</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">+=</span><span class="normal"> startsegx</span><span class="symbol">;</span>
<span class="normal">				</span><span class="cbracket">}</span>
<span class="normal">				startsegx </span><span class="symbol">=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">positions</span><span class="symbol">[</span><span class="normal">charInLine </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">];</span>
<span class="normal">				startseg </span><span class="symbol">=</span><span class="normal"> charInLine </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="comment">// Small hack to make lines that end with italics not cut off the edge of the last character</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">startseg </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> lastSegItalics</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			ll</span><span class="symbol">-&gt;</span><span class="normal">positions</span><span class="symbol">[</span><span class="normal">startseg</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		ll</span><span class="symbol">-&gt;</span><span class="normal">numCharsInLine </span><span class="symbol">=</span><span class="normal"> numCharsInLine</span><span class="symbol">;</span>
<span class="normal">		ll</span><span class="symbol">-&gt;</span><span class="normal">validity </span><span class="symbol">=</span><span class="normal"> LineLayout</span><span class="symbol">::</span><span class="normal">llPositions</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="comment">// Hard to cope when too narrow, so just assume there is space</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">20</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		width </span><span class="symbol">=</span><span class="normal"> </span><span class="number">20</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">validity </span><span class="symbol">==</span><span class="normal"> LineLayout</span><span class="symbol">::</span><span class="normal">llPositions</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">widthLine </span><span class="symbol">!=</span><span class="normal"> width</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		ll</span><span class="symbol">-&gt;</span><span class="normal">widthLine </span><span class="symbol">=</span><span class="normal"> width</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width </span><span class="symbol">==</span><span class="normal"> LineLayout</span><span class="symbol">::</span><span class="normal">wrapWidthInfinite</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			ll</span><span class="symbol">-&gt;</span><span class="normal">lines </span><span class="symbol">=</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">width </span><span class="symbol">&gt;</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">positions</span><span class="symbol">[</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">numCharsInLine</span><span class="symbol">])</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="comment">// Simple common case where line does not need wrapping.</span>
<span class="normal">			ll</span><span class="symbol">-&gt;</span><span class="normal">lines </span><span class="symbol">=</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">wrapVisualFlags </span><span class="symbol">&amp;</span><span class="normal"> SC_WRAPVISUALFLAG_END</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				width </span><span class="symbol">-=</span><span class="normal"> vstyle</span><span class="symbol">.</span><span class="normal">aveCharWidth</span><span class="symbol">;</span><span class="normal"> </span><span class="comment">// take into account the space for end wrap mark</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">			ll</span><span class="symbol">-&gt;</span><span class="normal">wrapIndent </span><span class="symbol">=</span><span class="normal"> wrapAddIndent</span><span class="symbol">;</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">wrapIndentMode </span><span class="symbol">!=</span><span class="normal"> SC_WRAPINDENT_FIXED</span><span class="symbol">)</span>
<span class="normal">				</span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="normal"> i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">numCharsInLine</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="function">IsSpaceOrTab</span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">chars</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">						ll</span><span class="symbol">-&gt;</span><span class="normal">wrapIndent </span><span class="symbol">+=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">positions</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">];</span><span class="normal"> </span><span class="comment">// Add line indent</span>
<span class="normal">						</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">					</span><span class="cbracket">}</span>
<span class="normal">				</span><span class="cbracket">}</span>
<span class="normal">			</span><span class="comment">// Check for text width minimum</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">wrapIndent </span><span class="symbol">&gt;</span><span class="normal"> width </span><span class="symbol">-</span><span class="normal"> </span><span class="keyword">static_cast</span><span class="symbol">&lt;</span><span class="type">int</span><span class="symbol">&gt;(</span><span class="normal">vstyle</span><span class="symbol">.</span><span class="normal">aveCharWidth</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> </span><span class="number">15</span><span class="symbol">)</span>
<span class="normal">				ll</span><span class="symbol">-&gt;</span><span class="normal">wrapIndent </span><span class="symbol">=</span><span class="normal"> wrapAddIndent</span><span class="symbol">;</span>
<span class="normal">			</span><span class="comment">// Check for wrapIndent minimum</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">wrapVisualFlags </span><span class="symbol">&amp;</span><span class="normal"> SC_WRAPVISUALFLAG_START</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">wrapIndent </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="keyword">static_cast</span><span class="symbol">&lt;</span><span class="type">int</span><span class="symbol">&gt;(</span><span class="normal">vstyle</span><span class="symbol">.</span><span class="normal">aveCharWidth</span><span class="symbol">)))</span>
<span class="normal">				ll</span><span class="symbol">-&gt;</span><span class="normal">wrapIndent </span><span class="symbol">=</span><span class="normal"> vstyle</span><span class="symbol">.</span><span class="normal">aveCharWidth</span><span class="symbol">;</span><span class="normal"> </span><span class="comment">// Indent to show start visual</span>
<span class="normal">			ll</span><span class="symbol">-&gt;</span><span class="normal">lines </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">			</span><span class="comment">// Calculate line start positions based upon width.</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> lastGoodBreak </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> lastLineStart </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> startOffset </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> p </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">			</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">p </span><span class="symbol">&lt;</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">numCharsInLine</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">positions</span><span class="symbol">[</span><span class="normal">p </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> startOffset</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;=</span><span class="normal"> width</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lastGoodBreak </span><span class="symbol">==</span><span class="normal"> lastLineStart</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">						</span><span class="comment">// Try moving to start of last character</span>
<span class="normal">						</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">p </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">							lastGoodBreak </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">MovePositionOutsideChar</span><span class="symbol">(</span><span class="normal">p </span><span class="symbol">+</span><span class="normal"> posLineStart</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">)</span>
<span class="normal">							        </span><span class="symbol">-</span><span class="normal"> posLineStart</span><span class="symbol">;</span>
<span class="normal">						</span><span class="cbracket">}</span>
<span class="normal">						</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lastGoodBreak </span><span class="symbol">==</span><span class="normal"> lastLineStart</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">							</span><span class="comment">// Ensure at least one character on line.</span>
<span class="normal">							lastGoodBreak </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">MovePositionOutsideChar</span><span class="symbol">(</span><span class="normal">lastGoodBreak </span><span class="symbol">+</span><span class="normal"> posLineStart </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span>
<span class="normal">							        </span><span class="symbol">-</span><span class="normal"> posLineStart</span><span class="symbol">;</span>
<span class="normal">						</span><span class="cbracket">}</span>
<span class="normal">					</span><span class="cbracket">}</span>
<span class="normal">					lastLineStart </span><span class="symbol">=</span><span class="normal"> lastGoodBreak</span><span class="symbol">;</span>
<span class="normal">					ll</span><span class="symbol">-&gt;</span><span class="normal">lines</span><span class="symbol">++;</span>
<span class="normal">					ll</span><span class="symbol">-&gt;</span><span class="function">SetLineStart</span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">lines</span><span class="symbol">,</span><span class="normal"> lastGoodBreak</span><span class="symbol">);</span>
<span class="normal">					startOffset </span><span class="symbol">=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">positions</span><span class="symbol">[</span><span class="normal">lastGoodBreak</span><span class="symbol">];</span>
<span class="normal">					</span><span class="comment">// take into account the space for start wrap mark and indent</span>
<span class="normal">					startOffset </span><span class="symbol">-=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">wrapIndent</span><span class="symbol">;</span>
<span class="normal">					p </span><span class="symbol">=</span><span class="normal"> lastGoodBreak </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">					</span><span class="keyword">continue</span><span class="symbol">;</span>
<span class="normal">				</span><span class="cbracket">}</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">p </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">wrapState </span><span class="symbol">==</span><span class="normal"> eWrapChar</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">						lastGoodBreak </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">MovePositionOutsideChar</span><span class="symbol">(</span><span class="normal">p </span><span class="symbol">+</span><span class="normal"> posLineStart</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">)</span>
<span class="normal">						        </span><span class="symbol">-</span><span class="normal"> posLineStart</span><span class="symbol">;</span>
<span class="normal">						p </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">MovePositionOutsideChar</span><span class="symbol">(</span><span class="normal">p </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> posLineStart</span><span class="symbol">,</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> posLineStart</span><span class="symbol">;</span>
<span class="normal">						</span><span class="keyword">continue</span><span class="symbol">;</span>
<span class="normal">					</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">p</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">p </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">])</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">						lastGoodBreak </span><span class="symbol">=</span><span class="normal"> p</span><span class="symbol">;</span>
<span class="normal">					</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">IsSpaceOrTab</span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">chars</span><span class="symbol">[</span><span class="normal">p </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">])</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">!</span><span class="function">IsSpaceOrTab</span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">chars</span><span class="symbol">[</span><span class="normal">p</span><span class="symbol">]))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">						lastGoodBreak </span><span class="symbol">=</span><span class="normal"> p</span><span class="symbol">;</span>
<span class="normal">					</span><span class="cbracket">}</span>
<span class="normal">				</span><span class="cbracket">}</span>
<span class="normal">				p</span><span class="symbol">++;</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">			ll</span><span class="symbol">-&gt;</span><span class="normal">lines</span><span class="symbol">++;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		ll</span><span class="symbol">-&gt;</span><span class="normal">validity </span><span class="symbol">=</span><span class="normal"> LineLayout</span><span class="symbol">::</span><span class="normal">llLines</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="usertype">ColourAllocated</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">SelectionBackground</span><span class="symbol">(</span><span class="usertype">ViewStyle</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">vsDraw</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> primarySelection </span><span class="symbol">?</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">selbackground</span><span class="symbol">.</span><span class="normal">allocated </span><span class="symbol">:</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">selbackground2</span><span class="symbol">.</span><span class="normal">allocated</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="usertype">ColourAllocated</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">TextBackground</span><span class="symbol">(</span><span class="usertype">ViewStyle</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">vsDraw</span><span class="symbol">,</span><span class="normal"> </span><span class="type">bool</span><span class="normal"> overrideBackground</span><span class="symbol">,</span>
<span class="normal">        </span><span class="usertype">ColourAllocated</span><span class="normal"> background</span><span class="symbol">,</span><span class="normal"> </span><span class="type">bool</span><span class="normal"> inSelection</span><span class="symbol">,</span><span class="normal"> </span><span class="type">bool</span><span class="normal"> inHotspot</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> styleMain</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> i</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">LineLayout</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">ll</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">inSelection</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vsDraw</span><span class="symbol">.</span><span class="normal">selbackset </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vsDraw</span><span class="symbol">.</span><span class="normal">selAlpha </span><span class="symbol">==</span><span class="normal"> SC_ALPHA_NOALPHA</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> </span><span class="function">SelectionBackground</span><span class="symbol">(</span><span class="normal">vsDraw</span><span class="symbol">);</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">vsDraw</span><span class="symbol">.</span><span class="normal">edgeState </span><span class="symbol">==</span><span class="normal"> EDGE_BACKGROUND</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span>
<span class="normal">		        </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">&gt;=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">edgeColumn</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span>
<span class="normal">		        </span><span class="symbol">!</span><span class="function">IsEOLChar</span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">chars</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]))</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">edgecolour</span><span class="symbol">.</span><span class="normal">allocated</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">inHotspot </span><span class="symbol">&amp;&amp;</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">hotspotBackgroundSet</span><span class="symbol">)</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">hotspotBackground</span><span class="symbol">.</span><span class="normal">allocated</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">overrideBackground </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">styleMain </span><span class="symbol">!=</span><span class="normal"> STYLE_BRACELIGHT</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">styleMain </span><span class="symbol">!=</span><span class="normal"> STYLE_BRACEBAD</span><span class="symbol">))</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> background</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">styleMain</span><span class="symbol">].</span><span class="normal">back</span><span class="symbol">.</span><span class="normal">allocated</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">DrawIndentGuide</span><span class="symbol">(</span><span class="usertype">Surface</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">surface</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> lineVisible</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> lineHeight</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> start</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">PRectangle</span><span class="normal"> rcSegment</span><span class="symbol">,</span><span class="normal"> </span><span class="type">bool</span><span class="normal"> highlight</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="usertype">Point</span><span class="normal"> </span><span class="function">from</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">lineVisible </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lineHeight </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">?</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">:</span><span class="normal"> </span><span class="number">0</span><span class="symbol">);</span>
<span class="normal">	</span><span class="usertype">PRectangle</span><span class="normal"> </span><span class="function">rcCopyArea</span><span class="symbol">(</span><span class="normal">start </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span><span class="normal"> rcSegment</span><span class="symbol">.</span><span class="normal">top</span><span class="symbol">,</span><span class="normal"> start </span><span class="symbol">+</span><span class="normal"> </span><span class="number">2</span><span class="symbol">,</span><span class="normal"> rcSegment</span><span class="symbol">.</span><span class="normal">bottom</span><span class="symbol">);</span>
<span class="normal">	surface</span><span class="symbol">-&gt;</span><span class="function">Copy</span><span class="symbol">(</span><span class="normal">rcCopyArea</span><span class="symbol">,</span><span class="normal"> from</span><span class="symbol">,</span>
<span class="normal">	        highlight </span><span class="symbol">?</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">pixmapIndentGuideHighlight </span><span class="symbol">:</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">pixmapIndentGuide</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">DrawWrapMarker</span><span class="symbol">(</span><span class="usertype">Surface</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">surface</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">PRectangle</span><span class="normal"> rcPlace</span><span class="symbol">,</span>
<span class="normal">        </span><span class="type">bool</span><span class="normal"> isEndMarker</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">ColourAllocated</span><span class="normal"> wrapColour</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	surface</span><span class="symbol">-&gt;</span><span class="function">PenColour</span><span class="symbol">(</span><span class="normal">wrapColour</span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">enum</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal"> xa </span><span class="symbol">=</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="cbracket">}</span><span class="symbol">;</span><span class="normal"> </span><span class="comment">// gap before start</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> w </span><span class="symbol">=</span><span class="normal"> rcPlace</span><span class="symbol">.</span><span class="normal">right </span><span class="symbol">-</span><span class="normal"> rcPlace</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">-</span><span class="normal"> xa </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>

<span class="normal">	</span><span class="type">bool</span><span class="normal"> xStraight </span><span class="symbol">=</span><span class="normal"> isEndMarker</span><span class="symbol">;</span><span class="normal">  </span><span class="comment">// x-mirrored symbol for start marker</span>
<span class="normal">	</span><span class="type">bool</span><span class="normal"> yStraight </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>
<span class="normal">	</span><span class="comment">//bool yStraight= isEndMarker; // comment in for start marker y-mirrowed</span>

<span class="normal">	</span><span class="type">int</span><span class="normal"> x0 </span><span class="symbol">=</span><span class="normal"> xStraight </span><span class="symbol">?</span><span class="normal"> rcPlace</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">:</span><span class="normal"> rcPlace</span><span class="symbol">.</span><span class="normal">right </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> y0 </span><span class="symbol">=</span><span class="normal"> yStraight </span><span class="symbol">?</span><span class="normal"> rcPlace</span><span class="symbol">.</span><span class="normal">top </span><span class="symbol">:</span><span class="normal"> rcPlace</span><span class="symbol">.</span><span class="normal">bottom </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>

<span class="normal">	</span><span class="type">int</span><span class="normal"> dy </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">rcPlace</span><span class="symbol">.</span><span class="normal">bottom </span><span class="symbol">-</span><span class="normal"> rcPlace</span><span class="symbol">.</span><span class="normal">top</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">/</span><span class="normal"> </span><span class="number">5</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> y </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">rcPlace</span><span class="symbol">.</span><span class="normal">bottom </span><span class="symbol">-</span><span class="normal"> rcPlace</span><span class="symbol">.</span><span class="normal">top</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">/</span><span class="normal"> </span><span class="number">2</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> dy</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">Relative</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="usertype">Surface</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">surface</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> xBase</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> xDir</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> yBase</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> yDir</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">void</span><span class="normal"> </span><span class="function">MoveTo</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> xRelative</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> yRelative</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			surface</span><span class="symbol">-&gt;</span><span class="function">MoveTo</span><span class="symbol">(</span><span class="normal">xBase </span><span class="symbol">+</span><span class="normal"> xDir </span><span class="symbol">*</span><span class="normal"> xRelative</span><span class="symbol">,</span><span class="normal"> yBase </span><span class="symbol">+</span><span class="normal"> yDir </span><span class="symbol">*</span><span class="normal"> yRelative</span><span class="symbol">);</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="type">void</span><span class="normal"> </span><span class="function">LineTo</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> xRelative</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> yRelative</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			surface</span><span class="symbol">-&gt;</span><span class="function">LineTo</span><span class="symbol">(</span><span class="normal">xBase </span><span class="symbol">+</span><span class="normal"> xDir </span><span class="symbol">*</span><span class="normal"> xRelative</span><span class="symbol">,</span><span class="normal"> yBase </span><span class="symbol">+</span><span class="normal"> yDir </span><span class="symbol">*</span><span class="normal"> yRelative</span><span class="symbol">);</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">Relative</span><span class="normal"> rel </span><span class="symbol">=</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal">surface</span><span class="symbol">,</span><span class="normal"> x0</span><span class="symbol">,</span><span class="normal"> xStraight </span><span class="symbol">?</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">:</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> y0</span><span class="symbol">,</span><span class="normal"> yStraight </span><span class="symbol">?</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">:</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="cbracket">}</span><span class="symbol">;</span>

<span class="normal">	</span><span class="comment">// arrow head</span>
<span class="normal">	rel</span><span class="symbol">.</span><span class="function">MoveTo</span><span class="symbol">(</span><span class="normal">xa</span><span class="symbol">,</span><span class="normal"> y</span><span class="symbol">);</span>
<span class="normal">	rel</span><span class="symbol">.</span><span class="function">LineTo</span><span class="symbol">(</span><span class="normal">xa </span><span class="symbol">+</span><span class="normal"> </span><span class="number">2</span><span class="symbol">*</span><span class="normal">w </span><span class="symbol">/</span><span class="normal"> </span><span class="number">3</span><span class="symbol">,</span><span class="normal"> y </span><span class="symbol">-</span><span class="normal"> dy</span><span class="symbol">);</span>
<span class="normal">	rel</span><span class="symbol">.</span><span class="function">MoveTo</span><span class="symbol">(</span><span class="normal">xa</span><span class="symbol">,</span><span class="normal"> y</span><span class="symbol">);</span>
<span class="normal">	rel</span><span class="symbol">.</span><span class="function">LineTo</span><span class="symbol">(</span><span class="normal">xa </span><span class="symbol">+</span><span class="normal"> </span><span class="number">2</span><span class="symbol">*</span><span class="normal">w </span><span class="symbol">/</span><span class="normal"> </span><span class="number">3</span><span class="symbol">,</span><span class="normal"> y </span><span class="symbol">+</span><span class="normal"> dy</span><span class="symbol">);</span>

<span class="normal">	</span><span class="comment">// arrow body</span>
<span class="normal">	rel</span><span class="symbol">.</span><span class="function">MoveTo</span><span class="symbol">(</span><span class="normal">xa</span><span class="symbol">,</span><span class="normal"> y</span><span class="symbol">);</span>
<span class="normal">	rel</span><span class="symbol">.</span><span class="function">LineTo</span><span class="symbol">(</span><span class="normal">xa </span><span class="symbol">+</span><span class="normal"> w</span><span class="symbol">,</span><span class="normal"> y</span><span class="symbol">);</span>
<span class="normal">	rel</span><span class="symbol">.</span><span class="function">LineTo</span><span class="symbol">(</span><span class="normal">xa </span><span class="symbol">+</span><span class="normal"> w</span><span class="symbol">,</span><span class="normal"> y </span><span class="symbol">-</span><span class="normal"> </span><span class="number">2</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> dy</span><span class="symbol">);</span>
<span class="normal">	rel</span><span class="symbol">.</span><span class="function">LineTo</span><span class="symbol">(</span><span class="normal">xa </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span><span class="normal">   </span><span class="comment">// on windows lineto is exclusive endpoint, perhaps GTK not...</span>
<span class="normal">	        y </span><span class="symbol">-</span><span class="normal"> </span><span class="number">2</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> dy</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="keyword">static</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="function">SimpleAlphaRectangle</span><span class="symbol">(</span><span class="usertype">Surface</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">surface</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">PRectangle</span><span class="normal"> rc</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">ColourAllocated</span><span class="normal"> fill</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> alpha</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">alpha </span><span class="symbol">!=</span><span class="normal"> SC_ALPHA_NOALPHA</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		surface</span><span class="symbol">-&gt;</span><span class="function">AlphaRectangle</span><span class="symbol">(</span><span class="normal">rc</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> fill</span><span class="symbol">,</span><span class="normal"> alpha</span><span class="symbol">,</span><span class="normal"> fill</span><span class="symbol">,</span><span class="normal"> alpha</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> </span><span class="function">DrawTextBlob</span><span class="symbol">(</span><span class="usertype">Surface</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">surface</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">ViewStyle</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">vsDraw</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">PRectangle</span><span class="normal"> rcSegment</span><span class="symbol">,</span>
<span class="normal">				  </span><span class="keyword">const</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">s</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">ColourAllocated</span><span class="normal"> textBack</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">ColourAllocated</span><span class="normal"> textFore</span><span class="symbol">,</span><span class="normal"> </span><span class="type">bool</span><span class="normal"> twoPhaseDraw</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">twoPhaseDraw</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		surface</span><span class="symbol">-&gt;</span><span class="function">FillRectangle</span><span class="symbol">(</span><span class="normal">rcSegment</span><span class="symbol">,</span><span class="normal"> textBack</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="usertype">Font</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">ctrlCharsFont </span><span class="symbol">=</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">STYLE_CONTROLCHAR</span><span class="symbol">].</span><span class="normal">font</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> normalCharHeight </span><span class="symbol">=</span><span class="normal"> surface</span><span class="symbol">-&gt;</span><span class="function">Ascent</span><span class="symbol">(</span><span class="normal">ctrlCharsFont</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">-</span>
<span class="normal">	        surface</span><span class="symbol">-&gt;</span><span class="function">InternalLeading</span><span class="symbol">(</span><span class="normal">ctrlCharsFont</span><span class="symbol">);</span>
<span class="normal">	</span><span class="usertype">PRectangle</span><span class="normal"> rcCChar </span><span class="symbol">=</span><span class="normal"> rcSegment</span><span class="symbol">;</span>
<span class="normal">	rcCChar</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">=</span><span class="normal"> rcCChar</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">	rcCChar</span><span class="symbol">.</span><span class="normal">top </span><span class="symbol">=</span><span class="normal"> rcSegment</span><span class="symbol">.</span><span class="normal">top </span><span class="symbol">+</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">maxAscent </span><span class="symbol">-</span><span class="normal"> normalCharHeight</span><span class="symbol">;</span>
<span class="normal">	rcCChar</span><span class="symbol">.</span><span class="normal">bottom </span><span class="symbol">=</span><span class="normal"> rcSegment</span><span class="symbol">.</span><span class="normal">top </span><span class="symbol">+</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">maxAscent </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">PRectangle</span><span class="normal"> rcCentral </span><span class="symbol">=</span><span class="normal"> rcCChar</span><span class="symbol">;</span>
<span class="normal">	rcCentral</span><span class="symbol">.</span><span class="normal">top</span><span class="symbol">++;</span>
<span class="normal">	rcCentral</span><span class="symbol">.</span><span class="normal">bottom</span><span class="symbol">--;</span>
<span class="normal">	surface</span><span class="symbol">-&gt;</span><span class="function">FillRectangle</span><span class="symbol">(</span><span class="normal">rcCentral</span><span class="symbol">,</span><span class="normal"> textFore</span><span class="symbol">);</span>
<span class="normal">	</span><span class="usertype">PRectangle</span><span class="normal"> rcChar </span><span class="symbol">=</span><span class="normal"> rcCChar</span><span class="symbol">;</span>
<span class="normal">	rcChar</span><span class="symbol">.</span><span class="normal">left</span><span class="symbol">++;</span>
<span class="normal">	rcChar</span><span class="symbol">.</span><span class="normal">right</span><span class="symbol">--;</span>
<span class="normal">	surface</span><span class="symbol">-&gt;</span><span class="function">DrawTextClipped</span><span class="symbol">(</span><span class="normal">rcChar</span><span class="symbol">,</span><span class="normal"> ctrlCharsFont</span><span class="symbol">,</span>
<span class="normal">	        rcSegment</span><span class="symbol">.</span><span class="normal">top </span><span class="symbol">+</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">maxAscent</span><span class="symbol">,</span><span class="normal"> s</span><span class="symbol">,</span><span class="normal"> </span><span class="function">istrlen</span><span class="symbol">(</span><span class="normal">s</span><span class="symbol">),</span>
<span class="normal">	        textBack</span><span class="symbol">,</span><span class="normal"> textFore</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">DrawEOL</span><span class="symbol">(</span><span class="usertype">Surface</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">surface</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">ViewStyle</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">vsDraw</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">PRectangle</span><span class="normal"> rcLine</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">LineLayout</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">ll</span><span class="symbol">,</span>
<span class="normal">        </span><span class="type">int</span><span class="normal"> line</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> lineEnd</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> xStart</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> subLine</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> subLineStart</span><span class="symbol">,</span>
<span class="normal">        </span><span class="type">bool</span><span class="normal"> overrideBackground</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">ColourAllocated</span><span class="normal"> background</span><span class="symbol">,</span>
<span class="normal">        </span><span class="type">bool</span><span class="normal"> drawWrapMarkEnd</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">ColourAllocated</span><span class="normal"> wrapColour</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>

<span class="normal">	</span><span class="type">int</span><span class="normal"> styleMask </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="normal">stylingBitsMask</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">PRectangle</span><span class="normal"> rcSegment </span><span class="symbol">=</span><span class="normal"> rcLine</span><span class="symbol">;</span>

<span class="normal">	</span><span class="comment">// Fill in a PRectangle representing the end of line characters</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> xEol </span><span class="symbol">=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">positions</span><span class="symbol">[</span><span class="normal">lineEnd</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> subLineStart</span><span class="symbol">;</span>
<span class="normal">	rcSegment</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">=</span><span class="normal"> xEol </span><span class="symbol">+</span><span class="normal"> xStart</span><span class="symbol">;</span>
<span class="normal">	rcSegment</span><span class="symbol">.</span><span class="normal">right </span><span class="symbol">=</span><span class="normal"> xEol </span><span class="symbol">+</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">aveCharWidth </span><span class="symbol">+</span><span class="normal"> xStart</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> posLineEnd </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">line </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">	</span><span class="type">bool</span><span class="normal"> eolInSelection </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">subLine </span><span class="symbol">==</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">lines </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span>
<span class="normal">	        </span><span class="symbol">(</span><span class="normal">posLineEnd </span><span class="symbol">&gt;</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">selStart</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">posLineEnd </span><span class="symbol">&lt;=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">selEnd</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">selStart </span><span class="symbol">!=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">selEnd</span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">eolInSelection </span><span class="symbol">&amp;&amp;</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">selbackset </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">line </span><span class="symbol">&lt;</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LinesTotal</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vsDraw</span><span class="symbol">.</span><span class="normal">selAlpha </span><span class="symbol">==</span><span class="normal"> SC_ALPHA_NOALPHA</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		surface</span><span class="symbol">-&gt;</span><span class="function">FillRectangle</span><span class="symbol">(</span><span class="normal">rcSegment</span><span class="symbol">,</span><span class="normal"> </span><span class="function">SelectionBackground</span><span class="symbol">(</span><span class="normal">vsDraw</span><span class="symbol">));</span>
<span class="normal">	</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">overrideBackground</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			surface</span><span class="symbol">-&gt;</span><span class="function">FillRectangle</span><span class="symbol">(</span><span class="normal">rcSegment</span><span class="symbol">,</span><span class="normal"> background</span><span class="symbol">);</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			surface</span><span class="symbol">-&gt;</span><span class="function">FillRectangle</span><span class="symbol">(</span><span class="normal">rcSegment</span><span class="symbol">,</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">numCharsInLine</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> styleMask</span><span class="symbol">].</span><span class="normal">back</span><span class="symbol">.</span><span class="normal">allocated</span><span class="symbol">);</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">eolInSelection </span><span class="symbol">&amp;&amp;</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">selbackset </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">line </span><span class="symbol">&lt;</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LinesTotal</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vsDraw</span><span class="symbol">.</span><span class="normal">selAlpha </span><span class="symbol">!=</span><span class="normal"> SC_ALPHA_NOALPHA</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="function">SimpleAlphaRectangle</span><span class="symbol">(</span><span class="normal">surface</span><span class="symbol">,</span><span class="normal"> rcSegment</span><span class="symbol">,</span><span class="normal"> </span><span class="function">SelectionBackground</span><span class="symbol">(</span><span class="normal">vsDraw</span><span class="symbol">),</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">selAlpha</span><span class="symbol">);</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	rcSegment</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">=</span><span class="normal"> xEol </span><span class="symbol">+</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">aveCharWidth </span><span class="symbol">+</span><span class="normal"> xStart</span><span class="symbol">;</span>
<span class="normal">	rcSegment</span><span class="symbol">.</span><span class="normal">right </span><span class="symbol">=</span><span class="normal"> rcLine</span><span class="symbol">.</span><span class="normal">right</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vsDraw</span><span class="symbol">.</span><span class="normal">selEOLFilled </span><span class="symbol">&amp;&amp;</span><span class="normal"> eolInSelection </span><span class="symbol">&amp;&amp;</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">selbackset </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">line </span><span class="symbol">&lt;</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LinesTotal</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vsDraw</span><span class="symbol">.</span><span class="normal">selAlpha </span><span class="symbol">==</span><span class="normal"> SC_ALPHA_NOALPHA</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		surface</span><span class="symbol">-&gt;</span><span class="function">FillRectangle</span><span class="symbol">(</span><span class="normal">rcSegment</span><span class="symbol">,</span><span class="normal"> </span><span class="function">SelectionBackground</span><span class="symbol">(</span><span class="normal">vsDraw</span><span class="symbol">));</span>
<span class="normal">	</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">overrideBackground</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			surface</span><span class="symbol">-&gt;</span><span class="function">FillRectangle</span><span class="symbol">(</span><span class="normal">rcSegment</span><span class="symbol">,</span><span class="normal"> background</span><span class="symbol">);</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vsDraw</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">numCharsInLine</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> styleMask</span><span class="symbol">].</span><span class="normal">eolFilled</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			surface</span><span class="symbol">-&gt;</span><span class="function">FillRectangle</span><span class="symbol">(</span><span class="normal">rcSegment</span><span class="symbol">,</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">numCharsInLine</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> styleMask</span><span class="symbol">].</span><span class="normal">back</span><span class="symbol">.</span><span class="normal">allocated</span><span class="symbol">);</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			surface</span><span class="symbol">-&gt;</span><span class="function">FillRectangle</span><span class="symbol">(</span><span class="normal">rcSegment</span><span class="symbol">,</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">STYLE_DEFAULT</span><span class="symbol">].</span><span class="normal">back</span><span class="symbol">.</span><span class="normal">allocated</span><span class="symbol">);</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vsDraw</span><span class="symbol">.</span><span class="normal">selEOLFilled </span><span class="symbol">&amp;&amp;</span><span class="normal"> eolInSelection </span><span class="symbol">&amp;&amp;</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">selbackset </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">line </span><span class="symbol">&lt;</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LinesTotal</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vsDraw</span><span class="symbol">.</span><span class="normal">selAlpha </span><span class="symbol">!=</span><span class="normal"> SC_ALPHA_NOALPHA</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="function">SimpleAlphaRectangle</span><span class="symbol">(</span><span class="normal">surface</span><span class="symbol">,</span><span class="normal"> rcSegment</span><span class="symbol">,</span><span class="normal"> </span><span class="function">SelectionBackground</span><span class="symbol">(</span><span class="normal">vsDraw</span><span class="symbol">),</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">selAlpha</span><span class="symbol">);</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">drawWrapMarkEnd</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="usertype">PRectangle</span><span class="normal"> rcPlace </span><span class="symbol">=</span><span class="normal"> rcSegment</span><span class="symbol">;</span>

<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">wrapVisualFlagsLocation </span><span class="symbol">&amp;</span><span class="normal"> SC_WRAPVISUALFLAGLOC_END_BY_TEXT</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			rcPlace</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">=</span><span class="normal"> xEol </span><span class="symbol">+</span><span class="normal"> xStart</span><span class="symbol">;</span>
<span class="normal">			rcPlace</span><span class="symbol">.</span><span class="normal">right </span><span class="symbol">=</span><span class="normal"> rcPlace</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">+</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">aveCharWidth</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="comment">// draw left of the right text margin, to avoid clipping by the current clip rect</span>
<span class="normal">			rcPlace</span><span class="symbol">.</span><span class="normal">right </span><span class="symbol">=</span><span class="normal"> rcLine</span><span class="symbol">.</span><span class="normal">right </span><span class="symbol">-</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">rightMarginWidth</span><span class="symbol">;</span>
<span class="normal">			rcPlace</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">=</span><span class="normal"> rcPlace</span><span class="symbol">.</span><span class="normal">right </span><span class="symbol">-</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">aveCharWidth</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="function">DrawWrapMarker</span><span class="symbol">(</span><span class="normal">surface</span><span class="symbol">,</span><span class="normal"> rcPlace</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">,</span><span class="normal"> wrapColour</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">DrawIndicators</span><span class="symbol">(</span><span class="usertype">Surface</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">surface</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">ViewStyle</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">vsDraw</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> line</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> xStart</span><span class="symbol">,</span>
<span class="normal">        </span><span class="usertype">PRectangle</span><span class="normal"> rcLine</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">LineLayout</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">ll</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> subLine</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> lineEnd</span><span class="symbol">,</span><span class="normal"> </span><span class="type">bool</span><span class="normal"> under</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="comment">// Draw decorators</span>
<span class="normal">	</span><span class="keyword">const</span><span class="normal"> </span><span class="type">int</span><span class="normal"> posLineStart </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">const</span><span class="normal"> </span><span class="type">int</span><span class="normal"> lineStart </span><span class="symbol">=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">subLine</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">const</span><span class="normal"> </span><span class="type">int</span><span class="normal"> subLineStart </span><span class="symbol">=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">positions</span><span class="symbol">[</span><span class="normal">lineStart</span><span class="symbol">];</span>
<span class="normal">	</span><span class="keyword">const</span><span class="normal"> </span><span class="type">int</span><span class="normal"> posLineEnd </span><span class="symbol">=</span><span class="normal"> posLineStart </span><span class="symbol">+</span><span class="normal"> lineEnd</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">under</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="comment">// Draw indicators</span>
<span class="normal">		</span><span class="comment">// foreach indicator...</span>
<span class="normal">		</span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="normal"> indicnum </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> mask </span><span class="symbol">=</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="normal">stylingBits</span><span class="symbol">;</span><span class="normal"> mask </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">0x100</span><span class="symbol">;</span><span class="normal"> indicnum</span><span class="symbol">++)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!(</span><span class="normal">mask </span><span class="symbol">&amp;</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">styleBitsSet</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				mask </span><span class="symbol">&lt;&lt;=</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">				</span><span class="keyword">continue</span><span class="symbol">;</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> startPos </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">			</span><span class="comment">// foreach style pos in line...</span>
<span class="normal">			</span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="normal"> indicPos </span><span class="symbol">=</span><span class="normal"> lineStart</span><span class="symbol">;</span><span class="normal"> indicPos </span><span class="symbol">&lt;=</span><span class="normal"> lineEnd</span><span class="symbol">;</span><span class="normal"> indicPos</span><span class="symbol">++)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="comment">// look for starts...</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">startPos </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="comment">// NOT in indicator run, looking for START</span>
<span class="normal">					</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">indicPos </span><span class="symbol">&lt;</span><span class="normal"> lineEnd </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">indicators</span><span class="symbol">[</span><span class="normal">indicPos</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> mask</span><span class="symbol">))</span>
<span class="normal">						startPos </span><span class="symbol">=</span><span class="normal"> indicPos</span><span class="symbol">;</span>
<span class="normal">				</span><span class="cbracket">}</span>
<span class="normal">				</span><span class="comment">// ... or ends</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">startPos </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="comment">// IN indicator run, looking for END</span>
<span class="normal">					</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">indicPos </span><span class="symbol">&gt;=</span><span class="normal"> lineEnd </span><span class="symbol">||</span><span class="normal"> </span><span class="symbol">!(</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">indicators</span><span class="symbol">[</span><span class="normal">indicPos</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> mask</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">						</span><span class="comment">// AT end of indicator run, DRAW it!</span>
<span class="normal">						</span><span class="usertype">PRectangle</span><span class="normal"> </span><span class="function">rcIndic</span><span class="symbol">(</span>
<span class="normal">						    ll</span><span class="symbol">-&gt;</span><span class="normal">positions</span><span class="symbol">[</span><span class="normal">startPos</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> xStart </span><span class="symbol">-</span><span class="normal"> subLineStart</span><span class="symbol">,</span>
<span class="normal">						    rcLine</span><span class="symbol">.</span><span class="normal">top </span><span class="symbol">+</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">maxAscent</span><span class="symbol">,</span>
<span class="normal">						    ll</span><span class="symbol">-&gt;</span><span class="normal">positions</span><span class="symbol">[</span><span class="normal">indicPos</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> xStart </span><span class="symbol">-</span><span class="normal"> subLineStart</span><span class="symbol">,</span>
<span class="normal">						    rcLine</span><span class="symbol">.</span><span class="normal">top </span><span class="symbol">+</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">maxAscent </span><span class="symbol">+</span><span class="normal"> </span><span class="number">3</span><span class="symbol">);</span>
<span class="normal">						vsDraw</span><span class="symbol">.</span><span class="normal">indicators</span><span class="symbol">[</span><span class="normal">indicnum</span><span class="symbol">].</span><span class="function">Draw</span><span class="symbol">(</span><span class="normal">surface</span><span class="symbol">,</span><span class="normal"> rcIndic</span><span class="symbol">,</span><span class="normal"> rcLine</span><span class="symbol">);</span>
<span class="normal">						</span><span class="comment">// RESET control var</span>
<span class="normal">						startPos </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">					</span><span class="cbracket">}</span>
<span class="normal">				</span><span class="cbracket">}</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">			mask </span><span class="symbol">&lt;&lt;=</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="usertype">Decoration</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">deco </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="normal">decorations</span><span class="symbol">.</span><span class="normal">root</span><span class="symbol">;</span><span class="normal"> deco</span><span class="symbol">;</span><span class="normal"> deco </span><span class="symbol">=</span><span class="normal"> deco</span><span class="symbol">-&gt;</span><span class="normal">next</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">under </span><span class="symbol">==</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">indicators</span><span class="symbol">[</span><span class="normal">deco</span><span class="symbol">-&gt;</span><span class="normal">indicator</span><span class="symbol">].</span><span class="normal">under</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> startPos </span><span class="symbol">=</span><span class="normal"> posLineStart </span><span class="symbol">+</span><span class="normal"> lineStart</span><span class="symbol">;</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">deco</span><span class="symbol">-&gt;</span><span class="normal">rs</span><span class="symbol">.</span><span class="function">ValueAt</span><span class="symbol">(</span><span class="normal">startPos</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				startPos </span><span class="symbol">=</span><span class="normal"> deco</span><span class="symbol">-&gt;</span><span class="normal">rs</span><span class="symbol">.</span><span class="function">EndRun</span><span class="symbol">(</span><span class="normal">startPos</span><span class="symbol">);</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">			</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">startPos </span><span class="symbol">&lt;</span><span class="normal"> posLineEnd</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">deco</span><span class="symbol">-&gt;</span><span class="normal">rs</span><span class="symbol">.</span><span class="function">ValueAt</span><span class="symbol">(</span><span class="normal">startPos</span><span class="symbol">)))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="type">int</span><span class="normal"> endPos </span><span class="symbol">=</span><span class="normal"> deco</span><span class="symbol">-&gt;</span><span class="normal">rs</span><span class="symbol">.</span><span class="function">EndRun</span><span class="symbol">(</span><span class="normal">startPos</span><span class="symbol">);</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">endPos </span><span class="symbol">&gt;</span><span class="normal"> posLineEnd</span><span class="symbol">)</span>
<span class="normal">					endPos </span><span class="symbol">=</span><span class="normal"> posLineEnd</span><span class="symbol">;</span>
<span class="normal">				</span><span class="usertype">PRectangle</span><span class="normal"> </span><span class="function">rcIndic</span><span class="symbol">(</span>
<span class="normal">				    ll</span><span class="symbol">-&gt;</span><span class="normal">positions</span><span class="symbol">[</span><span class="normal">startPos </span><span class="symbol">-</span><span class="normal"> posLineStart</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> xStart </span><span class="symbol">-</span><span class="normal"> subLineStart</span><span class="symbol">,</span>
<span class="normal">				    rcLine</span><span class="symbol">.</span><span class="normal">top </span><span class="symbol">+</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">maxAscent</span><span class="symbol">,</span>
<span class="normal">				    ll</span><span class="symbol">-&gt;</span><span class="normal">positions</span><span class="symbol">[</span><span class="normal">endPos </span><span class="symbol">-</span><span class="normal"> posLineStart</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> xStart </span><span class="symbol">-</span><span class="normal"> subLineStart</span><span class="symbol">,</span>
<span class="normal">				    rcLine</span><span class="symbol">.</span><span class="normal">top </span><span class="symbol">+</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">maxAscent </span><span class="symbol">+</span><span class="normal"> </span><span class="number">3</span><span class="symbol">);</span>
<span class="normal">				vsDraw</span><span class="symbol">.</span><span class="normal">indicators</span><span class="symbol">[</span><span class="normal">deco</span><span class="symbol">-&gt;</span><span class="normal">indicator</span><span class="symbol">].</span><span class="function">Draw</span><span class="symbol">(</span><span class="normal">surface</span><span class="symbol">,</span><span class="normal"> rcIndic</span><span class="symbol">,</span><span class="normal"> rcLine</span><span class="symbol">);</span>
<span class="normal">				startPos </span><span class="symbol">=</span><span class="normal"> deco</span><span class="symbol">-&gt;</span><span class="normal">rs</span><span class="symbol">.</span><span class="function">EndRun</span><span class="symbol">(</span><span class="normal">endPos</span><span class="symbol">);</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">DrawAnnotation</span><span class="symbol">(</span><span class="usertype">Surface</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">surface</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">ViewStyle</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">vsDraw</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> line</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> xStart</span><span class="symbol">,</span>
<span class="normal">    </span><span class="usertype">PRectangle</span><span class="normal"> rcLine</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">LineLayout</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">ll</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> subLine</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> indent </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">GetLineIndentation</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">spaceWidth</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">PRectangle</span><span class="normal"> rcSegment </span><span class="symbol">=</span><span class="normal"> rcLine</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> annotationLine </span><span class="symbol">=</span><span class="normal"> subLine </span><span class="symbol">-</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">lines</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">const</span><span class="normal"> </span><span class="usertype">StyledText</span><span class="normal"> stAnnotation  </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">AnnotationStyledText</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">stAnnotation</span><span class="symbol">.</span><span class="normal">text </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="function">ValidStyledText</span><span class="symbol">(</span><span class="normal">vsDraw</span><span class="symbol">,</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">annotationStyleOffset</span><span class="symbol">,</span><span class="normal"> stAnnotation</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		surface</span><span class="symbol">-&gt;</span><span class="function">FillRectangle</span><span class="symbol">(</span><span class="normal">rcSegment</span><span class="symbol">,</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="number">0</span><span class="symbol">].</span><span class="normal">back</span><span class="symbol">.</span><span class="normal">allocated</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vs</span><span class="symbol">.</span><span class="normal">annotationVisible </span><span class="symbol">==</span><span class="normal"> ANNOTATION_BOXED</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="comment">// Only care about calculating width if need to draw box</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> widthAnnotation </span><span class="symbol">=</span><span class="normal"> </span><span class="function">WidestLineWidth</span><span class="symbol">(</span><span class="normal">surface</span><span class="symbol">,</span><span class="normal"> vsDraw</span><span class="symbol">,</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">annotationStyleOffset</span><span class="symbol">,</span><span class="normal"> stAnnotation</span><span class="symbol">);</span>
<span class="normal">			widthAnnotation </span><span class="symbol">+=</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">spaceWidth </span><span class="symbol">*</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span><span class="normal"> </span><span class="comment">// Margins</span>
<span class="normal">			rcSegment</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">=</span><span class="normal"> xStart </span><span class="symbol">+</span><span class="normal"> indent</span><span class="symbol">;</span>
<span class="normal">			rcSegment</span><span class="symbol">.</span><span class="normal">right </span><span class="symbol">=</span><span class="normal"> rcSegment</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">+</span><span class="normal"> widthAnnotation</span><span class="symbol">;</span>
<span class="normal">			surface</span><span class="symbol">-&gt;</span><span class="function">PenColour</span><span class="symbol">(</span><span class="normal">vsDraw</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">vsDraw</span><span class="symbol">.</span><span class="normal">annotationStyleOffset</span><span class="symbol">].</span><span class="normal">fore</span><span class="symbol">.</span><span class="normal">allocated</span><span class="symbol">);</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			rcSegment</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">=</span><span class="normal"> xStart</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">const</span><span class="normal"> </span><span class="type">int</span><span class="normal"> annotationLines </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">AnnotationLines</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">);</span>
<span class="normal">		</span><span class="usertype">size_t</span><span class="normal"> start </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		</span><span class="usertype">size_t</span><span class="normal"> lengthAnnotation </span><span class="symbol">=</span><span class="normal"> stAnnotation</span><span class="symbol">.</span><span class="function">LineLength</span><span class="symbol">(</span><span class="normal">start</span><span class="symbol">);</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> lineInAnnotation </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">lineInAnnotation </span><span class="symbol">&lt;</span><span class="normal"> annotationLine</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">start </span><span class="symbol">&lt;</span><span class="normal"> stAnnotation</span><span class="symbol">.</span><span class="normal">length</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			start </span><span class="symbol">+=</span><span class="normal"> lengthAnnotation </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">			lengthAnnotation </span><span class="symbol">=</span><span class="normal"> stAnnotation</span><span class="symbol">.</span><span class="function">LineLength</span><span class="symbol">(</span><span class="normal">start</span><span class="symbol">);</span>
<span class="normal">			lineInAnnotation</span><span class="symbol">++;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="usertype">PRectangle</span><span class="normal"> rcText </span><span class="symbol">=</span><span class="normal"> rcSegment</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vs</span><span class="symbol">.</span><span class="normal">annotationVisible </span><span class="symbol">==</span><span class="normal"> ANNOTATION_BOXED</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			surface</span><span class="symbol">-&gt;</span><span class="function">FillRectangle</span><span class="symbol">(</span><span class="normal">rcText</span><span class="symbol">,</span><span class="normal"> </span>
<span class="normal">				vsDraw</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">stAnnotation</span><span class="symbol">.</span><span class="function">StyleAt</span><span class="symbol">(</span><span class="normal">start</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">annotationStyleOffset</span><span class="symbol">].</span><span class="normal">back</span><span class="symbol">.</span><span class="normal">allocated</span><span class="symbol">);</span>
<span class="normal">			rcText</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">+=</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">spaceWidth</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="function">DrawStyledText</span><span class="symbol">(</span><span class="normal">surface</span><span class="symbol">,</span><span class="normal"> vsDraw</span><span class="symbol">,</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">annotationStyleOffset</span><span class="symbol">,</span><span class="normal"> rcText</span><span class="symbol">,</span><span class="normal"> rcText</span><span class="symbol">.</span><span class="normal">top </span><span class="symbol">+</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">maxAscent</span><span class="symbol">,</span><span class="normal"> </span>
<span class="normal">			stAnnotation</span><span class="symbol">,</span><span class="normal"> start</span><span class="symbol">,</span><span class="normal"> lengthAnnotation</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vs</span><span class="symbol">.</span><span class="normal">annotationVisible </span><span class="symbol">==</span><span class="normal"> ANNOTATION_BOXED</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			surface</span><span class="symbol">-&gt;</span><span class="function">MoveTo</span><span class="symbol">(</span><span class="normal">rcSegment</span><span class="symbol">.</span><span class="normal">left</span><span class="symbol">,</span><span class="normal"> rcSegment</span><span class="symbol">.</span><span class="normal">top</span><span class="symbol">);</span>
<span class="normal">			surface</span><span class="symbol">-&gt;</span><span class="function">LineTo</span><span class="symbol">(</span><span class="normal">rcSegment</span><span class="symbol">.</span><span class="normal">left</span><span class="symbol">,</span><span class="normal"> rcSegment</span><span class="symbol">.</span><span class="normal">bottom</span><span class="symbol">);</span>
<span class="normal">			surface</span><span class="symbol">-&gt;</span><span class="function">MoveTo</span><span class="symbol">(</span><span class="normal">rcSegment</span><span class="symbol">.</span><span class="normal">right</span><span class="symbol">,</span><span class="normal"> rcSegment</span><span class="symbol">.</span><span class="normal">top</span><span class="symbol">);</span>
<span class="normal">			surface</span><span class="symbol">-&gt;</span><span class="function">LineTo</span><span class="symbol">(</span><span class="normal">rcSegment</span><span class="symbol">.</span><span class="normal">right</span><span class="symbol">,</span><span class="normal"> rcSegment</span><span class="symbol">.</span><span class="normal">bottom</span><span class="symbol">);</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">subLine </span><span class="symbol">==</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">lines</span><span class="symbol">)</span><span class="cbracket">{</span>
<span class="normal">				surface</span><span class="symbol">-&gt;</span><span class="function">MoveTo</span><span class="symbol">(</span><span class="normal">rcSegment</span><span class="symbol">.</span><span class="normal">left</span><span class="symbol">,</span><span class="normal"> rcSegment</span><span class="symbol">.</span><span class="normal">top</span><span class="symbol">);</span>
<span class="normal">				surface</span><span class="symbol">-&gt;</span><span class="function">LineTo</span><span class="symbol">(</span><span class="normal">rcSegment</span><span class="symbol">.</span><span class="normal">right</span><span class="symbol">,</span><span class="normal"> rcSegment</span><span class="symbol">.</span><span class="normal">top</span><span class="symbol">);</span>
<span class="normal">			</span><span class="cbracket">}</span><span class="normal"> </span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">subLine </span><span class="symbol">==</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">lines</span><span class="symbol">+</span><span class="normal">annotationLines</span><span class="symbol">-</span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				surface</span><span class="symbol">-&gt;</span><span class="function">MoveTo</span><span class="symbol">(</span><span class="normal">rcSegment</span><span class="symbol">.</span><span class="normal">left</span><span class="symbol">,</span><span class="normal"> rcSegment</span><span class="symbol">.</span><span class="normal">bottom </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">				surface</span><span class="symbol">-&gt;</span><span class="function">LineTo</span><span class="symbol">(</span><span class="normal">rcSegment</span><span class="symbol">.</span><span class="normal">right</span><span class="symbol">,</span><span class="normal"> rcSegment</span><span class="symbol">.</span><span class="normal">bottom </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">DrawLine</span><span class="symbol">(</span><span class="usertype">Surface</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">surface</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">ViewStyle</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">vsDraw</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> line</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> lineVisible</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> xStart</span><span class="symbol">,</span>
<span class="normal">        </span><span class="usertype">PRectangle</span><span class="normal"> rcLine</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">LineLayout</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">ll</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> subLine</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>

<span class="normal">	</span><span class="usertype">PRectangle</span><span class="normal"> rcSegment </span><span class="symbol">=</span><span class="normal"> rcLine</span><span class="symbol">;</span>

<span class="normal">	</span><span class="comment">// Using one font for all control characters so it can be controlled independently to ensure</span>
<span class="normal">	</span><span class="comment">// the box goes around the characters tightly. Seems to be no way to work out what height</span>
<span class="normal">	</span><span class="comment">// is taken by an individual character - internal leading gives varying results.</span>
<span class="normal">	</span><span class="usertype">Font</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">ctrlCharsFont </span><span class="symbol">=</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">STYLE_CONTROLCHAR</span><span class="symbol">].</span><span class="normal">font</span><span class="symbol">;</span>

<span class="normal">	</span><span class="comment">// See if something overrides the line background color:  Either if caret is on the line</span>
<span class="normal">	</span><span class="comment">// and background color is set for that, or if a marker is defined that forces its background</span>
<span class="normal">	</span><span class="comment">// color onto the line, or if a marker is defined but has no selection margin in which to</span>
<span class="normal">	</span><span class="comment">// display itself (as long as it's not an SC_MARK_EMPTY marker).  These are checked in order</span>
<span class="normal">	</span><span class="comment">// with the earlier taking precedence.  When multiple markers cause background override,</span>
<span class="normal">	</span><span class="comment">// the color for the highest numbered one is used.</span>
<span class="normal">	</span><span class="type">bool</span><span class="normal"> overrideBackground </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">ColourAllocated</span><span class="normal"> background</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">caret</span><span class="symbol">.</span><span class="normal">active </span><span class="symbol">&amp;&amp;</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">showCaretLineBackground </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vsDraw</span><span class="symbol">.</span><span class="normal">caretLineAlpha </span><span class="symbol">==</span><span class="normal"> SC_ALPHA_NOALPHA</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">containsCaret</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		overrideBackground </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>
<span class="normal">		background </span><span class="symbol">=</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">caretLineBackground</span><span class="symbol">.</span><span class="normal">allocated</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">overrideBackground</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> marks </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">GetMark</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="normal"> markBit </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">markBit </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">32</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> marks</span><span class="symbol">;</span><span class="normal"> markBit</span><span class="symbol">++)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">marks </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vsDraw</span><span class="symbol">.</span><span class="normal">markers</span><span class="symbol">[</span><span class="normal">markBit</span><span class="symbol">].</span><span class="normal">markType </span><span class="symbol">==</span><span class="normal"> SC_MARK_BACKGROUND</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span>
<span class="normal">			        </span><span class="symbol">(</span><span class="normal">vsDraw</span><span class="symbol">.</span><span class="normal">markers</span><span class="symbol">[</span><span class="normal">markBit</span><span class="symbol">].</span><span class="normal">alpha </span><span class="symbol">==</span><span class="normal"> SC_ALPHA_NOALPHA</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				background </span><span class="symbol">=</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">markers</span><span class="symbol">[</span><span class="normal">markBit</span><span class="symbol">].</span><span class="normal">back</span><span class="symbol">.</span><span class="normal">allocated</span><span class="symbol">;</span>
<span class="normal">				overrideBackground </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">			marks </span><span class="symbol">&gt;&gt;=</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">overrideBackground</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vsDraw</span><span class="symbol">.</span><span class="normal">maskInLine</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> marksMasked </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">GetMark</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">maskInLine</span><span class="symbol">;</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">marksMasked</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="normal"> markBit </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">markBit </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">32</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> marksMasked</span><span class="symbol">;</span><span class="normal"> markBit</span><span class="symbol">++)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">marksMasked </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vsDraw</span><span class="symbol">.</span><span class="normal">markers</span><span class="symbol">[</span><span class="normal">markBit</span><span class="symbol">].</span><span class="normal">markType </span><span class="symbol">!=</span><span class="normal"> SC_MARK_EMPTY</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span>
<span class="normal">					        </span><span class="symbol">(</span><span class="normal">vsDraw</span><span class="symbol">.</span><span class="normal">markers</span><span class="symbol">[</span><span class="normal">markBit</span><span class="symbol">].</span><span class="normal">alpha </span><span class="symbol">==</span><span class="normal"> SC_ALPHA_NOALPHA</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">						overrideBackground </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>
<span class="normal">						background </span><span class="symbol">=</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">markers</span><span class="symbol">[</span><span class="normal">markBit</span><span class="symbol">].</span><span class="normal">back</span><span class="symbol">.</span><span class="normal">allocated</span><span class="symbol">;</span>
<span class="normal">					</span><span class="cbracket">}</span>
<span class="normal">					marksMasked </span><span class="symbol">&gt;&gt;=</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">				</span><span class="cbracket">}</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="type">bool</span><span class="normal"> drawWhitespaceBackground </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vsDraw</span><span class="symbol">.</span><span class="normal">viewWhitespace </span><span class="symbol">!=</span><span class="normal"> wsInvisible</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span>
<span class="normal">	        </span><span class="symbol">(!</span><span class="normal">overrideBackground</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vsDraw</span><span class="symbol">.</span><span class="normal">whitespaceBackgroundSet</span><span class="symbol">);</span>

<span class="normal">	</span><span class="type">bool</span><span class="normal"> inIndentation </span><span class="symbol">=</span><span class="normal"> subLine </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal">	</span><span class="comment">// Do not handle indentation except on first subline.</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> indentWidth </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">IndentSize</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">spaceWidth</span><span class="symbol">;</span>

<span class="normal">	</span><span class="type">int</span><span class="normal"> posLineStart </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">);</span>

<span class="normal">	</span><span class="type">int</span><span class="normal"> startseg </span><span class="symbol">=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">subLine</span><span class="symbol">);</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> subLineStart </span><span class="symbol">=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">positions</span><span class="symbol">[</span><span class="normal">startseg</span><span class="symbol">];</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">subLine </span><span class="symbol">&gt;=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">lines</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">DrawAnnotation</span><span class="symbol">(</span><span class="normal">surface</span><span class="symbol">,</span><span class="normal"> vsDraw</span><span class="symbol">,</span><span class="normal"> line</span><span class="symbol">,</span><span class="normal"> xStart</span><span class="symbol">,</span><span class="normal"> rcLine</span><span class="symbol">,</span><span class="normal"> ll</span><span class="symbol">,</span><span class="normal"> subLine</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">return</span><span class="symbol">;</span><span class="normal"> </span><span class="comment">// No further drawing</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> lineStart </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> lineEnd </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">subLine </span><span class="symbol">&lt;</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">lines</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		lineStart </span><span class="symbol">=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">subLine</span><span class="symbol">);</span>
<span class="normal">		lineEnd </span><span class="symbol">=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">subLine </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="usertype">ColourAllocated</span><span class="normal"> wrapColour </span><span class="symbol">=</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">STYLE_DEFAULT</span><span class="symbol">].</span><span class="normal">fore</span><span class="symbol">.</span><span class="normal">allocated</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vsDraw</span><span class="symbol">.</span><span class="normal">whitespaceForegroundSet</span><span class="symbol">)</span>
<span class="normal">		wrapColour </span><span class="symbol">=</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">whitespaceForeground</span><span class="symbol">.</span><span class="normal">allocated</span><span class="symbol">;</span>

<span class="normal">	</span><span class="type">bool</span><span class="normal"> drawWrapMarkEnd </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">wrapVisualFlags </span><span class="symbol">&amp;</span><span class="normal"> SC_WRAPVISUALFLAG_END</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">subLine </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">&lt;</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">lines</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			drawWrapMarkEnd </span><span class="symbol">=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">subLine </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">wrapIndent </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>

<span class="normal">		</span><span class="type">bool</span><span class="normal"> continuedWrapLine </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">subLine </span><span class="symbol">&lt;</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">lines</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			continuedWrapLine </span><span class="symbol">=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">subLine</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>

<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">continuedWrapLine</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="comment">// draw continuation rect</span>
<span class="normal">			</span><span class="usertype">PRectangle</span><span class="normal"> rcPlace </span><span class="symbol">=</span><span class="normal"> rcSegment</span><span class="symbol">;</span>

<span class="normal">			rcPlace</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">positions</span><span class="symbol">[</span><span class="normal">startseg</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> xStart </span><span class="symbol">-</span><span class="normal"> subLineStart</span><span class="symbol">;</span>
<span class="normal">			rcPlace</span><span class="symbol">.</span><span class="normal">right </span><span class="symbol">=</span><span class="normal"> rcPlace</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">+</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">wrapIndent</span><span class="symbol">;</span>

<span class="normal">			</span><span class="comment">// default bgnd here..</span>
<span class="normal">			surface</span><span class="symbol">-&gt;</span><span class="function">FillRectangle</span><span class="symbol">(</span><span class="normal">rcSegment</span><span class="symbol">,</span><span class="normal"> overrideBackground </span><span class="symbol">?</span><span class="normal"> background </span><span class="symbol">:</span>
<span class="normal">			        vsDraw</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">STYLE_DEFAULT</span><span class="symbol">].</span><span class="normal">back</span><span class="symbol">.</span><span class="normal">allocated</span><span class="symbol">);</span>

<span class="normal">			</span><span class="comment">// main line style would be below but this would be inconsistent with end markers</span>
<span class="normal">			</span><span class="comment">// also would possibly not be the style at wrap point</span>
<span class="normal">			</span><span class="comment">//int styleMain = ll-&gt;styles[lineStart];</span>
<span class="normal">			</span><span class="comment">//surface-&gt;FillRectangle(rcPlace, vsDraw.styles[styleMain].back.allocated);</span>

<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">wrapVisualFlags </span><span class="symbol">&amp;</span><span class="normal"> SC_WRAPVISUALFLAG_START</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>

<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">wrapVisualFlagsLocation </span><span class="symbol">&amp;</span><span class="normal"> SC_WRAPVISUALFLAGLOC_START_BY_TEXT</span><span class="symbol">)</span>
<span class="normal">					rcPlace</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">=</span><span class="normal"> rcPlace</span><span class="symbol">.</span><span class="normal">right </span><span class="symbol">-</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">aveCharWidth</span><span class="symbol">;</span>
<span class="normal">				</span><span class="keyword">else</span>
<span class="normal">					rcPlace</span><span class="symbol">.</span><span class="normal">right </span><span class="symbol">=</span><span class="normal"> rcPlace</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">+</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">aveCharWidth</span><span class="symbol">;</span>

<span class="normal">				</span><span class="function">DrawWrapMarker</span><span class="symbol">(</span><span class="normal">surface</span><span class="symbol">,</span><span class="normal"> rcPlace</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">,</span><span class="normal"> wrapColour</span><span class="symbol">);</span>
<span class="normal">			</span><span class="cbracket">}</span>

<span class="normal">			xStart </span><span class="symbol">+=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">wrapIndent</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="comment">// Does not take margin into account but not significant</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> xStartVisible </span><span class="symbol">=</span><span class="normal"> subLineStart </span><span class="symbol">-</span><span class="normal"> xStart</span><span class="symbol">;</span>

<span class="normal">	</span><span class="usertype">BreakFinder</span><span class="normal"> </span><span class="function">bfBack</span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">,</span><span class="normal"> lineStart</span><span class="symbol">,</span><span class="normal"> lineEnd</span><span class="symbol">,</span><span class="normal"> posLineStart</span><span class="symbol">,</span><span class="normal"> </span><span class="function">IsUnicodeMode</span><span class="symbol">(),</span><span class="normal"> xStartVisible</span><span class="symbol">);</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> next </span><span class="symbol">=</span><span class="normal"> bfBack</span><span class="symbol">.</span><span class="function">First</span><span class="symbol">();</span>

<span class="normal">	</span><span class="comment">// Background drawing loop</span>
<span class="normal">	</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">twoPhaseDraw </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">next </span><span class="symbol">&lt;</span><span class="normal"> lineEnd</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>

<span class="normal">		startseg </span><span class="symbol">=</span><span class="normal"> next</span><span class="symbol">;</span>
<span class="normal">		next </span><span class="symbol">=</span><span class="normal"> bfBack</span><span class="symbol">.</span><span class="function">Next</span><span class="symbol">();</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> i </span><span class="symbol">=</span><span class="normal"> next </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> iDoc </span><span class="symbol">=</span><span class="normal"> i </span><span class="symbol">+</span><span class="normal"> posLineStart</span><span class="symbol">;</span>

<span class="normal">		rcSegment</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">positions</span><span class="symbol">[</span><span class="normal">startseg</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> xStart </span><span class="symbol">-</span><span class="normal"> subLineStart</span><span class="symbol">;</span>
<span class="normal">		rcSegment</span><span class="symbol">.</span><span class="normal">right </span><span class="symbol">=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">positions</span><span class="symbol">[</span><span class="normal">i </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> xStart </span><span class="symbol">-</span><span class="normal"> subLineStart</span><span class="symbol">;</span>
<span class="normal">		</span><span class="comment">// Only try to draw if really visible - enhances performance by not calling environment to</span>
<span class="normal">		</span><span class="comment">// draw strings that are completely past the right side of the window.</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">rcSegment</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">&lt;=</span><span class="normal"> rcLine</span><span class="symbol">.</span><span class="normal">right</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">rcSegment</span><span class="symbol">.</span><span class="normal">right </span><span class="symbol">&gt;=</span><span class="normal"> rcLine</span><span class="symbol">.</span><span class="normal">left</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="comment">// Clip to line rectangle, since may have a huge position which will not work with some platforms</span>
<span class="normal">			rcSegment</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">=</span><span class="normal"> Platform</span><span class="symbol">::</span><span class="function">Maximum</span><span class="symbol">(</span><span class="normal">rcSegment</span><span class="symbol">.</span><span class="normal">left</span><span class="symbol">,</span><span class="normal"> rcLine</span><span class="symbol">.</span><span class="normal">left</span><span class="symbol">);</span>
<span class="normal">			rcSegment</span><span class="symbol">.</span><span class="normal">right </span><span class="symbol">=</span><span class="normal"> Platform</span><span class="symbol">::</span><span class="function">Minimum</span><span class="symbol">(</span><span class="normal">rcSegment</span><span class="symbol">.</span><span class="normal">right</span><span class="symbol">,</span><span class="normal"> rcLine</span><span class="symbol">.</span><span class="normal">right</span><span class="symbol">);</span>

<span class="normal">			</span><span class="type">int</span><span class="normal"> styleMain </span><span class="symbol">=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">];</span>
<span class="normal">			</span><span class="type">bool</span><span class="normal"> inSelection </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">iDoc </span><span class="symbol">&gt;=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">selStart</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">iDoc </span><span class="symbol">&lt;</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">selEnd</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">selStart </span><span class="symbol">!=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">selEnd</span><span class="symbol">);</span>
<span class="normal">			</span><span class="type">bool</span><span class="normal"> inHotspot </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">hsStart </span><span class="symbol">!=</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">iDoc </span><span class="symbol">&gt;=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">hsStart</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">iDoc </span><span class="symbol">&lt;</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">hsEnd</span><span class="symbol">);</span>
<span class="normal">			</span><span class="usertype">ColourAllocated</span><span class="normal"> textBack </span><span class="symbol">=</span><span class="normal"> </span><span class="function">TextBackground</span><span class="symbol">(</span><span class="normal">vsDraw</span><span class="symbol">,</span><span class="normal"> overrideBackground</span><span class="symbol">,</span><span class="normal"> background</span><span class="symbol">,</span><span class="normal"> inSelection</span><span class="symbol">,</span><span class="normal"> inHotspot</span><span class="symbol">,</span><span class="normal"> styleMain</span><span class="symbol">,</span><span class="normal"> i</span><span class="symbol">,</span><span class="normal"> ll</span><span class="symbol">);</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">chars</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="string">'</span><span class="specialchar">\t</span><span class="string">'</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="comment">// Tab display</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">drawWhitespaceBackground </span><span class="symbol">&amp;&amp;</span>
<span class="normal">				        </span><span class="symbol">(!</span><span class="normal">inIndentation </span><span class="symbol">||</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">viewWhitespace </span><span class="symbol">==</span><span class="normal"> wsVisibleAlways</span><span class="symbol">))</span>
<span class="normal">					textBack </span><span class="symbol">=</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">whitespaceBackground</span><span class="symbol">.</span><span class="normal">allocated</span><span class="symbol">;</span>
<span class="normal">				surface</span><span class="symbol">-&gt;</span><span class="function">FillRectangle</span><span class="symbol">(</span><span class="normal">rcSegment</span><span class="symbol">,</span><span class="normal"> textBack</span><span class="symbol">);</span>
<span class="normal">			</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">IsControlCharacter</span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">chars</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="comment">// Control character display</span>
<span class="normal">				inIndentation </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="normal">				surface</span><span class="symbol">-&gt;</span><span class="function">FillRectangle</span><span class="symbol">(</span><span class="normal">rcSegment</span><span class="symbol">,</span><span class="normal"> textBack</span><span class="symbol">);</span>
<span class="normal">			</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="comment">// Normal text display</span>
<span class="normal">				surface</span><span class="symbol">-&gt;</span><span class="function">FillRectangle</span><span class="symbol">(</span><span class="normal">rcSegment</span><span class="symbol">,</span><span class="normal"> textBack</span><span class="symbol">);</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vsDraw</span><span class="symbol">.</span><span class="normal">viewWhitespace </span><span class="symbol">!=</span><span class="normal"> wsInvisible </span><span class="symbol">||</span>
<span class="normal">				        </span><span class="symbol">(</span><span class="normal">inIndentation </span><span class="symbol">&amp;&amp;</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">viewIndentationGuides </span><span class="symbol">==</span><span class="normal"> ivReal</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="normal"> cpos </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> cpos </span><span class="symbol">&lt;=</span><span class="normal"> i </span><span class="symbol">-</span><span class="normal"> startseg</span><span class="symbol">;</span><span class="normal"> cpos</span><span class="symbol">++)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">						</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">chars</span><span class="symbol">[</span><span class="normal">cpos </span><span class="symbol">+</span><span class="normal"> startseg</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="string">' '</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">							</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">drawWhitespaceBackground </span><span class="symbol">&amp;&amp;</span>
<span class="normal">							        </span><span class="symbol">(!</span><span class="normal">inIndentation </span><span class="symbol">||</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">viewWhitespace </span><span class="symbol">==</span><span class="normal"> wsVisibleAlways</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">								</span><span class="usertype">PRectangle</span><span class="normal"> </span><span class="function">rcSpace</span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">positions</span><span class="symbol">[</span><span class="normal">cpos </span><span class="symbol">+</span><span class="normal"> startseg</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> xStart </span><span class="symbol">-</span><span class="normal"> subLineStart</span><span class="symbol">,</span>
<span class="normal">									rcSegment</span><span class="symbol">.</span><span class="normal">top</span><span class="symbol">,</span>
<span class="normal">									ll</span><span class="symbol">-&gt;</span><span class="normal">positions</span><span class="symbol">[</span><span class="normal">cpos </span><span class="symbol">+</span><span class="normal"> startseg </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> xStart </span><span class="symbol">-</span><span class="normal"> subLineStart</span><span class="symbol">,</span>
<span class="normal">									rcSegment</span><span class="symbol">.</span><span class="normal">bottom</span><span class="symbol">);</span>
<span class="normal">								surface</span><span class="symbol">-&gt;</span><span class="function">FillRectangle</span><span class="symbol">(</span><span class="normal">rcSpace</span><span class="symbol">,</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">whitespaceBackground</span><span class="symbol">.</span><span class="normal">allocated</span><span class="symbol">);</span>
<span class="normal">							</span><span class="cbracket">}</span>
<span class="normal">						</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">							inIndentation </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="normal">						</span><span class="cbracket">}</span>
<span class="normal">					</span><span class="cbracket">}</span>
<span class="normal">				</span><span class="cbracket">}</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">rcSegment</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">&gt;</span><span class="normal"> rcLine</span><span class="symbol">.</span><span class="normal">right</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">twoPhaseDraw</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">DrawEOL</span><span class="symbol">(</span><span class="normal">surface</span><span class="symbol">,</span><span class="normal"> vsDraw</span><span class="symbol">,</span><span class="normal"> rcLine</span><span class="symbol">,</span><span class="normal"> ll</span><span class="symbol">,</span><span class="normal"> line</span><span class="symbol">,</span><span class="normal"> lineEnd</span><span class="symbol">,</span>
<span class="normal">		        xStart</span><span class="symbol">,</span><span class="normal"> subLine</span><span class="symbol">,</span><span class="normal"> subLineStart</span><span class="symbol">,</span><span class="normal"> overrideBackground</span><span class="symbol">,</span><span class="normal"> background</span><span class="symbol">,</span>
<span class="normal">		        drawWrapMarkEnd</span><span class="symbol">,</span><span class="normal"> wrapColour</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="function">DrawIndicators</span><span class="symbol">(</span><span class="normal">surface</span><span class="symbol">,</span><span class="normal"> vsDraw</span><span class="symbol">,</span><span class="normal"> line</span><span class="symbol">,</span><span class="normal"> xStart</span><span class="symbol">,</span><span class="normal"> rcLine</span><span class="symbol">,</span><span class="normal"> ll</span><span class="symbol">,</span><span class="normal"> subLine</span><span class="symbol">,</span><span class="normal"> lineEnd</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vsDraw</span><span class="symbol">.</span><span class="normal">edgeState </span><span class="symbol">==</span><span class="normal"> EDGE_LINE</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> edgeX </span><span class="symbol">=</span><span class="normal"> theEdge </span><span class="symbol">*</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">spaceWidth</span><span class="symbol">;</span>
<span class="normal">		rcSegment</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">=</span><span class="normal"> edgeX </span><span class="symbol">+</span><span class="normal"> xStart</span><span class="symbol">;</span>
<span class="normal">		rcSegment</span><span class="symbol">.</span><span class="normal">right </span><span class="symbol">=</span><span class="normal"> rcSegment</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">		surface</span><span class="symbol">-&gt;</span><span class="function">FillRectangle</span><span class="symbol">(</span><span class="normal">rcSegment</span><span class="symbol">,</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">edgecolour</span><span class="symbol">.</span><span class="normal">allocated</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="comment">// Draw underline mark as part of background if not transparent</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> marks </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">GetMark</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">);</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> markBit</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">markBit </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">markBit </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">32</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> marks</span><span class="symbol">;</span><span class="normal"> markBit</span><span class="symbol">++)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">marks </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vsDraw</span><span class="symbol">.</span><span class="normal">markers</span><span class="symbol">[</span><span class="normal">markBit</span><span class="symbol">].</span><span class="normal">markType </span><span class="symbol">==</span><span class="normal"> SC_MARK_UNDERLINE</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span>
<span class="normal">		    </span><span class="symbol">(</span><span class="normal">vsDraw</span><span class="symbol">.</span><span class="normal">markers</span><span class="symbol">[</span><span class="normal">markBit</span><span class="symbol">].</span><span class="normal">alpha </span><span class="symbol">==</span><span class="normal"> SC_ALPHA_NOALPHA</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="usertype">PRectangle</span><span class="normal"> rcUnderline </span><span class="symbol">=</span><span class="normal"> rcLine</span><span class="symbol">;</span>
<span class="normal">			rcUnderline</span><span class="symbol">.</span><span class="normal">top </span><span class="symbol">=</span><span class="normal"> rcUnderline</span><span class="symbol">.</span><span class="normal">bottom </span><span class="symbol">-</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">			surface</span><span class="symbol">-&gt;</span><span class="function">FillRectangle</span><span class="symbol">(</span><span class="normal">rcUnderline</span><span class="symbol">,</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">markers</span><span class="symbol">[</span><span class="normal">markBit</span><span class="symbol">].</span><span class="normal">back</span><span class="symbol">.</span><span class="normal">allocated</span><span class="symbol">);</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		marks </span><span class="symbol">&gt;&gt;=</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	inIndentation </span><span class="symbol">=</span><span class="normal"> subLine </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal">	</span><span class="comment">// Do not handle indentation except on first subline.</span>
<span class="normal">	</span><span class="comment">// Foreground drawing loop</span>
<span class="normal">	</span><span class="usertype">BreakFinder</span><span class="normal"> </span><span class="function">bfFore</span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">,</span><span class="normal"> lineStart</span><span class="symbol">,</span><span class="normal"> lineEnd</span><span class="symbol">,</span><span class="normal"> posLineStart</span><span class="symbol">,</span><span class="normal"> </span><span class="function">IsUnicodeMode</span><span class="symbol">(),</span><span class="normal"> xStartVisible</span><span class="symbol">);</span>
<span class="normal">	next </span><span class="symbol">=</span><span class="normal"> bfFore</span><span class="symbol">.</span><span class="function">First</span><span class="symbol">();</span>

<span class="normal">	</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">next </span><span class="symbol">&lt;</span><span class="normal"> lineEnd</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>

<span class="normal">		startseg </span><span class="symbol">=</span><span class="normal"> next</span><span class="symbol">;</span>
<span class="normal">		next </span><span class="symbol">=</span><span class="normal"> bfFore</span><span class="symbol">.</span><span class="function">Next</span><span class="symbol">();</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> i </span><span class="symbol">=</span><span class="normal"> next </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>

<span class="normal">		</span><span class="type">int</span><span class="normal"> iDoc </span><span class="symbol">=</span><span class="normal"> i </span><span class="symbol">+</span><span class="normal"> posLineStart</span><span class="symbol">;</span>

<span class="normal">		rcSegment</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">positions</span><span class="symbol">[</span><span class="normal">startseg</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> xStart </span><span class="symbol">-</span><span class="normal"> subLineStart</span><span class="symbol">;</span>
<span class="normal">		rcSegment</span><span class="symbol">.</span><span class="normal">right </span><span class="symbol">=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">positions</span><span class="symbol">[</span><span class="normal">i </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> xStart </span><span class="symbol">-</span><span class="normal"> subLineStart</span><span class="symbol">;</span>
<span class="normal">		</span><span class="comment">// Only try to draw if really visible - enhances performance by not calling environment to</span>
<span class="normal">		</span><span class="comment">// draw strings that are completely past the right side of the window.</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">rcSegment</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">&lt;=</span><span class="normal"> rcLine</span><span class="symbol">.</span><span class="normal">right</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">rcSegment</span><span class="symbol">.</span><span class="normal">right </span><span class="symbol">&gt;=</span><span class="normal"> rcLine</span><span class="symbol">.</span><span class="normal">left</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> styleMain </span><span class="symbol">=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">];</span>
<span class="normal">			</span><span class="usertype">ColourAllocated</span><span class="normal"> textFore </span><span class="symbol">=</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">styleMain</span><span class="symbol">].</span><span class="normal">fore</span><span class="symbol">.</span><span class="normal">allocated</span><span class="symbol">;</span>
<span class="normal">			</span><span class="usertype">Font</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">textFont </span><span class="symbol">=</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">styleMain</span><span class="symbol">].</span><span class="normal">font</span><span class="symbol">;</span>
<span class="normal">			</span><span class="comment">//hotspot foreground</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">hsStart </span><span class="symbol">!=</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> iDoc </span><span class="symbol">&gt;=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">hsStart </span><span class="symbol">&amp;&amp;</span><span class="normal"> iDoc </span><span class="symbol">&lt;</span><span class="normal"> hsEnd</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vsDraw</span><span class="symbol">.</span><span class="normal">hotspotForegroundSet</span><span class="symbol">)</span>
<span class="normal">					textFore </span><span class="symbol">=</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">hotspotForeground</span><span class="symbol">.</span><span class="normal">allocated</span><span class="symbol">;</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">			</span><span class="type">bool</span><span class="normal"> inSelection </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">iDoc </span><span class="symbol">&gt;=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">selStart</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">iDoc </span><span class="symbol">&lt;</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">selEnd</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">selStart </span><span class="symbol">!=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">selEnd</span><span class="symbol">);</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">inSelection </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vsDraw</span><span class="symbol">.</span><span class="normal">selforeset</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				textFore </span><span class="symbol">=</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">selforeground</span><span class="symbol">.</span><span class="normal">allocated</span><span class="symbol">;</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">			</span><span class="type">bool</span><span class="normal"> inHotspot </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">hsStart </span><span class="symbol">!=</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">iDoc </span><span class="symbol">&gt;=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">hsStart</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">iDoc </span><span class="symbol">&lt;</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">hsEnd</span><span class="symbol">);</span>
<span class="normal">			</span><span class="usertype">ColourAllocated</span><span class="normal"> textBack </span><span class="symbol">=</span><span class="normal"> </span><span class="function">TextBackground</span><span class="symbol">(</span><span class="normal">vsDraw</span><span class="symbol">,</span><span class="normal"> overrideBackground</span><span class="symbol">,</span><span class="normal"> background</span><span class="symbol">,</span><span class="normal"> inSelection</span><span class="symbol">,</span><span class="normal"> inHotspot</span><span class="symbol">,</span><span class="normal"> styleMain</span><span class="symbol">,</span><span class="normal"> i</span><span class="symbol">,</span><span class="normal"> ll</span><span class="symbol">);</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">chars</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="string">'</span><span class="specialchar">\t</span><span class="string">'</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="comment">// Tab display</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">twoPhaseDraw</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">drawWhitespaceBackground </span><span class="symbol">&amp;&amp;</span>
<span class="normal">					        </span><span class="symbol">(!</span><span class="normal">inIndentation </span><span class="symbol">||</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">viewWhitespace </span><span class="symbol">==</span><span class="normal"> wsVisibleAlways</span><span class="symbol">))</span>
<span class="normal">						textBack </span><span class="symbol">=</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">whitespaceBackground</span><span class="symbol">.</span><span class="normal">allocated</span><span class="symbol">;</span>
<span class="normal">					surface</span><span class="symbol">-&gt;</span><span class="function">FillRectangle</span><span class="symbol">(</span><span class="normal">rcSegment</span><span class="symbol">,</span><span class="normal"> textBack</span><span class="symbol">);</span>
<span class="normal">				</span><span class="cbracket">}</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">vsDraw</span><span class="symbol">.</span><span class="normal">viewWhitespace </span><span class="symbol">!=</span><span class="normal"> wsInvisible</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">||</span>
<span class="normal">				        </span><span class="symbol">(</span><span class="normal">inIndentation </span><span class="symbol">&amp;&amp;</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">viewIndentationGuides </span><span class="symbol">!=</span><span class="normal"> ivNone</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vsDraw</span><span class="symbol">.</span><span class="normal">whitespaceForegroundSet</span><span class="symbol">)</span>
<span class="normal">						textFore </span><span class="symbol">=</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">whitespaceForeground</span><span class="symbol">.</span><span class="normal">allocated</span><span class="symbol">;</span>
<span class="normal">					surface</span><span class="symbol">-&gt;</span><span class="function">PenColour</span><span class="symbol">(</span><span class="normal">textFore</span><span class="symbol">);</span>
<span class="normal">				</span><span class="cbracket">}</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">inIndentation </span><span class="symbol">&amp;&amp;</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">viewIndentationGuides </span><span class="symbol">==</span><span class="normal"> ivReal</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="normal"> xIG </span><span class="symbol">=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">positions</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">/</span><span class="normal"> indentWidth </span><span class="symbol">*</span><span class="normal"> indentWidth</span><span class="symbol">;</span><span class="normal"> xIG </span><span class="symbol">&lt;</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">positions</span><span class="symbol">[</span><span class="normal">i </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">];</span><span class="normal"> xIG </span><span class="symbol">+=</span><span class="normal"> indentWidth</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">						</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">xIG </span><span class="symbol">&gt;=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">positions</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> xIG </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">							</span><span class="function">DrawIndentGuide</span><span class="symbol">(</span><span class="normal">surface</span><span class="symbol">,</span><span class="normal"> lineVisible</span><span class="symbol">,</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">lineHeight</span><span class="symbol">,</span><span class="normal"> xIG </span><span class="symbol">+</span><span class="normal"> xStart</span><span class="symbol">,</span><span class="normal"> rcSegment</span><span class="symbol">,</span>
<span class="normal">							        </span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">xHighlightGuide </span><span class="symbol">==</span><span class="normal"> xIG</span><span class="symbol">));</span>
<span class="normal">						</span><span class="cbracket">}</span>
<span class="normal">					</span><span class="cbracket">}</span>
<span class="normal">				</span><span class="cbracket">}</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vsDraw</span><span class="symbol">.</span><span class="normal">viewWhitespace </span><span class="symbol">!=</span><span class="normal"> wsInvisible</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">inIndentation </span><span class="symbol">||</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">viewWhitespace </span><span class="symbol">==</span><span class="normal"> wsVisibleAlways</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">						</span><span class="usertype">PRectangle</span><span class="normal"> </span><span class="function">rcTab</span><span class="symbol">(</span><span class="normal">rcSegment</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span><span class="normal"> rcSegment</span><span class="symbol">.</span><span class="normal">top </span><span class="symbol">+</span><span class="normal"> </span><span class="number">4</span><span class="symbol">,</span>
<span class="normal">						        rcSegment</span><span class="symbol">.</span><span class="normal">right </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span><span class="normal"> rcSegment</span><span class="symbol">.</span><span class="normal">bottom </span><span class="symbol">-</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">maxDescent</span><span class="symbol">);</span>
<span class="normal">						</span><span class="function">DrawTabArrow</span><span class="symbol">(</span><span class="normal">surface</span><span class="symbol">,</span><span class="normal"> rcTab</span><span class="symbol">,</span><span class="normal"> rcSegment</span><span class="symbol">.</span><span class="normal">top </span><span class="symbol">+</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">lineHeight </span><span class="symbol">/</span><span class="normal"> </span><span class="number">2</span><span class="symbol">);</span>
<span class="normal">					</span><span class="cbracket">}</span>
<span class="normal">				</span><span class="cbracket">}</span>
<span class="normal">			</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">IsControlCharacter</span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">chars</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="comment">// Control character display</span>
<span class="normal">				inIndentation </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">controlCharSymbol </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">32</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="comment">// Draw the character</span>
<span class="normal">					</span><span class="keyword">const</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">ctrlChar </span><span class="symbol">=</span><span class="normal"> </span><span class="function">ControlCharacterString</span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">chars</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]);</span>
<span class="normal">					</span><span class="function">DrawTextBlob</span><span class="symbol">(</span><span class="normal">surface</span><span class="symbol">,</span><span class="normal"> vsDraw</span><span class="symbol">,</span><span class="normal"> rcSegment</span><span class="symbol">,</span><span class="normal"> ctrlChar</span><span class="symbol">,</span><span class="normal"> textBack</span><span class="symbol">,</span><span class="normal"> textFore</span><span class="symbol">,</span><span class="normal"> twoPhaseDraw</span><span class="symbol">);</span>
<span class="normal">				</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="type">char</span><span class="normal"> cc</span><span class="symbol">[</span><span class="number">2</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal"> </span><span class="keyword">static_cast</span><span class="symbol">&lt;</span><span class="type">char</span><span class="symbol">&gt;(</span><span class="normal">controlCharSymbol</span><span class="symbol">),</span><span class="normal"> </span><span class="string">'</span><span class="specialchar">\0</span><span class="string">'</span><span class="normal"> </span><span class="cbracket">}</span><span class="symbol">;</span>
<span class="normal">					surface</span><span class="symbol">-&gt;</span><span class="function">DrawTextNoClip</span><span class="symbol">(</span><span class="normal">rcSegment</span><span class="symbol">,</span><span class="normal"> ctrlCharsFont</span><span class="symbol">,</span>
<span class="normal">					        rcSegment</span><span class="symbol">.</span><span class="normal">top </span><span class="symbol">+</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">maxAscent</span><span class="symbol">,</span>
<span class="normal">					        cc</span><span class="symbol">,</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span><span class="normal"> textBack</span><span class="symbol">,</span><span class="normal"> textFore</span><span class="symbol">);</span>
<span class="normal">				</span><span class="cbracket">}</span>
<span class="normal">			</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">i </span><span class="symbol">==</span><span class="normal"> startseg</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="keyword">static_cast</span><span class="symbol">&lt;</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="symbol">&gt;(</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">chars</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">])</span><span class="normal"> </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">0x80</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="function">IsUnicodeMode</span><span class="symbol">())</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="type">char</span><span class="normal"> hexits</span><span class="symbol">[</span><span class="number">3</span><span class="symbol">];</span>
<span class="normal">				</span><span class="function">sprintf</span><span class="symbol">(</span><span class="normal">hexits</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%2X"</span><span class="symbol">,</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">chars</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">				</span><span class="function">DrawTextBlob</span><span class="symbol">(</span><span class="normal">surface</span><span class="symbol">,</span><span class="normal"> vsDraw</span><span class="symbol">,</span><span class="normal"> rcSegment</span><span class="symbol">,</span><span class="normal"> hexits</span><span class="symbol">,</span><span class="normal"> textBack</span><span class="symbol">,</span><span class="normal"> textFore</span><span class="symbol">,</span><span class="normal"> twoPhaseDraw</span><span class="symbol">);</span>
<span class="normal">			</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="comment">// Normal text display</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vsDraw</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">styleMain</span><span class="symbol">].</span><span class="normal">visible</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">twoPhaseDraw</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">						surface</span><span class="symbol">-&gt;</span><span class="function">DrawTextTransparent</span><span class="symbol">(</span><span class="normal">rcSegment</span><span class="symbol">,</span><span class="normal"> textFont</span><span class="symbol">,</span>
<span class="normal">						        rcSegment</span><span class="symbol">.</span><span class="normal">top </span><span class="symbol">+</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">maxAscent</span><span class="symbol">,</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">chars </span><span class="symbol">+</span><span class="normal"> startseg</span><span class="symbol">,</span>
<span class="normal">						        i </span><span class="symbol">-</span><span class="normal"> startseg </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span><span class="normal"> textFore</span><span class="symbol">);</span>
<span class="normal">					</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">						surface</span><span class="symbol">-&gt;</span><span class="function">DrawTextNoClip</span><span class="symbol">(</span><span class="normal">rcSegment</span><span class="symbol">,</span><span class="normal"> textFont</span><span class="symbol">,</span>
<span class="normal">						        rcSegment</span><span class="symbol">.</span><span class="normal">top </span><span class="symbol">+</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">maxAscent</span><span class="symbol">,</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">chars </span><span class="symbol">+</span><span class="normal"> startseg</span><span class="symbol">,</span>
<span class="normal">						        i </span><span class="symbol">-</span><span class="normal"> startseg </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span><span class="normal"> textFore</span><span class="symbol">,</span><span class="normal"> textBack</span><span class="symbol">);</span>
<span class="normal">					</span><span class="cbracket">}</span>
<span class="normal">				</span><span class="cbracket">}</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vsDraw</span><span class="symbol">.</span><span class="normal">viewWhitespace </span><span class="symbol">!=</span><span class="normal"> wsInvisible </span><span class="symbol">||</span>
<span class="normal">				        </span><span class="symbol">(</span><span class="normal">inIndentation </span><span class="symbol">&amp;&amp;</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">viewIndentationGuides </span><span class="symbol">!=</span><span class="normal"> ivNone</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="normal"> cpos </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> cpos </span><span class="symbol">&lt;=</span><span class="normal"> i </span><span class="symbol">-</span><span class="normal"> startseg</span><span class="symbol">;</span><span class="normal"> cpos</span><span class="symbol">++)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">						</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">chars</span><span class="symbol">[</span><span class="normal">cpos </span><span class="symbol">+</span><span class="normal"> startseg</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="string">' '</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">							</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vsDraw</span><span class="symbol">.</span><span class="normal">viewWhitespace </span><span class="symbol">!=</span><span class="normal"> wsInvisible</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">								</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vsDraw</span><span class="symbol">.</span><span class="normal">whitespaceForegroundSet</span><span class="symbol">)</span>
<span class="normal">									textFore </span><span class="symbol">=</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">whitespaceForeground</span><span class="symbol">.</span><span class="normal">allocated</span><span class="symbol">;</span>
<span class="normal">								</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">inIndentation </span><span class="symbol">||</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">viewWhitespace </span><span class="symbol">==</span><span class="normal"> wsVisibleAlways</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">									</span><span class="type">int</span><span class="normal"> xmid </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">positions</span><span class="symbol">[</span><span class="normal">cpos </span><span class="symbol">+</span><span class="normal"> startseg</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">positions</span><span class="symbol">[</span><span class="normal">cpos </span><span class="symbol">+</span><span class="normal"> startseg </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">])</span><span class="normal"> </span><span class="symbol">/</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">									</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">twoPhaseDraw </span><span class="symbol">&amp;&amp;</span><span class="normal"> drawWhitespaceBackground </span><span class="symbol">&amp;&amp;</span>
<span class="normal">									        </span><span class="symbol">(!</span><span class="normal">inIndentation </span><span class="symbol">||</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">viewWhitespace </span><span class="symbol">==</span><span class="normal"> wsVisibleAlways</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">										textBack </span><span class="symbol">=</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">whitespaceBackground</span><span class="symbol">.</span><span class="normal">allocated</span><span class="symbol">;</span>
<span class="normal">										</span><span class="usertype">PRectangle</span><span class="normal"> </span><span class="function">rcSpace</span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">positions</span><span class="symbol">[</span><span class="normal">cpos </span><span class="symbol">+</span><span class="normal"> startseg</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> xStart </span><span class="symbol">-</span><span class="normal"> subLineStart</span><span class="symbol">,</span>
<span class="normal">											rcSegment</span><span class="symbol">.</span><span class="normal">top</span><span class="symbol">,</span>
<span class="normal">											ll</span><span class="symbol">-&gt;</span><span class="normal">positions</span><span class="symbol">[</span><span class="normal">cpos </span><span class="symbol">+</span><span class="normal"> startseg </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> xStart </span><span class="symbol">-</span><span class="normal"> subLineStart</span><span class="symbol">,</span>
<span class="normal">											rcSegment</span><span class="symbol">.</span><span class="normal">bottom</span><span class="symbol">);</span>
<span class="normal">										surface</span><span class="symbol">-&gt;</span><span class="function">FillRectangle</span><span class="symbol">(</span><span class="normal">rcSpace</span><span class="symbol">,</span><span class="normal"> textBack</span><span class="symbol">);</span>
<span class="normal">									</span><span class="cbracket">}</span>
<span class="normal">									</span><span class="usertype">PRectangle</span><span class="normal"> </span><span class="function">rcDot</span><span class="symbol">(</span><span class="normal">xmid </span><span class="symbol">+</span><span class="normal"> xStart </span><span class="symbol">-</span><span class="normal"> subLineStart</span><span class="symbol">,</span><span class="normal"> rcSegment</span><span class="symbol">.</span><span class="normal">top </span><span class="symbol">+</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">lineHeight </span><span class="symbol">/</span><span class="normal"> </span><span class="number">2</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">);</span>
<span class="normal">									rcDot</span><span class="symbol">.</span><span class="normal">right </span><span class="symbol">=</span><span class="normal"> rcDot</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">									rcDot</span><span class="symbol">.</span><span class="normal">bottom </span><span class="symbol">=</span><span class="normal"> rcDot</span><span class="symbol">.</span><span class="normal">top </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">									surface</span><span class="symbol">-&gt;</span><span class="function">FillRectangle</span><span class="symbol">(</span><span class="normal">rcDot</span><span class="symbol">,</span><span class="normal"> textFore</span><span class="symbol">);</span>
<span class="normal">								</span><span class="cbracket">}</span>
<span class="normal">							</span><span class="cbracket">}</span>
<span class="normal">							</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">inIndentation </span><span class="symbol">&amp;&amp;</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">viewIndentationGuides </span><span class="symbol">==</span><span class="normal"> ivReal</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">								</span><span class="type">int</span><span class="normal"> startSpace </span><span class="symbol">=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">positions</span><span class="symbol">[</span><span class="normal">cpos </span><span class="symbol">+</span><span class="normal"> startseg</span><span class="symbol">];</span>
<span class="normal">								</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">startSpace </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">0</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">startSpace </span><span class="symbol">%</span><span class="normal"> indentWidth </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">									</span><span class="function">DrawIndentGuide</span><span class="symbol">(</span><span class="normal">surface</span><span class="symbol">,</span><span class="normal"> lineVisible</span><span class="symbol">,</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">lineHeight</span><span class="symbol">,</span><span class="normal"> startSpace </span><span class="symbol">+</span><span class="normal"> xStart</span><span class="symbol">,</span><span class="normal"> rcSegment</span><span class="symbol">,</span>
<span class="normal">									        </span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">xHighlightGuide </span><span class="symbol">==</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">positions</span><span class="symbol">[</span><span class="normal">cpos </span><span class="symbol">+</span><span class="normal"> startseg</span><span class="symbol">]));</span>
<span class="normal">								</span><span class="cbracket">}</span>
<span class="normal">							</span><span class="cbracket">}</span>
<span class="normal">						</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">							inIndentation </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="normal">						</span><span class="cbracket">}</span>
<span class="normal">					</span><span class="cbracket">}</span>
<span class="normal">				</span><span class="cbracket">}</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">hsStart </span><span class="symbol">!=</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">hotspotUnderline </span><span class="symbol">&amp;&amp;</span><span class="normal"> iDoc </span><span class="symbol">&gt;=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">hsStart </span><span class="symbol">&amp;&amp;</span><span class="normal"> iDoc </span><span class="symbol">&lt;</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">hsEnd </span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="usertype">PRectangle</span><span class="normal"> rcUL </span><span class="symbol">=</span><span class="normal"> rcSegment</span><span class="symbol">;</span>
<span class="normal">				rcUL</span><span class="symbol">.</span><span class="normal">top </span><span class="symbol">=</span><span class="normal"> rcUL</span><span class="symbol">.</span><span class="normal">top </span><span class="symbol">+</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">maxAscent </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">				rcUL</span><span class="symbol">.</span><span class="normal">bottom </span><span class="symbol">=</span><span class="normal"> rcUL</span><span class="symbol">.</span><span class="normal">top </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vsDraw</span><span class="symbol">.</span><span class="normal">hotspotForegroundSet</span><span class="symbol">)</span>
<span class="normal">					surface</span><span class="symbol">-&gt;</span><span class="function">FillRectangle</span><span class="symbol">(</span><span class="normal">rcUL</span><span class="symbol">,</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">hotspotForeground</span><span class="symbol">.</span><span class="normal">allocated</span><span class="symbol">);</span>
<span class="normal">				</span><span class="keyword">else</span>
<span class="normal">					surface</span><span class="symbol">-&gt;</span><span class="function">FillRectangle</span><span class="symbol">(</span><span class="normal">rcUL</span><span class="symbol">,</span><span class="normal"> textFore</span><span class="symbol">);</span>
<span class="normal">			</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vsDraw</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">styleMain</span><span class="symbol">].</span><span class="normal">underline</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="usertype">PRectangle</span><span class="normal"> rcUL </span><span class="symbol">=</span><span class="normal"> rcSegment</span><span class="symbol">;</span>
<span class="normal">				rcUL</span><span class="symbol">.</span><span class="normal">top </span><span class="symbol">=</span><span class="normal"> rcUL</span><span class="symbol">.</span><span class="normal">top </span><span class="symbol">+</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">maxAscent </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">				rcUL</span><span class="symbol">.</span><span class="normal">bottom </span><span class="symbol">=</span><span class="normal"> rcUL</span><span class="symbol">.</span><span class="normal">top </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">				surface</span><span class="symbol">-&gt;</span><span class="function">FillRectangle</span><span class="symbol">(</span><span class="normal">rcUL</span><span class="symbol">,</span><span class="normal"> textFore</span><span class="symbol">);</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">rcSegment</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">&gt;</span><span class="normal"> rcLine</span><span class="symbol">.</span><span class="normal">right</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">vsDraw</span><span class="symbol">.</span><span class="normal">viewIndentationGuides </span><span class="symbol">==</span><span class="normal"> ivLookForward </span><span class="symbol">||</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">viewIndentationGuides </span><span class="symbol">==</span><span class="normal"> ivLookBoth</span><span class="symbol">)</span>
<span class="normal">	        </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">subLine </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> indentSpace </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">GetLineIndentation</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">);</span>
<span class="normal">		</span><span class="comment">// Find the most recent line with some text</span>

<span class="normal">		</span><span class="type">int</span><span class="normal"> lineLastWithText </span><span class="symbol">=</span><span class="normal"> line</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lineLastWithText </span><span class="symbol">&gt;</span><span class="normal"> Platform</span><span class="symbol">::</span><span class="function">Maximum</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">-</span><span class="number">20</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">IsWhiteLine</span><span class="symbol">(</span><span class="normal">lineLastWithText</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			lineLastWithText</span><span class="symbol">--;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lineLastWithText </span><span class="symbol">&lt;</span><span class="normal"> line</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="comment">// This line is empty, so use indentation of last line with text</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> indentLastWithText </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">GetLineIndentation</span><span class="symbol">(</span><span class="normal">lineLastWithText</span><span class="symbol">);</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> isFoldHeader </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">GetLevel</span><span class="symbol">(</span><span class="normal">lineLastWithText</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> SC_FOLDLEVELHEADERFLAG</span><span class="symbol">;</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">isFoldHeader</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="comment">// Level is one more level than parent</span>
<span class="normal">				indentLastWithText </span><span class="symbol">+=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">IndentSize</span><span class="symbol">();</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vsDraw</span><span class="symbol">.</span><span class="normal">viewIndentationGuides </span><span class="symbol">==</span><span class="normal"> ivLookForward</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="comment">// In viLookForward mode, previous line only used if it is a fold header</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">isFoldHeader</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					indentSpace </span><span class="symbol">=</span><span class="normal"> Platform</span><span class="symbol">::</span><span class="function">Maximum</span><span class="symbol">(</span><span class="normal">indentSpace</span><span class="symbol">,</span><span class="normal"> indentLastWithText</span><span class="symbol">);</span>
<span class="normal">				</span><span class="cbracket">}</span>
<span class="normal">			</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal">	</span><span class="comment">// viLookBoth</span>
<span class="normal">				indentSpace </span><span class="symbol">=</span><span class="normal"> Platform</span><span class="symbol">::</span><span class="function">Maximum</span><span class="symbol">(</span><span class="normal">indentSpace</span><span class="symbol">,</span><span class="normal"> indentLastWithText</span><span class="symbol">);</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span>

<span class="normal">		</span><span class="type">int</span><span class="normal"> lineNextWithText </span><span class="symbol">=</span><span class="normal"> line</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lineNextWithText </span><span class="symbol">&lt;</span><span class="normal"> Platform</span><span class="symbol">::</span><span class="function">Minimum</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">+</span><span class="number">20</span><span class="symbol">,</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LinesTotal</span><span class="symbol">())</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">IsWhiteLine</span><span class="symbol">(</span><span class="normal">lineNextWithText</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			lineNextWithText</span><span class="symbol">++;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lineNextWithText </span><span class="symbol">&gt;</span><span class="normal"> line</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="comment">// This line is empty, so use indentation of last line with text</span>
<span class="normal">			indentSpace </span><span class="symbol">=</span><span class="normal"> Platform</span><span class="symbol">::</span><span class="function">Maximum</span><span class="symbol">(</span><span class="normal">indentSpace</span><span class="symbol">,</span>
<span class="normal">			        pdoc</span><span class="symbol">-&gt;</span><span class="function">GetLineIndentation</span><span class="symbol">(</span><span class="normal">lineNextWithText</span><span class="symbol">));</span>
<span class="normal">		</span><span class="cbracket">}</span>

<span class="normal">		</span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="normal"> indentPos </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">IndentSize</span><span class="symbol">();</span><span class="normal"> indentPos </span><span class="symbol">&lt;</span><span class="normal"> indentSpace</span><span class="symbol">;</span><span class="normal"> indentPos </span><span class="symbol">+=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">IndentSize</span><span class="symbol">())</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> xIndent </span><span class="symbol">=</span><span class="normal"> indentPos </span><span class="symbol">*</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">spaceWidth</span><span class="symbol">;</span>
<span class="normal">			</span><span class="function">DrawIndentGuide</span><span class="symbol">(</span><span class="normal">surface</span><span class="symbol">,</span><span class="normal"> lineVisible</span><span class="symbol">,</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">lineHeight</span><span class="symbol">,</span><span class="normal"> xIndent </span><span class="symbol">+</span><span class="normal"> xStart</span><span class="symbol">,</span><span class="normal"> rcSegment</span><span class="symbol">,</span>
<span class="normal">			        </span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">xHighlightGuide </span><span class="symbol">==</span><span class="normal"> xIndent</span><span class="symbol">));</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="function">DrawIndicators</span><span class="symbol">(</span><span class="normal">surface</span><span class="symbol">,</span><span class="normal"> vsDraw</span><span class="symbol">,</span><span class="normal"> line</span><span class="symbol">,</span><span class="normal"> xStart</span><span class="symbol">,</span><span class="normal"> rcLine</span><span class="symbol">,</span><span class="normal"> ll</span><span class="symbol">,</span><span class="normal"> subLine</span><span class="symbol">,</span><span class="normal"> lineEnd</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">);</span>

<span class="normal">	</span><span class="comment">// End of the drawing of the current line</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">twoPhaseDraw</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">DrawEOL</span><span class="symbol">(</span><span class="normal">surface</span><span class="symbol">,</span><span class="normal"> vsDraw</span><span class="symbol">,</span><span class="normal"> rcLine</span><span class="symbol">,</span><span class="normal"> ll</span><span class="symbol">,</span><span class="normal"> line</span><span class="symbol">,</span><span class="normal"> lineEnd</span><span class="symbol">,</span>
<span class="normal">		        xStart</span><span class="symbol">,</span><span class="normal"> subLine</span><span class="symbol">,</span><span class="normal"> subLineStart</span><span class="symbol">,</span><span class="normal"> overrideBackground</span><span class="symbol">,</span><span class="normal"> background</span><span class="symbol">,</span>
<span class="normal">		        drawWrapMarkEnd</span><span class="symbol">,</span><span class="normal"> wrapColour</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">vsDraw</span><span class="symbol">.</span><span class="normal">selAlpha </span><span class="symbol">!=</span><span class="normal"> SC_ALPHA_NOALPHA</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">selStart </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">selEnd </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> startPosSel </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">selStart </span><span class="symbol">&lt;</span><span class="normal"> posLineStart</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">?</span><span class="normal"> posLineStart </span><span class="symbol">:</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">selStart</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> endPosSel </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">selEnd </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lineEnd </span><span class="symbol">+</span><span class="normal"> posLineStart</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">?</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">selEnd </span><span class="symbol">:</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lineEnd </span><span class="symbol">+</span><span class="normal"> posLineStart</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">startPosSel </span><span class="symbol">&lt;</span><span class="normal"> endPosSel</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			rcSegment</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">=</span><span class="normal"> xStart </span><span class="symbol">+</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">positions</span><span class="symbol">[</span><span class="normal">startPosSel </span><span class="symbol">-</span><span class="normal"> posLineStart</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> subLineStart</span><span class="symbol">;</span>
<span class="normal">			rcSegment</span><span class="symbol">.</span><span class="normal">right </span><span class="symbol">=</span><span class="normal"> xStart </span><span class="symbol">+</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">positions</span><span class="symbol">[</span><span class="normal">endPosSel </span><span class="symbol">-</span><span class="normal"> posLineStart</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> subLineStart</span><span class="symbol">;</span>
<span class="normal">			rcSegment</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">=</span><span class="normal"> Platform</span><span class="symbol">::</span><span class="function">Maximum</span><span class="symbol">(</span><span class="normal">rcSegment</span><span class="symbol">.</span><span class="normal">left</span><span class="symbol">,</span><span class="normal"> rcLine</span><span class="symbol">.</span><span class="normal">left</span><span class="symbol">);</span>
<span class="normal">			rcSegment</span><span class="symbol">.</span><span class="normal">right </span><span class="symbol">=</span><span class="normal"> Platform</span><span class="symbol">::</span><span class="function">Minimum</span><span class="symbol">(</span><span class="normal">rcSegment</span><span class="symbol">.</span><span class="normal">right</span><span class="symbol">,</span><span class="normal"> rcLine</span><span class="symbol">.</span><span class="normal">right</span><span class="symbol">);</span>
<span class="normal">			</span><span class="function">SimpleAlphaRectangle</span><span class="symbol">(</span><span class="normal">surface</span><span class="symbol">,</span><span class="normal"> rcSegment</span><span class="symbol">,</span><span class="normal"> </span><span class="function">SelectionBackground</span><span class="symbol">(</span><span class="normal">vsDraw</span><span class="symbol">),</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">selAlpha</span><span class="symbol">);</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="comment">// Draw any translucent whole line states</span>
<span class="normal">	rcSegment</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">=</span><span class="normal"> xStart</span><span class="symbol">;</span>
<span class="normal">	rcSegment</span><span class="symbol">.</span><span class="normal">right </span><span class="symbol">=</span><span class="normal"> rcLine</span><span class="symbol">.</span><span class="normal">right </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">caret</span><span class="symbol">.</span><span class="normal">active </span><span class="symbol">&amp;&amp;</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">showCaretLineBackground </span><span class="symbol">&amp;&amp;</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">containsCaret</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">SimpleAlphaRectangle</span><span class="symbol">(</span><span class="normal">surface</span><span class="symbol">,</span><span class="normal"> rcSegment</span><span class="symbol">,</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">caretLineBackground</span><span class="symbol">.</span><span class="normal">allocated</span><span class="symbol">,</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">caretLineAlpha</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	marks </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">GetMark</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">markBit </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">markBit </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">32</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> marks</span><span class="symbol">;</span><span class="normal"> markBit</span><span class="symbol">++)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">marks </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vsDraw</span><span class="symbol">.</span><span class="normal">markers</span><span class="symbol">[</span><span class="normal">markBit</span><span class="symbol">].</span><span class="normal">markType </span><span class="symbol">==</span><span class="normal"> SC_MARK_BACKGROUND</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="function">SimpleAlphaRectangle</span><span class="symbol">(</span><span class="normal">surface</span><span class="symbol">,</span><span class="normal"> rcSegment</span><span class="symbol">,</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">markers</span><span class="symbol">[</span><span class="normal">markBit</span><span class="symbol">].</span><span class="normal">back</span><span class="symbol">.</span><span class="normal">allocated</span><span class="symbol">,</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">markers</span><span class="symbol">[</span><span class="normal">markBit</span><span class="symbol">].</span><span class="normal">alpha</span><span class="symbol">);</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">marks </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vsDraw</span><span class="symbol">.</span><span class="normal">markers</span><span class="symbol">[</span><span class="normal">markBit</span><span class="symbol">].</span><span class="normal">markType </span><span class="symbol">==</span><span class="normal"> SC_MARK_UNDERLINE</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="usertype">PRectangle</span><span class="normal"> rcUnderline </span><span class="symbol">=</span><span class="normal"> rcSegment</span><span class="symbol">;</span>
<span class="normal">			rcUnderline</span><span class="symbol">.</span><span class="normal">top </span><span class="symbol">=</span><span class="normal"> rcUnderline</span><span class="symbol">.</span><span class="normal">bottom </span><span class="symbol">-</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">			</span><span class="function">SimpleAlphaRectangle</span><span class="symbol">(</span><span class="normal">surface</span><span class="symbol">,</span><span class="normal"> rcUnderline</span><span class="symbol">,</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">markers</span><span class="symbol">[</span><span class="normal">markBit</span><span class="symbol">].</span><span class="normal">back</span><span class="symbol">.</span><span class="normal">allocated</span><span class="symbol">,</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">markers</span><span class="symbol">[</span><span class="normal">markBit</span><span class="symbol">].</span><span class="normal">alpha</span><span class="symbol">);</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		marks </span><span class="symbol">&gt;&gt;=</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vsDraw</span><span class="symbol">.</span><span class="normal">maskInLine</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> marksMasked </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">GetMark</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">maskInLine</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">marksMasked</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">markBit </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">markBit </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">32</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> marksMasked</span><span class="symbol">;</span><span class="normal"> markBit</span><span class="symbol">++)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">marksMasked </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vsDraw</span><span class="symbol">.</span><span class="normal">markers</span><span class="symbol">[</span><span class="normal">markBit</span><span class="symbol">].</span><span class="normal">markType </span><span class="symbol">!=</span><span class="normal"> SC_MARK_EMPTY</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="function">SimpleAlphaRectangle</span><span class="symbol">(</span><span class="normal">surface</span><span class="symbol">,</span><span class="normal"> rcSegment</span><span class="symbol">,</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">markers</span><span class="symbol">[</span><span class="normal">markBit</span><span class="symbol">].</span><span class="normal">back</span><span class="symbol">.</span><span class="normal">allocated</span><span class="symbol">,</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">markers</span><span class="symbol">[</span><span class="normal">markBit</span><span class="symbol">].</span><span class="normal">alpha</span><span class="symbol">);</span>
<span class="normal">				</span><span class="cbracket">}</span>
<span class="normal">				marksMasked </span><span class="symbol">&gt;&gt;=</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">DrawBlockCaret</span><span class="symbol">(</span><span class="usertype">Surface</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">surface</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">ViewStyle</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">vsDraw</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">LineLayout</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">ll</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> subLine</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> xStart</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> offset</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> posCaret</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">PRectangle</span><span class="normal"> rcCaret</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>

<span class="normal">	</span><span class="type">int</span><span class="normal"> lineStart </span><span class="symbol">=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">subLine</span><span class="symbol">);</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> posBefore </span><span class="symbol">=</span><span class="normal"> posCaret</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> posAfter </span><span class="symbol">=</span><span class="normal"> </span><span class="function">MovePositionOutsideChar</span><span class="symbol">(</span><span class="normal">posCaret </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> numCharsToDraw </span><span class="symbol">=</span><span class="normal"> posAfter </span><span class="symbol">-</span><span class="normal"> posCaret</span><span class="symbol">;</span>

<span class="normal">	</span><span class="comment">// Work out where the starting and ending offsets are. We need to</span>
<span class="normal">	</span><span class="comment">// see if the previous character shares horizontal space, such as a</span>
<span class="normal">	</span><span class="comment">// glyph / combining character. If so we'll need to draw that too.</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> offsetFirstChar </span><span class="symbol">=</span><span class="normal"> offset</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> offsetLastChar </span><span class="symbol">=</span><span class="normal"> offset </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">posAfter </span><span class="symbol">-</span><span class="normal"> posCaret</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">offsetLastChar </span><span class="symbol">-</span><span class="normal"> numCharsToDraw</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;=</span><span class="normal"> lineStart</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">positions</span><span class="symbol">[</span><span class="normal">offsetLastChar</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">positions</span><span class="symbol">[</span><span class="normal">offsetLastChar </span><span class="symbol">-</span><span class="normal"> numCharsToDraw</span><span class="symbol">])</span><span class="normal"> </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="comment">// The char does not share horizontal space</span>
<span class="normal">			</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="comment">// Char shares horizontal space, update the numChars to draw</span>
<span class="normal">		</span><span class="comment">// Update posBefore to point to the prev char</span>
<span class="normal">		posBefore </span><span class="symbol">=</span><span class="normal"> </span><span class="function">MovePositionOutsideChar</span><span class="symbol">(</span><span class="normal">posBefore </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">		numCharsToDraw </span><span class="symbol">=</span><span class="normal"> posAfter </span><span class="symbol">-</span><span class="normal"> posBefore</span><span class="symbol">;</span>
<span class="normal">		offsetFirstChar </span><span class="symbol">=</span><span class="normal"> offset </span><span class="symbol">-</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">posCaret </span><span class="symbol">-</span><span class="normal"> posBefore</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="comment">// See if the next character shares horizontal space, if so we'll</span>
<span class="normal">	</span><span class="comment">// need to draw that too.</span>
<span class="normal">	numCharsToDraw </span><span class="symbol">=</span><span class="normal"> offsetLastChar </span><span class="symbol">-</span><span class="normal"> offsetFirstChar</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">offsetLastChar </span><span class="symbol">&lt;</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">subLine </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">offsetLastChar </span><span class="symbol">&lt;=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">numCharsInLine</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="comment">// Update posAfter to point to the 2nd next char, this is where</span>
<span class="normal">		</span><span class="comment">// the next character ends, and 2nd next begins. We'll need</span>
<span class="normal">		</span><span class="comment">// to compare these two</span>
<span class="normal">		posBefore </span><span class="symbol">=</span><span class="normal"> posAfter</span><span class="symbol">;</span>
<span class="normal">		posAfter </span><span class="symbol">=</span><span class="normal"> </span><span class="function">MovePositionOutsideChar</span><span class="symbol">(</span><span class="normal">posAfter </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">		offsetLastChar </span><span class="symbol">=</span><span class="normal"> offset </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">posAfter </span><span class="symbol">-</span><span class="normal"> posCaret</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">positions</span><span class="symbol">[</span><span class="normal">offsetLastChar</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">positions</span><span class="symbol">[</span><span class="normal">offsetLastChar </span><span class="symbol">-</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">posAfter </span><span class="symbol">-</span><span class="normal"> posBefore</span><span class="symbol">)])</span><span class="normal"> </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="comment">// The char does not share horizontal space</span>
<span class="normal">			</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="comment">// Char shares horizontal space, update the numChars to draw</span>
<span class="normal">		numCharsToDraw </span><span class="symbol">=</span><span class="normal"> offsetLastChar </span><span class="symbol">-</span><span class="normal"> offsetFirstChar</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="comment">// We now know what to draw, update the caret drawing rectangle</span>
<span class="normal">	rcCaret</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">positions</span><span class="symbol">[</span><span class="normal">offsetFirstChar</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">positions</span><span class="symbol">[</span><span class="normal">lineStart</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> xStart</span><span class="symbol">;</span>
<span class="normal">	rcCaret</span><span class="symbol">.</span><span class="normal">right </span><span class="symbol">=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">positions</span><span class="symbol">[</span><span class="normal">offsetFirstChar</span><span class="symbol">+</span><span class="normal">numCharsToDraw</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">positions</span><span class="symbol">[</span><span class="normal">lineStart</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> xStart</span><span class="symbol">;</span>

<span class="normal">	</span><span class="comment">// Adjust caret position to take into account any word wrapping symbols.</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">wrapIndent </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lineStart </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> wordWrapCharWidth </span><span class="symbol">=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">wrapIndent</span><span class="symbol">;</span>
<span class="normal">		rcCaret</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">+=</span><span class="normal"> wordWrapCharWidth</span><span class="symbol">;</span>
<span class="normal">		rcCaret</span><span class="symbol">.</span><span class="normal">right </span><span class="symbol">+=</span><span class="normal"> wordWrapCharWidth</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="comment">// This character is where the caret block is, we override the colours</span>
<span class="normal">	</span><span class="comment">// (inversed) for drawing the caret here.</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> styleMain </span><span class="symbol">=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">offsetFirstChar</span><span class="symbol">];</span>
<span class="normal">	surface</span><span class="symbol">-&gt;</span><span class="function">DrawTextClipped</span><span class="symbol">(</span><span class="normal">rcCaret</span><span class="symbol">,</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">styleMain</span><span class="symbol">].</span><span class="normal">font</span><span class="symbol">,</span>
<span class="normal">	        rcCaret</span><span class="symbol">.</span><span class="normal">top </span><span class="symbol">+</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">maxAscent</span><span class="symbol">,</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">chars </span><span class="symbol">+</span><span class="normal"> offsetFirstChar</span><span class="symbol">,</span>
<span class="normal">	        numCharsToDraw</span><span class="symbol">,</span><span class="normal"> vsDraw</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">styleMain</span><span class="symbol">].</span><span class="normal">back</span><span class="symbol">.</span><span class="normal">allocated</span><span class="symbol">,</span>
<span class="normal">	        vsDraw</span><span class="symbol">.</span><span class="normal">caretcolour</span><span class="symbol">.</span><span class="normal">allocated</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">RefreshPixMaps</span><span class="symbol">(</span><span class="usertype">Surface</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">surfaceWindow</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">pixmapSelPattern</span><span class="symbol">-&gt;</span><span class="function">Initialised</span><span class="symbol">())</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">const</span><span class="normal"> </span><span class="type">int</span><span class="normal"> patternSize </span><span class="symbol">=</span><span class="normal"> </span><span class="number">8</span><span class="symbol">;</span>
<span class="normal">		pixmapSelPattern</span><span class="symbol">-&gt;</span><span class="function">InitPixMap</span><span class="symbol">(</span><span class="normal">patternSize</span><span class="symbol">,</span><span class="normal"> patternSize</span><span class="symbol">,</span><span class="normal"> surfaceWindow</span><span class="symbol">,</span><span class="normal"> wMain</span><span class="symbol">.</span><span class="function">GetID</span><span class="symbol">());</span>
<span class="normal">		</span><span class="comment">// This complex procedure is to reproduce the checkerboard dithered pattern used by windows</span>
<span class="normal">		</span><span class="comment">// for scroll bars and Visual Studio for its selection margin. The colour of this pattern is half</span>
<span class="normal">		</span><span class="comment">// way between the chrome colour and the chrome highlight colour making a nice transition</span>
<span class="normal">		</span><span class="comment">// between the window chrome and the content area. And it works in low colour depths.</span>
<span class="normal">		</span><span class="usertype">PRectangle</span><span class="normal"> </span><span class="function">rcPattern</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> patternSize</span><span class="symbol">,</span><span class="normal"> patternSize</span><span class="symbol">);</span>

<span class="normal">		</span><span class="comment">// Initialize default colours based on the chrome colour scheme.  Typically the highlight is white.</span>
<span class="normal">		</span><span class="usertype">ColourAllocated</span><span class="normal"> colourFMFill </span><span class="symbol">=</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">selbar</span><span class="symbol">.</span><span class="normal">allocated</span><span class="symbol">;</span>
<span class="normal">		</span><span class="usertype">ColourAllocated</span><span class="normal"> colourFMStripes </span><span class="symbol">=</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">selbarlight</span><span class="symbol">.</span><span class="normal">allocated</span><span class="symbol">;</span>

<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!(</span><span class="normal">vs</span><span class="symbol">.</span><span class="normal">selbarlight</span><span class="symbol">.</span><span class="normal">desired </span><span class="symbol">==</span><span class="normal"> </span><span class="function">ColourDesired</span><span class="symbol">(</span><span class="number">0xff</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">)))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="comment">// User has chosen an unusual chrome colour scheme so just use the highlight edge colour.</span>
<span class="normal">			</span><span class="comment">// (Typically, the highlight colour is white.)</span>
<span class="normal">			colourFMFill </span><span class="symbol">=</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">selbarlight</span><span class="symbol">.</span><span class="normal">allocated</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>

<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vs</span><span class="symbol">.</span><span class="normal">foldmarginColourSet</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="comment">// override default fold margin colour</span>
<span class="normal">			colourFMFill </span><span class="symbol">=</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">foldmarginColour</span><span class="symbol">.</span><span class="normal">allocated</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vs</span><span class="symbol">.</span><span class="normal">foldmarginHighlightColourSet</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="comment">// override default fold margin highlight colour</span>
<span class="normal">			colourFMStripes </span><span class="symbol">=</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">foldmarginHighlightColour</span><span class="symbol">.</span><span class="normal">allocated</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>

<span class="normal">		pixmapSelPattern</span><span class="symbol">-&gt;</span><span class="function">FillRectangle</span><span class="symbol">(</span><span class="normal">rcPattern</span><span class="symbol">,</span><span class="normal"> colourFMFill</span><span class="symbol">);</span>
<span class="normal">		pixmapSelPattern</span><span class="symbol">-&gt;</span><span class="function">PenColour</span><span class="symbol">(</span><span class="normal">colourFMStripes</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="normal"> stripe </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> stripe </span><span class="symbol">&lt;</span><span class="normal"> patternSize</span><span class="symbol">;</span><span class="normal"> stripe</span><span class="symbol">++)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="comment">// Alternating 1 pixel stripes is same as checkerboard.</span>
<span class="normal">			pixmapSelPattern</span><span class="symbol">-&gt;</span><span class="function">MoveTo</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">,</span><span class="normal"> stripe </span><span class="symbol">*</span><span class="normal"> </span><span class="number">2</span><span class="symbol">);</span>
<span class="normal">			pixmapSelPattern</span><span class="symbol">-&gt;</span><span class="function">LineTo</span><span class="symbol">(</span><span class="normal">patternSize</span><span class="symbol">,</span><span class="normal"> stripe </span><span class="symbol">*</span><span class="normal"> </span><span class="number">2</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> patternSize</span><span class="symbol">);</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">pixmapIndentGuide</span><span class="symbol">-&gt;</span><span class="function">Initialised</span><span class="symbol">())</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="comment">// 1 extra pixel in height so can handle odd/even positions and so produce a continuous line</span>
<span class="normal">		pixmapIndentGuide</span><span class="symbol">-&gt;</span><span class="function">InitPixMap</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">lineHeight </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span><span class="normal"> surfaceWindow</span><span class="symbol">,</span><span class="normal"> wMain</span><span class="symbol">.</span><span class="function">GetID</span><span class="symbol">());</span>
<span class="normal">		pixmapIndentGuideHighlight</span><span class="symbol">-&gt;</span><span class="function">InitPixMap</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">lineHeight </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span><span class="normal"> surfaceWindow</span><span class="symbol">,</span><span class="normal"> wMain</span><span class="symbol">.</span><span class="function">GetID</span><span class="symbol">());</span>
<span class="normal">		</span><span class="usertype">PRectangle</span><span class="normal"> </span><span class="function">rcIG</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">lineHeight</span><span class="symbol">);</span>
<span class="normal">		pixmapIndentGuide</span><span class="symbol">-&gt;</span><span class="function">FillRectangle</span><span class="symbol">(</span><span class="normal">rcIG</span><span class="symbol">,</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">STYLE_INDENTGUIDE</span><span class="symbol">].</span><span class="normal">back</span><span class="symbol">.</span><span class="normal">allocated</span><span class="symbol">);</span>
<span class="normal">		pixmapIndentGuide</span><span class="symbol">-&gt;</span><span class="function">PenColour</span><span class="symbol">(</span><span class="normal">vs</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">STYLE_INDENTGUIDE</span><span class="symbol">].</span><span class="normal">fore</span><span class="symbol">.</span><span class="normal">allocated</span><span class="symbol">);</span>
<span class="normal">		pixmapIndentGuideHighlight</span><span class="symbol">-&gt;</span><span class="function">FillRectangle</span><span class="symbol">(</span><span class="normal">rcIG</span><span class="symbol">,</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">STYLE_BRACELIGHT</span><span class="symbol">].</span><span class="normal">back</span><span class="symbol">.</span><span class="normal">allocated</span><span class="symbol">);</span>
<span class="normal">		pixmapIndentGuideHighlight</span><span class="symbol">-&gt;</span><span class="function">PenColour</span><span class="symbol">(</span><span class="normal">vs</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">STYLE_BRACELIGHT</span><span class="symbol">].</span><span class="normal">fore</span><span class="symbol">.</span><span class="normal">allocated</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="normal"> stripe </span><span class="symbol">=</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span><span class="normal"> stripe </span><span class="symbol">&lt;</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">lineHeight </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span><span class="normal"> stripe </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			pixmapIndentGuide</span><span class="symbol">-&gt;</span><span class="function">MoveTo</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">,</span><span class="normal"> stripe</span><span class="symbol">);</span>
<span class="normal">			pixmapIndentGuide</span><span class="symbol">-&gt;</span><span class="function">LineTo</span><span class="symbol">(</span><span class="number">2</span><span class="symbol">,</span><span class="normal"> stripe</span><span class="symbol">);</span>
<span class="normal">			pixmapIndentGuideHighlight</span><span class="symbol">-&gt;</span><span class="function">MoveTo</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">,</span><span class="normal"> stripe</span><span class="symbol">);</span>
<span class="normal">			pixmapIndentGuideHighlight</span><span class="symbol">-&gt;</span><span class="function">LineTo</span><span class="symbol">(</span><span class="number">2</span><span class="symbol">,</span><span class="normal"> stripe</span><span class="symbol">);</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">bufferedDraw</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">pixmapLine</span><span class="symbol">-&gt;</span><span class="function">Initialised</span><span class="symbol">())</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="usertype">PRectangle</span><span class="normal"> rcClient </span><span class="symbol">=</span><span class="normal"> </span><span class="function">GetClientRectangle</span><span class="symbol">();</span>
<span class="normal">			pixmapLine</span><span class="symbol">-&gt;</span><span class="function">InitPixMap</span><span class="symbol">(</span><span class="normal">rcClient</span><span class="symbol">.</span><span class="function">Width</span><span class="symbol">(),</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">lineHeight</span><span class="symbol">,</span>
<span class="normal">			        surfaceWindow</span><span class="symbol">,</span><span class="normal"> wMain</span><span class="symbol">.</span><span class="function">GetID</span><span class="symbol">());</span>
<span class="normal">			pixmapSelMargin</span><span class="symbol">-&gt;</span><span class="function">InitPixMap</span><span class="symbol">(</span><span class="normal">vs</span><span class="symbol">.</span><span class="normal">fixedColumnWidth</span><span class="symbol">,</span>
<span class="normal">			        rcClient</span><span class="symbol">.</span><span class="function">Height</span><span class="symbol">(),</span><span class="normal"> surfaceWindow</span><span class="symbol">,</span><span class="normal"> wMain</span><span class="symbol">.</span><span class="function">GetID</span><span class="symbol">());</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">Paint</span><span class="symbol">(</span><span class="usertype">Surface</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">surfaceWindow</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">PRectangle</span><span class="normal"> rcArea</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="comment">//Platform::DebugPrintf("Paint:%1d (%3d,%3d) ... (%3d,%3d)\n",</span>
<span class="normal">	</span><span class="comment">//	paintingAllText, rcArea.left, rcArea.top, rcArea.right, rcArea.bottom);</span>

<span class="normal">	pixmapLine</span><span class="symbol">-&gt;</span><span class="function">Release</span><span class="symbol">();</span>
<span class="normal">	</span><span class="function">RefreshStyleData</span><span class="symbol">();</span>
<span class="normal">	</span><span class="function">RefreshPixMaps</span><span class="symbol">(</span><span class="normal">surfaceWindow</span><span class="symbol">);</span>

<span class="normal">	</span><span class="usertype">PRectangle</span><span class="normal"> rcClient </span><span class="symbol">=</span><span class="normal"> </span><span class="function">GetClientRectangle</span><span class="symbol">();</span>
<span class="normal">	</span><span class="comment">//Platform::DebugPrintf("Client: (%3d,%3d) ... (%3d,%3d)   %d\n",</span>
<span class="normal">	</span><span class="comment">//	rcClient.left, rcClient.top, rcClient.right, rcClient.bottom);</span>

<span class="normal">	surfaceWindow</span><span class="symbol">-&gt;</span><span class="function">SetPalette</span><span class="symbol">(&amp;</span><span class="normal">palette</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">);</span>
<span class="normal">	pixmapLine</span><span class="symbol">-&gt;</span><span class="function">SetPalette</span><span class="symbol">(&amp;</span><span class="normal">palette</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">!</span><span class="normal">hasFocus</span><span class="symbol">);</span>

<span class="normal">	</span><span class="type">int</span><span class="normal"> screenLinePaintFirst </span><span class="symbol">=</span><span class="normal"> rcArea</span><span class="symbol">.</span><span class="normal">top </span><span class="symbol">/</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">lineHeight</span><span class="symbol">;</span>
<span class="normal">	</span><span class="comment">// The area to be painted plus one extra line is styled.</span>
<span class="normal">	</span><span class="comment">// The extra line is to determine when a style change, such as starting a comment flows on to other lines.</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> lineStyleLast </span><span class="symbol">=</span><span class="normal"> topLine </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">rcArea</span><span class="symbol">.</span><span class="normal">bottom </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">/</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">lineHeight </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">	</span><span class="comment">//Platform::DebugPrintf("Paint lines = %d .. %d\n", topLine + screenLinePaintFirst, lineStyleLast);</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> endPosPaint </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">Length</span><span class="symbol">();</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lineStyleLast </span><span class="symbol">&lt;</span><span class="normal"> cs</span><span class="symbol">.</span><span class="function">LinesDisplayed</span><span class="symbol">())</span>
<span class="normal">		endPosPaint </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">cs</span><span class="symbol">.</span><span class="function">DocFromDisplay</span><span class="symbol">(</span><span class="normal">lineStyleLast</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>

<span class="normal">	</span><span class="type">int</span><span class="normal"> xStart </span><span class="symbol">=</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">fixedColumnWidth </span><span class="symbol">-</span><span class="normal"> xOffset</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> ypos </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">bufferedDraw</span><span class="symbol">)</span>
<span class="normal">		ypos </span><span class="symbol">+=</span><span class="normal"> screenLinePaintFirst </span><span class="symbol">*</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">lineHeight</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> yposScreen </span><span class="symbol">=</span><span class="normal"> screenLinePaintFirst </span><span class="symbol">*</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">lineHeight</span><span class="symbol">;</span>

<span class="normal">	</span><span class="comment">// Ensure we are styled as far as we are painting.</span>
<span class="normal">	pdoc</span><span class="symbol">-&gt;</span><span class="function">EnsureStyledTo</span><span class="symbol">(</span><span class="normal">endPosPaint</span><span class="symbol">);</span>
<span class="normal">	</span><span class="type">bool</span><span class="normal"> paintAbandonedByStyling </span><span class="symbol">=</span><span class="normal"> paintState </span><span class="symbol">==</span><span class="normal"> paintAbandoned</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">needUpdateUI</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="comment">// Deselect palette by selecting a temporary palette</span>
<span class="normal">		</span><span class="usertype">Palette</span><span class="normal"> palTemp</span><span class="symbol">;</span>
<span class="normal">		surfaceWindow</span><span class="symbol">-&gt;</span><span class="function">SetPalette</span><span class="symbol">(&amp;</span><span class="normal">palTemp</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">);</span>

<span class="normal">		</span><span class="function">NotifyUpdateUI</span><span class="symbol">();</span>
<span class="normal">		needUpdateUI </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>

<span class="normal">		</span><span class="function">RefreshStyleData</span><span class="symbol">();</span>
<span class="normal">		</span><span class="function">RefreshPixMaps</span><span class="symbol">(</span><span class="normal">surfaceWindow</span><span class="symbol">);</span>
<span class="normal">		surfaceWindow</span><span class="symbol">-&gt;</span><span class="function">SetPalette</span><span class="symbol">(&amp;</span><span class="normal">palette</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">);</span>
<span class="normal">		pixmapLine</span><span class="symbol">-&gt;</span><span class="function">SetPalette</span><span class="symbol">(&amp;</span><span class="normal">palette</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">!</span><span class="normal">hasFocus</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="comment">// Call priority lines wrap on a window of lines which are likely</span>
<span class="normal">	</span><span class="comment">// to rendered with the following paint (that is wrap the visible</span>
<span class="normal">	</span><span class="comment">// 	lines first).</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> startLineToWrap </span><span class="symbol">=</span><span class="normal"> cs</span><span class="symbol">.</span><span class="function">DocFromDisplay</span><span class="symbol">(</span><span class="normal">topLine</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="number">5</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">startLineToWrap </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">		startLineToWrap </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">WrapLines</span><span class="symbol">(</span><span class="keyword">false</span><span class="symbol">,</span><span class="normal"> startLineToWrap</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="comment">// The wrapping process has changed the height of some lines so</span>
<span class="normal">		</span><span class="comment">// abandon this paint for a complete repaint.</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">AbandonPaint</span><span class="symbol">())</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">return</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="function">RefreshPixMaps</span><span class="symbol">(</span><span class="normal">surfaceWindow</span><span class="symbol">);</span><span class="normal">	</span><span class="comment">// In case pixmaps invalidated by scrollbar change</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="function">PLATFORM_ASSERT</span><span class="symbol">(</span><span class="normal">pixmapSelPattern</span><span class="symbol">-&gt;</span><span class="function">Initialised</span><span class="symbol">());</span>

<span class="normal">	</span><span class="function">PaintSelMargin</span><span class="symbol">(</span><span class="normal">surfaceWindow</span><span class="symbol">,</span><span class="normal"> rcArea</span><span class="symbol">);</span>

<span class="normal">	</span><span class="usertype">PRectangle</span><span class="normal"> rcRightMargin </span><span class="symbol">=</span><span class="normal"> rcClient</span><span class="symbol">;</span>
<span class="normal">	rcRightMargin</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">=</span><span class="normal"> rcRightMargin</span><span class="symbol">.</span><span class="normal">right </span><span class="symbol">-</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">rightMarginWidth</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">rcArea</span><span class="symbol">.</span><span class="function">Intersects</span><span class="symbol">(</span><span class="normal">rcRightMargin</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		surfaceWindow</span><span class="symbol">-&gt;</span><span class="function">FillRectangle</span><span class="symbol">(</span><span class="normal">rcRightMargin</span><span class="symbol">,</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">STYLE_DEFAULT</span><span class="symbol">].</span><span class="normal">back</span><span class="symbol">.</span><span class="normal">allocated</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">paintState </span><span class="symbol">==</span><span class="normal"> paintAbandoned</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="comment">// Either styling or NotifyUpdateUI noticed that painting is needed</span>
<span class="normal">		</span><span class="comment">// outside the current painting rectangle</span>
<span class="normal">		</span><span class="comment">//Platform::DebugPrintf("Abandoning paint\n");</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">wrapState </span><span class="symbol">!=</span><span class="normal"> eWrapNone</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">paintAbandonedByStyling</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="comment">// Styling has spilled over a line end, such as occurs by starting a multiline</span>
<span class="normal">				</span><span class="comment">// comment. The width of subsequent text may have changed, so rewrap.</span>
<span class="normal">				</span><span class="function">NeedWrapping</span><span class="symbol">(</span><span class="normal">cs</span><span class="symbol">.</span><span class="function">DocFromDisplay</span><span class="symbol">(</span><span class="normal">topLine</span><span class="symbol">));</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">return</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="comment">//Platform::DebugPrintf("start display %d, offset = %d\n", pdoc-&gt;Length(), xOffset);</span>

<span class="normal">	</span><span class="comment">// Do the painting</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">rcArea</span><span class="symbol">.</span><span class="normal">right </span><span class="symbol">&gt;</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">fixedColumnWidth</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>

<span class="normal">		</span><span class="usertype">Surface</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">surface </span><span class="symbol">=</span><span class="normal"> surfaceWindow</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">bufferedDraw</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			surface </span><span class="symbol">=</span><span class="normal"> pixmapLine</span><span class="symbol">;</span>
<span class="normal">			</span><span class="function">PLATFORM_ASSERT</span><span class="symbol">(</span><span class="normal">pixmapLine</span><span class="symbol">-&gt;</span><span class="function">Initialised</span><span class="symbol">());</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		surface</span><span class="symbol">-&gt;</span><span class="function">SetUnicodeMode</span><span class="symbol">(</span><span class="function">IsUnicodeMode</span><span class="symbol">());</span>
<span class="normal">		surface</span><span class="symbol">-&gt;</span><span class="function">SetDBCSMode</span><span class="symbol">(</span><span class="function">CodePage</span><span class="symbol">());</span>

<span class="normal">		</span><span class="type">int</span><span class="normal"> visibleLine </span><span class="symbol">=</span><span class="normal"> topLine </span><span class="symbol">+</span><span class="normal"> screenLinePaintFirst</span><span class="symbol">;</span>

<span class="normal">		</span><span class="type">int</span><span class="normal"> posCaret </span><span class="symbol">=</span><span class="normal"> currentPos</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">posDrag </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">			posCaret </span><span class="symbol">=</span><span class="normal"> posDrag</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> lineCaret </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineFromPosition</span><span class="symbol">(</span><span class="normal">posCaret</span><span class="symbol">);</span>

<span class="normal">		</span><span class="comment">// Remove selection margin from drawing area so text will not be drawn</span>
<span class="normal">		</span><span class="comment">// on it in unbuffered mode.</span>
<span class="normal">		</span><span class="usertype">PRectangle</span><span class="normal"> rcTextArea </span><span class="symbol">=</span><span class="normal"> rcClient</span><span class="symbol">;</span>
<span class="normal">		rcTextArea</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">=</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">fixedColumnWidth</span><span class="symbol">;</span>
<span class="normal">		rcTextArea</span><span class="symbol">.</span><span class="normal">right </span><span class="symbol">-=</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">rightMarginWidth</span><span class="symbol">;</span>
<span class="normal">		surfaceWindow</span><span class="symbol">-&gt;</span><span class="function">SetClip</span><span class="symbol">(</span><span class="normal">rcTextArea</span><span class="symbol">);</span>

<span class="normal">		</span><span class="comment">// Loop on visible lines</span>
<span class="normal">		</span><span class="comment">//double durLayout = 0.0;</span>
<span class="normal">		</span><span class="comment">//double durPaint = 0.0;</span>
<span class="normal">		</span><span class="comment">//double durCopy = 0.0;</span>
<span class="normal">		</span><span class="comment">//ElapsedTime etWhole;</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> lineDocPrevious </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">;</span><span class="normal">	</span><span class="comment">// Used to avoid laying out one document line multiple times</span>
<span class="normal">		</span><span class="usertype">AutoLineLayout</span><span class="normal"> </span><span class="function">ll</span><span class="symbol">(</span><span class="normal">llc</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">);</span>
<span class="normal">		</span><span class="usertype">SelectionLineIterator</span><span class="normal"> </span><span class="function">lineIterator</span><span class="symbol">(</span><span class="keyword">this</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">visibleLine </span><span class="symbol">&lt;</span><span class="normal"> cs</span><span class="symbol">.</span><span class="function">LinesDisplayed</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> yposScreen </span><span class="symbol">&lt;</span><span class="normal"> rcArea</span><span class="symbol">.</span><span class="normal">bottom</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>

<span class="normal">			</span><span class="type">int</span><span class="normal"> lineDoc </span><span class="symbol">=</span><span class="normal"> cs</span><span class="symbol">.</span><span class="function">DocFromDisplay</span><span class="symbol">(</span><span class="normal">visibleLine</span><span class="symbol">);</span>
<span class="normal">			</span><span class="comment">// Only visible lines should be handled by the code within the loop</span>
<span class="normal">			</span><span class="function">PLATFORM_ASSERT</span><span class="symbol">(</span><span class="normal">cs</span><span class="symbol">.</span><span class="function">GetVisible</span><span class="symbol">(</span><span class="normal">lineDoc</span><span class="symbol">));</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> lineStartSet </span><span class="symbol">=</span><span class="normal"> cs</span><span class="symbol">.</span><span class="function">DisplayFromDoc</span><span class="symbol">(</span><span class="normal">lineDoc</span><span class="symbol">);</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> subLine </span><span class="symbol">=</span><span class="normal"> visibleLine </span><span class="symbol">-</span><span class="normal"> lineStartSet</span><span class="symbol">;</span>

<span class="normal">			</span><span class="comment">// Copy this line and its styles from the document into local arrays</span>
<span class="normal">			</span><span class="comment">// and determine the x position at which each character starts.</span>
<span class="normal">			</span><span class="comment">//ElapsedTime et;</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lineDoc </span><span class="symbol">!=</span><span class="normal"> lineDocPrevious</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				ll</span><span class="symbol">.</span><span class="function">Set</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">);</span>
<span class="normal">				</span><span class="comment">// For rectangular selection this accesses the layout cache so should be after layout returned.</span>
<span class="normal">				lineIterator</span><span class="symbol">.</span><span class="function">SetAt</span><span class="symbol">(</span><span class="normal">lineDoc</span><span class="symbol">);</span>
<span class="normal">				ll</span><span class="symbol">.</span><span class="function">Set</span><span class="symbol">(</span><span class="function">RetrieveLineLayout</span><span class="symbol">(</span><span class="normal">lineDoc</span><span class="symbol">));</span>
<span class="normal">				</span><span class="function">LayoutLine</span><span class="symbol">(</span><span class="normal">lineDoc</span><span class="symbol">,</span><span class="normal"> surface</span><span class="symbol">,</span><span class="normal"> vs</span><span class="symbol">,</span><span class="normal"> ll</span><span class="symbol">,</span><span class="normal"> wrapWidth</span><span class="symbol">);</span>
<span class="normal">				lineDocPrevious </span><span class="symbol">=</span><span class="normal"> lineDoc</span><span class="symbol">;</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">			</span><span class="comment">//durLayout += et.Duration(true);</span>

<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">selType </span><span class="symbol">==</span><span class="normal"> selStream</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					ll</span><span class="symbol">-&gt;</span><span class="normal">selStart </span><span class="symbol">=</span><span class="normal"> </span><span class="function">SelectionStart</span><span class="symbol">();</span>
<span class="normal">					ll</span><span class="symbol">-&gt;</span><span class="normal">selEnd </span><span class="symbol">=</span><span class="normal"> </span><span class="function">SelectionEnd</span><span class="symbol">();</span>
<span class="normal">				</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					ll</span><span class="symbol">-&gt;</span><span class="normal">selStart </span><span class="symbol">=</span><span class="normal"> lineIterator</span><span class="symbol">.</span><span class="normal">startPos</span><span class="symbol">;</span>
<span class="normal">					ll</span><span class="symbol">-&gt;</span><span class="normal">selEnd </span><span class="symbol">=</span><span class="normal"> lineIterator</span><span class="symbol">.</span><span class="normal">endPos</span><span class="symbol">;</span>
<span class="normal">				</span><span class="cbracket">}</span>
<span class="normal">				ll</span><span class="symbol">-&gt;</span><span class="normal">containsCaret </span><span class="symbol">=</span><span class="normal"> lineDoc </span><span class="symbol">==</span><span class="normal"> lineCaret</span><span class="symbol">;</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">hideSelection</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					ll</span><span class="symbol">-&gt;</span><span class="normal">selStart </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">					ll</span><span class="symbol">-&gt;</span><span class="normal">selEnd </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">					ll</span><span class="symbol">-&gt;</span><span class="normal">containsCaret </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="normal">				</span><span class="cbracket">}</span>

<span class="normal">				</span><span class="function">GetHotSpotRange</span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">hsStart</span><span class="symbol">,</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">hsEnd</span><span class="symbol">);</span>

<span class="normal">				</span><span class="usertype">PRectangle</span><span class="normal"> rcLine </span><span class="symbol">=</span><span class="normal"> rcClient</span><span class="symbol">;</span>
<span class="normal">				rcLine</span><span class="symbol">.</span><span class="normal">top </span><span class="symbol">=</span><span class="normal"> ypos</span><span class="symbol">;</span>
<span class="normal">				rcLine</span><span class="symbol">.</span><span class="normal">bottom </span><span class="symbol">=</span><span class="normal"> ypos </span><span class="symbol">+</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">lineHeight</span><span class="symbol">;</span>

<span class="normal">				</span><span class="usertype">Range</span><span class="normal"> </span><span class="function">rangeLine</span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">lineDoc</span><span class="symbol">),</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">lineDoc </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">));</span>
<span class="normal">				</span><span class="comment">// Highlight the current braces if any</span>
<span class="normal">				ll</span><span class="symbol">-&gt;</span><span class="function">SetBracesHighlight</span><span class="symbol">(</span><span class="normal">rangeLine</span><span class="symbol">,</span><span class="normal"> braces</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">static_cast</span><span class="symbol">&lt;</span><span class="type">char</span><span class="symbol">&gt;(</span><span class="normal">bracesMatchStyle</span><span class="symbol">),</span>
<span class="normal">				        highlightGuideColumn </span><span class="symbol">*</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">spaceWidth</span><span class="symbol">);</span>

<span class="normal">				</span><span class="comment">// Draw the line</span>
<span class="normal">				</span><span class="function">DrawLine</span><span class="symbol">(</span><span class="normal">surface</span><span class="symbol">,</span><span class="normal"> vs</span><span class="symbol">,</span><span class="normal"> lineDoc</span><span class="symbol">,</span><span class="normal"> visibleLine</span><span class="symbol">,</span><span class="normal"> xStart</span><span class="symbol">,</span><span class="normal"> rcLine</span><span class="symbol">,</span><span class="normal"> ll</span><span class="symbol">,</span><span class="normal"> subLine</span><span class="symbol">);</span>
<span class="normal">				</span><span class="comment">//durPaint += et.Duration(true);</span>

<span class="normal">				</span><span class="comment">// Restore the previous styles for the brace highlights in case layout is in cache.</span>
<span class="normal">				ll</span><span class="symbol">-&gt;</span><span class="function">RestoreBracesHighlight</span><span class="symbol">(</span><span class="normal">rangeLine</span><span class="symbol">,</span><span class="normal"> braces</span><span class="symbol">);</span>

<span class="normal">				</span><span class="type">bool</span><span class="normal"> expanded </span><span class="symbol">=</span><span class="normal"> cs</span><span class="symbol">.</span><span class="function">GetExpanded</span><span class="symbol">(</span><span class="normal">lineDoc</span><span class="symbol">);</span>
<span class="normal">				</span><span class="comment">// Paint the line above the fold</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">expanded </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">foldFlags </span><span class="symbol">&amp;</span><span class="normal"> SC_FOLDFLAG_LINEBEFORE_EXPANDED</span><span class="symbol">))</span>
<span class="normal">					</span><span class="symbol">||</span>
<span class="normal">					</span><span class="symbol">(!</span><span class="normal">expanded </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">foldFlags </span><span class="symbol">&amp;</span><span class="normal"> SC_FOLDFLAG_LINEBEFORE_CONTRACTED</span><span class="symbol">)))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">GetLevel</span><span class="symbol">(</span><span class="normal">lineDoc</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> SC_FOLDLEVELHEADERFLAG</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">						</span><span class="usertype">PRectangle</span><span class="normal"> rcFoldLine </span><span class="symbol">=</span><span class="normal"> rcLine</span><span class="symbol">;</span>
<span class="normal">						rcFoldLine</span><span class="symbol">.</span><span class="normal">bottom </span><span class="symbol">=</span><span class="normal"> rcFoldLine</span><span class="symbol">.</span><span class="normal">top </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">						surface</span><span class="symbol">-&gt;</span><span class="function">FillRectangle</span><span class="symbol">(</span><span class="normal">rcFoldLine</span><span class="symbol">,</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">STYLE_DEFAULT</span><span class="symbol">].</span><span class="normal">fore</span><span class="symbol">.</span><span class="normal">allocated</span><span class="symbol">);</span>
<span class="normal">					</span><span class="cbracket">}</span>
<span class="normal">				</span><span class="cbracket">}</span>
<span class="normal">				</span><span class="comment">// Paint the line below the fold</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">expanded </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">foldFlags </span><span class="symbol">&amp;</span><span class="normal"> SC_FOLDFLAG_LINEAFTER_EXPANDED</span><span class="symbol">))</span>
<span class="normal">					</span><span class="symbol">||</span>
<span class="normal">					</span><span class="symbol">(!</span><span class="normal">expanded </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">foldFlags </span><span class="symbol">&amp;</span><span class="normal"> SC_FOLDFLAG_LINEAFTER_CONTRACTED</span><span class="symbol">)))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">GetLevel</span><span class="symbol">(</span><span class="normal">lineDoc</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> SC_FOLDLEVELHEADERFLAG</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">						</span><span class="usertype">PRectangle</span><span class="normal"> rcFoldLine </span><span class="symbol">=</span><span class="normal"> rcLine</span><span class="symbol">;</span>
<span class="normal">						rcFoldLine</span><span class="symbol">.</span><span class="normal">top </span><span class="symbol">=</span><span class="normal"> rcFoldLine</span><span class="symbol">.</span><span class="normal">bottom </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">						surface</span><span class="symbol">-&gt;</span><span class="function">FillRectangle</span><span class="symbol">(</span><span class="normal">rcFoldLine</span><span class="symbol">,</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">STYLE_DEFAULT</span><span class="symbol">].</span><span class="normal">fore</span><span class="symbol">.</span><span class="normal">allocated</span><span class="symbol">);</span>
<span class="normal">					</span><span class="cbracket">}</span>
<span class="normal">				</span><span class="cbracket">}</span>

<span class="normal">				</span><span class="comment">// Draw the Caret</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lineDoc </span><span class="symbol">==</span><span class="normal"> lineCaret</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="type">int</span><span class="normal"> offset </span><span class="symbol">=</span><span class="normal"> Platform</span><span class="symbol">::</span><span class="function">Minimum</span><span class="symbol">(</span><span class="normal">posCaret </span><span class="symbol">-</span><span class="normal"> rangeLine</span><span class="symbol">.</span><span class="normal">start</span><span class="symbol">,</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">maxLineLength</span><span class="symbol">);</span>
<span class="normal">					</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="function">InLine</span><span class="symbol">(</span><span class="normal">offset</span><span class="symbol">,</span><span class="normal"> subLine</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">						</span><span class="type">int</span><span class="normal"> xposCaret </span><span class="symbol">=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">positions</span><span class="symbol">[</span><span class="normal">offset</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">positions</span><span class="symbol">[</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">subLine</span><span class="symbol">)]</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> xStart</span><span class="symbol">;</span>

<span class="normal">						</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">wrapIndent </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">							</span><span class="type">int</span><span class="normal"> lineStart </span><span class="symbol">=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">subLine</span><span class="symbol">);</span>
<span class="normal">							</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lineStart </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal">	</span><span class="comment">// Wrapped</span>
<span class="normal">								xposCaret </span><span class="symbol">+=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">wrapIndent</span><span class="symbol">;</span>
<span class="normal">						</span><span class="cbracket">}</span>
<span class="normal">						</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">xposCaret </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vs</span><span class="symbol">.</span><span class="normal">caretWidth </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vs</span><span class="symbol">.</span><span class="normal">caretStyle </span><span class="symbol">!=</span><span class="normal"> CARETSTYLE_INVISIBLE</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span>
<span class="normal">						        </span><span class="symbol">((</span><span class="normal">posDrag </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">caret</span><span class="symbol">.</span><span class="normal">active </span><span class="symbol">&amp;&amp;</span><span class="normal"> caret</span><span class="symbol">.</span><span class="normal">on</span><span class="symbol">)))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">							</span><span class="type">bool</span><span class="normal"> caretAtEOF </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="normal">							</span><span class="type">bool</span><span class="normal"> caretAtEOL </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="normal">							</span><span class="type">bool</span><span class="normal"> drawBlockCaret </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="normal">							</span><span class="type">int</span><span class="normal"> widthOverstrikeCaret</span><span class="symbol">;</span>
<span class="normal">							</span><span class="type">int</span><span class="normal"> caretWidthOffset </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">							</span><span class="usertype">PRectangle</span><span class="normal"> rcCaret </span><span class="symbol">=</span><span class="normal"> rcLine</span><span class="symbol">;</span>

<span class="normal">							</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">posCaret </span><span class="symbol">==</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">Length</span><span class="symbol">())</span><span class="normal">	</span><span class="cbracket">{</span><span class="normal">   </span><span class="comment">// At end of document</span>
<span class="normal">								caretAtEOF </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>
<span class="normal">								widthOverstrikeCaret </span><span class="symbol">=</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">aveCharWidth</span><span class="symbol">;</span>
<span class="normal">							</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">posCaret </span><span class="symbol">-</span><span class="normal"> rangeLine</span><span class="symbol">.</span><span class="normal">start</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">numCharsInLine</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal">	</span><span class="comment">// At end of line</span>
<span class="normal">								caretAtEOL </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>
<span class="normal">								widthOverstrikeCaret </span><span class="symbol">=</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">aveCharWidth</span><span class="symbol">;</span>
<span class="normal">							</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">								widthOverstrikeCaret </span><span class="symbol">=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">positions</span><span class="symbol">[</span><span class="normal">offset </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">positions</span><span class="symbol">[</span><span class="normal">offset</span><span class="symbol">];</span>
<span class="normal">							</span><span class="cbracket">}</span>
<span class="normal">							</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">widthOverstrikeCaret </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">3</span><span class="symbol">)</span><span class="normal">	</span><span class="comment">// Make sure its visible</span>
<span class="normal">								widthOverstrikeCaret </span><span class="symbol">=</span><span class="normal"> </span><span class="number">3</span><span class="symbol">;</span>

<span class="normal">							</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">offset </span><span class="symbol">&gt;</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">subLine</span><span class="symbol">))</span>
<span class="normal">								caretWidthOffset </span><span class="symbol">=</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span><span class="normal">	</span><span class="comment">// Move back so overlaps both character cells.</span>
<span class="normal">							</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">posDrag </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">								</span><span class="comment">/* Dragging text, use a line caret */</span>
<span class="normal">								rcCaret</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">=</span><span class="normal"> xposCaret </span><span class="symbol">-</span><span class="normal"> caretWidthOffset</span><span class="symbol">;</span>
<span class="normal">								rcCaret</span><span class="symbol">.</span><span class="normal">right </span><span class="symbol">=</span><span class="normal"> rcCaret</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">+</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">caretWidth</span><span class="symbol">;</span>
<span class="normal">							</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">inOverstrike</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">								</span><span class="comment">/* Overstrike (insert mode), use a modified bar caret */</span>
<span class="normal">								rcCaret</span><span class="symbol">.</span><span class="normal">top </span><span class="symbol">=</span><span class="normal"> rcCaret</span><span class="symbol">.</span><span class="normal">bottom </span><span class="symbol">-</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">								rcCaret</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">=</span><span class="normal"> xposCaret </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">								rcCaret</span><span class="symbol">.</span><span class="normal">right </span><span class="symbol">=</span><span class="normal"> rcCaret</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">+</span><span class="normal"> widthOverstrikeCaret </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">							</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vs</span><span class="symbol">.</span><span class="normal">caretStyle </span><span class="symbol">==</span><span class="normal"> CARETSTYLE_BLOCK</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">								</span><span class="comment">/* Block caret */</span>
<span class="normal">								rcCaret</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">=</span><span class="normal"> xposCaret</span><span class="symbol">;</span>
<span class="normal">								</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">caretAtEOL </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">!</span><span class="normal">caretAtEOF </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">chars</span><span class="symbol">[</span><span class="normal">offset</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="string">'</span><span class="specialchar">\t</span><span class="string">'</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">!(</span><span class="function">IsControlCharacter</span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">chars</span><span class="symbol">[</span><span class="normal">offset</span><span class="symbol">])))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">									drawBlockCaret </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>
<span class="normal">									rcCaret</span><span class="symbol">.</span><span class="normal">right </span><span class="symbol">=</span><span class="normal"> xposCaret </span><span class="symbol">+</span><span class="normal"> widthOverstrikeCaret</span><span class="symbol">;</span>
<span class="normal">								</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">									rcCaret</span><span class="symbol">.</span><span class="normal">right </span><span class="symbol">=</span><span class="normal"> xposCaret </span><span class="symbol">+</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">aveCharWidth</span><span class="symbol">;</span>
<span class="normal">								</span><span class="cbracket">}</span>
<span class="normal">							</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">								</span><span class="comment">/* Line caret */</span>
<span class="normal">								rcCaret</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">=</span><span class="normal"> xposCaret </span><span class="symbol">-</span><span class="normal"> caretWidthOffset</span><span class="symbol">;</span>
<span class="normal">								rcCaret</span><span class="symbol">.</span><span class="normal">right </span><span class="symbol">=</span><span class="normal"> rcCaret</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">+</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">caretWidth</span><span class="symbol">;</span>
<span class="normal">							</span><span class="cbracket">}</span>
<span class="normal">							</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">drawBlockCaret</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">								</span><span class="function">DrawBlockCaret</span><span class="symbol">(</span><span class="normal">surface</span><span class="symbol">,</span><span class="normal"> vs</span><span class="symbol">,</span><span class="normal"> ll</span><span class="symbol">,</span><span class="normal"> subLine</span><span class="symbol">,</span><span class="normal"> xStart</span><span class="symbol">,</span><span class="normal"> offset</span><span class="symbol">,</span><span class="normal"> posCaret</span><span class="symbol">,</span><span class="normal"> rcCaret</span><span class="symbol">);</span>
<span class="normal">							</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">								surface</span><span class="symbol">-&gt;</span><span class="function">FillRectangle</span><span class="symbol">(</span><span class="normal">rcCaret</span><span class="symbol">,</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">caretcolour</span><span class="symbol">.</span><span class="normal">allocated</span><span class="symbol">);</span>
<span class="normal">							</span><span class="cbracket">}</span>
<span class="normal">						</span><span class="cbracket">}</span>
<span class="normal">					</span><span class="cbracket">}</span>
<span class="normal">				</span><span class="cbracket">}</span>

<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">bufferedDraw</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="usertype">Point</span><span class="normal"> </span><span class="function">from</span><span class="symbol">(</span><span class="normal">vs</span><span class="symbol">.</span><span class="normal">fixedColumnWidth</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">);</span>
<span class="normal">					</span><span class="usertype">PRectangle</span><span class="normal"> </span><span class="function">rcCopyArea</span><span class="symbol">(</span><span class="normal">vs</span><span class="symbol">.</span><span class="normal">fixedColumnWidth</span><span class="symbol">,</span><span class="normal"> yposScreen</span><span class="symbol">,</span>
<span class="normal">					        rcClient</span><span class="symbol">.</span><span class="normal">right</span><span class="symbol">,</span><span class="normal"> yposScreen </span><span class="symbol">+</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">lineHeight</span><span class="symbol">);</span>
<span class="normal">					surfaceWindow</span><span class="symbol">-&gt;</span><span class="function">Copy</span><span class="symbol">(</span><span class="normal">rcCopyArea</span><span class="symbol">,</span><span class="normal"> from</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">pixmapLine</span><span class="symbol">);</span>
<span class="normal">				</span><span class="cbracket">}</span>
<span class="normal">				</span><span class="comment">//durCopy += et.Duration(true);</span>
<span class="normal">			</span><span class="cbracket">}</span>

<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">bufferedDraw</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				ypos </span><span class="symbol">+=</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">lineHeight</span><span class="symbol">;</span>
<span class="normal">			</span><span class="cbracket">}</span>

<span class="normal">			yposScreen </span><span class="symbol">+=</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">lineHeight</span><span class="symbol">;</span>
<span class="normal">			visibleLine</span><span class="symbol">++;</span>

<span class="normal">			lineWidthMaxSeen </span><span class="symbol">=</span><span class="normal"> Platform</span><span class="symbol">::</span><span class="function">Maximum</span><span class="symbol">(</span>
<span class="normal">			            lineWidthMaxSeen</span><span class="symbol">,</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">positions</span><span class="symbol">[</span><span class="normal">ll</span><span class="symbol">-&gt;</span><span class="normal">numCharsInLine</span><span class="symbol">]);</span>
<span class="normal">			</span><span class="comment">//gdk_flush();</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		ll</span><span class="symbol">.</span><span class="function">Set</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">);</span>
<span class="normal">		</span><span class="comment">//if (durPaint &lt; 0.00000001)</span>
<span class="normal">		</span><span class="comment">//	durPaint = 0.00000001;</span>

<span class="normal">		</span><span class="comment">// Right column limit indicator</span>
<span class="normal">		</span><span class="usertype">PRectangle</span><span class="normal"> rcBeyondEOF </span><span class="symbol">=</span><span class="normal"> rcClient</span><span class="symbol">;</span>
<span class="normal">		rcBeyondEOF</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">=</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">fixedColumnWidth</span><span class="symbol">;</span>
<span class="normal">		rcBeyondEOF</span><span class="symbol">.</span><span class="normal">right </span><span class="symbol">=</span><span class="normal"> rcBeyondEOF</span><span class="symbol">.</span><span class="normal">right</span><span class="symbol">;</span>
<span class="normal">		rcBeyondEOF</span><span class="symbol">.</span><span class="normal">top </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">cs</span><span class="symbol">.</span><span class="function">LinesDisplayed</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> topLine</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">lineHeight</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">rcBeyondEOF</span><span class="symbol">.</span><span class="normal">top </span><span class="symbol">&lt;</span><span class="normal"> rcBeyondEOF</span><span class="symbol">.</span><span class="normal">bottom</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			surfaceWindow</span><span class="symbol">-&gt;</span><span class="function">FillRectangle</span><span class="symbol">(</span><span class="normal">rcBeyondEOF</span><span class="symbol">,</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">STYLE_DEFAULT</span><span class="symbol">].</span><span class="normal">back</span><span class="symbol">.</span><span class="normal">allocated</span><span class="symbol">);</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vs</span><span class="symbol">.</span><span class="normal">edgeState </span><span class="symbol">==</span><span class="normal"> EDGE_LINE</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="type">int</span><span class="normal"> edgeX </span><span class="symbol">=</span><span class="normal"> theEdge </span><span class="symbol">*</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">spaceWidth</span><span class="symbol">;</span>
<span class="normal">				rcBeyondEOF</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">=</span><span class="normal"> edgeX </span><span class="symbol">+</span><span class="normal"> xStart</span><span class="symbol">;</span>
<span class="normal">				rcBeyondEOF</span><span class="symbol">.</span><span class="normal">right </span><span class="symbol">=</span><span class="normal"> rcBeyondEOF</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">				surfaceWindow</span><span class="symbol">-&gt;</span><span class="function">FillRectangle</span><span class="symbol">(</span><span class="normal">rcBeyondEOF</span><span class="symbol">,</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">edgecolour</span><span class="symbol">.</span><span class="normal">allocated</span><span class="symbol">);</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="comment">//Platform::DebugPrintf(</span>
<span class="normal">		</span><span class="comment">//"Layout:%9.6g    Paint:%9.6g    Ratio:%9.6g   Copy:%9.6g   Total:%9.6g\n",</span>
<span class="normal">		</span><span class="comment">//durLayout, durPaint, durLayout / durPaint, durCopy, etWhole.Duration());</span>
<span class="normal">		</span><span class="function">NotifyPainted</span><span class="symbol">();</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="comment">// Space (3 space characters) between line numbers and text when printing.</span>
<span class="preproc">#define</span><span class="normal"> lineNumberPrintSpace </span><span class="string">"   "</span>

<span class="usertype">ColourDesired</span><span class="normal"> </span><span class="function">InvertedLight</span><span class="symbol">(</span><span class="usertype">ColourDesired</span><span class="normal"> orig</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> r </span><span class="symbol">=</span><span class="normal"> orig</span><span class="symbol">.</span><span class="function">GetRed</span><span class="symbol">();</span>
<span class="normal">	</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> g </span><span class="symbol">=</span><span class="normal"> orig</span><span class="symbol">.</span><span class="function">GetGreen</span><span class="symbol">();</span>
<span class="normal">	</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> b </span><span class="symbol">=</span><span class="normal"> orig</span><span class="symbol">.</span><span class="function">GetBlue</span><span class="symbol">();</span>
<span class="normal">	</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> l </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">r </span><span class="symbol">+</span><span class="normal"> g </span><span class="symbol">+</span><span class="normal"> b</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">/</span><span class="normal"> </span><span class="number">3</span><span class="symbol">;</span><span class="normal"> 	</span><span class="comment">// There is a better calculation for this that matches human eye</span>
<span class="normal">	</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> il </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0xff</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> l</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">l </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="function">ColourDesired</span><span class="symbol">(</span><span class="number">0xff</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">	r </span><span class="symbol">=</span><span class="normal"> r </span><span class="symbol">*</span><span class="normal"> il </span><span class="symbol">/</span><span class="normal"> l</span><span class="symbol">;</span>
<span class="normal">	g </span><span class="symbol">=</span><span class="normal"> g </span><span class="symbol">*</span><span class="normal"> il </span><span class="symbol">/</span><span class="normal"> l</span><span class="symbol">;</span>
<span class="normal">	b </span><span class="symbol">=</span><span class="normal"> b </span><span class="symbol">*</span><span class="normal"> il </span><span class="symbol">/</span><span class="normal"> l</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="function">ColourDesired</span><span class="symbol">(</span><span class="normal">Platform</span><span class="symbol">::</span><span class="function">Minimum</span><span class="symbol">(</span><span class="normal">r</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">),</span><span class="normal"> Platform</span><span class="symbol">::</span><span class="function">Minimum</span><span class="symbol">(</span><span class="normal">g</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">),</span><span class="normal"> Platform</span><span class="symbol">::</span><span class="function">Minimum</span><span class="symbol">(</span><span class="normal">b</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">));</span>
<span class="cbracket">}</span>

<span class="comment">// This is mostly copied from the Paint method but with some things omitted</span>
<span class="comment">// such as the margin markers, line numbers, selection and caret</span>
<span class="comment">// Should be merged back into a combined Draw method.</span>
<span class="type">long</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">FormatRange</span><span class="symbol">(</span><span class="type">bool</span><span class="normal"> draw</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">Sci_RangeToFormat</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">pfr</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">pfr</span><span class="symbol">)</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">	</span><span class="usertype">AutoSurface</span><span class="normal"> </span><span class="function">surface</span><span class="symbol">(</span><span class="normal">pfr</span><span class="symbol">-&gt;</span><span class="normal">hdc</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">this</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">surface</span><span class="symbol">)</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">	</span><span class="usertype">AutoSurface</span><span class="normal"> </span><span class="function">surfaceMeasure</span><span class="symbol">(</span><span class="normal">pfr</span><span class="symbol">-&gt;</span><span class="normal">hdcTarget</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">this</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">surfaceMeasure</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="comment">// Can't use measurements cached for screen</span>
<span class="normal">	posCache</span><span class="symbol">.</span><span class="function">Clear</span><span class="symbol">();</span>

<span class="normal">	</span><span class="usertype">ViewStyle</span><span class="normal"> </span><span class="function">vsPrint</span><span class="symbol">(</span><span class="normal">vs</span><span class="symbol">);</span>

<span class="normal">	</span><span class="comment">// Modify the view style for printing as do not normally want any of the transient features to be printed</span>
<span class="normal">	</span><span class="comment">// Printing supports only the line number margin.</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> lineNumberIndex </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="normal"> margin </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> margin </span><span class="symbol">&lt;</span><span class="normal"> ViewStyle</span><span class="symbol">::</span><span class="normal">margins</span><span class="symbol">;</span><span class="normal"> margin</span><span class="symbol">++)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">vsPrint</span><span class="symbol">.</span><span class="normal">ms</span><span class="symbol">[</span><span class="normal">margin</span><span class="symbol">].</span><span class="normal">style </span><span class="symbol">==</span><span class="normal"> SC_MARGIN_NUMBER</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vsPrint</span><span class="symbol">.</span><span class="normal">ms</span><span class="symbol">[</span><span class="normal">margin</span><span class="symbol">].</span><span class="normal">width </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			lineNumberIndex </span><span class="symbol">=</span><span class="normal"> margin</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			vsPrint</span><span class="symbol">.</span><span class="normal">ms</span><span class="symbol">[</span><span class="normal">margin</span><span class="symbol">].</span><span class="normal">width </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	vsPrint</span><span class="symbol">.</span><span class="normal">showMarkedLines </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="normal">	vsPrint</span><span class="symbol">.</span><span class="normal">fixedColumnWidth </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">	vsPrint</span><span class="symbol">.</span><span class="normal">zoomLevel </span><span class="symbol">=</span><span class="normal"> printMagnification</span><span class="symbol">;</span>
<span class="normal">	vsPrint</span><span class="symbol">.</span><span class="normal">viewIndentationGuides </span><span class="symbol">=</span><span class="normal"> ivNone</span><span class="symbol">;</span>
<span class="normal">	</span><span class="comment">// Don't show the selection when printing</span>
<span class="normal">	vsPrint</span><span class="symbol">.</span><span class="normal">selbackset </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="normal">	vsPrint</span><span class="symbol">.</span><span class="normal">selforeset </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="normal">	vsPrint</span><span class="symbol">.</span><span class="normal">selAlpha </span><span class="symbol">=</span><span class="normal"> SC_ALPHA_NOALPHA</span><span class="symbol">;</span>
<span class="normal">	vsPrint</span><span class="symbol">.</span><span class="normal">whitespaceBackgroundSet </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="normal">	vsPrint</span><span class="symbol">.</span><span class="normal">whitespaceForegroundSet </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="normal">	vsPrint</span><span class="symbol">.</span><span class="normal">showCaretLineBackground </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>

<span class="normal">	</span><span class="comment">// Set colours for printing according to users settings</span>
<span class="normal">	</span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="usertype">size_t</span><span class="normal"> sty </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal">sty </span><span class="symbol">&lt;</span><span class="normal"> vsPrint</span><span class="symbol">.</span><span class="normal">stylesSize</span><span class="symbol">;</span><span class="normal">sty</span><span class="symbol">++)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">printColourMode </span><span class="symbol">==</span><span class="normal"> SC_PRINT_INVERTLIGHT</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			vsPrint</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">sty</span><span class="symbol">].</span><span class="normal">fore</span><span class="symbol">.</span><span class="normal">desired </span><span class="symbol">=</span><span class="normal"> </span><span class="function">InvertedLight</span><span class="symbol">(</span><span class="normal">vsPrint</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">sty</span><span class="symbol">].</span><span class="normal">fore</span><span class="symbol">.</span><span class="normal">desired</span><span class="symbol">);</span>
<span class="normal">			vsPrint</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">sty</span><span class="symbol">].</span><span class="normal">back</span><span class="symbol">.</span><span class="normal">desired </span><span class="symbol">=</span><span class="normal"> </span><span class="function">InvertedLight</span><span class="symbol">(</span><span class="normal">vsPrint</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">sty</span><span class="symbol">].</span><span class="normal">back</span><span class="symbol">.</span><span class="normal">desired</span><span class="symbol">);</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">printColourMode </span><span class="symbol">==</span><span class="normal"> SC_PRINT_BLACKONWHITE</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			vsPrint</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">sty</span><span class="symbol">].</span><span class="normal">fore</span><span class="symbol">.</span><span class="normal">desired </span><span class="symbol">=</span><span class="normal"> </span><span class="function">ColourDesired</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">);</span>
<span class="normal">			vsPrint</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">sty</span><span class="symbol">].</span><span class="normal">back</span><span class="symbol">.</span><span class="normal">desired </span><span class="symbol">=</span><span class="normal"> </span><span class="function">ColourDesired</span><span class="symbol">(</span><span class="number">0xff</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">printColourMode </span><span class="symbol">==</span><span class="normal"> SC_PRINT_COLOURONWHITE</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			vsPrint</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">sty</span><span class="symbol">].</span><span class="normal">back</span><span class="symbol">.</span><span class="normal">desired </span><span class="symbol">=</span><span class="normal"> </span><span class="function">ColourDesired</span><span class="symbol">(</span><span class="number">0xff</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">printColourMode </span><span class="symbol">==</span><span class="normal"> SC_PRINT_COLOURONWHITEDEFAULTBG</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">sty </span><span class="symbol">&lt;=</span><span class="normal"> STYLE_DEFAULT</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				vsPrint</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">sty</span><span class="symbol">].</span><span class="normal">back</span><span class="symbol">.</span><span class="normal">desired </span><span class="symbol">=</span><span class="normal"> </span><span class="function">ColourDesired</span><span class="symbol">(</span><span class="number">0xff</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="comment">// White background for the line numbers</span>
<span class="normal">	vsPrint</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">STYLE_LINENUMBER</span><span class="symbol">].</span><span class="normal">back</span><span class="symbol">.</span><span class="normal">desired </span><span class="symbol">=</span><span class="normal"> </span><span class="function">ColourDesired</span><span class="symbol">(</span><span class="number">0xff</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0xff</span><span class="symbol">);</span>

<span class="normal">	vsPrint</span><span class="symbol">.</span><span class="function">Refresh</span><span class="symbol">(*</span><span class="normal">surfaceMeasure</span><span class="symbol">);</span>
<span class="normal">	</span><span class="comment">// Determining width must hapen after fonts have been realised in Refresh</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> lineNumberWidth </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lineNumberIndex </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		lineNumberWidth </span><span class="symbol">=</span><span class="normal"> surfaceMeasure</span><span class="symbol">-&gt;</span><span class="function">WidthText</span><span class="symbol">(</span><span class="normal">vsPrint</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">STYLE_LINENUMBER</span><span class="symbol">].</span><span class="normal">font</span><span class="symbol">,</span>
<span class="normal">		        </span><span class="string">"99999"</span><span class="normal"> lineNumberPrintSpace</span><span class="symbol">,</span><span class="normal"> </span><span class="number">5</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="function">istrlen</span><span class="symbol">(</span><span class="normal">lineNumberPrintSpace</span><span class="symbol">));</span>
<span class="normal">		vsPrint</span><span class="symbol">.</span><span class="normal">ms</span><span class="symbol">[</span><span class="normal">lineNumberIndex</span><span class="symbol">].</span><span class="normal">width </span><span class="symbol">=</span><span class="normal"> lineNumberWidth</span><span class="symbol">;</span>
<span class="normal">		vsPrint</span><span class="symbol">.</span><span class="function">Refresh</span><span class="symbol">(*</span><span class="normal">surfaceMeasure</span><span class="symbol">);</span><span class="normal">	</span><span class="comment">// Recalculate fixedColumnWidth</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="comment">// Ensure colours are set up</span>
<span class="normal">	vsPrint</span><span class="symbol">.</span><span class="function">RefreshColourPalette</span><span class="symbol">(</span><span class="normal">palette</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">);</span>
<span class="normal">	vsPrint</span><span class="symbol">.</span><span class="function">RefreshColourPalette</span><span class="symbol">(</span><span class="normal">palette</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">);</span>

<span class="normal">	</span><span class="type">int</span><span class="normal"> linePrintStart </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineFromPosition</span><span class="symbol">(</span><span class="normal">pfr</span><span class="symbol">-&gt;</span><span class="normal">chrg</span><span class="symbol">.</span><span class="normal">cpMin</span><span class="symbol">);</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> linePrintLast </span><span class="symbol">=</span><span class="normal"> linePrintStart </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pfr</span><span class="symbol">-&gt;</span><span class="normal">rc</span><span class="symbol">.</span><span class="normal">bottom </span><span class="symbol">-</span><span class="normal"> pfr</span><span class="symbol">-&gt;</span><span class="normal">rc</span><span class="symbol">.</span><span class="normal">top</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">/</span><span class="normal"> vsPrint</span><span class="symbol">.</span><span class="normal">lineHeight </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">linePrintLast </span><span class="symbol">&lt;</span><span class="normal"> linePrintStart</span><span class="symbol">)</span>
<span class="normal">		linePrintLast </span><span class="symbol">=</span><span class="normal"> linePrintStart</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> linePrintMax </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineFromPosition</span><span class="symbol">(</span><span class="normal">pfr</span><span class="symbol">-&gt;</span><span class="normal">chrg</span><span class="symbol">.</span><span class="normal">cpMax</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">linePrintLast </span><span class="symbol">&gt;</span><span class="normal"> linePrintMax</span><span class="symbol">)</span>
<span class="normal">		linePrintLast </span><span class="symbol">=</span><span class="normal"> linePrintMax</span><span class="symbol">;</span>
<span class="normal">	</span><span class="comment">//Platform::DebugPrintf("Formatting lines=[%0d,%0d,%0d] top=%0d bottom=%0d line=%0d %0d\n",</span>
<span class="normal">	</span><span class="comment">//      linePrintStart, linePrintLast, linePrintMax, pfr-&gt;rc.top, pfr-&gt;rc.bottom, vsPrint.lineHeight,</span>
<span class="normal">	</span><span class="comment">//      surfaceMeasure-&gt;Height(vsPrint.styles[STYLE_LINENUMBER].font));</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> endPosPrint </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">Length</span><span class="symbol">();</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">linePrintLast </span><span class="symbol">&lt;</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LinesTotal</span><span class="symbol">())</span>
<span class="normal">		endPosPrint </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">linePrintLast </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>

<span class="normal">	</span><span class="comment">// Ensure we are styled to where we are formatting.</span>
<span class="normal">	pdoc</span><span class="symbol">-&gt;</span><span class="function">EnsureStyledTo</span><span class="symbol">(</span><span class="normal">endPosPrint</span><span class="symbol">);</span>

<span class="normal">	</span><span class="type">int</span><span class="normal"> xStart </span><span class="symbol">=</span><span class="normal"> vsPrint</span><span class="symbol">.</span><span class="normal">fixedColumnWidth </span><span class="symbol">+</span><span class="normal"> pfr</span><span class="symbol">-&gt;</span><span class="normal">rc</span><span class="symbol">.</span><span class="normal">left</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> ypos </span><span class="symbol">=</span><span class="normal"> pfr</span><span class="symbol">-&gt;</span><span class="normal">rc</span><span class="symbol">.</span><span class="normal">top</span><span class="symbol">;</span>

<span class="normal">	</span><span class="type">int</span><span class="normal"> lineDoc </span><span class="symbol">=</span><span class="normal"> linePrintStart</span><span class="symbol">;</span>

<span class="normal">	</span><span class="type">int</span><span class="normal"> nPrintPos </span><span class="symbol">=</span><span class="normal"> pfr</span><span class="symbol">-&gt;</span><span class="normal">chrg</span><span class="symbol">.</span><span class="normal">cpMin</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> visibleLine </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> widthPrint </span><span class="symbol">=</span><span class="normal"> pfr</span><span class="symbol">-&gt;</span><span class="normal">rc</span><span class="symbol">.</span><span class="function">Width</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> vsPrint</span><span class="symbol">.</span><span class="normal">fixedColumnWidth</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">printWrapState </span><span class="symbol">==</span><span class="normal"> eWrapNone</span><span class="symbol">)</span>
<span class="normal">		widthPrint </span><span class="symbol">=</span><span class="normal"> LineLayout</span><span class="symbol">::</span><span class="normal">wrapWidthInfinite</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lineDoc </span><span class="symbol">&lt;=</span><span class="normal"> linePrintLast </span><span class="symbol">&amp;&amp;</span><span class="normal"> ypos </span><span class="symbol">&lt;</span><span class="normal"> pfr</span><span class="symbol">-&gt;</span><span class="normal">rc</span><span class="symbol">.</span><span class="normal">bottom</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>

<span class="normal">		</span><span class="comment">// When printing, the hdc and hdcTarget may be the same, so</span>
<span class="normal">		</span><span class="comment">// changing the state of surfaceMeasure may change the underlying</span>
<span class="normal">		</span><span class="comment">// state of surface. Therefore, any cached state is discarded before</span>
<span class="normal">		</span><span class="comment">// using each surface.</span>
<span class="normal">		surfaceMeasure</span><span class="symbol">-&gt;</span><span class="function">FlushCachedState</span><span class="symbol">();</span>

<span class="normal">		</span><span class="comment">// Copy this line and its styles from the document into local arrays</span>
<span class="normal">		</span><span class="comment">// and determine the x position at which each character starts.</span>
<span class="normal">		</span><span class="usertype">LineLayout</span><span class="normal"> </span><span class="function">ll</span><span class="symbol">(</span><span class="number">8000</span><span class="symbol">);</span>
<span class="normal">		</span><span class="function">LayoutLine</span><span class="symbol">(</span><span class="normal">lineDoc</span><span class="symbol">,</span><span class="normal"> surfaceMeasure</span><span class="symbol">,</span><span class="normal"> vsPrint</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">ll</span><span class="symbol">,</span><span class="normal"> widthPrint</span><span class="symbol">);</span>

<span class="normal">		ll</span><span class="symbol">.</span><span class="normal">selStart </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">		ll</span><span class="symbol">.</span><span class="normal">selEnd </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">		ll</span><span class="symbol">.</span><span class="normal">containsCaret </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>

<span class="normal">		</span><span class="usertype">PRectangle</span><span class="normal"> rcLine</span><span class="symbol">;</span>
<span class="normal">		rcLine</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">=</span><span class="normal"> pfr</span><span class="symbol">-&gt;</span><span class="normal">rc</span><span class="symbol">.</span><span class="normal">left</span><span class="symbol">;</span>
<span class="normal">		rcLine</span><span class="symbol">.</span><span class="normal">top </span><span class="symbol">=</span><span class="normal"> ypos</span><span class="symbol">;</span>
<span class="normal">		rcLine</span><span class="symbol">.</span><span class="normal">right </span><span class="symbol">=</span><span class="normal"> pfr</span><span class="symbol">-&gt;</span><span class="normal">rc</span><span class="symbol">.</span><span class="normal">right </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">		rcLine</span><span class="symbol">.</span><span class="normal">bottom </span><span class="symbol">=</span><span class="normal"> ypos </span><span class="symbol">+</span><span class="normal"> vsPrint</span><span class="symbol">.</span><span class="normal">lineHeight</span><span class="symbol">;</span>

<span class="normal">		</span><span class="comment">// When document line is wrapped over multiple display lines, find where</span>
<span class="normal">		</span><span class="comment">// to start printing from to ensure a particular position is on the first</span>
<span class="normal">		</span><span class="comment">// line of the page.</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">visibleLine </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> startWithinLine </span><span class="symbol">=</span><span class="normal"> nPrintPos </span><span class="symbol">-</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">lineDoc</span><span class="symbol">);</span>
<span class="normal">			</span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="normal"> iwl </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> iwl </span><span class="symbol">&lt;</span><span class="normal"> ll</span><span class="symbol">.</span><span class="normal">lines </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span><span class="normal"> iwl</span><span class="symbol">++)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">.</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">iwl</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&lt;=</span><span class="normal"> startWithinLine </span><span class="symbol">&amp;&amp;</span><span class="normal"> ll</span><span class="symbol">.</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">iwl </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;=</span><span class="normal"> startWithinLine</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					visibleLine </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">-</span><span class="normal">iwl</span><span class="symbol">;</span>
<span class="normal">				</span><span class="cbracket">}</span>
<span class="normal">			</span><span class="cbracket">}</span>

<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">.</span><span class="normal">lines </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> startWithinLine </span><span class="symbol">&gt;=</span><span class="normal"> ll</span><span class="symbol">.</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">ll</span><span class="symbol">.</span><span class="normal">lines </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				visibleLine </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">-(</span><span class="normal">ll</span><span class="symbol">.</span><span class="normal">lines </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span>

<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">draw </span><span class="symbol">&amp;&amp;</span><span class="normal"> lineNumberWidth </span><span class="symbol">&amp;&amp;</span>
<span class="normal">		        </span><span class="symbol">(</span><span class="normal">ypos </span><span class="symbol">+</span><span class="normal"> vsPrint</span><span class="symbol">.</span><span class="normal">lineHeight </span><span class="symbol">&lt;=</span><span class="normal"> pfr</span><span class="symbol">-&gt;</span><span class="normal">rc</span><span class="symbol">.</span><span class="normal">bottom</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span>
<span class="normal">		        </span><span class="symbol">(</span><span class="normal">visibleLine </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="type">char</span><span class="normal"> number</span><span class="symbol">[</span><span class="number">100</span><span class="symbol">];</span>
<span class="normal">			</span><span class="function">sprintf</span><span class="symbol">(</span><span class="normal">number</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%d"</span><span class="normal"> lineNumberPrintSpace</span><span class="symbol">,</span><span class="normal"> lineDoc </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">			</span><span class="usertype">PRectangle</span><span class="normal"> rcNumber </span><span class="symbol">=</span><span class="normal"> rcLine</span><span class="symbol">;</span>
<span class="normal">			rcNumber</span><span class="symbol">.</span><span class="normal">right </span><span class="symbol">=</span><span class="normal"> rcNumber</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">+</span><span class="normal"> lineNumberWidth</span><span class="symbol">;</span>
<span class="normal">			</span><span class="comment">// Right justify</span>
<span class="normal">			rcNumber</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">=</span><span class="normal"> rcNumber</span><span class="symbol">.</span><span class="normal">right </span><span class="symbol">-</span><span class="normal"> surfaceMeasure</span><span class="symbol">-&gt;</span><span class="function">WidthText</span><span class="symbol">(</span>
<span class="normal">			            vsPrint</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">STYLE_LINENUMBER</span><span class="symbol">].</span><span class="normal">font</span><span class="symbol">,</span><span class="normal"> number</span><span class="symbol">,</span><span class="normal"> </span><span class="function">istrlen</span><span class="symbol">(</span><span class="normal">number</span><span class="symbol">));</span>
<span class="normal">			surface</span><span class="symbol">-&gt;</span><span class="function">FlushCachedState</span><span class="symbol">();</span>
<span class="normal">			surface</span><span class="symbol">-&gt;</span><span class="function">DrawTextNoClip</span><span class="symbol">(</span><span class="normal">rcNumber</span><span class="symbol">,</span><span class="normal"> vsPrint</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">STYLE_LINENUMBER</span><span class="symbol">].</span><span class="normal">font</span><span class="symbol">,</span>
<span class="normal">			        ypos </span><span class="symbol">+</span><span class="normal"> vsPrint</span><span class="symbol">.</span><span class="normal">maxAscent</span><span class="symbol">,</span><span class="normal"> number</span><span class="symbol">,</span><span class="normal"> </span><span class="function">istrlen</span><span class="symbol">(</span><span class="normal">number</span><span class="symbol">),</span>
<span class="normal">			        vsPrint</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">STYLE_LINENUMBER</span><span class="symbol">].</span><span class="normal">fore</span><span class="symbol">.</span><span class="normal">allocated</span><span class="symbol">,</span>
<span class="normal">			        vsPrint</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">STYLE_LINENUMBER</span><span class="symbol">].</span><span class="normal">back</span><span class="symbol">.</span><span class="normal">allocated</span><span class="symbol">);</span>
<span class="normal">		</span><span class="cbracket">}</span>

<span class="normal">		</span><span class="comment">// Draw the line</span>
<span class="normal">		surface</span><span class="symbol">-&gt;</span><span class="function">FlushCachedState</span><span class="symbol">();</span>

<span class="normal">		</span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="normal"> iwl </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> iwl </span><span class="symbol">&lt;</span><span class="normal"> ll</span><span class="symbol">.</span><span class="normal">lines</span><span class="symbol">;</span><span class="normal"> iwl</span><span class="symbol">++)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ypos </span><span class="symbol">+</span><span class="normal"> vsPrint</span><span class="symbol">.</span><span class="normal">lineHeight </span><span class="symbol">&lt;=</span><span class="normal"> pfr</span><span class="symbol">-&gt;</span><span class="normal">rc</span><span class="symbol">.</span><span class="normal">bottom</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">visibleLine </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">draw</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">						rcLine</span><span class="symbol">.</span><span class="normal">top </span><span class="symbol">=</span><span class="normal"> ypos</span><span class="symbol">;</span>
<span class="normal">						rcLine</span><span class="symbol">.</span><span class="normal">bottom </span><span class="symbol">=</span><span class="normal"> ypos </span><span class="symbol">+</span><span class="normal"> vsPrint</span><span class="symbol">.</span><span class="normal">lineHeight</span><span class="symbol">;</span>
<span class="normal">						</span><span class="function">DrawLine</span><span class="symbol">(</span><span class="normal">surface</span><span class="symbol">,</span><span class="normal"> vsPrint</span><span class="symbol">,</span><span class="normal"> lineDoc</span><span class="symbol">,</span><span class="normal"> visibleLine</span><span class="symbol">,</span><span class="normal"> xStart</span><span class="symbol">,</span><span class="normal"> rcLine</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">ll</span><span class="symbol">,</span><span class="normal"> iwl</span><span class="symbol">);</span>
<span class="normal">					</span><span class="cbracket">}</span>
<span class="normal">					ypos </span><span class="symbol">+=</span><span class="normal"> vsPrint</span><span class="symbol">.</span><span class="normal">lineHeight</span><span class="symbol">;</span>
<span class="normal">				</span><span class="cbracket">}</span>
<span class="normal">				visibleLine</span><span class="symbol">++;</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">iwl </span><span class="symbol">==</span><span class="normal"> ll</span><span class="symbol">.</span><span class="normal">lines </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span>
<span class="normal">					nPrintPos </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">lineDoc </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">				</span><span class="keyword">else</span>
<span class="normal">					nPrintPos </span><span class="symbol">+=</span><span class="normal"> ll</span><span class="symbol">.</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">iwl </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> ll</span><span class="symbol">.</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">iwl</span><span class="symbol">);</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span>

<span class="normal">		</span><span class="symbol">++</span><span class="normal">lineDoc</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="comment">// Clear cache so measurements are not used for screen</span>
<span class="normal">	posCache</span><span class="symbol">.</span><span class="function">Clear</span><span class="symbol">();</span>

<span class="normal">	</span><span class="keyword">return</span><span class="normal"> nPrintPos</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="type">int</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">TextWidth</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> style</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">text</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="function">RefreshStyleData</span><span class="symbol">();</span>
<span class="normal">	</span><span class="usertype">AutoSurface</span><span class="normal"> </span><span class="function">surface</span><span class="symbol">(</span><span class="keyword">this</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">surface</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> surface</span><span class="symbol">-&gt;</span><span class="function">WidthText</span><span class="symbol">(</span><span class="normal">vs</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">style</span><span class="symbol">].</span><span class="normal">font</span><span class="symbol">,</span><span class="normal"> text</span><span class="symbol">,</span><span class="normal"> </span><span class="function">istrlen</span><span class="symbol">(</span><span class="normal">text</span><span class="symbol">));</span>
<span class="normal">	</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="comment">// Empty method is overridden on GTK+ to show / hide scrollbars</span>
<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">ReconfigureScrollBars</span><span class="symbol">()</span><span class="normal"> </span><span class="cbracket">{}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">SetScrollBars</span><span class="symbol">()</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="function">RefreshStyleData</span><span class="symbol">();</span>

<span class="normal">	</span><span class="type">int</span><span class="normal"> nMax </span><span class="symbol">=</span><span class="normal"> </span><span class="function">MaxScrollPos</span><span class="symbol">();</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> nPage </span><span class="symbol">=</span><span class="normal"> </span><span class="function">LinesOnScreen</span><span class="symbol">();</span>
<span class="normal">	</span><span class="type">bool</span><span class="normal"> modified </span><span class="symbol">=</span><span class="normal"> </span><span class="function">ModifyScrollBars</span><span class="symbol">(</span><span class="normal">nMax </span><span class="symbol">+</span><span class="normal"> nPage </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span><span class="normal"> nPage</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">modified</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">DwellEnd</span><span class="symbol">(</span><span class="keyword">true</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="comment">// TODO: ensure always showing as many lines as possible</span>
<span class="normal">	</span><span class="comment">// May not be, if, for example, window made larger</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">topLine </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="function">MaxScrollPos</span><span class="symbol">())</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">SetTopLine</span><span class="symbol">(</span><span class="normal">Platform</span><span class="symbol">::</span><span class="function">Clamp</span><span class="symbol">(</span><span class="normal">topLine</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="function">MaxScrollPos</span><span class="symbol">()));</span>
<span class="normal">		</span><span class="function">SetVerticalScrollPos</span><span class="symbol">();</span>
<span class="normal">		</span><span class="function">Redraw</span><span class="symbol">();</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">modified</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="function">AbandonPaint</span><span class="symbol">())</span>
<span class="normal">			</span><span class="function">Redraw</span><span class="symbol">();</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="comment">//Platform::DebugPrintf("end max = %d page = %d\n", nMax, nPage);</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">ChangeSize</span><span class="symbol">()</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="function">DropGraphics</span><span class="symbol">();</span>
<span class="normal">	</span><span class="function">SetScrollBars</span><span class="symbol">();</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">wrapState </span><span class="symbol">!=</span><span class="normal"> eWrapNone</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="usertype">PRectangle</span><span class="normal"> rcTextArea </span><span class="symbol">=</span><span class="normal"> </span><span class="function">GetClientRectangle</span><span class="symbol">();</span>
<span class="normal">		rcTextArea</span><span class="symbol">.</span><span class="normal">left </span><span class="symbol">=</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">fixedColumnWidth</span><span class="symbol">;</span>
<span class="normal">		rcTextArea</span><span class="symbol">.</span><span class="normal">right </span><span class="symbol">-=</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">rightMarginWidth</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">wrapWidth </span><span class="symbol">!=</span><span class="normal"> rcTextArea</span><span class="symbol">.</span><span class="function">Width</span><span class="symbol">())</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="function">NeedWrapping</span><span class="symbol">();</span>
<span class="normal">			</span><span class="function">Redraw</span><span class="symbol">();</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">AddChar</span><span class="symbol">(</span><span class="type">char</span><span class="normal"> ch</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="type">char</span><span class="normal"> s</span><span class="symbol">[</span><span class="number">2</span><span class="symbol">];</span>
<span class="normal">	s</span><span class="symbol">[</span><span class="number">0</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> ch</span><span class="symbol">;</span>
<span class="normal">	s</span><span class="symbol">[</span><span class="number">1</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="string">'</span><span class="specialchar">\0</span><span class="string">'</span><span class="symbol">;</span>
<span class="normal">	</span><span class="function">AddCharUTF</span><span class="symbol">(</span><span class="normal">s</span><span class="symbol">,</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="comment">// AddCharUTF inserts an array of bytes which may or may not be in UTF-8.</span>
<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">AddCharUTF</span><span class="symbol">(</span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">s</span><span class="symbol">,</span><span class="normal"> </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> len</span><span class="symbol">,</span><span class="normal"> </span><span class="type">bool</span><span class="normal"> treatAsDBCS</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="type">bool</span><span class="normal"> wasSelection </span><span class="symbol">=</span><span class="normal"> currentPos </span><span class="symbol">!=</span><span class="normal"> anchor</span><span class="symbol">;</span>
<span class="normal">	</span><span class="function">ClearSelection</span><span class="symbol">();</span>
<span class="normal">	</span><span class="type">bool</span><span class="normal"> charReplaceAction </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">inOverstrike </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">!</span><span class="normal">wasSelection </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">!</span><span class="function">RangeContainsProtected</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">,</span><span class="normal"> currentPos </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">currentPos </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">Length</span><span class="symbol">()))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="function">IsEOLChar</span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">CharAt</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">)))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				charReplaceAction </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>
<span class="normal">				pdoc</span><span class="symbol">-&gt;</span><span class="function">BeginUndoAction</span><span class="symbol">();</span>
<span class="normal">				pdoc</span><span class="symbol">-&gt;</span><span class="function">DelChar</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">);</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">InsertString</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">,</span><span class="normal"> s</span><span class="symbol">,</span><span class="normal"> len</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">SetEmptySelection</span><span class="symbol">(</span><span class="normal">currentPos </span><span class="symbol">+</span><span class="normal"> len</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">charReplaceAction</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		pdoc</span><span class="symbol">-&gt;</span><span class="function">EndUndoAction</span><span class="symbol">();</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="comment">// If in wrap mode rewrap current line so EnsureCaretVisible has accurate information</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">wrapState </span><span class="symbol">!=</span><span class="normal"> eWrapNone</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="usertype">AutoSurface</span><span class="normal"> </span><span class="function">surface</span><span class="symbol">(</span><span class="keyword">this</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">surface</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="function">WrapOneLine</span><span class="symbol">(</span><span class="normal">surface</span><span class="symbol">,</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineFromPosition</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">));</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="function">SetScrollBars</span><span class="symbol">();</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="function">EnsureCaretVisible</span><span class="symbol">();</span>
<span class="normal">	</span><span class="comment">// Avoid blinking during rapid typing:</span>
<span class="normal">	</span><span class="function">ShowCaretAtCurrentPosition</span><span class="symbol">();</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">caretSticky</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">SetLastXChosen</span><span class="symbol">();</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">treatAsDBCS</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">NotifyChar</span><span class="symbol">((</span><span class="keyword">static_cast</span><span class="symbol">&lt;</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="symbol">&gt;(</span><span class="normal">s</span><span class="symbol">[</span><span class="number">0</span><span class="symbol">])</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">|</span>
<span class="normal">		        </span><span class="keyword">static_cast</span><span class="symbol">&lt;</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="symbol">&gt;(</span><span class="normal">s</span><span class="symbol">[</span><span class="number">1</span><span class="symbol">]));</span>
<span class="normal">	</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> byte </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">static_cast</span><span class="symbol">&lt;</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="symbol">&gt;(</span><span class="normal">s</span><span class="symbol">[</span><span class="number">0</span><span class="symbol">]);</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">byte </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">0xC0</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> </span><span class="symbol">(</span><span class="number">1</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> len</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="comment">// Handles UTF-8 characters between 0x01 and 0x7F and single byte</span>
<span class="normal">			</span><span class="comment">// characters when not in UTF-8 mode.</span>
<span class="normal">			</span><span class="comment">// Also treats \0 and naked trail bytes 0x80 to 0xBF as valid</span>
<span class="normal">			</span><span class="comment">// characters representing themselves.</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="comment">// Unroll 1 to 3 byte UTF-8 sequences.  See reference data at:</span>
<span class="normal">			</span><span class="comment">// http://www.cl.cam.ac.uk/~mgk25/unicode.html</span>
<span class="normal">			</span><span class="comment">// http://www.cl.cam.ac.uk/~mgk25/ucs/examples/UTF-8-test.txt</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">byte </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">0xE0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="type">int</span><span class="normal"> byte2 </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">static_cast</span><span class="symbol">&lt;</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="symbol">&gt;(</span><span class="normal">s</span><span class="symbol">[</span><span class="number">1</span><span class="symbol">]);</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">byte2 </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xC0</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0x80</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="comment">// Two-byte-character lead-byte followed by a trail-byte.</span>
<span class="normal">					byte </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(((</span><span class="normal">byte </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x1F</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">6</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">|</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">byte2 </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x3F</span><span class="symbol">));</span>
<span class="normal">				</span><span class="cbracket">}</span>
<span class="normal">				</span><span class="comment">// A two-byte-character lead-byte not followed by trail-byte</span>
<span class="normal">				</span><span class="comment">// represents itself.</span>
<span class="normal">			</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">byte </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">0xF0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="type">int</span><span class="normal"> byte2 </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">static_cast</span><span class="symbol">&lt;</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="symbol">&gt;(</span><span class="normal">s</span><span class="symbol">[</span><span class="number">1</span><span class="symbol">]);</span>
<span class="normal">				</span><span class="type">int</span><span class="normal"> byte3 </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">static_cast</span><span class="symbol">&lt;</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="symbol">&gt;(</span><span class="normal">s</span><span class="symbol">[</span><span class="number">2</span><span class="symbol">]);</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(((</span><span class="normal">byte2 </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xC0</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0x80</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">byte3 </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0xC0</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0x80</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="comment">// Three-byte-character lead byte followed by two trail bytes.</span>
<span class="normal">					byte </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(((</span><span class="normal">byte </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x0F</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">12</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">|</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">byte2 </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x3F</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="number">6</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">|</span>
<span class="normal">					        </span><span class="symbol">(</span><span class="normal">byte3 </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="number">0x3F</span><span class="symbol">));</span>
<span class="normal">				</span><span class="cbracket">}</span>
<span class="normal">				</span><span class="comment">// A three-byte-character lead-byte not followed by two trail-bytes</span>
<span class="normal">				</span><span class="comment">// represents itself.</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="function">NotifyChar</span><span class="symbol">(</span><span class="normal">byte</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">ClearSelection</span><span class="symbol">()</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="function">SelectionContainsProtected</span><span class="symbol">())</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> startPos </span><span class="symbol">=</span><span class="normal"> </span><span class="function">SelectionStart</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">selType </span><span class="symbol">==</span><span class="normal"> selStream</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> chars </span><span class="symbol">=</span><span class="normal"> </span><span class="function">SelectionEnd</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> startPos</span><span class="symbol">;</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="number">0</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> chars</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				pdoc</span><span class="symbol">-&gt;</span><span class="function">BeginUndoAction</span><span class="symbol">();</span>
<span class="normal">				pdoc</span><span class="symbol">-&gt;</span><span class="function">DeleteChars</span><span class="symbol">(</span><span class="normal">startPos</span><span class="symbol">,</span><span class="normal"> chars</span><span class="symbol">);</span>
<span class="normal">				pdoc</span><span class="symbol">-&gt;</span><span class="function">EndUndoAction</span><span class="symbol">();</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			pdoc</span><span class="symbol">-&gt;</span><span class="function">BeginUndoAction</span><span class="symbol">();</span>
<span class="normal">			</span><span class="usertype">SelectionLineIterator</span><span class="normal"> </span><span class="function">lineIterator</span><span class="symbol">(</span><span class="keyword">this</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">);</span>
<span class="normal">			</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lineIterator</span><span class="symbol">.</span><span class="function">Iterate</span><span class="symbol">())</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				startPos </span><span class="symbol">=</span><span class="normal"> lineIterator</span><span class="symbol">.</span><span class="normal">startPos</span><span class="symbol">;</span>
<span class="normal">				</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> chars </span><span class="symbol">=</span><span class="normal"> lineIterator</span><span class="symbol">.</span><span class="normal">endPos </span><span class="symbol">-</span><span class="normal"> startPos</span><span class="symbol">;</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="number">0</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> chars</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					pdoc</span><span class="symbol">-&gt;</span><span class="function">DeleteChars</span><span class="symbol">(</span><span class="normal">startPos</span><span class="symbol">,</span><span class="normal"> chars</span><span class="symbol">);</span>
<span class="normal">				</span><span class="cbracket">}</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">			pdoc</span><span class="symbol">-&gt;</span><span class="function">EndUndoAction</span><span class="symbol">();</span>
<span class="normal">			selType </span><span class="symbol">=</span><span class="normal"> selStream</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="function">SetEmptySelection</span><span class="symbol">(</span><span class="normal">startPos</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">ClearAll</span><span class="symbol">()</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	pdoc</span><span class="symbol">-&gt;</span><span class="function">BeginUndoAction</span><span class="symbol">();</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="number">0</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">Length</span><span class="symbol">())</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		pdoc</span><span class="symbol">-&gt;</span><span class="function">DeleteChars</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">,</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">Length</span><span class="symbol">());</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">IsReadOnly</span><span class="symbol">())</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		cs</span><span class="symbol">.</span><span class="function">Clear</span><span class="symbol">();</span>
<span class="normal">		pdoc</span><span class="symbol">-&gt;</span><span class="function">AnnotationClearAll</span><span class="symbol">();</span>
<span class="normal">		pdoc</span><span class="symbol">-&gt;</span><span class="function">MarginClearAll</span><span class="symbol">();</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	pdoc</span><span class="symbol">-&gt;</span><span class="function">EndUndoAction</span><span class="symbol">();</span>
<span class="normal">	anchor </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">	currentPos </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">	</span><span class="function">SetTopLine</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">);</span>
<span class="normal">	</span><span class="function">SetVerticalScrollPos</span><span class="symbol">();</span>
<span class="normal">	</span><span class="function">InvalidateStyleRedraw</span><span class="symbol">();</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">ClearDocumentStyle</span><span class="symbol">()</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="usertype">Decoration</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">deco </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="normal">decorations</span><span class="symbol">.</span><span class="normal">root</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">deco</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="comment">// Save next in case deco deleted</span>
<span class="normal">		</span><span class="usertype">Decoration</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">decoNext </span><span class="symbol">=</span><span class="normal"> deco</span><span class="symbol">-&gt;</span><span class="normal">next</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">deco</span><span class="symbol">-&gt;</span><span class="normal">indicator </span><span class="symbol">&lt;</span><span class="normal"> INDIC_CONTAINER</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			pdoc</span><span class="symbol">-&gt;</span><span class="normal">decorations</span><span class="symbol">.</span><span class="function">SetCurrentIndicator</span><span class="symbol">(</span><span class="normal">deco</span><span class="symbol">-&gt;</span><span class="normal">indicator</span><span class="symbol">);</span>
<span class="normal">			pdoc</span><span class="symbol">-&gt;</span><span class="function">DecorationFillRange</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">Length</span><span class="symbol">());</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		deco </span><span class="symbol">=</span><span class="normal"> decoNext</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	pdoc</span><span class="symbol">-&gt;</span><span class="function">StartStyling</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="string">'</span><span class="specialchar">\3</span><span class="string">77'</span><span class="symbol">);</span>
<span class="normal">	pdoc</span><span class="symbol">-&gt;</span><span class="function">SetStyleFor</span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">Length</span><span class="symbol">(),</span><span class="normal"> </span><span class="number">0</span><span class="symbol">);</span>
<span class="normal">	cs</span><span class="symbol">.</span><span class="function">ShowAll</span><span class="symbol">();</span>
<span class="normal">	pdoc</span><span class="symbol">-&gt;</span><span class="function">ClearLevels</span><span class="symbol">();</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">CopyAllowLine</span><span class="symbol">()</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="usertype">SelectionText</span><span class="normal"> selectedText</span><span class="symbol">;</span>
<span class="normal">	</span><span class="function">CopySelectionRange</span><span class="symbol">(&amp;</span><span class="normal">selectedText</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">);</span>
<span class="normal">	</span><span class="function">CopyToClipboard</span><span class="symbol">(</span><span class="normal">selectedText</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">Cut</span><span class="symbol">()</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	pdoc</span><span class="symbol">-&gt;</span><span class="function">CheckReadOnly</span><span class="symbol">();</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">IsReadOnly</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">!</span><span class="function">SelectionContainsProtected</span><span class="symbol">())</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">Copy</span><span class="symbol">();</span>
<span class="normal">		</span><span class="function">ClearSelection</span><span class="symbol">();</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">PasteRectangular</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> pos</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">ptr</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> len</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">IsReadOnly</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> </span><span class="function">SelectionContainsProtected</span><span class="symbol">())</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">return</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	currentPos </span><span class="symbol">=</span><span class="normal"> pos</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> xInsert </span><span class="symbol">=</span><span class="normal"> </span><span class="function">XFromPosition</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">);</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> line </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineFromPosition</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">);</span>
<span class="normal">	</span><span class="type">bool</span><span class="normal"> prevCr </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="normal">	pdoc</span><span class="symbol">-&gt;</span><span class="function">BeginUndoAction</span><span class="symbol">();</span>
<span class="normal">	</span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="normal"> i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> len</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">IsEOLChar</span><span class="symbol">(</span><span class="normal">ptr</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">ptr</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="string">'</span><span class="specialchar">\r</span><span class="string">'</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">prevCr</span><span class="symbol">))</span>
<span class="normal">				line</span><span class="symbol">++;</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">line </span><span class="symbol">&gt;=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LinesTotal</span><span class="symbol">())</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="normal">eolMode </span><span class="symbol">!=</span><span class="normal"> SC_EOL_LF</span><span class="symbol">)</span>
<span class="normal">					pdoc</span><span class="symbol">-&gt;</span><span class="function">InsertChar</span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">Length</span><span class="symbol">(),</span><span class="normal"> </span><span class="string">'</span><span class="specialchar">\r</span><span class="string">'</span><span class="symbol">);</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="normal">eolMode </span><span class="symbol">!=</span><span class="normal"> SC_EOL_CR</span><span class="symbol">)</span>
<span class="normal">					pdoc</span><span class="symbol">-&gt;</span><span class="function">InsertChar</span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">Length</span><span class="symbol">(),</span><span class="normal"> </span><span class="string">'</span><span class="specialchar">\n</span><span class="string">'</span><span class="symbol">);</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">			</span><span class="comment">// Pad the end of lines with spaces if required</span>
<span class="normal">			currentPos </span><span class="symbol">=</span><span class="normal"> </span><span class="function">PositionFromLineX</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">,</span><span class="normal"> xInsert</span><span class="symbol">);</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="function">XFromPosition</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&lt;</span><span class="normal"> xInsert</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">&lt;</span><span class="normal"> len</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="function">XFromPosition</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&lt;</span><span class="normal"> xInsert</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					pdoc</span><span class="symbol">-&gt;</span><span class="function">InsertChar</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">,</span><span class="normal"> </span><span class="string">' '</span><span class="symbol">);</span>
<span class="normal">					currentPos</span><span class="symbol">++;</span>
<span class="normal">				</span><span class="cbracket">}</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">			prevCr </span><span class="symbol">=</span><span class="normal"> ptr</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="string">'</span><span class="specialchar">\r</span><span class="string">'</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			pdoc</span><span class="symbol">-&gt;</span><span class="function">InsertString</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">,</span><span class="normal"> ptr </span><span class="symbol">+</span><span class="normal"> i</span><span class="symbol">,</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">			currentPos</span><span class="symbol">++;</span>
<span class="normal">			prevCr </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	pdoc</span><span class="symbol">-&gt;</span><span class="function">EndUndoAction</span><span class="symbol">();</span>
<span class="normal">	</span><span class="function">SetEmptySelection</span><span class="symbol">(</span><span class="normal">pos</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="type">bool</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">CanPaste</span><span class="symbol">()</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">!</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">IsReadOnly</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">!</span><span class="function">SelectionContainsProtected</span><span class="symbol">();</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">Clear</span><span class="symbol">()</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">currentPos </span><span class="symbol">==</span><span class="normal"> anchor</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="function">RangeContainsProtected</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">,</span><span class="normal"> currentPos </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="function">DelChar</span><span class="symbol">();</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">ClearSelection</span><span class="symbol">();</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="function">SetEmptySelection</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">SelectAll</span><span class="symbol">()</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="function">SetSelection</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">,</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">Length</span><span class="symbol">());</span>
<span class="normal">	</span><span class="function">Redraw</span><span class="symbol">();</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">Undo</span><span class="symbol">()</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">CanUndo</span><span class="symbol">())</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">InvalidateCaret</span><span class="symbol">();</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> newPos </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">Undo</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">newPos </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">			</span><span class="function">SetEmptySelection</span><span class="symbol">(</span><span class="normal">newPos</span><span class="symbol">);</span>
<span class="normal">		</span><span class="function">EnsureCaretVisible</span><span class="symbol">();</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">Redo</span><span class="symbol">()</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">CanRedo</span><span class="symbol">())</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> newPos </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">Redo</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">newPos </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">			</span><span class="function">SetEmptySelection</span><span class="symbol">(</span><span class="normal">newPos</span><span class="symbol">);</span>
<span class="normal">		</span><span class="function">EnsureCaretVisible</span><span class="symbol">();</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">DelChar</span><span class="symbol">()</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="function">RangeContainsProtected</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">,</span><span class="normal"> currentPos </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		pdoc</span><span class="symbol">-&gt;</span><span class="function">DelChar</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="comment">// Avoid blinking during rapid typing:</span>
<span class="normal">	</span><span class="function">ShowCaretAtCurrentPosition</span><span class="symbol">();</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">DelCharBack</span><span class="symbol">(</span><span class="type">bool</span><span class="normal"> allowLineStartDeletion</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">currentPos </span><span class="symbol">==</span><span class="normal"> anchor</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="function">RangeContainsProtected</span><span class="symbol">(</span><span class="normal">currentPos </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span><span class="normal"> currentPos</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> lineCurrentPos </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineFromPosition</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">);</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">allowLineStartDeletion </span><span class="symbol">||</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">lineCurrentPos</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> currentPos</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">GetColumn</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&lt;=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">GetLineIndentation</span><span class="symbol">(</span><span class="normal">lineCurrentPos</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span>
<span class="normal">				        pdoc</span><span class="symbol">-&gt;</span><span class="function">GetColumn</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">0</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="normal">backspaceUnindents</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					pdoc</span><span class="symbol">-&gt;</span><span class="function">BeginUndoAction</span><span class="symbol">();</span>
<span class="normal">					</span><span class="type">int</span><span class="normal"> indentation </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">GetLineIndentation</span><span class="symbol">(</span><span class="normal">lineCurrentPos</span><span class="symbol">);</span>
<span class="normal">					</span><span class="type">int</span><span class="normal"> indentationStep </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">IndentSize</span><span class="symbol">();</span>
<span class="normal">					</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">indentation </span><span class="symbol">%</span><span class="normal"> indentationStep </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">						pdoc</span><span class="symbol">-&gt;</span><span class="function">SetLineIndentation</span><span class="symbol">(</span><span class="normal">lineCurrentPos</span><span class="symbol">,</span><span class="normal"> indentation </span><span class="symbol">-</span><span class="normal"> indentationStep</span><span class="symbol">);</span>
<span class="normal">					</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">						pdoc</span><span class="symbol">-&gt;</span><span class="function">SetLineIndentation</span><span class="symbol">(</span><span class="normal">lineCurrentPos</span><span class="symbol">,</span><span class="normal"> indentation </span><span class="symbol">-</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">indentation </span><span class="symbol">%</span><span class="normal"> indentationStep</span><span class="symbol">));</span>
<span class="normal">					</span><span class="cbracket">}</span>
<span class="normal">					</span><span class="function">SetEmptySelection</span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">GetLineIndentPosition</span><span class="symbol">(</span><span class="normal">lineCurrentPos</span><span class="symbol">));</span>
<span class="normal">					pdoc</span><span class="symbol">-&gt;</span><span class="function">EndUndoAction</span><span class="symbol">();</span>
<span class="normal">				</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					pdoc</span><span class="symbol">-&gt;</span><span class="function">DelCharBack</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">);</span>
<span class="normal">				</span><span class="cbracket">}</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">ClearSelection</span><span class="symbol">();</span>
<span class="normal">		</span><span class="function">SetEmptySelection</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="comment">// Avoid blinking during rapid typing:</span>
<span class="normal">	</span><span class="function">ShowCaretAtCurrentPosition</span><span class="symbol">();</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">NotifyFocus</span><span class="symbol">(</span><span class="type">bool</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">NotifyStyleToNeeded</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> endStyleNeeded</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="usertype">SCNotification</span><span class="normal"> scn </span><span class="symbol">=</span><span class="normal"> </span><span class="cbracket">{</span><span class="number">0</span><span class="cbracket">}</span><span class="symbol">;</span>
<span class="normal">	scn</span><span class="symbol">.</span><span class="normal">nmhdr</span><span class="symbol">.</span><span class="normal">code </span><span class="symbol">=</span><span class="normal"> SCN_STYLENEEDED</span><span class="symbol">;</span>
<span class="normal">	scn</span><span class="symbol">.</span><span class="normal">position </span><span class="symbol">=</span><span class="normal"> endStyleNeeded</span><span class="symbol">;</span>
<span class="normal">	</span><span class="function">NotifyParent</span><span class="symbol">(</span><span class="normal">scn</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">NotifyStyleNeeded</span><span class="symbol">(</span><span class="normal">Document</span><span class="symbol">*,</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="symbol">*,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> endStyleNeeded</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="function">NotifyStyleToNeeded</span><span class="symbol">(</span><span class="normal">endStyleNeeded</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">NotifyChar</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> ch</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="usertype">SCNotification</span><span class="normal"> scn </span><span class="symbol">=</span><span class="normal"> </span><span class="cbracket">{</span><span class="number">0</span><span class="cbracket">}</span><span class="symbol">;</span>
<span class="normal">	scn</span><span class="symbol">.</span><span class="normal">nmhdr</span><span class="symbol">.</span><span class="normal">code </span><span class="symbol">=</span><span class="normal"> SCN_CHARADDED</span><span class="symbol">;</span>
<span class="normal">	scn</span><span class="symbol">.</span><span class="normal">ch </span><span class="symbol">=</span><span class="normal"> ch</span><span class="symbol">;</span>
<span class="normal">	</span><span class="function">NotifyParent</span><span class="symbol">(</span><span class="normal">scn</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">recordingMacro</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="type">char</span><span class="normal"> txt</span><span class="symbol">[</span><span class="number">2</span><span class="symbol">];</span>
<span class="normal">		txt</span><span class="symbol">[</span><span class="number">0</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">static_cast</span><span class="symbol">&lt;</span><span class="type">char</span><span class="symbol">&gt;(</span><span class="normal">ch</span><span class="symbol">);</span>
<span class="normal">		txt</span><span class="symbol">[</span><span class="number">1</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="string">'</span><span class="specialchar">\0</span><span class="string">'</span><span class="symbol">;</span>
<span class="normal">		</span><span class="function">NotifyMacroRecord</span><span class="symbol">(</span><span class="normal">SCI_REPLACESEL</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">reinterpret_cast</span><span class="symbol">&lt;</span><span class="normal">sptr_t</span><span class="symbol">&gt;(</span><span class="normal">txt</span><span class="symbol">));</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">NotifySavePoint</span><span class="symbol">(</span><span class="type">bool</span><span class="normal"> isSavePoint</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="usertype">SCNotification</span><span class="normal"> scn </span><span class="symbol">=</span><span class="normal"> </span><span class="cbracket">{</span><span class="number">0</span><span class="cbracket">}</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">isSavePoint</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		scn</span><span class="symbol">.</span><span class="normal">nmhdr</span><span class="symbol">.</span><span class="normal">code </span><span class="symbol">=</span><span class="normal"> SCN_SAVEPOINTREACHED</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		scn</span><span class="symbol">.</span><span class="normal">nmhdr</span><span class="symbol">.</span><span class="normal">code </span><span class="symbol">=</span><span class="normal"> SCN_SAVEPOINTLEFT</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="function">NotifyParent</span><span class="symbol">(</span><span class="normal">scn</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">NotifyModifyAttempt</span><span class="symbol">()</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="usertype">SCNotification</span><span class="normal"> scn </span><span class="symbol">=</span><span class="normal"> </span><span class="cbracket">{</span><span class="number">0</span><span class="cbracket">}</span><span class="symbol">;</span>
<span class="normal">	scn</span><span class="symbol">.</span><span class="normal">nmhdr</span><span class="symbol">.</span><span class="normal">code </span><span class="symbol">=</span><span class="normal"> SCN_MODIFYATTEMPTRO</span><span class="symbol">;</span>
<span class="normal">	</span><span class="function">NotifyParent</span><span class="symbol">(</span><span class="normal">scn</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">NotifyDoubleClick</span><span class="symbol">(</span><span class="usertype">Point</span><span class="normal"> pt</span><span class="symbol">,</span><span class="normal"> </span><span class="type">bool</span><span class="normal"> shift</span><span class="symbol">,</span><span class="normal"> </span><span class="type">bool</span><span class="normal"> ctrl</span><span class="symbol">,</span><span class="normal"> </span><span class="type">bool</span><span class="normal"> alt</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="usertype">SCNotification</span><span class="normal"> scn </span><span class="symbol">=</span><span class="normal"> </span><span class="cbracket">{</span><span class="number">0</span><span class="cbracket">}</span><span class="symbol">;</span>
<span class="normal">	scn</span><span class="symbol">.</span><span class="normal">nmhdr</span><span class="symbol">.</span><span class="normal">code </span><span class="symbol">=</span><span class="normal"> SCN_DOUBLECLICK</span><span class="symbol">;</span>
<span class="normal">	scn</span><span class="symbol">.</span><span class="normal">line </span><span class="symbol">=</span><span class="normal"> </span><span class="function">LineFromLocation</span><span class="symbol">(</span><span class="normal">pt</span><span class="symbol">);</span>
<span class="normal">	scn</span><span class="symbol">.</span><span class="normal">position </span><span class="symbol">=</span><span class="normal"> </span><span class="function">PositionFromLocation</span><span class="symbol">(</span><span class="normal">pt</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">);</span>
<span class="normal">	scn</span><span class="symbol">.</span><span class="normal">modifiers </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">shift </span><span class="symbol">?</span><span class="normal"> SCI_SHIFT </span><span class="symbol">:</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">|</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ctrl </span><span class="symbol">?</span><span class="normal"> SCI_CTRL </span><span class="symbol">:</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">|</span>
<span class="normal">	        </span><span class="symbol">(</span><span class="normal">alt </span><span class="symbol">?</span><span class="normal"> SCI_ALT </span><span class="symbol">:</span><span class="normal"> </span><span class="number">0</span><span class="symbol">);</span>
<span class="normal">	</span><span class="function">NotifyParent</span><span class="symbol">(</span><span class="normal">scn</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">NotifyHotSpotDoubleClicked</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> position</span><span class="symbol">,</span><span class="normal"> </span><span class="type">bool</span><span class="normal"> shift</span><span class="symbol">,</span><span class="normal"> </span><span class="type">bool</span><span class="normal"> ctrl</span><span class="symbol">,</span><span class="normal"> </span><span class="type">bool</span><span class="normal"> alt</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="usertype">SCNotification</span><span class="normal"> scn </span><span class="symbol">=</span><span class="normal"> </span><span class="cbracket">{</span><span class="number">0</span><span class="cbracket">}</span><span class="symbol">;</span>
<span class="normal">	scn</span><span class="symbol">.</span><span class="normal">nmhdr</span><span class="symbol">.</span><span class="normal">code </span><span class="symbol">=</span><span class="normal"> SCN_HOTSPOTDOUBLECLICK</span><span class="symbol">;</span>
<span class="normal">	scn</span><span class="symbol">.</span><span class="normal">position </span><span class="symbol">=</span><span class="normal"> position</span><span class="symbol">;</span>
<span class="normal">	scn</span><span class="symbol">.</span><span class="normal">modifiers </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">shift </span><span class="symbol">?</span><span class="normal"> SCI_SHIFT </span><span class="symbol">:</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">|</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ctrl </span><span class="symbol">?</span><span class="normal"> SCI_CTRL </span><span class="symbol">:</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">|</span>
<span class="normal">	        </span><span class="symbol">(</span><span class="normal">alt </span><span class="symbol">?</span><span class="normal"> SCI_ALT </span><span class="symbol">:</span><span class="normal"> </span><span class="number">0</span><span class="symbol">);</span>
<span class="normal">	</span><span class="function">NotifyParent</span><span class="symbol">(</span><span class="normal">scn</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">NotifyHotSpotClicked</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> position</span><span class="symbol">,</span><span class="normal"> </span><span class="type">bool</span><span class="normal"> shift</span><span class="symbol">,</span><span class="normal"> </span><span class="type">bool</span><span class="normal"> ctrl</span><span class="symbol">,</span><span class="normal"> </span><span class="type">bool</span><span class="normal"> alt</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="usertype">SCNotification</span><span class="normal"> scn </span><span class="symbol">=</span><span class="normal"> </span><span class="cbracket">{</span><span class="number">0</span><span class="cbracket">}</span><span class="symbol">;</span>
<span class="normal">	scn</span><span class="symbol">.</span><span class="normal">nmhdr</span><span class="symbol">.</span><span class="normal">code </span><span class="symbol">=</span><span class="normal"> SCN_HOTSPOTCLICK</span><span class="symbol">;</span>
<span class="normal">	scn</span><span class="symbol">.</span><span class="normal">position </span><span class="symbol">=</span><span class="normal"> position</span><span class="symbol">;</span>
<span class="normal">	scn</span><span class="symbol">.</span><span class="normal">modifiers </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">shift </span><span class="symbol">?</span><span class="normal"> SCI_SHIFT </span><span class="symbol">:</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">|</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ctrl </span><span class="symbol">?</span><span class="normal"> SCI_CTRL </span><span class="symbol">:</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">|</span>
<span class="normal">	        </span><span class="symbol">(</span><span class="normal">alt </span><span class="symbol">?</span><span class="normal"> SCI_ALT </span><span class="symbol">:</span><span class="normal"> </span><span class="number">0</span><span class="symbol">);</span>
<span class="normal">	</span><span class="function">NotifyParent</span><span class="symbol">(</span><span class="normal">scn</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">NotifyUpdateUI</span><span class="symbol">()</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="usertype">SCNotification</span><span class="normal"> scn </span><span class="symbol">=</span><span class="normal"> </span><span class="cbracket">{</span><span class="number">0</span><span class="cbracket">}</span><span class="symbol">;</span>
<span class="normal">	scn</span><span class="symbol">.</span><span class="normal">nmhdr</span><span class="symbol">.</span><span class="normal">code </span><span class="symbol">=</span><span class="normal"> SCN_UPDATEUI</span><span class="symbol">;</span>
<span class="normal">	</span><span class="function">NotifyParent</span><span class="symbol">(</span><span class="normal">scn</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">NotifyPainted</span><span class="symbol">()</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="usertype">SCNotification</span><span class="normal"> scn </span><span class="symbol">=</span><span class="normal"> </span><span class="cbracket">{</span><span class="number">0</span><span class="cbracket">}</span><span class="symbol">;</span>
<span class="normal">	scn</span><span class="symbol">.</span><span class="normal">nmhdr</span><span class="symbol">.</span><span class="normal">code </span><span class="symbol">=</span><span class="normal"> SCN_PAINTED</span><span class="symbol">;</span>
<span class="normal">	</span><span class="function">NotifyParent</span><span class="symbol">(</span><span class="normal">scn</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">NotifyIndicatorClick</span><span class="symbol">(</span><span class="type">bool</span><span class="normal"> click</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> position</span><span class="symbol">,</span><span class="normal"> </span><span class="type">bool</span><span class="normal"> shift</span><span class="symbol">,</span><span class="normal"> </span><span class="type">bool</span><span class="normal"> ctrl</span><span class="symbol">,</span><span class="normal"> </span><span class="type">bool</span><span class="normal"> alt</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> mask </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="normal">decorations</span><span class="symbol">.</span><span class="function">AllOnFor</span><span class="symbol">(</span><span class="normal">position</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">click </span><span class="symbol">&amp;&amp;</span><span class="normal"> mask</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="normal">decorations</span><span class="symbol">.</span><span class="normal">clickNotified</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="usertype">SCNotification</span><span class="normal"> scn </span><span class="symbol">=</span><span class="normal"> </span><span class="cbracket">{</span><span class="number">0</span><span class="cbracket">}</span><span class="symbol">;</span>
<span class="normal">		pdoc</span><span class="symbol">-&gt;</span><span class="normal">decorations</span><span class="symbol">.</span><span class="normal">clickNotified </span><span class="symbol">=</span><span class="normal"> click</span><span class="symbol">;</span>
<span class="normal">		scn</span><span class="symbol">.</span><span class="normal">nmhdr</span><span class="symbol">.</span><span class="normal">code </span><span class="symbol">=</span><span class="normal"> click </span><span class="symbol">?</span><span class="normal"> SCN_INDICATORCLICK </span><span class="symbol">:</span><span class="normal"> SCN_INDICATORRELEASE</span><span class="symbol">;</span>
<span class="normal">		scn</span><span class="symbol">.</span><span class="normal">modifiers </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">shift </span><span class="symbol">?</span><span class="normal"> SCI_SHIFT </span><span class="symbol">:</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">|</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ctrl </span><span class="symbol">?</span><span class="normal"> SCI_CTRL </span><span class="symbol">:</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">|</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">alt </span><span class="symbol">?</span><span class="normal"> SCI_ALT </span><span class="symbol">:</span><span class="normal"> </span><span class="number">0</span><span class="symbol">);</span>
<span class="normal">		scn</span><span class="symbol">.</span><span class="normal">position </span><span class="symbol">=</span><span class="normal"> position</span><span class="symbol">;</span>
<span class="normal">		</span><span class="function">NotifyParent</span><span class="symbol">(</span><span class="normal">scn</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="type">bool</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">NotifyMarginClick</span><span class="symbol">(</span><span class="usertype">Point</span><span class="normal"> pt</span><span class="symbol">,</span><span class="normal"> </span><span class="type">bool</span><span class="normal"> shift</span><span class="symbol">,</span><span class="normal"> </span><span class="type">bool</span><span class="normal"> ctrl</span><span class="symbol">,</span><span class="normal"> </span><span class="type">bool</span><span class="normal"> alt</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> marginClicked </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> x </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="normal"> margin </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> margin </span><span class="symbol">&lt;</span><span class="normal"> ViewStyle</span><span class="symbol">::</span><span class="normal">margins</span><span class="symbol">;</span><span class="normal"> margin</span><span class="symbol">++)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">pt</span><span class="symbol">.</span><span class="normal">x </span><span class="symbol">&gt;</span><span class="normal"> x</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pt</span><span class="symbol">.</span><span class="normal">x </span><span class="symbol">&lt;</span><span class="normal"> x </span><span class="symbol">+</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">ms</span><span class="symbol">[</span><span class="normal">margin</span><span class="symbol">].</span><span class="normal">width</span><span class="symbol">))</span>
<span class="normal">			marginClicked </span><span class="symbol">=</span><span class="normal"> margin</span><span class="symbol">;</span>
<span class="normal">		x </span><span class="symbol">+=</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">ms</span><span class="symbol">[</span><span class="normal">margin</span><span class="symbol">].</span><span class="normal">width</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">marginClicked </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">ms</span><span class="symbol">[</span><span class="normal">marginClicked</span><span class="symbol">].</span><span class="normal">sensitive</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="usertype">SCNotification</span><span class="normal"> scn </span><span class="symbol">=</span><span class="normal"> </span><span class="cbracket">{</span><span class="number">0</span><span class="cbracket">}</span><span class="symbol">;</span>
<span class="normal">		scn</span><span class="symbol">.</span><span class="normal">nmhdr</span><span class="symbol">.</span><span class="normal">code </span><span class="symbol">=</span><span class="normal"> SCN_MARGINCLICK</span><span class="symbol">;</span>
<span class="normal">		scn</span><span class="symbol">.</span><span class="normal">modifiers </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">shift </span><span class="symbol">?</span><span class="normal"> SCI_SHIFT </span><span class="symbol">:</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">|</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ctrl </span><span class="symbol">?</span><span class="normal"> SCI_CTRL </span><span class="symbol">:</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">|</span>
<span class="normal">		        </span><span class="symbol">(</span><span class="normal">alt </span><span class="symbol">?</span><span class="normal"> SCI_ALT </span><span class="symbol">:</span><span class="normal"> </span><span class="number">0</span><span class="symbol">);</span>
<span class="normal">		scn</span><span class="symbol">.</span><span class="normal">position </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="function">LineFromLocation</span><span class="symbol">(</span><span class="normal">pt</span><span class="symbol">));</span>
<span class="normal">		scn</span><span class="symbol">.</span><span class="normal">margin </span><span class="symbol">=</span><span class="normal"> marginClicked</span><span class="symbol">;</span>
<span class="normal">		</span><span class="function">NotifyParent</span><span class="symbol">(</span><span class="normal">scn</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">NotifyNeedShown</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> pos</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> len</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="usertype">SCNotification</span><span class="normal"> scn </span><span class="symbol">=</span><span class="normal"> </span><span class="cbracket">{</span><span class="number">0</span><span class="cbracket">}</span><span class="symbol">;</span>
<span class="normal">	scn</span><span class="symbol">.</span><span class="normal">nmhdr</span><span class="symbol">.</span><span class="normal">code </span><span class="symbol">=</span><span class="normal"> SCN_NEEDSHOWN</span><span class="symbol">;</span>
<span class="normal">	scn</span><span class="symbol">.</span><span class="normal">position </span><span class="symbol">=</span><span class="normal"> pos</span><span class="symbol">;</span>
<span class="normal">	scn</span><span class="symbol">.</span><span class="normal">length </span><span class="symbol">=</span><span class="normal"> len</span><span class="symbol">;</span>
<span class="normal">	</span><span class="function">NotifyParent</span><span class="symbol">(</span><span class="normal">scn</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">NotifyDwelling</span><span class="symbol">(</span><span class="usertype">Point</span><span class="normal"> pt</span><span class="symbol">,</span><span class="normal"> </span><span class="type">bool</span><span class="normal"> state</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="usertype">SCNotification</span><span class="normal"> scn </span><span class="symbol">=</span><span class="normal"> </span><span class="cbracket">{</span><span class="number">0</span><span class="cbracket">}</span><span class="symbol">;</span>
<span class="normal">	scn</span><span class="symbol">.</span><span class="normal">nmhdr</span><span class="symbol">.</span><span class="normal">code </span><span class="symbol">=</span><span class="normal"> state </span><span class="symbol">?</span><span class="normal"> SCN_DWELLSTART </span><span class="symbol">:</span><span class="normal"> SCN_DWELLEND</span><span class="symbol">;</span>
<span class="normal">	scn</span><span class="symbol">.</span><span class="normal">position </span><span class="symbol">=</span><span class="normal"> </span><span class="function">PositionFromLocation</span><span class="symbol">(</span><span class="normal">pt</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">);</span>
<span class="normal">	scn</span><span class="symbol">.</span><span class="normal">x </span><span class="symbol">=</span><span class="normal"> pt</span><span class="symbol">.</span><span class="normal">x</span><span class="symbol">;</span>
<span class="normal">	scn</span><span class="symbol">.</span><span class="normal">y </span><span class="symbol">=</span><span class="normal"> pt</span><span class="symbol">.</span><span class="normal">y</span><span class="symbol">;</span>
<span class="normal">	</span><span class="function">NotifyParent</span><span class="symbol">(</span><span class="normal">scn</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">NotifyZoom</span><span class="symbol">()</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="usertype">SCNotification</span><span class="normal"> scn </span><span class="symbol">=</span><span class="normal"> </span><span class="cbracket">{</span><span class="number">0</span><span class="cbracket">}</span><span class="symbol">;</span>
<span class="normal">	scn</span><span class="symbol">.</span><span class="normal">nmhdr</span><span class="symbol">.</span><span class="normal">code </span><span class="symbol">=</span><span class="normal"> SCN_ZOOM</span><span class="symbol">;</span>
<span class="normal">	</span><span class="function">NotifyParent</span><span class="symbol">(</span><span class="normal">scn</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="comment">// Notifications from document</span>
<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">NotifyModifyAttempt</span><span class="symbol">(</span><span class="normal">Document</span><span class="symbol">*,</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="symbol">*)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="comment">//Platform::DebugPrintf("** Modify Attempt\n");</span>
<span class="normal">	</span><span class="function">NotifyModifyAttempt</span><span class="symbol">();</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">NotifySavePoint</span><span class="symbol">(</span><span class="normal">Document</span><span class="symbol">*,</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="symbol">*,</span><span class="normal"> </span><span class="type">bool</span><span class="normal"> atSavePoint</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="comment">//Platform::DebugPrintf("** Save Point %s\n", atSavePoint ? "On" : "Off");</span>
<span class="normal">	</span><span class="function">NotifySavePoint</span><span class="symbol">(</span><span class="normal">atSavePoint</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">CheckModificationForWrap</span><span class="symbol">(</span><span class="usertype">DocModification</span><span class="normal"> mh</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">mh</span><span class="symbol">.</span><span class="normal">modificationType </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">SC_MOD_INSERTTEXT </span><span class="symbol">|</span><span class="normal"> SC_MOD_DELETETEXT</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		llc</span><span class="symbol">.</span><span class="function">Invalidate</span><span class="symbol">(</span><span class="normal">LineLayout</span><span class="symbol">::</span><span class="normal">llCheckTextAndStyle</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">wrapState </span><span class="symbol">!=</span><span class="normal"> eWrapNone</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> lineDoc </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineFromPosition</span><span class="symbol">(</span><span class="normal">mh</span><span class="symbol">.</span><span class="normal">position</span><span class="symbol">);</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> lines </span><span class="symbol">=</span><span class="normal"> Platform</span><span class="symbol">::</span><span class="function">Maximum</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">,</span><span class="normal"> mh</span><span class="symbol">.</span><span class="normal">linesAdded</span><span class="symbol">);</span>
<span class="normal">			</span><span class="function">NeedWrapping</span><span class="symbol">(</span><span class="normal">lineDoc</span><span class="symbol">,</span><span class="normal"> lineDoc </span><span class="symbol">+</span><span class="normal"> lines </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="comment">// Fix up annotation heights</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> lineDoc </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineFromPosition</span><span class="symbol">(</span><span class="normal">mh</span><span class="symbol">.</span><span class="normal">position</span><span class="symbol">);</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> lines </span><span class="symbol">=</span><span class="normal"> Platform</span><span class="symbol">::</span><span class="function">Maximum</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">,</span><span class="normal"> mh</span><span class="symbol">.</span><span class="normal">linesAdded</span><span class="symbol">);</span>
<span class="normal">		</span><span class="function">SetAnnotationHeights</span><span class="symbol">(</span><span class="normal">lineDoc</span><span class="symbol">,</span><span class="normal"> lineDoc </span><span class="symbol">+</span><span class="normal"> lines </span><span class="symbol">+</span><span class="normal"> </span><span class="number">2</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="comment">// Move a position so it is still after the same character as before the insertion.</span>
<span class="keyword">static</span><span class="normal"> </span><span class="keyword">inline</span><span class="normal"> </span><span class="type">int</span><span class="normal"> </span><span class="function">MovePositionForInsertion</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> position</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> startInsertion</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> length</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">position </span><span class="symbol">&gt;</span><span class="normal"> startInsertion</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> position </span><span class="symbol">+</span><span class="normal"> length</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> position</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="comment">// Move a position so it is still after the same character as before the deletion if that</span>
<span class="comment">// character is still present else after the previous surviving character.</span>
<span class="keyword">static</span><span class="normal"> </span><span class="keyword">inline</span><span class="normal"> </span><span class="type">int</span><span class="normal"> </span><span class="function">MovePositionForDeletion</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> position</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> startDeletion</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> length</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">position </span><span class="symbol">&gt;</span><span class="normal"> startDeletion</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> endDeletion </span><span class="symbol">=</span><span class="normal"> startDeletion </span><span class="symbol">+</span><span class="normal"> length</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">position </span><span class="symbol">&gt;</span><span class="normal"> endDeletion</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> position </span><span class="symbol">-</span><span class="normal"> length</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> startDeletion</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> position</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">NotifyModified</span><span class="symbol">(</span><span class="normal">Document</span><span class="symbol">*,</span><span class="normal"> </span><span class="usertype">DocModification</span><span class="normal"> mh</span><span class="symbol">,</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="symbol">*)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	needUpdateUI </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">paintState </span><span class="symbol">==</span><span class="normal"> painting</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">CheckForChangeOutsidePaint</span><span class="symbol">(</span><span class="function">Range</span><span class="symbol">(</span><span class="normal">mh</span><span class="symbol">.</span><span class="normal">position</span><span class="symbol">,</span><span class="normal"> mh</span><span class="symbol">.</span><span class="normal">position </span><span class="symbol">+</span><span class="normal"> mh</span><span class="symbol">.</span><span class="normal">length</span><span class="symbol">));</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">mh</span><span class="symbol">.</span><span class="normal">modificationType </span><span class="symbol">&amp;</span><span class="normal"> SC_MOD_CHANGELINESTATE</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">paintState </span><span class="symbol">==</span><span class="normal"> painting</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="function">CheckForChangeOutsidePaint</span><span class="symbol">(</span>
<span class="normal">			    </span><span class="function">Range</span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">mh</span><span class="symbol">.</span><span class="normal">line</span><span class="symbol">),</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">mh</span><span class="symbol">.</span><span class="normal">line </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)));</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="comment">// Could check that change is before last visible line.</span>
<span class="normal">			</span><span class="function">Redraw</span><span class="symbol">();</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">mh</span><span class="symbol">.</span><span class="normal">modificationType </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">SC_MOD_CHANGESTYLE </span><span class="symbol">|</span><span class="normal"> SC_MOD_CHANGEINDICATOR</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">mh</span><span class="symbol">.</span><span class="normal">modificationType </span><span class="symbol">&amp;</span><span class="normal"> SC_MOD_CHANGESTYLE</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			pdoc</span><span class="symbol">-&gt;</span><span class="function">IncrementStyleClock</span><span class="symbol">();</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">paintState </span><span class="symbol">==</span><span class="normal"> notPainting</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">mh</span><span class="symbol">.</span><span class="normal">position </span><span class="symbol">&lt;</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">topLine</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="comment">// Styling performed before this view</span>
<span class="normal">				</span><span class="function">Redraw</span><span class="symbol">();</span>
<span class="normal">			</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="function">InvalidateRange</span><span class="symbol">(</span><span class="normal">mh</span><span class="symbol">.</span><span class="normal">position</span><span class="symbol">,</span><span class="normal"> mh</span><span class="symbol">.</span><span class="normal">position </span><span class="symbol">+</span><span class="normal"> mh</span><span class="symbol">.</span><span class="normal">length</span><span class="symbol">);</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">mh</span><span class="symbol">.</span><span class="normal">modificationType </span><span class="symbol">&amp;</span><span class="normal"> SC_MOD_CHANGESTYLE</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			llc</span><span class="symbol">.</span><span class="function">Invalidate</span><span class="symbol">(</span><span class="normal">LineLayout</span><span class="symbol">::</span><span class="normal">llCheckTextAndStyle</span><span class="symbol">);</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="comment">// Move selection and brace highlights</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">mh</span><span class="symbol">.</span><span class="normal">modificationType </span><span class="symbol">&amp;</span><span class="normal"> SC_MOD_INSERTTEXT</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			currentPos </span><span class="symbol">=</span><span class="normal"> </span><span class="function">MovePositionForInsertion</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">,</span><span class="normal"> mh</span><span class="symbol">.</span><span class="normal">position</span><span class="symbol">,</span><span class="normal"> mh</span><span class="symbol">.</span><span class="normal">length</span><span class="symbol">);</span>
<span class="normal">			anchor </span><span class="symbol">=</span><span class="normal"> </span><span class="function">MovePositionForInsertion</span><span class="symbol">(</span><span class="normal">anchor</span><span class="symbol">,</span><span class="normal"> mh</span><span class="symbol">.</span><span class="normal">position</span><span class="symbol">,</span><span class="normal"> mh</span><span class="symbol">.</span><span class="normal">length</span><span class="symbol">);</span>
<span class="normal">			braces</span><span class="symbol">[</span><span class="number">0</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="function">MovePositionForInsertion</span><span class="symbol">(</span><span class="normal">braces</span><span class="symbol">[</span><span class="number">0</span><span class="symbol">],</span><span class="normal"> mh</span><span class="symbol">.</span><span class="normal">position</span><span class="symbol">,</span><span class="normal"> mh</span><span class="symbol">.</span><span class="normal">length</span><span class="symbol">);</span>
<span class="normal">			braces</span><span class="symbol">[</span><span class="number">1</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="function">MovePositionForInsertion</span><span class="symbol">(</span><span class="normal">braces</span><span class="symbol">[</span><span class="number">1</span><span class="symbol">],</span><span class="normal"> mh</span><span class="symbol">.</span><span class="normal">position</span><span class="symbol">,</span><span class="normal"> mh</span><span class="symbol">.</span><span class="normal">length</span><span class="symbol">);</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">mh</span><span class="symbol">.</span><span class="normal">modificationType </span><span class="symbol">&amp;</span><span class="normal"> SC_MOD_DELETETEXT</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			currentPos </span><span class="symbol">=</span><span class="normal"> </span><span class="function">MovePositionForDeletion</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">,</span><span class="normal"> mh</span><span class="symbol">.</span><span class="normal">position</span><span class="symbol">,</span><span class="normal"> mh</span><span class="symbol">.</span><span class="normal">length</span><span class="symbol">);</span>
<span class="normal">			anchor </span><span class="symbol">=</span><span class="normal"> </span><span class="function">MovePositionForDeletion</span><span class="symbol">(</span><span class="normal">anchor</span><span class="symbol">,</span><span class="normal"> mh</span><span class="symbol">.</span><span class="normal">position</span><span class="symbol">,</span><span class="normal"> mh</span><span class="symbol">.</span><span class="normal">length</span><span class="symbol">);</span>
<span class="normal">			braces</span><span class="symbol">[</span><span class="number">0</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="function">MovePositionForDeletion</span><span class="symbol">(</span><span class="normal">braces</span><span class="symbol">[</span><span class="number">0</span><span class="symbol">],</span><span class="normal"> mh</span><span class="symbol">.</span><span class="normal">position</span><span class="symbol">,</span><span class="normal"> mh</span><span class="symbol">.</span><span class="normal">length</span><span class="symbol">);</span>
<span class="normal">			braces</span><span class="symbol">[</span><span class="number">1</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="function">MovePositionForDeletion</span><span class="symbol">(</span><span class="normal">braces</span><span class="symbol">[</span><span class="number">1</span><span class="symbol">],</span><span class="normal"> mh</span><span class="symbol">.</span><span class="normal">position</span><span class="symbol">,</span><span class="normal"> mh</span><span class="symbol">.</span><span class="normal">length</span><span class="symbol">);</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">cs</span><span class="symbol">.</span><span class="function">LinesDisplayed</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">&lt;</span><span class="normal"> cs</span><span class="symbol">.</span><span class="function">LinesInDoc</span><span class="symbol">())</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="comment">// Some lines are hidden so may need shown.</span>
<span class="normal">			</span><span class="comment">// TODO: check if the modified area is hidden.</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">mh</span><span class="symbol">.</span><span class="normal">modificationType </span><span class="symbol">&amp;</span><span class="normal"> SC_MOD_BEFOREINSERT</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="function">NotifyNeedShown</span><span class="symbol">(</span><span class="normal">mh</span><span class="symbol">.</span><span class="normal">position</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">);</span>
<span class="normal">			</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">mh</span><span class="symbol">.</span><span class="normal">modificationType </span><span class="symbol">&amp;</span><span class="normal"> SC_MOD_BEFOREDELETE</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="function">NotifyNeedShown</span><span class="symbol">(</span><span class="normal">mh</span><span class="symbol">.</span><span class="normal">position</span><span class="symbol">,</span><span class="normal"> mh</span><span class="symbol">.</span><span class="normal">length</span><span class="symbol">);</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">mh</span><span class="symbol">.</span><span class="normal">linesAdded </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="comment">// Update contraction state for inserted and removed lines</span>
<span class="normal">			</span><span class="comment">// lineOfPos should be calculated in context of state before modification, shouldn't it</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> lineOfPos </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineFromPosition</span><span class="symbol">(</span><span class="normal">mh</span><span class="symbol">.</span><span class="normal">position</span><span class="symbol">);</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">mh</span><span class="symbol">.</span><span class="normal">linesAdded </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				cs</span><span class="symbol">.</span><span class="function">InsertLines</span><span class="symbol">(</span><span class="normal">lineOfPos</span><span class="symbol">,</span><span class="normal"> mh</span><span class="symbol">.</span><span class="normal">linesAdded</span><span class="symbol">);</span>
<span class="normal">			</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				cs</span><span class="symbol">.</span><span class="function">DeleteLines</span><span class="symbol">(</span><span class="normal">lineOfPos</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">-</span><span class="normal">mh</span><span class="symbol">.</span><span class="normal">linesAdded</span><span class="symbol">);</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">mh</span><span class="symbol">.</span><span class="normal">modificationType </span><span class="symbol">&amp;</span><span class="normal"> SC_MOD_CHANGEANNOTATION</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> lineDoc </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineFromPosition</span><span class="symbol">(</span><span class="normal">mh</span><span class="symbol">.</span><span class="normal">position</span><span class="symbol">);</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vs</span><span class="symbol">.</span><span class="normal">annotationVisible</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				cs</span><span class="symbol">.</span><span class="function">SetHeight</span><span class="symbol">(</span><span class="normal">lineDoc</span><span class="symbol">,</span><span class="normal"> cs</span><span class="symbol">.</span><span class="function">GetHeight</span><span class="symbol">(</span><span class="normal">lineDoc</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> mh</span><span class="symbol">.</span><span class="normal">annotationLinesAdded</span><span class="symbol">);</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="function">CheckModificationForWrap</span><span class="symbol">(</span><span class="normal">mh</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">mh</span><span class="symbol">.</span><span class="normal">linesAdded </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="comment">// Avoid scrolling of display if change before current display</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">mh</span><span class="symbol">.</span><span class="normal">position </span><span class="symbol">&lt;</span><span class="normal"> posTopLine </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">!</span><span class="function">CanDeferToLastStep</span><span class="symbol">(</span><span class="normal">mh</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="type">int</span><span class="normal"> newTop </span><span class="symbol">=</span><span class="normal"> Platform</span><span class="symbol">::</span><span class="function">Clamp</span><span class="symbol">(</span><span class="normal">topLine </span><span class="symbol">+</span><span class="normal"> mh</span><span class="symbol">.</span><span class="normal">linesAdded</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="function">MaxScrollPos</span><span class="symbol">());</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">newTop </span><span class="symbol">!=</span><span class="normal"> topLine</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="function">SetTopLine</span><span class="symbol">(</span><span class="normal">newTop</span><span class="symbol">);</span>
<span class="normal">					</span><span class="function">SetVerticalScrollPos</span><span class="symbol">();</span>
<span class="normal">				</span><span class="cbracket">}</span>
<span class="normal">			</span><span class="cbracket">}</span>

<span class="normal">			</span><span class="comment">//Platform::DebugPrintf("** %x Doc Changed\n", this);</span>
<span class="normal">			</span><span class="comment">// TODO: could invalidate from mh.startModification to end of screen</span>
<span class="normal">			</span><span class="comment">//InvalidateRange(mh.position, mh.position + mh.length);</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">paintState </span><span class="symbol">==</span><span class="normal"> notPainting </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">!</span><span class="function">CanDeferToLastStep</span><span class="symbol">(</span><span class="normal">mh</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="function">Redraw</span><span class="symbol">();</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="comment">//Platform::DebugPrintf("** %x Line Changed %d .. %d\n", this,</span>
<span class="normal">			</span><span class="comment">//	mh.position, mh.position + mh.length);</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">paintState </span><span class="symbol">==</span><span class="normal"> notPainting </span><span class="symbol">&amp;&amp;</span><span class="normal"> mh</span><span class="symbol">.</span><span class="normal">length </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">!</span><span class="function">CanEliminate</span><span class="symbol">(</span><span class="normal">mh</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="function">InvalidateRange</span><span class="symbol">(</span><span class="normal">mh</span><span class="symbol">.</span><span class="normal">position</span><span class="symbol">,</span><span class="normal"> mh</span><span class="symbol">.</span><span class="normal">position </span><span class="symbol">+</span><span class="normal"> mh</span><span class="symbol">.</span><span class="normal">length</span><span class="symbol">);</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">mh</span><span class="symbol">.</span><span class="normal">linesAdded </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">!</span><span class="function">CanDeferToLastStep</span><span class="symbol">(</span><span class="normal">mh</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">SetScrollBars</span><span class="symbol">();</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">mh</span><span class="symbol">.</span><span class="normal">modificationType </span><span class="symbol">&amp;</span><span class="normal"> SC_MOD_CHANGEMARKER</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">mh</span><span class="symbol">.</span><span class="normal">modificationType </span><span class="symbol">&amp;</span><span class="normal"> SC_MOD_CHANGEMARGIN</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">paintState </span><span class="symbol">==</span><span class="normal"> notPainting</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> </span><span class="symbol">!</span><span class="function">PaintContainsMargin</span><span class="symbol">())</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">mh</span><span class="symbol">.</span><span class="normal">modificationType </span><span class="symbol">&amp;</span><span class="normal"> SC_MOD_CHANGEFOLD</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="comment">// Fold changes can affect the drawing of following lines so redraw whole margin</span>
<span class="normal">				</span><span class="function">RedrawSelMargin</span><span class="symbol">();</span>
<span class="normal">			</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="function">RedrawSelMargin</span><span class="symbol">(</span><span class="normal">mh</span><span class="symbol">.</span><span class="normal">line</span><span class="symbol">);</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="comment">// NOW pay the piper WRT "deferred" visual updates</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">IsLastStep</span><span class="symbol">(</span><span class="normal">mh</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">SetScrollBars</span><span class="symbol">();</span>
<span class="normal">		</span><span class="function">Redraw</span><span class="symbol">();</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="comment">// If client wants to see this modification</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">mh</span><span class="symbol">.</span><span class="normal">modificationType </span><span class="symbol">&amp;</span><span class="normal"> modEventMask</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">mh</span><span class="symbol">.</span><span class="normal">modificationType </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">SC_MOD_CHANGESTYLE </span><span class="symbol">|</span><span class="normal"> SC_MOD_CHANGEINDICATOR</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="comment">// Real modification made to text of document.</span>
<span class="normal">			</span><span class="function">NotifyChange</span><span class="symbol">();</span><span class="normal">	</span><span class="comment">// Send EN_CHANGE</span>
<span class="normal">		</span><span class="cbracket">}</span>

<span class="normal">		</span><span class="usertype">SCNotification</span><span class="normal"> scn </span><span class="symbol">=</span><span class="normal"> </span><span class="cbracket">{</span><span class="number">0</span><span class="cbracket">}</span><span class="symbol">;</span>
<span class="normal">		scn</span><span class="symbol">.</span><span class="normal">nmhdr</span><span class="symbol">.</span><span class="normal">code </span><span class="symbol">=</span><span class="normal"> SCN_MODIFIED</span><span class="symbol">;</span>
<span class="normal">		scn</span><span class="symbol">.</span><span class="normal">position </span><span class="symbol">=</span><span class="normal"> mh</span><span class="symbol">.</span><span class="normal">position</span><span class="symbol">;</span>
<span class="normal">		scn</span><span class="symbol">.</span><span class="normal">modificationType </span><span class="symbol">=</span><span class="normal"> mh</span><span class="symbol">.</span><span class="normal">modificationType</span><span class="symbol">;</span>
<span class="normal">		scn</span><span class="symbol">.</span><span class="normal">text </span><span class="symbol">=</span><span class="normal"> mh</span><span class="symbol">.</span><span class="normal">text</span><span class="symbol">;</span>
<span class="normal">		scn</span><span class="symbol">.</span><span class="normal">length </span><span class="symbol">=</span><span class="normal"> mh</span><span class="symbol">.</span><span class="normal">length</span><span class="symbol">;</span>
<span class="normal">		scn</span><span class="symbol">.</span><span class="normal">linesAdded </span><span class="symbol">=</span><span class="normal"> mh</span><span class="symbol">.</span><span class="normal">linesAdded</span><span class="symbol">;</span>
<span class="normal">		scn</span><span class="symbol">.</span><span class="normal">line </span><span class="symbol">=</span><span class="normal"> mh</span><span class="symbol">.</span><span class="normal">line</span><span class="symbol">;</span>
<span class="normal">		scn</span><span class="symbol">.</span><span class="normal">foldLevelNow </span><span class="symbol">=</span><span class="normal"> mh</span><span class="symbol">.</span><span class="normal">foldLevelNow</span><span class="symbol">;</span>
<span class="normal">		scn</span><span class="symbol">.</span><span class="normal">foldLevelPrev </span><span class="symbol">=</span><span class="normal"> mh</span><span class="symbol">.</span><span class="normal">foldLevelPrev</span><span class="symbol">;</span>
<span class="normal">		scn</span><span class="symbol">.</span><span class="normal">token </span><span class="symbol">=</span><span class="normal"> mh</span><span class="symbol">.</span><span class="normal">token</span><span class="symbol">;</span>
<span class="normal">		scn</span><span class="symbol">.</span><span class="normal">annotationLinesAdded </span><span class="symbol">=</span><span class="normal"> mh</span><span class="symbol">.</span><span class="normal">annotationLinesAdded</span><span class="symbol">;</span>
<span class="normal">		</span><span class="function">NotifyParent</span><span class="symbol">(</span><span class="normal">scn</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">NotifyDeleted</span><span class="symbol">(</span><span class="normal">Document </span><span class="symbol">*,</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="symbol">*)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="comment">/* Do nothing */</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">NotifyMacroRecord</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> iMessage</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">uptr_t</span><span class="normal"> wParam</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">sptr_t</span><span class="normal"> lParam</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>

<span class="normal">	</span><span class="comment">// Enumerates all macroable messages</span>
<span class="normal">	</span><span class="keyword">switch</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">iMessage</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_CUT</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_COPY</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_PASTE</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_CLEAR</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_REPLACESEL</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_ADDTEXT</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_INSERTTEXT</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_APPENDTEXT</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_CLEARALL</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SELECTALL</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GOTOLINE</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GOTOPOS</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SEARCHANCHOR</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SEARCHNEXT</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SEARCHPREV</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_LINEDOWN</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_LINEDOWNEXTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_PARADOWN</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_PARADOWNEXTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_LINEUP</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_LINEUPEXTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_PARAUP</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_PARAUPEXTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_CHARLEFT</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_CHARLEFTEXTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_CHARRIGHT</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_CHARRIGHTEXTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_WORDLEFT</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_WORDLEFTEXTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_WORDRIGHT</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_WORDRIGHTEXTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_WORDPARTLEFT</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_WORDPARTLEFTEXTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_WORDPARTRIGHT</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_WORDPARTRIGHTEXTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_WORDLEFTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_WORDLEFTENDEXTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_WORDRIGHTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_WORDRIGHTENDEXTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_HOME</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_HOMEEXTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_LINEEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_LINEENDEXTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_HOMEWRAP</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_HOMEWRAPEXTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_LINEENDWRAP</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_LINEENDWRAPEXTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_DOCUMENTSTART</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_DOCUMENTSTARTEXTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_DOCUMENTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_DOCUMENTENDEXTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_STUTTEREDPAGEUP</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_STUTTEREDPAGEUPEXTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_STUTTEREDPAGEDOWN</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_STUTTEREDPAGEDOWNEXTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_PAGEUP</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_PAGEUPEXTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_PAGEDOWN</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_PAGEDOWNEXTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_EDITTOGGLEOVERTYPE</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_CANCEL</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_DELETEBACK</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_TAB</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_BACKTAB</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_FORMFEED</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_VCHOME</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_VCHOMEEXTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_VCHOMEWRAP</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_VCHOMEWRAPEXTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_DELWORDLEFT</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_DELWORDRIGHT</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_DELWORDRIGHTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_DELLINELEFT</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_DELLINERIGHT</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_LINECOPY</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_LINECUT</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_LINEDELETE</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_LINETRANSPOSE</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_LINEDUPLICATE</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_LOWERCASE</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_UPPERCASE</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_LINESCROLLDOWN</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_LINESCROLLUP</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_DELETEBACKNOTLINE</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_HOMEDISPLAY</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_HOMEDISPLAYEXTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_LINEENDDISPLAY</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_LINEENDDISPLAYEXTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETSELECTIONMODE</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_LINEDOWNRECTEXTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_LINEUPRECTEXTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_CHARLEFTRECTEXTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_CHARRIGHTRECTEXTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_HOMERECTEXTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_VCHOMERECTEXTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_LINEENDRECTEXTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_PAGEUPRECTEXTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_PAGEDOWNRECTEXTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SELECTIONDUPLICATE</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_COPYALLOWLINE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">		</span><span class="comment">// Filter out all others like display changes. Also, newlines are redundant</span>
<span class="normal">		</span><span class="comment">// with char insert messages.</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_NEWLINE</span><span class="symbol">:</span>
<span class="label">	default:</span>
<span class="normal">		</span><span class="comment">//		printf("Filtered out %ld of macro recording\n", iMessage);</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="comment">// Send notification</span>
<span class="normal">	</span><span class="usertype">SCNotification</span><span class="normal"> scn </span><span class="symbol">=</span><span class="normal"> </span><span class="cbracket">{</span><span class="number">0</span><span class="cbracket">}</span><span class="symbol">;</span>
<span class="normal">	scn</span><span class="symbol">.</span><span class="normal">nmhdr</span><span class="symbol">.</span><span class="normal">code </span><span class="symbol">=</span><span class="normal"> SCN_MACRORECORD</span><span class="symbol">;</span>
<span class="normal">	scn</span><span class="symbol">.</span><span class="normal">message </span><span class="symbol">=</span><span class="normal"> iMessage</span><span class="symbol">;</span>
<span class="normal">	scn</span><span class="symbol">.</span><span class="normal">wParam </span><span class="symbol">=</span><span class="normal"> wParam</span><span class="symbol">;</span>
<span class="normal">	scn</span><span class="symbol">.</span><span class="normal">lParam </span><span class="symbol">=</span><span class="normal"> lParam</span><span class="symbol">;</span>
<span class="normal">	</span><span class="function">NotifyParent</span><span class="symbol">(</span><span class="normal">scn</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="comment">/**</span>
<span class="comment"> * Force scroll and keep position relative to top of window.</span>
<span class="comment"> *</span>
<span class="comment"> * If stuttered = true and not already at first/last row, move to first/last row of window.</span>
<span class="comment"> * If stuttered = true and already at first/last row, scroll as normal.</span>
<span class="comment"> */</span>
<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">PageMove</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> direction</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">selTypes</span><span class="normal"> sel</span><span class="symbol">,</span><span class="normal"> </span><span class="type">bool</span><span class="normal"> stuttered</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> topLineNew</span><span class="symbol">,</span><span class="normal"> newPos</span><span class="symbol">;</span>

<span class="normal">	</span><span class="comment">// I consider only the caretYSlop, and ignore the caretYPolicy-- is that a problem?</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> currentLine </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineFromPosition</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">);</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> topStutterLine </span><span class="symbol">=</span><span class="normal"> topLine </span><span class="symbol">+</span><span class="normal"> caretYSlop</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> bottomStutterLine </span><span class="symbol">=</span>
<span class="normal">	    pdoc</span><span class="symbol">-&gt;</span><span class="function">LineFromPosition</span><span class="symbol">(</span><span class="function">PositionFromLocation</span><span class="symbol">(</span>
<span class="normal">	                </span><span class="function">Point</span><span class="symbol">(</span><span class="normal">lastXChosen</span><span class="symbol">,</span><span class="normal"> direction </span><span class="symbol">*</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">lineHeight </span><span class="symbol">*</span><span class="normal"> </span><span class="function">LinesToScroll</span><span class="symbol">())))</span>
<span class="normal">	    </span><span class="symbol">-</span><span class="normal"> caretYSlop </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">stuttered </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">direction </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">0</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> currentLine </span><span class="symbol">&gt;</span><span class="normal"> topStutterLine</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		topLineNew </span><span class="symbol">=</span><span class="normal"> topLine</span><span class="symbol">;</span>
<span class="normal">		newPos </span><span class="symbol">=</span><span class="normal"> </span><span class="function">PositionFromLocation</span><span class="symbol">(</span><span class="function">Point</span><span class="symbol">(</span><span class="normal">lastXChosen</span><span class="symbol">,</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">lineHeight </span><span class="symbol">*</span><span class="normal"> caretYSlop</span><span class="symbol">));</span>

<span class="normal">	</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">stuttered </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">direction </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">0</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> currentLine </span><span class="symbol">&lt;</span><span class="normal"> bottomStutterLine</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		topLineNew </span><span class="symbol">=</span><span class="normal"> topLine</span><span class="symbol">;</span>
<span class="normal">		newPos </span><span class="symbol">=</span><span class="normal"> </span><span class="function">PositionFromLocation</span><span class="symbol">(</span><span class="function">Point</span><span class="symbol">(</span><span class="normal">lastXChosen</span><span class="symbol">,</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">lineHeight </span><span class="symbol">*</span><span class="normal"> </span><span class="symbol">(</span><span class="function">LinesToScroll</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> caretYSlop</span><span class="symbol">)));</span>

<span class="normal">	</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="usertype">Point</span><span class="normal"> pt </span><span class="symbol">=</span><span class="normal"> </span><span class="function">LocationFromPosition</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">);</span>

<span class="normal">		topLineNew </span><span class="symbol">=</span><span class="normal"> Platform</span><span class="symbol">::</span><span class="function">Clamp</span><span class="symbol">(</span>
<span class="normal">		            topLine </span><span class="symbol">+</span><span class="normal"> direction </span><span class="symbol">*</span><span class="normal"> </span><span class="function">LinesToScroll</span><span class="symbol">(),</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="function">MaxScrollPos</span><span class="symbol">());</span>
<span class="normal">		newPos </span><span class="symbol">=</span><span class="normal"> </span><span class="function">PositionFromLocation</span><span class="symbol">(</span>
<span class="normal">		            </span><span class="function">Point</span><span class="symbol">(</span><span class="normal">lastXChosen</span><span class="symbol">,</span><span class="normal"> pt</span><span class="symbol">.</span><span class="normal">y </span><span class="symbol">+</span><span class="normal"> direction </span><span class="symbol">*</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vs</span><span class="symbol">.</span><span class="normal">lineHeight </span><span class="symbol">*</span><span class="normal"> </span><span class="function">LinesToScroll</span><span class="symbol">())));</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">topLineNew </span><span class="symbol">!=</span><span class="normal"> topLine</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">SetTopLine</span><span class="symbol">(</span><span class="normal">topLineNew</span><span class="symbol">);</span>
<span class="normal">		</span><span class="function">MovePositionTo</span><span class="symbol">(</span><span class="normal">newPos</span><span class="symbol">,</span><span class="normal"> sel</span><span class="symbol">);</span>
<span class="normal">		</span><span class="function">Redraw</span><span class="symbol">();</span>
<span class="normal">		</span><span class="function">SetVerticalScrollPos</span><span class="symbol">();</span>
<span class="normal">	</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">MovePositionTo</span><span class="symbol">(</span><span class="normal">newPos</span><span class="symbol">,</span><span class="normal"> sel</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">ChangeCaseOfSelection</span><span class="symbol">(</span><span class="type">bool</span><span class="normal"> makeUpperCase</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	pdoc</span><span class="symbol">-&gt;</span><span class="function">BeginUndoAction</span><span class="symbol">();</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> startCurrent </span><span class="symbol">=</span><span class="normal"> currentPos</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> startAnchor </span><span class="symbol">=</span><span class="normal"> anchor</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">selType </span><span class="symbol">==</span><span class="normal"> selStream</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		pdoc</span><span class="symbol">-&gt;</span><span class="function">ChangeCase</span><span class="symbol">(</span><span class="function">Range</span><span class="symbol">(</span><span class="function">SelectionStart</span><span class="symbol">(),</span><span class="normal"> </span><span class="function">SelectionEnd</span><span class="symbol">()),</span>
<span class="normal">		        makeUpperCase</span><span class="symbol">);</span>
<span class="normal">		</span><span class="function">SetSelection</span><span class="symbol">(</span><span class="normal">startCurrent</span><span class="symbol">,</span><span class="normal"> startAnchor</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="usertype">SelectionLineIterator</span><span class="normal"> </span><span class="function">lineIterator</span><span class="symbol">(</span><span class="keyword">this</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lineIterator</span><span class="symbol">.</span><span class="function">Iterate</span><span class="symbol">())</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			pdoc</span><span class="symbol">-&gt;</span><span class="function">ChangeCase</span><span class="symbol">(</span>
<span class="normal">			    </span><span class="function">Range</span><span class="symbol">(</span><span class="normal">lineIterator</span><span class="symbol">.</span><span class="normal">startPos</span><span class="symbol">,</span><span class="normal"> lineIterator</span><span class="symbol">.</span><span class="normal">endPos</span><span class="symbol">),</span>
<span class="normal">			    makeUpperCase</span><span class="symbol">);</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="comment">// Would be nicer to keep the rectangular selection but this is complex</span>
<span class="normal">		</span><span class="function">SetEmptySelection</span><span class="symbol">(</span><span class="normal">startCurrent</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	pdoc</span><span class="symbol">-&gt;</span><span class="function">EndUndoAction</span><span class="symbol">();</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">LineTranspose</span><span class="symbol">()</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> line </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineFromPosition</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">line </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		pdoc</span><span class="symbol">-&gt;</span><span class="function">BeginUndoAction</span><span class="symbol">();</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> startPrev </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">line </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> endPrev </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineEnd</span><span class="symbol">(</span><span class="normal">line </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> start </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">);</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> end </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineEnd</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">);</span>
<span class="normal">		</span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">line1 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">CopyRange</span><span class="symbol">(</span><span class="normal">startPrev</span><span class="symbol">,</span><span class="normal"> endPrev</span><span class="symbol">);</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> len1 </span><span class="symbol">=</span><span class="normal"> endPrev </span><span class="symbol">-</span><span class="normal"> startPrev</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">line2 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">CopyRange</span><span class="symbol">(</span><span class="normal">start</span><span class="symbol">,</span><span class="normal"> end</span><span class="symbol">);</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> len2 </span><span class="symbol">=</span><span class="normal"> end </span><span class="symbol">-</span><span class="normal"> start</span><span class="symbol">;</span>
<span class="normal">		pdoc</span><span class="symbol">-&gt;</span><span class="function">DeleteChars</span><span class="symbol">(</span><span class="normal">start</span><span class="symbol">,</span><span class="normal"> len2</span><span class="symbol">);</span>
<span class="normal">		pdoc</span><span class="symbol">-&gt;</span><span class="function">DeleteChars</span><span class="symbol">(</span><span class="normal">startPrev</span><span class="symbol">,</span><span class="normal"> len1</span><span class="symbol">);</span>
<span class="normal">		pdoc</span><span class="symbol">-&gt;</span><span class="function">InsertString</span><span class="symbol">(</span><span class="normal">startPrev</span><span class="symbol">,</span><span class="normal"> line2</span><span class="symbol">,</span><span class="normal"> len2</span><span class="symbol">);</span>
<span class="normal">		pdoc</span><span class="symbol">-&gt;</span><span class="function">InsertString</span><span class="symbol">(</span><span class="normal">start </span><span class="symbol">-</span><span class="normal"> len1 </span><span class="symbol">+</span><span class="normal"> len2</span><span class="symbol">,</span><span class="normal"> line1</span><span class="symbol">,</span><span class="normal"> len1</span><span class="symbol">);</span>
<span class="normal">		</span><span class="function">MovePositionTo</span><span class="symbol">(</span><span class="normal">start </span><span class="symbol">-</span><span class="normal"> len1 </span><span class="symbol">+</span><span class="normal"> len2</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">delete</span><span class="normal"> </span><span class="symbol">[]</span><span class="normal">line1</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">delete</span><span class="normal"> </span><span class="symbol">[]</span><span class="normal">line2</span><span class="symbol">;</span>
<span class="normal">		pdoc</span><span class="symbol">-&gt;</span><span class="function">EndUndoAction</span><span class="symbol">();</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">Duplicate</span><span class="symbol">(</span><span class="type">bool</span><span class="normal"> forLine</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> start </span><span class="symbol">=</span><span class="normal"> </span><span class="function">SelectionStart</span><span class="symbol">();</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> end </span><span class="symbol">=</span><span class="normal"> </span><span class="function">SelectionEnd</span><span class="symbol">();</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">start </span><span class="symbol">==</span><span class="normal"> end</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		forLine </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">forLine</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> line </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineFromPosition</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">);</span>
<span class="normal">		start </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">);</span>
<span class="normal">		end </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineEnd</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">text </span><span class="symbol">=</span><span class="normal"> </span><span class="function">CopyRange</span><span class="symbol">(</span><span class="normal">start</span><span class="symbol">,</span><span class="normal"> end</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">forLine</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">const</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">eol </span><span class="symbol">=</span><span class="normal"> </span><span class="function">StringFromEOLMode</span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="normal">eolMode</span><span class="symbol">);</span>
<span class="normal">		pdoc</span><span class="symbol">-&gt;</span><span class="function">InsertCString</span><span class="symbol">(</span><span class="normal">end</span><span class="symbol">,</span><span class="normal"> eol</span><span class="symbol">);</span>
<span class="normal">		pdoc</span><span class="symbol">-&gt;</span><span class="function">InsertString</span><span class="symbol">(</span><span class="normal">end </span><span class="symbol">+</span><span class="normal"> </span><span class="function">istrlen</span><span class="symbol">(</span><span class="normal">eol</span><span class="symbol">),</span><span class="normal"> text</span><span class="symbol">,</span><span class="normal"> end </span><span class="symbol">-</span><span class="normal"> start</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		pdoc</span><span class="symbol">-&gt;</span><span class="function">InsertString</span><span class="symbol">(</span><span class="normal">end</span><span class="symbol">,</span><span class="normal"> text</span><span class="symbol">,</span><span class="normal"> end </span><span class="symbol">-</span><span class="normal"> start</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">delete</span><span class="normal"> </span><span class="symbol">[]</span><span class="normal">text</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">CancelModes</span><span class="symbol">()</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	moveExtendsSelection </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">NewLine</span><span class="symbol">()</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="function">ClearSelection</span><span class="symbol">();</span>
<span class="normal">	</span><span class="keyword">const</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">eol </span><span class="symbol">=</span><span class="normal"> </span><span class="string">"</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="normal">eolMode </span><span class="symbol">==</span><span class="normal"> SC_EOL_CRLF</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		eol </span><span class="symbol">=</span><span class="normal"> </span><span class="string">"</span><span class="specialchar">\r\n</span><span class="string">"</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="normal">eolMode </span><span class="symbol">==</span><span class="normal"> SC_EOL_CR</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		eol </span><span class="symbol">=</span><span class="normal"> </span><span class="string">"</span><span class="specialchar">\r</span><span class="string">"</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span><span class="normal"> </span><span class="comment">// else SC_EOL_LF -&gt; "\n" already set</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">InsertCString</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">,</span><span class="normal"> eol</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">SetEmptySelection</span><span class="symbol">(</span><span class="normal">currentPos </span><span class="symbol">+</span><span class="normal"> </span><span class="function">istrlen</span><span class="symbol">(</span><span class="normal">eol</span><span class="symbol">));</span>
<span class="normal">		</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(*</span><span class="normal">eol</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="function">NotifyChar</span><span class="symbol">(*</span><span class="normal">eol</span><span class="symbol">);</span>
<span class="normal">			eol</span><span class="symbol">++;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="function">SetLastXChosen</span><span class="symbol">();</span>
<span class="normal">	</span><span class="function">SetScrollBars</span><span class="symbol">();</span>
<span class="normal">	</span><span class="function">EnsureCaretVisible</span><span class="symbol">();</span>
<span class="normal">	</span><span class="comment">// Avoid blinking during rapid typing:</span>
<span class="normal">	</span><span class="function">ShowCaretAtCurrentPosition</span><span class="symbol">();</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">CursorUpOrDown</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> direction</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">selTypes</span><span class="normal"> sel</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="usertype">Point</span><span class="normal"> pt </span><span class="symbol">=</span><span class="normal"> </span><span class="function">LocationFromPosition</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">);</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> lineDoc </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineFromPosition</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">);</span>
<span class="normal">	</span><span class="usertype">Point</span><span class="normal"> ptStartLine </span><span class="symbol">=</span><span class="normal"> </span><span class="function">LocationFromPosition</span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">lineDoc</span><span class="symbol">));</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> subLine </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pt</span><span class="symbol">.</span><span class="normal">y </span><span class="symbol">-</span><span class="normal"> ptStartLine</span><span class="symbol">.</span><span class="normal">y</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">/</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">lineHeight</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> commentLines </span><span class="symbol">=</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">annotationVisible </span><span class="symbol">?</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">AnnotationLines</span><span class="symbol">(</span><span class="normal">lineDoc</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">:</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> posNew </span><span class="symbol">=</span><span class="normal"> </span><span class="function">PositionFromLocation</span><span class="symbol">(</span>
<span class="normal">	            </span><span class="function">Point</span><span class="symbol">(</span><span class="normal">lastXChosen</span><span class="symbol">,</span><span class="normal"> pt</span><span class="symbol">.</span><span class="normal">y </span><span class="symbol">+</span><span class="normal"> direction </span><span class="symbol">*</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">lineHeight</span><span class="symbol">));</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">direction </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">subLine </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">cs</span><span class="symbol">.</span><span class="function">GetHeight</span><span class="symbol">(</span><span class="normal">lineDoc</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> commentLines</span><span class="symbol">)))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		posNew </span><span class="symbol">=</span><span class="normal"> </span><span class="function">PositionFromLocation</span><span class="symbol">(</span>
<span class="normal">	            </span><span class="function">Point</span><span class="symbol">(</span><span class="normal">lastXChosen</span><span class="symbol">,</span><span class="normal"> pt</span><span class="symbol">.</span><span class="normal">y </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">commentLines </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">lineHeight</span><span class="symbol">));</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">direction </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="comment">// Line wrapping may lead to a location on the same line, so</span>
<span class="normal">		</span><span class="comment">// seek back if that is the case.</span>
<span class="normal">		</span><span class="comment">// There is an equivalent case when moving down which skips</span>
<span class="normal">		</span><span class="comment">// over a line but as that does not trap the user it is fine.</span>
<span class="normal">		</span><span class="usertype">Point</span><span class="normal"> ptNew </span><span class="symbol">=</span><span class="normal"> </span><span class="function">LocationFromPosition</span><span class="symbol">(</span><span class="normal">posNew</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">posNew </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pt</span><span class="symbol">.</span><span class="normal">y </span><span class="symbol">==</span><span class="normal"> ptNew</span><span class="symbol">.</span><span class="normal">y</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			posNew</span><span class="symbol">--;</span>
<span class="normal">			ptNew </span><span class="symbol">=</span><span class="normal"> </span><span class="function">LocationFromPosition</span><span class="symbol">(</span><span class="normal">posNew</span><span class="symbol">);</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="function">MovePositionTo</span><span class="symbol">(</span><span class="normal">posNew</span><span class="symbol">,</span><span class="normal"> sel</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">ParaUpOrDown</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> direction</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">selTypes</span><span class="normal"> sel</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> lineDoc</span><span class="symbol">,</span><span class="normal"> savedPos </span><span class="symbol">=</span><span class="normal"> currentPos</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">do</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">MovePositionTo</span><span class="symbol">(</span><span class="normal">direction </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">0</span><span class="normal"> </span><span class="symbol">?</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">ParaDown</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">:</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">ParaUp</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">),</span><span class="normal"> sel</span><span class="symbol">);</span>
<span class="normal">		lineDoc </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineFromPosition</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">direction </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">currentPos </span><span class="symbol">&gt;=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">Length</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">!</span><span class="normal">cs</span><span class="symbol">.</span><span class="function">GetVisible</span><span class="symbol">(</span><span class="normal">lineDoc</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">sel </span><span class="symbol">==</span><span class="normal"> noSel</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="function">MovePositionTo</span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">LineEndPosition</span><span class="symbol">(</span><span class="normal">savedPos</span><span class="symbol">));</span>
<span class="normal">				</span><span class="cbracket">}</span>
<span class="normal">				</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">cs</span><span class="symbol">.</span><span class="function">GetVisible</span><span class="symbol">(</span><span class="normal">lineDoc</span><span class="symbol">));</span>
<span class="cbracket">}</span>

<span class="type">int</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">StartEndDisplayLine</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> pos</span><span class="symbol">,</span><span class="normal"> </span><span class="type">bool</span><span class="normal"> start</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="function">RefreshStyleData</span><span class="symbol">();</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> line </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineFromPosition</span><span class="symbol">(</span><span class="normal">pos</span><span class="symbol">);</span>
<span class="normal">	</span><span class="usertype">AutoSurface</span><span class="normal"> </span><span class="function">surface</span><span class="symbol">(</span><span class="keyword">this</span><span class="symbol">);</span>
<span class="normal">	</span><span class="usertype">AutoLineLayout</span><span class="normal"> </span><span class="function">ll</span><span class="symbol">(</span><span class="normal">llc</span><span class="symbol">,</span><span class="normal"> </span><span class="function">RetrieveLineLayout</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">));</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> posRet </span><span class="symbol">=</span><span class="normal"> INVALID_POSITION</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">surface </span><span class="symbol">&amp;&amp;</span><span class="normal"> ll</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> posLineStart </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">);</span>
<span class="normal">		</span><span class="function">LayoutLine</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">,</span><span class="normal"> surface</span><span class="symbol">,</span><span class="normal"> vs</span><span class="symbol">,</span><span class="normal"> ll</span><span class="symbol">,</span><span class="normal"> wrapWidth</span><span class="symbol">);</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> posInLine </span><span class="symbol">=</span><span class="normal"> pos </span><span class="symbol">-</span><span class="normal"> posLineStart</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">posInLine </span><span class="symbol">&lt;=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">maxLineLength</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="normal"> subLine </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> subLine </span><span class="symbol">&lt;</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">lines</span><span class="symbol">;</span><span class="normal"> subLine</span><span class="symbol">++)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">posInLine </span><span class="symbol">&gt;=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">subLine</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">posInLine </span><span class="symbol">&lt;=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">subLine </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">start</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">						posRet </span><span class="symbol">=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">subLine</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> posLineStart</span><span class="symbol">;</span>
<span class="normal">					</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">						</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">subLine </span><span class="symbol">==</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">lines </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span>
<span class="normal">							posRet </span><span class="symbol">=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">subLine </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> posLineStart</span><span class="symbol">;</span>
<span class="normal">						</span><span class="keyword">else</span>
<span class="normal">							posRet </span><span class="symbol">=</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">subLine </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> posLineStart </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">					</span><span class="cbracket">}</span>
<span class="normal">				</span><span class="cbracket">}</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">posRet </span><span class="symbol">==</span><span class="normal"> INVALID_POSITION</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> pos</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> posRet</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="type">int</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">KeyCommand</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> iMessage</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">switch</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">iMessage</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_LINEDOWN</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">CursorUpOrDown</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_LINEDOWNEXTEND</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">CursorUpOrDown</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> selStream</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_LINEDOWNRECTEXTEND</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">CursorUpOrDown</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> selRectangle</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_PARADOWN</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">ParaUpOrDown</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_PARADOWNEXTEND</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">ParaUpOrDown</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> selStream</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_LINESCROLLDOWN</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">ScrollTo</span><span class="symbol">(</span><span class="normal">topLine </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">		</span><span class="function">MoveCaretInsideView</span><span class="symbol">(</span><span class="keyword">false</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_LINEUP</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">CursorUpOrDown</span><span class="symbol">(-</span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_LINEUPEXTEND</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">CursorUpOrDown</span><span class="symbol">(-</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> selStream</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_LINEUPRECTEXTEND</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">CursorUpOrDown</span><span class="symbol">(-</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> selRectangle</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_PARAUP</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">ParaUpOrDown</span><span class="symbol">(-</span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_PARAUPEXTEND</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">ParaUpOrDown</span><span class="symbol">(-</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> selStream</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_LINESCROLLUP</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">ScrollTo</span><span class="symbol">(</span><span class="normal">topLine </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">		</span><span class="function">MoveCaretInsideView</span><span class="symbol">(</span><span class="keyword">false</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_CHARLEFT</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">SelectionEmpty</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> moveExtendsSelection</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="function">MovePositionTo</span><span class="symbol">(</span><span class="function">MovePositionSoVisible</span><span class="symbol">(</span><span class="normal">currentPos </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">));</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="function">MovePositionTo</span><span class="symbol">(</span><span class="function">SelectionStart</span><span class="symbol">());</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="function">SetLastXChosen</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_CHARLEFTEXTEND</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">MovePositionTo</span><span class="symbol">(</span><span class="function">MovePositionSoVisible</span><span class="symbol">(</span><span class="normal">currentPos </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">),</span><span class="normal"> selStream</span><span class="symbol">);</span>
<span class="normal">		</span><span class="function">SetLastXChosen</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_CHARLEFTRECTEXTEND</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">MovePositionTo</span><span class="symbol">(</span><span class="function">MovePositionSoVisible</span><span class="symbol">(</span><span class="normal">currentPos </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">),</span><span class="normal"> selRectangle</span><span class="symbol">);</span>
<span class="normal">		</span><span class="function">SetLastXChosen</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_CHARRIGHT</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">SelectionEmpty</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> moveExtendsSelection</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="function">MovePositionTo</span><span class="symbol">(</span><span class="function">MovePositionSoVisible</span><span class="symbol">(</span><span class="normal">currentPos </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="number">1</span><span class="symbol">));</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="function">MovePositionTo</span><span class="symbol">(</span><span class="function">SelectionEnd</span><span class="symbol">());</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="function">SetLastXChosen</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_CHARRIGHTEXTEND</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">MovePositionTo</span><span class="symbol">(</span><span class="function">MovePositionSoVisible</span><span class="symbol">(</span><span class="normal">currentPos </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="number">1</span><span class="symbol">),</span><span class="normal"> selStream</span><span class="symbol">);</span>
<span class="normal">		</span><span class="function">SetLastXChosen</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_CHARRIGHTRECTEXTEND</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">MovePositionTo</span><span class="symbol">(</span><span class="function">MovePositionSoVisible</span><span class="symbol">(</span><span class="normal">currentPos </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="number">1</span><span class="symbol">),</span><span class="normal"> selRectangle</span><span class="symbol">);</span>
<span class="normal">		</span><span class="function">SetLastXChosen</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_WORDLEFT</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">MovePositionTo</span><span class="symbol">(</span><span class="function">MovePositionSoVisible</span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">NextWordStart</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">),</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">));</span>
<span class="normal">		</span><span class="function">SetLastXChosen</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_WORDLEFTEXTEND</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">MovePositionTo</span><span class="symbol">(</span><span class="function">MovePositionSoVisible</span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">NextWordStart</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">),</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">),</span><span class="normal"> selStream</span><span class="symbol">);</span>
<span class="normal">		</span><span class="function">SetLastXChosen</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_WORDRIGHT</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">MovePositionTo</span><span class="symbol">(</span><span class="function">MovePositionSoVisible</span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">NextWordStart</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">,</span><span class="normal"> </span><span class="number">1</span><span class="symbol">),</span><span class="normal"> </span><span class="number">1</span><span class="symbol">));</span>
<span class="normal">		</span><span class="function">SetLastXChosen</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_WORDRIGHTEXTEND</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">MovePositionTo</span><span class="symbol">(</span><span class="function">MovePositionSoVisible</span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">NextWordStart</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">,</span><span class="normal"> </span><span class="number">1</span><span class="symbol">),</span><span class="normal"> </span><span class="number">1</span><span class="symbol">),</span><span class="normal"> selStream</span><span class="symbol">);</span>
<span class="normal">		</span><span class="function">SetLastXChosen</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_WORDLEFTEND</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">MovePositionTo</span><span class="symbol">(</span><span class="function">MovePositionSoVisible</span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">NextWordEnd</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">),</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">));</span>
<span class="normal">		</span><span class="function">SetLastXChosen</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_WORDLEFTENDEXTEND</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">MovePositionTo</span><span class="symbol">(</span><span class="function">MovePositionSoVisible</span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">NextWordEnd</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">),</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">),</span><span class="normal"> selStream</span><span class="symbol">);</span>
<span class="normal">		</span><span class="function">SetLastXChosen</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_WORDRIGHTEND</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">MovePositionTo</span><span class="symbol">(</span><span class="function">MovePositionSoVisible</span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">NextWordEnd</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">,</span><span class="normal"> </span><span class="number">1</span><span class="symbol">),</span><span class="normal"> </span><span class="number">1</span><span class="symbol">));</span>
<span class="normal">		</span><span class="function">SetLastXChosen</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_WORDRIGHTENDEXTEND</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">MovePositionTo</span><span class="symbol">(</span><span class="function">MovePositionSoVisible</span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">NextWordEnd</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">,</span><span class="normal"> </span><span class="number">1</span><span class="symbol">),</span><span class="normal"> </span><span class="number">1</span><span class="symbol">),</span><span class="normal"> selStream</span><span class="symbol">);</span>
<span class="normal">		</span><span class="function">SetLastXChosen</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_HOME</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">MovePositionTo</span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">LineFromPosition</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">)));</span>
<span class="normal">		</span><span class="function">SetLastXChosen</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_HOMEEXTEND</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">MovePositionTo</span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">LineFromPosition</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">)),</span><span class="normal"> selStream</span><span class="symbol">);</span>
<span class="normal">		</span><span class="function">SetLastXChosen</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_HOMERECTEXTEND</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">MovePositionTo</span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">LineFromPosition</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">)),</span><span class="normal"> selRectangle</span><span class="symbol">);</span>
<span class="normal">		</span><span class="function">SetLastXChosen</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_LINEEND</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">MovePositionTo</span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">LineEndPosition</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">));</span>
<span class="normal">		</span><span class="function">SetLastXChosen</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_LINEENDEXTEND</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">MovePositionTo</span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">LineEndPosition</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">),</span><span class="normal"> selStream</span><span class="symbol">);</span>
<span class="normal">		</span><span class="function">SetLastXChosen</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_LINEENDRECTEXTEND</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">MovePositionTo</span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">LineEndPosition</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">),</span><span class="normal"> selRectangle</span><span class="symbol">);</span>
<span class="normal">		</span><span class="function">SetLastXChosen</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_HOMEWRAP</span><span class="symbol">:</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> homePos </span><span class="symbol">=</span><span class="normal"> </span><span class="function">MovePositionSoVisible</span><span class="symbol">(</span><span class="function">StartEndDisplayLine</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">),</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">currentPos </span><span class="symbol">&lt;=</span><span class="normal"> homePos</span><span class="symbol">)</span>
<span class="normal">				homePos </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">LineFromPosition</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">));</span>
<span class="normal">			</span><span class="function">MovePositionTo</span><span class="symbol">(</span><span class="normal">homePos</span><span class="symbol">);</span>
<span class="normal">			</span><span class="function">SetLastXChosen</span><span class="symbol">();</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_HOMEWRAPEXTEND</span><span class="symbol">:</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> homePos </span><span class="symbol">=</span><span class="normal"> </span><span class="function">MovePositionSoVisible</span><span class="symbol">(</span><span class="function">StartEndDisplayLine</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">),</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">currentPos </span><span class="symbol">&lt;=</span><span class="normal"> homePos</span><span class="symbol">)</span>
<span class="normal">				homePos </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">LineFromPosition</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">));</span>
<span class="normal">			</span><span class="function">MovePositionTo</span><span class="symbol">(</span><span class="normal">homePos</span><span class="symbol">,</span><span class="normal"> selStream</span><span class="symbol">);</span>
<span class="normal">			</span><span class="function">SetLastXChosen</span><span class="symbol">();</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_LINEENDWRAP</span><span class="symbol">:</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> endPos </span><span class="symbol">=</span><span class="normal"> </span><span class="function">MovePositionSoVisible</span><span class="symbol">(</span><span class="function">StartEndDisplayLine</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">),</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> realEndPos </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineEndPosition</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">);</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">endPos </span><span class="symbol">&gt;</span><span class="normal"> realEndPos      </span><span class="comment">// if moved past visible EOLs</span>
<span class="normal">			        </span><span class="symbol">||</span><span class="normal"> currentPos </span><span class="symbol">&gt;=</span><span class="normal"> endPos</span><span class="symbol">)</span><span class="normal"> </span><span class="comment">// if at end of display line already</span>
<span class="normal">				endPos </span><span class="symbol">=</span><span class="normal"> realEndPos</span><span class="symbol">;</span>
<span class="normal">			</span><span class="function">MovePositionTo</span><span class="symbol">(</span><span class="normal">endPos</span><span class="symbol">);</span>
<span class="normal">			</span><span class="function">SetLastXChosen</span><span class="symbol">();</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_LINEENDWRAPEXTEND</span><span class="symbol">:</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> endPos </span><span class="symbol">=</span><span class="normal"> </span><span class="function">MovePositionSoVisible</span><span class="symbol">(</span><span class="function">StartEndDisplayLine</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">),</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> realEndPos </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineEndPosition</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">);</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">endPos </span><span class="symbol">&gt;</span><span class="normal"> realEndPos      </span><span class="comment">// if moved past visible EOLs</span>
<span class="normal">			        </span><span class="symbol">||</span><span class="normal"> currentPos </span><span class="symbol">&gt;=</span><span class="normal"> endPos</span><span class="symbol">)</span><span class="normal"> </span><span class="comment">// if at end of display line already</span>
<span class="normal">				endPos </span><span class="symbol">=</span><span class="normal"> realEndPos</span><span class="symbol">;</span>
<span class="normal">			</span><span class="function">MovePositionTo</span><span class="symbol">(</span><span class="normal">endPos</span><span class="symbol">,</span><span class="normal"> selStream</span><span class="symbol">);</span>
<span class="normal">			</span><span class="function">SetLastXChosen</span><span class="symbol">();</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_DOCUMENTSTART</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">MovePositionTo</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">);</span>
<span class="normal">		</span><span class="function">SetLastXChosen</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_DOCUMENTSTARTEXTEND</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">MovePositionTo</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">,</span><span class="normal"> selStream</span><span class="symbol">);</span>
<span class="normal">		</span><span class="function">SetLastXChosen</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_DOCUMENTEND</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">MovePositionTo</span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">Length</span><span class="symbol">());</span>
<span class="normal">		</span><span class="function">SetLastXChosen</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_DOCUMENTENDEXTEND</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">MovePositionTo</span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">Length</span><span class="symbol">(),</span><span class="normal"> selStream</span><span class="symbol">);</span>
<span class="normal">		</span><span class="function">SetLastXChosen</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_STUTTEREDPAGEUP</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">PageMove</span><span class="symbol">(-</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> noSel</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_STUTTEREDPAGEUPEXTEND</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">PageMove</span><span class="symbol">(-</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> selStream</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_STUTTEREDPAGEDOWN</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">PageMove</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> noSel</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_STUTTEREDPAGEDOWNEXTEND</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">PageMove</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> selStream</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_PAGEUP</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">PageMove</span><span class="symbol">(-</span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_PAGEUPEXTEND</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">PageMove</span><span class="symbol">(-</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> selStream</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_PAGEUPRECTEXTEND</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">PageMove</span><span class="symbol">(-</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> selRectangle</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_PAGEDOWN</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">PageMove</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_PAGEDOWNEXTEND</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">PageMove</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> selStream</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_PAGEDOWNRECTEXTEND</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">PageMove</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> selRectangle</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_EDITTOGGLEOVERTYPE</span><span class="symbol">:</span>
<span class="normal">		inOverstrike </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">!</span><span class="normal">inOverstrike</span><span class="symbol">;</span>
<span class="normal">		</span><span class="function">DropCaret</span><span class="symbol">();</span>
<span class="normal">		</span><span class="function">ShowCaretAtCurrentPosition</span><span class="symbol">();</span>
<span class="normal">		</span><span class="function">NotifyUpdateUI</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_CANCEL</span><span class="symbol">:</span><span class="normal">            	</span><span class="comment">// Cancel any modes - handled in subclass</span>
<span class="normal">		</span><span class="comment">// Also unselect text</span>
<span class="normal">		</span><span class="function">CancelModes</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_DELETEBACK</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">DelCharBack</span><span class="symbol">(</span><span class="keyword">true</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">caretSticky</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="function">SetLastXChosen</span><span class="symbol">();</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="function">EnsureCaretVisible</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_DELETEBACKNOTLINE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">DelCharBack</span><span class="symbol">(</span><span class="keyword">false</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">caretSticky</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="function">SetLastXChosen</span><span class="symbol">();</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="function">EnsureCaretVisible</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_TAB</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">Indent</span><span class="symbol">(</span><span class="keyword">true</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">caretSticky</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="function">SetLastXChosen</span><span class="symbol">();</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="function">EnsureCaretVisible</span><span class="symbol">();</span>
<span class="normal">		</span><span class="function">ShowCaretAtCurrentPosition</span><span class="symbol">();</span><span class="normal">		</span><span class="comment">// Avoid blinking</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_BACKTAB</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">Indent</span><span class="symbol">(</span><span class="keyword">false</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">caretSticky</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="function">SetLastXChosen</span><span class="symbol">();</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="function">EnsureCaretVisible</span><span class="symbol">();</span>
<span class="normal">		</span><span class="function">ShowCaretAtCurrentPosition</span><span class="symbol">();</span><span class="normal">		</span><span class="comment">// Avoid blinking</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_NEWLINE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">NewLine</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_FORMFEED</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">AddChar</span><span class="symbol">(</span><span class="string">'</span><span class="specialchar">\f</span><span class="string">'</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_VCHOME</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">MovePositionTo</span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">VCHomePosition</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">));</span>
<span class="normal">		</span><span class="function">SetLastXChosen</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_VCHOMEEXTEND</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">MovePositionTo</span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">VCHomePosition</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">),</span><span class="normal"> selStream</span><span class="symbol">);</span>
<span class="normal">		</span><span class="function">SetLastXChosen</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_VCHOMERECTEXTEND</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">MovePositionTo</span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">VCHomePosition</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">),</span><span class="normal"> selRectangle</span><span class="symbol">);</span>
<span class="normal">		</span><span class="function">SetLastXChosen</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_VCHOMEWRAP</span><span class="symbol">:</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> homePos </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">VCHomePosition</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">);</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> viewLineStart </span><span class="symbol">=</span><span class="normal"> </span><span class="function">MovePositionSoVisible</span><span class="symbol">(</span><span class="function">StartEndDisplayLine</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">),</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">viewLineStart </span><span class="symbol">&lt;</span><span class="normal"> currentPos</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">viewLineStart </span><span class="symbol">&gt;</span><span class="normal"> homePos</span><span class="symbol">))</span>
<span class="normal">				homePos </span><span class="symbol">=</span><span class="normal"> viewLineStart</span><span class="symbol">;</span>

<span class="normal">			</span><span class="function">MovePositionTo</span><span class="symbol">(</span><span class="normal">homePos</span><span class="symbol">);</span>
<span class="normal">			</span><span class="function">SetLastXChosen</span><span class="symbol">();</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_VCHOMEWRAPEXTEND</span><span class="symbol">:</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> homePos </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">VCHomePosition</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">);</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> viewLineStart </span><span class="symbol">=</span><span class="normal"> </span><span class="function">MovePositionSoVisible</span><span class="symbol">(</span><span class="function">StartEndDisplayLine</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">),</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">viewLineStart </span><span class="symbol">&lt;</span><span class="normal"> currentPos</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">viewLineStart </span><span class="symbol">&gt;</span><span class="normal"> homePos</span><span class="symbol">))</span>
<span class="normal">				homePos </span><span class="symbol">=</span><span class="normal"> viewLineStart</span><span class="symbol">;</span>

<span class="normal">			</span><span class="function">MovePositionTo</span><span class="symbol">(</span><span class="normal">homePos</span><span class="symbol">,</span><span class="normal"> selStream</span><span class="symbol">);</span>
<span class="normal">			</span><span class="function">SetLastXChosen</span><span class="symbol">();</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_ZOOMIN</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vs</span><span class="symbol">.</span><span class="normal">zoomLevel </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">20</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			vs</span><span class="symbol">.</span><span class="normal">zoomLevel</span><span class="symbol">++;</span>
<span class="normal">			</span><span class="function">InvalidateStyleRedraw</span><span class="symbol">();</span>
<span class="normal">			</span><span class="function">NotifyZoom</span><span class="symbol">();</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_ZOOMOUT</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vs</span><span class="symbol">.</span><span class="normal">zoomLevel </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="symbol">-</span><span class="number">10</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			vs</span><span class="symbol">.</span><span class="normal">zoomLevel</span><span class="symbol">--;</span>
<span class="normal">			</span><span class="function">InvalidateStyleRedraw</span><span class="symbol">();</span>
<span class="normal">			</span><span class="function">NotifyZoom</span><span class="symbol">();</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_DELWORDLEFT</span><span class="symbol">:</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> startWord </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">NextWordStart</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">			pdoc</span><span class="symbol">-&gt;</span><span class="function">DeleteChars</span><span class="symbol">(</span><span class="normal">startWord</span><span class="symbol">,</span><span class="normal"> currentPos </span><span class="symbol">-</span><span class="normal"> startWord</span><span class="symbol">);</span>
<span class="normal">			</span><span class="function">SetLastXChosen</span><span class="symbol">();</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_DELWORDRIGHT</span><span class="symbol">:</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> endWord </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">NextWordStart</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">,</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">			pdoc</span><span class="symbol">-&gt;</span><span class="function">DeleteChars</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">,</span><span class="normal"> endWord </span><span class="symbol">-</span><span class="normal"> currentPos</span><span class="symbol">);</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_DELWORDRIGHTEND</span><span class="symbol">:</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> endWord </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">NextWordEnd</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">,</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">			pdoc</span><span class="symbol">-&gt;</span><span class="function">DeleteChars</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">,</span><span class="normal"> endWord </span><span class="symbol">-</span><span class="normal"> currentPos</span><span class="symbol">);</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_DELLINELEFT</span><span class="symbol">:</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> line </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineFromPosition</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">);</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> start </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">);</span>
<span class="normal">			pdoc</span><span class="symbol">-&gt;</span><span class="function">DeleteChars</span><span class="symbol">(</span><span class="normal">start</span><span class="symbol">,</span><span class="normal"> currentPos </span><span class="symbol">-</span><span class="normal"> start</span><span class="symbol">);</span>
<span class="normal">			</span><span class="function">SetLastXChosen</span><span class="symbol">();</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_DELLINERIGHT</span><span class="symbol">:</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> line </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineFromPosition</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">);</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> end </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineEnd</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">);</span>
<span class="normal">			pdoc</span><span class="symbol">-&gt;</span><span class="function">DeleteChars</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">,</span><span class="normal"> end </span><span class="symbol">-</span><span class="normal"> currentPos</span><span class="symbol">);</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_LINECOPY</span><span class="symbol">:</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> lineStart </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineFromPosition</span><span class="symbol">(</span><span class="function">SelectionStart</span><span class="symbol">());</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> lineEnd </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineFromPosition</span><span class="symbol">(</span><span class="function">SelectionEnd</span><span class="symbol">());</span>
<span class="normal">			</span><span class="function">CopyRangeToClipboard</span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">lineStart</span><span class="symbol">),</span>
<span class="normal">			        pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">lineEnd </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">));</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_LINECUT</span><span class="symbol">:</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> lineStart </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineFromPosition</span><span class="symbol">(</span><span class="function">SelectionStart</span><span class="symbol">());</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> lineEnd </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineFromPosition</span><span class="symbol">(</span><span class="function">SelectionEnd</span><span class="symbol">());</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> start </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">lineStart</span><span class="symbol">);</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> end </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">lineEnd </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">			</span><span class="function">SetSelection</span><span class="symbol">(</span><span class="normal">start</span><span class="symbol">,</span><span class="normal"> end</span><span class="symbol">);</span>
<span class="normal">			</span><span class="function">Cut</span><span class="symbol">();</span>
<span class="normal">			</span><span class="function">SetLastXChosen</span><span class="symbol">();</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_LINEDELETE</span><span class="symbol">:</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> line </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineFromPosition</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">);</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> start </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">);</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> end </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">line </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">			pdoc</span><span class="symbol">-&gt;</span><span class="function">DeleteChars</span><span class="symbol">(</span><span class="normal">start</span><span class="symbol">,</span><span class="normal"> end </span><span class="symbol">-</span><span class="normal"> start</span><span class="symbol">);</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_LINETRANSPOSE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">LineTranspose</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_LINEDUPLICATE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">Duplicate</span><span class="symbol">(</span><span class="keyword">true</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SELECTIONDUPLICATE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">Duplicate</span><span class="symbol">(</span><span class="keyword">false</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_LOWERCASE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">ChangeCaseOfSelection</span><span class="symbol">(</span><span class="keyword">false</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_UPPERCASE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">ChangeCaseOfSelection</span><span class="symbol">(</span><span class="keyword">true</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_WORDPARTLEFT</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">MovePositionTo</span><span class="symbol">(</span><span class="function">MovePositionSoVisible</span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">WordPartLeft</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">),</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">));</span>
<span class="normal">		</span><span class="function">SetLastXChosen</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_WORDPARTLEFTEXTEND</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">MovePositionTo</span><span class="symbol">(</span><span class="function">MovePositionSoVisible</span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">WordPartLeft</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">),</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">),</span><span class="normal"> selStream</span><span class="symbol">);</span>
<span class="normal">		</span><span class="function">SetLastXChosen</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_WORDPARTRIGHT</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">MovePositionTo</span><span class="symbol">(</span><span class="function">MovePositionSoVisible</span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">WordPartRight</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">),</span><span class="normal"> </span><span class="number">1</span><span class="symbol">));</span>
<span class="normal">		</span><span class="function">SetLastXChosen</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_WORDPARTRIGHTEXTEND</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">MovePositionTo</span><span class="symbol">(</span><span class="function">MovePositionSoVisible</span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">WordPartRight</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">),</span><span class="normal"> </span><span class="number">1</span><span class="symbol">),</span><span class="normal"> selStream</span><span class="symbol">);</span>
<span class="normal">		</span><span class="function">SetLastXChosen</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_HOMEDISPLAY</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">MovePositionTo</span><span class="symbol">(</span><span class="function">MovePositionSoVisible</span><span class="symbol">(</span>
<span class="normal">		            </span><span class="function">StartEndDisplayLine</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">),</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">));</span>
<span class="normal">		</span><span class="function">SetLastXChosen</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_HOMEDISPLAYEXTEND</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">MovePositionTo</span><span class="symbol">(</span><span class="function">MovePositionSoVisible</span><span class="symbol">(</span>
<span class="normal">		            </span><span class="function">StartEndDisplayLine</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">),</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">),</span><span class="normal"> selStream</span><span class="symbol">);</span>
<span class="normal">		</span><span class="function">SetLastXChosen</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_LINEENDDISPLAY</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">MovePositionTo</span><span class="symbol">(</span><span class="function">MovePositionSoVisible</span><span class="symbol">(</span>
<span class="normal">		            </span><span class="function">StartEndDisplayLine</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">),</span><span class="normal"> </span><span class="number">1</span><span class="symbol">));</span>
<span class="normal">		</span><span class="function">SetLastXChosen</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_LINEENDDISPLAYEXTEND</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">MovePositionTo</span><span class="symbol">(</span><span class="function">MovePositionSoVisible</span><span class="symbol">(</span>
<span class="normal">		            </span><span class="function">StartEndDisplayLine</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">),</span><span class="normal"> </span><span class="number">1</span><span class="symbol">),</span><span class="normal"> selStream</span><span class="symbol">);</span>
<span class="normal">		</span><span class="function">SetLastXChosen</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="type">int</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">KeyDefault</span><span class="symbol">(</span><span class="type">int</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="type">int</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">KeyDown</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> key</span><span class="symbol">,</span><span class="normal"> </span><span class="type">bool</span><span class="normal"> shift</span><span class="symbol">,</span><span class="normal"> </span><span class="type">bool</span><span class="normal"> ctrl</span><span class="symbol">,</span><span class="normal"> </span><span class="type">bool</span><span class="normal"> alt</span><span class="symbol">,</span><span class="normal"> </span><span class="type">bool</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">consumed</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="function">DwellEnd</span><span class="symbol">(</span><span class="keyword">false</span><span class="symbol">);</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> modifiers </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">shift </span><span class="symbol">?</span><span class="normal"> SCI_SHIFT </span><span class="symbol">:</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">|</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ctrl </span><span class="symbol">?</span><span class="normal"> SCI_CTRL </span><span class="symbol">:</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">|</span>
<span class="normal">	        </span><span class="symbol">(</span><span class="normal">alt </span><span class="symbol">?</span><span class="normal"> SCI_ALT </span><span class="symbol">:</span><span class="normal"> </span><span class="number">0</span><span class="symbol">);</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> msg </span><span class="symbol">=</span><span class="normal"> kmap</span><span class="symbol">.</span><span class="function">Find</span><span class="symbol">(</span><span class="normal">key</span><span class="symbol">,</span><span class="normal"> modifiers</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">msg</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">consumed</span><span class="symbol">)</span>
<span class="normal">			</span><span class="symbol">*</span><span class="normal">consumed </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="function">WndProc</span><span class="symbol">(</span><span class="normal">msg</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">consumed</span><span class="symbol">)</span>
<span class="normal">			</span><span class="symbol">*</span><span class="normal">consumed </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="function">KeyDefault</span><span class="symbol">(</span><span class="normal">key</span><span class="symbol">,</span><span class="normal"> modifiers</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">SetWhitespaceVisible</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> view</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	vs</span><span class="symbol">.</span><span class="normal">viewWhitespace </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">static_cast</span><span class="symbol">&lt;</span><span class="normal">WhiteSpaceVisibility</span><span class="symbol">&gt;(</span><span class="normal">view</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="type">int</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">GetWhitespaceVisible</span><span class="symbol">()</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">viewWhitespace</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">Indent</span><span class="symbol">(</span><span class="type">bool</span><span class="normal"> forwards</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="comment">//Platform::DebugPrintf("INdent %d\n", forwards);</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> lineOfAnchor </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineFromPosition</span><span class="symbol">(</span><span class="normal">anchor</span><span class="symbol">);</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> lineCurrentPos </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineFromPosition</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lineOfAnchor </span><span class="symbol">==</span><span class="normal"> lineCurrentPos</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">forwards</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			pdoc</span><span class="symbol">-&gt;</span><span class="function">BeginUndoAction</span><span class="symbol">();</span>
<span class="normal">			</span><span class="function">ClearSelection</span><span class="symbol">();</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">GetColumn</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&lt;=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">GetColumn</span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">GetLineIndentPosition</span><span class="symbol">(</span><span class="normal">lineCurrentPos</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span>
<span class="normal">			        pdoc</span><span class="symbol">-&gt;</span><span class="normal">tabIndents</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="type">int</span><span class="normal"> indentation </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">GetLineIndentation</span><span class="symbol">(</span><span class="normal">lineCurrentPos</span><span class="symbol">);</span>
<span class="normal">				</span><span class="type">int</span><span class="normal"> indentationStep </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">IndentSize</span><span class="symbol">();</span>
<span class="normal">				pdoc</span><span class="symbol">-&gt;</span><span class="function">SetLineIndentation</span><span class="symbol">(</span><span class="normal">lineCurrentPos</span><span class="symbol">,</span><span class="normal"> indentation </span><span class="symbol">+</span><span class="normal"> indentationStep </span><span class="symbol">-</span><span class="normal"> indentation </span><span class="symbol">%</span><span class="normal"> indentationStep</span><span class="symbol">);</span>
<span class="normal">				</span><span class="function">SetEmptySelection</span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">GetLineIndentPosition</span><span class="symbol">(</span><span class="normal">lineCurrentPos</span><span class="symbol">));</span>
<span class="normal">			</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="normal">useTabs</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					pdoc</span><span class="symbol">-&gt;</span><span class="function">InsertChar</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">,</span><span class="normal"> </span><span class="string">'</span><span class="specialchar">\t</span><span class="string">'</span><span class="symbol">);</span>
<span class="normal">					</span><span class="function">SetEmptySelection</span><span class="symbol">(</span><span class="normal">currentPos </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">				</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="type">int</span><span class="normal"> numSpaces </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="normal">tabInChars</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">-</span>
<span class="normal">					        </span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">GetColumn</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">%</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="normal">tabInChars</span><span class="symbol">));</span>
<span class="normal">					</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">numSpaces </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span>
<span class="normal">						numSpaces </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="normal">tabInChars</span><span class="symbol">;</span>
<span class="normal">					</span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="normal"> i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> numSpaces</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">						pdoc</span><span class="symbol">-&gt;</span><span class="function">InsertChar</span><span class="symbol">(</span><span class="normal">currentPos </span><span class="symbol">+</span><span class="normal"> i</span><span class="symbol">,</span><span class="normal"> </span><span class="string">' '</span><span class="symbol">);</span>
<span class="normal">					</span><span class="cbracket">}</span>
<span class="normal">					</span><span class="function">SetEmptySelection</span><span class="symbol">(</span><span class="normal">currentPos </span><span class="symbol">+</span><span class="normal"> numSpaces</span><span class="symbol">);</span>
<span class="normal">				</span><span class="cbracket">}</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">			pdoc</span><span class="symbol">-&gt;</span><span class="function">EndUndoAction</span><span class="symbol">();</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">GetColumn</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&lt;=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">GetLineIndentation</span><span class="symbol">(</span><span class="normal">lineCurrentPos</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span>
<span class="normal">			        pdoc</span><span class="symbol">-&gt;</span><span class="normal">tabIndents</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				pdoc</span><span class="symbol">-&gt;</span><span class="function">BeginUndoAction</span><span class="symbol">();</span>
<span class="normal">				</span><span class="type">int</span><span class="normal"> indentation </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">GetLineIndentation</span><span class="symbol">(</span><span class="normal">lineCurrentPos</span><span class="symbol">);</span>
<span class="normal">				</span><span class="type">int</span><span class="normal"> indentationStep </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">IndentSize</span><span class="symbol">();</span>
<span class="normal">				pdoc</span><span class="symbol">-&gt;</span><span class="function">SetLineIndentation</span><span class="symbol">(</span><span class="normal">lineCurrentPos</span><span class="symbol">,</span><span class="normal"> indentation </span><span class="symbol">-</span><span class="normal"> indentationStep</span><span class="symbol">);</span>
<span class="normal">				</span><span class="function">SetEmptySelection</span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">GetLineIndentPosition</span><span class="symbol">(</span><span class="normal">lineCurrentPos</span><span class="symbol">));</span>
<span class="normal">				pdoc</span><span class="symbol">-&gt;</span><span class="function">EndUndoAction</span><span class="symbol">();</span>
<span class="normal">			</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="type">int</span><span class="normal"> newColumn </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">GetColumn</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">/</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="normal">tabInChars</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span>
<span class="normal">				        pdoc</span><span class="symbol">-&gt;</span><span class="normal">tabInChars</span><span class="symbol">;</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">newColumn </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">					newColumn </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">				</span><span class="type">int</span><span class="normal"> newPos </span><span class="symbol">=</span><span class="normal"> currentPos</span><span class="symbol">;</span>
<span class="normal">				</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">GetColumn</span><span class="symbol">(</span><span class="normal">newPos</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;</span><span class="normal"> newColumn</span><span class="symbol">)</span>
<span class="normal">					newPos</span><span class="symbol">--;</span>
<span class="normal">				</span><span class="function">SetEmptySelection</span><span class="symbol">(</span><span class="normal">newPos</span><span class="symbol">);</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> anchorPosOnLine </span><span class="symbol">=</span><span class="normal"> anchor </span><span class="symbol">-</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">lineOfAnchor</span><span class="symbol">);</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> currentPosPosOnLine </span><span class="symbol">=</span><span class="normal"> currentPos </span><span class="symbol">-</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">lineCurrentPos</span><span class="symbol">);</span>
<span class="normal">		</span><span class="comment">// Multiple lines selected so indent / dedent</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> lineTopSel </span><span class="symbol">=</span><span class="normal"> Platform</span><span class="symbol">::</span><span class="function">Minimum</span><span class="symbol">(</span><span class="normal">lineOfAnchor</span><span class="symbol">,</span><span class="normal"> lineCurrentPos</span><span class="symbol">);</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> lineBottomSel </span><span class="symbol">=</span><span class="normal"> Platform</span><span class="symbol">::</span><span class="function">Maximum</span><span class="symbol">(</span><span class="normal">lineOfAnchor</span><span class="symbol">,</span><span class="normal"> lineCurrentPos</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">lineBottomSel</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> anchor </span><span class="symbol">||</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">lineBottomSel</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> currentPos</span><span class="symbol">)</span>
<span class="normal">			lineBottomSel</span><span class="symbol">--;</span><span class="normal">  	</span><span class="comment">// If not selecting any characters on a line, do not indent</span>
<span class="normal">		pdoc</span><span class="symbol">-&gt;</span><span class="function">BeginUndoAction</span><span class="symbol">();</span>
<span class="normal">		pdoc</span><span class="symbol">-&gt;</span><span class="function">Indent</span><span class="symbol">(</span><span class="normal">forwards</span><span class="symbol">,</span><span class="normal"> lineBottomSel</span><span class="symbol">,</span><span class="normal"> lineTopSel</span><span class="symbol">);</span>
<span class="normal">		pdoc</span><span class="symbol">-&gt;</span><span class="function">EndUndoAction</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lineOfAnchor </span><span class="symbol">&lt;</span><span class="normal"> lineCurrentPos</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">currentPosPosOnLine </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">				</span><span class="function">SetSelection</span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">lineCurrentPos</span><span class="symbol">),</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">lineOfAnchor</span><span class="symbol">));</span>
<span class="normal">			</span><span class="keyword">else</span>
<span class="normal">				</span><span class="function">SetSelection</span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">lineCurrentPos </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">),</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">lineOfAnchor</span><span class="symbol">));</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">anchorPosOnLine </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">				</span><span class="function">SetSelection</span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">lineCurrentPos</span><span class="symbol">),</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">lineOfAnchor</span><span class="symbol">));</span>
<span class="normal">			</span><span class="keyword">else</span>
<span class="normal">				</span><span class="function">SetSelection</span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">lineCurrentPos</span><span class="symbol">),</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">lineOfAnchor </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">));</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="comment">/**</span>
<span class="comment"> * Search of a text in the document, in the given range.</span>
<span class="comment"> * </span><span class="type">@return</span><span class="comment"> The position of the found text, -1 if not found.</span>
<span class="comment"> */</span>
<span class="type">long</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">FindText</span><span class="symbol">(</span>
<span class="normal">    </span><span class="usertype">uptr_t</span><span class="normal"> wParam</span><span class="symbol">,</span><span class="normal">		</span><span class="comment">///&lt; Search modes : </span><span class="type">@c</span><span class="comment"> SCFIND_MATCHCASE, </span><span class="type">@c</span><span class="comment"> SCFIND_WHOLEWORD,</span>
<span class="normal">    </span><span class="comment">///&lt; </span><span class="type">@c</span><span class="comment"> SCFIND_WORDSTART, </span><span class="type">@c</span><span class="comment"> SCFIND_REGEXP or </span><span class="type">@c</span><span class="comment"> SCFIND_POSIX.</span>
<span class="normal">    </span><span class="usertype">sptr_t</span><span class="normal"> lParam</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal">	</span><span class="comment">///&lt; </span><span class="type">@c</span><span class="comment"> TextToFind structure: The text to search for in the given range.</span>

<span class="normal">	</span><span class="usertype">Sci_TextToFind</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">ft </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">reinterpret_cast</span><span class="symbol">&lt;</span><span class="normal">Sci_TextToFind </span><span class="symbol">*&gt;(</span><span class="normal">lParam</span><span class="symbol">);</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> lengthFound </span><span class="symbol">=</span><span class="normal"> </span><span class="function">istrlen</span><span class="symbol">(</span><span class="normal">ft</span><span class="symbol">-&gt;</span><span class="normal">lpstrText</span><span class="symbol">);</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> pos </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">FindText</span><span class="symbol">(</span><span class="normal">ft</span><span class="symbol">-&gt;</span><span class="normal">chrg</span><span class="symbol">.</span><span class="normal">cpMin</span><span class="symbol">,</span><span class="normal"> ft</span><span class="symbol">-&gt;</span><span class="normal">chrg</span><span class="symbol">.</span><span class="normal">cpMax</span><span class="symbol">,</span><span class="normal"> ft</span><span class="symbol">-&gt;</span><span class="normal">lpstrText</span><span class="symbol">,</span>
<span class="normal">	        </span><span class="symbol">(</span><span class="normal">wParam </span><span class="symbol">&amp;</span><span class="normal"> SCFIND_MATCHCASE</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span>
<span class="normal">	        </span><span class="symbol">(</span><span class="normal">wParam </span><span class="symbol">&amp;</span><span class="normal"> SCFIND_WHOLEWORD</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span>
<span class="normal">	        </span><span class="symbol">(</span><span class="normal">wParam </span><span class="symbol">&amp;</span><span class="normal"> SCFIND_WORDSTART</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span>
<span class="normal">	        </span><span class="symbol">(</span><span class="normal">wParam </span><span class="symbol">&amp;</span><span class="normal"> SCFIND_REGEXP</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span>
<span class="normal">	        wParam</span><span class="symbol">,</span>
<span class="normal">	        </span><span class="symbol">&amp;</span><span class="normal">lengthFound</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pos </span><span class="symbol">!=</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		ft</span><span class="symbol">-&gt;</span><span class="normal">chrgText</span><span class="symbol">.</span><span class="normal">cpMin </span><span class="symbol">=</span><span class="normal"> pos</span><span class="symbol">;</span>
<span class="normal">		ft</span><span class="symbol">-&gt;</span><span class="normal">chrgText</span><span class="symbol">.</span><span class="normal">cpMax </span><span class="symbol">=</span><span class="normal"> pos </span><span class="symbol">+</span><span class="normal"> lengthFound</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> pos</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="comment">/**</span>
<span class="comment"> * Relocatable search support : Searches relative to current selection</span>
<span class="comment"> * point and sets the selection to the found text range with</span>
<span class="comment"> * each search.</span>
<span class="comment"> */</span>
<span class="comment">/**</span>
<span class="comment"> * Anchor following searches at current selection start: This allows</span>
<span class="comment"> * multiple incremental interactive searches to be macro recorded</span>
<span class="comment"> * while still setting the selection to found text so the find/select</span>
<span class="comment"> * operation is self-contained.</span>
<span class="comment"> */</span>
<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">SearchAnchor</span><span class="symbol">()</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	searchAnchor </span><span class="symbol">=</span><span class="normal"> </span><span class="function">SelectionStart</span><span class="symbol">();</span>
<span class="cbracket">}</span>

<span class="comment">/**</span>
<span class="comment"> * Find text from current search anchor: Must call </span><span class="type">@c</span><span class="comment"> SearchAnchor first.</span>
<span class="comment"> * Used for next text and previous text requests.</span>
<span class="comment"> * </span><span class="type">@return</span><span class="comment"> The position of the found text, -1 if not found.</span>
<span class="comment"> */</span>
<span class="type">long</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">SearchText</span><span class="symbol">(</span>
<span class="normal">    </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> iMessage</span><span class="symbol">,</span><span class="normal">		</span><span class="comment">///&lt; Accepts both </span><span class="type">@c</span><span class="comment"> SCI_SEARCHNEXT and </span><span class="type">@c</span><span class="comment"> SCI_SEARCHPREV.</span>
<span class="normal">    </span><span class="usertype">uptr_t</span><span class="normal"> wParam</span><span class="symbol">,</span><span class="normal">				</span><span class="comment">///&lt; Search modes : </span><span class="type">@c</span><span class="comment"> SCFIND_MATCHCASE, </span><span class="type">@c</span><span class="comment"> SCFIND_WHOLEWORD,</span>
<span class="normal">    </span><span class="comment">///&lt; </span><span class="type">@c</span><span class="comment"> SCFIND_WORDSTART, </span><span class="type">@c</span><span class="comment"> SCFIND_REGEXP or </span><span class="type">@c</span><span class="comment"> SCFIND_POSIX.</span>
<span class="normal">    </span><span class="usertype">sptr_t</span><span class="normal"> lParam</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal">			</span><span class="comment">///&lt; The text to search for.</span>

<span class="normal">	</span><span class="keyword">const</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">txt </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">reinterpret_cast</span><span class="symbol">&lt;</span><span class="type">char</span><span class="normal"> </span><span class="symbol">*&gt;(</span><span class="normal">lParam</span><span class="symbol">);</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> pos</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> lengthFound </span><span class="symbol">=</span><span class="normal"> </span><span class="function">istrlen</span><span class="symbol">(</span><span class="normal">txt</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">iMessage </span><span class="symbol">==</span><span class="normal"> SCI_SEARCHNEXT</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		pos </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">FindText</span><span class="symbol">(</span><span class="normal">searchAnchor</span><span class="symbol">,</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">Length</span><span class="symbol">(),</span><span class="normal"> txt</span><span class="symbol">,</span>
<span class="normal">		        </span><span class="symbol">(</span><span class="normal">wParam </span><span class="symbol">&amp;</span><span class="normal"> SCFIND_MATCHCASE</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span>
<span class="normal">		        </span><span class="symbol">(</span><span class="normal">wParam </span><span class="symbol">&amp;</span><span class="normal"> SCFIND_WHOLEWORD</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span>
<span class="normal">		        </span><span class="symbol">(</span><span class="normal">wParam </span><span class="symbol">&amp;</span><span class="normal"> SCFIND_WORDSTART</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span>
<span class="normal">		        </span><span class="symbol">(</span><span class="normal">wParam </span><span class="symbol">&amp;</span><span class="normal"> SCFIND_REGEXP</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span>
<span class="normal">		        wParam</span><span class="symbol">,</span>
<span class="normal">		        </span><span class="symbol">&amp;</span><span class="normal">lengthFound</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		pos </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">FindText</span><span class="symbol">(</span><span class="normal">searchAnchor</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> txt</span><span class="symbol">,</span>
<span class="normal">		        </span><span class="symbol">(</span><span class="normal">wParam </span><span class="symbol">&amp;</span><span class="normal"> SCFIND_MATCHCASE</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span>
<span class="normal">		        </span><span class="symbol">(</span><span class="normal">wParam </span><span class="symbol">&amp;</span><span class="normal"> SCFIND_WHOLEWORD</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span>
<span class="normal">		        </span><span class="symbol">(</span><span class="normal">wParam </span><span class="symbol">&amp;</span><span class="normal"> SCFIND_WORDSTART</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span>
<span class="normal">		        </span><span class="symbol">(</span><span class="normal">wParam </span><span class="symbol">&amp;</span><span class="normal"> SCFIND_REGEXP</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span>
<span class="normal">		        wParam</span><span class="symbol">,</span>
<span class="normal">		        </span><span class="symbol">&amp;</span><span class="normal">lengthFound</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pos </span><span class="symbol">!=</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">SetSelection</span><span class="symbol">(</span><span class="normal">pos</span><span class="symbol">,</span><span class="normal"> pos </span><span class="symbol">+</span><span class="normal"> lengthFound</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="keyword">return</span><span class="normal"> pos</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="comment">/**</span>
<span class="comment"> * Search for text in the target range of the document.</span>
<span class="comment"> * </span><span class="type">@return</span><span class="comment"> The position of the found text, -1 if not found.</span>
<span class="comment"> */</span>
<span class="type">long</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">SearchInTarget</span><span class="symbol">(</span><span class="keyword">const</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">text</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> length</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> lengthFound </span><span class="symbol">=</span><span class="normal"> length</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> pos </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">FindText</span><span class="symbol">(</span><span class="normal">targetStart</span><span class="symbol">,</span><span class="normal"> targetEnd</span><span class="symbol">,</span><span class="normal"> text</span><span class="symbol">,</span>
<span class="normal">	        </span><span class="symbol">(</span><span class="normal">searchFlags </span><span class="symbol">&amp;</span><span class="normal"> SCFIND_MATCHCASE</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span>
<span class="normal">	        </span><span class="symbol">(</span><span class="normal">searchFlags </span><span class="symbol">&amp;</span><span class="normal"> SCFIND_WHOLEWORD</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span>
<span class="normal">	        </span><span class="symbol">(</span><span class="normal">searchFlags </span><span class="symbol">&amp;</span><span class="normal"> SCFIND_WORDSTART</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span>
<span class="normal">	        </span><span class="symbol">(</span><span class="normal">searchFlags </span><span class="symbol">&amp;</span><span class="normal"> SCFIND_REGEXP</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span>
<span class="normal">	        searchFlags</span><span class="symbol">,</span>
<span class="normal">	        </span><span class="symbol">&amp;</span><span class="normal">lengthFound</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pos </span><span class="symbol">!=</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		targetStart </span><span class="symbol">=</span><span class="normal"> pos</span><span class="symbol">;</span>
<span class="normal">		targetEnd </span><span class="symbol">=</span><span class="normal"> pos </span><span class="symbol">+</span><span class="normal"> lengthFound</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> pos</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">GoToLine</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> lineNo</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lineNo </span><span class="symbol">&gt;</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LinesTotal</span><span class="symbol">())</span>
<span class="normal">		lineNo </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LinesTotal</span><span class="symbol">();</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lineNo </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">		lineNo </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">	</span><span class="function">SetEmptySelection</span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">lineNo</span><span class="symbol">));</span>
<span class="normal">	</span><span class="function">ShowCaretAtCurrentPosition</span><span class="symbol">();</span>
<span class="normal">	</span><span class="function">EnsureCaretVisible</span><span class="symbol">();</span>
<span class="cbracket">}</span>

<span class="keyword">static</span><span class="normal"> </span><span class="type">bool</span><span class="normal"> </span><span class="function">Close</span><span class="symbol">(</span><span class="usertype">Point</span><span class="normal"> pt1</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">Point</span><span class="normal"> pt2</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">abs</span><span class="symbol">(</span><span class="normal">pt1</span><span class="symbol">.</span><span class="normal">x </span><span class="symbol">-</span><span class="normal"> pt2</span><span class="symbol">.</span><span class="normal">x</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">3</span><span class="symbol">)</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">abs</span><span class="symbol">(</span><span class="normal">pt1</span><span class="symbol">.</span><span class="normal">y </span><span class="symbol">-</span><span class="normal"> pt2</span><span class="symbol">.</span><span class="normal">y</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">3</span><span class="symbol">)</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">Editor</span><span class="symbol">::</span><span class="function">CopyRange</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> start</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> end</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">text </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">start </span><span class="symbol">&lt;</span><span class="normal"> end</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> len </span><span class="symbol">=</span><span class="normal"> end </span><span class="symbol">-</span><span class="normal"> start</span><span class="symbol">;</span>
<span class="normal">		text </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">new</span><span class="normal"> </span><span class="type">char</span><span class="symbol">[</span><span class="normal">len </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">];</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">text</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="normal"> i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> len</span><span class="symbol">;</span><span class="normal"> i</span><span class="symbol">++)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				text</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">CharAt</span><span class="symbol">(</span><span class="normal">start </span><span class="symbol">+</span><span class="normal"> i</span><span class="symbol">);</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">			text</span><span class="symbol">[</span><span class="normal">len</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="string">'</span><span class="specialchar">\0</span><span class="string">'</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> text</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">CopySelectionFromRange</span><span class="symbol">(</span><span class="usertype">SelectionText</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">ss</span><span class="symbol">,</span><span class="normal"> </span><span class="type">bool</span><span class="normal"> allowLineCopy</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> start</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> end</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="type">bool</span><span class="normal"> isLine </span><span class="symbol">=</span><span class="normal"> allowLineCopy </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">start </span><span class="symbol">==</span><span class="normal"> end</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">isLine</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> currentLine </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineFromPosition</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">);</span>
<span class="normal">		start </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">currentLine</span><span class="symbol">);</span>
<span class="normal">		end </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineEnd</span><span class="symbol">(</span><span class="normal">currentLine</span><span class="symbol">);</span>

<span class="normal">		</span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">text </span><span class="symbol">=</span><span class="normal"> </span><span class="function">CopyRange</span><span class="symbol">(</span><span class="normal">start</span><span class="symbol">,</span><span class="normal"> end</span><span class="symbol">);</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> textLen </span><span class="symbol">=</span><span class="normal"> text </span><span class="symbol">?</span><span class="normal"> </span><span class="function">strlen</span><span class="symbol">(</span><span class="normal">text</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">:</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		</span><span class="comment">// include room for \r\n\0</span>
<span class="normal">		textLen </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">3</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">textWithEndl </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">new</span><span class="normal"> </span><span class="type">char</span><span class="symbol">[</span><span class="normal">textLen</span><span class="symbol">];</span>
<span class="normal">		textWithEndl</span><span class="symbol">[</span><span class="number">0</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="string">'</span><span class="specialchar">\0</span><span class="string">'</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">text</span><span class="symbol">)</span>
<span class="normal">			</span><span class="function">strncat</span><span class="symbol">(</span><span class="normal">textWithEndl</span><span class="symbol">,</span><span class="normal"> text</span><span class="symbol">,</span><span class="normal"> textLen</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="normal">eolMode </span><span class="symbol">!=</span><span class="normal"> SC_EOL_LF</span><span class="symbol">)</span>
<span class="normal">			</span><span class="function">strncat</span><span class="symbol">(</span><span class="normal">textWithEndl</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"</span><span class="specialchar">\r</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> textLen</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="normal">eolMode </span><span class="symbol">!=</span><span class="normal"> SC_EOL_CR</span><span class="symbol">)</span>
<span class="normal">			</span><span class="function">strncat</span><span class="symbol">(</span><span class="normal">textWithEndl</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> textLen</span><span class="symbol">);</span>
<span class="normal">		ss</span><span class="symbol">-&gt;</span><span class="function">Set</span><span class="symbol">(</span><span class="normal">textWithEndl</span><span class="symbol">,</span><span class="normal"> </span><span class="function">strlen</span><span class="symbol">(</span><span class="normal">textWithEndl</span><span class="symbol">),</span>
<span class="normal">			pdoc</span><span class="symbol">-&gt;</span><span class="normal">dbcsCodePage</span><span class="symbol">,</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">STYLE_DEFAULT</span><span class="symbol">].</span><span class="normal">characterSet</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">delete</span><span class="normal"> </span><span class="symbol">[]</span><span class="normal">text</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		ss</span><span class="symbol">-&gt;</span><span class="function">Set</span><span class="symbol">(</span><span class="function">CopyRange</span><span class="symbol">(</span><span class="normal">start</span><span class="symbol">,</span><span class="normal"> end</span><span class="symbol">),</span><span class="normal"> end </span><span class="symbol">-</span><span class="normal"> start </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span>
<span class="normal">			pdoc</span><span class="symbol">-&gt;</span><span class="normal">dbcsCodePage</span><span class="symbol">,</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">STYLE_DEFAULT</span><span class="symbol">].</span><span class="normal">characterSet</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">CopySelectionRange</span><span class="symbol">(</span><span class="usertype">SelectionText</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">ss</span><span class="symbol">,</span><span class="normal"> </span><span class="type">bool</span><span class="normal"> allowLineCopy</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">selType </span><span class="symbol">==</span><span class="normal"> selStream</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">CopySelectionFromRange</span><span class="symbol">(</span><span class="normal">ss</span><span class="symbol">,</span><span class="normal"> allowLineCopy</span><span class="symbol">,</span><span class="normal"> </span><span class="function">SelectionStart</span><span class="symbol">(),</span><span class="normal"> </span><span class="function">SelectionEnd</span><span class="symbol">());</span>
<span class="normal">	</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">text </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> size </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		</span><span class="usertype">SelectionLineIterator</span><span class="normal"> </span><span class="function">lineIterator</span><span class="symbol">(</span><span class="keyword">this</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lineIterator</span><span class="symbol">.</span><span class="function">Iterate</span><span class="symbol">())</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			size </span><span class="symbol">+=</span><span class="normal"> lineIterator</span><span class="symbol">.</span><span class="normal">endPos </span><span class="symbol">-</span><span class="normal"> lineIterator</span><span class="symbol">.</span><span class="normal">startPos</span><span class="symbol">;</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">selType </span><span class="symbol">!=</span><span class="normal"> selLines</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				size</span><span class="symbol">++;</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="normal">eolMode </span><span class="symbol">==</span><span class="normal"> SC_EOL_CRLF</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					size</span><span class="symbol">++;</span>
<span class="normal">				</span><span class="cbracket">}</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">size </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			text </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">new</span><span class="normal"> </span><span class="type">char</span><span class="symbol">[</span><span class="normal">size </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">];</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">text</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="type">int</span><span class="normal"> j </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">				lineIterator</span><span class="symbol">.</span><span class="function">Reset</span><span class="symbol">();</span>
<span class="normal">				</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lineIterator</span><span class="symbol">.</span><span class="function">Iterate</span><span class="symbol">())</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="normal"> i </span><span class="symbol">=</span><span class="normal"> lineIterator</span><span class="symbol">.</span><span class="normal">startPos</span><span class="symbol">;</span>
<span class="normal">					        i </span><span class="symbol">&lt;</span><span class="normal"> lineIterator</span><span class="symbol">.</span><span class="normal">endPos</span><span class="symbol">;</span>
<span class="normal">					        i</span><span class="symbol">++)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">						text</span><span class="symbol">[</span><span class="normal">j</span><span class="symbol">++]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">CharAt</span><span class="symbol">(</span><span class="normal">i</span><span class="symbol">);</span>
<span class="normal">					</span><span class="cbracket">}</span>
<span class="normal">					</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">selType </span><span class="symbol">!=</span><span class="normal"> selLines</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">						</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="normal">eolMode </span><span class="symbol">!=</span><span class="normal"> SC_EOL_LF</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">							text</span><span class="symbol">[</span><span class="normal">j</span><span class="symbol">++]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="string">'</span><span class="specialchar">\r</span><span class="string">'</span><span class="symbol">;</span>
<span class="normal">						</span><span class="cbracket">}</span>
<span class="normal">						</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="normal">eolMode </span><span class="symbol">!=</span><span class="normal"> SC_EOL_CR</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">							text</span><span class="symbol">[</span><span class="normal">j</span><span class="symbol">++]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="string">'</span><span class="specialchar">\n</span><span class="string">'</span><span class="symbol">;</span>
<span class="normal">						</span><span class="cbracket">}</span>
<span class="normal">					</span><span class="cbracket">}</span>
<span class="normal">				</span><span class="cbracket">}</span>
<span class="normal">				text</span><span class="symbol">[</span><span class="normal">size</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="string">'</span><span class="specialchar">\0</span><span class="string">'</span><span class="symbol">;</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		ss</span><span class="symbol">-&gt;</span><span class="function">Set</span><span class="symbol">(</span><span class="normal">text</span><span class="symbol">,</span><span class="normal"> size </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="normal">dbcsCodePage</span><span class="symbol">,</span>
<span class="normal">			vs</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">STYLE_DEFAULT</span><span class="symbol">].</span><span class="normal">characterSet</span><span class="symbol">,</span><span class="normal"> selType </span><span class="symbol">==</span><span class="normal"> selRectangle</span><span class="symbol">,</span><span class="normal"> selType </span><span class="symbol">==</span><span class="normal"> selLines</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">CopyRangeToClipboard</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> start</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> end</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	start </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">ClampPositionIntoDocument</span><span class="symbol">(</span><span class="normal">start</span><span class="symbol">);</span>
<span class="normal">	end </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">ClampPositionIntoDocument</span><span class="symbol">(</span><span class="normal">end</span><span class="symbol">);</span>
<span class="normal">	</span><span class="usertype">SelectionText</span><span class="normal"> selectedText</span><span class="symbol">;</span>
<span class="normal">	selectedText</span><span class="symbol">.</span><span class="function">Set</span><span class="symbol">(</span><span class="function">CopyRange</span><span class="symbol">(</span><span class="normal">start</span><span class="symbol">,</span><span class="normal"> end</span><span class="symbol">),</span><span class="normal"> end </span><span class="symbol">-</span><span class="normal"> start </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span>
<span class="normal">		pdoc</span><span class="symbol">-&gt;</span><span class="normal">dbcsCodePage</span><span class="symbol">,</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">STYLE_DEFAULT</span><span class="symbol">].</span><span class="normal">characterSet</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">);</span>
<span class="normal">	</span><span class="function">CopyToClipboard</span><span class="symbol">(</span><span class="normal">selectedText</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">CopyText</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> length</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">text</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="usertype">SelectionText</span><span class="normal"> selectedText</span><span class="symbol">;</span>
<span class="normal">	selectedText</span><span class="symbol">.</span><span class="function">Copy</span><span class="symbol">(</span><span class="normal">text</span><span class="symbol">,</span><span class="normal"> length </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span>
<span class="normal">		pdoc</span><span class="symbol">-&gt;</span><span class="normal">dbcsCodePage</span><span class="symbol">,</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">STYLE_DEFAULT</span><span class="symbol">].</span><span class="normal">characterSet</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">);</span>
<span class="normal">	</span><span class="function">CopyToClipboard</span><span class="symbol">(</span><span class="normal">selectedText</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">SetDragPosition</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> newPos</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">newPos </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		newPos </span><span class="symbol">=</span><span class="normal"> </span><span class="function">MovePositionOutsideChar</span><span class="symbol">(</span><span class="normal">newPos</span><span class="symbol">,</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">		posDrop </span><span class="symbol">=</span><span class="normal"> newPos</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">posDrag </span><span class="symbol">!=</span><span class="normal"> newPos</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		caret</span><span class="symbol">.</span><span class="normal">on </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>
<span class="normal">		</span><span class="function">SetTicking</span><span class="symbol">(</span><span class="keyword">true</span><span class="symbol">);</span>
<span class="normal">		</span><span class="function">InvalidateCaret</span><span class="symbol">();</span>
<span class="normal">		posDrag </span><span class="symbol">=</span><span class="normal"> newPos</span><span class="symbol">;</span>
<span class="normal">		</span><span class="function">InvalidateCaret</span><span class="symbol">();</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">DisplayCursor</span><span class="symbol">(</span><span class="normal">Window</span><span class="symbol">::</span><span class="usertype">Cursor</span><span class="normal"> c</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">cursorMode </span><span class="symbol">==</span><span class="normal"> SC_CURSORNORMAL</span><span class="symbol">)</span>
<span class="normal">		wMain</span><span class="symbol">.</span><span class="function">SetCursor</span><span class="symbol">(</span><span class="normal">c</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">else</span>
<span class="normal">		wMain</span><span class="symbol">.</span><span class="function">SetCursor</span><span class="symbol">(</span><span class="keyword">static_cast</span><span class="symbol">&lt;</span><span class="normal">Window</span><span class="symbol">::</span><span class="normal">Cursor</span><span class="symbol">&gt;(</span><span class="normal">cursorMode</span><span class="symbol">));</span>
<span class="cbracket">}</span>

<span class="type">bool</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">DragThreshold</span><span class="symbol">(</span><span class="usertype">Point</span><span class="normal"> ptStart</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">Point</span><span class="normal"> ptNow</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> xMove </span><span class="symbol">=</span><span class="normal"> ptStart</span><span class="symbol">.</span><span class="normal">x </span><span class="symbol">-</span><span class="normal"> ptNow</span><span class="symbol">.</span><span class="normal">x</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> yMove </span><span class="symbol">=</span><span class="normal"> ptStart</span><span class="symbol">.</span><span class="normal">y </span><span class="symbol">-</span><span class="normal"> ptNow</span><span class="symbol">.</span><span class="normal">y</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> distanceSquared </span><span class="symbol">=</span><span class="normal"> xMove </span><span class="symbol">*</span><span class="normal"> xMove </span><span class="symbol">+</span><span class="normal"> yMove </span><span class="symbol">*</span><span class="normal"> yMove</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> distanceSquared </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">16</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">StartDrag</span><span class="symbol">()</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="comment">// Always handled by subclasses</span>
<span class="normal">	</span><span class="comment">//SetMouseCapture(true);</span>
<span class="normal">	</span><span class="comment">//DisplayCursor(Window::cursorArrow);</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">DropAt</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> position</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">value</span><span class="symbol">,</span><span class="normal"> </span><span class="type">bool</span><span class="normal"> moving</span><span class="symbol">,</span><span class="normal"> </span><span class="type">bool</span><span class="normal"> rectangular</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="comment">//Platform::DebugPrintf("DropAt %d %d\n", inDragDrop, position);</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">inDragDrop </span><span class="symbol">==</span><span class="normal"> ddDragging</span><span class="symbol">)</span>
<span class="normal">		dropWentOutside </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>

<span class="normal">	</span><span class="type">int</span><span class="normal"> positionWasInSelection </span><span class="symbol">=</span><span class="normal"> </span><span class="function">PositionInSelection</span><span class="symbol">(</span><span class="normal">position</span><span class="symbol">);</span>

<span class="normal">	</span><span class="type">bool</span><span class="normal"> positionOnEdgeOfSelection </span><span class="symbol">=</span>
<span class="normal">	    </span><span class="symbol">(</span><span class="normal">position </span><span class="symbol">==</span><span class="normal"> </span><span class="function">SelectionStart</span><span class="symbol">())</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">position </span><span class="symbol">==</span><span class="normal"> </span><span class="function">SelectionEnd</span><span class="symbol">());</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">inDragDrop </span><span class="symbol">!=</span><span class="normal"> ddDragging</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> </span><span class="symbol">!(</span><span class="number">0</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> positionWasInSelection</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">||</span>
<span class="normal">	        </span><span class="symbol">(</span><span class="normal">positionOnEdgeOfSelection </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">!</span><span class="normal">moving</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>

<span class="normal">		</span><span class="type">int</span><span class="normal"> selStart </span><span class="symbol">=</span><span class="normal"> </span><span class="function">SelectionStart</span><span class="symbol">();</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> selEnd </span><span class="symbol">=</span><span class="normal"> </span><span class="function">SelectionEnd</span><span class="symbol">();</span>

<span class="normal">		pdoc</span><span class="symbol">-&gt;</span><span class="function">BeginUndoAction</span><span class="symbol">();</span>

<span class="normal">		</span><span class="type">int</span><span class="normal"> positionAfterDeletion </span><span class="symbol">=</span><span class="normal"> position</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">inDragDrop </span><span class="symbol">==</span><span class="normal"> ddDragging</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> moving</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="comment">// Remove dragged out text</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">rectangular </span><span class="symbol">||</span><span class="normal"> selType </span><span class="symbol">==</span><span class="normal"> selLines</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="usertype">SelectionLineIterator</span><span class="normal"> </span><span class="function">lineIterator</span><span class="symbol">(</span><span class="keyword">this</span><span class="symbol">);</span>
<span class="normal">				</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lineIterator</span><span class="symbol">.</span><span class="function">Iterate</span><span class="symbol">())</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">position </span><span class="symbol">&gt;=</span><span class="normal"> lineIterator</span><span class="symbol">.</span><span class="normal">startPos</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">						</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">position </span><span class="symbol">&gt;</span><span class="normal"> lineIterator</span><span class="symbol">.</span><span class="normal">endPos</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">							positionAfterDeletion </span><span class="symbol">-=</span><span class="normal"> lineIterator</span><span class="symbol">.</span><span class="normal">endPos </span><span class="symbol">-</span><span class="normal"> lineIterator</span><span class="symbol">.</span><span class="normal">startPos</span><span class="symbol">;</span>
<span class="normal">						</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">							positionAfterDeletion </span><span class="symbol">-=</span><span class="normal"> position </span><span class="symbol">-</span><span class="normal"> lineIterator</span><span class="symbol">.</span><span class="normal">startPos</span><span class="symbol">;</span>
<span class="normal">						</span><span class="cbracket">}</span>
<span class="normal">					</span><span class="cbracket">}</span>
<span class="normal">				</span><span class="cbracket">}</span>
<span class="normal">			</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">position </span><span class="symbol">&gt;</span><span class="normal"> selStart</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					positionAfterDeletion </span><span class="symbol">-=</span><span class="normal"> selEnd </span><span class="symbol">-</span><span class="normal"> selStart</span><span class="symbol">;</span>
<span class="normal">				</span><span class="cbracket">}</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">			</span><span class="function">ClearSelection</span><span class="symbol">();</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		position </span><span class="symbol">=</span><span class="normal"> positionAfterDeletion</span><span class="symbol">;</span>

<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">rectangular</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="function">PasteRectangular</span><span class="symbol">(</span><span class="normal">position</span><span class="symbol">,</span><span class="normal"> value</span><span class="symbol">,</span><span class="normal"> </span><span class="function">istrlen</span><span class="symbol">(</span><span class="normal">value</span><span class="symbol">));</span>
<span class="normal">			pdoc</span><span class="symbol">-&gt;</span><span class="function">EndUndoAction</span><span class="symbol">();</span>
<span class="normal">			</span><span class="comment">// Should try to select new rectangle but it may not be a rectangle now so just select the drop position</span>
<span class="normal">			</span><span class="function">SetEmptySelection</span><span class="symbol">(</span><span class="normal">position</span><span class="symbol">);</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			position </span><span class="symbol">=</span><span class="normal"> </span><span class="function">MovePositionOutsideChar</span><span class="symbol">(</span><span class="normal">position</span><span class="symbol">,</span><span class="normal"> currentPos </span><span class="symbol">-</span><span class="normal"> position</span><span class="symbol">);</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">InsertCString</span><span class="symbol">(</span><span class="normal">position</span><span class="symbol">,</span><span class="normal"> value</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="function">SetSelection</span><span class="symbol">(</span><span class="normal">position </span><span class="symbol">+</span><span class="normal"> </span><span class="function">istrlen</span><span class="symbol">(</span><span class="normal">value</span><span class="symbol">),</span><span class="normal"> position</span><span class="symbol">);</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">			pdoc</span><span class="symbol">-&gt;</span><span class="function">EndUndoAction</span><span class="symbol">();</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">inDragDrop </span><span class="symbol">==</span><span class="normal"> ddDragging</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">SetEmptySelection</span><span class="symbol">(</span><span class="normal">position</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="comment">/**</span>
<span class="comment"> * </span><span class="type">@return</span><span class="comment"> -1 if given position is before the selection,</span>
<span class="comment"> *          1 if position is after the selection,</span>
<span class="comment"> *          0 if position is inside the selection,</span>
<span class="comment"> */</span>
<span class="type">int</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">PositionInSelection</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> pos</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	pos </span><span class="symbol">=</span><span class="normal"> </span><span class="function">MovePositionOutsideChar</span><span class="symbol">(</span><span class="normal">pos</span><span class="symbol">,</span><span class="normal"> currentPos </span><span class="symbol">-</span><span class="normal"> pos</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pos </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="function">SelectionStart</span><span class="symbol">())</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pos </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="function">SelectionEnd</span><span class="symbol">())</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">selType </span><span class="symbol">==</span><span class="normal"> selStream</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="usertype">SelectionLineIterator</span><span class="normal"> </span><span class="function">lineIterator</span><span class="symbol">(</span><span class="keyword">this</span><span class="symbol">);</span>
<span class="normal">		lineIterator</span><span class="symbol">.</span><span class="function">SetAt</span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">LineFromPosition</span><span class="symbol">(</span><span class="normal">pos</span><span class="symbol">));</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pos </span><span class="symbol">&lt;</span><span class="normal"> lineIterator</span><span class="symbol">.</span><span class="normal">startPos</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pos </span><span class="symbol">&gt;</span><span class="normal"> lineIterator</span><span class="symbol">.</span><span class="normal">endPos</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="type">bool</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">PointInSelection</span><span class="symbol">(</span><span class="usertype">Point</span><span class="normal"> pt</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> pos </span><span class="symbol">=</span><span class="normal"> </span><span class="function">PositionFromLocation</span><span class="symbol">(</span><span class="normal">pt</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="number">0</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="function">PositionInSelection</span><span class="symbol">(</span><span class="normal">pos</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="comment">// Probably inside, but we must make a finer test</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> selStart</span><span class="symbol">,</span><span class="normal"> selEnd</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">selType </span><span class="symbol">==</span><span class="normal"> selStream</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			selStart </span><span class="symbol">=</span><span class="normal"> </span><span class="function">SelectionStart</span><span class="symbol">();</span>
<span class="normal">			selEnd </span><span class="symbol">=</span><span class="normal"> </span><span class="function">SelectionEnd</span><span class="symbol">();</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="usertype">SelectionLineIterator</span><span class="normal"> </span><span class="function">lineIterator</span><span class="symbol">(</span><span class="keyword">this</span><span class="symbol">);</span>
<span class="normal">			lineIterator</span><span class="symbol">.</span><span class="function">SetAt</span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">LineFromPosition</span><span class="symbol">(</span><span class="normal">pos</span><span class="symbol">));</span>
<span class="normal">			selStart </span><span class="symbol">=</span><span class="normal"> lineIterator</span><span class="symbol">.</span><span class="normal">startPos</span><span class="symbol">;</span>
<span class="normal">			selEnd </span><span class="symbol">=</span><span class="normal"> lineIterator</span><span class="symbol">.</span><span class="normal">endPos</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pos </span><span class="symbol">==</span><span class="normal"> selStart</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="comment">// see if just before selection</span>
<span class="normal">			</span><span class="usertype">Point</span><span class="normal"> locStart </span><span class="symbol">=</span><span class="normal"> </span><span class="function">LocationFromPosition</span><span class="symbol">(</span><span class="normal">pos</span><span class="symbol">);</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pt</span><span class="symbol">.</span><span class="normal">x </span><span class="symbol">&lt;</span><span class="normal"> locStart</span><span class="symbol">.</span><span class="normal">x</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="keyword">return</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pos </span><span class="symbol">==</span><span class="normal"> selEnd</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="comment">// see if just after selection</span>
<span class="normal">			</span><span class="usertype">Point</span><span class="normal"> locEnd </span><span class="symbol">=</span><span class="normal"> </span><span class="function">LocationFromPosition</span><span class="symbol">(</span><span class="normal">pos</span><span class="symbol">);</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pt</span><span class="symbol">.</span><span class="normal">x </span><span class="symbol">&gt;</span><span class="normal"> locEnd</span><span class="symbol">.</span><span class="normal">x</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="keyword">return</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="type">bool</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">PointInSelMargin</span><span class="symbol">(</span><span class="usertype">Point</span><span class="normal"> pt</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="comment">// Really means: "Point in a margin"</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vs</span><span class="symbol">.</span><span class="normal">fixedColumnWidth </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal">	</span><span class="comment">// There is a margin</span>
<span class="normal">		</span><span class="usertype">PRectangle</span><span class="normal"> rcSelMargin </span><span class="symbol">=</span><span class="normal"> </span><span class="function">GetClientRectangle</span><span class="symbol">();</span>
<span class="normal">		rcSelMargin</span><span class="symbol">.</span><span class="normal">right </span><span class="symbol">=</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">fixedColumnWidth </span><span class="symbol">-</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">leftMarginWidth</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> rcSelMargin</span><span class="symbol">.</span><span class="function">Contains</span><span class="symbol">(</span><span class="normal">pt</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">LineSelection</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> lineCurrent_</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> lineAnchor_</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lineAnchor_ </span><span class="symbol">&lt;</span><span class="normal"> lineCurrent_</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">SetSelection</span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">lineCurrent_ </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">),</span>
<span class="normal">		        pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">lineAnchor_</span><span class="symbol">));</span>
<span class="normal">	</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lineAnchor_ </span><span class="symbol">&gt;</span><span class="normal"> lineCurrent_</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">SetSelection</span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">lineCurrent_</span><span class="symbol">),</span>
<span class="normal">		        pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">lineAnchor_ </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">));</span>
<span class="normal">	</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal"> </span><span class="comment">// Same line, select it</span>
<span class="normal">		</span><span class="function">SetSelection</span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">lineAnchor_ </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">),</span>
<span class="normal">		        pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">lineAnchor_</span><span class="symbol">));</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">DwellEnd</span><span class="symbol">(</span><span class="type">bool</span><span class="normal"> mouseMoved</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">mouseMoved</span><span class="symbol">)</span>
<span class="normal">		ticksToDwell </span><span class="symbol">=</span><span class="normal"> dwellDelay</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">else</span>
<span class="normal">		ticksToDwell </span><span class="symbol">=</span><span class="normal"> SC_TIME_FOREVER</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dwelling </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dwellDelay </span><span class="symbol">&lt;</span><span class="normal"> SC_TIME_FOREVER</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		dwelling </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="normal">		</span><span class="function">NotifyDwelling</span><span class="symbol">(</span><span class="normal">ptMouseLast</span><span class="symbol">,</span><span class="normal"> dwelling</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">ButtonDown</span><span class="symbol">(</span><span class="usertype">Point</span><span class="normal"> pt</span><span class="symbol">,</span><span class="normal"> </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> curTime</span><span class="symbol">,</span><span class="normal"> </span><span class="type">bool</span><span class="normal"> shift</span><span class="symbol">,</span><span class="normal"> </span><span class="type">bool</span><span class="normal"> ctrl</span><span class="symbol">,</span><span class="normal"> </span><span class="type">bool</span><span class="normal"> alt</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="comment">//Platform::DebugPrintf("ButtonDown %d %d = %d alt=%d %d\n", curTime, lastClickTime, curTime - lastClickTime, alt, inDragDrop);</span>
<span class="normal">	ptMouseLast </span><span class="symbol">=</span><span class="normal"> pt</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> newPos </span><span class="symbol">=</span><span class="normal"> </span><span class="function">PositionFromLocation</span><span class="symbol">(</span><span class="normal">pt</span><span class="symbol">);</span>
<span class="normal">	newPos </span><span class="symbol">=</span><span class="normal"> </span><span class="function">MovePositionOutsideChar</span><span class="symbol">(</span><span class="normal">newPos</span><span class="symbol">,</span><span class="normal"> currentPos </span><span class="symbol">-</span><span class="normal"> newPos</span><span class="symbol">);</span>
<span class="normal">	inDragDrop </span><span class="symbol">=</span><span class="normal"> ddNone</span><span class="symbol">;</span>
<span class="normal">	moveExtendsSelection </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>

<span class="normal">	</span><span class="type">bool</span><span class="normal"> processed </span><span class="symbol">=</span><span class="normal"> </span><span class="function">NotifyMarginClick</span><span class="symbol">(</span><span class="normal">pt</span><span class="symbol">,</span><span class="normal"> shift</span><span class="symbol">,</span><span class="normal"> ctrl</span><span class="symbol">,</span><span class="normal"> alt</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">processed</span><span class="symbol">)</span>
<span class="normal">		</span><span class="keyword">return</span><span class="symbol">;</span>

<span class="normal">	</span><span class="function">NotifyIndicatorClick</span><span class="symbol">(</span><span class="keyword">true</span><span class="symbol">,</span><span class="normal"> newPos</span><span class="symbol">,</span><span class="normal"> shift</span><span class="symbol">,</span><span class="normal"> ctrl</span><span class="symbol">,</span><span class="normal"> alt</span><span class="symbol">);</span>

<span class="normal">	</span><span class="type">bool</span><span class="normal"> inSelMargin </span><span class="symbol">=</span><span class="normal"> </span><span class="function">PointInSelMargin</span><span class="symbol">(</span><span class="normal">pt</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">shift </span><span class="symbol">&amp;</span><span class="normal"> </span><span class="symbol">!</span><span class="normal">inSelMargin</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">SetSelection</span><span class="symbol">(</span><span class="normal">newPos</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(((</span><span class="normal">curTime </span><span class="symbol">-</span><span class="normal"> lastClickTime</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&lt;</span><span class="normal"> Platform</span><span class="symbol">::</span><span class="function">DoubleClickTime</span><span class="symbol">())</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="function">Close</span><span class="symbol">(</span><span class="normal">pt</span><span class="symbol">,</span><span class="normal"> lastClick</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="comment">//Platform::DebugPrintf("Double click %d %d = %d\n", curTime, lastClickTime, curTime - lastClickTime);</span>
<span class="normal">		</span><span class="function">SetMouseCapture</span><span class="symbol">(</span><span class="keyword">true</span><span class="symbol">);</span>
<span class="normal">		</span><span class="function">SetEmptySelection</span><span class="symbol">(</span><span class="normal">newPos</span><span class="symbol">);</span>
<span class="normal">		</span><span class="type">bool</span><span class="normal"> doubleClick </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="normal">		</span><span class="comment">// Stop mouse button bounce changing selection type</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">Platform</span><span class="symbol">::</span><span class="function">MouseButtonBounce</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> curTime </span><span class="symbol">!=</span><span class="normal"> lastClickTime</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">selectionType </span><span class="symbol">==</span><span class="normal"> selChar</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				selectionType </span><span class="symbol">=</span><span class="normal"> selWord</span><span class="symbol">;</span>
<span class="normal">				doubleClick </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>
<span class="normal">			</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">selectionType </span><span class="symbol">==</span><span class="normal"> selWord</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				selectionType </span><span class="symbol">=</span><span class="normal"> selLine</span><span class="symbol">;</span>
<span class="normal">			</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				selectionType </span><span class="symbol">=</span><span class="normal"> selChar</span><span class="symbol">;</span>
<span class="normal">				originalAnchorPos </span><span class="symbol">=</span><span class="normal"> currentPos</span><span class="symbol">;</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span>

<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">selectionType </span><span class="symbol">==</span><span class="normal"> selWord</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">currentPos </span><span class="symbol">&gt;=</span><span class="normal"> originalAnchorPos</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal">	</span><span class="comment">// Moved forward</span>
<span class="normal">				</span><span class="function">SetSelection</span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">ExtendWordSelect</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">,</span><span class="normal"> </span><span class="number">1</span><span class="symbol">),</span>
<span class="normal">				        pdoc</span><span class="symbol">-&gt;</span><span class="function">ExtendWordSelect</span><span class="symbol">(</span><span class="normal">originalAnchorPos</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">));</span>
<span class="normal">			</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal">	</span><span class="comment">// Moved backward</span>
<span class="normal">				</span><span class="function">SetSelection</span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">ExtendWordSelect</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">),</span>
<span class="normal">				        pdoc</span><span class="symbol">-&gt;</span><span class="function">ExtendWordSelect</span><span class="symbol">(</span><span class="normal">originalAnchorPos</span><span class="symbol">,</span><span class="normal"> </span><span class="number">1</span><span class="symbol">));</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">selectionType </span><span class="symbol">==</span><span class="normal"> selLine</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			lineAnchor </span><span class="symbol">=</span><span class="normal"> </span><span class="function">LineFromLocation</span><span class="symbol">(</span><span class="normal">pt</span><span class="symbol">);</span>
<span class="normal">			</span><span class="function">SetSelection</span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">lineAnchor </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">),</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">lineAnchor</span><span class="symbol">));</span>
<span class="normal">			</span><span class="comment">//Platform::DebugPrintf("Triple click: %d - %d\n", anchor, currentPos);</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="function">SetEmptySelection</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">);</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="comment">//Platform::DebugPrintf("Double click: %d - %d\n", anchor, currentPos);</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">doubleClick</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="function">NotifyDoubleClick</span><span class="symbol">(</span><span class="normal">pt</span><span class="symbol">,</span><span class="normal"> shift</span><span class="symbol">,</span><span class="normal"> ctrl</span><span class="symbol">,</span><span class="normal"> alt</span><span class="symbol">);</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">PositionIsHotspot</span><span class="symbol">(</span><span class="normal">newPos</span><span class="symbol">))</span>
<span class="normal">				</span><span class="function">NotifyHotSpotDoubleClicked</span><span class="symbol">(</span><span class="normal">newPos</span><span class="symbol">,</span><span class="normal"> shift</span><span class="symbol">,</span><span class="normal"> ctrl</span><span class="symbol">,</span><span class="normal"> alt</span><span class="symbol">);</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal">	</span><span class="comment">// Single click</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">inSelMargin</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			selType </span><span class="symbol">=</span><span class="normal"> selStream</span><span class="symbol">;</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ctrl</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="function">SelectAll</span><span class="symbol">();</span>
<span class="normal">				lastClickTime </span><span class="symbol">=</span><span class="normal"> curTime</span><span class="symbol">;</span>
<span class="normal">				</span><span class="keyword">return</span><span class="symbol">;</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">shift</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				lineAnchor </span><span class="symbol">=</span><span class="normal"> </span><span class="function">LineFromLocation</span><span class="symbol">(</span><span class="normal">pt</span><span class="symbol">);</span>
<span class="normal">				</span><span class="comment">// Single click in margin: select whole line</span>
<span class="normal">				</span><span class="function">LineSelection</span><span class="symbol">(</span><span class="normal">lineAnchor</span><span class="symbol">,</span><span class="normal"> lineAnchor</span><span class="symbol">);</span>
<span class="normal">				</span><span class="function">SetSelection</span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">lineAnchor </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">),</span>
<span class="normal">				        pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">lineAnchor</span><span class="symbol">));</span>
<span class="normal">			</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="comment">// Single shift+click in margin: select from line anchor to clicked line</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">anchor </span><span class="symbol">&gt;</span><span class="normal"> currentPos</span><span class="symbol">)</span>
<span class="normal">					lineAnchor </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineFromPosition</span><span class="symbol">(</span><span class="normal">anchor </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">				</span><span class="keyword">else</span>
<span class="normal">					lineAnchor </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineFromPosition</span><span class="symbol">(</span><span class="normal">anchor</span><span class="symbol">);</span>
<span class="normal">				</span><span class="type">int</span><span class="normal"> lineStart </span><span class="symbol">=</span><span class="normal"> </span><span class="function">LineFromLocation</span><span class="symbol">(</span><span class="normal">pt</span><span class="symbol">);</span>
<span class="normal">				</span><span class="function">LineSelection</span><span class="symbol">(</span><span class="normal">lineStart</span><span class="symbol">,</span><span class="normal"> lineAnchor</span><span class="symbol">);</span>
<span class="normal">				</span><span class="comment">//lineAnchor = lineStart; // Keep the same anchor for ButtonMove</span>
<span class="normal">			</span><span class="cbracket">}</span>

<span class="normal">			</span><span class="function">SetDragPosition</span><span class="symbol">(</span><span class="normal">invalidPosition</span><span class="symbol">);</span>
<span class="normal">			</span><span class="function">SetMouseCapture</span><span class="symbol">(</span><span class="keyword">true</span><span class="symbol">);</span>
<span class="normal">			selectionType </span><span class="symbol">=</span><span class="normal"> selLine</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">PointIsHotspot</span><span class="symbol">(</span><span class="normal">pt</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="function">NotifyHotSpotClicked</span><span class="symbol">(</span><span class="normal">newPos</span><span class="symbol">,</span><span class="normal"> shift</span><span class="symbol">,</span><span class="normal"> ctrl</span><span class="symbol">,</span><span class="normal"> alt</span><span class="symbol">);</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">shift</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">PointInSelection</span><span class="symbol">(</span><span class="normal">pt</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">!</span><span class="function">SelectionEmpty</span><span class="symbol">())</span>
<span class="normal">					inDragDrop </span><span class="symbol">=</span><span class="normal"> ddInitial</span><span class="symbol">;</span>
<span class="normal">				</span><span class="keyword">else</span>
<span class="normal">					inDragDrop </span><span class="symbol">=</span><span class="normal"> ddNone</span><span class="symbol">;</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">			</span><span class="function">SetMouseCapture</span><span class="symbol">(</span><span class="keyword">true</span><span class="symbol">);</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">inDragDrop </span><span class="symbol">!=</span><span class="normal"> ddInitial</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="function">SetDragPosition</span><span class="symbol">(</span><span class="normal">invalidPosition</span><span class="symbol">);</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">shift</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="function">SetEmptySelection</span><span class="symbol">(</span><span class="normal">newPos</span><span class="symbol">);</span>
<span class="normal">				</span><span class="cbracket">}</span>
<span class="normal">				selType </span><span class="symbol">=</span><span class="normal"> alt </span><span class="symbol">?</span><span class="normal"> selRectangle </span><span class="symbol">:</span><span class="normal"> selStream</span><span class="symbol">;</span>
<span class="normal">				selectionType </span><span class="symbol">=</span><span class="normal"> selChar</span><span class="symbol">;</span>
<span class="normal">				originalAnchorPos </span><span class="symbol">=</span><span class="normal"> currentPos</span><span class="symbol">;</span>
<span class="normal">				</span><span class="function">SetRectangularRange</span><span class="symbol">();</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	lastClickTime </span><span class="symbol">=</span><span class="normal"> curTime</span><span class="symbol">;</span>
<span class="normal">	lastXChosen </span><span class="symbol">=</span><span class="normal"> pt</span><span class="symbol">.</span><span class="normal">x</span><span class="symbol">;</span>
<span class="normal">	</span><span class="function">ShowCaretAtCurrentPosition</span><span class="symbol">();</span>
<span class="cbracket">}</span>

<span class="type">bool</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">PositionIsHotspot</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> position</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">StyleAt</span><span class="symbol">(</span><span class="normal">position</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="normal">stylingBitsMask</span><span class="symbol">].</span><span class="normal">hotspot</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="type">bool</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">PointIsHotspot</span><span class="symbol">(</span><span class="usertype">Point</span><span class="normal"> pt</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> pos </span><span class="symbol">=</span><span class="normal"> </span><span class="function">PositionFromLocation</span><span class="symbol">(</span><span class="normal">pt</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pos </span><span class="symbol">==</span><span class="normal"> INVALID_POSITION</span><span class="symbol">)</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="function">PositionIsHotspot</span><span class="symbol">(</span><span class="normal">pos</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">SetHotSpotRange</span><span class="symbol">(</span><span class="usertype">Point</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">pt</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pt</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> pos </span><span class="symbol">=</span><span class="normal"> </span><span class="function">PositionFromLocation</span><span class="symbol">(*</span><span class="normal">pt</span><span class="symbol">);</span>

<span class="normal">		</span><span class="comment">// If we don't limit this to word characters then the</span>
<span class="normal">		</span><span class="comment">// range can encompass more than the run range and then</span>
<span class="normal">		</span><span class="comment">// the underline will not be drawn properly.</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> hsStart_ </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">ExtendStyleRange</span><span class="symbol">(</span><span class="normal">pos</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">hotspotSingleLine</span><span class="symbol">);</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> hsEnd_ </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">ExtendStyleRange</span><span class="symbol">(</span><span class="normal">pos</span><span class="symbol">,</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">hotspotSingleLine</span><span class="symbol">);</span>

<span class="normal">		</span><span class="comment">// Only invalidate the range if the hotspot range has changed...</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">hsStart_ </span><span class="symbol">!=</span><span class="normal"> hsStart </span><span class="symbol">||</span><span class="normal"> hsEnd_ </span><span class="symbol">!=</span><span class="normal"> hsEnd</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">hsStart </span><span class="symbol">!=</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="function">InvalidateRange</span><span class="symbol">(</span><span class="normal">hsStart</span><span class="symbol">,</span><span class="normal"> hsEnd</span><span class="symbol">);</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">			hsStart </span><span class="symbol">=</span><span class="normal"> hsStart_</span><span class="symbol">;</span>
<span class="normal">			hsEnd </span><span class="symbol">=</span><span class="normal"> hsEnd_</span><span class="symbol">;</span>
<span class="normal">			</span><span class="function">InvalidateRange</span><span class="symbol">(</span><span class="normal">hsStart</span><span class="symbol">,</span><span class="normal"> hsEnd</span><span class="symbol">);</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">hsStart </span><span class="symbol">!=</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> hsStart_ </span><span class="symbol">=</span><span class="normal"> hsStart</span><span class="symbol">;</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> hsEnd_ </span><span class="symbol">=</span><span class="normal"> hsEnd</span><span class="symbol">;</span>
<span class="normal">			hsStart </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">			hsEnd </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">			</span><span class="function">InvalidateRange</span><span class="symbol">(</span><span class="normal">hsStart_</span><span class="symbol">,</span><span class="normal"> hsEnd_</span><span class="symbol">);</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			hsStart </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">			hsEnd </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">GetHotSpotRange</span><span class="symbol">(</span><span class="type">int</span><span class="symbol">&amp;</span><span class="normal"> hsStart_</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="symbol">&amp;</span><span class="normal"> hsEnd_</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	hsStart_ </span><span class="symbol">=</span><span class="normal"> hsStart</span><span class="symbol">;</span>
<span class="normal">	hsEnd_ </span><span class="symbol">=</span><span class="normal"> hsEnd</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">ButtonMove</span><span class="symbol">(</span><span class="usertype">Point</span><span class="normal"> pt</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">ptMouseLast</span><span class="symbol">.</span><span class="normal">x </span><span class="symbol">!=</span><span class="normal"> pt</span><span class="symbol">.</span><span class="normal">x</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ptMouseLast</span><span class="symbol">.</span><span class="normal">y </span><span class="symbol">!=</span><span class="normal"> pt</span><span class="symbol">.</span><span class="normal">y</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">DwellEnd</span><span class="symbol">(</span><span class="keyword">true</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="type">int</span><span class="normal"> movePos </span><span class="symbol">=</span><span class="normal"> </span><span class="function">PositionFromLocation</span><span class="symbol">(</span><span class="normal">pt</span><span class="symbol">);</span>
<span class="normal">	movePos </span><span class="symbol">=</span><span class="normal"> </span><span class="function">MovePositionOutsideChar</span><span class="symbol">(</span><span class="normal">movePos</span><span class="symbol">,</span><span class="normal"> currentPos </span><span class="symbol">-</span><span class="normal"> movePos</span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">inDragDrop </span><span class="symbol">==</span><span class="normal"> ddInitial</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">DragThreshold</span><span class="symbol">(</span><span class="normal">ptMouseLast</span><span class="symbol">,</span><span class="normal"> pt</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="function">SetMouseCapture</span><span class="symbol">(</span><span class="keyword">false</span><span class="symbol">);</span>
<span class="normal">			</span><span class="function">SetDragPosition</span><span class="symbol">(</span><span class="normal">movePos</span><span class="symbol">);</span>
<span class="normal">			</span><span class="function">CopySelectionRange</span><span class="symbol">(&amp;</span><span class="normal">drag</span><span class="symbol">);</span>
<span class="normal">			</span><span class="function">StartDrag</span><span class="symbol">();</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">return</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	ptMouseLast </span><span class="symbol">=</span><span class="normal"> pt</span><span class="symbol">;</span>
<span class="normal">	</span><span class="comment">//Platform::DebugPrintf("Move %d %d\n", pt.x, pt.y);</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">HaveMouseCapture</span><span class="symbol">())</span><span class="normal"> </span><span class="cbracket">{</span>

<span class="normal">		</span><span class="comment">// Slow down autoscrolling/selection</span>
<span class="normal">		autoScrollTimer</span><span class="symbol">.</span><span class="normal">ticksToWait </span><span class="symbol">-=</span><span class="normal"> timer</span><span class="symbol">.</span><span class="normal">tickSize</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">autoScrollTimer</span><span class="symbol">.</span><span class="normal">ticksToWait </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">			</span><span class="keyword">return</span><span class="symbol">;</span>
<span class="normal">		autoScrollTimer</span><span class="symbol">.</span><span class="normal">ticksToWait </span><span class="symbol">=</span><span class="normal"> autoScrollDelay</span><span class="symbol">;</span>

<span class="normal">		</span><span class="comment">// Adjust selection</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">posDrag </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="function">SetDragPosition</span><span class="symbol">(</span><span class="normal">movePos</span><span class="symbol">);</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">selectionType </span><span class="symbol">==</span><span class="normal"> selChar</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="function">SetSelection</span><span class="symbol">(</span><span class="normal">movePos</span><span class="symbol">);</span>
<span class="normal">			</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">selectionType </span><span class="symbol">==</span><span class="normal"> selWord</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="comment">// Continue selecting by word</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">movePos </span><span class="symbol">==</span><span class="normal"> originalAnchorPos</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal">	</span><span class="comment">// Didn't move</span>
<span class="normal">					</span><span class="comment">// No need to do anything. Previously this case was lumped</span>
<span class="normal">					</span><span class="comment">// in with "Moved forward", but that can be harmful in this</span>
<span class="normal">					</span><span class="comment">// case: a handler for the NotifyDoubleClick re-adjusts</span>
<span class="normal">					</span><span class="comment">// the selection for a fancier definition of "word" (for</span>
<span class="normal">					</span><span class="comment">// example, in Perl it is useful to include the leading</span>
<span class="normal">					</span><span class="comment">// '$', '%' or '@' on variables for word selection). In this</span>
<span class="normal">					</span><span class="comment">// the ButtonMove() called via Tick() for auto-scrolling</span>
<span class="normal">					</span><span class="comment">// could result in the fancier word selection adjustment</span>
<span class="normal">					</span><span class="comment">// being unmade.</span>
<span class="normal">				</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">movePos </span><span class="symbol">&gt;</span><span class="normal"> originalAnchorPos</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal">	</span><span class="comment">// Moved forward</span>
<span class="normal">					</span><span class="function">SetSelection</span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">ExtendWordSelect</span><span class="symbol">(</span><span class="normal">movePos</span><span class="symbol">,</span><span class="normal"> </span><span class="number">1</span><span class="symbol">),</span>
<span class="normal">					        pdoc</span><span class="symbol">-&gt;</span><span class="function">ExtendWordSelect</span><span class="symbol">(</span><span class="normal">originalAnchorPos</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">));</span>
<span class="normal">				</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal">	</span><span class="comment">// Moved backward</span>
<span class="normal">					</span><span class="function">SetSelection</span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">ExtendWordSelect</span><span class="symbol">(</span><span class="normal">movePos</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">),</span>
<span class="normal">					        pdoc</span><span class="symbol">-&gt;</span><span class="function">ExtendWordSelect</span><span class="symbol">(</span><span class="normal">originalAnchorPos</span><span class="symbol">,</span><span class="normal"> </span><span class="number">1</span><span class="symbol">));</span>
<span class="normal">				</span><span class="cbracket">}</span>
<span class="normal">			</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="comment">// Continue selecting by line</span>
<span class="normal">				</span><span class="type">int</span><span class="normal"> lineMove </span><span class="symbol">=</span><span class="normal"> </span><span class="function">LineFromLocation</span><span class="symbol">(</span><span class="normal">pt</span><span class="symbol">);</span>
<span class="normal">				</span><span class="function">LineSelection</span><span class="symbol">(</span><span class="normal">lineMove</span><span class="symbol">,</span><span class="normal"> lineAnchor</span><span class="symbol">);</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="comment">// While dragging to make rectangular selection, we don't want the current</span>
<span class="normal">		</span><span class="comment">// position to jump to the end of smaller or empty lines.</span>
<span class="normal">		</span><span class="comment">//xEndSelect = pt.x - vs.fixedColumnWidth + xOffset;</span>
<span class="normal">		xEndSelect </span><span class="symbol">=</span><span class="normal"> </span><span class="function">XFromPosition</span><span class="symbol">(</span><span class="normal">movePos</span><span class="symbol">);</span>

<span class="normal">		</span><span class="comment">// Autoscroll</span>
<span class="normal">		</span><span class="usertype">PRectangle</span><span class="normal"> rcClient </span><span class="symbol">=</span><span class="normal"> </span><span class="function">GetClientRectangle</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pt</span><span class="symbol">.</span><span class="normal">y </span><span class="symbol">&gt;</span><span class="normal"> rcClient</span><span class="symbol">.</span><span class="normal">bottom</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> lineMove </span><span class="symbol">=</span><span class="normal"> cs</span><span class="symbol">.</span><span class="function">DisplayFromDoc</span><span class="symbol">(</span><span class="function">LineFromLocation</span><span class="symbol">(</span><span class="normal">pt</span><span class="symbol">));</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lineMove </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				lineMove </span><span class="symbol">=</span><span class="normal"> cs</span><span class="symbol">.</span><span class="function">DisplayFromDoc</span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">LinesTotal</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">			</span><span class="function">ScrollTo</span><span class="symbol">(</span><span class="normal">lineMove </span><span class="symbol">-</span><span class="normal"> </span><span class="function">LinesOnScreen</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">			</span><span class="function">Redraw</span><span class="symbol">();</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pt</span><span class="symbol">.</span><span class="normal">y </span><span class="symbol">&lt;</span><span class="normal"> rcClient</span><span class="symbol">.</span><span class="normal">top</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> lineMove </span><span class="symbol">=</span><span class="normal"> cs</span><span class="symbol">.</span><span class="function">DisplayFromDoc</span><span class="symbol">(</span><span class="function">LineFromLocation</span><span class="symbol">(</span><span class="normal">pt</span><span class="symbol">));</span>
<span class="normal">			</span><span class="function">ScrollTo</span><span class="symbol">(</span><span class="normal">lineMove </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">			</span><span class="function">Redraw</span><span class="symbol">();</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="function">EnsureCaretVisible</span><span class="symbol">(</span><span class="keyword">false</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">);</span>

<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">hsStart </span><span class="symbol">!=</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">!</span><span class="function">PositionIsHotspot</span><span class="symbol">(</span><span class="normal">movePos</span><span class="symbol">))</span>
<span class="normal">			</span><span class="function">SetHotSpotRange</span><span class="symbol">(</span><span class="normal">NULL</span><span class="symbol">);</span>

<span class="normal">	</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vs</span><span class="symbol">.</span><span class="normal">fixedColumnWidth </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal">	</span><span class="comment">// There is a margin</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">PointInSelMargin</span><span class="symbol">(</span><span class="normal">pt</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="function">DisplayCursor</span><span class="symbol">(</span><span class="normal">Window</span><span class="symbol">::</span><span class="normal">cursorReverseArrow</span><span class="symbol">);</span>
<span class="normal">				</span><span class="keyword">return</span><span class="symbol">;</span><span class="normal"> 	</span><span class="comment">// No need to test for selection</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="comment">// Display regular (drag) cursor over selection</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">PointInSelection</span><span class="symbol">(</span><span class="normal">pt</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">!</span><span class="function">SelectionEmpty</span><span class="symbol">())</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="function">DisplayCursor</span><span class="symbol">(</span><span class="normal">Window</span><span class="symbol">::</span><span class="normal">cursorArrow</span><span class="symbol">);</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">PointIsHotspot</span><span class="symbol">(</span><span class="normal">pt</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="function">DisplayCursor</span><span class="symbol">(</span><span class="normal">Window</span><span class="symbol">::</span><span class="normal">cursorHand</span><span class="symbol">);</span>
<span class="normal">			</span><span class="function">SetHotSpotRange</span><span class="symbol">(&amp;</span><span class="normal">pt</span><span class="symbol">);</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="function">DisplayCursor</span><span class="symbol">(</span><span class="normal">Window</span><span class="symbol">::</span><span class="normal">cursorText</span><span class="symbol">);</span>
<span class="normal">			</span><span class="function">SetHotSpotRange</span><span class="symbol">(</span><span class="normal">NULL</span><span class="symbol">);</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">ButtonUp</span><span class="symbol">(</span><span class="usertype">Point</span><span class="normal"> pt</span><span class="symbol">,</span><span class="normal"> </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> curTime</span><span class="symbol">,</span><span class="normal"> </span><span class="type">bool</span><span class="normal"> ctrl</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="comment">//Platform::DebugPrintf("ButtonUp %d %d\n", HaveMouseCapture(), inDragDrop);</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> newPos </span><span class="symbol">=</span><span class="normal"> </span><span class="function">PositionFromLocation</span><span class="symbol">(</span><span class="normal">pt</span><span class="symbol">);</span>
<span class="normal">	newPos </span><span class="symbol">=</span><span class="normal"> </span><span class="function">MovePositionOutsideChar</span><span class="symbol">(</span><span class="normal">newPos</span><span class="symbol">,</span><span class="normal"> currentPos </span><span class="symbol">-</span><span class="normal"> newPos</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">inDragDrop </span><span class="symbol">==</span><span class="normal"> ddInitial</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		inDragDrop </span><span class="symbol">=</span><span class="normal"> ddNone</span><span class="symbol">;</span>
<span class="normal">		</span><span class="function">SetEmptySelection</span><span class="symbol">(</span><span class="normal">newPos</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">HaveMouseCapture</span><span class="symbol">())</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">PointInSelMargin</span><span class="symbol">(</span><span class="normal">pt</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="function">DisplayCursor</span><span class="symbol">(</span><span class="normal">Window</span><span class="symbol">::</span><span class="normal">cursorReverseArrow</span><span class="symbol">);</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="function">DisplayCursor</span><span class="symbol">(</span><span class="normal">Window</span><span class="symbol">::</span><span class="normal">cursorText</span><span class="symbol">);</span>
<span class="normal">			</span><span class="function">SetHotSpotRange</span><span class="symbol">(</span><span class="normal">NULL</span><span class="symbol">);</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		ptMouseLast </span><span class="symbol">=</span><span class="normal"> pt</span><span class="symbol">;</span>
<span class="normal">		</span><span class="function">SetMouseCapture</span><span class="symbol">(</span><span class="keyword">false</span><span class="symbol">);</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> newPos </span><span class="symbol">=</span><span class="normal"> </span><span class="function">PositionFromLocation</span><span class="symbol">(</span><span class="normal">pt</span><span class="symbol">);</span>
<span class="normal">		newPos </span><span class="symbol">=</span><span class="normal"> </span><span class="function">MovePositionOutsideChar</span><span class="symbol">(</span><span class="normal">newPos</span><span class="symbol">,</span><span class="normal"> currentPos </span><span class="symbol">-</span><span class="normal"> newPos</span><span class="symbol">);</span>
<span class="normal">		</span><span class="function">NotifyIndicatorClick</span><span class="symbol">(</span><span class="keyword">false</span><span class="symbol">,</span><span class="normal"> newPos</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">inDragDrop </span><span class="symbol">==</span><span class="normal"> ddDragging</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> selStart </span><span class="symbol">=</span><span class="normal"> </span><span class="function">SelectionStart</span><span class="symbol">();</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> selEnd </span><span class="symbol">=</span><span class="normal"> </span><span class="function">SelectionEnd</span><span class="symbol">();</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">selStart </span><span class="symbol">&lt;</span><span class="normal"> selEnd</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">drag</span><span class="symbol">.</span><span class="normal">len</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ctrl</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">						</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">InsertString</span><span class="symbol">(</span><span class="normal">newPos</span><span class="symbol">,</span><span class="normal"> drag</span><span class="symbol">.</span><span class="normal">s</span><span class="symbol">,</span><span class="normal"> drag</span><span class="symbol">.</span><span class="normal">len</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">							</span><span class="function">SetSelection</span><span class="symbol">(</span><span class="normal">newPos</span><span class="symbol">,</span><span class="normal"> newPos </span><span class="symbol">+</span><span class="normal"> drag</span><span class="symbol">.</span><span class="normal">len</span><span class="symbol">);</span>
<span class="normal">						</span><span class="cbracket">}</span>
<span class="normal">					</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">newPos </span><span class="symbol">&lt;</span><span class="normal"> selStart</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">						pdoc</span><span class="symbol">-&gt;</span><span class="function">DeleteChars</span><span class="symbol">(</span><span class="normal">selStart</span><span class="symbol">,</span><span class="normal"> drag</span><span class="symbol">.</span><span class="normal">len</span><span class="symbol">);</span>
<span class="normal">						</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">InsertString</span><span class="symbol">(</span><span class="normal">newPos</span><span class="symbol">,</span><span class="normal"> drag</span><span class="symbol">.</span><span class="normal">s</span><span class="symbol">,</span><span class="normal"> drag</span><span class="symbol">.</span><span class="normal">len</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">							</span><span class="function">SetSelection</span><span class="symbol">(</span><span class="normal">newPos</span><span class="symbol">,</span><span class="normal"> newPos </span><span class="symbol">+</span><span class="normal"> drag</span><span class="symbol">.</span><span class="normal">len</span><span class="symbol">);</span>
<span class="normal">						</span><span class="cbracket">}</span>
<span class="normal">					</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">newPos </span><span class="symbol">&gt;</span><span class="normal"> selEnd</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">						pdoc</span><span class="symbol">-&gt;</span><span class="function">DeleteChars</span><span class="symbol">(</span><span class="normal">selStart</span><span class="symbol">,</span><span class="normal"> drag</span><span class="symbol">.</span><span class="normal">len</span><span class="symbol">);</span>
<span class="normal">						newPos </span><span class="symbol">-=</span><span class="normal"> drag</span><span class="symbol">.</span><span class="normal">len</span><span class="symbol">;</span>
<span class="normal">						</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">InsertString</span><span class="symbol">(</span><span class="normal">newPos</span><span class="symbol">,</span><span class="normal"> drag</span><span class="symbol">.</span><span class="normal">s</span><span class="symbol">,</span><span class="normal"> drag</span><span class="symbol">.</span><span class="normal">len</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">							</span><span class="function">SetSelection</span><span class="symbol">(</span><span class="normal">newPos</span><span class="symbol">,</span><span class="normal"> newPos </span><span class="symbol">+</span><span class="normal"> drag</span><span class="symbol">.</span><span class="normal">len</span><span class="symbol">);</span>
<span class="normal">						</span><span class="cbracket">}</span>
<span class="normal">					</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">						</span><span class="function">SetEmptySelection</span><span class="symbol">(</span><span class="normal">newPos</span><span class="symbol">);</span>
<span class="normal">					</span><span class="cbracket">}</span>
<span class="normal">					drag</span><span class="symbol">.</span><span class="function">Free</span><span class="symbol">();</span>
<span class="normal">				</span><span class="cbracket">}</span>
<span class="normal">				selectionType </span><span class="symbol">=</span><span class="normal"> selChar</span><span class="symbol">;</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">selectionType </span><span class="symbol">==</span><span class="normal"> selChar</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="function">SetSelection</span><span class="symbol">(</span><span class="normal">newPos</span><span class="symbol">);</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="function">SetRectangularRange</span><span class="symbol">();</span>
<span class="normal">		lastClickTime </span><span class="symbol">=</span><span class="normal"> curTime</span><span class="symbol">;</span>
<span class="normal">		lastClick </span><span class="symbol">=</span><span class="normal"> pt</span><span class="symbol">;</span>
<span class="normal">		lastXChosen </span><span class="symbol">=</span><span class="normal"> pt</span><span class="symbol">.</span><span class="normal">x</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">selType </span><span class="symbol">==</span><span class="normal"> selStream</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="function">SetLastXChosen</span><span class="symbol">();</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		inDragDrop </span><span class="symbol">=</span><span class="normal"> ddNone</span><span class="symbol">;</span>
<span class="normal">		</span><span class="function">EnsureCaretVisible</span><span class="symbol">(</span><span class="keyword">false</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="comment">// Called frequently to perform background UI including</span>
<span class="comment">// caret blinking and automatic scrolling.</span>
<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">Tick</span><span class="symbol">()</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">HaveMouseCapture</span><span class="symbol">())</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="comment">// Auto scroll</span>
<span class="normal">		</span><span class="function">ButtonMove</span><span class="symbol">(</span><span class="normal">ptMouseLast</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">caret</span><span class="symbol">.</span><span class="normal">period </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		timer</span><span class="symbol">.</span><span class="normal">ticksToWait </span><span class="symbol">-=</span><span class="normal"> timer</span><span class="symbol">.</span><span class="normal">tickSize</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">timer</span><span class="symbol">.</span><span class="normal">ticksToWait </span><span class="symbol">&lt;=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			caret</span><span class="symbol">.</span><span class="normal">on </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">!</span><span class="normal">caret</span><span class="symbol">.</span><span class="normal">on</span><span class="symbol">;</span>
<span class="normal">			timer</span><span class="symbol">.</span><span class="normal">ticksToWait </span><span class="symbol">=</span><span class="normal"> caret</span><span class="symbol">.</span><span class="normal">period</span><span class="symbol">;</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">caret</span><span class="symbol">.</span><span class="normal">active</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="function">InvalidateCaret</span><span class="symbol">();</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">horizontalScrollBarVisible </span><span class="symbol">&amp;&amp;</span><span class="normal"> trackLineWidth </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lineWidthMaxSeen </span><span class="symbol">&gt;</span><span class="normal"> scrollWidth</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		scrollWidth </span><span class="symbol">=</span><span class="normal"> lineWidthMaxSeen</span><span class="symbol">;</span>
<span class="normal">		</span><span class="function">SetScrollBars</span><span class="symbol">();</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">dwellDelay </span><span class="symbol">&lt;</span><span class="normal"> SC_TIME_FOREVER</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span>
<span class="normal">	        </span><span class="symbol">(</span><span class="normal">ticksToDwell </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span>
<span class="normal">	        </span><span class="symbol">(!</span><span class="function">HaveMouseCapture</span><span class="symbol">()))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		ticksToDwell </span><span class="symbol">-=</span><span class="normal"> timer</span><span class="symbol">.</span><span class="normal">tickSize</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ticksToDwell </span><span class="symbol">&lt;=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			dwelling </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>
<span class="normal">			</span><span class="function">NotifyDwelling</span><span class="symbol">(</span><span class="normal">ptMouseLast</span><span class="symbol">,</span><span class="normal"> dwelling</span><span class="symbol">);</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="type">bool</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">Idle</span><span class="symbol">()</span><span class="normal"> </span><span class="cbracket">{</span>

<span class="normal">	</span><span class="type">bool</span><span class="normal"> idleDone</span><span class="symbol">;</span>

<span class="normal">	</span><span class="type">bool</span><span class="normal"> wrappingDone </span><span class="symbol">=</span><span class="normal"> wrapState </span><span class="symbol">==</span><span class="normal"> eWrapNone</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">wrappingDone</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="comment">// Wrap lines during idle.</span>
<span class="normal">		</span><span class="function">WrapLines</span><span class="symbol">(</span><span class="keyword">false</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">		</span><span class="comment">// No more wrapping</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">wrapStart </span><span class="symbol">==</span><span class="normal"> wrapEnd</span><span class="symbol">)</span>
<span class="normal">			wrappingDone </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="comment">// Add more idle things to do here, but make sure idleDone is</span>
<span class="normal">	</span><span class="comment">// set correctly before the function returns. returning</span>
<span class="normal">	</span><span class="comment">// false will stop calling this idle funtion until SetIdle() is</span>
<span class="normal">	</span><span class="comment">// called again.</span>

<span class="normal">	idleDone </span><span class="symbol">=</span><span class="normal"> wrappingDone</span><span class="symbol">;</span><span class="normal"> </span><span class="comment">// &amp;&amp; thatDone &amp;&amp; theOtherThingDone...</span>

<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">!</span><span class="normal">idleDone</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">SetFocusState</span><span class="symbol">(</span><span class="type">bool</span><span class="normal"> focusState</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	hasFocus </span><span class="symbol">=</span><span class="normal"> focusState</span><span class="symbol">;</span>
<span class="normal">	</span><span class="function">NotifyFocus</span><span class="symbol">(</span><span class="normal">hasFocus</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">hasFocus</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">ShowCaretAtCurrentPosition</span><span class="symbol">();</span>
<span class="normal">	</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">CancelModes</span><span class="symbol">();</span>
<span class="normal">		</span><span class="function">DropCaret</span><span class="symbol">();</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="type">bool</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">PaintContains</span><span class="symbol">(</span><span class="usertype">PRectangle</span><span class="normal"> rc</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">rc</span><span class="symbol">.</span><span class="function">Empty</span><span class="symbol">())</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> rcPaint</span><span class="symbol">.</span><span class="function">Contains</span><span class="symbol">(</span><span class="normal">rc</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="type">bool</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">PaintContainsMargin</span><span class="symbol">()</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="usertype">PRectangle</span><span class="normal"> rcSelMargin </span><span class="symbol">=</span><span class="normal"> </span><span class="function">GetClientRectangle</span><span class="symbol">();</span>
<span class="normal">	rcSelMargin</span><span class="symbol">.</span><span class="normal">right </span><span class="symbol">=</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">fixedColumnWidth</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="function">PaintContains</span><span class="symbol">(</span><span class="normal">rcSelMargin</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">CheckForChangeOutsidePaint</span><span class="symbol">(</span><span class="usertype">Range</span><span class="normal"> r</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">paintState </span><span class="symbol">==</span><span class="normal"> painting </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">!</span><span class="normal">paintingAllText</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="comment">//Platform::DebugPrintf("Checking range in paint %d-%d\n", r.start, r.end);</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">r</span><span class="symbol">.</span><span class="function">Valid</span><span class="symbol">())</span>
<span class="normal">			</span><span class="keyword">return</span><span class="symbol">;</span>

<span class="normal">		</span><span class="usertype">PRectangle</span><span class="normal"> rcRange </span><span class="symbol">=</span><span class="normal"> </span><span class="function">RectangleFromRange</span><span class="symbol">(</span><span class="normal">r</span><span class="symbol">.</span><span class="normal">start</span><span class="symbol">,</span><span class="normal"> r</span><span class="symbol">.</span><span class="normal">end</span><span class="symbol">);</span>
<span class="normal">		</span><span class="usertype">PRectangle</span><span class="normal"> rcText </span><span class="symbol">=</span><span class="normal"> </span><span class="function">GetTextRectangle</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">rcRange</span><span class="symbol">.</span><span class="normal">top </span><span class="symbol">&lt;</span><span class="normal"> rcText</span><span class="symbol">.</span><span class="normal">top</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			rcRange</span><span class="symbol">.</span><span class="normal">top </span><span class="symbol">=</span><span class="normal"> rcText</span><span class="symbol">.</span><span class="normal">top</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">rcRange</span><span class="symbol">.</span><span class="normal">bottom </span><span class="symbol">&gt;</span><span class="normal"> rcText</span><span class="symbol">.</span><span class="normal">bottom</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			rcRange</span><span class="symbol">.</span><span class="normal">bottom </span><span class="symbol">=</span><span class="normal"> rcText</span><span class="symbol">.</span><span class="normal">bottom</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>

<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="function">PaintContains</span><span class="symbol">(</span><span class="normal">rcRange</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="function">AbandonPaint</span><span class="symbol">();</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">SetBraceHighlight</span><span class="symbol">(</span><span class="usertype">Position</span><span class="normal"> pos0</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">Position</span><span class="normal"> pos1</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> matchStyle</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">pos0 </span><span class="symbol">!=</span><span class="normal"> braces</span><span class="symbol">[</span><span class="number">0</span><span class="symbol">])</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pos1 </span><span class="symbol">!=</span><span class="normal"> braces</span><span class="symbol">[</span><span class="number">1</span><span class="symbol">])</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">matchStyle </span><span class="symbol">!=</span><span class="normal"> bracesMatchStyle</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">braces</span><span class="symbol">[</span><span class="number">0</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> pos0</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">matchStyle </span><span class="symbol">!=</span><span class="normal"> bracesMatchStyle</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="function">CheckForChangeOutsidePaint</span><span class="symbol">(</span><span class="function">Range</span><span class="symbol">(</span><span class="normal">braces</span><span class="symbol">[</span><span class="number">0</span><span class="symbol">]));</span>
<span class="normal">			</span><span class="function">CheckForChangeOutsidePaint</span><span class="symbol">(</span><span class="function">Range</span><span class="symbol">(</span><span class="normal">pos0</span><span class="symbol">));</span>
<span class="normal">			braces</span><span class="symbol">[</span><span class="number">0</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> pos0</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">braces</span><span class="symbol">[</span><span class="number">1</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> pos1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">matchStyle </span><span class="symbol">!=</span><span class="normal"> bracesMatchStyle</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="function">CheckForChangeOutsidePaint</span><span class="symbol">(</span><span class="function">Range</span><span class="symbol">(</span><span class="normal">braces</span><span class="symbol">[</span><span class="number">1</span><span class="symbol">]));</span>
<span class="normal">			</span><span class="function">CheckForChangeOutsidePaint</span><span class="symbol">(</span><span class="function">Range</span><span class="symbol">(</span><span class="normal">pos1</span><span class="symbol">));</span>
<span class="normal">			braces</span><span class="symbol">[</span><span class="number">1</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> pos1</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		bracesMatchStyle </span><span class="symbol">=</span><span class="normal"> matchStyle</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">paintState </span><span class="symbol">==</span><span class="normal"> notPainting</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="function">Redraw</span><span class="symbol">();</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">SetAnnotationHeights</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> start</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> end</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vs</span><span class="symbol">.</span><span class="normal">annotationVisible</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="normal"> line</span><span class="symbol">=</span><span class="normal">start</span><span class="symbol">;</span><span class="normal"> line</span><span class="symbol">&lt;</span><span class="normal">end</span><span class="symbol">;</span><span class="normal"> line</span><span class="symbol">++)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			cs</span><span class="symbol">.</span><span class="function">SetHeight</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">,</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">AnnotationLines</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">SetDocPointer</span><span class="symbol">(</span><span class="usertype">Document</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">document</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="comment">//Platform::DebugPrintf("** %x setdoc to %x\n", pdoc, document);</span>
<span class="normal">	pdoc</span><span class="symbol">-&gt;</span><span class="function">RemoveWatcher</span><span class="symbol">(</span><span class="keyword">this</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">);</span>
<span class="normal">	pdoc</span><span class="symbol">-&gt;</span><span class="function">Release</span><span class="symbol">();</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">document </span><span class="symbol">==</span><span class="normal"> NULL</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		pdoc </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">new</span><span class="normal"> </span><span class="function">Document</span><span class="symbol">();</span>
<span class="normal">	</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		pdoc </span><span class="symbol">=</span><span class="normal"> document</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	pdoc</span><span class="symbol">-&gt;</span><span class="function">AddRef</span><span class="symbol">();</span>

<span class="normal">	</span><span class="comment">// Ensure all positions within document</span>
<span class="normal">	selType </span><span class="symbol">=</span><span class="normal"> selStream</span><span class="symbol">;</span>
<span class="normal">	currentPos </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">	anchor </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">	targetStart </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">	targetEnd </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">	braces</span><span class="symbol">[</span><span class="number">0</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> invalidPosition</span><span class="symbol">;</span>
<span class="normal">	braces</span><span class="symbol">[</span><span class="number">1</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> invalidPosition</span><span class="symbol">;</span>

<span class="normal">	</span><span class="comment">// Reset the contraction state to fully shown.</span>
<span class="normal">	cs</span><span class="symbol">.</span><span class="function">Clear</span><span class="symbol">();</span>
<span class="normal">	cs</span><span class="symbol">.</span><span class="function">InsertLines</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">,</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LinesTotal</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">	</span><span class="function">SetAnnotationHeights</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">,</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LinesTotal</span><span class="symbol">());</span>
<span class="normal">	llc</span><span class="symbol">.</span><span class="function">Deallocate</span><span class="symbol">();</span>
<span class="normal">	</span><span class="function">NeedWrapping</span><span class="symbol">();</span>

<span class="normal">	pdoc</span><span class="symbol">-&gt;</span><span class="function">AddWatcher</span><span class="symbol">(</span><span class="keyword">this</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">);</span>
<span class="normal">	</span><span class="function">SetScrollBars</span><span class="symbol">();</span>
<span class="normal">	</span><span class="function">Redraw</span><span class="symbol">();</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">SetAnnotationVisible</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> visible</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vs</span><span class="symbol">.</span><span class="normal">annotationVisible </span><span class="symbol">!=</span><span class="normal"> visible</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="type">bool</span><span class="normal"> changedFromOrToHidden </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">vs</span><span class="symbol">.</span><span class="normal">annotationVisible </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">visible </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">));</span>
<span class="normal">		vs</span><span class="symbol">.</span><span class="normal">annotationVisible </span><span class="symbol">=</span><span class="normal"> visible</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">changedFromOrToHidden</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> dir </span><span class="symbol">=</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">annotationVisible </span><span class="symbol">?</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">:</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">			</span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="normal"> line</span><span class="symbol">=</span><span class="number">0</span><span class="symbol">;</span><span class="normal"> line</span><span class="symbol">&lt;</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">LinesTotal</span><span class="symbol">();</span><span class="normal"> line</span><span class="symbol">++)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="type">int</span><span class="normal"> annotationLines </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">AnnotationLines</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">);</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">annotationLines </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					cs</span><span class="symbol">.</span><span class="function">SetHeight</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">,</span><span class="normal"> cs</span><span class="symbol">.</span><span class="function">GetHeight</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> annotationLines </span><span class="symbol">*</span><span class="normal"> dir</span><span class="symbol">);</span>
<span class="normal">				</span><span class="cbracket">}</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="comment">/**</span>
<span class="comment"> * Recursively expand a fold, making lines visible except where they have an unexpanded parent.</span>
<span class="comment"> */</span>
<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">Expand</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">line</span><span class="symbol">,</span><span class="normal"> </span><span class="type">bool</span><span class="normal"> doExpand</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> lineMaxSubord </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">GetLastChild</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">);</span>
<span class="normal">	line</span><span class="symbol">++;</span>
<span class="normal">	</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">line </span><span class="symbol">&lt;=</span><span class="normal"> lineMaxSubord</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">doExpand</span><span class="symbol">)</span>
<span class="normal">			cs</span><span class="symbol">.</span><span class="function">SetVisible</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">,</span><span class="normal"> line</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">);</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> level </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">GetLevel</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">level </span><span class="symbol">&amp;</span><span class="normal"> SC_FOLDLEVELHEADERFLAG</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">doExpand </span><span class="symbol">&amp;&amp;</span><span class="normal"> cs</span><span class="symbol">.</span><span class="function">GetExpanded</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="function">Expand</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">);</span>
<span class="normal">			</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="function">Expand</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">);</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			line</span><span class="symbol">++;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">ToggleContraction</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> line</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">line </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">GetLevel</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> SC_FOLDLEVELHEADERFLAG</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			line </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">GetFoldParent</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">);</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">line </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">				</span><span class="keyword">return</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>

<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">cs</span><span class="symbol">.</span><span class="function">GetExpanded</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> lineMaxSubord </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">GetLastChild</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">);</span>
<span class="normal">			cs</span><span class="symbol">.</span><span class="function">SetExpanded</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">);</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lineMaxSubord </span><span class="symbol">&gt;</span><span class="normal"> line</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				cs</span><span class="symbol">.</span><span class="function">SetVisible</span><span class="symbol">(</span><span class="normal">line </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span><span class="normal"> lineMaxSubord</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">);</span>

<span class="normal">				</span><span class="type">int</span><span class="normal"> lineCurrent </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineFromPosition</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">);</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lineCurrent </span><span class="symbol">&gt;</span><span class="normal"> line </span><span class="symbol">&amp;&amp;</span><span class="normal"> lineCurrent </span><span class="symbol">&lt;=</span><span class="normal"> lineMaxSubord</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="comment">// This does not re-expand the fold</span>
<span class="normal">					</span><span class="function">EnsureCaretVisible</span><span class="symbol">();</span>
<span class="normal">				</span><span class="cbracket">}</span>

<span class="normal">				</span><span class="function">SetScrollBars</span><span class="symbol">();</span>
<span class="normal">				</span><span class="function">Redraw</span><span class="symbol">();</span>
<span class="normal">			</span><span class="cbracket">}</span>

<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!(</span><span class="normal">cs</span><span class="symbol">.</span><span class="function">GetVisible</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">)))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="function">EnsureLineVisible</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">);</span>
<span class="normal">				</span><span class="function">GoToLine</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">);</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">			cs</span><span class="symbol">.</span><span class="function">SetExpanded</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">,</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">			</span><span class="function">Expand</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">);</span>
<span class="normal">			</span><span class="function">SetScrollBars</span><span class="symbol">();</span>
<span class="normal">			</span><span class="function">Redraw</span><span class="symbol">();</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="comment">/**</span>
<span class="comment"> * Recurse up from this line to find any folds that prevent this line from being visible</span>
<span class="comment"> * and unfold them all.</span>
<span class="comment"> */</span>
<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">EnsureLineVisible</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> lineDoc</span><span class="symbol">,</span><span class="normal"> </span><span class="type">bool</span><span class="normal"> enforcePolicy</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>

<span class="normal">	</span><span class="comment">// In case in need of wrapping to ensure DisplayFromDoc works.</span>
<span class="normal">	</span><span class="function">WrapLines</span><span class="symbol">(</span><span class="keyword">true</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">cs</span><span class="symbol">.</span><span class="function">GetVisible</span><span class="symbol">(</span><span class="normal">lineDoc</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> lineParent </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">GetFoldParent</span><span class="symbol">(</span><span class="normal">lineDoc</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lineParent </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lineDoc </span><span class="symbol">!=</span><span class="normal"> lineParent</span><span class="symbol">)</span>
<span class="normal">				</span><span class="function">EnsureLineVisible</span><span class="symbol">(</span><span class="normal">lineParent</span><span class="symbol">,</span><span class="normal"> enforcePolicy</span><span class="symbol">);</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">cs</span><span class="symbol">.</span><span class="function">GetExpanded</span><span class="symbol">(</span><span class="normal">lineParent</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				cs</span><span class="symbol">.</span><span class="function">SetExpanded</span><span class="symbol">(</span><span class="normal">lineParent</span><span class="symbol">,</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">				</span><span class="function">Expand</span><span class="symbol">(</span><span class="normal">lineParent</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">);</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="function">SetScrollBars</span><span class="symbol">();</span>
<span class="normal">		</span><span class="function">Redraw</span><span class="symbol">();</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">enforcePolicy</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="type">int</span><span class="normal"> lineDisplay </span><span class="symbol">=</span><span class="normal"> cs</span><span class="symbol">.</span><span class="function">DisplayFromDoc</span><span class="symbol">(</span><span class="normal">lineDoc</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">visiblePolicy </span><span class="symbol">&amp;</span><span class="normal"> VISIBLE_SLOP</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">topLine </span><span class="symbol">&gt;</span><span class="normal"> lineDisplay</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">visiblePolicy </span><span class="symbol">&amp;</span><span class="normal"> VISIBLE_STRICT</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">topLine </span><span class="symbol">+</span><span class="normal"> visibleSlop </span><span class="symbol">&gt;</span><span class="normal"> lineDisplay</span><span class="symbol">)))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="function">SetTopLine</span><span class="symbol">(</span><span class="normal">Platform</span><span class="symbol">::</span><span class="function">Clamp</span><span class="symbol">(</span><span class="normal">lineDisplay </span><span class="symbol">-</span><span class="normal"> visibleSlop</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="function">MaxScrollPos</span><span class="symbol">()));</span>
<span class="normal">				</span><span class="function">SetVerticalScrollPos</span><span class="symbol">();</span>
<span class="normal">				</span><span class="function">Redraw</span><span class="symbol">();</span>
<span class="normal">			</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">lineDisplay </span><span class="symbol">&gt;</span><span class="normal"> topLine </span><span class="symbol">+</span><span class="normal"> </span><span class="function">LinesOnScreen</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">||</span>
<span class="normal">			        </span><span class="symbol">((</span><span class="normal">visiblePolicy </span><span class="symbol">&amp;</span><span class="normal"> VISIBLE_STRICT</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lineDisplay </span><span class="symbol">&gt;</span><span class="normal"> topLine </span><span class="symbol">+</span><span class="normal"> </span><span class="function">LinesOnScreen</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> visibleSlop</span><span class="symbol">)))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="function">SetTopLine</span><span class="symbol">(</span><span class="normal">Platform</span><span class="symbol">::</span><span class="function">Clamp</span><span class="symbol">(</span><span class="normal">lineDisplay </span><span class="symbol">-</span><span class="normal"> </span><span class="function">LinesOnScreen</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> visibleSlop</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="function">MaxScrollPos</span><span class="symbol">()));</span>
<span class="normal">				</span><span class="function">SetVerticalScrollPos</span><span class="symbol">();</span>
<span class="normal">				</span><span class="function">Redraw</span><span class="symbol">();</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">topLine </span><span class="symbol">&gt;</span><span class="normal"> lineDisplay</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lineDisplay </span><span class="symbol">&gt;</span><span class="normal"> topLine </span><span class="symbol">+</span><span class="normal"> </span><span class="function">LinesOnScreen</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">visiblePolicy </span><span class="symbol">&amp;</span><span class="normal"> VISIBLE_STRICT</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="function">SetTopLine</span><span class="symbol">(</span><span class="normal">Platform</span><span class="symbol">::</span><span class="function">Clamp</span><span class="symbol">(</span><span class="normal">lineDisplay </span><span class="symbol">-</span><span class="normal"> </span><span class="function">LinesOnScreen</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">/</span><span class="normal"> </span><span class="number">2</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="function">MaxScrollPos</span><span class="symbol">()));</span>
<span class="normal">				</span><span class="function">SetVerticalScrollPos</span><span class="symbol">();</span>
<span class="normal">				</span><span class="function">Redraw</span><span class="symbol">();</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="type">int</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">ReplaceTarget</span><span class="symbol">(</span><span class="type">bool</span><span class="normal"> replacePatterns</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">text</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> length</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	pdoc</span><span class="symbol">-&gt;</span><span class="function">BeginUndoAction</span><span class="symbol">();</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">length </span><span class="symbol">==</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">)</span>
<span class="normal">		length </span><span class="symbol">=</span><span class="normal"> </span><span class="function">istrlen</span><span class="symbol">(</span><span class="normal">text</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">replacePatterns</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		text </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">SubstituteByPosition</span><span class="symbol">(</span><span class="normal">text</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">length</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">text</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			pdoc</span><span class="symbol">-&gt;</span><span class="function">EndUndoAction</span><span class="symbol">();</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">targetStart </span><span class="symbol">!=</span><span class="normal"> targetEnd</span><span class="symbol">)</span>
<span class="normal">		pdoc</span><span class="symbol">-&gt;</span><span class="function">DeleteChars</span><span class="symbol">(</span><span class="normal">targetStart</span><span class="symbol">,</span><span class="normal"> targetEnd </span><span class="symbol">-</span><span class="normal"> targetStart</span><span class="symbol">);</span>
<span class="normal">	targetEnd </span><span class="symbol">=</span><span class="normal"> targetStart</span><span class="symbol">;</span>
<span class="normal">	pdoc</span><span class="symbol">-&gt;</span><span class="function">InsertString</span><span class="symbol">(</span><span class="normal">targetStart</span><span class="symbol">,</span><span class="normal"> text</span><span class="symbol">,</span><span class="normal"> length</span><span class="symbol">);</span>
<span class="normal">	targetEnd </span><span class="symbol">=</span><span class="normal"> targetStart </span><span class="symbol">+</span><span class="normal"> length</span><span class="symbol">;</span>
<span class="normal">	pdoc</span><span class="symbol">-&gt;</span><span class="function">EndUndoAction</span><span class="symbol">();</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> length</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="type">bool</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">IsUnicodeMode</span><span class="symbol">()</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> pdoc </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">SC_CP_UTF8 </span><span class="symbol">==</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="normal">dbcsCodePage</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="type">int</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">CodePage</span><span class="symbol">()</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">)</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="normal">dbcsCodePage</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">else</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="type">int</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">WrapCount</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> line</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="usertype">AutoSurface</span><span class="normal"> </span><span class="function">surface</span><span class="symbol">(</span><span class="keyword">this</span><span class="symbol">);</span>
<span class="normal">	</span><span class="usertype">AutoLineLayout</span><span class="normal"> </span><span class="function">ll</span><span class="symbol">(</span><span class="normal">llc</span><span class="symbol">,</span><span class="normal"> </span><span class="function">RetrieveLineLayout</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">));</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">surface </span><span class="symbol">&amp;&amp;</span><span class="normal"> ll</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">LayoutLine</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">,</span><span class="normal"> surface</span><span class="symbol">,</span><span class="normal"> vs</span><span class="symbol">,</span><span class="normal"> ll</span><span class="symbol">,</span><span class="normal"> wrapWidth</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> ll</span><span class="symbol">-&gt;</span><span class="normal">lines</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">AddStyledText</span><span class="symbol">(</span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">buffer</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> appendLength</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="comment">// The buffer consists of alternating character bytes and style bytes</span>
<span class="normal">	</span><span class="usertype">size_t</span><span class="normal"> textLength </span><span class="symbol">=</span><span class="normal"> appendLength </span><span class="symbol">/</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">text </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">new</span><span class="normal"> </span><span class="type">char</span><span class="symbol">[</span><span class="normal">textLength</span><span class="symbol">];</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">text</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="usertype">size_t</span><span class="normal"> i</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal">i </span><span class="symbol">&lt;</span><span class="normal"> textLength</span><span class="symbol">;</span><span class="normal">i</span><span class="symbol">++)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			text</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> buffer</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">*</span><span class="number">2</span><span class="symbol">];</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		pdoc</span><span class="symbol">-&gt;</span><span class="function">InsertString</span><span class="symbol">(</span><span class="function">CurrentPosition</span><span class="symbol">(),</span><span class="normal"> text</span><span class="symbol">,</span><span class="normal"> textLength</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal">i </span><span class="symbol">&lt;</span><span class="normal"> textLength</span><span class="symbol">;</span><span class="normal">i</span><span class="symbol">++)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			text</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> buffer</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">*</span><span class="number">2</span><span class="symbol">+</span><span class="number">1</span><span class="symbol">];</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		pdoc</span><span class="symbol">-&gt;</span><span class="function">StartStyling</span><span class="symbol">(</span><span class="function">CurrentPosition</span><span class="symbol">(),</span><span class="normal"> </span><span class="keyword">static_cast</span><span class="symbol">&lt;</span><span class="type">char</span><span class="symbol">&gt;(</span><span class="number">0xff</span><span class="symbol">));</span>
<span class="normal">		pdoc</span><span class="symbol">-&gt;</span><span class="function">SetStyles</span><span class="symbol">(</span><span class="normal">textLength</span><span class="symbol">,</span><span class="normal"> text</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">delete</span><span class="normal"> </span><span class="symbol">[]</span><span class="normal">text</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="function">SetEmptySelection</span><span class="symbol">(</span><span class="normal">currentPos </span><span class="symbol">+</span><span class="normal"> textLength</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="keyword">static</span><span class="normal"> </span><span class="type">bool</span><span class="normal"> </span><span class="function">ValidMargin</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">long</span><span class="normal"> wParam</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> wParam </span><span class="symbol">&lt;</span><span class="normal"> ViewStyle</span><span class="symbol">::</span><span class="normal">margins</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="keyword">static</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="function">CharPtrFromSPtr</span><span class="symbol">(</span><span class="usertype">sptr_t</span><span class="normal"> lParam</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="keyword">reinterpret_cast</span><span class="symbol">&lt;</span><span class="type">char</span><span class="normal"> </span><span class="symbol">*&gt;(</span><span class="normal">lParam</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">StyleSetMessage</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> iMessage</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">uptr_t</span><span class="normal"> wParam</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">sptr_t</span><span class="normal"> lParam</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	vs</span><span class="symbol">.</span><span class="function">EnsureStyle</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">switch</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">iMessage</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_STYLESETFORE</span><span class="symbol">:</span>
<span class="normal">		vs</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">wParam</span><span class="symbol">].</span><span class="normal">fore</span><span class="symbol">.</span><span class="normal">desired </span><span class="symbol">=</span><span class="normal"> </span><span class="function">ColourDesired</span><span class="symbol">(</span><span class="normal">lParam</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_STYLESETBACK</span><span class="symbol">:</span>
<span class="normal">		vs</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">wParam</span><span class="symbol">].</span><span class="normal">back</span><span class="symbol">.</span><span class="normal">desired </span><span class="symbol">=</span><span class="normal"> </span><span class="function">ColourDesired</span><span class="symbol">(</span><span class="normal">lParam</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_STYLESETBOLD</span><span class="symbol">:</span>
<span class="normal">		vs</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">wParam</span><span class="symbol">].</span><span class="normal">bold </span><span class="symbol">=</span><span class="normal"> lParam </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_STYLESETITALIC</span><span class="symbol">:</span>
<span class="normal">		vs</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">wParam</span><span class="symbol">].</span><span class="normal">italic </span><span class="symbol">=</span><span class="normal"> lParam </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_STYLESETEOLFILLED</span><span class="symbol">:</span>
<span class="normal">		vs</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">wParam</span><span class="symbol">].</span><span class="normal">eolFilled </span><span class="symbol">=</span><span class="normal"> lParam </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_STYLESETSIZE</span><span class="symbol">:</span>
<span class="normal">		vs</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">wParam</span><span class="symbol">].</span><span class="normal">size </span><span class="symbol">=</span><span class="normal"> lParam</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_STYLESETFONT</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lParam </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			vs</span><span class="symbol">.</span><span class="function">SetStyleFontName</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">,</span><span class="normal"> </span><span class="function">CharPtrFromSPtr</span><span class="symbol">(</span><span class="normal">lParam</span><span class="symbol">));</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_STYLESETUNDERLINE</span><span class="symbol">:</span>
<span class="normal">		vs</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">wParam</span><span class="symbol">].</span><span class="normal">underline </span><span class="symbol">=</span><span class="normal"> lParam </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_STYLESETCASE</span><span class="symbol">:</span>
<span class="normal">		vs</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">wParam</span><span class="symbol">].</span><span class="normal">caseForce </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">static_cast</span><span class="symbol">&lt;</span><span class="normal">Style</span><span class="symbol">::</span><span class="normal">ecaseForced</span><span class="symbol">&gt;(</span><span class="normal">lParam</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_STYLESETCHARACTERSET</span><span class="symbol">:</span>
<span class="normal">		vs</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">wParam</span><span class="symbol">].</span><span class="normal">characterSet </span><span class="symbol">=</span><span class="normal"> lParam</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_STYLESETVISIBLE</span><span class="symbol">:</span>
<span class="normal">		vs</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">wParam</span><span class="symbol">].</span><span class="normal">visible </span><span class="symbol">=</span><span class="normal"> lParam </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_STYLESETCHANGEABLE</span><span class="symbol">:</span>
<span class="normal">		vs</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">wParam</span><span class="symbol">].</span><span class="normal">changeable </span><span class="symbol">=</span><span class="normal"> lParam </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_STYLESETHOTSPOT</span><span class="symbol">:</span>
<span class="normal">		vs</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">wParam</span><span class="symbol">].</span><span class="normal">hotspot </span><span class="symbol">=</span><span class="normal"> lParam </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="function">InvalidateStyleRedraw</span><span class="symbol">();</span>
<span class="cbracket">}</span>

<span class="usertype">sptr_t</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">StyleGetMessage</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> iMessage</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">uptr_t</span><span class="normal"> wParam</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">sptr_t</span><span class="normal"> lParam</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	vs</span><span class="symbol">.</span><span class="function">EnsureStyle</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">switch</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">iMessage</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_STYLEGETFORE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">wParam</span><span class="symbol">].</span><span class="normal">fore</span><span class="symbol">.</span><span class="normal">desired</span><span class="symbol">.</span><span class="function">AsLong</span><span class="symbol">();</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_STYLEGETBACK</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">wParam</span><span class="symbol">].</span><span class="normal">back</span><span class="symbol">.</span><span class="normal">desired</span><span class="symbol">.</span><span class="function">AsLong</span><span class="symbol">();</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_STYLEGETBOLD</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">wParam</span><span class="symbol">].</span><span class="normal">bold </span><span class="symbol">?</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">:</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_STYLEGETITALIC</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">wParam</span><span class="symbol">].</span><span class="normal">italic </span><span class="symbol">?</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">:</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_STYLEGETEOLFILLED</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">wParam</span><span class="symbol">].</span><span class="normal">eolFilled </span><span class="symbol">?</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">:</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_STYLEGETSIZE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">wParam</span><span class="symbol">].</span><span class="normal">size</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_STYLEGETFONT</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lParam </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">			</span><span class="function">strcpy</span><span class="symbol">(</span><span class="function">CharPtrFromSPtr</span><span class="symbol">(</span><span class="normal">lParam</span><span class="symbol">),</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">wParam</span><span class="symbol">].</span><span class="normal">fontName</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="function">strlen</span><span class="symbol">(</span><span class="normal">vs</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">wParam</span><span class="symbol">].</span><span class="normal">fontName</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_STYLEGETUNDERLINE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">wParam</span><span class="symbol">].</span><span class="normal">underline </span><span class="symbol">?</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">:</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_STYLEGETCASE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="keyword">static_cast</span><span class="symbol">&lt;</span><span class="type">int</span><span class="symbol">&gt;(</span><span class="normal">vs</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">wParam</span><span class="symbol">].</span><span class="normal">caseForce</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_STYLEGETCHARACTERSET</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">wParam</span><span class="symbol">].</span><span class="normal">characterSet</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_STYLEGETVISIBLE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">wParam</span><span class="symbol">].</span><span class="normal">visible </span><span class="symbol">?</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">:</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_STYLEGETCHANGEABLE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">wParam</span><span class="symbol">].</span><span class="normal">changeable </span><span class="symbol">?</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">:</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_STYLEGETHOTSPOT</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">[</span><span class="normal">wParam</span><span class="symbol">].</span><span class="normal">hotspot </span><span class="symbol">?</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">:</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="usertype">sptr_t</span><span class="normal"> Editor</span><span class="symbol">::</span><span class="function">WndProc</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> iMessage</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">uptr_t</span><span class="normal"> wParam</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">sptr_t</span><span class="normal"> lParam</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="comment">//Platform::DebugPrintf("S start wnd proc %d %d %d\n",iMessage, wParam, lParam);</span>

<span class="normal">	</span><span class="comment">// Optional macro recording hook</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">recordingMacro</span><span class="symbol">)</span>
<span class="normal">		</span><span class="function">NotifyMacroRecord</span><span class="symbol">(</span><span class="normal">iMessage</span><span class="symbol">,</span><span class="normal"> wParam</span><span class="symbol">,</span><span class="normal"> lParam</span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">switch</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">iMessage</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETTEXT</span><span class="symbol">:</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lParam </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">				</span><span class="keyword">return</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">Length</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">wParam </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">				</span><span class="keyword">return</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">			</span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">ptr </span><span class="symbol">=</span><span class="normal"> </span><span class="function">CharPtrFromSPtr</span><span class="symbol">(</span><span class="normal">lParam</span><span class="symbol">);</span>
<span class="normal">			</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> iChar </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">			</span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(;</span><span class="normal"> iChar </span><span class="symbol">&lt;</span><span class="normal"> wParam </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span><span class="normal"> iChar</span><span class="symbol">++)</span>
<span class="normal">				ptr</span><span class="symbol">[</span><span class="normal">iChar</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">CharAt</span><span class="symbol">(</span><span class="normal">iChar</span><span class="symbol">);</span>
<span class="normal">			ptr</span><span class="symbol">[</span><span class="normal">iChar</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="string">'</span><span class="specialchar">\0</span><span class="string">'</span><span class="symbol">;</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> iChar</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETTEXT</span><span class="symbol">:</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lParam </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">				</span><span class="keyword">return</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">			pdoc</span><span class="symbol">-&gt;</span><span class="function">BeginUndoAction</span><span class="symbol">();</span>
<span class="normal">			pdoc</span><span class="symbol">-&gt;</span><span class="function">DeleteChars</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">,</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">Length</span><span class="symbol">());</span>
<span class="normal">			</span><span class="function">SetEmptySelection</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">);</span>
<span class="normal">			pdoc</span><span class="symbol">-&gt;</span><span class="function">InsertCString</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="function">CharPtrFromSPtr</span><span class="symbol">(</span><span class="normal">lParam</span><span class="symbol">));</span>
<span class="normal">			pdoc</span><span class="symbol">-&gt;</span><span class="function">EndUndoAction</span><span class="symbol">();</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETTEXTLENGTH</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">Length</span><span class="symbol">();</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_CUT</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">Cut</span><span class="symbol">();</span>
<span class="normal">		</span><span class="function">SetLastXChosen</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_COPY</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">Copy</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_COPYALLOWLINE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">CopyAllowLine</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_COPYRANGE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">CopyRangeToClipboard</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">,</span><span class="normal"> lParam</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_COPYTEXT</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">CopyText</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">,</span><span class="normal"> </span><span class="function">CharPtrFromSPtr</span><span class="symbol">(</span><span class="normal">lParam</span><span class="symbol">));</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_PASTE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">Paste</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">caretSticky</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="function">SetLastXChosen</span><span class="symbol">();</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="function">EnsureCaretVisible</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_CLEAR</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">Clear</span><span class="symbol">();</span>
<span class="normal">		</span><span class="function">SetLastXChosen</span><span class="symbol">();</span>
<span class="normal">		</span><span class="function">EnsureCaretVisible</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_UNDO</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">Undo</span><span class="symbol">();</span>
<span class="normal">		</span><span class="function">SetLastXChosen</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_CANUNDO</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">CanUndo</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">!</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">IsReadOnly</span><span class="symbol">())</span><span class="normal"> </span><span class="symbol">?</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">:</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_EMPTYUNDOBUFFER</span><span class="symbol">:</span>
<span class="normal">		pdoc</span><span class="symbol">-&gt;</span><span class="function">DeleteUndoHistory</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETFIRSTVISIBLELINE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> topLine</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETLINE</span><span class="symbol">:</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal">	</span><span class="comment">// Risk of overwriting the end of the buffer</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> lineStart </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">);</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> lineEnd </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">wParam </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lParam </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="keyword">return</span><span class="normal"> lineEnd </span><span class="symbol">-</span><span class="normal"> lineStart</span><span class="symbol">;</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">			</span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">ptr </span><span class="symbol">=</span><span class="normal"> </span><span class="function">CharPtrFromSPtr</span><span class="symbol">(</span><span class="normal">lParam</span><span class="symbol">);</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> iPlace </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">			</span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="normal"> iChar </span><span class="symbol">=</span><span class="normal"> lineStart</span><span class="symbol">;</span><span class="normal"> iChar </span><span class="symbol">&lt;</span><span class="normal"> lineEnd</span><span class="symbol">;</span><span class="normal"> iChar</span><span class="symbol">++)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				ptr</span><span class="symbol">[</span><span class="normal">iPlace</span><span class="symbol">++]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">CharAt</span><span class="symbol">(</span><span class="normal">iChar</span><span class="symbol">);</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> iPlace</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETLINECOUNT</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">LinesTotal</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">else</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LinesTotal</span><span class="symbol">();</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETMODIFY</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">!</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">IsSavePoint</span><span class="symbol">();</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETSEL</span><span class="symbol">:</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> nStart </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">static_cast</span><span class="symbol">&lt;</span><span class="type">int</span><span class="symbol">&gt;(</span><span class="normal">wParam</span><span class="symbol">);</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> nEnd </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">static_cast</span><span class="symbol">&lt;</span><span class="type">int</span><span class="symbol">&gt;(</span><span class="normal">lParam</span><span class="symbol">);</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">nEnd </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">				nEnd </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">Length</span><span class="symbol">();</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">nStart </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">				nStart </span><span class="symbol">=</span><span class="normal"> nEnd</span><span class="symbol">;</span><span class="normal"> 	</span><span class="comment">// Remove selection</span>
<span class="normal">			selType </span><span class="symbol">=</span><span class="normal"> selStream</span><span class="symbol">;</span>
<span class="normal">			</span><span class="function">SetSelection</span><span class="symbol">(</span><span class="normal">nEnd</span><span class="symbol">,</span><span class="normal"> nStart</span><span class="symbol">);</span>
<span class="normal">			</span><span class="function">EnsureCaretVisible</span><span class="symbol">();</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETSELTEXT</span><span class="symbol">:</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lParam </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">selType </span><span class="symbol">==</span><span class="normal"> selStream</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="keyword">return</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="function">SelectionEnd</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="function">SelectionStart</span><span class="symbol">();</span>
<span class="normal">				</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">					</span><span class="comment">// TODO: why is selLines handled the slow way?</span>
<span class="normal">					</span><span class="type">int</span><span class="normal"> size </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">					</span><span class="type">int</span><span class="normal"> extraCharsPerLine </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">					</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">selType </span><span class="symbol">!=</span><span class="normal"> selLines</span><span class="symbol">)</span>
<span class="normal">						extraCharsPerLine </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="normal">eolMode </span><span class="symbol">==</span><span class="normal"> SC_EOL_CRLF</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">?</span><span class="normal"> </span><span class="number">2</span><span class="normal"> </span><span class="symbol">:</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">					</span><span class="usertype">SelectionLineIterator</span><span class="normal"> </span><span class="function">lineIterator</span><span class="symbol">(</span><span class="keyword">this</span><span class="symbol">);</span>
<span class="normal">					</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lineIterator</span><span class="symbol">.</span><span class="function">Iterate</span><span class="symbol">())</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">						size </span><span class="symbol">+=</span><span class="normal"> lineIterator</span><span class="symbol">.</span><span class="normal">endPos </span><span class="symbol">+</span><span class="normal"> extraCharsPerLine </span><span class="symbol">-</span><span class="normal"> lineIterator</span><span class="symbol">.</span><span class="normal">startPos</span><span class="symbol">;</span>
<span class="normal">					</span><span class="cbracket">}</span>

<span class="normal">					</span><span class="keyword">return</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> size</span><span class="symbol">;</span>
<span class="normal">				</span><span class="cbracket">}</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">			</span><span class="usertype">SelectionText</span><span class="normal"> selectedText</span><span class="symbol">;</span>
<span class="normal">			</span><span class="function">CopySelectionRange</span><span class="symbol">(&amp;</span><span class="normal">selectedText</span><span class="symbol">);</span>
<span class="normal">			</span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">ptr </span><span class="symbol">=</span><span class="normal"> </span><span class="function">CharPtrFromSPtr</span><span class="symbol">(</span><span class="normal">lParam</span><span class="symbol">);</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> iChar </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">selectedText</span><span class="symbol">.</span><span class="normal">len</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(;</span><span class="normal"> iChar </span><span class="symbol">&lt;</span><span class="normal"> selectedText</span><span class="symbol">.</span><span class="normal">len</span><span class="symbol">;</span><span class="normal"> iChar</span><span class="symbol">++)</span>
<span class="normal">					ptr</span><span class="symbol">[</span><span class="normal">iChar</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> selectedText</span><span class="symbol">.</span><span class="normal">s</span><span class="symbol">[</span><span class="normal">iChar</span><span class="symbol">];</span>
<span class="normal">			</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				ptr</span><span class="symbol">[</span><span class="number">0</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="string">'</span><span class="specialchar">\0</span><span class="string">'</span><span class="symbol">;</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> iChar</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_LINEFROMPOSITION</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="keyword">static_cast</span><span class="symbol">&lt;</span><span class="type">int</span><span class="symbol">&gt;(</span><span class="normal">wParam</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineFromPosition</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_POSITIONFROMLINE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="keyword">static_cast</span><span class="symbol">&lt;</span><span class="type">int</span><span class="symbol">&gt;(</span><span class="normal">wParam</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">			wParam </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineFromPosition</span><span class="symbol">(</span><span class="function">SelectionStart</span><span class="symbol">());</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">wParam </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> 	</span><span class="comment">// Even if there is no text, there is a first line that starts at 0</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="keyword">static_cast</span><span class="symbol">&lt;</span><span class="type">int</span><span class="symbol">&gt;(</span><span class="normal">wParam</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LinesTotal</span><span class="symbol">())</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">		</span><span class="comment">//if (wParam &gt; pdoc-&gt;LineFromPosition(pdoc-&gt;Length()))	// Useful test, anyway...</span>
<span class="normal">		</span><span class="comment">//	return -1;</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">);</span>

<span class="normal">		</span><span class="comment">// Replacement of the old Scintilla interpretation of EM_LINELENGTH</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_LINELENGTH</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="keyword">static_cast</span><span class="symbol">&lt;</span><span class="type">int</span><span class="symbol">&gt;(</span><span class="normal">wParam</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">||</span>
<span class="normal">		        </span><span class="symbol">(</span><span class="keyword">static_cast</span><span class="symbol">&lt;</span><span class="type">int</span><span class="symbol">&gt;(</span><span class="normal">wParam</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineFromPosition</span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">Length</span><span class="symbol">())))</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">wParam </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_REPLACESEL</span><span class="symbol">:</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lParam </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">				</span><span class="keyword">return</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">			pdoc</span><span class="symbol">-&gt;</span><span class="function">BeginUndoAction</span><span class="symbol">();</span>
<span class="normal">			</span><span class="function">ClearSelection</span><span class="symbol">();</span>
<span class="normal">			</span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">replacement </span><span class="symbol">=</span><span class="normal"> </span><span class="function">CharPtrFromSPtr</span><span class="symbol">(</span><span class="normal">lParam</span><span class="symbol">);</span>
<span class="normal">			pdoc</span><span class="symbol">-&gt;</span><span class="function">InsertCString</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">,</span><span class="normal"> replacement</span><span class="symbol">);</span>
<span class="normal">			pdoc</span><span class="symbol">-&gt;</span><span class="function">EndUndoAction</span><span class="symbol">();</span>
<span class="normal">			</span><span class="function">SetEmptySelection</span><span class="symbol">(</span><span class="normal">currentPos </span><span class="symbol">+</span><span class="normal"> </span><span class="function">istrlen</span><span class="symbol">(</span><span class="normal">replacement</span><span class="symbol">));</span>
<span class="normal">			</span><span class="function">EnsureCaretVisible</span><span class="symbol">();</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETTARGETSTART</span><span class="symbol">:</span>
<span class="normal">		targetStart </span><span class="symbol">=</span><span class="normal"> wParam</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETTARGETSTART</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> targetStart</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETTARGETEND</span><span class="symbol">:</span>
<span class="normal">		targetEnd </span><span class="symbol">=</span><span class="normal"> wParam</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETTARGETEND</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> targetEnd</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_TARGETFROMSELECTION</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">currentPos </span><span class="symbol">&lt;</span><span class="normal"> anchor</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			targetStart </span><span class="symbol">=</span><span class="normal"> currentPos</span><span class="symbol">;</span>
<span class="normal">			targetEnd </span><span class="symbol">=</span><span class="normal"> anchor</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			targetStart </span><span class="symbol">=</span><span class="normal"> anchor</span><span class="symbol">;</span>
<span class="normal">			targetEnd </span><span class="symbol">=</span><span class="normal"> currentPos</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_REPLACETARGET</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">PLATFORM_ASSERT</span><span class="symbol">(</span><span class="normal">lParam</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="function">ReplaceTarget</span><span class="symbol">(</span><span class="keyword">false</span><span class="symbol">,</span><span class="normal"> </span><span class="function">CharPtrFromSPtr</span><span class="symbol">(</span><span class="normal">lParam</span><span class="symbol">),</span><span class="normal"> wParam</span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_REPLACETARGETRE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">PLATFORM_ASSERT</span><span class="symbol">(</span><span class="normal">lParam</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="function">ReplaceTarget</span><span class="symbol">(</span><span class="keyword">true</span><span class="symbol">,</span><span class="normal"> </span><span class="function">CharPtrFromSPtr</span><span class="symbol">(</span><span class="normal">lParam</span><span class="symbol">),</span><span class="normal"> wParam</span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SEARCHINTARGET</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">PLATFORM_ASSERT</span><span class="symbol">(</span><span class="normal">lParam</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="function">SearchInTarget</span><span class="symbol">(</span><span class="function">CharPtrFromSPtr</span><span class="symbol">(</span><span class="normal">lParam</span><span class="symbol">),</span><span class="normal"> wParam</span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETSEARCHFLAGS</span><span class="symbol">:</span>
<span class="normal">		searchFlags </span><span class="symbol">=</span><span class="normal"> wParam</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETSEARCHFLAGS</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> searchFlags</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_POSITIONBEFORE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">MovePositionOutsideChar</span><span class="symbol">(</span><span class="normal">wParam </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_POSITIONAFTER</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">MovePositionOutsideChar</span><span class="symbol">(</span><span class="normal">wParam </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_LINESCROLL</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">ScrollTo</span><span class="symbol">(</span><span class="normal">topLine </span><span class="symbol">+</span><span class="normal"> lParam</span><span class="symbol">);</span>
<span class="normal">		</span><span class="function">HorizontalScrollTo</span><span class="symbol">(</span><span class="normal">xOffset </span><span class="symbol">+</span><span class="normal"> wParam </span><span class="symbol">*</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">spaceWidth</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETXOFFSET</span><span class="symbol">:</span>
<span class="normal">		xOffset </span><span class="symbol">=</span><span class="normal"> wParam</span><span class="symbol">;</span>
<span class="normal">		</span><span class="function">SetHorizontalScrollPos</span><span class="symbol">();</span>
<span class="normal">		</span><span class="function">Redraw</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETXOFFSET</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> xOffset</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_CHOOSECARETX</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">SetLastXChosen</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SCROLLCARET</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">EnsureCaretVisible</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETREADONLY</span><span class="symbol">:</span>
<span class="normal">		pdoc</span><span class="symbol">-&gt;</span><span class="function">SetReadOnly</span><span class="symbol">(</span><span class="normal">wParam </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETREADONLY</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">IsReadOnly</span><span class="symbol">();</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_CANPASTE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="function">CanPaste</span><span class="symbol">();</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_POINTXFROMPOSITION</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lParam </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="usertype">Point</span><span class="normal"> pt </span><span class="symbol">=</span><span class="normal"> </span><span class="function">LocationFromPosition</span><span class="symbol">(</span><span class="normal">lParam</span><span class="symbol">);</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> pt</span><span class="symbol">.</span><span class="normal">x</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_POINTYFROMPOSITION</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lParam </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="usertype">Point</span><span class="normal"> pt </span><span class="symbol">=</span><span class="normal"> </span><span class="function">LocationFromPosition</span><span class="symbol">(</span><span class="normal">lParam</span><span class="symbol">);</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> pt</span><span class="symbol">.</span><span class="normal">y</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_FINDTEXT</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="function">FindText</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">,</span><span class="normal"> lParam</span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETTEXTRANGE</span><span class="symbol">:</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lParam </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">				</span><span class="keyword">return</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">			</span><span class="usertype">Sci_TextRange</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">tr </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">reinterpret_cast</span><span class="symbol">&lt;</span><span class="normal">Sci_TextRange </span><span class="symbol">*&gt;(</span><span class="normal">lParam</span><span class="symbol">);</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> cpMax </span><span class="symbol">=</span><span class="normal"> tr</span><span class="symbol">-&gt;</span><span class="normal">chrg</span><span class="symbol">.</span><span class="normal">cpMax</span><span class="symbol">;</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">cpMax </span><span class="symbol">==</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">)</span>
<span class="normal">				cpMax </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">Length</span><span class="symbol">();</span>
<span class="normal">			</span><span class="function">PLATFORM_ASSERT</span><span class="symbol">(</span><span class="normal">cpMax </span><span class="symbol">&lt;=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">Length</span><span class="symbol">());</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> len </span><span class="symbol">=</span><span class="normal"> cpMax </span><span class="symbol">-</span><span class="normal"> tr</span><span class="symbol">-&gt;</span><span class="normal">chrg</span><span class="symbol">.</span><span class="normal">cpMin</span><span class="symbol">;</span><span class="normal"> 	</span><span class="comment">// No -1 as cpMin and cpMax are referring to inter character positions</span>
<span class="normal">			pdoc</span><span class="symbol">-&gt;</span><span class="function">GetCharRange</span><span class="symbol">(</span><span class="normal">tr</span><span class="symbol">-&gt;</span><span class="normal">lpstrText</span><span class="symbol">,</span><span class="normal"> tr</span><span class="symbol">-&gt;</span><span class="normal">chrg</span><span class="symbol">.</span><span class="normal">cpMin</span><span class="symbol">,</span><span class="normal"> len</span><span class="symbol">);</span>
<span class="normal">			</span><span class="comment">// Spec says copied text is terminated with a NUL</span>
<span class="normal">			tr</span><span class="symbol">-&gt;</span><span class="normal">lpstrText</span><span class="symbol">[</span><span class="normal">len</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="string">'</span><span class="specialchar">\0</span><span class="string">'</span><span class="symbol">;</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> len</span><span class="symbol">;</span><span class="normal"> 	</span><span class="comment">// Not including NUL</span>
<span class="normal">		</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_HIDESELECTION</span><span class="symbol">:</span>
<span class="normal">		hideSelection </span><span class="symbol">=</span><span class="normal"> wParam </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		</span><span class="function">Redraw</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_FORMATRANGE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="function">FormatRange</span><span class="symbol">(</span><span class="normal">wParam </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">reinterpret_cast</span><span class="symbol">&lt;</span><span class="normal">Sci_RangeToFormat </span><span class="symbol">*&gt;(</span><span class="normal">lParam</span><span class="symbol">));</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETMARGINLEFT</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">leftMarginWidth</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETMARGINRIGHT</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">rightMarginWidth</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETMARGINLEFT</span><span class="symbol">:</span>
<span class="normal">		vs</span><span class="symbol">.</span><span class="normal">leftMarginWidth </span><span class="symbol">=</span><span class="normal"> lParam</span><span class="symbol">;</span>
<span class="normal">		</span><span class="function">InvalidateStyleRedraw</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETMARGINRIGHT</span><span class="symbol">:</span>
<span class="normal">		vs</span><span class="symbol">.</span><span class="normal">rightMarginWidth </span><span class="symbol">=</span><span class="normal"> lParam</span><span class="symbol">;</span>
<span class="normal">		</span><span class="function">InvalidateStyleRedraw</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">		</span><span class="comment">// Control specific mesages</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_ADDTEXT</span><span class="symbol">:</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lParam </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">				</span><span class="keyword">return</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">			pdoc</span><span class="symbol">-&gt;</span><span class="function">InsertString</span><span class="symbol">(</span><span class="function">CurrentPosition</span><span class="symbol">(),</span><span class="normal"> </span><span class="function">CharPtrFromSPtr</span><span class="symbol">(</span><span class="normal">lParam</span><span class="symbol">),</span><span class="normal"> wParam</span><span class="symbol">);</span>
<span class="normal">			</span><span class="function">SetEmptySelection</span><span class="symbol">(</span><span class="normal">currentPos </span><span class="symbol">+</span><span class="normal"> wParam</span><span class="symbol">);</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_ADDSTYLEDTEXT</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lParam</span><span class="symbol">)</span>
<span class="normal">			</span><span class="function">AddStyledText</span><span class="symbol">(</span><span class="function">CharPtrFromSPtr</span><span class="symbol">(</span><span class="normal">lParam</span><span class="symbol">),</span><span class="normal"> wParam</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_INSERTTEXT</span><span class="symbol">:</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lParam </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">				</span><span class="keyword">return</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> insertPos </span><span class="symbol">=</span><span class="normal"> wParam</span><span class="symbol">;</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="keyword">static_cast</span><span class="symbol">&lt;</span><span class="type">int</span><span class="symbol">&gt;(</span><span class="normal">wParam</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">)</span>
<span class="normal">				insertPos </span><span class="symbol">=</span><span class="normal"> </span><span class="function">CurrentPosition</span><span class="symbol">();</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> newCurrent </span><span class="symbol">=</span><span class="normal"> </span><span class="function">CurrentPosition</span><span class="symbol">();</span>
<span class="normal">			</span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">sz </span><span class="symbol">=</span><span class="normal"> </span><span class="function">CharPtrFromSPtr</span><span class="symbol">(</span><span class="normal">lParam</span><span class="symbol">);</span>
<span class="normal">			pdoc</span><span class="symbol">-&gt;</span><span class="function">InsertCString</span><span class="symbol">(</span><span class="normal">insertPos</span><span class="symbol">,</span><span class="normal"> sz</span><span class="symbol">);</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">newCurrent </span><span class="symbol">&gt;</span><span class="normal"> insertPos</span><span class="symbol">)</span>
<span class="normal">				newCurrent </span><span class="symbol">+=</span><span class="normal"> </span><span class="function">istrlen</span><span class="symbol">(</span><span class="normal">sz</span><span class="symbol">);</span>
<span class="normal">			</span><span class="function">SetEmptySelection</span><span class="symbol">(</span><span class="normal">newCurrent</span><span class="symbol">);</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_APPENDTEXT</span><span class="symbol">:</span>
<span class="normal">		pdoc</span><span class="symbol">-&gt;</span><span class="function">InsertString</span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">Length</span><span class="symbol">(),</span><span class="normal"> </span><span class="function">CharPtrFromSPtr</span><span class="symbol">(</span><span class="normal">lParam</span><span class="symbol">),</span><span class="normal"> wParam</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_CLEARALL</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">ClearAll</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_CLEARDOCUMENTSTYLE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">ClearDocumentStyle</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETUNDOCOLLECTION</span><span class="symbol">:</span>
<span class="normal">		pdoc</span><span class="symbol">-&gt;</span><span class="function">SetUndoCollection</span><span class="symbol">(</span><span class="normal">wParam </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETUNDOCOLLECTION</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">IsCollectingUndo</span><span class="symbol">();</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_BEGINUNDOACTION</span><span class="symbol">:</span>
<span class="normal">		pdoc</span><span class="symbol">-&gt;</span><span class="function">BeginUndoAction</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_ENDUNDOACTION</span><span class="symbol">:</span>
<span class="normal">		pdoc</span><span class="symbol">-&gt;</span><span class="function">EndUndoAction</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETCARETPERIOD</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> caret</span><span class="symbol">.</span><span class="normal">period</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETCARETPERIOD</span><span class="symbol">:</span>
<span class="normal">		caret</span><span class="symbol">.</span><span class="normal">period </span><span class="symbol">=</span><span class="normal"> wParam</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETWORDCHARS</span><span class="symbol">:</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			pdoc</span><span class="symbol">-&gt;</span><span class="function">SetDefaultCharClasses</span><span class="symbol">(</span><span class="keyword">false</span><span class="symbol">);</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lParam </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">				</span><span class="keyword">return</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">			pdoc</span><span class="symbol">-&gt;</span><span class="function">SetCharClasses</span><span class="symbol">(</span><span class="keyword">reinterpret_cast</span><span class="symbol">&lt;</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*&gt;(</span><span class="normal">lParam</span><span class="symbol">),</span><span class="normal"> CharClassify</span><span class="symbol">::</span><span class="normal">ccWord</span><span class="symbol">);</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETWHITESPACECHARS</span><span class="symbol">:</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lParam </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">				</span><span class="keyword">return</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">			pdoc</span><span class="symbol">-&gt;</span><span class="function">SetCharClasses</span><span class="symbol">(</span><span class="keyword">reinterpret_cast</span><span class="symbol">&lt;</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*&gt;(</span><span class="normal">lParam</span><span class="symbol">),</span><span class="normal"> CharClassify</span><span class="symbol">::</span><span class="normal">ccSpace</span><span class="symbol">);</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETCHARSDEFAULT</span><span class="symbol">:</span>
<span class="normal">		pdoc</span><span class="symbol">-&gt;</span><span class="function">SetDefaultCharClasses</span><span class="symbol">(</span><span class="keyword">true</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETLENGTH</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">Length</span><span class="symbol">();</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_ALLOCATE</span><span class="symbol">:</span>
<span class="normal">		pdoc</span><span class="symbol">-&gt;</span><span class="function">Allocate</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETCHARAT</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">CharAt</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETCURRENTPOS</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">SetSelection</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">,</span><span class="normal"> anchor</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETCURRENTPOS</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> currentPos</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETANCHOR</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">SetSelection</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">,</span><span class="normal"> wParam</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETANCHOR</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> anchor</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETSELECTIONSTART</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">SetSelection</span><span class="symbol">(</span><span class="normal">Platform</span><span class="symbol">::</span><span class="function">Maximum</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">,</span><span class="normal"> wParam</span><span class="symbol">),</span><span class="normal"> wParam</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETSELECTIONSTART</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> Platform</span><span class="symbol">::</span><span class="function">Minimum</span><span class="symbol">(</span><span class="normal">anchor</span><span class="symbol">,</span><span class="normal"> currentPos</span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETSELECTIONEND</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">SetSelection</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">,</span><span class="normal"> Platform</span><span class="symbol">::</span><span class="function">Minimum</span><span class="symbol">(</span><span class="normal">anchor</span><span class="symbol">,</span><span class="normal"> wParam</span><span class="symbol">));</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETSELECTIONEND</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> Platform</span><span class="symbol">::</span><span class="function">Maximum</span><span class="symbol">(</span><span class="normal">anchor</span><span class="symbol">,</span><span class="normal"> currentPos</span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETPRINTMAGNIFICATION</span><span class="symbol">:</span>
<span class="normal">		printMagnification </span><span class="symbol">=</span><span class="normal"> wParam</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETPRINTMAGNIFICATION</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> printMagnification</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETPRINTCOLOURMODE</span><span class="symbol">:</span>
<span class="normal">		printColourMode </span><span class="symbol">=</span><span class="normal"> wParam</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETPRINTCOLOURMODE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> printColourMode</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETPRINTWRAPMODE</span><span class="symbol">:</span>
<span class="normal">		printWrapState </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">wParam </span><span class="symbol">==</span><span class="normal"> SC_WRAP_WORD</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">?</span><span class="normal"> eWrapWord </span><span class="symbol">:</span><span class="normal"> eWrapNone</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETPRINTWRAPMODE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> printWrapState</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETSTYLEAT</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="keyword">static_cast</span><span class="symbol">&lt;</span><span class="type">int</span><span class="symbol">&gt;(</span><span class="normal">wParam</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">Length</span><span class="symbol">())</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">else</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">StyleAt</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_REDO</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">Redo</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SELECTALL</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">SelectAll</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETSAVEPOINT</span><span class="symbol">:</span>
<span class="normal">		pdoc</span><span class="symbol">-&gt;</span><span class="function">SetSavePoint</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETSTYLEDTEXT</span><span class="symbol">:</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lParam </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">				</span><span class="keyword">return</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">			</span><span class="usertype">Sci_TextRange</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">tr </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">reinterpret_cast</span><span class="symbol">&lt;</span><span class="normal">Sci_TextRange </span><span class="symbol">*&gt;(</span><span class="normal">lParam</span><span class="symbol">);</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> iPlace </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">			</span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="normal"> iChar </span><span class="symbol">=</span><span class="normal"> tr</span><span class="symbol">-&gt;</span><span class="normal">chrg</span><span class="symbol">.</span><span class="normal">cpMin</span><span class="symbol">;</span><span class="normal"> iChar </span><span class="symbol">&lt;</span><span class="normal"> tr</span><span class="symbol">-&gt;</span><span class="normal">chrg</span><span class="symbol">.</span><span class="normal">cpMax</span><span class="symbol">;</span><span class="normal"> iChar</span><span class="symbol">++)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				tr</span><span class="symbol">-&gt;</span><span class="normal">lpstrText</span><span class="symbol">[</span><span class="normal">iPlace</span><span class="symbol">++]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">CharAt</span><span class="symbol">(</span><span class="normal">iChar</span><span class="symbol">);</span>
<span class="normal">				tr</span><span class="symbol">-&gt;</span><span class="normal">lpstrText</span><span class="symbol">[</span><span class="normal">iPlace</span><span class="symbol">++]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">StyleAt</span><span class="symbol">(</span><span class="normal">iChar</span><span class="symbol">);</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">			tr</span><span class="symbol">-&gt;</span><span class="normal">lpstrText</span><span class="symbol">[</span><span class="normal">iPlace</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="string">'</span><span class="specialchar">\0</span><span class="string">'</span><span class="symbol">;</span>
<span class="normal">			tr</span><span class="symbol">-&gt;</span><span class="normal">lpstrText</span><span class="symbol">[</span><span class="normal">iPlace </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="string">'</span><span class="specialchar">\0</span><span class="string">'</span><span class="symbol">;</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> iPlace</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_CANREDO</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">CanRedo</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">!</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">IsReadOnly</span><span class="symbol">())</span><span class="normal"> </span><span class="symbol">?</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">:</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_MARKERLINEFROMHANDLE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineFromHandle</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_MARKERDELETEHANDLE</span><span class="symbol">:</span>
<span class="normal">		pdoc</span><span class="symbol">-&gt;</span><span class="function">DeleteMarkFromHandle</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETVIEWWS</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">viewWhitespace</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETVIEWWS</span><span class="symbol">:</span>
<span class="normal">		vs</span><span class="symbol">.</span><span class="normal">viewWhitespace </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">static_cast</span><span class="symbol">&lt;</span><span class="normal">WhiteSpaceVisibility</span><span class="symbol">&gt;(</span><span class="normal">wParam</span><span class="symbol">);</span>
<span class="normal">		</span><span class="function">Redraw</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_POSITIONFROMPOINT</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="function">PositionFromLocation</span><span class="symbol">(</span><span class="function">Point</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">,</span><span class="normal"> lParam</span><span class="symbol">),</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_POSITIONFROMPOINTCLOSE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="function">PositionFromLocation</span><span class="symbol">(</span><span class="function">Point</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">,</span><span class="normal"> lParam</span><span class="symbol">),</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_CHARPOSITIONFROMPOINT</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="function">PositionFromLocation</span><span class="symbol">(</span><span class="function">Point</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">,</span><span class="normal"> lParam</span><span class="symbol">),</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_CHARPOSITIONFROMPOINTCLOSE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="function">PositionFromLocation</span><span class="symbol">(</span><span class="function">Point</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">,</span><span class="normal"> lParam</span><span class="symbol">),</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GOTOLINE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">GoToLine</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GOTOPOS</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">SetEmptySelection</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">);</span>
<span class="normal">		</span><span class="function">EnsureCaretVisible</span><span class="symbol">();</span>
<span class="normal">		</span><span class="function">Redraw</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETCURLINE</span><span class="symbol">:</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> lineCurrentPos </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineFromPosition</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">);</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> lineStart </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">lineCurrentPos</span><span class="symbol">);</span>
<span class="normal">			</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> lineEnd </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineStart</span><span class="symbol">(</span><span class="normal">lineCurrentPos </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lParam </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="keyword">return</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> lineEnd </span><span class="symbol">-</span><span class="normal"> lineStart</span><span class="symbol">;</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">			</span><span class="function">PLATFORM_ASSERT</span><span class="symbol">(</span><span class="normal">wParam </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">);</span>
<span class="normal">			</span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">ptr </span><span class="symbol">=</span><span class="normal"> </span><span class="function">CharPtrFromSPtr</span><span class="symbol">(</span><span class="normal">lParam</span><span class="symbol">);</span>
<span class="normal">			</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> iPlace </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">			</span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> iChar </span><span class="symbol">=</span><span class="normal"> lineStart</span><span class="symbol">;</span><span class="normal"> iChar </span><span class="symbol">&lt;</span><span class="normal"> lineEnd </span><span class="symbol">&amp;&amp;</span><span class="normal"> iPlace </span><span class="symbol">&lt;</span><span class="normal"> wParam </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span><span class="normal"> iChar</span><span class="symbol">++)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				ptr</span><span class="symbol">[</span><span class="normal">iPlace</span><span class="symbol">++]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">CharAt</span><span class="symbol">(</span><span class="normal">iChar</span><span class="symbol">);</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">			ptr</span><span class="symbol">[</span><span class="normal">iPlace</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="string">'</span><span class="specialchar">\0</span><span class="string">'</span><span class="symbol">;</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> currentPos </span><span class="symbol">-</span><span class="normal"> lineStart</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETENDSTYLED</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">GetEndStyled</span><span class="symbol">();</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETEOLMODE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="normal">eolMode</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETEOLMODE</span><span class="symbol">:</span>
<span class="normal">		pdoc</span><span class="symbol">-&gt;</span><span class="normal">eolMode </span><span class="symbol">=</span><span class="normal"> wParam</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_STARTSTYLING</span><span class="symbol">:</span>
<span class="normal">		pdoc</span><span class="symbol">-&gt;</span><span class="function">StartStyling</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">static_cast</span><span class="symbol">&lt;</span><span class="type">char</span><span class="symbol">&gt;(</span><span class="normal">lParam</span><span class="symbol">));</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETSTYLING</span><span class="symbol">:</span>
<span class="normal">		pdoc</span><span class="symbol">-&gt;</span><span class="function">SetStyleFor</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">static_cast</span><span class="symbol">&lt;</span><span class="type">char</span><span class="symbol">&gt;(</span><span class="normal">lParam</span><span class="symbol">));</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETSTYLINGEX</span><span class="symbol">:</span><span class="normal">             </span><span class="comment">// Specify a complete styling buffer</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lParam </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		pdoc</span><span class="symbol">-&gt;</span><span class="function">SetStyles</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">,</span><span class="normal"> </span><span class="function">CharPtrFromSPtr</span><span class="symbol">(</span><span class="normal">lParam</span><span class="symbol">));</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETBUFFEREDDRAW</span><span class="symbol">:</span>
<span class="normal">		bufferedDraw </span><span class="symbol">=</span><span class="normal"> wParam </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETBUFFEREDDRAW</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> bufferedDraw</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETTWOPHASEDRAW</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> twoPhaseDraw</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETTWOPHASEDRAW</span><span class="symbol">:</span>
<span class="normal">		twoPhaseDraw </span><span class="symbol">=</span><span class="normal"> wParam </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		</span><span class="function">InvalidateStyleRedraw</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETTABWIDTH</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">wParam </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			pdoc</span><span class="symbol">-&gt;</span><span class="normal">tabInChars </span><span class="symbol">=</span><span class="normal"> wParam</span><span class="symbol">;</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="normal">indentInChars </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">				pdoc</span><span class="symbol">-&gt;</span><span class="normal">actualIndentInChars </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="normal">tabInChars</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="function">InvalidateStyleRedraw</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETTABWIDTH</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="normal">tabInChars</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETINDENT</span><span class="symbol">:</span>
<span class="normal">		pdoc</span><span class="symbol">-&gt;</span><span class="normal">indentInChars </span><span class="symbol">=</span><span class="normal"> wParam</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="normal">indentInChars </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">			pdoc</span><span class="symbol">-&gt;</span><span class="normal">actualIndentInChars </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="normal">indentInChars</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">else</span>
<span class="normal">			pdoc</span><span class="symbol">-&gt;</span><span class="normal">actualIndentInChars </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="normal">tabInChars</span><span class="symbol">;</span>
<span class="normal">		</span><span class="function">InvalidateStyleRedraw</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETINDENT</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="normal">indentInChars</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETUSETABS</span><span class="symbol">:</span>
<span class="normal">		pdoc</span><span class="symbol">-&gt;</span><span class="normal">useTabs </span><span class="symbol">=</span><span class="normal"> wParam </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		</span><span class="function">InvalidateStyleRedraw</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETUSETABS</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="normal">useTabs</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETLINEINDENTATION</span><span class="symbol">:</span>
<span class="normal">		pdoc</span><span class="symbol">-&gt;</span><span class="function">SetLineIndentation</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">,</span><span class="normal"> lParam</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETLINEINDENTATION</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">GetLineIndentation</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETLINEINDENTPOSITION</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">GetLineIndentPosition</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETTABINDENTS</span><span class="symbol">:</span>
<span class="normal">		pdoc</span><span class="symbol">-&gt;</span><span class="normal">tabIndents </span><span class="symbol">=</span><span class="normal"> wParam </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETTABINDENTS</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="normal">tabIndents</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETBACKSPACEUNINDENTS</span><span class="symbol">:</span>
<span class="normal">		pdoc</span><span class="symbol">-&gt;</span><span class="normal">backspaceUnindents </span><span class="symbol">=</span><span class="normal"> wParam </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETBACKSPACEUNINDENTS</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="normal">backspaceUnindents</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETMOUSEDWELLTIME</span><span class="symbol">:</span>
<span class="normal">		dwellDelay </span><span class="symbol">=</span><span class="normal"> wParam</span><span class="symbol">;</span>
<span class="normal">		ticksToDwell </span><span class="symbol">=</span><span class="normal"> dwellDelay</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETMOUSEDWELLTIME</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> dwellDelay</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_WORDSTARTPOSITION</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">ExtendWordSelect</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> lParam </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_WORDENDPOSITION</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">ExtendWordSelect</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">,</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span><span class="normal"> lParam </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETWRAPMODE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">switch</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">case</span><span class="normal"> SC_WRAP_WORD</span><span class="symbol">:</span>
<span class="normal">			wrapState </span><span class="symbol">=</span><span class="normal"> eWrapWord</span><span class="symbol">;</span>
<span class="normal">			</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">case</span><span class="normal"> SC_WRAP_CHAR</span><span class="symbol">:</span>
<span class="normal">			wrapState </span><span class="symbol">=</span><span class="normal"> eWrapChar</span><span class="symbol">;</span>
<span class="normal">			</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="label">		default:</span>
<span class="normal">			wrapState </span><span class="symbol">=</span><span class="normal"> eWrapNone</span><span class="symbol">;</span>
<span class="normal">			</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		xOffset </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		</span><span class="function">InvalidateStyleRedraw</span><span class="symbol">();</span>
<span class="normal">		</span><span class="function">ReconfigureScrollBars</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETWRAPMODE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> wrapState</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETWRAPVISUALFLAGS</span><span class="symbol">:</span>
<span class="normal">		wrapVisualFlags </span><span class="symbol">=</span><span class="normal"> wParam</span><span class="symbol">;</span>
<span class="normal">		</span><span class="function">InvalidateStyleRedraw</span><span class="symbol">();</span>
<span class="normal">		</span><span class="function">ReconfigureScrollBars</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETWRAPVISUALFLAGS</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> wrapVisualFlags</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETWRAPVISUALFLAGSLOCATION</span><span class="symbol">:</span>
<span class="normal">		wrapVisualFlagsLocation </span><span class="symbol">=</span><span class="normal"> wParam</span><span class="symbol">;</span>
<span class="normal">		</span><span class="function">InvalidateStyleRedraw</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETWRAPVISUALFLAGSLOCATION</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> wrapVisualFlagsLocation</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETWRAPSTARTINDENT</span><span class="symbol">:</span>
<span class="normal">		wrapVisualStartIndent </span><span class="symbol">=</span><span class="normal"> wParam</span><span class="symbol">;</span>
<span class="normal">		</span><span class="function">InvalidateStyleRedraw</span><span class="symbol">();</span>
<span class="normal">		</span><span class="function">ReconfigureScrollBars</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETWRAPSTARTINDENT</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> wrapVisualStartIndent</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETWRAPINDENTMODE</span><span class="symbol">:</span>
<span class="normal">		wrapIndentMode </span><span class="symbol">=</span><span class="normal"> wParam</span><span class="symbol">;</span>
<span class="normal">		</span><span class="function">InvalidateStyleRedraw</span><span class="symbol">();</span>
<span class="normal">		</span><span class="function">ReconfigureScrollBars</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETWRAPINDENTMODE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> wrapIndentMode</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETLAYOUTCACHE</span><span class="symbol">:</span>
<span class="normal">		llc</span><span class="symbol">.</span><span class="function">SetLevel</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETLAYOUTCACHE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> llc</span><span class="symbol">.</span><span class="function">GetLevel</span><span class="symbol">();</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETPOSITIONCACHE</span><span class="symbol">:</span>
<span class="normal">		posCache</span><span class="symbol">.</span><span class="function">SetSize</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETPOSITIONCACHE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> posCache</span><span class="symbol">.</span><span class="function">GetSize</span><span class="symbol">();</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETSCROLLWIDTH</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">PLATFORM_ASSERT</span><span class="symbol">(</span><span class="normal">wParam </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">wParam </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">wParam </span><span class="symbol">!=</span><span class="normal"> </span><span class="keyword">static_cast</span><span class="symbol">&lt;</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> </span><span class="symbol">&gt;(</span><span class="normal">scrollWidth</span><span class="symbol">)))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			lineWidthMaxSeen </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">			scrollWidth </span><span class="symbol">=</span><span class="normal"> wParam</span><span class="symbol">;</span>
<span class="normal">			</span><span class="function">SetScrollBars</span><span class="symbol">();</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETSCROLLWIDTH</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> scrollWidth</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETSCROLLWIDTHTRACKING</span><span class="symbol">:</span>
<span class="normal">		trackLineWidth </span><span class="symbol">=</span><span class="normal"> wParam </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETSCROLLWIDTHTRACKING</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> trackLineWidth</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_LINESJOIN</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">LinesJoin</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_LINESSPLIT</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">LinesSplit</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_TEXTWIDTH</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">PLATFORM_ASSERT</span><span class="symbol">(</span><span class="normal">wParam </span><span class="symbol">&lt;</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">stylesSize</span><span class="symbol">);</span>
<span class="normal">		</span><span class="function">PLATFORM_ASSERT</span><span class="symbol">(</span><span class="normal">lParam</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="function">TextWidth</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">,</span><span class="normal"> </span><span class="function">CharPtrFromSPtr</span><span class="symbol">(</span><span class="normal">lParam</span><span class="symbol">));</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_TEXTHEIGHT</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">lineHeight</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETENDATLASTLINE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">PLATFORM_ASSERT</span><span class="symbol">((</span><span class="normal">wParam </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">wParam </span><span class="symbol">==</span><span class="normal"> </span><span class="number">1</span><span class="symbol">));</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">endAtLastLine </span><span class="symbol">!=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">wParam </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			endAtLastLine </span><span class="symbol">=</span><span class="normal"> wParam </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">			</span><span class="function">SetScrollBars</span><span class="symbol">();</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETENDATLASTLINE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> endAtLastLine</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETCARETSTICKY</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">PLATFORM_ASSERT</span><span class="symbol">((</span><span class="normal">wParam </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">wParam </span><span class="symbol">==</span><span class="normal"> </span><span class="number">1</span><span class="symbol">));</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">caretSticky </span><span class="symbol">!=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">wParam </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			caretSticky </span><span class="symbol">=</span><span class="normal"> wParam </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETCARETSTICKY</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> caretSticky</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_TOGGLECARETSTICKY</span><span class="symbol">:</span>
<span class="normal">		caretSticky </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">!</span><span class="normal">caretSticky</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETCOLUMN</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">GetColumn</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_FINDCOLUMN</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">FindColumn</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">,</span><span class="normal"> lParam</span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETHSCROLLBAR </span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">horizontalScrollBarVisible </span><span class="symbol">!=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">wParam </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			horizontalScrollBarVisible </span><span class="symbol">=</span><span class="normal"> wParam </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">			</span><span class="function">SetScrollBars</span><span class="symbol">();</span>
<span class="normal">			</span><span class="function">ReconfigureScrollBars</span><span class="symbol">();</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETHSCROLLBAR</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> horizontalScrollBarVisible</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETVSCROLLBAR</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">verticalScrollBarVisible </span><span class="symbol">!=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">wParam </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			verticalScrollBarVisible </span><span class="symbol">=</span><span class="normal"> wParam </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">			</span><span class="function">SetScrollBars</span><span class="symbol">();</span>
<span class="normal">			</span><span class="function">ReconfigureScrollBars</span><span class="symbol">();</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETVSCROLLBAR</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> verticalScrollBarVisible</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETINDENTATIONGUIDES</span><span class="symbol">:</span>
<span class="normal">		vs</span><span class="symbol">.</span><span class="normal">viewIndentationGuides </span><span class="symbol">=</span><span class="normal"> </span><span class="function">IndentView</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">);</span>
<span class="normal">		</span><span class="function">Redraw</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETINDENTATIONGUIDES</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">viewIndentationGuides</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETHIGHLIGHTGUIDE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">highlightGuideColumn </span><span class="symbol">!=</span><span class="normal"> </span><span class="keyword">static_cast</span><span class="symbol">&lt;</span><span class="type">int</span><span class="symbol">&gt;(</span><span class="normal">wParam</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">wParam </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			highlightGuideColumn </span><span class="symbol">=</span><span class="normal"> wParam</span><span class="symbol">;</span>
<span class="normal">			</span><span class="function">Redraw</span><span class="symbol">();</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETHIGHLIGHTGUIDE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> highlightGuideColumn</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETLINEENDPOSITION</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LineEnd</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETCODEPAGE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">ValidCodePage</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			pdoc</span><span class="symbol">-&gt;</span><span class="normal">dbcsCodePage </span><span class="symbol">=</span><span class="normal"> wParam</span><span class="symbol">;</span>
<span class="normal">			</span><span class="function">InvalidateStyleRedraw</span><span class="symbol">();</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETCODEPAGE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="normal">dbcsCodePage</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETUSEPALETTE</span><span class="symbol">:</span>
<span class="normal">		palette</span><span class="symbol">.</span><span class="normal">allowRealization </span><span class="symbol">=</span><span class="normal"> wParam </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		</span><span class="function">InvalidateStyleRedraw</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETUSEPALETTE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> palette</span><span class="symbol">.</span><span class="normal">allowRealization</span><span class="symbol">;</span>

<span class="normal">		</span><span class="comment">// Marker definition and setting</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_MARKERDEFINE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">wParam </span><span class="symbol">&lt;=</span><span class="normal"> MARKER_MAX</span><span class="symbol">)</span>
<span class="normal">			vs</span><span class="symbol">.</span><span class="normal">markers</span><span class="symbol">[</span><span class="normal">wParam</span><span class="symbol">].</span><span class="normal">markType </span><span class="symbol">=</span><span class="normal"> lParam</span><span class="symbol">;</span>
<span class="normal">		</span><span class="function">InvalidateStyleData</span><span class="symbol">();</span>
<span class="normal">		</span><span class="function">RedrawSelMargin</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_MARKERSYMBOLDEFINED</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">wParam </span><span class="symbol">&lt;=</span><span class="normal"> MARKER_MAX</span><span class="symbol">)</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">markers</span><span class="symbol">[</span><span class="normal">wParam</span><span class="symbol">].</span><span class="normal">markType</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">else</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_MARKERSETFORE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">wParam </span><span class="symbol">&lt;=</span><span class="normal"> MARKER_MAX</span><span class="symbol">)</span>
<span class="normal">			vs</span><span class="symbol">.</span><span class="normal">markers</span><span class="symbol">[</span><span class="normal">wParam</span><span class="symbol">].</span><span class="normal">fore</span><span class="symbol">.</span><span class="normal">desired </span><span class="symbol">=</span><span class="normal"> </span><span class="function">ColourDesired</span><span class="symbol">(</span><span class="normal">lParam</span><span class="symbol">);</span>
<span class="normal">		</span><span class="function">InvalidateStyleData</span><span class="symbol">();</span>
<span class="normal">		</span><span class="function">RedrawSelMargin</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_MARKERSETBACK</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">wParam </span><span class="symbol">&lt;=</span><span class="normal"> MARKER_MAX</span><span class="symbol">)</span>
<span class="normal">			vs</span><span class="symbol">.</span><span class="normal">markers</span><span class="symbol">[</span><span class="normal">wParam</span><span class="symbol">].</span><span class="normal">back</span><span class="symbol">.</span><span class="normal">desired </span><span class="symbol">=</span><span class="normal"> </span><span class="function">ColourDesired</span><span class="symbol">(</span><span class="normal">lParam</span><span class="symbol">);</span>
<span class="normal">		</span><span class="function">InvalidateStyleData</span><span class="symbol">();</span>
<span class="normal">		</span><span class="function">RedrawSelMargin</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_MARKERSETALPHA</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">wParam </span><span class="symbol">&lt;=</span><span class="normal"> MARKER_MAX</span><span class="symbol">)</span>
<span class="normal">			vs</span><span class="symbol">.</span><span class="normal">markers</span><span class="symbol">[</span><span class="normal">wParam</span><span class="symbol">].</span><span class="normal">alpha </span><span class="symbol">=</span><span class="normal"> lParam</span><span class="symbol">;</span>
<span class="normal">		</span><span class="function">InvalidateStyleRedraw</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_MARKERADD</span><span class="symbol">:</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> markerID </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">AddMark</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">,</span><span class="normal"> lParam</span><span class="symbol">);</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> markerID</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_MARKERADDSET</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lParam </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">			pdoc</span><span class="symbol">-&gt;</span><span class="function">AddMarkSet</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">,</span><span class="normal"> lParam</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_MARKERDELETE</span><span class="symbol">:</span>
<span class="normal">		pdoc</span><span class="symbol">-&gt;</span><span class="function">DeleteMark</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">,</span><span class="normal"> lParam</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_MARKERDELETEALL</span><span class="symbol">:</span>
<span class="normal">		pdoc</span><span class="symbol">-&gt;</span><span class="function">DeleteAllMarks</span><span class="symbol">(</span><span class="keyword">static_cast</span><span class="symbol">&lt;</span><span class="type">int</span><span class="symbol">&gt;(</span><span class="normal">wParam</span><span class="symbol">));</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_MARKERGET</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">GetMark</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_MARKERNEXT</span><span class="symbol">:</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> lt </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">LinesTotal</span><span class="symbol">();</span>
<span class="normal">			</span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="normal"> iLine </span><span class="symbol">=</span><span class="normal"> wParam</span><span class="symbol">;</span><span class="normal"> iLine </span><span class="symbol">&lt;</span><span class="normal"> lt</span><span class="symbol">;</span><span class="normal"> iLine</span><span class="symbol">++)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">GetMark</span><span class="symbol">(</span><span class="normal">iLine</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> lParam</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">					</span><span class="keyword">return</span><span class="normal"> iLine</span><span class="symbol">;</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_MARKERPREVIOUS</span><span class="symbol">:</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="normal"> iLine </span><span class="symbol">=</span><span class="normal"> wParam</span><span class="symbol">;</span><span class="normal"> iLine </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> iLine</span><span class="symbol">--)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">GetMark</span><span class="symbol">(</span><span class="normal">iLine</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal"> lParam</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">					</span><span class="keyword">return</span><span class="normal"> iLine</span><span class="symbol">;</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_MARKERDEFINEPIXMAP</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">wParam </span><span class="symbol">&lt;=</span><span class="normal"> MARKER_MAX</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			vs</span><span class="symbol">.</span><span class="normal">markers</span><span class="symbol">[</span><span class="normal">wParam</span><span class="symbol">].</span><span class="function">SetXPM</span><span class="symbol">(</span><span class="function">CharPtrFromSPtr</span><span class="symbol">(</span><span class="normal">lParam</span><span class="symbol">));</span>
<span class="normal">		</span><span class="cbracket">}</span><span class="symbol">;</span>
<span class="normal">		</span><span class="function">InvalidateStyleData</span><span class="symbol">();</span>
<span class="normal">		</span><span class="function">RedrawSelMargin</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETMARGINTYPEN</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">ValidMargin</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			vs</span><span class="symbol">.</span><span class="normal">ms</span><span class="symbol">[</span><span class="normal">wParam</span><span class="symbol">].</span><span class="normal">style </span><span class="symbol">=</span><span class="normal"> lParam</span><span class="symbol">;</span>
<span class="normal">			</span><span class="function">InvalidateStyleRedraw</span><span class="symbol">();</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETMARGINTYPEN</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">ValidMargin</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">))</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">ms</span><span class="symbol">[</span><span class="normal">wParam</span><span class="symbol">].</span><span class="normal">style</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">else</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETMARGINWIDTHN</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">ValidMargin</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="comment">// Short-circuit if the width is unchanged, to avoid unnecessary redraw.</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vs</span><span class="symbol">.</span><span class="normal">ms</span><span class="symbol">[</span><span class="normal">wParam</span><span class="symbol">].</span><span class="normal">width </span><span class="symbol">!=</span><span class="normal"> lParam</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				vs</span><span class="symbol">.</span><span class="normal">ms</span><span class="symbol">[</span><span class="normal">wParam</span><span class="symbol">].</span><span class="normal">width </span><span class="symbol">=</span><span class="normal"> lParam</span><span class="symbol">;</span>
<span class="normal">				</span><span class="function">InvalidateStyleRedraw</span><span class="symbol">();</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETMARGINWIDTHN</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">ValidMargin</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">))</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">ms</span><span class="symbol">[</span><span class="normal">wParam</span><span class="symbol">].</span><span class="normal">width</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">else</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETMARGINMASKN</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">ValidMargin</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			vs</span><span class="symbol">.</span><span class="normal">ms</span><span class="symbol">[</span><span class="normal">wParam</span><span class="symbol">].</span><span class="normal">mask </span><span class="symbol">=</span><span class="normal"> lParam</span><span class="symbol">;</span>
<span class="normal">			</span><span class="function">InvalidateStyleRedraw</span><span class="symbol">();</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETMARGINMASKN</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">ValidMargin</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">))</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">ms</span><span class="symbol">[</span><span class="normal">wParam</span><span class="symbol">].</span><span class="normal">mask</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">else</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETMARGINSENSITIVEN</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">ValidMargin</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			vs</span><span class="symbol">.</span><span class="normal">ms</span><span class="symbol">[</span><span class="normal">wParam</span><span class="symbol">].</span><span class="normal">sensitive </span><span class="symbol">=</span><span class="normal"> lParam </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">			</span><span class="function">InvalidateStyleRedraw</span><span class="symbol">();</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETMARGINSENSITIVEN</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">ValidMargin</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">))</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">ms</span><span class="symbol">[</span><span class="normal">wParam</span><span class="symbol">].</span><span class="normal">sensitive </span><span class="symbol">?</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">:</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">else</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_STYLECLEARALL</span><span class="symbol">:</span>
<span class="normal">		vs</span><span class="symbol">.</span><span class="function">ClearStyles</span><span class="symbol">();</span>
<span class="normal">		</span><span class="function">InvalidateStyleRedraw</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_STYLESETFORE</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_STYLESETBACK</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_STYLESETBOLD</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_STYLESETITALIC</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_STYLESETEOLFILLED</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_STYLESETSIZE</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_STYLESETFONT</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_STYLESETUNDERLINE</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_STYLESETCASE</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_STYLESETCHARACTERSET</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_STYLESETVISIBLE</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_STYLESETCHANGEABLE</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_STYLESETHOTSPOT</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">StyleSetMessage</span><span class="symbol">(</span><span class="normal">iMessage</span><span class="symbol">,</span><span class="normal"> wParam</span><span class="symbol">,</span><span class="normal"> lParam</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_STYLEGETFORE</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_STYLEGETBACK</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_STYLEGETBOLD</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_STYLEGETITALIC</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_STYLEGETEOLFILLED</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_STYLEGETSIZE</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_STYLEGETFONT</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_STYLEGETUNDERLINE</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_STYLEGETCASE</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_STYLEGETCHARACTERSET</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_STYLEGETVISIBLE</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_STYLEGETCHANGEABLE</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_STYLEGETHOTSPOT</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="function">StyleGetMessage</span><span class="symbol">(</span><span class="normal">iMessage</span><span class="symbol">,</span><span class="normal"> wParam</span><span class="symbol">,</span><span class="normal"> lParam</span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_STYLERESETDEFAULT</span><span class="symbol">:</span>
<span class="normal">		vs</span><span class="symbol">.</span><span class="function">ResetDefaultStyle</span><span class="symbol">();</span>
<span class="normal">		</span><span class="function">InvalidateStyleRedraw</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETSTYLEBITS</span><span class="symbol">:</span>
<span class="normal">		vs</span><span class="symbol">.</span><span class="function">EnsureStyle</span><span class="symbol">((</span><span class="number">1</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> wParam</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">		pdoc</span><span class="symbol">-&gt;</span><span class="function">SetStylingBits</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETSTYLEBITS</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="normal">stylingBits</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETLINESTATE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">SetLineState</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">,</span><span class="normal"> lParam</span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETLINESTATE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">GetLineState</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETMAXLINESTATE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">GetMaxLineState</span><span class="symbol">();</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETCARETLINEVISIBLE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">showCaretLineBackground</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETCARETLINEVISIBLE</span><span class="symbol">:</span>
<span class="normal">		vs</span><span class="symbol">.</span><span class="normal">showCaretLineBackground </span><span class="symbol">=</span><span class="normal"> wParam </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		</span><span class="function">InvalidateStyleRedraw</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETCARETLINEBACK</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">caretLineBackground</span><span class="symbol">.</span><span class="normal">desired</span><span class="symbol">.</span><span class="function">AsLong</span><span class="symbol">();</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETCARETLINEBACK</span><span class="symbol">:</span>
<span class="normal">		vs</span><span class="symbol">.</span><span class="normal">caretLineBackground</span><span class="symbol">.</span><span class="normal">desired </span><span class="symbol">=</span><span class="normal"> wParam</span><span class="symbol">;</span>
<span class="normal">		</span><span class="function">InvalidateStyleRedraw</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETCARETLINEBACKALPHA</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">caretLineAlpha</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETCARETLINEBACKALPHA</span><span class="symbol">:</span>
<span class="normal">		vs</span><span class="symbol">.</span><span class="normal">caretLineAlpha </span><span class="symbol">=</span><span class="normal"> wParam</span><span class="symbol">;</span>
<span class="normal">		</span><span class="function">InvalidateStyleRedraw</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">		</span><span class="comment">// Folding messages</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_VISIBLEFROMDOCLINE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> cs</span><span class="symbol">.</span><span class="function">DisplayFromDoc</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_DOCLINEFROMVISIBLE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> cs</span><span class="symbol">.</span><span class="function">DocFromDisplay</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_WRAPCOUNT</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="function">WrapCount</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETFOLDLEVEL</span><span class="symbol">:</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="type">int</span><span class="normal"> prev </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">SetLevel</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">,</span><span class="normal"> lParam</span><span class="symbol">);</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">prev </span><span class="symbol">!=</span><span class="normal"> lParam</span><span class="symbol">)</span>
<span class="normal">				</span><span class="function">RedrawSelMargin</span><span class="symbol">();</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> prev</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETFOLDLEVEL</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">GetLevel</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETLASTCHILD</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">GetLastChild</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">,</span><span class="normal"> lParam</span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETFOLDPARENT</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">GetFoldParent</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SHOWLINES</span><span class="symbol">:</span>
<span class="normal">		cs</span><span class="symbol">.</span><span class="function">SetVisible</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">,</span><span class="normal"> lParam</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">);</span>
<span class="normal">		</span><span class="function">SetScrollBars</span><span class="symbol">();</span>
<span class="normal">		</span><span class="function">Redraw</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_HIDELINES</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">wParam </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">			cs</span><span class="symbol">.</span><span class="function">SetVisible</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">,</span><span class="normal"> lParam</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">);</span>
<span class="normal">		</span><span class="function">SetScrollBars</span><span class="symbol">();</span>
<span class="normal">		</span><span class="function">Redraw</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETLINEVISIBLE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> cs</span><span class="symbol">.</span><span class="function">GetVisible</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETFOLDEXPANDED</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">cs</span><span class="symbol">.</span><span class="function">SetExpanded</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">,</span><span class="normal"> lParam </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="function">RedrawSelMargin</span><span class="symbol">();</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETFOLDEXPANDED</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> cs</span><span class="symbol">.</span><span class="function">GetExpanded</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETFOLDFLAGS</span><span class="symbol">:</span>
<span class="normal">		foldFlags </span><span class="symbol">=</span><span class="normal"> wParam</span><span class="symbol">;</span>
<span class="normal">		</span><span class="function">Redraw</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_TOGGLEFOLD</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">ToggleContraction</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_ENSUREVISIBLE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">EnsureLineVisible</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_ENSUREVISIBLEENFORCEPOLICY</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">EnsureLineVisible</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SEARCHANCHOR</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">SearchAnchor</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SEARCHNEXT</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SEARCHPREV</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="function">SearchText</span><span class="symbol">(</span><span class="normal">iMessage</span><span class="symbol">,</span><span class="normal"> wParam</span><span class="symbol">,</span><span class="normal"> lParam</span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETXCARETPOLICY</span><span class="symbol">:</span>
<span class="normal">		caretXPolicy </span><span class="symbol">=</span><span class="normal"> wParam</span><span class="symbol">;</span>
<span class="normal">		caretXSlop </span><span class="symbol">=</span><span class="normal"> lParam</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETYCARETPOLICY</span><span class="symbol">:</span>
<span class="normal">		caretYPolicy </span><span class="symbol">=</span><span class="normal"> wParam</span><span class="symbol">;</span>
<span class="normal">		caretYSlop </span><span class="symbol">=</span><span class="normal"> lParam</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETVISIBLEPOLICY</span><span class="symbol">:</span>
<span class="normal">		visiblePolicy </span><span class="symbol">=</span><span class="normal"> wParam</span><span class="symbol">;</span>
<span class="normal">		visibleSlop </span><span class="symbol">=</span><span class="normal"> lParam</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_LINESONSCREEN</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="function">LinesOnScreen</span><span class="symbol">();</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETSELFORE</span><span class="symbol">:</span>
<span class="normal">		vs</span><span class="symbol">.</span><span class="normal">selforeset </span><span class="symbol">=</span><span class="normal"> wParam </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		vs</span><span class="symbol">.</span><span class="normal">selforeground</span><span class="symbol">.</span><span class="normal">desired </span><span class="symbol">=</span><span class="normal"> </span><span class="function">ColourDesired</span><span class="symbol">(</span><span class="normal">lParam</span><span class="symbol">);</span>
<span class="normal">		</span><span class="function">InvalidateStyleRedraw</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETSELBACK</span><span class="symbol">:</span>
<span class="normal">		vs</span><span class="symbol">.</span><span class="normal">selbackset </span><span class="symbol">=</span><span class="normal"> wParam </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		vs</span><span class="symbol">.</span><span class="normal">selbackground</span><span class="symbol">.</span><span class="normal">desired </span><span class="symbol">=</span><span class="normal"> </span><span class="function">ColourDesired</span><span class="symbol">(</span><span class="normal">lParam</span><span class="symbol">);</span>
<span class="normal">		</span><span class="function">InvalidateStyleRedraw</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETSELALPHA</span><span class="symbol">:</span>
<span class="normal">		vs</span><span class="symbol">.</span><span class="normal">selAlpha </span><span class="symbol">=</span><span class="normal"> wParam</span><span class="symbol">;</span>
<span class="normal">		</span><span class="function">InvalidateStyleRedraw</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETSELALPHA</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">selAlpha</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETSELEOLFILLED</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">selEOLFilled</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETSELEOLFILLED</span><span class="symbol">:</span>
<span class="normal">		vs</span><span class="symbol">.</span><span class="normal">selEOLFilled </span><span class="symbol">=</span><span class="normal"> wParam </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		</span><span class="function">InvalidateStyleRedraw</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETWHITESPACEFORE</span><span class="symbol">:</span>
<span class="normal">		vs</span><span class="symbol">.</span><span class="normal">whitespaceForegroundSet </span><span class="symbol">=</span><span class="normal"> wParam </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		vs</span><span class="symbol">.</span><span class="normal">whitespaceForeground</span><span class="symbol">.</span><span class="normal">desired </span><span class="symbol">=</span><span class="normal"> </span><span class="function">ColourDesired</span><span class="symbol">(</span><span class="normal">lParam</span><span class="symbol">);</span>
<span class="normal">		</span><span class="function">InvalidateStyleRedraw</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETWHITESPACEBACK</span><span class="symbol">:</span>
<span class="normal">		vs</span><span class="symbol">.</span><span class="normal">whitespaceBackgroundSet </span><span class="symbol">=</span><span class="normal"> wParam </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		vs</span><span class="symbol">.</span><span class="normal">whitespaceBackground</span><span class="symbol">.</span><span class="normal">desired </span><span class="symbol">=</span><span class="normal"> </span><span class="function">ColourDesired</span><span class="symbol">(</span><span class="normal">lParam</span><span class="symbol">);</span>
<span class="normal">		</span><span class="function">InvalidateStyleRedraw</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETCARETFORE</span><span class="symbol">:</span>
<span class="normal">		vs</span><span class="symbol">.</span><span class="normal">caretcolour</span><span class="symbol">.</span><span class="normal">desired </span><span class="symbol">=</span><span class="normal"> </span><span class="function">ColourDesired</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">);</span>
<span class="normal">		</span><span class="function">InvalidateStyleRedraw</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETCARETFORE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">caretcolour</span><span class="symbol">.</span><span class="normal">desired</span><span class="symbol">.</span><span class="function">AsLong</span><span class="symbol">();</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETCARETSTYLE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">wParam </span><span class="symbol">&gt;=</span><span class="normal"> CARETSTYLE_INVISIBLE </span><span class="symbol">&amp;&amp;</span><span class="normal"> wParam </span><span class="symbol">&lt;=</span><span class="normal"> CARETSTYLE_BLOCK</span><span class="symbol">)</span>
<span class="normal">			vs</span><span class="symbol">.</span><span class="normal">caretStyle </span><span class="symbol">=</span><span class="normal"> wParam</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">else</span>
<span class="normal">			</span><span class="comment">/* Default to the line caret */</span>
<span class="normal">			vs</span><span class="symbol">.</span><span class="normal">caretStyle </span><span class="symbol">=</span><span class="normal"> CARETSTYLE_LINE</span><span class="symbol">;</span>
<span class="normal">		</span><span class="function">InvalidateStyleRedraw</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETCARETSTYLE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">caretStyle</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETCARETWIDTH</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">wParam </span><span class="symbol">&lt;=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">			vs</span><span class="symbol">.</span><span class="normal">caretWidth </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">wParam </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">3</span><span class="symbol">)</span>
<span class="normal">			vs</span><span class="symbol">.</span><span class="normal">caretWidth </span><span class="symbol">=</span><span class="normal"> </span><span class="number">3</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">else</span>
<span class="normal">			vs</span><span class="symbol">.</span><span class="normal">caretWidth </span><span class="symbol">=</span><span class="normal"> wParam</span><span class="symbol">;</span>
<span class="normal">		</span><span class="function">InvalidateStyleRedraw</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETCARETWIDTH</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">caretWidth</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_ASSIGNCMDKEY</span><span class="symbol">:</span>
<span class="normal">		kmap</span><span class="symbol">.</span><span class="function">AssignCmdKey</span><span class="symbol">(</span><span class="normal">Platform</span><span class="symbol">::</span><span class="function">LowShortFromLong</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">),</span>
<span class="normal">		        Platform</span><span class="symbol">::</span><span class="function">HighShortFromLong</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">),</span><span class="normal"> lParam</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_CLEARCMDKEY</span><span class="symbol">:</span>
<span class="normal">		kmap</span><span class="symbol">.</span><span class="function">AssignCmdKey</span><span class="symbol">(</span><span class="normal">Platform</span><span class="symbol">::</span><span class="function">LowShortFromLong</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">),</span>
<span class="normal">		        Platform</span><span class="symbol">::</span><span class="function">HighShortFromLong</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">),</span><span class="normal"> SCI_NULL</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_CLEARALLCMDKEYS</span><span class="symbol">:</span>
<span class="normal">		kmap</span><span class="symbol">.</span><span class="function">Clear</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_INDICSETSTYLE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">wParam </span><span class="symbol">&lt;=</span><span class="normal"> INDIC_MAX</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			vs</span><span class="symbol">.</span><span class="normal">indicators</span><span class="symbol">[</span><span class="normal">wParam</span><span class="symbol">].</span><span class="normal">style </span><span class="symbol">=</span><span class="normal"> lParam</span><span class="symbol">;</span>
<span class="normal">			</span><span class="function">InvalidateStyleRedraw</span><span class="symbol">();</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_INDICGETSTYLE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">wParam </span><span class="symbol">&lt;=</span><span class="normal"> INDIC_MAX</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">?</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">indicators</span><span class="symbol">[</span><span class="normal">wParam</span><span class="symbol">].</span><span class="normal">style </span><span class="symbol">:</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_INDICSETFORE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">wParam </span><span class="symbol">&lt;=</span><span class="normal"> INDIC_MAX</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			vs</span><span class="symbol">.</span><span class="normal">indicators</span><span class="symbol">[</span><span class="normal">wParam</span><span class="symbol">].</span><span class="normal">fore</span><span class="symbol">.</span><span class="normal">desired </span><span class="symbol">=</span><span class="normal"> </span><span class="function">ColourDesired</span><span class="symbol">(</span><span class="normal">lParam</span><span class="symbol">);</span>
<span class="normal">			</span><span class="function">InvalidateStyleRedraw</span><span class="symbol">();</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_INDICGETFORE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">wParam </span><span class="symbol">&lt;=</span><span class="normal"> INDIC_MAX</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">?</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">indicators</span><span class="symbol">[</span><span class="normal">wParam</span><span class="symbol">].</span><span class="normal">fore</span><span class="symbol">.</span><span class="normal">desired</span><span class="symbol">.</span><span class="function">AsLong</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">:</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_INDICSETUNDER</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">wParam </span><span class="symbol">&lt;=</span><span class="normal"> INDIC_MAX</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			vs</span><span class="symbol">.</span><span class="normal">indicators</span><span class="symbol">[</span><span class="normal">wParam</span><span class="symbol">].</span><span class="normal">under </span><span class="symbol">=</span><span class="normal"> lParam </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">			</span><span class="function">InvalidateStyleRedraw</span><span class="symbol">();</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_INDICGETUNDER</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">wParam </span><span class="symbol">&lt;=</span><span class="normal"> INDIC_MAX</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">?</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">indicators</span><span class="symbol">[</span><span class="normal">wParam</span><span class="symbol">].</span><span class="normal">under </span><span class="symbol">:</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_INDICSETALPHA</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">wParam </span><span class="symbol">&lt;=</span><span class="normal"> INDIC_MAX </span><span class="symbol">&amp;&amp;</span><span class="normal"> lParam </span><span class="symbol">&gt;=</span><span class="number">0</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> lParam </span><span class="symbol">&lt;=</span><span class="normal"> </span><span class="number">100</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			vs</span><span class="symbol">.</span><span class="normal">indicators</span><span class="symbol">[</span><span class="normal">wParam</span><span class="symbol">].</span><span class="normal">fillAlpha </span><span class="symbol">=</span><span class="normal"> lParam</span><span class="symbol">;</span>
<span class="normal">			</span><span class="function">InvalidateStyleRedraw</span><span class="symbol">();</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_INDICGETALPHA</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">wParam </span><span class="symbol">&lt;=</span><span class="normal"> INDIC_MAX</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">?</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">indicators</span><span class="symbol">[</span><span class="normal">wParam</span><span class="symbol">].</span><span class="normal">fillAlpha </span><span class="symbol">:</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETINDICATORCURRENT</span><span class="symbol">:</span>
<span class="normal">		pdoc</span><span class="symbol">-&gt;</span><span class="normal">decorations</span><span class="symbol">.</span><span class="function">SetCurrentIndicator</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETINDICATORCURRENT</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="normal">decorations</span><span class="symbol">.</span><span class="function">GetCurrentIndicator</span><span class="symbol">();</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETINDICATORVALUE</span><span class="symbol">:</span>
<span class="normal">		pdoc</span><span class="symbol">-&gt;</span><span class="normal">decorations</span><span class="symbol">.</span><span class="function">SetCurrentValue</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETINDICATORVALUE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="normal">decorations</span><span class="symbol">.</span><span class="function">GetCurrentValue</span><span class="symbol">();</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_INDICATORFILLRANGE</span><span class="symbol">:</span>
<span class="normal">		pdoc</span><span class="symbol">-&gt;</span><span class="function">DecorationFillRange</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">,</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="normal">decorations</span><span class="symbol">.</span><span class="function">GetCurrentValue</span><span class="symbol">(),</span><span class="normal"> lParam</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_INDICATORCLEARRANGE</span><span class="symbol">:</span>
<span class="normal">		pdoc</span><span class="symbol">-&gt;</span><span class="function">DecorationFillRange</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> lParam</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_INDICATORALLONFOR</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="normal">decorations</span><span class="symbol">.</span><span class="function">AllOnFor</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_INDICATORVALUEAT</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="normal">decorations</span><span class="symbol">.</span><span class="function">ValueAt</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">,</span><span class="normal"> lParam</span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_INDICATORSTART</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="normal">decorations</span><span class="symbol">.</span><span class="function">Start</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">,</span><span class="normal"> lParam</span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_INDICATOREND</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="normal">decorations</span><span class="symbol">.</span><span class="function">End</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">,</span><span class="normal"> lParam</span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_LINEDOWN</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_LINEDOWNEXTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_PARADOWN</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_PARADOWNEXTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_LINEUP</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_LINEUPEXTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_PARAUP</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_PARAUPEXTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_CHARLEFT</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_CHARLEFTEXTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_CHARRIGHT</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_CHARRIGHTEXTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_WORDLEFT</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_WORDLEFTEXTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_WORDRIGHT</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_WORDRIGHTEXTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_WORDLEFTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_WORDLEFTENDEXTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_WORDRIGHTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_WORDRIGHTENDEXTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_HOME</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_HOMEEXTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_LINEEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_LINEENDEXTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_HOMEWRAP</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_HOMEWRAPEXTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_LINEENDWRAP</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_LINEENDWRAPEXTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_DOCUMENTSTART</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_DOCUMENTSTARTEXTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_DOCUMENTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_DOCUMENTENDEXTEND</span><span class="symbol">:</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_STUTTEREDPAGEUP</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_STUTTEREDPAGEUPEXTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_STUTTEREDPAGEDOWN</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_STUTTEREDPAGEDOWNEXTEND</span><span class="symbol">:</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_PAGEUP</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_PAGEUPEXTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_PAGEDOWN</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_PAGEDOWNEXTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_EDITTOGGLEOVERTYPE</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_CANCEL</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_DELETEBACK</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_TAB</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_BACKTAB</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_NEWLINE</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_FORMFEED</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_VCHOME</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_VCHOMEEXTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_VCHOMEWRAP</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_VCHOMEWRAPEXTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_ZOOMIN</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_ZOOMOUT</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_DELWORDLEFT</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_DELWORDRIGHT</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_DELWORDRIGHTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_DELLINELEFT</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_DELLINERIGHT</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_LINECOPY</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_LINECUT</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_LINEDELETE</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_LINETRANSPOSE</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_LINEDUPLICATE</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_LOWERCASE</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_UPPERCASE</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_LINESCROLLDOWN</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_LINESCROLLUP</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_WORDPARTLEFT</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_WORDPARTLEFTEXTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_WORDPARTRIGHT</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_WORDPARTRIGHTEXTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_DELETEBACKNOTLINE</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_HOMEDISPLAY</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_HOMEDISPLAYEXTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_LINEENDDISPLAY</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_LINEENDDISPLAYEXTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_LINEDOWNRECTEXTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_LINEUPRECTEXTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_CHARLEFTRECTEXTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_CHARRIGHTRECTEXTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_HOMERECTEXTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_VCHOMERECTEXTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_LINEENDRECTEXTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_PAGEUPRECTEXTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_PAGEDOWNRECTEXTEND</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SELECTIONDUPLICATE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="function">KeyCommand</span><span class="symbol">(</span><span class="normal">iMessage</span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_BRACEHIGHLIGHT</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">SetBraceHighlight</span><span class="symbol">(</span><span class="keyword">static_cast</span><span class="symbol">&lt;</span><span class="type">int</span><span class="symbol">&gt;(</span><span class="normal">wParam</span><span class="symbol">),</span><span class="normal"> lParam</span><span class="symbol">,</span><span class="normal"> STYLE_BRACELIGHT</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_BRACEBADLIGHT</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">SetBraceHighlight</span><span class="symbol">(</span><span class="keyword">static_cast</span><span class="symbol">&lt;</span><span class="type">int</span><span class="symbol">&gt;(</span><span class="normal">wParam</span><span class="symbol">),</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> STYLE_BRACEBAD</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_BRACEMATCH</span><span class="symbol">:</span>
<span class="normal">		</span><span class="comment">// wParam is position of char to find brace for,</span>
<span class="normal">		</span><span class="comment">// lParam is maximum amount of text to restyle to find it</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">BraceMatch</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">,</span><span class="normal"> lParam</span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETVIEWEOL</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">viewEOL</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETVIEWEOL</span><span class="symbol">:</span>
<span class="normal">		vs</span><span class="symbol">.</span><span class="normal">viewEOL </span><span class="symbol">=</span><span class="normal"> wParam </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		</span><span class="function">InvalidateStyleRedraw</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETZOOM</span><span class="symbol">:</span>
<span class="normal">		vs</span><span class="symbol">.</span><span class="normal">zoomLevel </span><span class="symbol">=</span><span class="normal"> wParam</span><span class="symbol">;</span>
<span class="normal">		</span><span class="function">InvalidateStyleRedraw</span><span class="symbol">();</span>
<span class="normal">		</span><span class="function">NotifyZoom</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETZOOM</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">zoomLevel</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETEDGECOLUMN</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> theEdge</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETEDGECOLUMN</span><span class="symbol">:</span>
<span class="normal">		theEdge </span><span class="symbol">=</span><span class="normal"> wParam</span><span class="symbol">;</span>
<span class="normal">		</span><span class="function">InvalidateStyleRedraw</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETEDGEMODE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">edgeState</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETEDGEMODE</span><span class="symbol">:</span>
<span class="normal">		vs</span><span class="symbol">.</span><span class="normal">edgeState </span><span class="symbol">=</span><span class="normal"> wParam</span><span class="symbol">;</span>
<span class="normal">		</span><span class="function">InvalidateStyleRedraw</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETEDGECOLOUR</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">edgecolour</span><span class="symbol">.</span><span class="normal">desired</span><span class="symbol">.</span><span class="function">AsLong</span><span class="symbol">();</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETEDGECOLOUR</span><span class="symbol">:</span>
<span class="normal">		vs</span><span class="symbol">.</span><span class="normal">edgecolour</span><span class="symbol">.</span><span class="normal">desired </span><span class="symbol">=</span><span class="normal"> </span><span class="function">ColourDesired</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">);</span>
<span class="normal">		</span><span class="function">InvalidateStyleRedraw</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETDOCPOINTER</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="keyword">reinterpret_cast</span><span class="symbol">&lt;</span><span class="normal">sptr_t</span><span class="symbol">&gt;(</span><span class="normal">pdoc</span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETDOCPOINTER</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">CancelModes</span><span class="symbol">();</span>
<span class="normal">		</span><span class="function">SetDocPointer</span><span class="symbol">(</span><span class="keyword">reinterpret_cast</span><span class="symbol">&lt;</span><span class="normal">Document </span><span class="symbol">*&gt;(</span><span class="normal">lParam</span><span class="symbol">));</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_CREATEDOCUMENT</span><span class="symbol">:</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="usertype">Document</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">doc </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">new</span><span class="normal"> </span><span class="function">Document</span><span class="symbol">();</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">doc</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				doc</span><span class="symbol">-&gt;</span><span class="function">AddRef</span><span class="symbol">();</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> </span><span class="keyword">reinterpret_cast</span><span class="symbol">&lt;</span><span class="normal">sptr_t</span><span class="symbol">&gt;(</span><span class="normal">doc</span><span class="symbol">);</span>
<span class="normal">		</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_ADDREFDOCUMENT</span><span class="symbol">:</span>
<span class="normal">		</span><span class="symbol">(</span><span class="keyword">reinterpret_cast</span><span class="symbol">&lt;</span><span class="normal">Document </span><span class="symbol">*&gt;(</span><span class="normal">lParam</span><span class="symbol">))-&gt;</span><span class="function">AddRef</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_RELEASEDOCUMENT</span><span class="symbol">:</span>
<span class="normal">		</span><span class="symbol">(</span><span class="keyword">reinterpret_cast</span><span class="symbol">&lt;</span><span class="normal">Document </span><span class="symbol">*&gt;(</span><span class="normal">lParam</span><span class="symbol">))-&gt;</span><span class="function">Release</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETMODEVENTMASK</span><span class="symbol">:</span>
<span class="normal">		modEventMask </span><span class="symbol">=</span><span class="normal"> wParam</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETMODEVENTMASK</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> modEventMask</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_CONVERTEOLS</span><span class="symbol">:</span>
<span class="normal">		pdoc</span><span class="symbol">-&gt;</span><span class="function">ConvertLineEnds</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">);</span>
<span class="normal">		</span><span class="function">SetSelection</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">,</span><span class="normal"> anchor</span><span class="symbol">);</span><span class="normal">	</span><span class="comment">// Ensure selection inside document</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETLENGTHFORENCODE</span><span class="symbol">:</span>
<span class="normal">		lengthForEncode </span><span class="symbol">=</span><span class="normal"> wParam</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SELECTIONISRECTANGLE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> selType </span><span class="symbol">==</span><span class="normal"> selRectangle </span><span class="symbol">?</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">:</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETSELECTIONMODE</span><span class="symbol">:</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">switch</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">case</span><span class="normal"> SC_SEL_STREAM</span><span class="symbol">:</span>
<span class="normal">				moveExtendsSelection </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">!</span><span class="normal">moveExtendsSelection </span><span class="symbol">||</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">selType </span><span class="symbol">!=</span><span class="normal"> selStream</span><span class="symbol">);</span>
<span class="normal">				selType </span><span class="symbol">=</span><span class="normal"> selStream</span><span class="symbol">;</span>
<span class="normal">				</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">			</span><span class="keyword">case</span><span class="normal"> SC_SEL_RECTANGLE</span><span class="symbol">:</span>
<span class="normal">				moveExtendsSelection </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">!</span><span class="normal">moveExtendsSelection </span><span class="symbol">||</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">selType </span><span class="symbol">!=</span><span class="normal"> selRectangle</span><span class="symbol">);</span>
<span class="normal">				selType </span><span class="symbol">=</span><span class="normal"> selRectangle</span><span class="symbol">;</span>
<span class="normal">				</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">			</span><span class="keyword">case</span><span class="normal"> SC_SEL_LINES</span><span class="symbol">:</span>
<span class="normal">				moveExtendsSelection </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">!</span><span class="normal">moveExtendsSelection </span><span class="symbol">||</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">selType </span><span class="symbol">!=</span><span class="normal"> selLines</span><span class="symbol">);</span>
<span class="normal">				selType </span><span class="symbol">=</span><span class="normal"> selLines</span><span class="symbol">;</span>
<span class="normal">				</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="label">			default:</span>
<span class="normal">				moveExtendsSelection </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">!</span><span class="normal">moveExtendsSelection </span><span class="symbol">||</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">selType </span><span class="symbol">!=</span><span class="normal"> selStream</span><span class="symbol">);</span>
<span class="normal">				selType </span><span class="symbol">=</span><span class="normal"> selStream</span><span class="symbol">;</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">			</span><span class="function">InvalidateSelection</span><span class="symbol">(</span><span class="normal">currentPos</span><span class="symbol">,</span><span class="normal"> anchor</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">);</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETSELECTIONMODE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">switch</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">selType</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">case</span><span class="normal"> selStream</span><span class="symbol">:</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> SC_SEL_STREAM</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">case</span><span class="normal"> selRectangle</span><span class="symbol">:</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> SC_SEL_RECTANGLE</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">case</span><span class="normal"> selLines</span><span class="symbol">:</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> SC_SEL_LINES</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">default</span><span class="symbol">:</span><span class="normal">	</span><span class="comment">// ?!</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> SC_SEL_STREAM</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETLINESELSTARTPOSITION</span><span class="symbol">:</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="usertype">SelectionLineIterator</span><span class="normal"> </span><span class="function">lineIterator</span><span class="symbol">(</span><span class="keyword">this</span><span class="symbol">);</span>
<span class="normal">			lineIterator</span><span class="symbol">.</span><span class="function">SetAt</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">);</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> lineIterator</span><span class="symbol">.</span><span class="normal">startPos</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETLINESELENDPOSITION</span><span class="symbol">:</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="usertype">SelectionLineIterator</span><span class="normal"> </span><span class="function">lineIterator</span><span class="symbol">(</span><span class="keyword">this</span><span class="symbol">);</span>
<span class="normal">			lineIterator</span><span class="symbol">.</span><span class="function">SetAt</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">);</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> lineIterator</span><span class="symbol">.</span><span class="normal">endPos</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETOVERTYPE</span><span class="symbol">:</span>
<span class="normal">		inOverstrike </span><span class="symbol">=</span><span class="normal"> wParam </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETOVERTYPE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> inOverstrike </span><span class="symbol">?</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">:</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETFOCUS</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">SetFocusState</span><span class="symbol">(</span><span class="normal">wParam </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETFOCUS</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> hasFocus</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETSTATUS</span><span class="symbol">:</span>
<span class="normal">		errorStatus </span><span class="symbol">=</span><span class="normal"> wParam</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETSTATUS</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> errorStatus</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETMOUSEDOWNCAPTURES</span><span class="symbol">:</span>
<span class="normal">		mouseDownCaptures </span><span class="symbol">=</span><span class="normal"> wParam </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETMOUSEDOWNCAPTURES</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> mouseDownCaptures</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETCURSOR</span><span class="symbol">:</span>
<span class="normal">		cursorMode </span><span class="symbol">=</span><span class="normal"> wParam</span><span class="symbol">;</span>
<span class="normal">		</span><span class="function">DisplayCursor</span><span class="symbol">(</span><span class="normal">Window</span><span class="symbol">::</span><span class="normal">cursorText</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETCURSOR</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> cursorMode</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETCONTROLCHARSYMBOL</span><span class="symbol">:</span>
<span class="normal">		controlCharSymbol </span><span class="symbol">=</span><span class="normal"> wParam</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETCONTROLCHARSYMBOL</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> controlCharSymbol</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_STARTRECORD</span><span class="symbol">:</span>
<span class="normal">		recordingMacro </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_STOPRECORD</span><span class="symbol">:</span>
<span class="normal">		recordingMacro </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_MOVECARETINSIDEVIEW</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">MoveCaretInsideView</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETFOLDMARGINCOLOUR</span><span class="symbol">:</span>
<span class="normal">		vs</span><span class="symbol">.</span><span class="normal">foldmarginColourSet </span><span class="symbol">=</span><span class="normal"> wParam </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		vs</span><span class="symbol">.</span><span class="normal">foldmarginColour</span><span class="symbol">.</span><span class="normal">desired </span><span class="symbol">=</span><span class="normal"> </span><span class="function">ColourDesired</span><span class="symbol">(</span><span class="normal">lParam</span><span class="symbol">);</span>
<span class="normal">		</span><span class="function">InvalidateStyleRedraw</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETFOLDMARGINHICOLOUR</span><span class="symbol">:</span>
<span class="normal">		vs</span><span class="symbol">.</span><span class="normal">foldmarginHighlightColourSet </span><span class="symbol">=</span><span class="normal"> wParam </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		vs</span><span class="symbol">.</span><span class="normal">foldmarginHighlightColour</span><span class="symbol">.</span><span class="normal">desired </span><span class="symbol">=</span><span class="normal"> </span><span class="function">ColourDesired</span><span class="symbol">(</span><span class="normal">lParam</span><span class="symbol">);</span>
<span class="normal">		</span><span class="function">InvalidateStyleRedraw</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETHOTSPOTACTIVEFORE</span><span class="symbol">:</span>
<span class="normal">		vs</span><span class="symbol">.</span><span class="normal">hotspotForegroundSet </span><span class="symbol">=</span><span class="normal"> wParam </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		vs</span><span class="symbol">.</span><span class="normal">hotspotForeground</span><span class="symbol">.</span><span class="normal">desired </span><span class="symbol">=</span><span class="normal"> </span><span class="function">ColourDesired</span><span class="symbol">(</span><span class="normal">lParam</span><span class="symbol">);</span>
<span class="normal">		</span><span class="function">InvalidateStyleRedraw</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETHOTSPOTACTIVEFORE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">hotspotForeground</span><span class="symbol">.</span><span class="normal">desired</span><span class="symbol">.</span><span class="function">AsLong</span><span class="symbol">();</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETHOTSPOTACTIVEBACK</span><span class="symbol">:</span>
<span class="normal">		vs</span><span class="symbol">.</span><span class="normal">hotspotBackgroundSet </span><span class="symbol">=</span><span class="normal"> wParam </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		vs</span><span class="symbol">.</span><span class="normal">hotspotBackground</span><span class="symbol">.</span><span class="normal">desired </span><span class="symbol">=</span><span class="normal"> </span><span class="function">ColourDesired</span><span class="symbol">(</span><span class="normal">lParam</span><span class="symbol">);</span>
<span class="normal">		</span><span class="function">InvalidateStyleRedraw</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETHOTSPOTACTIVEBACK</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">hotspotBackground</span><span class="symbol">.</span><span class="normal">desired</span><span class="symbol">.</span><span class="function">AsLong</span><span class="symbol">();</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETHOTSPOTACTIVEUNDERLINE</span><span class="symbol">:</span>
<span class="normal">		vs</span><span class="symbol">.</span><span class="normal">hotspotUnderline </span><span class="symbol">=</span><span class="normal"> wParam </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		</span><span class="function">InvalidateStyleRedraw</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETHOTSPOTACTIVEUNDERLINE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">hotspotUnderline </span><span class="symbol">?</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">:</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETHOTSPOTSINGLELINE</span><span class="symbol">:</span>
<span class="normal">		vs</span><span class="symbol">.</span><span class="normal">hotspotSingleLine </span><span class="symbol">=</span><span class="normal"> wParam </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		</span><span class="function">InvalidateStyleRedraw</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETHOTSPOTSINGLELINE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">hotspotSingleLine </span><span class="symbol">?</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">:</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETPASTECONVERTENDINGS</span><span class="symbol">:</span>
<span class="normal">		convertPastes </span><span class="symbol">=</span><span class="normal"> wParam </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETPASTECONVERTENDINGS</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> convertPastes </span><span class="symbol">?</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">:</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETCHARACTERPOINTER</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="keyword">reinterpret_cast</span><span class="symbol">&lt;</span><span class="normal">sptr_t</span><span class="symbol">&gt;(</span><span class="normal">pdoc</span><span class="symbol">-&gt;</span><span class="function">BufferPointer</span><span class="symbol">());</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETEXTRAASCENT</span><span class="symbol">:</span>
<span class="normal">		vs</span><span class="symbol">.</span><span class="normal">extraAscent </span><span class="symbol">=</span><span class="normal"> wParam</span><span class="symbol">;</span>
<span class="normal">		</span><span class="function">InvalidateStyleRedraw</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETEXTRAASCENT</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">extraAscent</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_SETEXTRADESCENT</span><span class="symbol">:</span>
<span class="normal">		vs</span><span class="symbol">.</span><span class="normal">extraDescent </span><span class="symbol">=</span><span class="normal"> wParam</span><span class="symbol">;</span>
<span class="normal">		</span><span class="function">InvalidateStyleRedraw</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_GETEXTRADESCENT</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">extraDescent</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_MARGINSETSTYLEOFFSET</span><span class="symbol">:</span>
<span class="normal">		vs</span><span class="symbol">.</span><span class="normal">marginStyleOffset </span><span class="symbol">=</span><span class="normal"> wParam</span><span class="symbol">;</span>
<span class="normal">		</span><span class="function">InvalidateStyleRedraw</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_MARGINGETSTYLEOFFSET</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">marginStyleOffset</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_MARGINSETTEXT</span><span class="symbol">:</span>
<span class="normal">		pdoc</span><span class="symbol">-&gt;</span><span class="function">MarginSetText</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">,</span><span class="normal"> </span><span class="function">CharPtrFromSPtr</span><span class="symbol">(</span><span class="normal">lParam</span><span class="symbol">));</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_MARGINGETTEXT</span><span class="symbol">:</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">const</span><span class="normal"> </span><span class="usertype">StyledText</span><span class="normal"> st </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">MarginStyledText</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">);</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lParam</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">st</span><span class="symbol">.</span><span class="normal">text</span><span class="symbol">)</span>
<span class="normal">					</span><span class="function">memcpy</span><span class="symbol">(</span><span class="function">CharPtrFromSPtr</span><span class="symbol">(</span><span class="normal">lParam</span><span class="symbol">),</span><span class="normal"> st</span><span class="symbol">.</span><span class="normal">text</span><span class="symbol">,</span><span class="normal"> st</span><span class="symbol">.</span><span class="normal">length</span><span class="symbol">);</span>
<span class="normal">				</span><span class="keyword">else</span>
<span class="normal">					</span><span class="function">strcpy</span><span class="symbol">(</span><span class="function">CharPtrFromSPtr</span><span class="symbol">(</span><span class="normal">lParam</span><span class="symbol">),</span><span class="normal"> </span><span class="string">""</span><span class="symbol">);</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> st</span><span class="symbol">.</span><span class="normal">length</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_MARGINSETSTYLE</span><span class="symbol">:</span>
<span class="normal">		pdoc</span><span class="symbol">-&gt;</span><span class="function">MarginSetStyle</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">,</span><span class="normal"> lParam</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_MARGINGETSTYLE</span><span class="symbol">:</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">const</span><span class="normal"> </span><span class="usertype">StyledText</span><span class="normal"> st </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">MarginStyledText</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">);</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> st</span><span class="symbol">.</span><span class="normal">style</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_MARGINSETSTYLES</span><span class="symbol">:</span>
<span class="normal">		pdoc</span><span class="symbol">-&gt;</span><span class="function">MarginSetStyles</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">reinterpret_cast</span><span class="symbol">&lt;</span><span class="keyword">const</span><span class="normal"> </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*&gt;(</span><span class="normal">lParam</span><span class="symbol">));</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_MARGINGETSTYLES</span><span class="symbol">:</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">const</span><span class="normal"> </span><span class="usertype">StyledText</span><span class="normal"> st </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">MarginStyledText</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">);</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lParam</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">st</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">)</span>
<span class="normal">					</span><span class="function">memcpy</span><span class="symbol">(</span><span class="function">CharPtrFromSPtr</span><span class="symbol">(</span><span class="normal">lParam</span><span class="symbol">),</span><span class="normal"> st</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">,</span><span class="normal"> st</span><span class="symbol">.</span><span class="normal">length</span><span class="symbol">);</span>
<span class="normal">				</span><span class="keyword">else</span>
<span class="normal">					</span><span class="function">strcpy</span><span class="symbol">(</span><span class="function">CharPtrFromSPtr</span><span class="symbol">(</span><span class="normal">lParam</span><span class="symbol">),</span><span class="normal"> </span><span class="string">""</span><span class="symbol">);</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> st</span><span class="symbol">.</span><span class="normal">styles </span><span class="symbol">?</span><span class="normal"> st</span><span class="symbol">.</span><span class="normal">length </span><span class="symbol">:</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_MARGINTEXTCLEARALL</span><span class="symbol">:</span>
<span class="normal">		pdoc</span><span class="symbol">-&gt;</span><span class="function">MarginClearAll</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_ANNOTATIONSETTEXT</span><span class="symbol">:</span>
<span class="normal">		pdoc</span><span class="symbol">-&gt;</span><span class="function">AnnotationSetText</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">,</span><span class="normal"> </span><span class="function">CharPtrFromSPtr</span><span class="symbol">(</span><span class="normal">lParam</span><span class="symbol">));</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_ANNOTATIONGETTEXT</span><span class="symbol">:</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">const</span><span class="normal"> </span><span class="usertype">StyledText</span><span class="normal"> st </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">AnnotationStyledText</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">);</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lParam</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">st</span><span class="symbol">.</span><span class="normal">text</span><span class="symbol">)</span>
<span class="normal">					</span><span class="function">memcpy</span><span class="symbol">(</span><span class="function">CharPtrFromSPtr</span><span class="symbol">(</span><span class="normal">lParam</span><span class="symbol">),</span><span class="normal"> st</span><span class="symbol">.</span><span class="normal">text</span><span class="symbol">,</span><span class="normal"> st</span><span class="symbol">.</span><span class="normal">length</span><span class="symbol">);</span>
<span class="normal">				</span><span class="keyword">else</span>
<span class="normal">					</span><span class="function">strcpy</span><span class="symbol">(</span><span class="function">CharPtrFromSPtr</span><span class="symbol">(</span><span class="normal">lParam</span><span class="symbol">),</span><span class="normal"> </span><span class="string">""</span><span class="symbol">);</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> st</span><span class="symbol">.</span><span class="normal">length</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_ANNOTATIONGETSTYLE</span><span class="symbol">:</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">const</span><span class="normal"> </span><span class="usertype">StyledText</span><span class="normal"> st </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">AnnotationStyledText</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">);</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> st</span><span class="symbol">.</span><span class="normal">style</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_ANNOTATIONSETSTYLE</span><span class="symbol">:</span>
<span class="normal">		pdoc</span><span class="symbol">-&gt;</span><span class="function">AnnotationSetStyle</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">,</span><span class="normal"> lParam</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_ANNOTATIONSETSTYLES</span><span class="symbol">:</span>
<span class="normal">		pdoc</span><span class="symbol">-&gt;</span><span class="function">AnnotationSetStyles</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">reinterpret_cast</span><span class="symbol">&lt;</span><span class="keyword">const</span><span class="normal"> </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*&gt;(</span><span class="normal">lParam</span><span class="symbol">));</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_ANNOTATIONGETSTYLES</span><span class="symbol">:</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="keyword">const</span><span class="normal"> </span><span class="usertype">StyledText</span><span class="normal"> st </span><span class="symbol">=</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">AnnotationStyledText</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">);</span>
<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">lParam</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">				</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">st</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">)</span>
<span class="normal">					</span><span class="function">memcpy</span><span class="symbol">(</span><span class="function">CharPtrFromSPtr</span><span class="symbol">(</span><span class="normal">lParam</span><span class="symbol">),</span><span class="normal"> st</span><span class="symbol">.</span><span class="normal">styles</span><span class="symbol">,</span><span class="normal"> st</span><span class="symbol">.</span><span class="normal">length</span><span class="symbol">);</span>
<span class="normal">				</span><span class="keyword">else</span>
<span class="normal">					</span><span class="function">strcpy</span><span class="symbol">(</span><span class="function">CharPtrFromSPtr</span><span class="symbol">(</span><span class="normal">lParam</span><span class="symbol">),</span><span class="normal"> </span><span class="string">""</span><span class="symbol">);</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">			</span><span class="keyword">return</span><span class="normal"> st</span><span class="symbol">.</span><span class="normal">styles </span><span class="symbol">?</span><span class="normal"> st</span><span class="symbol">.</span><span class="normal">length </span><span class="symbol">:</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_ANNOTATIONGETLINES</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> pdoc</span><span class="symbol">-&gt;</span><span class="function">AnnotationLines</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_ANNOTATIONCLEARALL</span><span class="symbol">:</span>
<span class="normal">		pdoc</span><span class="symbol">-&gt;</span><span class="function">AnnotationClearAll</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_ANNOTATIONSETVISIBLE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="function">SetAnnotationVisible</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_ANNOTATIONGETVISIBLE</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">annotationVisible</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_ANNOTATIONSETSTYLEOFFSET</span><span class="symbol">:</span>
<span class="normal">		vs</span><span class="symbol">.</span><span class="normal">annotationStyleOffset </span><span class="symbol">=</span><span class="normal"> wParam</span><span class="symbol">;</span>
<span class="normal">		</span><span class="function">InvalidateStyleRedraw</span><span class="symbol">();</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_ANNOTATIONGETSTYLEOFFSET</span><span class="symbol">:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> vs</span><span class="symbol">.</span><span class="normal">annotationStyleOffset</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> SCI_ADDUNDOACTION</span><span class="symbol">:</span>
<span class="normal">		pdoc</span><span class="symbol">-&gt;</span><span class="function">AddUndoAction</span><span class="symbol">(</span><span class="normal">wParam</span><span class="symbol">,</span><span class="normal"> lParam </span><span class="symbol">&amp;</span><span class="normal"> UNDO_MAY_COALESCE</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="label">	default:</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="function">DefWndProc</span><span class="symbol">(</span><span class="normal">iMessage</span><span class="symbol">,</span><span class="normal"> wParam</span><span class="symbol">,</span><span class="normal"> lParam</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="comment">//Platform::DebugPrintf("end wnd proc\n");</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> 0l</span><span class="symbol">;</span>
<span class="cbracket">}</span>
</tt></pre></div><div style="text-align: right; padding: 8pt; font-size: 12px"><a href="/xmlfeed/weblog-rss20.xml"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAAAPAgMAAAAOp6AcAAAADFBMVEVmZmb/ZgD///+JjnlbTUWmAAAACXBIWXMAAABIAAAASABGyWs+AAAACXZwQWcAAABQAAAADwCexKkxAAAAWUlEQVQYlWNgwAa0VmGAFQyqoSCQ/x8J/CBFMCt0ZdTU/F/7/+1HEkydFpoKVPn+93sUlUujQvP/7UcRTAuNDJ2a//s/imDqtKVZofm/1qGYSZk7sfodGwAAiobBJtffoNAAAAAASUVORK5CYII=" alt="RSS 2.0 Weblog Feed" width="80" height="15"/></a> <a href="/xmlfeed/weblog-atom10.xml"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAAAPAgMAAAAOp6AcAAAADFBMVEVmZmb/ZgD///+JjnlbTUWmAAAAaklEQVQYlWNgwAa0VmGAFQyqoSCQ/x8J/CBFMDV16rTQ/H/7V//69+//v/3/9oMEI6cuAwr+fv/+/b5d///v//0eJBgWOhMo+Gs9UPAdXDBy6lSYyn9wQZCZS0GCYDPXQcykzJ1Y/Y4NAABKvL80wyoMPgAAAABJRU5ErkJggg==" alt="Atom 1.0 Weblog Feed" width="80" height="15"/></a> <a href="http://validator.w3.org/check?uri=referer"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAAAPCAMAAABEF7i9AAAB1FBMVEUHQIgIRY0MN4QNRYoSRYsXUpIYVJQeUpUhWpgjUJMjWpgmU5QnXJkuYZ0uYpwwV5YyZJ4zaKM3ZaA5aaI6aqM6a6E8ZqA8Z6BAbaRBbqdCbaVHd61KSkpKcaZQUFBUf69UgbBVVVVXfq9Yg7NZhbJZh7RagrNeXVxeh7RfjLdgYGBiiLZmZmZnZ2doirhpkbt0m8F3m8B3ncJ5lb55ocR+ocSDgX+Do8eEpMqGhoaHp8iIpMeJjnmJpseKqMeOqsqPsdCQrcyVlZWVsM2Zs9CZtNCfu9ahoaGhuNShudSivNSjtMWjvNSmpqWnpqSrw9qvxNqyxdmyxdyzsK6zs7Ozx9y0xt21yN22tra4y+K80eK/v7/AwMDExMTEy9DH2ejK2+jM2ujN3uvP0dLR0NDR3uvS3uvS3+zU4u3V1dXY2dnY4u7Y4+3b5e/d3d3d5u/d5/De3t7f39/h4uLj4uHj6/Ll7PXm7fTn7/Xo7/Tp7/bq7Ozr6unr8ffw8PDw9vvx9fny+P7z8/Pz9vnz9vv3+fv4+vz5+vz6+vr6+/36/P36///7+/77/Pz7/f37/f78/Pz8/f38/f79/f39/f79/f/9/v79///+/v7+/v////3///+tYR2LAAABKklEQVQ4y2PQoTJg0JlNVYDPQBsyAMTAqaFes8tdsmdPCtA3MDStr3GKKK6myMAprgJ9pcpWs/MlRExYJBvNZLR0sigycHYOV1S7mtjsQJ4gf+HIFPXoWMs6qIGzIRiKZs9GFoEaMRuZhhrYqqJXy8uZYauRxC/VHew7e3YTPAxnI5swG6JxNrKBNjB1EFmIgV0+HA6C8pqqzhXG7BbJJROQIwViMYQ7G2oDQQNn57JyG7kxiCfObrBmS5+BHMuYLkTzMnYDm5WY4lOZZRPKZocxes+aPbuwCFsYohiICLvZsKBAMrDTQ7K/StveU8icTzrOL8JdLpOyWJ49u8Bx9ozw8DY7UYW03hhdxZAOSg2c3jN79rSJs1vSKmfOnpFXNJmynELlvExlAADnaZpLFGEC2wAAAABJRU5ErkJggg==" alt="Valid XHTML 1.1" width="80" height="15"/></a> <a href="http://jigsaw.w3.org/css-validator/check/referer"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAAAPCAMAAABEF7i9AAAB1FBMVEUHQIgIRY0MN4QNRYoSRYsXUpIYVJQeUpUhWpgjUJMjWpgmU5QnXJkuYZ0uYpwwV5YyZJ4zaKM3ZaA5aaI6aqM6a6E8ZqA8Z6BAbaRBbqdCbaVHd61KSkpKcaZQUFBUf69UgbBVVVVXfq9Yg7NZhbJZh7RagrNeXVxeh7RfjLdgYGBiiLZmZmZnZ2doirhpkbt0m8F3m8B3ncJ5lb55ocR+ocSDgX+Do8eEpMqGhoaHp8iIpMeJjnmJpseKqMeOqsqPsdCQrcyVlZWVsM2Zs9CZtNCfu9ahoaGhuNShudSivNSjtMWjvNSmpqWnpqSrw9qvxNqyxdmyxdyzsK6zs7Ozx9y0xt21yN22tra4y+K80eK/v7/AwMDExMTEy9DH2ejK2+jM2ujN3uvP0dLR0NDR3uvS3uvS3+zU4u3V1dXY2dnY4u7Y4+3b5e/d3d3d5u/d5/De3t7f39/h4uLj4uHj6/Ll7PXm7fTn7/Xo7/Tp7/bq7Ozr6unr8ffw8PDw9vvx9fny+P7z8/Pz9vnz9vv3+fv4+vz5+vz6+vr6+/36/P36///7+/77/Pz7/f37/f78/Pz8/f38/f79/f39/f79/f/9/v79///+/v7+/v////3///+tYR2LAAABEUlEQVQ4y2PQoTJg0JlNVYDPQBsyAMTAqaFes8tdsmdPCtA3MDStr3GKKK6myMAprgJ9pcpWs/MlRExYJBvNZLR0sigycHYOV1S7mtjsQJ4gf+HIFPXoWMs6mIEQCsIjwhKoga0qerW8nBm2Gkn8Ut3BvrNnN8HCcDYM2cBIogzs8uFwEJTXVHWuMGa3SC6ZgIgUqCEwdxJr4OxcVm4jNwbxxNkN1mzpM2ajGIjsPGK9PLtZiSk+lVk2oWx2GKP3rNmzC4tQwpDoIIQb2Okh2V+lbe8pZM4nHecX4S6XSVksz55d4Dh7Rnh4m52oQlpvjK5iSAelBk7vmT172sTZLWmVM2fPyCuaTFlOoXJepjIAANlljDGY/l5pAAAAAElFTkSuQmCC" alt="Valid CSS (2.1)" width="80" height="15"/></a><br/>Copyright 2005-2018 <a href="/about/">Timo Bingmann</a> - <a href="/about/impressum.html">Impressum</a></div><script type="text/javascript">var _paq = _paq || []; _paq.push(["trackPageView"]); _paq.push(["enableLinkTracking"]);(function() {var u=(("https:" == document.location.protocol) ? "https" : "http") + "://panthema.net/wik-331/"; _paq.push(["setTrackerUrl", u+"js/"]); _paq.push(["setSiteId", "2"]);var d=document, g=d.createElement("script"), s=d.getElementsByTagName("script")[0]; g.type="text/javascript";g.defer=true; g.async=true; g.src=u+"js/"; s.parentNode.insertBefore(g,s);})();</script><noscript><p><img src="http://panthema.net/wik-331/js/?idsite=2&amp;rec=1" style="border:0" alt="" /></p></noscript></body></html>