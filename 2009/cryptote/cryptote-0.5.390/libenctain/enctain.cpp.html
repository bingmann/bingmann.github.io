<?xml version="1.0" encoding="iso-8859-1"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta content="text/html; charset=iso-8859-1" http-equiv="content-type" /><title>/2009/cryptote/cryptote-0.5.390/libenctain/enctain.cpp - panthema.net</title><link rel="stylesheet" type="text/css" href="/css/base.css" /><link rel="stylesheet" type="text/css" href="/css/fonts.css" /><link rel="alternate" type="application/rss+xml" title="panthema.net Weblog Feed RSS 2.0" href="http://panthema.net/xmlfeed/weblog-rss20.xml" /><link rel="alternate" type="application/atom+xml" title="panthema.net Weblog Feed Atom 1.0" href="http://panthema.net/xmlfeed/weblog-atom10.xml" /><script type="text/javascript" src="/js/base.js"></script><script type="text/javascript">/* <!-- */makeIEHover = function() {var lis = document.getElementById('ptnav').getElementsByTagName('li');for (var i = 0; i < lis.length; i++) {lis[i].onmouseover = function() {this.className += ' sfhover';};lis[i].onmouseout = function() {this.className = this.className.replace(new RegExp(' sfhover\b'), '');};}};if (window.attachEvent) window.attachEvent('onload', makeIEHover);/* --> */</script></head><body style="background-image: url(/img/bgfractal4.jpg)"><div class="pttopbar"><div style="float: right"><ul id="ptnav"><li class="top"><a class="ni" href="/">Weblog</a><ul style="margin-left: -6px; margin-top: 4px" class="nx"><li><a href="/2014/">2014</a></li><li><a href="/2013/">2013</a></li><li><a href="/2012/">2012</a></li><li><a href="/2011/">2011</a></li><li><a href="/2010/">2010</a></li><li><a href="/2009/">2009</a></li><li><a href="/2008/">2008</a></li><li><a href="/2007/">2007</a></li><li><a href="/2006/">2006</a></li><li class="nt"><a href="/2005/">2005</a></li><li class="ns"><a href="/xmlfeed/weblog-rss20.xml">RSS Feed</a></li><li class="nt"><a href="/xmlfeed/weblog-atom10.xml">XML Atom</a></li><li class="ns"><a href="/search.html">Search</a></li></ul></li><li class="top"><a class="ni" href="/tags/">Tags</a><div style="width: 14em; margin-left: -9em; margin-top: 4px"><a style="font-size: 10pt" href="/tags/algebra.html">algebra</a> <a style="font-size: 16pt" href="/tags/c++.html">c++</a> <a style="font-size: 12pt" href="/tags/code-example.html">code-example</a> <a style="font-size: 14pt" href="/tags/code-snippet.html">code-snippet</a> <a style="font-size: 11pt" href="/tags/coding_tricks.html">coding tricks</a> <a style="font-size: 10pt" href="/tags/compsci.html">compsci</a> <a style="font-size: 10pt" href="/tags/compsci_study_thesis.html">compsci study thesis</a> <a style="font-size: 9pt" href="/tags/crypto-speedtest.html">crypto-speedtest</a> <a style="font-size: 10pt" href="/tags/cryptography.html">cryptography</a> <a style="font-size: 9pt" href="/tags/cryptote.html">cryptote</a> <a style="font-size: 12pt" href="/tags/flex-bison-cpp-example.html">flex-bison-cpp-example</a> <a style="font-size: 13pt" href="/tags/frontpage.html">frontpage</a> <a style="font-size: 13pt" href="/tags/fun.html">fun</a> <a style="font-size: 10pt" href="/tags/graphviz.html">graphviz</a> <a style="font-size: 9pt" href="http://www.hmtg.de">hartmetall</a> <a style="font-size: 9pt" href="/tags/helppc.html">helppc</a> <a style="font-size: 9pt" href="/tags/hifi_selbstbau.html">hifi selbstbau</a> <a style="font-size: 10pt" href="/tags/latex.html">latex</a> <a style="font-size: 10pt" href="/tags/librivox.html">librivox</a> <a style="font-size: 10pt" href="/tags/linux.html">linux</a> <a style="font-size: 10pt" href="/tags/maths.html">maths</a> <a style="font-size: 9pt" href="/tags/music.html">music</a> <a style="font-size: 10pt" href="/tags/netfundamentals.html">netfundamentals</a> <a style="font-size: 11pt" href="/tags/ns-3.html">ns-3</a> <a style="font-size: 10pt" href="/tags/parallel-string-sorting.html">parallel-string-sorting</a> <a style="font-size: 9pt" href="/tags/qtsqlview.html">qtsqlview</a> <a style="font-size: 10pt" href="/tags/research.html">research</a> <a style="font-size: 11pt" href="/tags/sdios06.html">sdios06</a> <a style="font-size: 9pt" href="/tags/sdlfractal.html">sdlfractal</a> <a style="font-size: 12pt" href="/tags/sorting.html">sorting</a> <a style="font-size: 10pt" href="/tags/stringology.html">stringology</a> <a style="font-size: 16pt" href="/tags/stx-btree.html">stx-btree</a> <a style="font-size: 9pt" href="/tags/stx-exparser.html">stx-exparser</a> <a style="font-size: 10pt" href="/tags/stxxl.html">stxxl</a> <a style="font-size: 15pt" href="/tags/talk.html">talk</a> <a style="font-size: 10pt" href="/tags/tutorium.html">tutorium</a> <a style="font-size: 16pt" href="/tags/university.html">university</a> <a style="font-size: 13pt" href="/tags/utilities.html">utilities</a> <a style="font-size: 9pt" href="/tags/webdesign.html">webdesign</a> </div></li><li class="top"> <a class="ni" href="#">Projects</a> <ul style="margin-left: -8em; margin-top: 4px;" class="nx"> <li><a href="/2009/cryptote/">CryptoTE</a></li> <li><a href="/2009/digup/">digup</a></li> <li><a href="/2013/disk-filltest/">disk-filltest</a></li> <li><a href="/2012/1119-eSAIS-Inducing-Suffix-and-LCP-Arrays-in-External-Memory/">eSAIS-LCP</a></li> <li><a href="/2007/flex-bison-cpp-example/">Flex Bison C++ Example</a></li> <li><a href="/2013/malloc_count/">malloc_count</a></li> <li><a href="/2013/parallel-string-sorting/">parallel-string-sorting</a></li> <li><a href="/2013/pmbw/">Parallel Memory Bandwidth</a></li> <li><a href="/2014/sqlplot-tools/">SqlPlotTools</a></li> <li><a href="/2013/sound-of-sorting/">The Sound of Sorting</a></li> <li><a href="/2007/stx-btree/">STX B+ Tree</a></li> <li><a href="/2010/stx-cbtreedb/">STX Constant BTreeDB</a></li> <li><a href="/2010/stx-execpipe/">STX ExecPipe</a></li> <li><a href="/2007/stx-exparser/">STX Expression Parser</a></li> <li class="nt"><a href="/2013/1212-stxxl-1.4.0/">STXXL 1.4</a></li> <li class="ns"><a href="/search.html">Search</a></li> </ul></li><li class="top"> <a class="ni" href="#">Research</a> <ul style="margin-left: -16em; margin-top: 4px" class="nx"> <li><a href="/2012/1119-eSAIS-Inducing-Suffix-and-LCP-Arrays-in-External-Memory/">eSAIS-LCP - External Memory Suffix Sorting</a></li> <li><a href="/2013/parallel-string-sorting/">Parallel String Sorting</a></li> <li><a href="/tags/stxxl.html">STXXL - External Memory Algorithms</a></li> <li class="ns"><a href="/search.html">Search</a></li> </ul></li><li class="top"> <a class="ni" href="/about/">About</a> <ul style="margin-left: -6em; margin-top: 4px" class="nx"> <li><a href="/about/">Timo Bingmann</a></li> <li><a href="/about/impressum.html">Impressum</a></li> </ul></li></ul></div><div style="padding: 6px"><a href="/">panthema</a>  / <a href="/2009/">2009</a> / <a href="/2009/cryptote/">cryptote</a> / <a href="/2009/cryptote/cryptote-0.5.390/">cryptote-0.5.390</a> / <a href="/2009/cryptote/cryptote-0.5.390/libenctain/">libenctain</a> / <a href="/2009/cryptote/cryptote-0.5.390/libenctain/enctain.cpp.html">enctain.cpp</a> (<a href="/2009/cryptote/cryptote-0.5.390/libenctain/enctain.cpp">Download File</a>)</div></div><div class="ptfullwidth"><pre class="codesnippet" style="font-family: monospace"><tt><span class="comment">// $Id: enctain.cpp 384 2009-08-03 20:29:06Z tb $</span>

<span class="comment">/*</span>
<span class="comment"> * CryptoTE LibEnctain v0.5.390</span>
<span class="comment"> * Copyright (C) 2008-2009 Timo Bingmann</span>
<span class="comment"> *</span>
<span class="comment"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="comment"> * under the terms of the GNU General Public License as published by the Free</span>
<span class="comment"> * Software Foundation; either version 2 of the License, or (at your option)</span>
<span class="comment"> * any later version.</span>
<span class="comment"> *</span>
<span class="comment"> * This program is distributed in the hope that it will be useful, but WITHOUT</span>
<span class="comment"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="comment"> * FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for</span>
<span class="comment"> * more details.</span>
<span class="comment"> *</span>
<span class="comment"> * You should have received a copy of the GNU General Public License along</span>
<span class="comment"> * with this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="comment"> * 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA</span>
<span class="comment"> */</span>

<span class="preproc">#include</span><span class="normal"> </span><span class="string">"enctain.h"</span>

<span class="preproc">#include</span><span class="normal"> </span><span class="string">&lt;vector&gt;</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">&lt;map&gt;</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">&lt;memory&gt;</span>

<span class="preproc">#include</span><span class="normal"> </span><span class="string">&lt;zlib.h&gt;</span>

<span class="preproc">#include</span><span class="normal"> </span><span class="string">"bytebuff.h"</span>

<span class="preproc">#include</span><span class="normal"> </span><span class="string">"botan-1.6/include/base.h"</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">"botan-1.6/include/init.h"</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">"botan-1.6/include/rng.h"</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">"botan-1.6/include/lookup.h"</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">"botan-1.6/include/pkcs5.h"</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">"botan-1.6/include/crc32.h"</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">"botan-1.6/include/pipe.h"</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">"botan-1.6/include/buf_filt.h"</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">"botan-1.6/include/zlib.h"</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">"botan-1.6/include/bzip2.h"</span>

<span class="keyword">namespace</span><span class="normal"> Enctain </span><span class="cbracket">{</span>
<span class="keyword">namespace</span><span class="normal"> internal </span><span class="cbracket">{</span>

<span class="comment">// *** ContainerImpl ***</span>

<span class="keyword">class</span><span class="normal"> </span><span class="classname">ContainerImpl</span>
<span class="cbracket">{</span>
<span class="keyword">protected</span><span class="symbol">:</span>

<span class="normal">    </span><span class="keyword">typedef</span><span class="normal"> std</span><span class="symbol">::</span><span class="usertype">map&lt;std::string, std::string&gt;</span><span class="normal"> propertymap_type</span><span class="symbol">;</span>

<span class="normal">    </span><span class="comment">// *** Structures ***</span>

<span class="normal">    </span><span class="comment">/// Memory structure used to represent a subfile of the container, not</span>
<span class="normal">    </span><span class="comment">/// directly used for disk storage.</span>
<span class="normal">    </span><span class="keyword">class</span><span class="normal"> </span><span class="classname">SubFile</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">public</span><span class="symbol">:</span>
<span class="normal">	</span><span class="comment">/// Size of subfile when saved.</span>
<span class="normal">	</span><span class="usertype">uint32_t</span><span class="normal">	storagesize</span><span class="symbol">;</span>

<span class="normal">	</span><span class="comment">/// Size of subfile when read by user program.</span>
<span class="normal">	</span><span class="usertype">uint32_t</span><span class="normal">	realsize</span><span class="symbol">;</span>

<span class="normal">	</span><span class="comment">/// CRC32 of subfile after decryption and decompression.</span>
<span class="normal">	</span><span class="usertype">uint32_t</span><span class="normal">	crc32</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">union</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="usertype">uint32_t</span><span class="normal">	flags</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="keyword">struct</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="usertype">uint8_t</span><span class="normal">	compression</span><span class="symbol">;</span>
<span class="normal">		</span><span class="usertype">uint8_t</span><span class="normal">	encryption</span><span class="symbol">;</span>
<span class="normal">		</span><span class="usertype">uint8_t</span><span class="normal">	reserved1</span><span class="symbol">;</span>
<span class="normal">		</span><span class="usertype">uint8_t</span><span class="normal">	reserved2</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="cbracket">}</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span><span class="symbol">;</span>

<span class="normal">	</span><span class="comment">/// Random encryption key and CBC-IV, if needed by encryption method.</span>
<span class="normal">	Botan</span><span class="symbol">::</span><span class="usertype">SecureVector&lt;Botan::byte&gt;</span><span class="normal">	encdata</span><span class="symbol">;</span>

<span class="normal">	</span><span class="comment">/// User-defined properties of the subfile.</span>
<span class="normal">	</span><span class="usertype">propertymap_type</span><span class="normal">                        properties</span><span class="symbol">;</span>

<span class="normal">	</span><span class="comment">/// Compressed and encrypted data of subfile.</span>
<span class="normal">	Botan</span><span class="symbol">::</span><span class="usertype">SecureVector&lt;Botan::byte&gt;</span><span class="normal">	data</span><span class="symbol">;</span>

<span class="normal">	</span><span class="comment">/// Constructor initializing everything to zero.</span>
<span class="normal">	</span><span class="function">SubFile</span><span class="symbol">()</span>
<span class="normal">	    </span><span class="symbol">:</span><span class="normal"> </span><span class="function">storagesize</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">),</span><span class="normal"> </span><span class="function">realsize</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">),</span><span class="normal"> </span><span class="function">crc32</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">),</span><span class="normal"> </span><span class="function">flags</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">    </span><span class="cbracket">}</span><span class="symbol">;</span>

<span class="normal">    </span><span class="comment">/// Structure of the disk file's header</span>
<span class="normal">    </span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">Header1</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="type">char</span><span class="normal">    	signature</span><span class="symbol">[</span><span class="number">8</span><span class="symbol">];</span><span class="normal">	</span><span class="comment">// "CryptoTE"</span>
<span class="normal">	</span><span class="usertype">uint16_t</span><span class="normal">	version_major</span><span class="symbol">;</span><span class="normal">	</span><span class="comment">// Currently 0x0001</span>
<span class="normal">	</span><span class="usertype">uint16_t</span><span class="normal">	version_minor</span><span class="symbol">;</span><span class="normal">	</span><span class="comment">// Currently 0x0000 = v1.0</span>
<span class="normal">	</span><span class="usertype">uint32_t</span><span class="normal">	unc_metalen</span><span class="symbol">;</span><span class="normal">	</span><span class="comment">// Unencrypted Metadata Length</span>

<span class="normal">    </span><span class="cbracket">}</span><span class="normal"> </span><span class="function">__attribute__</span><span class="symbol">((</span><span class="normal">packed</span><span class="symbol">));</span>

<span class="normal">    </span><span class="comment">/// Structure of the file's keyslots header</span>
<span class="normal">    </span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">Header2</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="usertype">uint32_t</span><span class="normal">	mkd_iterations</span><span class="symbol">;</span><span class="normal">	</span><span class="comment">// mk-PBKDF2 digest iterations</span>
<span class="normal">	</span><span class="usertype">uint8_t</span><span class="normal">		mkd_salt</span><span class="symbol">[</span><span class="number">32</span><span class="symbol">];</span><span class="normal">	</span><span class="comment">// mk-PBKDF2 digest salt</span>
<span class="normal">	</span><span class="usertype">uint8_t</span><span class="normal">		mkd_digest</span><span class="symbol">[</span><span class="number">32</span><span class="symbol">];</span><span class="normal">	</span><span class="comment">// mk-PBKDF2 digest</span>
<span class="normal">	</span><span class="usertype">uint32_t</span><span class="normal">	mkk_iterations</span><span class="symbol">;</span><span class="normal">	</span><span class="comment">// mk-PBKDF2 metadata key iterations</span>
<span class="normal">	</span><span class="usertype">uint8_t</span><span class="normal">		mkk_salt</span><span class="symbol">[</span><span class="number">32</span><span class="symbol">];</span><span class="normal">	</span><span class="comment">// mk-PBKDF2 metadata key salt</span>
<span class="normal">	</span><span class="usertype">uint32_t</span><span class="normal">	mki_iterations</span><span class="symbol">;</span><span class="normal">	</span><span class="comment">// mk-PBKDF2 metadata iv iterations</span>
<span class="normal">	</span><span class="usertype">uint8_t</span><span class="normal">		mki_salt</span><span class="symbol">[</span><span class="number">32</span><span class="symbol">];</span><span class="normal">	</span><span class="comment">// mk-PBKDF2 metadata iv salt</span>
<span class="normal">	</span><span class="usertype">uint32_t</span><span class="normal">	keyslots</span><span class="symbol">;</span><span class="normal">	</span><span class="comment">// Number of key slots following.</span>

<span class="normal">    </span><span class="cbracket">}</span><span class="normal"> </span><span class="function">__attribute__</span><span class="symbol">((</span><span class="normal">packed</span><span class="symbol">));</span>

<span class="normal">    </span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">KeySlot</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="usertype">uint32_t</span><span class="normal">	iterations</span><span class="symbol">;</span><span class="normal">	</span><span class="comment">// uk-PBKDF2 iterations</span>
<span class="normal">	</span><span class="usertype">uint8_t</span><span class="normal">		salt</span><span class="symbol">[</span><span class="number">32</span><span class="symbol">];</span><span class="normal">	</span><span class="comment">// uk-PBKDF2 random salt</span>
<span class="normal">	</span><span class="usertype">uint8_t</span><span class="normal">		emasterkey</span><span class="symbol">[</span><span class="number">64</span><span class="symbol">];</span><span class="normal">	</span><span class="comment">// Encrypted master key</span>

<span class="normal">    </span><span class="cbracket">}</span><span class="normal"> </span><span class="function">__attribute__</span><span class="symbol">((</span><span class="normal">packed</span><span class="symbol">));</span>

<span class="normal">    </span><span class="comment">/// Structure of the encrypted part of the header</span>
<span class="normal">    </span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">Header3</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="usertype">uint32_t</span><span class="normal">	metacomplen</span><span class="symbol">;</span><span class="normal">	</span><span class="comment">// Length of following compressed</span>
<span class="normal">					</span><span class="comment">// variable header holding all subfile</span>
<span class="normal">					</span><span class="comment">// metadata.</span>
<span class="normal">	</span><span class="usertype">uint32_t</span><span class="normal">	metacrc32</span><span class="symbol">;</span><span class="normal">	</span><span class="comment">// CRC32 of the following variable</span>
<span class="normal">					</span><span class="comment">// subfile metadata header</span>
<span class="normal">	</span><span class="usertype">uint32_t</span><span class="normal">	padding1</span><span class="symbol">;</span><span class="normal">	</span><span class="comment">// Padding</span>
<span class="normal">	</span><span class="usertype">uint32_t</span><span class="normal">	padding2</span><span class="symbol">;</span><span class="normal">	</span><span class="comment">// Padding</span>

<span class="normal">    </span><span class="cbracket">}</span><span class="normal"> </span><span class="function">__attribute__</span><span class="symbol">((</span><span class="normal">packed</span><span class="symbol">));</span>

<span class="normal">    </span><span class="comment">// *** Status and Container Contents Variables ***</span>

<span class="normal">    </span><span class="comment">/// Signature possibly changed by SetSignature()</span>
<span class="normal">    </span><span class="keyword">static</span><span class="normal"> </span><span class="type">char</span><span class="normal">		m_filesignature</span><span class="symbol">[</span><span class="number">8</span><span class="symbol">];</span>

<span class="normal">    </span><span class="comment">/// Number of references to this object</span>
<span class="normal">    </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal">	m_references</span><span class="symbol">;</span>

<span class="normal">    </span><span class="comment">/// True if one of the subfiles was changed using SetSubFileData() and the</span>
<span class="normal">    </span><span class="comment">/// container file was not saved yet.</span>
<span class="normal">    </span><span class="type">bool</span><span class="normal">		m_modified</span><span class="symbol">;</span>

<span class="normal">    </span><span class="comment">/// Header2 either loaded or filled on first user key added.</span>
<span class="normal">    </span><span class="usertype">Header2</span><span class="normal">		m_header2</span><span class="symbol">;</span>

<span class="normal">    </span><span class="comment">/// Master key material used for metadata encryption.</span>
<span class="normal">    Botan</span><span class="symbol">::</span><span class="usertype">SecureBuffer&lt;Botan::byte, 64&gt;</span><span class="normal"> m_masterkey</span><span class="symbol">;</span>

<span class="normal">    </span><span class="comment">/// Vector of user key slots.</span>
<span class="normal">    std</span><span class="symbol">::</span><span class="usertype">vector&lt;KeySlot&gt;</span><span class="normal"> m_keyslots</span><span class="symbol">;</span>

<span class="normal">    </span><span class="comment">/// Number of the correct key slot used while loading.</span>
<span class="normal">    </span><span class="type">int</span><span class="normal">			m_usedkeyslot</span><span class="symbol">;</span>

<span class="normal">    </span><span class="comment">/// Unencrypted global properties, completely user-defined.</span>
<span class="normal">    </span><span class="usertype">propertymap_type</span><span class="normal">	m_unc_properties</span><span class="symbol">;</span>

<span class="normal">    </span><span class="comment">/// Encrypted global properties, completely user-defined.</span>
<span class="normal">    </span><span class="usertype">propertymap_type</span><span class="normal">	m_enc_properties</span><span class="symbol">;</span>

<span class="normal">    </span><span class="comment">/// Vector of subfiles</span>
<span class="normal">    std</span><span class="symbol">::</span><span class="usertype">vector&lt;SubFile&gt;</span><span class="normal"> m_subfiles</span><span class="symbol">;</span>

<span class="normal">    </span><span class="comment">/// Bytes written to file during last Save() operation</span>
<span class="normal">    </span><span class="usertype">size_t</span><span class="normal">		m_written</span><span class="symbol">;</span>

<span class="normal">    </span><span class="comment">/// Progress indicator object receiving notifications.</span>
<span class="normal">    ProgressIndicator</span><span class="symbol">*</span><span class="normal">	m_progressindicator</span><span class="symbol">;</span>

<span class="normal">    </span><span class="comment">/// Friend class to access the progressindicator variable</span>
<span class="normal">    </span><span class="keyword">friend</span><span class="normal"> </span><span class="keyword">class</span><span class="normal"> </span><span class="classname">ProgressTicker</span><span class="symbol">;</span>

<span class="keyword">public</span><span class="symbol">:</span>
<span class="normal">    </span><span class="comment">// *** Constructor, Destructor and Reference Counter  ***</span>

<span class="normal">    </span><span class="function">ContainerImpl</span><span class="symbol">();</span>

<span class="normal">    </span><span class="symbol">~</span><span class="function">ContainerImpl</span><span class="symbol">();</span>

<span class="normal">    </span><span class="comment">/// Reset all structures in the container</span>
<span class="normal">    </span><span class="type">void</span><span class="normal">		</span><span class="function">Clear</span><span class="symbol">();</span>

<span class="normal">    </span><span class="comment">/// Increase reference counter by one.</span>
<span class="normal">    </span><span class="type">void</span><span class="normal">		</span><span class="function">IncReference</span><span class="symbol">();</span>

<span class="normal">    </span><span class="comment">/// Decrease reference counter by one and return the new value.</span>
<span class="normal">    </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> 	</span><span class="function">DecReference</span><span class="symbol">();</span>

<span class="normal">    </span><span class="comment">// *** Settings and Error Strings ***</span>

<span class="normal">    </span><span class="comment">/// Change the signature used by Enctain which defaults to "CryptoTE". The</span>
<span class="normal">    </span><span class="comment">/// signature is always 8 characters long and will be truncated or padded</span>
<span class="normal">    </span><span class="comment">/// with zeros. The signature is shared between all instances.</span>
<span class="normal">    </span><span class="keyword">static</span><span class="normal"> </span><span class="type">void</span><span class="normal">		</span><span class="function">SetSignature</span><span class="symbol">(</span><span class="keyword">const</span><span class="normal"> </span><span class="type">char</span><span class="symbol">*</span><span class="normal"> sign</span><span class="symbol">);</span>

<span class="normal">    </span><span class="comment">/// Return a one-line English description of the error code.</span>
<span class="normal">    </span><span class="keyword">static</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> </span><span class="type">char</span><span class="symbol">*</span><span class="normal">	</span><span class="function">GetErrorString</span><span class="symbol">(</span><span class="usertype">error_type</span><span class="normal"> e</span><span class="symbol">);</span>

<span class="normal">    </span><span class="comment">// *** Load/Save Operations ***</span>

<span class="normal">    </span><span class="comment">/// Save the current container by outputting all data to the data sink.</span>
<span class="normal">    </span><span class="type">void</span><span class="normal">		</span><span class="function">Save</span><span class="symbol">(</span><span class="normal">DataOutput</span><span class="symbol">&amp;</span><span class="normal"> dataout</span><span class="symbol">);</span>

<span class="normal">    </span><span class="comment">/// Load a new container from an input stream and parse the subfile index.</span>
<span class="normal">    </span><span class="type">void</span><span class="normal">		</span><span class="function">Load</span><span class="symbol">(</span><span class="normal">DataInput</span><span class="symbol">&amp;</span><span class="normal"> datain</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> userkey</span><span class="symbol">);</span>

<span class="normal">    </span><span class="comment">/// Load a container version v1.x</span>
<span class="normal">    </span><span class="type">void</span><span class="normal">		</span><span class="function">Loadv1</span><span class="symbol">(</span><span class="normal">DataInput</span><span class="symbol">&amp;</span><span class="normal"> datain</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> userkey</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> Header1</span><span class="symbol">&amp;</span><span class="normal"> header1</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">class</span><span class="normal"> </span><span class="classname">ProgressTicker</span><span class="symbol">&amp;</span><span class="normal"> progress</span><span class="symbol">);</span>


<span class="normal">    </span><span class="comment">// *** Container Info Operations ***</span>

<span class="normal">    </span><span class="comment">/// Return whether the subfiles or properties were changed since the last load/save.</span>
<span class="normal">    </span><span class="type">bool</span><span class="normal">		</span><span class="function">GetModified</span><span class="symbol">()</span><span class="normal"> </span><span class="keyword">const</span><span class="symbol">;</span>

<span class="normal">    </span><span class="comment">/// Return number of bytes written to data sink during last Save()</span>
<span class="normal">    </span><span class="comment">/// operation.</span>
<span class="normal">    </span><span class="usertype">size_t</span><span class="normal">		</span><span class="function">GetLastWritten</span><span class="symbol">()</span><span class="normal"> </span><span class="keyword">const</span><span class="symbol">;</span>

<span class="normal">    </span><span class="comment">/// Set the Progress Indicator object which receives progress notifications</span>
<span class="normal">    </span><span class="type">void</span><span class="normal">		</span><span class="function">SetProgressIndicator</span><span class="symbol">(</span><span class="normal">ProgressIndicator</span><span class="symbol">*</span><span class="normal"> pi</span><span class="symbol">);</span>


<span class="normal">    </span><span class="comment">// *** Container User Keys Operations ***</span>

<span class="normal">    </span><span class="comment">/// Return number of user key slots used.</span>
<span class="normal">    </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal">	</span><span class="function">CountKeySlots</span><span class="symbol">()</span><span class="normal"> </span><span class="keyword">const</span><span class="symbol">;</span>
<span class="normal">    </span>
<span class="normal">    </span><span class="comment">/// Add a new user key string. The string will be hashed and used to store</span>
<span class="normal">    </span><span class="comment">/// a copy of the master key. SubFiles do not need to be</span>
<span class="normal">    </span><span class="comment">/// reencrypted. Returns number of new key slot.</span>
<span class="normal">    </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal">	</span><span class="function">AddKeySlot</span><span class="symbol">(</span><span class="keyword">const</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> key</span><span class="symbol">);</span>

<span class="normal">    </span><span class="comment">/// Replace a key slot with a new key string. Requires that the container</span>
<span class="normal">    </span><span class="comment">/// was opened using one of the previously existing user key slots.</span>
<span class="normal">    </span><span class="type">void</span><span class="normal">		</span><span class="function">ChangeKeySlot</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> slot</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> key</span><span class="symbol">);</span>

<span class="normal">    </span><span class="comment">/// Remove a user key slot. When all user key slots are removed and a new</span>
<span class="normal">    </span><span class="comment">/// key is added, a new master key is also generated.</span>
<span class="normal">    </span><span class="type">void</span><span class="normal">		</span><span class="function">DeleteKeySlot</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> slot</span><span class="symbol">);</span>

<span class="normal">    </span><span class="comment">/// Return the number of the key slot which matched while loading the</span>
<span class="normal">    </span><span class="comment">/// file. Returns -1 if it was deleted.</span>
<span class="normal">    </span><span class="type">int</span><span class="normal">			</span><span class="function">GetUsedKeySlot</span><span class="symbol">()</span><span class="normal"> </span><span class="keyword">const</span><span class="symbol">;</span>


<span class="normal">    </span><span class="comment">// *** Container Unencrypted Global Properties ***</span>

<span class="normal">    </span><span class="comment">/// Set (overwrite) an unencrypted global property.</span>
<span class="normal">    </span><span class="type">void</span><span class="normal">		</span><span class="function">SetGlobalUnencryptedProperty</span><span class="symbol">(</span><span class="keyword">const</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> key</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> value</span><span class="symbol">);</span>
<span class="normal">    </span>
<span class="normal">    </span><span class="comment">/// Get an unencrypted  global property by key.</span>
<span class="normal">    </span><span class="keyword">const</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal">	</span><span class="function">GetGlobalUnencryptedProperty</span><span class="symbol">(</span><span class="keyword">const</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> key</span><span class="symbol">)</span><span class="normal"> </span><span class="keyword">const</span><span class="symbol">;</span>

<span class="normal">    </span><span class="comment">/// Delete an unencrypted  global property key.</span>
<span class="normal">    </span><span class="type">bool</span><span class="normal">		</span><span class="function">DeleteGlobalUnencryptedProperty</span><span class="symbol">(</span><span class="keyword">const</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> key</span><span class="symbol">);</span>
<span class="normal">    </span>
<span class="normal">    </span><span class="comment">/// Get an unencrypted global property (key and value) by index. Returns</span>
<span class="normal">    </span><span class="comment">/// false if the index is beyond the last property</span>
<span class="normal">    </span><span class="type">bool</span><span class="normal">		</span><span class="function">GetGlobalUnencryptedPropertyIndex</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> propindex</span><span class="symbol">,</span>
<span class="normal">							  std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> key</span><span class="symbol">,</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> value</span><span class="symbol">)</span><span class="normal"> </span><span class="keyword">const</span><span class="symbol">;</span>


<span class="normal">    </span><span class="comment">// *** Container Encrypted Global Properties ***</span>

<span class="normal">    </span><span class="comment">/// Set (overwrite) an encrypted global property.</span>
<span class="normal">    </span><span class="type">void</span><span class="normal">		</span><span class="function">SetGlobalEncryptedProperty</span><span class="symbol">(</span><span class="keyword">const</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> key</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> value</span><span class="symbol">);</span>
<span class="normal">    </span>
<span class="normal">    </span><span class="comment">/// Get an encrypted global property by key.</span>
<span class="normal">    </span><span class="keyword">const</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal">	</span><span class="function">GetGlobalEncryptedProperty</span><span class="symbol">(</span><span class="keyword">const</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> key</span><span class="symbol">)</span><span class="normal"> </span><span class="keyword">const</span><span class="symbol">;</span>

<span class="normal">    </span><span class="comment">/// Delete an encrypted global property key.</span>
<span class="normal">    </span><span class="type">bool</span><span class="normal">		</span><span class="function">DeleteGlobalEncryptedProperty</span><span class="symbol">(</span><span class="keyword">const</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> key</span><span class="symbol">);</span>
<span class="normal">    </span>
<span class="normal">    </span><span class="comment">/// Get an encrypted global property (key and value) by index. Returns</span>
<span class="normal">    </span><span class="comment">/// false if the index is beyond the last property</span>
<span class="normal">    </span><span class="type">bool</span><span class="normal">		</span><span class="function">GetGlobalEncryptedPropertyIndex</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> propindex</span><span class="symbol">,</span>
<span class="normal">							std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> key</span><span class="symbol">,</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> value</span><span class="symbol">)</span><span class="normal"> </span><span class="keyword">const</span><span class="symbol">;</span>


<span class="normal">    </span><span class="comment">// *** Container SubFiles ***</span>


<span class="normal">    </span><span class="comment">// * Subfile array management *</span>

<span class="normal">    </span><span class="comment">/// Return number of subfiles in the container.</span>
<span class="normal">    </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> 	</span><span class="function">CountSubFile</span><span class="symbol">()</span><span class="normal"> </span><span class="keyword">const</span><span class="symbol">;</span>

<span class="normal">    </span><span class="comment">/// Append an empty uninitialized subfile at the end of the list. Returns</span>
<span class="normal">    </span><span class="comment">/// the new subfile's index.</span>
<span class="normal">    </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> 	</span><span class="function">AppendSubFile</span><span class="symbol">();</span>

<span class="normal">    </span><span class="comment">/// Insert an empty uninitialized subfile at the given position in the</span>
<span class="normal">    </span><span class="comment">/// list. Returns the new subfile's index.</span>
<span class="normal">    </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> 	</span><span class="function">InsertSubFile</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> subfileindex</span><span class="symbol">);</span>

<span class="normal">    </span><span class="comment">/// Delete a subfile in the array. Returns true if it existed.</span>
<span class="normal">    </span><span class="type">bool</span><span class="normal">		</span><span class="function">DeleteSubFile</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> subfileindex</span><span class="symbol">);</span>


<span class="normal">    </span><span class="comment">// * Subfile user-defined properties *</span>

<span class="normal">    </span><span class="comment">/// Set (overwrite) a subfile's property.</span>
<span class="normal">    </span><span class="type">void</span><span class="normal">		</span><span class="function">SetSubFileProperty</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> subfileindex</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> key</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> value</span><span class="symbol">);</span>

<span class="normal">    </span><span class="comment">/// Get a subfile's property by key. Returns an empty string if it is not set.</span>
<span class="normal">    </span><span class="keyword">const</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal">	</span><span class="function">GetSubFileProperty</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> subfileindex</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> key</span><span class="symbol">)</span><span class="normal"> </span><span class="keyword">const</span><span class="symbol">;</span>

<span class="normal">    </span><span class="comment">/// Delete a subfile's property key.</span>
<span class="normal">    </span><span class="type">bool</span><span class="normal">		</span><span class="function">DeleteSubFileProperty</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> subfileindex</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> key</span><span class="symbol">);</span>
<span class="normal">    </span>
<span class="normal">    </span><span class="comment">/// Get a subfile's property (key and value) by index. Returns false if the</span>
<span class="normal">    </span><span class="comment">/// index is beyond the last property</span>
<span class="normal">    </span><span class="type">bool</span><span class="normal">		</span><span class="function">GetSubFilePropertyIndex</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> subfileindex</span><span class="symbol">,</span><span class="normal"> </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> propindex</span><span class="symbol">,</span>
<span class="normal">						std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> key</span><span class="symbol">,</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> value</span><span class="symbol">)</span><span class="normal"> </span><span class="keyword">const</span><span class="symbol">;</span>


<span class="normal">    </span><span class="comment">// * Get operations of subfile header fields *</span>
<span class="normal">    </span>
<span class="normal">    </span><span class="comment">/// Return number of bytes the subfile requires on disk, after compression</span>
<span class="normal">    </span><span class="comment">/// and encryption.</span>
<span class="normal">    </span><span class="usertype">uint32_t</span><span class="normal">		</span><span class="function">GetSubFileStorageSize</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> subfileindex</span><span class="symbol">)</span><span class="normal"> </span><span class="keyword">const</span><span class="symbol">;</span>

<span class="normal">    </span><span class="comment">/// Return number of bytes the subfile requires when decrypted and</span>
<span class="normal">    </span><span class="comment">/// decompressed.</span>
<span class="normal">    </span><span class="usertype">uint32_t</span><span class="normal">		</span><span class="function">GetSubFileSize</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> subfileindex</span><span class="symbol">)</span><span class="normal"> </span><span class="keyword">const</span><span class="symbol">;</span>

<span class="normal">    </span><span class="comment">/// Return encryption cipher of the subfile.</span>
<span class="normal">    </span><span class="usertype">encryption_type</span><span class="normal">	</span><span class="function">GetSubFileEncryption</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> subfileindex</span><span class="symbol">)</span><span class="normal"> </span><span class="keyword">const</span><span class="symbol">;</span>

<span class="normal">    </span><span class="comment">/// Return compression method of the subfile.</span>
<span class="normal">    </span><span class="usertype">compression_type</span><span class="normal">	</span><span class="function">GetSubFileCompression</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> subfileindex</span><span class="symbol">)</span><span class="normal"> </span><span class="keyword">const</span><span class="symbol">;</span>


<span class="normal">    </span><span class="comment">// * Set operations of subfile header fields *</span>

<span class="normal">    </span><span class="comment">/// Set data encryption flag of a subfile. This can be an expensive</span>
<span class="normal">    </span><span class="comment">/// operation as the memory buffer may need to be decrypted/encrypted.</span>
<span class="normal">    </span><span class="type">void</span><span class="normal">		</span><span class="function">SetSubFileEncryption</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> subfileindex</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">encryption_type</span><span class="normal"> c</span><span class="symbol">);</span>

<span class="normal">    </span><span class="comment">/// Set data compression flag of a subfile. This can be an expensive</span>
<span class="normal">    </span><span class="comment">/// operation as the memory buffer may need to be decompressed/compressed.</span>
<span class="normal">    </span><span class="type">void</span><span class="normal">		</span><span class="function">SetSubFileCompression</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> subfileindex</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">compression_type</span><span class="normal"> c</span><span class="symbol">);</span>

<span class="normal">    </span><span class="comment">/// Set both data compression and encryption flags of a subfile. This can</span>
<span class="normal">    </span><span class="comment">/// be an expensive operation as the memory buffer may need to be</span>
<span class="normal">    </span><span class="comment">/// decompressed/compressed and reencrypted.</span>
<span class="normal">    </span><span class="type">void</span><span class="normal">		</span><span class="function">SetSubFileCompressionEncryption</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> subfileindex</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">compression_type</span><span class="normal"> comp</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">encryption_type</span><span class="normal"> enc</span><span class="symbol">);</span>


<span class="normal">    </span><span class="comment">// * Subfile data operations *</span>

<span class="normal">    </span><span class="comment">/// Return the data of a subfile: decrypt and uncompress it. The data is</span>
<span class="normal">    </span><span class="comment">/// sent block-wise to the DataOutput object.</span>
<span class="normal">    </span><span class="type">void</span><span class="normal">		</span><span class="function">GetSubFileData</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> subfileindex</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">class</span><span class="normal"> </span><span class="classname">DataOutput</span><span class="symbol">&amp;</span><span class="normal"> dataout</span><span class="symbol">)</span><span class="normal"> </span><span class="keyword">const</span><span class="symbol">;</span>

<span class="normal">    </span><span class="comment">/// Return the data of a subfile: decrypt and uncompress it. Return</span>
<span class="normal">    </span><span class="comment">/// complete data in a memory string.</span>
<span class="normal">    </span><span class="type">void</span><span class="normal">		</span><span class="function">GetSubFileData</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> subfileindex</span><span class="symbol">,</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> data</span><span class="symbol">)</span><span class="normal"> </span><span class="keyword">const</span><span class="symbol">;</span>

<span class="normal">    </span><span class="comment">/// Set/change the data of a subfile, it will be compressed and encrypted</span>
<span class="normal">    </span><span class="comment">/// but not written to disk, yet.</span>
<span class="normal">    </span><span class="type">void</span><span class="normal">		</span><span class="function">SetSubFileData</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> subfileindex</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> </span><span class="type">void</span><span class="symbol">*</span><span class="normal"> data</span><span class="symbol">,</span><span class="normal"> </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> datalen</span><span class="symbol">);</span>
<span class="cbracket">}</span><span class="symbol">;</span>

<span class="comment">// *** Assert which throws an InternalError  ***</span>

<span class="preproc">#define</span><span class="normal"> </span><span class="function">AssertException</span><span class="symbol">(</span><span class="normal">x</span><span class="symbol">)</span><span class="normal">	</span><span class="keyword">do</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!(</span><span class="normal">x</span><span class="symbol">))</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal"> </span><span class="keyword">throw</span><span class="symbol">(</span><span class="function">InternalError</span><span class="symbol">(</span><span class="normal">ETE_TEXT</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"Assertion failed: "</span><span class="normal"> #x</span><span class="symbol">));</span><span class="normal"> </span><span class="cbracket">}</span><span class="normal"> </span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">while</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">)</span>

<span class="comment">// *** Constructor, Destructor and Reference Counter  ***</span>

<span class="normal">ContainerImpl</span><span class="symbol">::</span><span class="function">ContainerImpl</span><span class="symbol">()</span>
<span class="normal">    </span><span class="symbol">:</span><span class="normal"> </span><span class="function">m_references</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">),</span>
<span class="normal">      </span><span class="function">m_modified</span><span class="symbol">(</span><span class="keyword">false</span><span class="symbol">),</span>
<span class="normal">      </span><span class="function">m_usedkeyslot</span><span class="symbol">(-</span><span class="number">1</span><span class="symbol">),</span>
<span class="normal">      </span><span class="function">m_written</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">),</span>
<span class="normal">      </span><span class="function">m_progressindicator</span><span class="symbol">(</span><span class="normal">NULL</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="function">memset</span><span class="symbol">(&amp;</span><span class="normal">m_header2</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="normal">m_header2</span><span class="symbol">));</span>
<span class="cbracket">}</span>

<span class="normal">ContainerImpl</span><span class="symbol">::~</span><span class="function">ContainerImpl</span><span class="symbol">()</span>
<span class="cbracket">{</span>
<span class="normal">    m_masterkey</span><span class="symbol">.</span><span class="function">clear</span><span class="symbol">();</span>
<span class="normal">    m_keyslots</span><span class="symbol">.</span><span class="function">clear</span><span class="symbol">();</span>
<span class="normal">    </span><span class="function">memset</span><span class="symbol">(&amp;</span><span class="normal">m_header2</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="normal">m_header2</span><span class="symbol">));</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> ContainerImpl</span><span class="symbol">::</span><span class="function">Clear</span><span class="symbol">()</span>
<span class="cbracket">{</span>
<span class="normal">    m_modified </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="normal">    </span><span class="function">memset</span><span class="symbol">(&amp;</span><span class="normal">m_header2</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="normal">m_header2</span><span class="symbol">));</span>
<span class="normal">    m_masterkey</span><span class="symbol">.</span><span class="function">clear</span><span class="symbol">();</span>
<span class="normal">    m_keyslots</span><span class="symbol">.</span><span class="function">clear</span><span class="symbol">();</span>
<span class="normal">    m_usedkeyslot </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">    m_unc_properties</span><span class="symbol">.</span><span class="function">clear</span><span class="symbol">();</span>
<span class="normal">    m_enc_properties</span><span class="symbol">.</span><span class="function">clear</span><span class="symbol">();</span>
<span class="normal">    m_subfiles</span><span class="symbol">.</span><span class="function">clear</span><span class="symbol">();</span>
<span class="normal">    m_written </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> ContainerImpl</span><span class="symbol">::</span><span class="function">IncReference</span><span class="symbol">()</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="symbol">++</span><span class="normal">m_references</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> ContainerImpl</span><span class="symbol">::</span><span class="function">DecReference</span><span class="symbol">()</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">--</span><span class="normal">m_references</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="comment">// *** Progress Indicator Wrappers ***</span>

<span class="comment">/**</span>
<span class="comment"> * Little class which starts a progress by calling ProgressStart() on it's</span>
<span class="comment"> * references container object. When it gets destroyed the progress ends.</span>
<span class="comment"> */</span>
<span class="keyword">class</span><span class="normal"> </span><span class="classname">ProgressTicker</span>
<span class="cbracket">{</span>
<span class="keyword">private</span><span class="symbol">:</span>
<span class="normal">    </span><span class="comment">/// Reference to the container implementation</span>
<span class="normal">    </span><span class="keyword">const</span><span class="normal"> ContainerImpl</span><span class="symbol">&amp;</span><span class="normal"> 	m_cnt</span><span class="symbol">;</span>

<span class="normal">    </span><span class="comment">/// Current counter value</span>
<span class="normal">    </span><span class="usertype">size_t</span><span class="normal">			m_current</span><span class="symbol">;</span>

<span class="keyword">public</span><span class="symbol">:</span>
<span class="normal">    </span><span class="function">ProgressTicker</span><span class="symbol">(</span><span class="keyword">const</span><span class="normal"> ContainerImpl</span><span class="symbol">&amp;</span><span class="normal"> c</span><span class="symbol">,</span>
<span class="normal">		   </span><span class="keyword">const</span><span class="normal"> </span><span class="type">char</span><span class="symbol">*</span><span class="normal"> pitext</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">progress_indicator_type</span><span class="normal"> pitype</span><span class="symbol">,</span>
<span class="normal">		   </span><span class="usertype">size_t</span><span class="normal"> value</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">size_t</span><span class="normal"> limit</span><span class="symbol">)</span>
<span class="normal">	</span><span class="symbol">:</span><span class="normal"> </span><span class="function">m_cnt</span><span class="symbol">(</span><span class="normal">c</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">m_cnt</span><span class="symbol">.</span><span class="normal">m_progressindicator</span><span class="symbol">)</span>
<span class="normal">	    m_cnt</span><span class="symbol">.</span><span class="normal">m_progressindicator</span><span class="symbol">-&gt;</span><span class="function">ProgressStart</span><span class="symbol">(</span><span class="normal">pitext</span><span class="symbol">,</span><span class="normal"> pitype</span><span class="symbol">,</span><span class="normal"> value</span><span class="symbol">,</span><span class="normal"> limit</span><span class="symbol">);</span>
<span class="normal">	m_current </span><span class="symbol">=</span><span class="normal"> value</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="type">void</span><span class="normal"> </span><span class="function">Restart</span><span class="symbol">(</span><span class="keyword">const</span><span class="normal"> </span><span class="type">char</span><span class="symbol">*</span><span class="normal"> pitext</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">progress_indicator_type</span><span class="normal"> pitype</span><span class="symbol">,</span>
<span class="normal">		 </span><span class="usertype">size_t</span><span class="normal"> value</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">size_t</span><span class="normal"> limit</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">m_cnt</span><span class="symbol">.</span><span class="normal">m_progressindicator</span><span class="symbol">)</span>
<span class="normal">	    m_cnt</span><span class="symbol">.</span><span class="normal">m_progressindicator</span><span class="symbol">-&gt;</span><span class="function">ProgressStart</span><span class="symbol">(</span><span class="normal">pitext</span><span class="symbol">,</span><span class="normal"> pitype</span><span class="symbol">,</span><span class="normal"> value</span><span class="symbol">,</span><span class="normal"> limit</span><span class="symbol">);</span>
<span class="normal">	m_current </span><span class="symbol">=</span><span class="normal"> value</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="type">void</span><span class="normal"> </span><span class="function">Update</span><span class="symbol">(</span><span class="usertype">size_t</span><span class="normal"> value</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">m_cnt</span><span class="symbol">.</span><span class="normal">m_progressindicator</span><span class="symbol">)</span>
<span class="normal">	    m_cnt</span><span class="symbol">.</span><span class="normal">m_progressindicator</span><span class="symbol">-&gt;</span><span class="function">ProgressUpdate</span><span class="symbol">(</span><span class="normal">value</span><span class="symbol">);</span>
<span class="normal">	m_current </span><span class="symbol">=</span><span class="normal"> value</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="normal">    </span>
<span class="normal">    </span><span class="type">void</span><span class="normal"> </span><span class="function">Add</span><span class="symbol">(</span><span class="usertype">size_t</span><span class="normal"> increment</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	m_current </span><span class="symbol">+=</span><span class="normal"> increment</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">m_cnt</span><span class="symbol">.</span><span class="normal">m_progressindicator</span><span class="symbol">)</span>
<span class="normal">	    m_cnt</span><span class="symbol">.</span><span class="normal">m_progressindicator</span><span class="symbol">-&gt;</span><span class="function">ProgressUpdate</span><span class="symbol">(</span><span class="normal">m_current</span><span class="symbol">);</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="symbol">~</span><span class="function">ProgressTicker</span><span class="symbol">()</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">m_cnt</span><span class="symbol">.</span><span class="normal">m_progressindicator</span><span class="symbol">)</span>
<span class="normal">	    m_cnt</span><span class="symbol">.</span><span class="normal">m_progressindicator</span><span class="symbol">-&gt;</span><span class="function">ProgressStop</span><span class="symbol">();</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="cbracket">}</span><span class="symbol">;</span>

<span class="comment">// *** Settings ***</span>

<span class="type">char</span><span class="normal"> ContainerImpl</span><span class="symbol">::</span><span class="normal">m_filesignature</span><span class="symbol">[</span><span class="number">8</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span>
<span class="cbracket">{</span><span class="normal"> </span><span class="string">'C'</span><span class="symbol">,</span><span class="normal"> </span><span class="string">'r'</span><span class="symbol">,</span><span class="normal"> </span><span class="string">'y'</span><span class="symbol">,</span><span class="normal"> </span><span class="string">'p'</span><span class="symbol">,</span><span class="normal"> </span><span class="string">'t'</span><span class="symbol">,</span><span class="normal"> </span><span class="string">'o'</span><span class="symbol">,</span><span class="normal"> </span><span class="string">'T'</span><span class="symbol">,</span><span class="normal"> </span><span class="string">'E'</span><span class="normal"> </span><span class="cbracket">}</span><span class="symbol">;</span>

<span class="comment">/* static */</span><span class="normal"> </span><span class="type">void</span><span class="normal"> ContainerImpl</span><span class="symbol">::</span><span class="function">SetSignature</span><span class="symbol">(</span><span class="keyword">const</span><span class="normal"> </span><span class="type">char</span><span class="symbol">*</span><span class="normal"> sign</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">    </span><span class="keyword">while</span><span class="symbol">(</span><span class="normal">sign</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	m_filesignature</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> sign</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">];</span>
<span class="normal">	</span><span class="symbol">++</span><span class="normal">i</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="normal">    </span><span class="keyword">while</span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	m_filesignature</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">	</span><span class="symbol">++</span><span class="normal">i</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="comment">/* static */</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> </span><span class="type">char</span><span class="symbol">*</span><span class="normal"> ContainerImpl</span><span class="symbol">::</span><span class="function">GetErrorString</span><span class="symbol">(</span><span class="usertype">error_type</span><span class="normal"> e</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">switch</span><span class="symbol">(</span><span class="normal">e</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">case</span><span class="normal"> ETE_SUCCESS</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="string">"Success."</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">case</span><span class="normal"> ETE_TEXT</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="string">"Generic text message error."</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">case</span><span class="normal"> ETE_OUTPUT_ERROR</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="string">"DataOutput stream error."</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">case</span><span class="normal"> ETE_INPUT_ERROR</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="string">"DataInput stream error."</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">case</span><span class="normal"> ETE_SAVE_NO_KEYSLOTS</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="string">"Error saving container: no encryption key slots set!"</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">case</span><span class="normal"> ETE_LOAD_HEADER1</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="string">"Error loading container: could not read primary header."</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">case</span><span class="normal"> ETE_LOAD_HEADER1_SIGNATURE</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="string">"Error loading container: could not read primary header, invalid signature."</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">case</span><span class="normal"> ETE_LOAD_HEADER1_VERSION</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="string">"Error loading container: could not read primary header, invalid version."</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">case</span><span class="normal"> ETE_LOAD_HEADER1_METADATA</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="string">"Error loading container: could not read primary header, invalid metadata."</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">case</span><span class="normal"> ETE_LOAD_HEADER1_METADATA_PARSE</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="string">"Error loading container: could not read primary header, metadata parse failed."</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">case</span><span class="normal"> ETE_LOAD_HEADER2</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="string">"Error loading container: could not read key slots header."</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">case</span><span class="normal"> ETE_LOAD_HEADER2_NO_KEYSLOTS</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="string">"Error loading container: file contains no key slots for decryption."</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">case</span><span class="normal"> ETE_LOAD_HEADER2_KEYSLOTS</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="string">"Error loading container: could not read key slots header, error reading key slot material."</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">case</span><span class="normal"> ETE_LOAD_HEADER2_INVALID_KEY</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="string">"Error loading container: supplied key matches no key slot in header, check password."</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">case</span><span class="normal"> ETE_LOAD_HEADER3</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="string">"Error loading container: could not read data header."</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">case</span><span class="normal"> ETE_LOAD_HEADER3_ENCRYPTION</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="string">"Error loading container: could not read data header, check encryption key."</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">case</span><span class="normal"> ETE_LOAD_HEADER3_METADATA</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="string">"Error loading container: could not read data header, invalid metadata."</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">case</span><span class="normal"> ETE_LOAD_HEADER3_METADATA_CHECKSUM</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="string">"Error loading container: could not read data header, metadata CRC32 checksum mismatch."</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">case</span><span class="normal"> ETE_LOAD_HEADER3_METADATA_PARSE</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="string">"Error loading container: could not read data header, metadata parse failed."</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">case</span><span class="normal"> ETE_LOAD_SUBFILE</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="string">"Error loading container: could not read encrypted subfile data."</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">case</span><span class="normal"> ETE_LOAD_CHECKSUM</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="string">"Error loading container: CRC32 checksum mismatch, file possibly corrupt."</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">case</span><span class="normal"> ETE_KEYSLOT_INVALID_INDEX</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="string">"Invalid encryption key slot index."</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">case</span><span class="normal"> ETE_SUBFILE_INVALID_INDEX</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="string">"Invalid subfile index."</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">case</span><span class="normal"> ETE_SUBFILE_CHECKSUM</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="string">"Error in subfile: CRC32 checksum mismatch, data possibly corrupt."</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">case</span><span class="normal"> ETE_SUBFILE_INVALID_COMPRESSION</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="string">"Unknown subfile compression algorithm."</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">case</span><span class="normal"> ETE_SUBFILE_INVALID_ENCRYPTION</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="string">"Unknown subfile encryption cipher."</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">case</span><span class="normal"> ETE_Z_UNKNOWN</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="string">"Error in zlib: unknown error."</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">case</span><span class="normal"> ETE_Z_OK</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="string">"Error in zlib: success."</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">case</span><span class="normal"> ETE_Z_NEED_DICT</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="string">"Error in zlib: need dictionary."</span><span class="symbol">;</span>
<span class="normal">	</span>
<span class="normal">    </span><span class="keyword">case</span><span class="normal"> ETE_Z_STREAM_END</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="string">"Error in zlib: stream end."</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">case</span><span class="normal"> ETE_Z_ERRNO</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="string">"Error in zlib: file error."</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">case</span><span class="normal"> ETE_Z_STREAM_ERROR</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="string">"Error in zlib: stream error."</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">case</span><span class="normal"> ETE_Z_DATA_ERROR</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="string">"Error in zlib: data error."</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">case</span><span class="normal"> ETE_Z_MEM_ERROR</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="string">"Error in zlib: insufficient memory."</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">case</span><span class="normal"> ETE_Z_BUF_ERROR</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="string">"Error in zlib: buffer error."</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">case</span><span class="normal"> ETE_Z_VERSION_ERROR</span><span class="symbol">:</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="string">"Error in zlib: incompatible version."</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="keyword">return</span><span class="normal"> </span><span class="string">"Unknown error code."</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="keyword">static</span><span class="normal"> </span><span class="usertype">error_type</span><span class="normal"> </span><span class="function">ErrorCodeFromZLibError</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> ret</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">switch</span><span class="symbol">(</span><span class="normal">ret</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">default</span><span class="symbol">:</span><span class="normal">			</span><span class="keyword">return</span><span class="normal"> ETE_Z_UNKNOWN</span><span class="symbol">;</span>
<span class="normal">    </span><span class="keyword">case</span><span class="normal"> Z_NEED_DICT</span><span class="symbol">:</span><span class="normal">		</span><span class="keyword">return</span><span class="normal"> ETE_Z_NEED_DICT</span><span class="symbol">;</span>
<span class="normal">    </span><span class="keyword">case</span><span class="normal"> Z_STREAM_END</span><span class="symbol">:</span><span class="normal">		</span><span class="keyword">return</span><span class="normal"> ETE_Z_STREAM_END</span><span class="symbol">;</span>
<span class="normal">    </span><span class="keyword">case</span><span class="normal"> Z_OK</span><span class="symbol">:</span><span class="normal">			</span><span class="keyword">return</span><span class="normal"> ETE_Z_OK</span><span class="symbol">;</span>
<span class="normal">    </span><span class="keyword">case</span><span class="normal"> Z_ERRNO</span><span class="symbol">:</span><span class="normal">		</span><span class="keyword">return</span><span class="normal"> ETE_Z_ERRNO</span><span class="symbol">;</span>
<span class="normal">    </span><span class="keyword">case</span><span class="normal"> Z_STREAM_ERROR</span><span class="symbol">:</span><span class="normal">	</span><span class="keyword">return</span><span class="normal"> ETE_Z_STREAM_ERROR</span><span class="symbol">;</span>
<span class="normal">    </span><span class="keyword">case</span><span class="normal"> Z_DATA_ERROR</span><span class="symbol">:</span><span class="normal">		</span><span class="keyword">return</span><span class="normal"> ETE_Z_DATA_ERROR</span><span class="symbol">;</span>
<span class="normal">    </span><span class="keyword">case</span><span class="normal"> Z_MEM_ERROR</span><span class="symbol">:</span><span class="normal">		</span><span class="keyword">return</span><span class="normal"> ETE_Z_MEM_ERROR</span><span class="symbol">;</span>
<span class="normal">    </span><span class="keyword">case</span><span class="normal"> Z_BUF_ERROR</span><span class="symbol">:</span><span class="normal">		</span><span class="keyword">return</span><span class="normal"> ETE_Z_BUF_ERROR</span><span class="symbol">;</span>
<span class="normal">    </span><span class="keyword">case</span><span class="normal"> Z_VERSION_ERROR</span><span class="symbol">:</span><span class="normal">	</span><span class="keyword">return</span><span class="normal"> ETE_Z_VERSION_ERROR</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="comment">// *** Utilities Operations ***</span>

<span class="keyword">static</span><span class="normal"> </span><span class="keyword">inline</span><span class="normal"> </span><span class="usertype">uint32_t</span><span class="normal"> </span><span class="function">random_iterations</span><span class="symbol">()</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="usertype">uint16_t</span><span class="normal"> iterations</span><span class="symbol">;</span>
<span class="normal">    Botan</span><span class="symbol">::</span><span class="normal">Global_RNG</span><span class="symbol">::</span><span class="function">randomize</span><span class="symbol">((</span><span class="normal">Botan</span><span class="symbol">::</span><span class="normal">byte</span><span class="symbol">*)&amp;</span><span class="normal">iterations</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="normal">iterations</span><span class="symbol">));</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">iterations </span><span class="symbol">%</span><span class="normal"> </span><span class="number">10000</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1000</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="keyword">static</span><span class="normal"> </span><span class="keyword">inline</span><span class="normal"> </span><span class="usertype">uint32_t</span><span class="normal"> </span><span class="function">botan_crc32</span><span class="symbol">(</span><span class="normal">Botan</span><span class="symbol">::</span><span class="normal">byte</span><span class="symbol">*</span><span class="normal"> data</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">uint32_t</span><span class="normal"> datalen</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    Botan</span><span class="symbol">::</span><span class="usertype">SecureVector&lt;Botan::byte&gt;</span><span class="normal"> crc </span><span class="symbol">=</span><span class="normal"> Botan</span><span class="symbol">::</span><span class="function">CRC32</span><span class="symbol">().</span><span class="function">process</span><span class="symbol">(</span><span class="normal">data</span><span class="symbol">,</span><span class="normal"> datalen</span><span class="symbol">);</span>
<span class="normal">    </span><span class="function">AssertException</span><span class="symbol">(</span><span class="normal">crc</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="number">4</span><span class="symbol">);</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">uint32_t</span><span class="symbol">*)</span><span class="normal">crc</span><span class="symbol">.</span><span class="function">begin</span><span class="symbol">();</span>
<span class="cbracket">}</span>

<span class="comment">// *** Botan Library Helpers ***</span>

<span class="keyword">class</span><span class="normal"> </span><span class="classname">DataSinkSecureVector</span><span class="normal"> </span><span class="symbol">:</span><span class="normal"> </span><span class="keyword">public</span><span class="normal"> Botan</span><span class="symbol">::</span><span class="normal">DataSink</span>
<span class="cbracket">{</span>
<span class="keyword">private</span><span class="symbol">:</span>
<span class="normal">    Botan</span><span class="symbol">::</span><span class="normal">SecureVector</span><span class="symbol">&lt;</span><span class="normal">Botan</span><span class="symbol">::</span><span class="normal">byte</span><span class="symbol">&gt;&amp;</span><span class="normal">	m_secmem</span><span class="symbol">;</span>

<span class="keyword">public</span><span class="symbol">:</span>
<span class="normal">    </span><span class="function">DataSinkSecureVector</span><span class="symbol">(</span><span class="normal">Botan</span><span class="symbol">::</span><span class="normal">SecureVector</span><span class="symbol">&lt;</span><span class="normal">Botan</span><span class="symbol">::</span><span class="normal">byte</span><span class="symbol">&gt;&amp;</span><span class="normal"> secmem</span><span class="symbol">)</span>
<span class="normal">	</span><span class="symbol">:</span><span class="normal"> </span><span class="function">m_secmem</span><span class="symbol">(</span><span class="normal">secmem</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span><span class="normal"> </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="type">void</span><span class="normal"> </span><span class="function">write</span><span class="symbol">(</span><span class="keyword">const</span><span class="normal"> Botan</span><span class="symbol">::</span><span class="usertype">byte</span><span class="normal"> out</span><span class="symbol">[],</span><span class="normal"> Botan</span><span class="symbol">::</span><span class="usertype">u32bit</span><span class="normal"> length</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	m_secmem</span><span class="symbol">.</span><span class="function">append</span><span class="symbol">(</span><span class="normal">out</span><span class="symbol">,</span><span class="normal"> length</span><span class="symbol">);</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="cbracket">}</span><span class="symbol">;</span>

<span class="keyword">class</span><span class="normal"> </span><span class="classname">DataSink2DataOutput</span><span class="normal"> </span><span class="symbol">:</span><span class="normal"> </span><span class="keyword">public</span><span class="normal"> Botan</span><span class="symbol">::</span><span class="normal">DataSink</span>
<span class="cbracket">{</span>
<span class="keyword">private</span><span class="symbol">:</span>
<span class="normal">    DataOutput</span><span class="symbol">&amp;</span><span class="normal">		m_dataout</span><span class="symbol">;</span>
<span class="normal">    </span><span class="usertype">uint32_t</span><span class="normal">		m_written</span><span class="symbol">;</span>
<span class="normal">    ProgressTicker</span><span class="symbol">&amp;</span><span class="normal">	m_progress</span><span class="symbol">;</span>

<span class="keyword">public</span><span class="symbol">:</span>
<span class="normal">    </span><span class="function">DataSink2DataOutput</span><span class="symbol">(</span><span class="normal">DataOutput</span><span class="symbol">&amp;</span><span class="normal"> do_</span><span class="symbol">,</span><span class="normal"> ProgressTicker</span><span class="symbol">&amp;</span><span class="normal"> progress</span><span class="symbol">)</span>
<span class="normal">	</span><span class="symbol">:</span><span class="normal"> </span><span class="function">m_dataout</span><span class="symbol">(</span><span class="normal">do_</span><span class="symbol">),</span><span class="normal"> </span><span class="function">m_written</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">),</span><span class="normal"> </span><span class="function">m_progress</span><span class="symbol">(</span><span class="normal">progress</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span><span class="normal"> </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="type">void</span><span class="normal"> </span><span class="function">write</span><span class="symbol">(</span><span class="keyword">const</span><span class="normal"> Botan</span><span class="symbol">::</span><span class="usertype">byte</span><span class="normal"> out</span><span class="symbol">[],</span><span class="normal"> Botan</span><span class="symbol">::</span><span class="usertype">u32bit</span><span class="normal"> length</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">m_dataout</span><span class="symbol">.</span><span class="function">Output</span><span class="symbol">(</span><span class="normal">out</span><span class="symbol">,</span><span class="normal"> length</span><span class="symbol">))</span>
<span class="normal">	    </span><span class="keyword">throw</span><span class="symbol">(</span><span class="function">RuntimeError</span><span class="symbol">(</span><span class="normal">ETE_OUTPUT_ERROR</span><span class="symbol">));</span>

<span class="normal">	m_written </span><span class="symbol">+=</span><span class="normal"> length</span><span class="symbol">;</span>
<span class="normal">	m_progress</span><span class="symbol">.</span><span class="function">Add</span><span class="symbol">(</span><span class="normal">length</span><span class="symbol">);</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="usertype">uint32_t</span><span class="normal"> </span><span class="function">get_written</span><span class="symbol">()</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal"> </span><span class="keyword">return</span><span class="normal"> m_written</span><span class="symbol">;</span><span class="normal"> </span><span class="cbracket">}</span>
<span class="cbracket">}</span><span class="symbol">;</span>

<span class="keyword">class</span><span class="normal"> </span><span class="classname">NullBufferingFilter</span><span class="normal"> </span><span class="symbol">:</span><span class="normal"> </span><span class="keyword">public</span><span class="normal"> Botan</span><span class="symbol">::</span><span class="normal">Buffering_Filter</span>
<span class="cbracket">{</span>
<span class="keyword">public</span><span class="symbol">:</span>
<span class="normal">    </span><span class="keyword">const</span><span class="normal"> </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> m_blocksize</span><span class="symbol">;</span>

<span class="normal">    </span><span class="function">NullBufferingFilter</span><span class="symbol">(</span><span class="usertype">uint32_t</span><span class="normal"> blocksize</span><span class="symbol">)</span>
<span class="normal">	</span><span class="symbol">:</span><span class="normal"> </span><span class="function">Buffering_Filter</span><span class="symbol">(</span><span class="normal">blocksize</span><span class="symbol">),</span><span class="normal"> </span><span class="function">m_blocksize</span><span class="symbol">(</span><span class="normal">blocksize</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span><span class="normal"> </span><span class="cbracket">}</span>

<span class="keyword">protected</span><span class="symbol">:</span>
<span class="normal">    </span><span class="keyword">virtual</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="function">main_block</span><span class="symbol">(</span><span class="keyword">const</span><span class="normal"> Botan</span><span class="symbol">::</span><span class="usertype">byte</span><span class="normal"> input</span><span class="symbol">[])</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="function">send</span><span class="symbol">(</span><span class="normal">input</span><span class="symbol">,</span><span class="normal"> m_blocksize</span><span class="symbol">);</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="normal">    </span><span class="keyword">virtual</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="function">final_block</span><span class="symbol">(</span><span class="keyword">const</span><span class="normal"> Botan</span><span class="symbol">::</span><span class="usertype">byte</span><span class="normal"> input</span><span class="symbol">[],</span><span class="normal"> Botan</span><span class="symbol">::</span><span class="usertype">u32bit</span><span class="normal"> length</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="function">send</span><span class="symbol">(</span><span class="normal">input</span><span class="symbol">,</span><span class="normal"> length</span><span class="symbol">);</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="cbracket">}</span><span class="symbol">;</span>

<span class="comment">// *** DataOutput and DataInput Hashing Helpers ***</span>

<span class="keyword">class</span><span class="normal"> </span><span class="classname">DataOutputHashChain</span><span class="normal"> </span><span class="symbol">:</span><span class="normal"> </span><span class="keyword">public</span><span class="normal"> DataOutput</span>
<span class="cbracket">{</span>
<span class="keyword">public</span><span class="symbol">:</span>
<span class="normal">    </span><span class="comment">/// DataOutput to received data</span>
<span class="normal">    DataOutput</span><span class="symbol">&amp;</span><span class="normal">			m_chain</span><span class="symbol">;</span>

<span class="normal">    </span><span class="comment">/// Hash object to update</span>
<span class="normal">    Botan</span><span class="symbol">::</span><span class="normal">HashFunction</span><span class="symbol">&amp;</span><span class="normal">	m_hash</span><span class="symbol">;</span>

<span class="normal">    </span><span class="function">DataOutputHashChain</span><span class="symbol">(</span><span class="normal">DataOutput</span><span class="symbol">&amp;</span><span class="normal"> chain</span><span class="symbol">,</span><span class="normal"> Botan</span><span class="symbol">::</span><span class="normal">HashFunction</span><span class="symbol">&amp;</span><span class="normal"> hash</span><span class="symbol">)</span>
<span class="normal">	</span><span class="symbol">:</span><span class="normal"> </span><span class="function">m_chain</span><span class="symbol">(</span><span class="normal">chain</span><span class="symbol">),</span><span class="normal"> </span><span class="function">m_hash</span><span class="symbol">(</span><span class="normal">hash</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span><span class="normal"> </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="type">bool</span><span class="normal"> </span><span class="function">Output</span><span class="symbol">(</span><span class="keyword">const</span><span class="normal"> </span><span class="type">void</span><span class="symbol">*</span><span class="normal"> data</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">size_t</span><span class="normal"> datalen</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	m_hash</span><span class="symbol">.</span><span class="function">update</span><span class="symbol">((</span><span class="keyword">const</span><span class="normal"> Botan</span><span class="symbol">::</span><span class="normal">byte</span><span class="symbol">*)</span><span class="normal">data</span><span class="symbol">,</span><span class="normal"> datalen</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> m_chain</span><span class="symbol">.</span><span class="function">Output</span><span class="symbol">(</span><span class="normal">data</span><span class="symbol">,</span><span class="normal"> datalen</span><span class="symbol">);</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="cbracket">}</span><span class="symbol">;</span>

<span class="keyword">class</span><span class="normal"> </span><span class="classname">DataInputHashChain</span><span class="normal"> </span><span class="symbol">:</span><span class="normal"> </span><span class="keyword">public</span><span class="normal"> DataInput</span>
<span class="cbracket">{</span>
<span class="keyword">public</span><span class="symbol">:</span>
<span class="normal">    </span><span class="comment">/// DataInput to received data from</span>
<span class="normal">    DataInput</span><span class="symbol">&amp;</span><span class="normal">			m_chain</span><span class="symbol">;</span>

<span class="normal">    </span><span class="comment">/// Hash object to update</span>
<span class="normal">    Botan</span><span class="symbol">::</span><span class="normal">HashFunction</span><span class="symbol">&amp;</span><span class="normal">	m_hash</span><span class="symbol">;</span>

<span class="normal">    </span><span class="function">DataInputHashChain</span><span class="symbol">(</span><span class="normal">DataInput</span><span class="symbol">&amp;</span><span class="normal"> chain</span><span class="symbol">,</span><span class="normal"> Botan</span><span class="symbol">::</span><span class="normal">HashFunction</span><span class="symbol">&amp;</span><span class="normal"> hash</span><span class="symbol">)</span>
<span class="normal">	</span><span class="symbol">:</span><span class="normal"> </span><span class="function">m_chain</span><span class="symbol">(</span><span class="normal">chain</span><span class="symbol">),</span><span class="normal"> </span><span class="function">m_hash</span><span class="symbol">(</span><span class="normal">hash</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span><span class="normal"> </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> </span><span class="function">Input</span><span class="symbol">(</span><span class="type">void</span><span class="symbol">*</span><span class="normal"> data</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">size_t</span><span class="normal"> maxlen</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> rb </span><span class="symbol">=</span><span class="normal"> m_chain</span><span class="symbol">.</span><span class="function">Input</span><span class="symbol">(</span><span class="normal">data</span><span class="symbol">,</span><span class="normal"> maxlen</span><span class="symbol">);</span>
<span class="normal">	m_hash</span><span class="symbol">.</span><span class="function">update</span><span class="symbol">((</span><span class="normal">Botan</span><span class="symbol">::</span><span class="normal">byte</span><span class="symbol">*)</span><span class="normal">data</span><span class="symbol">,</span><span class="normal"> rb</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> rb</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="cbracket">}</span><span class="symbol">;</span>

<span class="comment">// *** Load/Save Operations ***</span>

<span class="type">void</span><span class="normal"> ContainerImpl</span><span class="symbol">::</span><span class="function">Save</span><span class="symbol">(</span><span class="normal">DataOutput</span><span class="symbol">&amp;</span><span class="normal"> dataout_</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    m_written </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">m_keyslots</span><span class="symbol">.</span><span class="function">empty</span><span class="symbol">())</span>
<span class="normal">	</span><span class="keyword">throw</span><span class="symbol">(</span><span class="function">ProgramError</span><span class="symbol">(</span><span class="normal">ETE_SAVE_NO_KEYSLOTS</span><span class="symbol">));</span>

<span class="normal">    </span><span class="comment">// Estimate amount of data written to file</span>

<span class="normal">    </span><span class="usertype">size_t</span><span class="normal"> subfiletotal </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> si </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> si </span><span class="symbol">&lt;</span><span class="normal"> m_subfiles</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">();</span><span class="normal"> </span><span class="symbol">++</span><span class="normal">si</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	subfiletotal </span><span class="symbol">+=</span><span class="normal"> m_subfiles</span><span class="symbol">[</span><span class="normal">si</span><span class="symbol">].</span><span class="normal">storagesize</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="usertype">size_t</span><span class="normal"> esttotal </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="normal">Header1</span><span class="symbol">)</span>
<span class="normal">	</span><span class="symbol">+</span><span class="normal"> </span><span class="number">100</span><span class="normal"> </span><span class="comment">// estimate for unencrypted metadata</span>
<span class="normal">	</span><span class="symbol">+</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="normal">Header2</span><span class="symbol">)</span>
<span class="normal">	</span><span class="symbol">+</span><span class="normal"> m_keyslots</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="normal">KeySlot</span><span class="symbol">)</span>
<span class="normal">	</span><span class="symbol">+</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="normal">Header3</span><span class="symbol">)</span>
<span class="normal">	</span><span class="symbol">+</span><span class="normal"> m_subfiles</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> </span><span class="number">50</span><span class="normal"> </span><span class="comment">// estimate for encrypted metadata</span>
<span class="normal">	</span><span class="symbol">+</span><span class="normal"> subfiletotal</span><span class="symbol">;</span>

<span class="normal">    </span><span class="usertype">ProgressTicker</span><span class="normal"> </span><span class="function">progress</span><span class="symbol">(*</span><span class="keyword">this</span><span class="symbol">,</span>
<span class="normal">			    </span><span class="string">"Saving Container"</span><span class="symbol">,</span><span class="normal"> PI_SAVE_CONTAINER</span><span class="symbol">,</span>
<span class="normal">			    </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> esttotal</span><span class="symbol">);</span>

<span class="normal">    Botan</span><span class="symbol">::</span><span class="usertype">CRC32</span><span class="normal"> crc32all</span><span class="symbol">;</span>
<span class="normal">    </span><span class="usertype">DataOutputHashChain</span><span class="normal"> </span><span class="function">dataout</span><span class="symbol">(</span><span class="normal">dataout_</span><span class="symbol">,</span><span class="normal"> crc32all</span><span class="symbol">);</span>

<span class="normal">    </span><span class="comment">// Write out unencrypted fixed Header1 and unencrypted metadata</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="comment">// Prepare variable metadata header containing unencrypted global</span>
<span class="normal">	</span><span class="comment">// properties.</span>
<span class="normal">	</span><span class="usertype">ByteBuffer</span><span class="normal"> unc_metadata</span><span class="symbol">;</span>

<span class="normal">	unc_metadata</span><span class="symbol">.</span><span class="normal">put</span><span class="symbol">&lt;</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="symbol">&gt;(</span><span class="normal">m_unc_properties</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">());</span>

<span class="normal">	</span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">propertymap_type</span><span class="symbol">::</span><span class="usertype">const_iterator</span><span class="normal"> pi </span><span class="symbol">=</span><span class="normal"> m_unc_properties</span><span class="symbol">.</span><span class="function">begin</span><span class="symbol">();</span>
<span class="normal">	     pi </span><span class="symbol">!=</span><span class="normal"> m_unc_properties</span><span class="symbol">.</span><span class="function">end</span><span class="symbol">();</span><span class="normal"> </span><span class="symbol">++</span><span class="normal">pi</span><span class="symbol">)</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    unc_metadata</span><span class="symbol">.</span><span class="normal">put</span><span class="symbol">&lt;</span><span class="normal">std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&gt;(</span><span class="normal">pi</span><span class="symbol">-&gt;</span><span class="normal">first</span><span class="symbol">);</span>
<span class="normal">	    unc_metadata</span><span class="symbol">.</span><span class="normal">put</span><span class="symbol">&lt;</span><span class="normal">std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&gt;(</span><span class="normal">pi</span><span class="symbol">-&gt;</span><span class="normal">second</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">Header1</span><span class="normal"> header1</span><span class="symbol">;</span>
<span class="normal">	</span><span class="function">memcpy</span><span class="symbol">(</span><span class="normal">header1</span><span class="symbol">.</span><span class="normal">signature</span><span class="symbol">,</span><span class="normal"> m_filesignature</span><span class="symbol">,</span><span class="normal"> </span><span class="number">8</span><span class="symbol">);</span>
<span class="normal">	header1</span><span class="symbol">.</span><span class="normal">version_major </span><span class="symbol">=</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">	header1</span><span class="symbol">.</span><span class="normal">version_minor </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">	header1</span><span class="symbol">.</span><span class="normal">unc_metalen </span><span class="symbol">=</span><span class="normal"> unc_metadata</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">();</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">dataout</span><span class="symbol">.</span><span class="function">Output</span><span class="symbol">(&amp;</span><span class="normal">header1</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="normal">header1</span><span class="symbol">)))</span>
<span class="normal">	    </span><span class="keyword">throw</span><span class="symbol">(</span><span class="function">RuntimeError</span><span class="symbol">(</span><span class="normal">ETE_OUTPUT_ERROR</span><span class="symbol">));</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">dataout</span><span class="symbol">.</span><span class="function">Output</span><span class="symbol">(</span><span class="normal">unc_metadata</span><span class="symbol">.</span><span class="function">data</span><span class="symbol">(),</span><span class="normal"> unc_metadata</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">()))</span>
<span class="normal">	    </span><span class="keyword">throw</span><span class="symbol">(</span><span class="function">RuntimeError</span><span class="symbol">(</span><span class="normal">ETE_OUTPUT_ERROR</span><span class="symbol">));</span>

<span class="normal">	m_written </span><span class="symbol">+=</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="normal">header1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> unc_metadata</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">();</span>
<span class="normal">	progress</span><span class="symbol">.</span><span class="function">Update</span><span class="symbol">(</span><span class="normal">m_written</span><span class="symbol">);</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="comment">// Write out master key digest and all key slots</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	m_header2</span><span class="symbol">.</span><span class="normal">keyslots </span><span class="symbol">=</span><span class="normal"> m_keyslots</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">();</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">dataout</span><span class="symbol">.</span><span class="function">Output</span><span class="symbol">(&amp;</span><span class="normal">m_header2</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="normal">m_header2</span><span class="symbol">)))</span>
<span class="normal">	    </span><span class="keyword">throw</span><span class="symbol">(</span><span class="function">RuntimeError</span><span class="symbol">(</span><span class="normal">ETE_OUTPUT_ERROR</span><span class="symbol">));</span>

<span class="normal">	</span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> m_keyslots</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">();</span><span class="normal"> </span><span class="symbol">++</span><span class="normal">i</span><span class="symbol">)</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">dataout</span><span class="symbol">.</span><span class="function">Output</span><span class="symbol">(&amp;</span><span class="normal">m_keyslots</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">],</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="normal">m_keyslots</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">])))</span>
<span class="normal">		</span><span class="keyword">throw</span><span class="symbol">(</span><span class="function">RuntimeError</span><span class="symbol">(</span><span class="normal">ETE_OUTPUT_ERROR</span><span class="symbol">));</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="comment">// Prepare variable metadata header containing global properties and all</span>
<span class="normal">    </span><span class="comment">// subfile properties.</span>
<span class="normal">    </span><span class="usertype">ByteBuffer</span><span class="normal"> metadata</span><span class="symbol">;</span>

<span class="normal">    </span><span class="comment">// append global properties</span>
<span class="normal">    metadata</span><span class="symbol">.</span><span class="normal">put</span><span class="symbol">&lt;</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="symbol">&gt;(</span><span class="normal">m_enc_properties</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">());</span>

<span class="normal">    </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">propertymap_type</span><span class="symbol">::</span><span class="usertype">const_iterator</span><span class="normal"> pi </span><span class="symbol">=</span><span class="normal"> m_enc_properties</span><span class="symbol">.</span><span class="function">begin</span><span class="symbol">();</span>
<span class="normal">	 pi </span><span class="symbol">!=</span><span class="normal"> m_enc_properties</span><span class="symbol">.</span><span class="function">end</span><span class="symbol">();</span><span class="normal"> </span><span class="symbol">++</span><span class="normal">pi</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	metadata</span><span class="symbol">.</span><span class="normal">put</span><span class="symbol">&lt;</span><span class="normal">std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&gt;(</span><span class="normal">pi</span><span class="symbol">-&gt;</span><span class="normal">first</span><span class="symbol">);</span>
<span class="normal">	metadata</span><span class="symbol">.</span><span class="normal">put</span><span class="symbol">&lt;</span><span class="normal">std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&gt;(</span><span class="normal">pi</span><span class="symbol">-&gt;</span><span class="normal">second</span><span class="symbol">);</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="comment">// append subfile metadata</span>
<span class="normal">    metadata</span><span class="symbol">.</span><span class="normal">put</span><span class="symbol">&lt;</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="symbol">&gt;(</span><span class="normal">m_subfiles</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">());</span>

<span class="normal">    </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> si </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> si </span><span class="symbol">&lt;</span><span class="normal"> m_subfiles</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">();</span><span class="normal"> </span><span class="symbol">++</span><span class="normal">si</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="comment">// fixed structure</span>
<span class="normal">	metadata</span><span class="symbol">.</span><span class="normal">put</span><span class="symbol">&lt;</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="symbol">&gt;(</span><span class="normal">m_subfiles</span><span class="symbol">[</span><span class="normal">si</span><span class="symbol">].</span><span class="normal">storagesize</span><span class="symbol">);</span>
<span class="normal">	metadata</span><span class="symbol">.</span><span class="normal">put</span><span class="symbol">&lt;</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="symbol">&gt;(</span><span class="normal">m_subfiles</span><span class="symbol">[</span><span class="normal">si</span><span class="symbol">].</span><span class="normal">realsize</span><span class="symbol">);</span>
<span class="normal">	metadata</span><span class="symbol">.</span><span class="normal">put</span><span class="symbol">&lt;</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="symbol">&gt;(</span><span class="normal">m_subfiles</span><span class="symbol">[</span><span class="normal">si</span><span class="symbol">].</span><span class="normal">flags</span><span class="symbol">);</span>
<span class="normal">	metadata</span><span class="symbol">.</span><span class="normal">put</span><span class="symbol">&lt;</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="symbol">&gt;(</span><span class="normal">m_subfiles</span><span class="symbol">[</span><span class="normal">si</span><span class="symbol">].</span><span class="normal">crc32</span><span class="symbol">);</span>

<span class="normal">	</span><span class="comment">// encryption parameters</span>
<span class="normal">	metadata</span><span class="symbol">.</span><span class="normal">put</span><span class="symbol">&lt;</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="symbol">&gt;(</span><span class="normal">m_subfiles</span><span class="symbol">[</span><span class="normal">si</span><span class="symbol">].</span><span class="normal">encdata</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">());</span>
<span class="normal">	metadata</span><span class="symbol">.</span><span class="function">append</span><span class="symbol">(</span><span class="normal">m_subfiles</span><span class="symbol">[</span><span class="normal">si</span><span class="symbol">].</span><span class="normal">encdata</span><span class="symbol">.</span><span class="function">begin</span><span class="symbol">(),</span><span class="normal"> m_subfiles</span><span class="symbol">[</span><span class="normal">si</span><span class="symbol">].</span><span class="normal">encdata</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">());</span>

<span class="normal">	</span><span class="comment">// variable properties structure</span>
<span class="normal">	metadata</span><span class="symbol">.</span><span class="normal">put</span><span class="symbol">&lt;</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="symbol">&gt;(</span><span class="normal">m_subfiles</span><span class="symbol">[</span><span class="normal">si</span><span class="symbol">].</span><span class="normal">properties</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">());</span>

<span class="normal">	</span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">propertymap_type</span><span class="symbol">::</span><span class="usertype">const_iterator</span><span class="normal"> pi </span><span class="symbol">=</span><span class="normal"> m_subfiles</span><span class="symbol">[</span><span class="normal">si</span><span class="symbol">].</span><span class="normal">properties</span><span class="symbol">.</span><span class="function">begin</span><span class="symbol">();</span>
<span class="normal">	     pi </span><span class="symbol">!=</span><span class="normal"> m_subfiles</span><span class="symbol">[</span><span class="normal">si</span><span class="symbol">].</span><span class="normal">properties</span><span class="symbol">.</span><span class="function">end</span><span class="symbol">();</span><span class="normal"> </span><span class="symbol">++</span><span class="normal">pi</span><span class="symbol">)</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    metadata</span><span class="symbol">.</span><span class="normal">put</span><span class="symbol">&lt;</span><span class="normal">std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&gt;(</span><span class="normal">pi</span><span class="symbol">-&gt;</span><span class="normal">first</span><span class="symbol">);</span>
<span class="normal">	    metadata</span><span class="symbol">.</span><span class="normal">put</span><span class="symbol">&lt;</span><span class="normal">std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&gt;(</span><span class="normal">pi</span><span class="symbol">-&gt;</span><span class="normal">second</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="comment">// Compress encrypted global properties using zlib</span>
<span class="normal">    </span><span class="usertype">ByteBuffer</span><span class="normal"> metadata_compressed</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="usertype">z_stream</span><span class="normal"> zs</span><span class="symbol">;</span>
<span class="normal">	</span><span class="function">memset</span><span class="symbol">(&amp;</span><span class="normal">zs</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="normal">zs</span><span class="symbol">));</span>

<span class="normal">	</span><span class="type">int</span><span class="normal"> ret </span><span class="symbol">=</span><span class="normal"> </span><span class="function">deflateInit</span><span class="symbol">(&amp;</span><span class="normal">zs</span><span class="symbol">,</span><span class="normal"> </span><span class="number">9</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ret </span><span class="symbol">!=</span><span class="normal"> Z_OK</span><span class="symbol">)</span>
<span class="normal">	    </span><span class="keyword">throw</span><span class="symbol">(</span><span class="function">InternalError</span><span class="symbol">(</span><span class="normal"> </span><span class="function">ErrorCodeFromZLibError</span><span class="symbol">(</span><span class="normal">ret</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">));</span>

<span class="normal">	zs</span><span class="symbol">.</span><span class="normal">next_in </span><span class="symbol">=</span><span class="normal"> metadata</span><span class="symbol">.</span><span class="function">data</span><span class="symbol">();</span>
<span class="normal">	zs</span><span class="symbol">.</span><span class="normal">avail_in </span><span class="symbol">=</span><span class="normal"> metadata</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">();</span>

<span class="normal">	</span><span class="type">char</span><span class="normal"> buffer</span><span class="symbol">[</span><span class="number">65536</span><span class="symbol">];</span>

<span class="normal">	</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ret </span><span class="symbol">==</span><span class="normal"> Z_OK</span><span class="symbol">)</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    zs</span><span class="symbol">.</span><span class="normal">next_out </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Bytef</span><span class="symbol">*)</span><span class="normal">buffer</span><span class="symbol">;</span>
<span class="normal">	    zs</span><span class="symbol">.</span><span class="normal">avail_out </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="normal">buffer</span><span class="symbol">);</span>

<span class="normal">	    ret </span><span class="symbol">=</span><span class="normal"> </span><span class="function">deflate</span><span class="symbol">(&amp;</span><span class="normal">zs</span><span class="symbol">,</span><span class="normal"> Z_FINISH</span><span class="symbol">);</span>

<span class="normal">	    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">metadata_compressed</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">&lt;</span><span class="normal"> zs</span><span class="symbol">.</span><span class="normal">total_out</span><span class="symbol">)</span>
<span class="normal">	    </span><span class="cbracket">{</span>
<span class="normal">		metadata_compressed</span><span class="symbol">.</span><span class="function">append</span><span class="symbol">(</span><span class="normal">buffer</span><span class="symbol">,</span>
<span class="normal">					   zs</span><span class="symbol">.</span><span class="normal">total_out </span><span class="symbol">-</span><span class="normal"> metadata_compressed</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">());</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="function">deflateEnd</span><span class="symbol">(&amp;</span><span class="normal">zs</span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ret </span><span class="symbol">!=</span><span class="normal"> Z_STREAM_END</span><span class="symbol">)</span>
<span class="normal">	    </span><span class="keyword">throw</span><span class="symbol">(</span><span class="function">InternalError</span><span class="symbol">(</span><span class="normal"> </span><span class="function">ErrorCodeFromZLibError</span><span class="symbol">(</span><span class="normal">ret</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">));</span>

<span class="normal">	</span><span class="comment">// append zeros to make output length a multiple of 16</span>
<span class="normal">	metadata_compressed</span><span class="symbol">.</span><span class="function">align</span><span class="symbol">(</span><span class="number">16</span><span class="symbol">);</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="comment">// Encrypt fixed header3 and variable metadata</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">Header3</span><span class="normal"> header3</span><span class="symbol">;</span>
<span class="normal">	</span><span class="function">memset</span><span class="symbol">(&amp;</span><span class="normal">header3</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="normal">header3</span><span class="symbol">));</span>

<span class="normal">	header3</span><span class="symbol">.</span><span class="normal">metacomplen </span><span class="symbol">=</span><span class="normal"> metadata_compressed</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">();</span>
<span class="normal">	header3</span><span class="symbol">.</span><span class="normal">metacrc32 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">botan_crc32</span><span class="symbol">(</span><span class="normal">metadata</span><span class="symbol">.</span><span class="function">data</span><span class="symbol">(),</span><span class="normal"> metadata</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">());</span>

<span class="normal">	Botan</span><span class="symbol">::</span><span class="usertype">PKCS5_PBKDF2</span><span class="normal"> </span><span class="function">pbkdf</span><span class="symbol">(</span><span class="string">"SHA-256"</span><span class="symbol">);</span>

<span class="normal">	pbkdf</span><span class="symbol">.</span><span class="function">set_iterations</span><span class="symbol">(</span><span class="normal">m_header2</span><span class="symbol">.</span><span class="normal">mkk_iterations</span><span class="symbol">);</span>
<span class="normal">	pbkdf</span><span class="symbol">.</span><span class="function">change_salt</span><span class="symbol">(</span><span class="normal">m_header2</span><span class="symbol">.</span><span class="normal">mkk_salt</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="normal">m_header2</span><span class="symbol">.</span><span class="normal">mkk_salt</span><span class="symbol">));</span>
<span class="normal">	Botan</span><span class="symbol">::</span><span class="usertype">OctetString</span><span class="normal"> enckey </span><span class="symbol">=</span><span class="normal"> pbkdf</span><span class="symbol">.</span><span class="function">derive_key</span><span class="symbol">(</span><span class="number">32</span><span class="symbol">,</span><span class="normal"> m_masterkey</span><span class="symbol">);</span>

<span class="normal">	pbkdf</span><span class="symbol">.</span><span class="function">set_iterations</span><span class="symbol">(</span><span class="normal">m_header2</span><span class="symbol">.</span><span class="normal">mki_iterations</span><span class="symbol">);</span>
<span class="normal">	pbkdf</span><span class="symbol">.</span><span class="function">change_salt</span><span class="symbol">(</span><span class="normal">m_header2</span><span class="symbol">.</span><span class="normal">mki_salt</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="normal">m_header2</span><span class="symbol">.</span><span class="normal">mki_salt</span><span class="symbol">));</span>
<span class="normal">	Botan</span><span class="symbol">::</span><span class="usertype">OctetString</span><span class="normal"> enciv </span><span class="symbol">=</span><span class="normal"> pbkdf</span><span class="symbol">.</span><span class="function">derive_key</span><span class="symbol">(</span><span class="number">16</span><span class="symbol">,</span><span class="normal"> m_masterkey</span><span class="symbol">);</span>

<span class="normal">	DataSink2DataOutput</span><span class="symbol">*</span><span class="normal"> datasink</span><span class="symbol">;</span>

<span class="normal">	Botan</span><span class="symbol">::</span><span class="usertype">Pipe</span><span class="normal"> </span><span class="function">pipe</span><span class="symbol">(</span>
<span class="normal">	    Botan</span><span class="symbol">::</span><span class="function">get_cipher</span><span class="symbol">(</span><span class="string">"Serpent/CBC/NoPadding"</span><span class="symbol">,</span><span class="normal"> enckey</span><span class="symbol">,</span><span class="normal"> enciv</span><span class="symbol">,</span><span class="normal"> Botan</span><span class="symbol">::</span><span class="normal">ENCRYPTION</span><span class="symbol">),</span>
<span class="normal">	    </span><span class="keyword">new</span><span class="normal"> </span><span class="function">NullBufferingFilter</span><span class="symbol">(</span><span class="number">4096</span><span class="symbol">),</span>
<span class="normal">	    </span><span class="symbol">(</span><span class="normal">datasink </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">new</span><span class="normal"> </span><span class="function">DataSink2DataOutput</span><span class="symbol">(</span><span class="normal">dataout</span><span class="symbol">,</span><span class="normal"> progress</span><span class="symbol">))</span>
<span class="normal">	    </span><span class="symbol">);</span>

<span class="normal">	pipe</span><span class="symbol">.</span><span class="function">process_msg</span><span class="symbol">((</span><span class="normal">Botan</span><span class="symbol">::</span><span class="normal">byte</span><span class="symbol">*)&amp;</span><span class="normal">header3</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="normal">header3</span><span class="symbol">));</span>

<span class="normal">	pipe</span><span class="symbol">.</span><span class="function">process_msg</span><span class="symbol">(</span><span class="normal">metadata_compressed</span><span class="symbol">.</span><span class="function">data</span><span class="symbol">(),</span><span class="normal"> metadata_compressed</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">());</span>

<span class="normal">	m_written </span><span class="symbol">+=</span><span class="normal"> datasink</span><span class="symbol">-&gt;</span><span class="function">get_written</span><span class="symbol">();</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="comment">// Refine file target size because it is now exactly known.</span>
<span class="normal">    esttotal </span><span class="symbol">=</span><span class="normal"> m_written </span><span class="symbol">+</span><span class="normal"> subfiletotal</span><span class="symbol">;</span>
<span class="normal">    progress</span><span class="symbol">.</span><span class="function">Restart</span><span class="symbol">(</span><span class="string">"Saving Container"</span><span class="symbol">,</span><span class="normal"> PI_SAVE_CONTAINER</span><span class="symbol">,</span><span class="normal"> m_written</span><span class="symbol">,</span><span class="normal"> esttotal</span><span class="symbol">);</span>

<span class="normal">    </span><span class="comment">// Output data of all subfiles simply concatenated</span>

<span class="normal">    </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> si </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> si </span><span class="symbol">&lt;</span><span class="normal"> m_subfiles</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">();</span><span class="normal"> </span><span class="symbol">++</span><span class="normal">si</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="function">AssertException</span><span class="symbol">(</span><span class="normal">m_subfiles</span><span class="symbol">[</span><span class="normal">si</span><span class="symbol">].</span><span class="normal">storagesize </span><span class="symbol">==</span><span class="normal"> m_subfiles</span><span class="symbol">[</span><span class="normal">si</span><span class="symbol">].</span><span class="normal">data</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">());</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">dataout</span><span class="symbol">.</span><span class="function">Output</span><span class="symbol">(</span><span class="normal">m_subfiles</span><span class="symbol">[</span><span class="normal">si</span><span class="symbol">].</span><span class="normal">data</span><span class="symbol">.</span><span class="function">begin</span><span class="symbol">(),</span><span class="normal"> m_subfiles</span><span class="symbol">[</span><span class="normal">si</span><span class="symbol">].</span><span class="normal">data</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">()))</span>
<span class="normal">	    </span><span class="keyword">throw</span><span class="symbol">(</span><span class="function">RuntimeError</span><span class="symbol">(</span><span class="normal">ETE_OUTPUT_ERROR</span><span class="symbol">));</span>

<span class="normal">	m_written </span><span class="symbol">+=</span><span class="normal"> m_subfiles</span><span class="symbol">[</span><span class="normal">si</span><span class="symbol">].</span><span class="normal">storagesize</span><span class="symbol">;</span>

<span class="normal">	progress</span><span class="symbol">.</span><span class="function">Update</span><span class="symbol">(</span><span class="normal">m_written</span><span class="symbol">);</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="comment">// Append 4 bytes CRC32 value at end of file</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	Botan</span><span class="symbol">::</span><span class="usertype">SecureVector&lt;Botan::byte&gt;</span><span class="normal"> crc32val </span><span class="symbol">=</span><span class="normal"> crc32all</span><span class="symbol">.</span><span class="function">final</span><span class="symbol">();</span>
<span class="normal">	</span><span class="function">AssertException</span><span class="symbol">(</span><span class="normal">crc32val</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="number">4</span><span class="symbol">);</span>
<span class="normal">    </span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">dataout</span><span class="symbol">.</span><span class="function">Output</span><span class="symbol">(</span><span class="normal">crc32val</span><span class="symbol">.</span><span class="function">begin</span><span class="symbol">(),</span><span class="normal"> crc32val</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">()))</span>
<span class="normal">	    </span><span class="keyword">throw</span><span class="symbol">(</span><span class="function">RuntimeError</span><span class="symbol">(</span><span class="normal">ETE_OUTPUT_ERROR</span><span class="symbol">));</span>

<span class="normal">	m_written </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">4</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    m_modified </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> ContainerImpl</span><span class="symbol">::</span><span class="function">Load</span><span class="symbol">(</span><span class="normal">DataInput</span><span class="symbol">&amp;</span><span class="normal"> datain</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> userkey</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="usertype">ProgressTicker</span><span class="normal"> </span><span class="function">progress</span><span class="symbol">(*</span><span class="keyword">this</span><span class="symbol">,</span>
<span class="normal">			    </span><span class="string">"Loading Container"</span><span class="symbol">,</span><span class="normal"> PI_LOAD_CONTAINER</span><span class="symbol">,</span>
<span class="normal">			    </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="number">10240</span><span class="symbol">);</span>

<span class="normal">    </span><span class="comment">// Read unencrypted fixed Header1</span>
<span class="normal">    </span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">Header1</span><span class="normal"> header1</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">datain</span><span class="symbol">.</span><span class="function">Input</span><span class="symbol">(&amp;</span><span class="normal">header1</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="normal">header1</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="normal">header1</span><span class="symbol">))</span>
<span class="normal">	</span><span class="keyword">throw</span><span class="symbol">(</span><span class="function">RuntimeError</span><span class="symbol">(</span><span class="normal">ETE_LOAD_HEADER1</span><span class="symbol">));</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">memcmp</span><span class="symbol">(</span><span class="normal">header1</span><span class="symbol">.</span><span class="normal">signature</span><span class="symbol">,</span><span class="normal"> m_filesignature</span><span class="symbol">,</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">	</span><span class="keyword">throw</span><span class="symbol">(</span><span class="function">RuntimeError</span><span class="symbol">(</span><span class="normal">ETE_LOAD_HEADER1_SIGNATURE</span><span class="symbol">));</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">header1</span><span class="symbol">.</span><span class="normal">version_major </span><span class="symbol">==</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="function">Loadv1</span><span class="symbol">(</span><span class="normal">datain</span><span class="symbol">,</span><span class="normal"> userkey</span><span class="symbol">,</span><span class="normal"> header1</span><span class="symbol">,</span><span class="normal"> progress</span><span class="symbol">);</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="normal">    </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">throw</span><span class="symbol">(</span><span class="function">RuntimeError</span><span class="symbol">(</span><span class="normal">ETE_LOAD_HEADER1_VERSION</span><span class="symbol">));</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> ContainerImpl</span><span class="symbol">::</span><span class="function">Loadv1</span><span class="symbol">(</span><span class="normal">DataInput</span><span class="symbol">&amp;</span><span class="normal"> datain_</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> userkey</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> Header1</span><span class="symbol">&amp;</span><span class="normal"> header1</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">class</span><span class="normal"> </span><span class="classname">ProgressTicker</span><span class="symbol">&amp;</span><span class="normal"> progress</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">header1</span><span class="symbol">.</span><span class="normal">version_minor </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">throw</span><span class="symbol">(</span><span class="function">RuntimeError</span><span class="symbol">(</span><span class="normal">ETE_LOAD_HEADER1_VERSION</span><span class="symbol">));</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    m_modified </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span><span class="normal"> </span><span class="comment">// set even when loading failed.</span>

<span class="normal">    </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> readbyte </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="normal">Header1</span><span class="symbol">);</span>

<span class="normal">    Botan</span><span class="symbol">::</span><span class="usertype">CRC32</span><span class="normal"> crc32all</span><span class="symbol">;</span>
<span class="normal">    crc32all</span><span class="symbol">.</span><span class="function">update</span><span class="symbol">((</span><span class="normal">Botan</span><span class="symbol">::</span><span class="normal">byte</span><span class="symbol">*)&amp;</span><span class="normal">header1</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="normal">header1</span><span class="symbol">));</span><span class="normal"> </span><span class="comment">// update hash with already read header bytes.</span>

<span class="normal">    </span><span class="usertype">DataInputHashChain</span><span class="normal"> </span><span class="function">datain</span><span class="symbol">(</span><span class="normal">datain_</span><span class="symbol">,</span><span class="normal"> crc32all</span><span class="symbol">);</span>

<span class="normal">    </span><span class="comment">// Read unencrypted metadata length</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="usertype">ByteBuffer</span><span class="normal"> unc_metadata</span><span class="symbol">;</span>
<span class="normal">	unc_metadata</span><span class="symbol">.</span><span class="function">alloc</span><span class="symbol">(</span><span class="normal">header1</span><span class="symbol">.</span><span class="normal">unc_metalen</span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">datain</span><span class="symbol">.</span><span class="function">Input</span><span class="symbol">(</span><span class="normal">unc_metadata</span><span class="symbol">.</span><span class="function">data</span><span class="symbol">(),</span><span class="normal"> header1</span><span class="symbol">.</span><span class="normal">unc_metalen</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> header1</span><span class="symbol">.</span><span class="normal">unc_metalen</span><span class="symbol">)</span>
<span class="normal">	    </span><span class="keyword">throw</span><span class="symbol">(</span><span class="function">RuntimeError</span><span class="symbol">(</span><span class="normal">ETE_LOAD_HEADER1_METADATA</span><span class="symbol">));</span>

<span class="normal">	readbyte </span><span class="symbol">+=</span><span class="normal"> header1</span><span class="symbol">.</span><span class="normal">unc_metalen</span><span class="symbol">;</span>
<span class="normal">	unc_metadata</span><span class="symbol">.</span><span class="function">set_size</span><span class="symbol">(</span><span class="normal">header1</span><span class="symbol">.</span><span class="normal">unc_metalen</span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">try</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="comment">// parse global unencrypted properties</span>
<span class="normal">	    </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> gpropsize </span><span class="symbol">=</span><span class="normal"> unc_metadata</span><span class="symbol">.</span><span class="normal">get</span><span class="symbol">&lt;</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="symbol">&gt;();</span>
<span class="normal">	    m_unc_properties</span><span class="symbol">.</span><span class="function">clear</span><span class="symbol">();</span>

<span class="normal">	    </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> pi </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> pi </span><span class="symbol">&lt;</span><span class="normal"> gpropsize</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">++</span><span class="normal">pi</span><span class="symbol">)</span>
<span class="normal">	    </span><span class="cbracket">{</span>
<span class="normal">		std</span><span class="symbol">::</span><span class="usertype">string</span><span class="normal"> key </span><span class="symbol">=</span><span class="normal"> unc_metadata</span><span class="symbol">.</span><span class="normal">get</span><span class="symbol">&lt;</span><span class="normal">std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&gt;();</span>
<span class="normal">		std</span><span class="symbol">::</span><span class="usertype">string</span><span class="normal"> val </span><span class="symbol">=</span><span class="normal"> unc_metadata</span><span class="symbol">.</span><span class="normal">get</span><span class="symbol">&lt;</span><span class="normal">std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&gt;();</span>

<span class="normal">		m_unc_properties</span><span class="symbol">.</span><span class="function">insert</span><span class="symbol">(</span><span class="normal"> propertymap_type</span><span class="symbol">::</span><span class="function">value_type</span><span class="symbol">(</span><span class="normal">key</span><span class="symbol">,</span><span class="normal"> val</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">);</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">catch</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">std</span><span class="symbol">::</span><span class="normal">underflow_error</span><span class="symbol">&amp;</span><span class="normal"> e</span><span class="symbol">)</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="keyword">throw</span><span class="symbol">(</span><span class="function">RuntimeError</span><span class="symbol">(</span><span class="normal">ETE_LOAD_HEADER1_METADATA_PARSE</span><span class="symbol">));</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    progress</span><span class="symbol">.</span><span class="function">Update</span><span class="symbol">(</span><span class="normal">readbyte</span><span class="symbol">);</span>

<span class="normal">    </span><span class="comment">// Read master key digest and user key slots</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">datain</span><span class="symbol">.</span><span class="function">Input</span><span class="symbol">(&amp;</span><span class="normal">m_header2</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="normal">m_header2</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="normal">m_header2</span><span class="symbol">))</span>
<span class="normal">	    </span><span class="keyword">throw</span><span class="symbol">(</span><span class="function">RuntimeError</span><span class="symbol">(</span><span class="normal">ETE_LOAD_HEADER2</span><span class="symbol">));</span>
<span class="normal">	</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">m_header2</span><span class="symbol">.</span><span class="normal">keyslots </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">	    </span><span class="keyword">throw</span><span class="symbol">(</span><span class="function">RuntimeError</span><span class="symbol">(</span><span class="normal">ETE_LOAD_HEADER2_NO_KEYSLOTS</span><span class="symbol">));</span>

<span class="normal">        m_keyslots</span><span class="symbol">.</span><span class="function">clear</span><span class="symbol">();</span>

<span class="normal">	</span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> m_header2</span><span class="symbol">.</span><span class="normal">keyslots</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">++</span><span class="normal">i</span><span class="symbol">)</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    m_keyslots</span><span class="symbol">.</span><span class="function">push_back</span><span class="symbol">(</span><span class="function">KeySlot</span><span class="symbol">());</span>
<span class="normal">	    KeySlot</span><span class="symbol">&amp;</span><span class="normal"> newkeyslot </span><span class="symbol">=</span><span class="normal"> m_keyslots</span><span class="symbol">.</span><span class="function">back</span><span class="symbol">();</span>

<span class="normal">	    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">datain</span><span class="symbol">.</span><span class="function">Input</span><span class="symbol">(&amp;</span><span class="normal">newkeyslot</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="normal">newkeyslot</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="normal">newkeyslot</span><span class="symbol">))</span>
<span class="normal">		</span><span class="keyword">throw</span><span class="symbol">(</span><span class="function">RuntimeError</span><span class="symbol">(</span><span class="normal">ETE_LOAD_HEADER2_KEYSLOTS</span><span class="symbol">));</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	readbyte </span><span class="symbol">+=</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="normal">m_header2</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> m_header2</span><span class="symbol">.</span><span class="normal">keyslots </span><span class="symbol">*</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="normal">KeySlot</span><span class="symbol">);</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    progress</span><span class="symbol">.</span><span class="function">Update</span><span class="symbol">(</span><span class="normal">readbyte</span><span class="symbol">);</span>

<span class="normal">    </span><span class="comment">// Try to retrieve master key by checking all user key slots</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	Botan</span><span class="symbol">::</span><span class="usertype">SecureVector&lt;Botan::byte&gt;</span><span class="normal"> </span><span class="function">userkeyvector</span><span class="symbol">((</span><span class="normal">Botan</span><span class="symbol">::</span><span class="normal">byte</span><span class="symbol">*)</span><span class="normal">userkey</span><span class="symbol">.</span><span class="function">data</span><span class="symbol">(),</span><span class="normal"> userkey</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">());</span>
<span class="normal">	</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> ks</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ks </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> ks </span><span class="symbol">&lt;</span><span class="normal"> m_header2</span><span class="symbol">.</span><span class="normal">keyslots</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">++</span><span class="normal">ks</span><span class="symbol">)</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    KeySlot</span><span class="symbol">&amp;</span><span class="normal"> keyslot </span><span class="symbol">=</span><span class="normal"> m_keyslots</span><span class="symbol">[</span><span class="normal">ks</span><span class="symbol">];</span>

<span class="normal">	    </span><span class="comment">// calculate user encryption key from password</span>

<span class="normal">	    Botan</span><span class="symbol">::</span><span class="usertype">PKCS5_PBKDF2</span><span class="normal"> </span><span class="function">pbkdf</span><span class="symbol">(</span><span class="string">"SHA-256"</span><span class="symbol">);</span>

<span class="normal">	    pbkdf</span><span class="symbol">.</span><span class="function">set_iterations</span><span class="symbol">(</span><span class="normal">keyslot</span><span class="symbol">.</span><span class="normal">iterations</span><span class="symbol">);</span>
<span class="normal">	    pbkdf</span><span class="symbol">.</span><span class="function">change_salt</span><span class="symbol">(</span><span class="normal">keyslot</span><span class="symbol">.</span><span class="normal">salt</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="normal">keyslot</span><span class="symbol">.</span><span class="normal">salt</span><span class="symbol">));</span>
<span class="normal">	    Botan</span><span class="symbol">::</span><span class="usertype">OctetString</span><span class="normal"> enckey </span><span class="symbol">=</span><span class="normal"> pbkdf</span><span class="symbol">.</span><span class="function">derive_key</span><span class="symbol">(</span><span class="number">32</span><span class="symbol">,</span><span class="normal"> userkeyvector</span><span class="symbol">);</span>

<span class="normal">	    </span><span class="comment">// decrypt master key copy</span>

<span class="normal">	    Botan</span><span class="symbol">::</span><span class="usertype">Pipe</span><span class="normal"> </span><span class="function">pipe</span><span class="symbol">(</span><span class="normal"> Botan</span><span class="symbol">::</span><span class="function">get_cipher</span><span class="symbol">(</span><span class="string">"Serpent/ECB/NoPadding"</span><span class="symbol">,</span><span class="normal"> enckey</span><span class="symbol">,</span><span class="normal"> Botan</span><span class="symbol">::</span><span class="normal">DECRYPTION</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">);</span>

<span class="normal">	    pipe</span><span class="symbol">.</span><span class="function">process_msg</span><span class="symbol">((</span><span class="normal">Botan</span><span class="symbol">::</span><span class="normal">byte</span><span class="symbol">*)</span><span class="normal">keyslot</span><span class="symbol">.</span><span class="normal">emasterkey</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="normal">keyslot</span><span class="symbol">.</span><span class="normal">emasterkey</span><span class="symbol">));</span>

<span class="normal">	    Botan</span><span class="symbol">::</span><span class="usertype">SecureVector&lt;Botan::byte&gt;</span><span class="normal"> testmasterkey </span><span class="symbol">=</span><span class="normal"> pipe</span><span class="symbol">.</span><span class="function">read_all</span><span class="symbol">();</span>
<span class="normal">	    </span><span class="function">AssertException</span><span class="symbol">(</span><span class="normal">testmasterkey</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> m_masterkey</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">());</span>

<span class="normal">	    </span><span class="comment">// digest master key and compare to stored digest</span>

<span class="normal">	    pbkdf</span><span class="symbol">.</span><span class="function">set_iterations</span><span class="symbol">(</span><span class="normal">m_header2</span><span class="symbol">.</span><span class="normal">mkd_iterations</span><span class="symbol">);</span>
<span class="normal">	    pbkdf</span><span class="symbol">.</span><span class="function">change_salt</span><span class="symbol">(</span><span class="normal">m_header2</span><span class="symbol">.</span><span class="normal">mkd_salt</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="normal">m_header2</span><span class="symbol">.</span><span class="normal">mkd_salt</span><span class="symbol">));</span>
<span class="normal">	    Botan</span><span class="symbol">::</span><span class="usertype">OctetString</span><span class="normal"> digest </span><span class="symbol">=</span><span class="normal"> pbkdf</span><span class="symbol">.</span><span class="function">derive_key</span><span class="symbol">(</span><span class="number">32</span><span class="symbol">,</span><span class="normal"> testmasterkey</span><span class="symbol">);</span>

<span class="normal">	    </span><span class="function">AssertException</span><span class="symbol">(</span><span class="normal">digest</span><span class="symbol">.</span><span class="function">length</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="normal">m_header2</span><span class="symbol">.</span><span class="normal">mkd_digest</span><span class="symbol">));</span>

<span class="normal">	    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Botan</span><span class="symbol">::</span><span class="function">same_mem</span><span class="symbol">(</span><span class="normal">digest</span><span class="symbol">.</span><span class="function">begin</span><span class="symbol">(),</span><span class="normal"> m_header2</span><span class="symbol">.</span><span class="normal">mkd_digest</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="normal">m_header2</span><span class="symbol">.</span><span class="normal">mkd_digest</span><span class="symbol">)))</span>
<span class="normal">	    </span><span class="cbracket">{</span>
<span class="normal">		m_usedkeyslot </span><span class="symbol">=</span><span class="normal"> ks</span><span class="symbol">;</span>
<span class="normal">		m_masterkey</span><span class="symbol">.</span><span class="function">set</span><span class="symbol">(</span><span class="normal">testmasterkey</span><span class="symbol">.</span><span class="function">begin</span><span class="symbol">(),</span><span class="normal"> testmasterkey</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">());</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="comment">// User supplied key does not match any slot.</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ks </span><span class="symbol">&gt;=</span><span class="normal"> m_header2</span><span class="symbol">.</span><span class="normal">keyslots</span><span class="symbol">)</span>
<span class="normal">	    </span><span class="keyword">throw</span><span class="symbol">(</span><span class="function">RuntimeError</span><span class="symbol">(</span><span class="normal">ETE_LOAD_HEADER2_INVALID_KEY</span><span class="symbol">));</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="comment">// Read encrypted fixed Header3</span>
<span class="normal">    </span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">Header3</span><span class="normal"> header3</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">datain</span><span class="symbol">.</span><span class="function">Input</span><span class="symbol">(&amp;</span><span class="normal">header3</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="normal">header3</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="normal">header3</span><span class="symbol">))</span>
<span class="normal">	</span><span class="keyword">throw</span><span class="symbol">(</span><span class="function">RuntimeError</span><span class="symbol">(</span><span class="normal">ETE_LOAD_HEADER3</span><span class="symbol">));</span>

<span class="normal">    readbyte </span><span class="symbol">+=</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="normal">header3</span><span class="symbol">);</span>

<span class="normal">    </span><span class="comment">// Attempt to decrypt Header3</span>

<span class="normal">    Botan</span><span class="symbol">::</span><span class="usertype">PKCS5_PBKDF2</span><span class="normal"> </span><span class="function">pbkdf</span><span class="symbol">(</span><span class="string">"SHA-256"</span><span class="symbol">);</span>

<span class="normal">    pbkdf</span><span class="symbol">.</span><span class="function">set_iterations</span><span class="symbol">(</span><span class="normal">m_header2</span><span class="symbol">.</span><span class="normal">mkk_iterations</span><span class="symbol">);</span>
<span class="normal">    pbkdf</span><span class="symbol">.</span><span class="function">change_salt</span><span class="symbol">(</span><span class="normal">m_header2</span><span class="symbol">.</span><span class="normal">mkk_salt</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="normal">m_header2</span><span class="symbol">.</span><span class="normal">mkk_salt</span><span class="symbol">));</span>
<span class="normal">    Botan</span><span class="symbol">::</span><span class="usertype">OctetString</span><span class="normal"> enckey </span><span class="symbol">=</span><span class="normal"> pbkdf</span><span class="symbol">.</span><span class="function">derive_key</span><span class="symbol">(</span><span class="number">32</span><span class="symbol">,</span><span class="normal"> m_masterkey</span><span class="symbol">);</span>

<span class="normal">    pbkdf</span><span class="symbol">.</span><span class="function">set_iterations</span><span class="symbol">(</span><span class="normal">m_header2</span><span class="symbol">.</span><span class="normal">mki_iterations</span><span class="symbol">);</span>
<span class="normal">    pbkdf</span><span class="symbol">.</span><span class="function">change_salt</span><span class="symbol">(</span><span class="normal">m_header2</span><span class="symbol">.</span><span class="normal">mki_salt</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="normal">m_header2</span><span class="symbol">.</span><span class="normal">mki_salt</span><span class="symbol">));</span>
<span class="normal">    Botan</span><span class="symbol">::</span><span class="usertype">OctetString</span><span class="normal"> enciv </span><span class="symbol">=</span><span class="normal"> pbkdf</span><span class="symbol">.</span><span class="function">derive_key</span><span class="symbol">(</span><span class="number">16</span><span class="symbol">,</span><span class="normal"> m_masterkey</span><span class="symbol">);</span>

<span class="normal">    Botan</span><span class="symbol">::</span><span class="usertype">Pipe</span><span class="normal"> </span><span class="function">pipe</span><span class="symbol">(</span><span class="normal"> Botan</span><span class="symbol">::</span><span class="function">get_cipher</span><span class="symbol">(</span><span class="string">"Serpent/CBC/NoPadding"</span><span class="symbol">,</span><span class="normal"> enckey</span><span class="symbol">,</span><span class="normal"> enciv</span><span class="symbol">,</span><span class="normal"> Botan</span><span class="symbol">::</span><span class="normal">DECRYPTION</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">);</span>

<span class="normal">    pipe</span><span class="symbol">.</span><span class="function">process_msg</span><span class="symbol">((</span><span class="normal">Botan</span><span class="symbol">::</span><span class="normal">byte</span><span class="symbol">*)&amp;</span><span class="normal">header3</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="normal">header3</span><span class="symbol">));</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pipe</span><span class="symbol">.</span><span class="function">read</span><span class="symbol">((</span><span class="normal">Botan</span><span class="symbol">::</span><span class="normal">byte</span><span class="symbol">*)&amp;</span><span class="normal">header3</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="normal">header3</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="normal">header3</span><span class="symbol">))</span>
<span class="normal">	</span><span class="keyword">throw</span><span class="symbol">(</span><span class="function">RuntimeError</span><span class="symbol">(</span><span class="normal">ETE_LOAD_HEADER3_ENCRYPTION</span><span class="symbol">));</span>

<span class="normal">    </span><span class="comment">// Read compressed variable length metadata</span>

<span class="normal">    </span><span class="usertype">ByteBuffer</span><span class="normal"> metadata_compressed</span><span class="symbol">;</span>
<span class="normal">    metadata_compressed</span><span class="symbol">.</span><span class="function">alloc</span><span class="symbol">(</span><span class="normal">header3</span><span class="symbol">.</span><span class="normal">metacomplen</span><span class="symbol">);</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">datain</span><span class="symbol">.</span><span class="function">Input</span><span class="symbol">(</span><span class="normal">metadata_compressed</span><span class="symbol">.</span><span class="function">data</span><span class="symbol">(),</span><span class="normal"> header3</span><span class="symbol">.</span><span class="normal">metacomplen</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> header3</span><span class="symbol">.</span><span class="normal">metacomplen</span><span class="symbol">)</span>
<span class="normal">	</span><span class="keyword">throw</span><span class="symbol">(</span><span class="function">RuntimeError</span><span class="symbol">(</span><span class="normal">ETE_LOAD_HEADER3_METADATA</span><span class="symbol">));</span>

<span class="normal">    readbyte </span><span class="symbol">+=</span><span class="normal"> header3</span><span class="symbol">.</span><span class="normal">metacomplen</span><span class="symbol">;</span>
<span class="normal">    metadata_compressed</span><span class="symbol">.</span><span class="function">set_size</span><span class="symbol">(</span><span class="normal">header3</span><span class="symbol">.</span><span class="normal">metacomplen</span><span class="symbol">);</span>

<span class="normal">    pipe</span><span class="symbol">.</span><span class="function">process_msg</span><span class="symbol">(</span><span class="normal">metadata_compressed</span><span class="symbol">.</span><span class="function">data</span><span class="symbol">(),</span><span class="normal"> metadata_compressed</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">());</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pipe</span><span class="symbol">.</span><span class="function">read</span><span class="symbol">(</span><span class="normal">metadata_compressed</span><span class="symbol">.</span><span class="function">data</span><span class="symbol">(),</span><span class="normal"> metadata_compressed</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">(),</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> metadata_compressed</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">())</span>
<span class="normal">	</span><span class="keyword">throw</span><span class="symbol">(</span><span class="function">RuntimeError</span><span class="symbol">(</span><span class="normal">ETE_LOAD_HEADER3_ENCRYPTION</span><span class="symbol">));</span>

<span class="normal">    progress</span><span class="symbol">.</span><span class="function">Restart</span><span class="symbol">(</span><span class="string">"Loading Container"</span><span class="symbol">,</span><span class="normal"> PI_LOAD_CONTAINER</span><span class="symbol">,</span>
<span class="normal">		     readbyte</span><span class="symbol">,</span><span class="normal"> readbyte </span><span class="symbol">*</span><span class="normal"> </span><span class="number">10</span><span class="symbol">);</span>

<span class="normal">    </span><span class="comment">// Decompress variable encrypted metadata</span>

<span class="normal">    </span><span class="usertype">ByteBuffer</span><span class="normal"> metadata</span><span class="symbol">;</span>

<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="usertype">z_stream</span><span class="normal"> zs</span><span class="symbol">;</span>
<span class="normal">	</span><span class="function">memset</span><span class="symbol">(&amp;</span><span class="normal">zs</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="normal">zs</span><span class="symbol">));</span>

<span class="normal">	</span><span class="type">int</span><span class="normal"> ret </span><span class="symbol">=</span><span class="normal"> </span><span class="function">inflateInit</span><span class="symbol">(&amp;</span><span class="normal">zs</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ret </span><span class="symbol">!=</span><span class="normal"> Z_OK</span><span class="symbol">)</span>
<span class="normal">	    </span><span class="keyword">throw</span><span class="symbol">(</span><span class="function">RuntimeError</span><span class="symbol">(</span><span class="normal"> </span><span class="function">ErrorCodeFromZLibError</span><span class="symbol">(</span><span class="normal">ret</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">));</span>

<span class="normal">	zs</span><span class="symbol">.</span><span class="normal">next_in </span><span class="symbol">=</span><span class="normal"> metadata_compressed</span><span class="symbol">.</span><span class="function">data</span><span class="symbol">();</span>
<span class="normal">	zs</span><span class="symbol">.</span><span class="normal">avail_in </span><span class="symbol">=</span><span class="normal"> metadata_compressed</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">();</span>

<span class="normal">	</span><span class="type">char</span><span class="normal"> buffer</span><span class="symbol">[</span><span class="number">65536</span><span class="symbol">];</span>

<span class="normal">	</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ret </span><span class="symbol">==</span><span class="normal"> Z_OK</span><span class="symbol">)</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    zs</span><span class="symbol">.</span><span class="normal">next_out </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">Bytef</span><span class="symbol">*)</span><span class="normal">buffer</span><span class="symbol">;</span>
<span class="normal">	    zs</span><span class="symbol">.</span><span class="normal">avail_out </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="normal">buffer</span><span class="symbol">);</span>

<span class="normal">	    ret </span><span class="symbol">=</span><span class="normal"> </span><span class="function">inflate</span><span class="symbol">(&amp;</span><span class="normal">zs</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">);</span>

<span class="normal">	    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">metadata</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">&lt;</span><span class="normal"> zs</span><span class="symbol">.</span><span class="normal">total_out</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		metadata</span><span class="symbol">.</span><span class="function">append</span><span class="symbol">(</span><span class="normal">buffer</span><span class="symbol">,</span><span class="normal"> zs</span><span class="symbol">.</span><span class="normal">total_out </span><span class="symbol">-</span><span class="normal"> metadata</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">());</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ret </span><span class="symbol">!=</span><span class="normal"> Z_STREAM_END</span><span class="symbol">)</span>
<span class="normal">	    </span><span class="keyword">throw</span><span class="symbol">(</span><span class="function">RuntimeError</span><span class="symbol">(</span><span class="normal"> </span><span class="function">ErrorCodeFromZLibError</span><span class="symbol">(</span><span class="normal">ret</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">));</span>

<span class="normal">	</span><span class="function">inflateEnd</span><span class="symbol">(&amp;</span><span class="normal">zs</span><span class="symbol">);</span>

<span class="normal">	</span><span class="usertype">uint32_t</span><span class="normal"> testcrc32 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">botan_crc32</span><span class="symbol">(</span><span class="normal">metadata</span><span class="symbol">.</span><span class="function">data</span><span class="symbol">(),</span><span class="normal"> metadata</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">());</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">testcrc32 </span><span class="symbol">!=</span><span class="normal"> header3</span><span class="symbol">.</span><span class="normal">metacrc32</span><span class="symbol">)</span>
<span class="normal">	    </span><span class="keyword">throw</span><span class="symbol">(</span><span class="function">RuntimeError</span><span class="symbol">(</span><span class="normal">ETE_LOAD_HEADER3_METADATA_CHECKSUM</span><span class="symbol">));</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="keyword">try</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="comment">// parse global encrypted properties</span>
<span class="normal">	</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> gpropsize </span><span class="symbol">=</span><span class="normal"> metadata</span><span class="symbol">.</span><span class="normal">get</span><span class="symbol">&lt;</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="symbol">&gt;();</span>
<span class="normal">	m_enc_properties</span><span class="symbol">.</span><span class="function">clear</span><span class="symbol">();</span>

<span class="normal">	</span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> pi </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> pi </span><span class="symbol">&lt;</span><span class="normal"> gpropsize</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">++</span><span class="normal">pi</span><span class="symbol">)</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    std</span><span class="symbol">::</span><span class="usertype">string</span><span class="normal"> key </span><span class="symbol">=</span><span class="normal"> metadata</span><span class="symbol">.</span><span class="normal">get</span><span class="symbol">&lt;</span><span class="normal">std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&gt;();</span>
<span class="normal">	    std</span><span class="symbol">::</span><span class="usertype">string</span><span class="normal"> val </span><span class="symbol">=</span><span class="normal"> metadata</span><span class="symbol">.</span><span class="normal">get</span><span class="symbol">&lt;</span><span class="normal">std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&gt;();</span>

<span class="normal">	    m_enc_properties</span><span class="symbol">.</span><span class="function">insert</span><span class="symbol">(</span><span class="normal"> propertymap_type</span><span class="symbol">::</span><span class="function">value_type</span><span class="symbol">(</span><span class="normal">key</span><span class="symbol">,</span><span class="normal"> val</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="comment">// parse subfile metadata</span>
<span class="normal">	</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> subfilenum </span><span class="symbol">=</span><span class="normal"> metadata</span><span class="symbol">.</span><span class="normal">get</span><span class="symbol">&lt;</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="symbol">&gt;();</span>
<span class="normal">	m_subfiles</span><span class="symbol">.</span><span class="function">clear</span><span class="symbol">();</span>

<span class="normal">	</span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> si </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> si </span><span class="symbol">&lt;</span><span class="normal"> subfilenum</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">++</span><span class="normal">si</span><span class="symbol">)</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    m_subfiles</span><span class="symbol">.</span><span class="function">push_back</span><span class="symbol">(</span><span class="function">SubFile</span><span class="symbol">());</span>
<span class="normal">	    SubFile</span><span class="symbol">&amp;</span><span class="normal"> subfile </span><span class="symbol">=</span><span class="normal"> m_subfiles</span><span class="symbol">.</span><span class="function">back</span><span class="symbol">();</span>

<span class="normal">	    </span><span class="comment">// fixed structure</span>
<span class="normal">	    subfile</span><span class="symbol">.</span><span class="normal">storagesize </span><span class="symbol">=</span><span class="normal"> metadata</span><span class="symbol">.</span><span class="normal">get</span><span class="symbol">&lt;</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="symbol">&gt;();</span>
<span class="normal">	    subfile</span><span class="symbol">.</span><span class="normal">realsize </span><span class="symbol">=</span><span class="normal"> metadata</span><span class="symbol">.</span><span class="normal">get</span><span class="symbol">&lt;</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="symbol">&gt;();</span>
<span class="normal">	    subfile</span><span class="symbol">.</span><span class="normal">flags </span><span class="symbol">=</span><span class="normal"> metadata</span><span class="symbol">.</span><span class="normal">get</span><span class="symbol">&lt;</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="symbol">&gt;();</span>
<span class="normal">	    subfile</span><span class="symbol">.</span><span class="normal">crc32 </span><span class="symbol">=</span><span class="normal"> metadata</span><span class="symbol">.</span><span class="normal">get</span><span class="symbol">&lt;</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="symbol">&gt;();</span>

<span class="normal">	    </span><span class="comment">// encryption parameter data</span>
<span class="normal">	    </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> encdatalen </span><span class="symbol">=</span><span class="normal"> metadata</span><span class="symbol">.</span><span class="normal">get</span><span class="symbol">&lt;</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="symbol">&gt;();</span>
<span class="normal">	    subfile</span><span class="symbol">.</span><span class="normal">encdata</span><span class="symbol">.</span><span class="function">create</span><span class="symbol">(</span><span class="normal">encdatalen</span><span class="symbol">);</span>

<span class="normal">	    metadata</span><span class="symbol">.</span><span class="function">get</span><span class="symbol">(</span><span class="normal">subfile</span><span class="symbol">.</span><span class="normal">encdata</span><span class="symbol">.</span><span class="function">begin</span><span class="symbol">(),</span><span class="normal"> encdatalen</span><span class="symbol">);</span>

<span class="normal">	    </span><span class="comment">// variable properties structure</span>
<span class="normal">	    </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> fpropsize </span><span class="symbol">=</span><span class="normal"> metadata</span><span class="symbol">.</span><span class="normal">get</span><span class="symbol">&lt;</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="symbol">&gt;();</span>

<span class="normal">	    </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> pi </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> pi </span><span class="symbol">&lt;</span><span class="normal"> fpropsize</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">++</span><span class="normal">pi</span><span class="symbol">)</span>
<span class="normal">	    </span><span class="cbracket">{</span>
<span class="normal">		std</span><span class="symbol">::</span><span class="usertype">string</span><span class="normal"> key </span><span class="symbol">=</span><span class="normal"> metadata</span><span class="symbol">.</span><span class="normal">get</span><span class="symbol">&lt;</span><span class="normal">std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&gt;();</span>
<span class="normal">		std</span><span class="symbol">::</span><span class="usertype">string</span><span class="normal"> val </span><span class="symbol">=</span><span class="normal"> metadata</span><span class="symbol">.</span><span class="normal">get</span><span class="symbol">&lt;</span><span class="normal">std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&gt;();</span>

<span class="normal">		subfile</span><span class="symbol">.</span><span class="normal">properties</span><span class="symbol">.</span><span class="function">insert</span><span class="symbol">(</span><span class="normal"> propertymap_type</span><span class="symbol">::</span><span class="function">value_type</span><span class="symbol">(</span><span class="normal">key</span><span class="symbol">,</span><span class="normal"> val</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">);</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="normal">    </span><span class="keyword">catch</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">std</span><span class="symbol">::</span><span class="normal">underflow_error</span><span class="symbol">&amp;</span><span class="normal"> e</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">throw</span><span class="symbol">(</span><span class="function">InternalError</span><span class="symbol">(</span><span class="normal">ETE_LOAD_HEADER3_METADATA_PARSE</span><span class="symbol">));</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="comment">// Now we can say how large the file actually is.</span>

<span class="normal">    </span><span class="usertype">size_t</span><span class="normal"> subfiletotal </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> si </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> si </span><span class="symbol">&lt;</span><span class="normal"> m_subfiles</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">();</span><span class="normal"> </span><span class="symbol">++</span><span class="normal">si</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	subfiletotal </span><span class="symbol">+=</span><span class="normal"> m_subfiles</span><span class="symbol">[</span><span class="normal">si</span><span class="symbol">].</span><span class="normal">storagesize</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    progress</span><span class="symbol">.</span><span class="function">Restart</span><span class="symbol">(</span><span class="string">"Loading Container"</span><span class="symbol">,</span><span class="normal"> PI_LOAD_CONTAINER</span><span class="symbol">,</span>
<span class="normal">		     readbyte</span><span class="symbol">,</span><span class="normal"> readbyte </span><span class="symbol">+</span><span class="normal"> subfiletotal</span><span class="symbol">);</span>

<span class="normal">    </span><span class="comment">// load data of all subfiles which are simply concatenated</span>

<span class="normal">    </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> si </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> si </span><span class="symbol">&lt;</span><span class="normal"> m_subfiles</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">();</span><span class="normal"> </span><span class="symbol">++</span><span class="normal">si</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	SubFile</span><span class="symbol">&amp;</span><span class="normal"> subfile </span><span class="symbol">=</span><span class="normal"> m_subfiles</span><span class="symbol">[</span><span class="normal">si</span><span class="symbol">];</span>

<span class="normal">	subfile</span><span class="symbol">.</span><span class="normal">data</span><span class="symbol">.</span><span class="function">create</span><span class="symbol">(</span><span class="normal"> subfile</span><span class="symbol">.</span><span class="normal">storagesize </span><span class="symbol">);</span>
<span class="normal">	</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> rb </span><span class="symbol">=</span><span class="normal"> datain</span><span class="symbol">.</span><span class="function">Input</span><span class="symbol">(</span><span class="normal">subfile</span><span class="symbol">.</span><span class="normal">data</span><span class="symbol">.</span><span class="function">begin</span><span class="symbol">(),</span><span class="normal"> subfile</span><span class="symbol">.</span><span class="normal">storagesize</span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">rb </span><span class="symbol">!=</span><span class="normal"> subfile</span><span class="symbol">.</span><span class="normal">storagesize</span><span class="symbol">)</span>
<span class="normal">	    </span><span class="keyword">throw</span><span class="symbol">(</span><span class="function">RuntimeError</span><span class="symbol">(</span><span class="normal">ETE_LOAD_SUBFILE</span><span class="symbol">));</span>

<span class="normal">	readbyte </span><span class="symbol">+=</span><span class="normal"> rb</span><span class="symbol">;</span>
<span class="normal">	progress</span><span class="symbol">.</span><span class="function">Update</span><span class="symbol">(</span><span class="normal">readbyte</span><span class="symbol">);</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="comment">// check overall CRC32 value at end</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	Botan</span><span class="symbol">::</span><span class="usertype">SecureVector&lt;Botan::byte&gt;</span><span class="normal"> crc32val </span><span class="symbol">=</span><span class="normal"> crc32all</span><span class="symbol">.</span><span class="function">final</span><span class="symbol">();</span>
<span class="normal">	</span><span class="function">AssertException</span><span class="symbol">(</span><span class="normal">crc32val</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="number">4</span><span class="symbol">);</span>

<span class="normal">	</span><span class="usertype">uint32_t</span><span class="normal"> crc32file</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">datain</span><span class="symbol">.</span><span class="function">Input</span><span class="symbol">(&amp;</span><span class="normal">crc32file</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="normal">crc32file</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="normal">crc32file</span><span class="symbol">))</span>
<span class="normal">	    </span><span class="keyword">throw</span><span class="symbol">(</span><span class="function">RuntimeError</span><span class="symbol">(</span><span class="normal">ETE_LOAD_CHECKSUM</span><span class="symbol">));</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">crc32file </span><span class="symbol">!=</span><span class="normal"> </span><span class="symbol">*(</span><span class="normal">uint32_t</span><span class="symbol">*)</span><span class="normal">crc32val</span><span class="symbol">.</span><span class="function">begin</span><span class="symbol">())</span>
<span class="normal">	    </span><span class="keyword">throw</span><span class="symbol">(</span><span class="function">RuntimeError</span><span class="symbol">(</span><span class="normal">ETE_LOAD_CHECKSUM</span><span class="symbol">));</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    m_modified </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="comment">// *** Container Info Operations ***</span>

<span class="type">bool</span><span class="normal"> ContainerImpl</span><span class="symbol">::</span><span class="function">GetModified</span><span class="symbol">()</span><span class="normal"> </span><span class="keyword">const</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> m_modified</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="usertype">size_t</span><span class="normal"> ContainerImpl</span><span class="symbol">::</span><span class="function">GetLastWritten</span><span class="symbol">()</span><span class="normal"> </span><span class="keyword">const</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> m_written</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> ContainerImpl</span><span class="symbol">::</span><span class="function">SetProgressIndicator</span><span class="symbol">(</span><span class="normal">ProgressIndicator</span><span class="symbol">*</span><span class="normal"> pi</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    m_progressindicator </span><span class="symbol">=</span><span class="normal"> pi</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="comment">// *** Container User KeySlots Operations ***</span>

<span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> ContainerImpl</span><span class="symbol">::</span><span class="function">CountKeySlots</span><span class="symbol">()</span><span class="normal"> </span><span class="keyword">const</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> m_keyslots</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">();</span>
<span class="cbracket">}</span>

<span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> ContainerImpl</span><span class="symbol">::</span><span class="function">AddKeySlot</span><span class="symbol">(</span><span class="keyword">const</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> key</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">m_keyslots</span><span class="symbol">.</span><span class="function">empty</span><span class="symbol">())</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="comment">// Generate new master key and salt/iter for digest, enckey and enciv.</span>

<span class="normal">	Botan</span><span class="symbol">::</span><span class="normal">Global_RNG</span><span class="symbol">::</span><span class="function">randomize</span><span class="symbol">(</span><span class="normal">m_masterkey</span><span class="symbol">.</span><span class="function">begin</span><span class="symbol">(),</span><span class="normal"> m_masterkey</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">());</span>

<span class="normal">	m_header2</span><span class="symbol">.</span><span class="normal">mkd_iterations </span><span class="symbol">=</span><span class="normal"> </span><span class="function">random_iterations</span><span class="symbol">();</span>
<span class="normal">	Botan</span><span class="symbol">::</span><span class="normal">Global_RNG</span><span class="symbol">::</span><span class="function">randomize</span><span class="symbol">(</span><span class="normal">m_header2</span><span class="symbol">.</span><span class="normal">mkd_salt</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="normal">m_header2</span><span class="symbol">.</span><span class="normal">mkd_salt</span><span class="symbol">));</span>

<span class="normal">	m_header2</span><span class="symbol">.</span><span class="normal">mkk_iterations </span><span class="symbol">=</span><span class="normal"> </span><span class="function">random_iterations</span><span class="symbol">();</span>
<span class="normal">	Botan</span><span class="symbol">::</span><span class="normal">Global_RNG</span><span class="symbol">::</span><span class="function">randomize</span><span class="symbol">(</span><span class="normal">m_header2</span><span class="symbol">.</span><span class="normal">mkk_salt</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="normal">m_header2</span><span class="symbol">.</span><span class="normal">mkk_salt</span><span class="symbol">));</span>

<span class="normal">	m_header2</span><span class="symbol">.</span><span class="normal">mki_iterations </span><span class="symbol">=</span><span class="normal"> </span><span class="function">random_iterations</span><span class="symbol">();</span>
<span class="normal">	Botan</span><span class="symbol">::</span><span class="normal">Global_RNG</span><span class="symbol">::</span><span class="function">randomize</span><span class="symbol">(</span><span class="normal">m_header2</span><span class="symbol">.</span><span class="normal">mki_salt</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="normal">m_header2</span><span class="symbol">.</span><span class="normal">mki_salt</span><span class="symbol">));</span>

<span class="normal">	</span><span class="comment">// Calculate master key digest</span>

<span class="normal">	Botan</span><span class="symbol">::</span><span class="usertype">PKCS5_PBKDF2</span><span class="normal"> </span><span class="function">pbkdf</span><span class="symbol">(</span><span class="string">"SHA-256"</span><span class="symbol">);</span>

<span class="normal">	pbkdf</span><span class="symbol">.</span><span class="function">set_iterations</span><span class="symbol">(</span><span class="normal">m_header2</span><span class="symbol">.</span><span class="normal">mkd_iterations</span><span class="symbol">);</span>
<span class="normal">	pbkdf</span><span class="symbol">.</span><span class="function">change_salt</span><span class="symbol">(</span><span class="normal">m_header2</span><span class="symbol">.</span><span class="normal">mkd_salt</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="normal">m_header2</span><span class="symbol">.</span><span class="normal">mkd_salt</span><span class="symbol">));</span>
<span class="normal">	Botan</span><span class="symbol">::</span><span class="usertype">OctetString</span><span class="normal"> digest </span><span class="symbol">=</span><span class="normal"> pbkdf</span><span class="symbol">.</span><span class="function">derive_key</span><span class="symbol">(</span><span class="number">32</span><span class="symbol">,</span><span class="normal"> m_masterkey</span><span class="symbol">);</span>

<span class="normal">	</span><span class="function">memcpy</span><span class="symbol">(</span><span class="normal">m_header2</span><span class="symbol">.</span><span class="normal">mkd_digest</span><span class="symbol">,</span><span class="normal"> digest</span><span class="symbol">.</span><span class="function">begin</span><span class="symbol">(),</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="normal">m_header2</span><span class="symbol">.</span><span class="normal">mkd_digest</span><span class="symbol">));</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="comment">// Create cipher key from new random salt and iterations.</span>

<span class="normal">    </span><span class="usertype">KeySlot</span><span class="normal"> newslot</span><span class="symbol">;</span>

<span class="normal">    Botan</span><span class="symbol">::</span><span class="usertype">PKCS5_PBKDF2</span><span class="normal"> </span><span class="function">pbkdf</span><span class="symbol">(</span><span class="string">"SHA-256"</span><span class="symbol">);</span>

<span class="normal">    newslot</span><span class="symbol">.</span><span class="normal">iterations </span><span class="symbol">=</span><span class="normal"> </span><span class="function">random_iterations</span><span class="symbol">();</span>
<span class="normal">    Botan</span><span class="symbol">::</span><span class="normal">Global_RNG</span><span class="symbol">::</span><span class="function">randomize</span><span class="symbol">(</span><span class="normal">newslot</span><span class="symbol">.</span><span class="normal">salt</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="normal">newslot</span><span class="symbol">.</span><span class="normal">salt</span><span class="symbol">));</span>

<span class="normal">    pbkdf</span><span class="symbol">.</span><span class="function">set_iterations</span><span class="symbol">(</span><span class="normal">newslot</span><span class="symbol">.</span><span class="normal">iterations</span><span class="symbol">);</span>
<span class="normal">    pbkdf</span><span class="symbol">.</span><span class="function">change_salt</span><span class="symbol">(</span><span class="normal">newslot</span><span class="symbol">.</span><span class="normal">salt</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="normal">newslot</span><span class="symbol">.</span><span class="normal">salt</span><span class="symbol">));</span>
<span class="normal">    Botan</span><span class="symbol">::</span><span class="usertype">OctetString</span><span class="normal"> enckey </span><span class="symbol">=</span><span class="normal"> pbkdf</span><span class="symbol">.</span><span class="function">derive_key</span><span class="symbol">(</span><span class="number">32</span><span class="symbol">,</span><span class="normal"> Botan</span><span class="symbol">::</span><span class="normal">SecureVector</span><span class="symbol">&lt;</span><span class="normal">Botan</span><span class="symbol">::</span><span class="normal">byte</span><span class="symbol">&gt;((</span><span class="normal">Botan</span><span class="symbol">::</span><span class="normal">byte</span><span class="symbol">*)</span><span class="normal">key</span><span class="symbol">.</span><span class="function">data</span><span class="symbol">(),</span><span class="normal"> key</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">()));</span>

<span class="normal">    </span><span class="comment">// Encrypt the known (or new) master key material with the derived key.</span>

<span class="normal">    Botan</span><span class="symbol">::</span><span class="usertype">Pipe</span><span class="normal"> </span><span class="function">pipe</span><span class="symbol">(</span><span class="normal"> Botan</span><span class="symbol">::</span><span class="function">get_cipher</span><span class="symbol">(</span><span class="string">"Serpent/ECB/NoPadding"</span><span class="symbol">,</span><span class="normal"> enckey</span><span class="symbol">,</span><span class="normal"> Botan</span><span class="symbol">::</span><span class="normal">ENCRYPTION</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">);</span>

<span class="normal">    pipe</span><span class="symbol">.</span><span class="function">process_msg</span><span class="symbol">(</span><span class="normal">m_masterkey</span><span class="symbol">);</span>

<span class="normal">    Botan</span><span class="symbol">::</span><span class="usertype">SecureVector&lt;Botan::byte&gt;</span><span class="normal"> ciphertext </span><span class="symbol">=</span><span class="normal"> pipe</span><span class="symbol">.</span><span class="function">read_all</span><span class="symbol">();</span>
<span class="normal">    </span><span class="function">AssertException</span><span class="symbol">(</span><span class="normal">ciphertext</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="normal">newslot</span><span class="symbol">.</span><span class="normal">emasterkey</span><span class="symbol">));</span>

<span class="normal">    </span><span class="function">memcpy</span><span class="symbol">(</span><span class="normal">newslot</span><span class="symbol">.</span><span class="normal">emasterkey</span><span class="symbol">,</span><span class="normal"> ciphertext</span><span class="symbol">.</span><span class="function">begin</span><span class="symbol">(),</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="normal">newslot</span><span class="symbol">.</span><span class="normal">emasterkey</span><span class="symbol">));</span>
<span class="normal">    </span>
<span class="normal">    m_keyslots</span><span class="symbol">.</span><span class="function">push_back</span><span class="symbol">(</span><span class="normal">newslot</span><span class="symbol">);</span>

<span class="normal">    m_modified </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">return</span><span class="normal"> m_keyslots</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> ContainerImpl</span><span class="symbol">::</span><span class="function">ChangeKeySlot</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> slot</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> key</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="comment">// Check that the user key slot is valid.</span>
<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">slot </span><span class="symbol">&gt;=</span><span class="normal"> m_keyslots</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">())</span>
<span class="normal">	</span><span class="keyword">throw</span><span class="symbol">(</span><span class="function">ProgramError</span><span class="symbol">(</span><span class="normal">ETE_KEYSLOT_INVALID_INDEX</span><span class="symbol">));</span>

<span class="normal">    KeySlot</span><span class="symbol">&amp;</span><span class="normal"> keyslot </span><span class="symbol">=</span><span class="normal"> m_keyslots</span><span class="symbol">[</span><span class="normal">slot</span><span class="symbol">];</span>

<span class="normal">    </span><span class="comment">// Create cipher key from new random salt and iterations.</span>

<span class="normal">    Botan</span><span class="symbol">::</span><span class="usertype">PKCS5_PBKDF2</span><span class="normal"> </span><span class="function">pbkdf</span><span class="symbol">(</span><span class="string">"SHA-256"</span><span class="symbol">);</span>

<span class="normal">    keyslot</span><span class="symbol">.</span><span class="normal">iterations </span><span class="symbol">=</span><span class="normal"> </span><span class="function">random_iterations</span><span class="symbol">();</span>
<span class="normal">    Botan</span><span class="symbol">::</span><span class="normal">Global_RNG</span><span class="symbol">::</span><span class="function">randomize</span><span class="symbol">(</span><span class="normal">keyslot</span><span class="symbol">.</span><span class="normal">salt</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="normal">keyslot</span><span class="symbol">.</span><span class="normal">salt</span><span class="symbol">));</span>

<span class="normal">    pbkdf</span><span class="symbol">.</span><span class="function">set_iterations</span><span class="symbol">(</span><span class="normal">keyslot</span><span class="symbol">.</span><span class="normal">iterations</span><span class="symbol">);</span>
<span class="normal">    pbkdf</span><span class="symbol">.</span><span class="function">change_salt</span><span class="symbol">(</span><span class="normal">keyslot</span><span class="symbol">.</span><span class="normal">salt</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="normal">keyslot</span><span class="symbol">.</span><span class="normal">salt</span><span class="symbol">));</span>
<span class="normal">    Botan</span><span class="symbol">::</span><span class="usertype">OctetString</span><span class="normal"> enckey </span><span class="symbol">=</span><span class="normal"> pbkdf</span><span class="symbol">.</span><span class="function">derive_key</span><span class="symbol">(</span><span class="number">32</span><span class="symbol">,</span><span class="normal"> Botan</span><span class="symbol">::</span><span class="normal">SecureVector</span><span class="symbol">&lt;</span><span class="normal">Botan</span><span class="symbol">::</span><span class="normal">byte</span><span class="symbol">&gt;((</span><span class="normal">Botan</span><span class="symbol">::</span><span class="normal">byte</span><span class="symbol">*)</span><span class="normal">key</span><span class="symbol">.</span><span class="function">data</span><span class="symbol">(),</span><span class="normal"> key</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">()));</span>

<span class="normal">    </span><span class="comment">// Encrypt the known master key material with the derived key.</span>

<span class="normal">    Botan</span><span class="symbol">::</span><span class="usertype">Pipe</span><span class="normal"> </span><span class="function">pipe</span><span class="symbol">(</span><span class="normal"> Botan</span><span class="symbol">::</span><span class="function">get_cipher</span><span class="symbol">(</span><span class="string">"Serpent/ECB/NoPadding"</span><span class="symbol">,</span><span class="normal"> enckey</span><span class="symbol">,</span><span class="normal"> Botan</span><span class="symbol">::</span><span class="normal">ENCRYPTION</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">);</span>

<span class="normal">    pipe</span><span class="symbol">.</span><span class="function">process_msg</span><span class="symbol">(</span><span class="normal">m_masterkey</span><span class="symbol">);</span>

<span class="normal">    Botan</span><span class="symbol">::</span><span class="usertype">SecureVector&lt;Botan::byte&gt;</span><span class="normal"> ciphertext </span><span class="symbol">=</span><span class="normal"> pipe</span><span class="symbol">.</span><span class="function">read_all</span><span class="symbol">();</span>
<span class="normal">    </span><span class="function">AssertException</span><span class="symbol">(</span><span class="normal">ciphertext</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="normal">keyslot</span><span class="symbol">.</span><span class="normal">emasterkey</span><span class="symbol">));</span>

<span class="normal">    </span><span class="function">memcpy</span><span class="symbol">(</span><span class="normal">keyslot</span><span class="symbol">.</span><span class="normal">emasterkey</span><span class="symbol">,</span><span class="normal"> ciphertext</span><span class="symbol">.</span><span class="function">begin</span><span class="symbol">(),</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="normal">keyslot</span><span class="symbol">.</span><span class="normal">emasterkey</span><span class="symbol">));</span>

<span class="normal">    m_modified </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> ContainerImpl</span><span class="symbol">::</span><span class="function">DeleteKeySlot</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> slot</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="comment">// Check that the user key slot is valid.</span>
<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">slot </span><span class="symbol">&gt;=</span><span class="normal"> m_keyslots</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">())</span>
<span class="normal">	</span><span class="keyword">throw</span><span class="symbol">(</span><span class="function">ProgramError</span><span class="symbol">(</span><span class="normal">ETE_KEYSLOT_INVALID_INDEX</span><span class="symbol">));</span>

<span class="normal">    </span><span class="comment">// fixup numbering of used key slot</span>
<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">m_usedkeyslot </span><span class="symbol">==</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="symbol">)</span><span class="normal">slot</span><span class="symbol">)</span>
<span class="normal">	m_usedkeyslot </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">    </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">m_usedkeyslot </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="symbol">(</span><span class="type">int</span><span class="symbol">)</span><span class="normal">slot</span><span class="symbol">)</span>
<span class="normal">	</span><span class="symbol">--</span><span class="normal">m_usedkeyslot</span><span class="symbol">;</span>

<span class="normal">    m_keyslots</span><span class="symbol">.</span><span class="function">erase</span><span class="symbol">(</span><span class="normal">m_keyslots</span><span class="symbol">.</span><span class="function">begin</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> slot</span><span class="symbol">);</span>

<span class="normal">    m_modified </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="type">int</span><span class="normal"> ContainerImpl</span><span class="symbol">::</span><span class="function">GetUsedKeySlot</span><span class="symbol">()</span><span class="normal"> </span><span class="keyword">const</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> m_usedkeyslot</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="comment">// *** Container Global Unencrypted Properties ***</span>

<span class="type">void</span><span class="normal"> ContainerImpl</span><span class="symbol">::</span><span class="function">SetGlobalUnencryptedProperty</span><span class="symbol">(</span><span class="keyword">const</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> key</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> value</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    m_unc_properties</span><span class="symbol">[</span><span class="normal">key</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> value</span><span class="symbol">;</span>

<span class="normal">    m_modified </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="keyword">const</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> ContainerImpl</span><span class="symbol">::</span><span class="function">GetGlobalUnencryptedProperty</span><span class="symbol">(</span><span class="keyword">const</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> key</span><span class="symbol">)</span><span class="normal"> </span><span class="keyword">const</span>
<span class="cbracket">{</span>
<span class="normal">    propertymap_type</span><span class="symbol">::</span><span class="usertype">const_iterator</span><span class="normal"> pi </span><span class="symbol">=</span><span class="normal"> m_unc_properties</span><span class="symbol">.</span><span class="function">find</span><span class="symbol">(</span><span class="normal">key</span><span class="symbol">);</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pi </span><span class="symbol">!=</span><span class="normal"> m_unc_properties</span><span class="symbol">.</span><span class="function">end</span><span class="symbol">())</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> pi</span><span class="symbol">-&gt;</span><span class="normal">second</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="normal">    </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">static</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> std</span><span class="symbol">::</span><span class="usertype">string</span><span class="normal"> zerostring</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> zerostring</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="type">bool</span><span class="normal"> ContainerImpl</span><span class="symbol">::</span><span class="function">DeleteGlobalUnencryptedProperty</span><span class="symbol">(</span><span class="keyword">const</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> key</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">m_unc_properties</span><span class="symbol">.</span><span class="function">erase</span><span class="symbol">(</span><span class="normal">key</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">m_modified </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="type">bool</span><span class="normal"> ContainerImpl</span><span class="symbol">::</span><span class="function">GetGlobalUnencryptedPropertyIndex</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> propindex</span><span class="symbol">,</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> key</span><span class="symbol">,</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> value</span><span class="symbol">)</span><span class="normal"> </span><span class="keyword">const</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">propindex </span><span class="symbol">&gt;=</span><span class="normal"> m_unc_properties</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">())</span><span class="normal"> </span><span class="keyword">return</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>

<span class="normal">    propertymap_type</span><span class="symbol">::</span><span class="usertype">const_iterator</span><span class="normal"> pi </span><span class="symbol">=</span><span class="normal"> m_unc_properties</span><span class="symbol">.</span><span class="function">begin</span><span class="symbol">();</span>

<span class="normal">    </span><span class="keyword">for</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> propindex</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">++</span><span class="normal">i</span><span class="symbol">)</span><span class="normal">	</span><span class="symbol">++</span><span class="normal">pi</span><span class="symbol">;</span>

<span class="normal">    key </span><span class="symbol">=</span><span class="normal"> pi</span><span class="symbol">-&gt;</span><span class="normal">first</span><span class="symbol">;</span>
<span class="normal">    value </span><span class="symbol">=</span><span class="normal"> pi</span><span class="symbol">-&gt;</span><span class="normal">second</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">return</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="comment">// *** Container Global Encrypted Properties ***</span>

<span class="type">void</span><span class="normal"> ContainerImpl</span><span class="symbol">::</span><span class="function">SetGlobalEncryptedProperty</span><span class="symbol">(</span><span class="keyword">const</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> key</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> value</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    m_enc_properties</span><span class="symbol">[</span><span class="normal">key</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> value</span><span class="symbol">;</span>

<span class="normal">    m_modified </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="keyword">const</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> ContainerImpl</span><span class="symbol">::</span><span class="function">GetGlobalEncryptedProperty</span><span class="symbol">(</span><span class="keyword">const</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> key</span><span class="symbol">)</span><span class="normal"> </span><span class="keyword">const</span>
<span class="cbracket">{</span>
<span class="normal">    propertymap_type</span><span class="symbol">::</span><span class="usertype">const_iterator</span><span class="normal"> pi </span><span class="symbol">=</span><span class="normal"> m_enc_properties</span><span class="symbol">.</span><span class="function">find</span><span class="symbol">(</span><span class="normal">key</span><span class="symbol">);</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pi </span><span class="symbol">!=</span><span class="normal"> m_enc_properties</span><span class="symbol">.</span><span class="function">end</span><span class="symbol">())</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> pi</span><span class="symbol">-&gt;</span><span class="normal">second</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="normal">    </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">static</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> std</span><span class="symbol">::</span><span class="usertype">string</span><span class="normal"> zerostring</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> zerostring</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="type">bool</span><span class="normal"> ContainerImpl</span><span class="symbol">::</span><span class="function">DeleteGlobalEncryptedProperty</span><span class="symbol">(</span><span class="keyword">const</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> key</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">m_enc_properties</span><span class="symbol">.</span><span class="function">erase</span><span class="symbol">(</span><span class="normal">key</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">m_modified </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="type">bool</span><span class="normal"> ContainerImpl</span><span class="symbol">::</span><span class="function">GetGlobalEncryptedPropertyIndex</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> propindex</span><span class="symbol">,</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> key</span><span class="symbol">,</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> value</span><span class="symbol">)</span><span class="normal"> </span><span class="keyword">const</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">propindex </span><span class="symbol">&gt;=</span><span class="normal"> m_enc_properties</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">())</span><span class="normal"> </span><span class="keyword">return</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>

<span class="normal">    propertymap_type</span><span class="symbol">::</span><span class="usertype">const_iterator</span><span class="normal"> pi </span><span class="symbol">=</span><span class="normal"> m_enc_properties</span><span class="symbol">.</span><span class="function">begin</span><span class="symbol">();</span>

<span class="normal">    </span><span class="keyword">for</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> propindex</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">++</span><span class="normal">i</span><span class="symbol">)</span><span class="normal">	</span><span class="symbol">++</span><span class="normal">pi</span><span class="symbol">;</span>

<span class="normal">    key </span><span class="symbol">=</span><span class="normal"> pi</span><span class="symbol">-&gt;</span><span class="normal">first</span><span class="symbol">;</span>
<span class="normal">    value </span><span class="symbol">=</span><span class="normal"> pi</span><span class="symbol">-&gt;</span><span class="normal">second</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">return</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="comment">// *** Container SubFiles - Subfile array management ***</span>

<span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> ContainerImpl</span><span class="symbol">::</span><span class="function">CountSubFile</span><span class="symbol">()</span><span class="normal"> </span><span class="keyword">const</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> m_subfiles</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">();</span>
<span class="cbracket">}</span>

<span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> ContainerImpl</span><span class="symbol">::</span><span class="function">AppendSubFile</span><span class="symbol">()</span>
<span class="cbracket">{</span>
<span class="normal">    m_modified </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>

<span class="normal">    </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> si </span><span class="symbol">=</span><span class="normal"> m_subfiles</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">();</span>
<span class="normal">    m_subfiles</span><span class="symbol">.</span><span class="function">push_back</span><span class="symbol">(</span><span class="normal"> </span><span class="function">SubFile</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">);</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> si</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> ContainerImpl</span><span class="symbol">::</span><span class="function">InsertSubFile</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> subfileindex</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    m_modified </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">subfileindex </span><span class="symbol">&lt;</span><span class="normal"> m_subfiles</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">())</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	m_subfiles</span><span class="symbol">.</span><span class="function">insert</span><span class="symbol">(</span><span class="normal">m_subfiles</span><span class="symbol">.</span><span class="function">begin</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> subfileindex</span><span class="symbol">,</span><span class="normal"> </span><span class="function">SubFile</span><span class="symbol">());</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> subfileindex</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="normal">    </span><span class="keyword">else</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="function">AppendSubFile</span><span class="symbol">();</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="type">bool</span><span class="normal"> ContainerImpl</span><span class="symbol">::</span><span class="function">DeleteSubFile</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> subfileindex</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">subfileindex </span><span class="symbol">&lt;</span><span class="normal"> m_subfiles</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">())</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	m_subfiles</span><span class="symbol">.</span><span class="function">erase</span><span class="symbol">(</span><span class="normal">m_subfiles</span><span class="symbol">.</span><span class="function">begin</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> subfileindex</span><span class="symbol">);</span>

<span class="normal">	m_modified </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="normal">    </span><span class="keyword">else</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="comment">// *** Container SubFiles - Subfile user-defined properties ***</span>

<span class="type">void</span><span class="normal"> ContainerImpl</span><span class="symbol">::</span><span class="function">SetSubFileProperty</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> subfileindex</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> key</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> value</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">subfileindex </span><span class="symbol">&gt;=</span><span class="normal"> m_subfiles</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">())</span>
<span class="normal">	</span><span class="keyword">throw</span><span class="symbol">(</span><span class="function">ProgramError</span><span class="symbol">(</span><span class="normal">ETE_SUBFILE_INVALID_INDEX</span><span class="symbol">));</span>

<span class="normal">    SubFile</span><span class="symbol">&amp;</span><span class="normal"> subfile </span><span class="symbol">=</span><span class="normal"> m_subfiles</span><span class="symbol">[</span><span class="normal">subfileindex</span><span class="symbol">];</span>
<span class="normal">    subfile</span><span class="symbol">.</span><span class="normal">properties</span><span class="symbol">[</span><span class="normal"> key </span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> value</span><span class="symbol">;</span>

<span class="normal">    m_modified </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="keyword">const</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> ContainerImpl</span><span class="symbol">::</span><span class="function">GetSubFileProperty</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> subfileindex</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> key</span><span class="symbol">)</span><span class="normal"> </span><span class="keyword">const</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">subfileindex </span><span class="symbol">&gt;=</span><span class="normal"> m_subfiles</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">())</span>
<span class="normal">	</span><span class="keyword">throw</span><span class="symbol">(</span><span class="function">ProgramError</span><span class="symbol">(</span><span class="normal">ETE_SUBFILE_INVALID_INDEX</span><span class="symbol">));</span>

<span class="normal">    </span><span class="keyword">const</span><span class="normal"> SubFile</span><span class="symbol">&amp;</span><span class="normal"> subfile </span><span class="symbol">=</span><span class="normal"> m_subfiles</span><span class="symbol">[</span><span class="normal">subfileindex</span><span class="symbol">];</span>
<span class="normal">    propertymap_type</span><span class="symbol">::</span><span class="usertype">const_iterator</span><span class="normal"> pi </span><span class="symbol">=</span><span class="normal"> subfile</span><span class="symbol">.</span><span class="normal">properties</span><span class="symbol">.</span><span class="function">find</span><span class="symbol">(</span><span class="normal">key</span><span class="symbol">);</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">pi </span><span class="symbol">!=</span><span class="normal"> subfile</span><span class="symbol">.</span><span class="normal">properties</span><span class="symbol">.</span><span class="function">end</span><span class="symbol">())</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> pi</span><span class="symbol">-&gt;</span><span class="normal">second</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="normal">    </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">static</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> std</span><span class="symbol">::</span><span class="usertype">string</span><span class="normal"> zerostring</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> zerostring</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="type">bool</span><span class="normal"> ContainerImpl</span><span class="symbol">::</span><span class="function">DeleteSubFileProperty</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> subfileindex</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> key</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">subfileindex </span><span class="symbol">&gt;=</span><span class="normal"> m_subfiles</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">())</span>
<span class="normal">	</span><span class="keyword">throw</span><span class="symbol">(</span><span class="function">ProgramError</span><span class="symbol">(</span><span class="normal">ETE_SUBFILE_INVALID_INDEX</span><span class="symbol">));</span>

<span class="normal">    m_modified </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>

<span class="normal">    SubFile</span><span class="symbol">&amp;</span><span class="normal"> subfile </span><span class="symbol">=</span><span class="normal"> m_subfiles</span><span class="symbol">[</span><span class="normal">subfileindex</span><span class="symbol">];</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">subfile</span><span class="symbol">.</span><span class="normal">properties</span><span class="symbol">.</span><span class="function">erase</span><span class="symbol">(</span><span class="normal">key</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="type">bool</span><span class="normal"> ContainerImpl</span><span class="symbol">::</span><span class="function">GetSubFilePropertyIndex</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> subfileindex</span><span class="symbol">,</span><span class="normal"> </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> propindex</span><span class="symbol">,</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> key</span><span class="symbol">,</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> value</span><span class="symbol">)</span><span class="normal"> </span><span class="keyword">const</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">subfileindex </span><span class="symbol">&gt;=</span><span class="normal"> m_subfiles</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">())</span>
<span class="normal">	</span><span class="keyword">throw</span><span class="symbol">(</span><span class="function">ProgramError</span><span class="symbol">(</span><span class="normal">ETE_SUBFILE_INVALID_INDEX</span><span class="symbol">));</span>

<span class="normal">    </span><span class="keyword">const</span><span class="normal"> SubFile</span><span class="symbol">&amp;</span><span class="normal"> subfile </span><span class="symbol">=</span><span class="normal"> m_subfiles</span><span class="symbol">[</span><span class="normal">subfileindex</span><span class="symbol">];</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">propindex </span><span class="symbol">&gt;=</span><span class="normal"> subfile</span><span class="symbol">.</span><span class="normal">properties</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">())</span><span class="normal"> </span><span class="keyword">return</span><span class="normal"> </span><span class="keyword">false</span><span class="symbol">;</span>

<span class="normal">    propertymap_type</span><span class="symbol">::</span><span class="usertype">const_iterator</span><span class="normal"> pi </span><span class="symbol">=</span><span class="normal"> subfile</span><span class="symbol">.</span><span class="normal">properties</span><span class="symbol">.</span><span class="function">begin</span><span class="symbol">();</span>

<span class="normal">    </span><span class="keyword">for</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> propindex</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">++</span><span class="normal">i</span><span class="symbol">)</span><span class="normal">	</span><span class="symbol">++</span><span class="normal">pi</span><span class="symbol">;</span>

<span class="normal">    key </span><span class="symbol">=</span><span class="normal"> pi</span><span class="symbol">-&gt;</span><span class="normal">first</span><span class="symbol">;</span>
<span class="normal">    value </span><span class="symbol">=</span><span class="normal"> pi</span><span class="symbol">-&gt;</span><span class="normal">second</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">return</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="comment">// *** Container SubFiles - Get operations of subfile header fields ***</span>

<span class="usertype">uint32_t</span><span class="normal"> ContainerImpl</span><span class="symbol">::</span><span class="function">GetSubFileStorageSize</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> subfileindex</span><span class="symbol">)</span><span class="normal"> </span><span class="keyword">const</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">subfileindex </span><span class="symbol">&gt;=</span><span class="normal"> m_subfiles</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">())</span>
<span class="normal">	</span><span class="keyword">throw</span><span class="symbol">(</span><span class="function">ProgramError</span><span class="symbol">(</span><span class="normal">ETE_SUBFILE_INVALID_INDEX</span><span class="symbol">));</span>

<span class="normal">    </span><span class="keyword">return</span><span class="normal"> m_subfiles</span><span class="symbol">[</span><span class="normal">subfileindex</span><span class="symbol">].</span><span class="normal">storagesize</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="usertype">uint32_t</span><span class="normal"> ContainerImpl</span><span class="symbol">::</span><span class="function">GetSubFileSize</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> subfileindex</span><span class="symbol">)</span><span class="normal"> </span><span class="keyword">const</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">subfileindex </span><span class="symbol">&gt;=</span><span class="normal"> m_subfiles</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">())</span>
<span class="normal">	</span><span class="keyword">throw</span><span class="symbol">(</span><span class="function">ProgramError</span><span class="symbol">(</span><span class="normal">ETE_SUBFILE_INVALID_INDEX</span><span class="symbol">));</span>

<span class="normal">    </span><span class="keyword">return</span><span class="normal"> m_subfiles</span><span class="symbol">[</span><span class="normal">subfileindex</span><span class="symbol">].</span><span class="normal">realsize</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="usertype">encryption_type</span><span class="normal"> ContainerImpl</span><span class="symbol">::</span><span class="function">GetSubFileEncryption</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> subfileindex</span><span class="symbol">)</span><span class="normal"> </span><span class="keyword">const</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">subfileindex </span><span class="symbol">&gt;=</span><span class="normal"> m_subfiles</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">())</span>
<span class="normal">	</span><span class="keyword">throw</span><span class="symbol">(</span><span class="function">ProgramError</span><span class="symbol">(</span><span class="normal">ETE_SUBFILE_INVALID_INDEX</span><span class="symbol">));</span>

<span class="normal">    </span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">encryption_type</span><span class="symbol">)</span><span class="normal">m_subfiles</span><span class="symbol">[</span><span class="normal">subfileindex</span><span class="symbol">].</span><span class="normal">encryption</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="usertype">compression_type</span><span class="normal"> ContainerImpl</span><span class="symbol">::</span><span class="function">GetSubFileCompression</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> subfileindex</span><span class="symbol">)</span><span class="normal"> </span><span class="keyword">const</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">subfileindex </span><span class="symbol">&gt;=</span><span class="normal"> m_subfiles</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">())</span>
<span class="normal">	</span><span class="keyword">throw</span><span class="symbol">(</span><span class="function">ProgramError</span><span class="symbol">(</span><span class="normal">ETE_SUBFILE_INVALID_INDEX</span><span class="symbol">));</span>

<span class="normal">    </span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">compression_type</span><span class="symbol">)</span><span class="normal">m_subfiles</span><span class="symbol">[</span><span class="normal">subfileindex</span><span class="symbol">].</span><span class="normal">compression</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="comment">// *** Container SubFiles - Set operations of subfile header fields ***</span>

<span class="type">void</span><span class="normal"> ContainerImpl</span><span class="symbol">::</span><span class="function">SetSubFileEncryption</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> subfileindex</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">encryption_type</span><span class="normal"> c</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">subfileindex </span><span class="symbol">&gt;=</span><span class="normal"> m_subfiles</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">())</span>
<span class="normal">	</span><span class="keyword">throw</span><span class="symbol">(</span><span class="function">ProgramError</span><span class="symbol">(</span><span class="normal">ETE_SUBFILE_INVALID_INDEX</span><span class="symbol">));</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">c </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">0</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> c </span><span class="symbol">&gt;</span><span class="normal"> ENCRYPTION_SERPENT256</span><span class="symbol">)</span>
<span class="normal">	</span><span class="keyword">throw</span><span class="symbol">(</span><span class="function">ProgramError</span><span class="symbol">(</span><span class="normal">ETE_SUBFILE_INVALID_ENCRYPTION</span><span class="symbol">));</span>

<span class="normal">    </span><span class="comment">// reencrypt if necessary</span>
<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">m_subfiles</span><span class="symbol">[</span><span class="normal">subfileindex</span><span class="symbol">].</span><span class="normal">encryption </span><span class="symbol">!=</span><span class="normal"> c</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	std</span><span class="symbol">::</span><span class="usertype">string</span><span class="normal"> data</span><span class="symbol">;</span>

<span class="normal">	</span><span class="function">GetSubFileData</span><span class="symbol">(</span><span class="normal">subfileindex</span><span class="symbol">,</span><span class="normal"> data</span><span class="symbol">);</span>

<span class="normal">	m_subfiles</span><span class="symbol">[</span><span class="normal">subfileindex</span><span class="symbol">].</span><span class="normal">encryption </span><span class="symbol">=</span><span class="normal"> c</span><span class="symbol">;</span>

<span class="normal">	</span><span class="function">SetSubFileData</span><span class="symbol">(</span><span class="normal">subfileindex</span><span class="symbol">,</span><span class="normal"> data</span><span class="symbol">.</span><span class="function">data</span><span class="symbol">(),</span><span class="normal"> data</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">());</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> ContainerImpl</span><span class="symbol">::</span><span class="function">SetSubFileCompression</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> subfileindex</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">compression_type</span><span class="normal"> c</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">subfileindex </span><span class="symbol">&gt;=</span><span class="normal"> m_subfiles</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">())</span>
<span class="normal">	</span><span class="keyword">throw</span><span class="symbol">(</span><span class="function">ProgramError</span><span class="symbol">(</span><span class="normal">ETE_SUBFILE_INVALID_INDEX</span><span class="symbol">));</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">c </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">0</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> c </span><span class="symbol">&gt;</span><span class="normal"> COMPRESSION_BZIP2</span><span class="symbol">)</span>
<span class="normal">	</span><span class="keyword">throw</span><span class="symbol">(</span><span class="function">ProgramError</span><span class="symbol">(</span><span class="normal">ETE_SUBFILE_INVALID_COMPRESSION</span><span class="symbol">));</span>

<span class="normal">    </span><span class="comment">// recompress if necessary</span>
<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">m_subfiles</span><span class="symbol">[</span><span class="normal">subfileindex</span><span class="symbol">].</span><span class="normal">compression </span><span class="symbol">!=</span><span class="normal"> c</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	std</span><span class="symbol">::</span><span class="usertype">string</span><span class="normal"> data</span><span class="symbol">;</span>

<span class="normal">	</span><span class="function">GetSubFileData</span><span class="symbol">(</span><span class="normal">subfileindex</span><span class="symbol">,</span><span class="normal"> data</span><span class="symbol">);</span>

<span class="normal">	m_subfiles</span><span class="symbol">[</span><span class="normal">subfileindex</span><span class="symbol">].</span><span class="normal">compression </span><span class="symbol">=</span><span class="normal"> c</span><span class="symbol">;</span>

<span class="normal">	</span><span class="function">SetSubFileData</span><span class="symbol">(</span><span class="normal">subfileindex</span><span class="symbol">,</span><span class="normal"> data</span><span class="symbol">.</span><span class="function">data</span><span class="symbol">(),</span><span class="normal"> data</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">());</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> ContainerImpl</span><span class="symbol">::</span><span class="function">SetSubFileCompressionEncryption</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> subfileindex</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">compression_type</span><span class="normal"> comp</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">encryption_type</span><span class="normal"> enc</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">subfileindex </span><span class="symbol">&gt;=</span><span class="normal"> m_subfiles</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">())</span>
<span class="normal">	</span><span class="keyword">throw</span><span class="symbol">(</span><span class="function">ProgramError</span><span class="symbol">(</span><span class="normal">ETE_SUBFILE_INVALID_INDEX</span><span class="symbol">));</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">comp </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">0</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> comp </span><span class="symbol">&gt;</span><span class="normal"> COMPRESSION_BZIP2</span><span class="symbol">)</span>
<span class="normal">	</span><span class="keyword">throw</span><span class="symbol">(</span><span class="function">ProgramError</span><span class="symbol">(</span><span class="normal">ETE_SUBFILE_INVALID_COMPRESSION</span><span class="symbol">));</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">enc </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">0</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> enc </span><span class="symbol">&gt;</span><span class="normal"> ENCRYPTION_SERPENT256</span><span class="symbol">)</span>
<span class="normal">	</span><span class="keyword">throw</span><span class="symbol">(</span><span class="function">ProgramError</span><span class="symbol">(</span><span class="normal">ETE_SUBFILE_INVALID_ENCRYPTION</span><span class="symbol">));</span>

<span class="normal">    </span><span class="comment">// reencrypt and recompress if necessary</span>
<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">m_subfiles</span><span class="symbol">[</span><span class="normal">subfileindex</span><span class="symbol">].</span><span class="normal">encryption </span><span class="symbol">!=</span><span class="normal"> enc </span><span class="symbol">||</span><span class="normal"> m_subfiles</span><span class="symbol">[</span><span class="normal">subfileindex</span><span class="symbol">].</span><span class="normal">compression </span><span class="symbol">!=</span><span class="normal"> comp</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	std</span><span class="symbol">::</span><span class="usertype">string</span><span class="normal"> data</span><span class="symbol">;</span>

<span class="normal">	</span><span class="function">GetSubFileData</span><span class="symbol">(</span><span class="normal">subfileindex</span><span class="symbol">,</span><span class="normal"> data</span><span class="symbol">);</span>

<span class="normal">	m_subfiles</span><span class="symbol">[</span><span class="normal">subfileindex</span><span class="symbol">].</span><span class="normal">encryption </span><span class="symbol">=</span><span class="normal"> enc</span><span class="symbol">;</span>
<span class="normal">	m_subfiles</span><span class="symbol">[</span><span class="normal">subfileindex</span><span class="symbol">].</span><span class="normal">compression </span><span class="symbol">=</span><span class="normal"> comp</span><span class="symbol">;</span>

<span class="normal">	</span><span class="function">SetSubFileData</span><span class="symbol">(</span><span class="normal">subfileindex</span><span class="symbol">,</span><span class="normal"> data</span><span class="symbol">.</span><span class="function">data</span><span class="symbol">(),</span><span class="normal"> data</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">());</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="comment">// *** Container SubFiles - Subfile data operations ***</span>

<span class="type">void</span><span class="normal"> ContainerImpl</span><span class="symbol">::</span><span class="function">SetSubFileData</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> subfileindex</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> </span><span class="type">void</span><span class="symbol">*</span><span class="normal"> data</span><span class="symbol">,</span><span class="normal"> </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> datalen</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">subfileindex </span><span class="symbol">&gt;=</span><span class="normal"> m_subfiles</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">())</span>
<span class="normal">	</span><span class="keyword">throw</span><span class="symbol">(</span><span class="function">ProgramError</span><span class="symbol">(</span><span class="normal">ETE_SUBFILE_INVALID_INDEX</span><span class="symbol">));</span>

<span class="normal">    SubFile</span><span class="symbol">&amp;</span><span class="normal"> subfile </span><span class="symbol">=</span><span class="normal"> m_subfiles</span><span class="symbol">[</span><span class="normal">subfileindex</span><span class="symbol">];</span>

<span class="normal">    subfile</span><span class="symbol">.</span><span class="normal">realsize </span><span class="symbol">=</span><span class="normal"> datalen</span><span class="symbol">;</span>

<span class="normal">    </span><span class="usertype">ProgressTicker</span><span class="normal"> </span><span class="function">progress</span><span class="symbol">(*</span><span class="keyword">this</span><span class="symbol">,</span>
<span class="normal">			    </span><span class="string">"Saving SubFile"</span><span class="symbol">,</span><span class="normal"> PI_SAVE_SUBFILE</span><span class="symbol">,</span>
<span class="normal">			    </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> datalen</span><span class="symbol">);</span>

<span class="normal">    </span><span class="comment">// Setup encryption context if requested</span>

<span class="normal">    std</span><span class="symbol">::</span><span class="usertype">auto_ptr&lt;Botan::Filter&gt;</span><span class="normal"> encryption_filter</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">subfile</span><span class="symbol">.</span><span class="normal">encryption </span><span class="symbol">==</span><span class="normal"> ENCRYPTION_NONE</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	subfile</span><span class="symbol">.</span><span class="normal">encdata</span><span class="symbol">.</span><span class="function">create</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">);</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="normal">    </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">subfile</span><span class="symbol">.</span><span class="normal">encryption </span><span class="symbol">==</span><span class="normal"> ENCRYPTION_SERPENT256</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="comment">// Generate a new encryption ley and CBC IV and save it in the encrypted metadata</span>

<span class="normal">	subfile</span><span class="symbol">.</span><span class="normal">encdata</span><span class="symbol">.</span><span class="function">create</span><span class="symbol">(</span><span class="number">32</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="number">16</span><span class="symbol">);</span>
<span class="normal">	Botan</span><span class="symbol">::</span><span class="normal">Global_RNG</span><span class="symbol">::</span><span class="function">randomize</span><span class="symbol">(</span><span class="normal">subfile</span><span class="symbol">.</span><span class="normal">encdata</span><span class="symbol">.</span><span class="function">begin</span><span class="symbol">(),</span><span class="normal"> subfile</span><span class="symbol">.</span><span class="normal">encdata</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">());</span>

<span class="normal">	Botan</span><span class="symbol">::</span><span class="usertype">SecureBuffer&lt;Botan::byte, 32&gt;</span><span class="normal"> </span><span class="function">enckey</span><span class="symbol">(</span><span class="normal">subfile</span><span class="symbol">.</span><span class="normal">encdata</span><span class="symbol">.</span><span class="function">begin</span><span class="symbol">(),</span><span class="normal"> </span><span class="number">32</span><span class="symbol">);</span>
<span class="normal">	Botan</span><span class="symbol">::</span><span class="usertype">SecureBuffer&lt;Botan::byte, 16&gt;</span><span class="normal"> </span><span class="function">cbciv</span><span class="symbol">(</span><span class="normal">subfile</span><span class="symbol">.</span><span class="normal">encdata</span><span class="symbol">.</span><span class="function">begin</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="number">32</span><span class="symbol">,</span><span class="normal"> </span><span class="number">16</span><span class="symbol">);</span>

<span class="normal">	encryption_filter </span><span class="symbol">=</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">auto_ptr</span><span class="symbol">&lt;</span><span class="normal">Botan</span><span class="symbol">::</span><span class="normal">Filter</span><span class="symbol">&gt;(</span>
<span class="normal">	    Botan</span><span class="symbol">::</span><span class="function">get_cipher</span><span class="symbol">(</span><span class="string">"Serpent/CBC/PKCS7"</span><span class="symbol">,</span><span class="normal"> enckey</span><span class="symbol">,</span><span class="normal"> cbciv</span><span class="symbol">,</span><span class="normal"> Botan</span><span class="symbol">::</span><span class="normal">ENCRYPTION</span><span class="symbol">)</span>
<span class="normal">	    </span><span class="symbol">);</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="normal">    </span><span class="keyword">else</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">throw</span><span class="symbol">(</span><span class="function">RuntimeError</span><span class="symbol">(</span><span class="normal">ETE_SUBFILE_INVALID_ENCRYPTION</span><span class="symbol">));</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="comment">// Setup compression context if requested</span>

<span class="normal">    std</span><span class="symbol">::</span><span class="usertype">auto_ptr&lt;Botan::Filter&gt;</span><span class="normal"> compression_filter</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">subfile</span><span class="symbol">.</span><span class="normal">compression </span><span class="symbol">==</span><span class="normal"> COMPRESSION_NONE</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="normal">    </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">subfile</span><span class="symbol">.</span><span class="normal">compression </span><span class="symbol">==</span><span class="normal"> COMPRESSION_ZLIB</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	compression_filter </span><span class="symbol">=</span><span class="normal">  std</span><span class="symbol">::</span><span class="normal">auto_ptr</span><span class="symbol">&lt;</span><span class="normal">Botan</span><span class="symbol">::</span><span class="normal">Filter</span><span class="symbol">&gt;(</span>
<span class="normal">	    </span><span class="keyword">new</span><span class="normal"> Botan</span><span class="symbol">::</span><span class="function">Zlib_Compression</span><span class="symbol">(</span><span class="number">9</span><span class="symbol">)</span>
<span class="normal">	    </span><span class="symbol">);</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="normal">    </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">subfile</span><span class="symbol">.</span><span class="normal">compression </span><span class="symbol">==</span><span class="normal"> COMPRESSION_BZIP2</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	compression_filter </span><span class="symbol">=</span><span class="normal">  std</span><span class="symbol">::</span><span class="normal">auto_ptr</span><span class="symbol">&lt;</span><span class="normal">Botan</span><span class="symbol">::</span><span class="normal">Filter</span><span class="symbol">&gt;(</span>
<span class="normal">	    </span><span class="keyword">new</span><span class="normal"> Botan</span><span class="symbol">::</span><span class="function">Bzip_Compression</span><span class="symbol">(</span><span class="number">9</span><span class="symbol">)</span>
<span class="normal">	    </span><span class="symbol">);</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="normal">    </span><span class="keyword">else</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">throw</span><span class="symbol">(</span><span class="function">RuntimeError</span><span class="symbol">(</span><span class="normal">ETE_SUBFILE_INVALID_COMPRESSION</span><span class="symbol">));</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="comment">// Setup processing pipe</span>

<span class="normal">    subfile</span><span class="symbol">.</span><span class="normal">data</span><span class="symbol">.</span><span class="function">create</span><span class="symbol">(</span><span class="normal">datalen </span><span class="symbol">/</span><span class="normal"> </span><span class="number">16</span><span class="symbol">);</span><span class="normal">	</span><span class="comment">// this allocates memory</span>
<span class="normal">    subfile</span><span class="symbol">.</span><span class="normal">data</span><span class="symbol">.</span><span class="function">create</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">);</span><span class="normal">		</span><span class="comment">// this clears the append cursor</span>

<span class="normal">    </span><span class="comment">// Pipe setup note: the encryption filter is chained to the _first_ filter</span>
<span class="normal">    </span><span class="comment">// in the preceding fork!</span>
<span class="normal">    Botan</span><span class="symbol">::</span><span class="normal">Filter</span><span class="symbol">*</span><span class="normal"> filters</span><span class="symbol">[</span><span class="number">4</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">new</span><span class="normal"> Botan</span><span class="symbol">::</span><span class="function">Fork</span><span class="symbol">(</span><span class="normal">compression_filter</span><span class="symbol">.</span><span class="function">release</span><span class="symbol">(),</span>
<span class="normal">			</span><span class="keyword">new</span><span class="normal"> Botan</span><span class="symbol">::</span><span class="function">Hash_Filter</span><span class="symbol">(</span><span class="string">"CRC32"</span><span class="symbol">)),</span>
<span class="normal">	encryption_filter</span><span class="symbol">.</span><span class="function">release</span><span class="symbol">(),</span>
<span class="normal">	</span><span class="keyword">new</span><span class="normal"> </span><span class="function">NullBufferingFilter</span><span class="symbol">(</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">max</span><span class="symbol">&lt;</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="symbol">&gt;(</span><span class="number">4096</span><span class="symbol">,</span><span class="normal"> datalen </span><span class="symbol">/</span><span class="normal"> </span><span class="number">10</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">),</span>
<span class="normal">	</span><span class="keyword">new</span><span class="normal"> </span><span class="function">DataSinkSecureVector</span><span class="symbol">(</span><span class="normal">subfile</span><span class="symbol">.</span><span class="normal">data</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">}</span><span class="symbol">;</span>

<span class="normal">    Botan</span><span class="symbol">::</span><span class="usertype">Pipe</span><span class="normal"> </span><span class="function">pipe</span><span class="symbol">(</span><span class="normal">filters</span><span class="symbol">,</span><span class="normal"> </span><span class="number">4</span><span class="symbol">);</span>

<span class="normal">    pipe</span><span class="symbol">.</span><span class="function">start_msg</span><span class="symbol">();</span>
<span class="normal">    </span><span class="keyword">for</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> dataptr </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> dataptr </span><span class="symbol">&lt;</span><span class="normal"> datalen</span><span class="symbol">;</span><span class="normal"> dataptr </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">8192</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	pipe</span><span class="symbol">.</span><span class="function">write</span><span class="symbol">((</span><span class="keyword">const</span><span class="normal"> Botan</span><span class="symbol">::</span><span class="normal">byte</span><span class="symbol">*)</span><span class="normal">data </span><span class="symbol">+</span><span class="normal"> dataptr</span><span class="symbol">,</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">min</span><span class="symbol">&lt;</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="symbol">&gt;(</span><span class="normal">datalen </span><span class="symbol">-</span><span class="normal"> dataptr</span><span class="symbol">,</span><span class="normal"> </span><span class="number">8192</span><span class="symbol">));</span>
<span class="normal">	progress</span><span class="symbol">.</span><span class="function">Update</span><span class="symbol">(</span><span class="normal">dataptr</span><span class="symbol">);</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="normal">    pipe</span><span class="symbol">.</span><span class="function">end_msg</span><span class="symbol">();</span>
<span class="normal">    progress</span><span class="symbol">.</span><span class="function">Update</span><span class="symbol">(</span><span class="normal">datalen</span><span class="symbol">);</span>

<span class="normal">    Botan</span><span class="symbol">::</span><span class="usertype">SecureVector&lt;Botan::byte&gt;</span><span class="normal"> crc32 </span><span class="symbol">=</span><span class="normal"> pipe</span><span class="symbol">.</span><span class="function">read_all</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">    </span><span class="function">AssertException</span><span class="symbol">(</span><span class="normal">crc32</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="number">4</span><span class="symbol">);</span>
<span class="normal">    subfile</span><span class="symbol">.</span><span class="normal">crc32 </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(</span><span class="keyword">const</span><span class="normal"> uint32_t</span><span class="symbol">*)</span><span class="normal">crc32</span><span class="symbol">.</span><span class="function">begin</span><span class="symbol">();</span>

<span class="normal">    subfile</span><span class="symbol">.</span><span class="normal">storagesize </span><span class="symbol">=</span><span class="normal"> subfile</span><span class="symbol">.</span><span class="normal">data</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">();</span>

<span class="normal">    m_modified </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="keyword">struct</span><span class="normal"> </span><span class="classname">DataOutputString</span><span class="normal"> </span><span class="symbol">:</span><span class="normal"> </span><span class="keyword">public</span><span class="normal"> DataOutput</span>
<span class="cbracket">{</span>
<span class="normal">    std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal">	str</span><span class="symbol">;</span>

<span class="normal">    </span><span class="function">DataOutputString</span><span class="symbol">(</span><span class="normal">std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> s</span><span class="symbol">)</span>
<span class="normal">	</span><span class="symbol">:</span><span class="normal"> </span><span class="function">str</span><span class="symbol">(</span><span class="normal">s</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="keyword">virtual</span><span class="normal"> </span><span class="type">bool</span><span class="normal"> </span><span class="function">Output</span><span class="symbol">(</span><span class="keyword">const</span><span class="normal"> </span><span class="type">void</span><span class="symbol">*</span><span class="normal"> data</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">size_t</span><span class="normal"> datalen</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	str</span><span class="symbol">.</span><span class="function">append</span><span class="symbol">(</span><span class="keyword">static_cast</span><span class="symbol">&lt;</span><span class="keyword">const</span><span class="normal"> </span><span class="type">char</span><span class="symbol">*&gt;(</span><span class="normal">data</span><span class="symbol">),</span><span class="normal"> datalen</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="keyword">true</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="cbracket">}</span><span class="symbol">;</span>

<span class="type">void</span><span class="normal"> ContainerImpl</span><span class="symbol">::</span><span class="function">GetSubFileData</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> subfileindex</span><span class="symbol">,</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> outstr</span><span class="symbol">)</span><span class="normal"> </span><span class="keyword">const</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">subfileindex </span><span class="symbol">&gt;=</span><span class="normal"> m_subfiles</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">())</span>
<span class="normal">	</span><span class="keyword">throw</span><span class="symbol">(</span><span class="function">ProgramError</span><span class="symbol">(</span><span class="normal">ETE_SUBFILE_INVALID_INDEX</span><span class="symbol">));</span>

<span class="normal">    </span><span class="keyword">const</span><span class="normal"> SubFile</span><span class="symbol">&amp;</span><span class="normal"> subfile </span><span class="symbol">=</span><span class="normal"> m_subfiles</span><span class="symbol">[</span><span class="normal">subfileindex</span><span class="symbol">];</span>

<span class="normal">    outstr</span><span class="symbol">.</span><span class="function">clear</span><span class="symbol">();</span>
<span class="normal">    outstr</span><span class="symbol">.</span><span class="function">reserve</span><span class="symbol">(</span><span class="normal">subfile</span><span class="symbol">.</span><span class="normal">realsize</span><span class="symbol">);</span>

<span class="normal">    </span><span class="usertype">DataOutputString</span><span class="normal"> </span><span class="function">dataout</span><span class="symbol">(</span><span class="normal">outstr</span><span class="symbol">);</span>

<span class="normal">    </span><span class="function">GetSubFileData</span><span class="symbol">(</span><span class="normal">subfileindex</span><span class="symbol">,</span><span class="normal"> dataout</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> ContainerImpl</span><span class="symbol">::</span><span class="function">GetSubFileData</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> subfileindex</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">class</span><span class="normal"> </span><span class="classname">DataOutput</span><span class="symbol">&amp;</span><span class="normal"> dataout</span><span class="symbol">)</span><span class="normal"> </span><span class="keyword">const</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">subfileindex </span><span class="symbol">&gt;=</span><span class="normal"> m_subfiles</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">())</span>
<span class="normal">	</span><span class="keyword">throw</span><span class="symbol">(</span><span class="function">ProgramError</span><span class="symbol">(</span><span class="normal">ETE_SUBFILE_INVALID_INDEX</span><span class="symbol">));</span>

<span class="normal">    </span><span class="keyword">const</span><span class="normal"> SubFile</span><span class="symbol">&amp;</span><span class="normal"> subfile </span><span class="symbol">=</span><span class="normal"> m_subfiles</span><span class="symbol">[</span><span class="normal">subfileindex</span><span class="symbol">];</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">subfile</span><span class="symbol">.</span><span class="normal">data</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="keyword">return</span><span class="symbol">;</span>

<span class="normal">    </span><span class="function">AssertException</span><span class="symbol">(</span><span class="normal">subfile</span><span class="symbol">.</span><span class="normal">data</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> subfile</span><span class="symbol">.</span><span class="normal">storagesize</span><span class="symbol">);</span>

<span class="normal">    </span><span class="usertype">ProgressTicker</span><span class="normal"> </span><span class="function">progress</span><span class="symbol">(*</span><span class="keyword">this</span><span class="symbol">,</span>
<span class="normal">			    </span><span class="string">"Loading SubFile"</span><span class="symbol">,</span><span class="normal"> PI_LOAD_SUBFILE</span><span class="symbol">,</span>
<span class="normal">			    </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> subfile</span><span class="symbol">.</span><span class="normal">realsize</span><span class="symbol">);</span>

<span class="normal">    </span><span class="comment">// Setup decryption context if requested</span>

<span class="normal">    std</span><span class="symbol">::</span><span class="usertype">auto_ptr&lt;Botan::Filter&gt;</span><span class="normal"> decryption_filter</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">subfile</span><span class="symbol">.</span><span class="normal">encryption </span><span class="symbol">==</span><span class="normal"> ENCRYPTION_NONE</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="normal">    </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">subfile</span><span class="symbol">.</span><span class="normal">encryption </span><span class="symbol">==</span><span class="normal"> ENCRYPTION_SERPENT256</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="function">AssertException</span><span class="symbol">(</span><span class="normal">subfile</span><span class="symbol">.</span><span class="normal">encdata</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="number">32</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="number">16</span><span class="symbol">);</span>

<span class="normal">	Botan</span><span class="symbol">::</span><span class="usertype">SecureBuffer&lt;Botan::byte, 32&gt;</span><span class="normal"> </span><span class="function">enckey</span><span class="symbol">(</span><span class="normal">subfile</span><span class="symbol">.</span><span class="normal">encdata</span><span class="symbol">.</span><span class="function">begin</span><span class="symbol">(),</span><span class="normal"> </span><span class="number">32</span><span class="symbol">);</span>
<span class="normal">	Botan</span><span class="symbol">::</span><span class="usertype">SecureBuffer&lt;Botan::byte, 16&gt;</span><span class="normal"> </span><span class="function">cbciv</span><span class="symbol">(</span><span class="normal">subfile</span><span class="symbol">.</span><span class="normal">encdata</span><span class="symbol">.</span><span class="function">begin</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="number">32</span><span class="symbol">,</span><span class="normal"> </span><span class="number">16</span><span class="symbol">);</span>

<span class="normal">	decryption_filter </span><span class="symbol">=</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">auto_ptr</span><span class="symbol">&lt;</span><span class="normal">Botan</span><span class="symbol">::</span><span class="normal">Filter</span><span class="symbol">&gt;(</span>
<span class="normal">	    Botan</span><span class="symbol">::</span><span class="function">get_cipher</span><span class="symbol">(</span><span class="string">"Serpent/CBC/PKCS7"</span><span class="symbol">,</span><span class="normal"> enckey</span><span class="symbol">,</span><span class="normal"> cbciv</span><span class="symbol">,</span><span class="normal"> Botan</span><span class="symbol">::</span><span class="normal">DECRYPTION</span><span class="symbol">)</span>
<span class="normal">	    </span><span class="symbol">);</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="normal">    </span><span class="keyword">else</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">throw</span><span class="symbol">(</span><span class="function">RuntimeError</span><span class="symbol">(</span><span class="normal">ETE_SUBFILE_INVALID_ENCRYPTION</span><span class="symbol">));</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="comment">// Setup decompression context if requested</span>

<span class="normal">    std</span><span class="symbol">::</span><span class="usertype">auto_ptr&lt;Botan::Filter&gt;</span><span class="normal"> decompression_filter</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">subfile</span><span class="symbol">.</span><span class="normal">compression </span><span class="symbol">==</span><span class="normal"> COMPRESSION_NONE</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="normal">    </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">subfile</span><span class="symbol">.</span><span class="normal">compression </span><span class="symbol">==</span><span class="normal"> COMPRESSION_ZLIB</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	decompression_filter </span><span class="symbol">=</span><span class="normal">  std</span><span class="symbol">::</span><span class="normal">auto_ptr</span><span class="symbol">&lt;</span><span class="normal">Botan</span><span class="symbol">::</span><span class="normal">Filter</span><span class="symbol">&gt;(</span>
<span class="normal">	    </span><span class="keyword">new</span><span class="normal"> Botan</span><span class="symbol">::</span><span class="function">Zlib_Decompression</span><span class="symbol">()</span>
<span class="normal">	    </span><span class="symbol">);</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="normal">    </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">subfile</span><span class="symbol">.</span><span class="normal">compression </span><span class="symbol">==</span><span class="normal"> COMPRESSION_BZIP2</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	decompression_filter </span><span class="symbol">=</span><span class="normal">  std</span><span class="symbol">::</span><span class="normal">auto_ptr</span><span class="symbol">&lt;</span><span class="normal">Botan</span><span class="symbol">::</span><span class="normal">Filter</span><span class="symbol">&gt;(</span>
<span class="normal">	    </span><span class="keyword">new</span><span class="normal"> Botan</span><span class="symbol">::</span><span class="function">Bzip_Decompression</span><span class="symbol">()</span>
<span class="normal">	    </span><span class="symbol">);</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="normal">    </span><span class="keyword">else</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">throw</span><span class="symbol">(</span><span class="function">RuntimeError</span><span class="symbol">(</span><span class="normal">ETE_SUBFILE_INVALID_COMPRESSION</span><span class="symbol">));</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="comment">// Setup processing pipe</span>

<span class="normal">    Botan</span><span class="symbol">::</span><span class="normal">Filter</span><span class="symbol">*</span><span class="normal"> filters</span><span class="symbol">[</span><span class="number">5</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	decryption_filter</span><span class="symbol">.</span><span class="function">release</span><span class="symbol">(),</span>
<span class="normal">	decompression_filter</span><span class="symbol">.</span><span class="function">release</span><span class="symbol">(),</span>
<span class="normal">	</span><span class="keyword">new</span><span class="normal"> Botan</span><span class="symbol">::</span><span class="function">Fork</span><span class="symbol">(</span><span class="normal">NULL</span><span class="symbol">,</span>
<span class="normal">			</span><span class="keyword">new</span><span class="normal"> Botan</span><span class="symbol">::</span><span class="function">Hash_Filter</span><span class="symbol">(</span><span class="string">"CRC32"</span><span class="symbol">)),</span>
<span class="normal">	</span><span class="keyword">new</span><span class="normal"> </span><span class="function">NullBufferingFilter</span><span class="symbol">(</span><span class="number">4096</span><span class="symbol">),</span>
<span class="normal">	</span><span class="keyword">new</span><span class="normal"> </span><span class="function">DataSink2DataOutput</span><span class="symbol">(</span><span class="normal">dataout</span><span class="symbol">,</span><span class="normal"> progress</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">}</span><span class="symbol">;</span>

<span class="normal">    Botan</span><span class="symbol">::</span><span class="usertype">Pipe</span><span class="normal"> </span><span class="function">pipe</span><span class="symbol">(</span><span class="normal">filters</span><span class="symbol">,</span><span class="normal"> </span><span class="number">5</span><span class="symbol">);</span>
<span class="normal">    pipe</span><span class="symbol">.</span><span class="function">process_msg</span><span class="symbol">(</span><span class="normal">subfile</span><span class="symbol">.</span><span class="normal">data</span><span class="symbol">);</span>

<span class="normal">    Botan</span><span class="symbol">::</span><span class="usertype">SecureVector&lt;Botan::byte&gt;</span><span class="normal"> crc32v </span><span class="symbol">=</span><span class="normal"> pipe</span><span class="symbol">.</span><span class="function">read_all</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">    </span><span class="function">AssertException</span><span class="symbol">(</span><span class="normal">crc32v</span><span class="symbol">.</span><span class="function">size</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="number">4</span><span class="symbol">);</span>

<span class="normal">    </span><span class="usertype">uint32_t</span><span class="normal"> crc32 </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*(</span><span class="keyword">const</span><span class="normal"> uint32_t</span><span class="symbol">*)</span><span class="normal">crc32v</span><span class="symbol">.</span><span class="function">begin</span><span class="symbol">();</span>
<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">subfile</span><span class="symbol">.</span><span class="normal">crc32 </span><span class="symbol">!=</span><span class="normal"> crc32</span><span class="symbol">)</span>
<span class="normal">	</span><span class="keyword">throw</span><span class="symbol">(</span><span class="function">RuntimeError</span><span class="symbol">(</span><span class="normal">ETE_SUBFILE_CHECKSUM</span><span class="symbol">));</span>
<span class="cbracket">}</span>

<span class="cbracket">}</span><span class="normal"> </span><span class="comment">// namespace internal</span>

<span class="comment">// *** Exception Constructors ***</span>

<span class="normal">Exception</span><span class="symbol">::</span><span class="function">Exception</span><span class="symbol">(</span><span class="usertype">error_type</span><span class="normal"> ec</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> m</span><span class="symbol">)</span>
<span class="normal">    </span><span class="symbol">:</span><span class="normal"> </span><span class="function">m_ecode</span><span class="symbol">(</span><span class="normal">ec</span><span class="symbol">),</span><span class="normal"> </span><span class="function">m_msg</span><span class="symbol">(</span><span class="string">"Enctain: "</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> m</span><span class="symbol">)</span>
<span class="cbracket">{</span><span class="normal"> </span><span class="cbracket">}</span>

<span class="normal">RuntimeError</span><span class="symbol">::</span><span class="function">RuntimeError</span><span class="symbol">(</span><span class="usertype">error_type</span><span class="normal"> ec</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> m</span><span class="symbol">)</span>
<span class="normal">    </span><span class="symbol">:</span><span class="normal"> </span><span class="function">Exception</span><span class="symbol">(</span><span class="normal">ec</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"&lt;RuntimeError&gt; "</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> m</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="cbracket">}</span>

<span class="normal">RuntimeError</span><span class="symbol">::</span><span class="function">RuntimeError</span><span class="symbol">(</span><span class="usertype">error_type</span><span class="normal"> ec</span><span class="symbol">)</span>
<span class="normal">    </span><span class="symbol">:</span><span class="normal"> </span><span class="function">Exception</span><span class="symbol">(</span><span class="normal">ec</span><span class="symbol">,</span><span class="normal"> std</span><span class="symbol">::</span><span class="function">string</span><span class="symbol">(</span><span class="string">"&lt;RuntimeError&gt; "</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> Container</span><span class="symbol">::</span><span class="function">GetErrorString</span><span class="symbol">(</span><span class="normal">ec</span><span class="symbol">))</span>
<span class="cbracket">{</span>
<span class="cbracket">}</span>

<span class="normal">ProgramError</span><span class="symbol">::</span><span class="function">ProgramError</span><span class="symbol">(</span><span class="usertype">error_type</span><span class="normal"> ec</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> m</span><span class="symbol">)</span>
<span class="normal">    </span><span class="symbol">:</span><span class="normal"> </span><span class="function">Exception</span><span class="symbol">(</span><span class="normal">ec</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"&lt;ProgramError&gt; "</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> m</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="cbracket">}</span>

<span class="normal">ProgramError</span><span class="symbol">::</span><span class="function">ProgramError</span><span class="symbol">(</span><span class="usertype">error_type</span><span class="normal"> ec</span><span class="symbol">)</span>
<span class="normal">    </span><span class="symbol">:</span><span class="normal"> </span><span class="function">Exception</span><span class="symbol">(</span><span class="normal">ec</span><span class="symbol">,</span><span class="normal"> std</span><span class="symbol">::</span><span class="function">string</span><span class="symbol">(</span><span class="string">"&lt;ProgramError&gt; "</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> Container</span><span class="symbol">::</span><span class="function">GetErrorString</span><span class="symbol">(</span><span class="normal">ec</span><span class="symbol">))</span>
<span class="cbracket">{</span>
<span class="cbracket">}</span>

<span class="normal">InternalError</span><span class="symbol">::</span><span class="function">InternalError</span><span class="symbol">(</span><span class="usertype">error_type</span><span class="normal"> ec</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> m</span><span class="symbol">)</span>
<span class="normal">    </span><span class="symbol">:</span><span class="normal"> </span><span class="function">Exception</span><span class="symbol">(</span><span class="normal">ec</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"&lt;InternalError&gt; "</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> m</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="cbracket">}</span>

<span class="normal">InternalError</span><span class="symbol">::</span><span class="function">InternalError</span><span class="symbol">(</span><span class="usertype">error_type</span><span class="normal"> ec</span><span class="symbol">)</span>
<span class="normal">    </span><span class="symbol">:</span><span class="normal"> </span><span class="function">Exception</span><span class="symbol">(</span><span class="normal">ec</span><span class="symbol">,</span><span class="normal"> std</span><span class="symbol">::</span><span class="function">string</span><span class="symbol">(</span><span class="string">"&lt;InternalError&gt; "</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> Container</span><span class="symbol">::</span><span class="function">GetErrorString</span><span class="symbol">(</span><span class="normal">ec</span><span class="symbol">))</span>
<span class="cbracket">{</span>
<span class="cbracket">}</span>

<span class="comment">// *** Pimpl Stubs for Container ***</span>

<span class="normal">Container</span><span class="symbol">::</span><span class="function">Container</span><span class="symbol">()</span>
<span class="cbracket">{</span>
<span class="normal">    m_pimpl </span><span class="symbol">=</span><span class="normal"> </span><span class="keyword">new</span><span class="normal"> internal</span><span class="symbol">::</span><span class="function">ContainerImpl</span><span class="symbol">();</span>
<span class="cbracket">}</span>

<span class="normal">Container</span><span class="symbol">::~</span><span class="function">Container</span><span class="symbol">()</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">m_pimpl</span><span class="symbol">-&gt;</span><span class="function">DecReference</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">	</span><span class="keyword">delete</span><span class="normal"> m_pimpl</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="normal">Container</span><span class="symbol">::</span><span class="function">Container</span><span class="symbol">(</span><span class="keyword">const</span><span class="normal"> </span><span class="usertype">Container</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">cnt</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    m_pimpl </span><span class="symbol">=</span><span class="normal"> cnt</span><span class="symbol">.</span><span class="normal">m_pimpl</span><span class="symbol">;</span>
<span class="normal">    m_pimpl</span><span class="symbol">-&gt;</span><span class="function">IncReference</span><span class="symbol">();</span>
<span class="cbracket">}</span>

<span class="normal">Container</span><span class="symbol">&amp;</span><span class="normal"> Container</span><span class="symbol">::</span><span class="keyword">operator</span><span class="symbol">=(</span><span class="keyword">const</span><span class="normal"> </span><span class="usertype">Container</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">cnt</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(&amp;</span><span class="normal">cnt </span><span class="symbol">==</span><span class="normal"> </span><span class="keyword">this</span><span class="symbol">)</span><span class="normal"> </span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">*</span><span class="keyword">this</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">m_pimpl</span><span class="symbol">-&gt;</span><span class="function">DecReference</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">	</span><span class="keyword">delete</span><span class="normal"> m_pimpl</span><span class="symbol">;</span>
<span class="normal">    </span>
<span class="normal">    m_pimpl </span><span class="symbol">=</span><span class="normal"> cnt</span><span class="symbol">.</span><span class="normal">m_pimpl</span><span class="symbol">;</span>
<span class="normal">    m_pimpl</span><span class="symbol">-&gt;</span><span class="function">IncReference</span><span class="symbol">();</span>

<span class="normal">    </span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">*</span><span class="keyword">this</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="comment">/* static */</span><span class="normal"> </span><span class="type">void</span><span class="normal"> Container</span><span class="symbol">::</span><span class="function">SetSignature</span><span class="symbol">(</span><span class="keyword">const</span><span class="normal"> </span><span class="type">char</span><span class="symbol">*</span><span class="normal"> sign</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    internal</span><span class="symbol">::</span><span class="normal">ContainerImpl</span><span class="symbol">::</span><span class="function">SetSignature</span><span class="symbol">(</span><span class="normal">sign</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="comment">/* static */</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> </span><span class="type">char</span><span class="symbol">*</span><span class="normal"> Container</span><span class="symbol">::</span><span class="function">GetErrorString</span><span class="symbol">(</span><span class="usertype">error_type</span><span class="normal"> e</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> internal</span><span class="symbol">::</span><span class="normal">ContainerImpl</span><span class="symbol">::</span><span class="function">GetErrorString</span><span class="symbol">(</span><span class="normal">e</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Container</span><span class="symbol">::</span><span class="function">Save</span><span class="symbol">(</span><span class="normal">DataOutput</span><span class="symbol">&amp;</span><span class="normal"> dataout</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> m_pimpl</span><span class="symbol">-&gt;</span><span class="function">Save</span><span class="symbol">(</span><span class="normal">dataout</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Container</span><span class="symbol">::</span><span class="function">Load</span><span class="symbol">(</span><span class="normal">DataInput</span><span class="symbol">&amp;</span><span class="normal"> datain</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> userkey</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> m_pimpl</span><span class="symbol">-&gt;</span><span class="function">Load</span><span class="symbol">(</span><span class="normal">datain</span><span class="symbol">,</span><span class="normal"> userkey</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Container</span><span class="symbol">::</span><span class="function">Clear</span><span class="symbol">()</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> m_pimpl</span><span class="symbol">-&gt;</span><span class="function">Clear</span><span class="symbol">();</span>
<span class="cbracket">}</span>

<span class="type">bool</span><span class="normal"> Container</span><span class="symbol">::</span><span class="function">GetModified</span><span class="symbol">()</span><span class="normal"> </span><span class="keyword">const</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> m_pimpl</span><span class="symbol">-&gt;</span><span class="function">GetModified</span><span class="symbol">();</span>
<span class="cbracket">}</span>

<span class="usertype">size_t</span><span class="normal"> Container</span><span class="symbol">::</span><span class="function">GetLastWritten</span><span class="symbol">()</span><span class="normal"> </span><span class="keyword">const</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> m_pimpl</span><span class="symbol">-&gt;</span><span class="function">GetLastWritten</span><span class="symbol">();</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Container</span><span class="symbol">::</span><span class="function">SetProgressIndicator</span><span class="symbol">(</span><span class="normal">ProgressIndicator</span><span class="symbol">*</span><span class="normal"> pi</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> m_pimpl</span><span class="symbol">-&gt;</span><span class="function">SetProgressIndicator</span><span class="symbol">(</span><span class="normal">pi</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> Container</span><span class="symbol">::</span><span class="function">CountKeySlots</span><span class="symbol">()</span><span class="normal"> </span><span class="keyword">const</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> m_pimpl</span><span class="symbol">-&gt;</span><span class="function">CountKeySlots</span><span class="symbol">();</span>
<span class="cbracket">}</span>

<span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> Container</span><span class="symbol">::</span><span class="function">AddKeySlot</span><span class="symbol">(</span><span class="keyword">const</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> key</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> m_pimpl</span><span class="symbol">-&gt;</span><span class="function">AddKeySlot</span><span class="symbol">(</span><span class="normal">key</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Container</span><span class="symbol">::</span><span class="function">ChangeKeySlot</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> slot</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> key</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> m_pimpl</span><span class="symbol">-&gt;</span><span class="function">ChangeKeySlot</span><span class="symbol">(</span><span class="normal">slot</span><span class="symbol">,</span><span class="normal"> key</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Container</span><span class="symbol">::</span><span class="function">DeleteKeySlot</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> slot</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> m_pimpl</span><span class="symbol">-&gt;</span><span class="function">DeleteKeySlot</span><span class="symbol">(</span><span class="normal">slot</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="type">int</span><span class="normal"> Container</span><span class="symbol">::</span><span class="function">GetUsedKeySlot</span><span class="symbol">()</span><span class="normal"> </span><span class="keyword">const</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> m_pimpl</span><span class="symbol">-&gt;</span><span class="function">GetUsedKeySlot</span><span class="symbol">();</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Container</span><span class="symbol">::</span><span class="function">SetGlobalUnencryptedProperty</span><span class="symbol">(</span><span class="keyword">const</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> key</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> value</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> m_pimpl</span><span class="symbol">-&gt;</span><span class="function">SetGlobalUnencryptedProperty</span><span class="symbol">(</span><span class="normal">key</span><span class="symbol">,</span><span class="normal"> value</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="keyword">const</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> Container</span><span class="symbol">::</span><span class="function">GetGlobalUnencryptedProperty</span><span class="symbol">(</span><span class="keyword">const</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> key</span><span class="symbol">)</span><span class="normal"> </span><span class="keyword">const</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> m_pimpl</span><span class="symbol">-&gt;</span><span class="function">GetGlobalUnencryptedProperty</span><span class="symbol">(</span><span class="normal">key</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="type">bool</span><span class="normal"> Container</span><span class="symbol">::</span><span class="function">DeleteGlobalUnencryptedProperty</span><span class="symbol">(</span><span class="keyword">const</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> key</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> m_pimpl</span><span class="symbol">-&gt;</span><span class="function">DeleteGlobalUnencryptedProperty</span><span class="symbol">(</span><span class="normal">key</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="type">bool</span><span class="normal"> Container</span><span class="symbol">::</span><span class="function">GetGlobalUnencryptedPropertyIndex</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> propindex</span><span class="symbol">,</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> key</span><span class="symbol">,</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> value</span><span class="symbol">)</span><span class="normal"> </span><span class="keyword">const</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> m_pimpl</span><span class="symbol">-&gt;</span><span class="function">GetGlobalUnencryptedPropertyIndex</span><span class="symbol">(</span><span class="normal">propindex</span><span class="symbol">,</span><span class="normal"> key</span><span class="symbol">,</span><span class="normal"> value</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Container</span><span class="symbol">::</span><span class="function">SetGlobalEncryptedProperty</span><span class="symbol">(</span><span class="keyword">const</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> key</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> value</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> m_pimpl</span><span class="symbol">-&gt;</span><span class="function">SetGlobalEncryptedProperty</span><span class="symbol">(</span><span class="normal">key</span><span class="symbol">,</span><span class="normal"> value</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="keyword">const</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> Container</span><span class="symbol">::</span><span class="function">GetGlobalEncryptedProperty</span><span class="symbol">(</span><span class="keyword">const</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> key</span><span class="symbol">)</span><span class="normal"> </span><span class="keyword">const</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> m_pimpl</span><span class="symbol">-&gt;</span><span class="function">GetGlobalEncryptedProperty</span><span class="symbol">(</span><span class="normal">key</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="type">bool</span><span class="normal"> Container</span><span class="symbol">::</span><span class="function">DeleteGlobalEncryptedProperty</span><span class="symbol">(</span><span class="keyword">const</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> key</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> m_pimpl</span><span class="symbol">-&gt;</span><span class="function">DeleteGlobalEncryptedProperty</span><span class="symbol">(</span><span class="normal">key</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="type">bool</span><span class="normal"> Container</span><span class="symbol">::</span><span class="function">GetGlobalEncryptedPropertyIndex</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> propindex</span><span class="symbol">,</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> key</span><span class="symbol">,</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> value</span><span class="symbol">)</span><span class="normal"> </span><span class="keyword">const</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> m_pimpl</span><span class="symbol">-&gt;</span><span class="function">GetGlobalEncryptedPropertyIndex</span><span class="symbol">(</span><span class="normal">propindex</span><span class="symbol">,</span><span class="normal"> key</span><span class="symbol">,</span><span class="normal"> value</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> Container</span><span class="symbol">::</span><span class="function">CountSubFile</span><span class="symbol">()</span><span class="normal"> </span><span class="keyword">const</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> m_pimpl</span><span class="symbol">-&gt;</span><span class="function">CountSubFile</span><span class="symbol">();</span>
<span class="cbracket">}</span>

<span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> Container</span><span class="symbol">::</span><span class="function">AppendSubFile</span><span class="symbol">()</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> m_pimpl</span><span class="symbol">-&gt;</span><span class="function">AppendSubFile</span><span class="symbol">();</span>
<span class="cbracket">}</span>

<span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> Container</span><span class="symbol">::</span><span class="function">InsertSubFile</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> subfileindex</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> m_pimpl</span><span class="symbol">-&gt;</span><span class="function">InsertSubFile</span><span class="symbol">(</span><span class="normal">subfileindex</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="type">bool</span><span class="normal"> Container</span><span class="symbol">::</span><span class="function">DeleteSubFile</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> subfileindex</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> m_pimpl</span><span class="symbol">-&gt;</span><span class="function">DeleteSubFile</span><span class="symbol">(</span><span class="normal">subfileindex</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Container</span><span class="symbol">::</span><span class="function">SetSubFileProperty</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> subfileindex</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> key</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> value</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> m_pimpl</span><span class="symbol">-&gt;</span><span class="function">SetSubFileProperty</span><span class="symbol">(</span><span class="normal">subfileindex</span><span class="symbol">,</span><span class="normal"> key</span><span class="symbol">,</span><span class="normal"> value</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="keyword">const</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> Container</span><span class="symbol">::</span><span class="function">GetSubFileProperty</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> subfileindex</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> key</span><span class="symbol">)</span><span class="normal"> </span><span class="keyword">const</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> m_pimpl</span><span class="symbol">-&gt;</span><span class="function">GetSubFileProperty</span><span class="symbol">(</span><span class="normal">subfileindex</span><span class="symbol">,</span><span class="normal"> key</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="type">bool</span><span class="normal"> Container</span><span class="symbol">::</span><span class="function">DeleteSubFileProperty</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> subfileindex</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> key</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> m_pimpl</span><span class="symbol">-&gt;</span><span class="function">DeleteSubFileProperty</span><span class="symbol">(</span><span class="normal">subfileindex</span><span class="symbol">,</span><span class="normal"> key</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="type">bool</span><span class="normal"> Container</span><span class="symbol">::</span><span class="function">GetSubFilePropertyIndex</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> subfileindex</span><span class="symbol">,</span><span class="normal"> </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> propindex</span><span class="symbol">,</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> key</span><span class="symbol">,</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> value</span><span class="symbol">)</span><span class="normal"> </span><span class="keyword">const</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> m_pimpl</span><span class="symbol">-&gt;</span><span class="function">GetSubFilePropertyIndex</span><span class="symbol">(</span><span class="normal">subfileindex</span><span class="symbol">,</span><span class="normal"> propindex</span><span class="symbol">,</span><span class="normal"> key</span><span class="symbol">,</span><span class="normal"> value</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="usertype">uint32_t</span><span class="normal"> Container</span><span class="symbol">::</span><span class="function">GetSubFileStorageSize</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> subfileindex</span><span class="symbol">)</span><span class="normal"> </span><span class="keyword">const</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> m_pimpl</span><span class="symbol">-&gt;</span><span class="function">GetSubFileStorageSize</span><span class="symbol">(</span><span class="normal">subfileindex</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="usertype">uint32_t</span><span class="normal"> Container</span><span class="symbol">::</span><span class="function">GetSubFileSize</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> subfileindex</span><span class="symbol">)</span><span class="normal"> </span><span class="keyword">const</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> m_pimpl</span><span class="symbol">-&gt;</span><span class="function">GetSubFileSize</span><span class="symbol">(</span><span class="normal">subfileindex</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="usertype">encryption_type</span><span class="normal"> Container</span><span class="symbol">::</span><span class="function">GetSubFileEncryption</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> subfileindex</span><span class="symbol">)</span><span class="normal"> </span><span class="keyword">const</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> m_pimpl</span><span class="symbol">-&gt;</span><span class="function">GetSubFileEncryption</span><span class="symbol">(</span><span class="normal">subfileindex</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="usertype">compression_type</span><span class="normal"> Container</span><span class="symbol">::</span><span class="function">GetSubFileCompression</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> subfileindex</span><span class="symbol">)</span><span class="normal"> </span><span class="keyword">const</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> m_pimpl</span><span class="symbol">-&gt;</span><span class="function">GetSubFileCompression</span><span class="symbol">(</span><span class="normal">subfileindex</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Container</span><span class="symbol">::</span><span class="function">SetSubFileEncryption</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> subfileindex</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">encryption_type</span><span class="normal"> c</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> m_pimpl</span><span class="symbol">-&gt;</span><span class="function">SetSubFileEncryption</span><span class="symbol">(</span><span class="normal">subfileindex</span><span class="symbol">,</span><span class="normal"> c</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Container</span><span class="symbol">::</span><span class="function">SetSubFileCompression</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> subfileindex</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">compression_type</span><span class="normal"> c</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> m_pimpl</span><span class="symbol">-&gt;</span><span class="function">SetSubFileCompression</span><span class="symbol">(</span><span class="normal">subfileindex</span><span class="symbol">,</span><span class="normal"> c</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Container</span><span class="symbol">::</span><span class="function">SetSubFileCompressionEncryption</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> subfileindex</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">compression_type</span><span class="normal"> comp</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">encryption_type</span><span class="normal"> enc</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> m_pimpl</span><span class="symbol">-&gt;</span><span class="function">SetSubFileCompressionEncryption</span><span class="symbol">(</span><span class="normal">subfileindex</span><span class="symbol">,</span><span class="normal"> comp</span><span class="symbol">,</span><span class="normal"> enc</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Container</span><span class="symbol">::</span><span class="function">SetSubFileData</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> subfileindex</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> </span><span class="type">void</span><span class="symbol">*</span><span class="normal"> data</span><span class="symbol">,</span><span class="normal"> </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> datalen</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> m_pimpl</span><span class="symbol">-&gt;</span><span class="function">SetSubFileData</span><span class="symbol">(</span><span class="normal">subfileindex</span><span class="symbol">,</span><span class="normal"> data</span><span class="symbol">,</span><span class="normal"> datalen</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Container</span><span class="symbol">::</span><span class="function">GetSubFileData</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> subfileindex</span><span class="symbol">,</span><span class="normal"> std</span><span class="symbol">::</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> outstr</span><span class="symbol">)</span><span class="normal"> </span><span class="keyword">const</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> m_pimpl</span><span class="symbol">-&gt;</span><span class="function">GetSubFileData</span><span class="symbol">(</span><span class="normal">subfileindex</span><span class="symbol">,</span><span class="normal"> outstr</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> Container</span><span class="symbol">::</span><span class="function">GetSubFileData</span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> subfileindex</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">class</span><span class="normal"> </span><span class="classname">DataOutput</span><span class="symbol">&amp;</span><span class="normal"> dataout</span><span class="symbol">)</span><span class="normal"> </span><span class="keyword">const</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> m_pimpl</span><span class="symbol">-&gt;</span><span class="function">GetSubFileData</span><span class="symbol">(</span><span class="normal">subfileindex</span><span class="symbol">,</span><span class="normal"> dataout</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="cbracket">}</span><span class="normal"> </span><span class="comment">// namespace Enctain</span>
</tt></pre></div><div style="text-align: right; padding: 8pt; font-size: 12px"><a href="/xmlfeed/weblog-rss20.xml"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAAAPAgMAAAAOp6AcAAAADFBMVEVmZmb/ZgD///+JjnlbTUWmAAAACXBIWXMAAABIAAAASABGyWs+AAAACXZwQWcAAABQAAAADwCexKkxAAAAWUlEQVQYlWNgwAa0VmGAFQyqoSCQ/x8J/CBFMCt0ZdTU/F/7/+1HEkydFpoKVPn+93sUlUujQvP/7UcRTAuNDJ2a//s/imDqtKVZofm/1qGYSZk7sfodGwAAiobBJtffoNAAAAAASUVORK5CYII=" alt="RSS 2.0 Weblog Feed" width="80" height="15"/></a> <a href="/xmlfeed/weblog-atom10.xml"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAAAPAgMAAAAOp6AcAAAADFBMVEVmZmb/ZgD///+JjnlbTUWmAAAAaklEQVQYlWNgwAa0VmGAFQyqoSCQ/x8J/CBFMDV16rTQ/H/7V//69+//v/3/9oMEI6cuAwr+fv/+/b5d///v//0eJBgWOhMo+Gs9UPAdXDBy6lSYyn9wQZCZS0GCYDPXQcykzJ1Y/Y4NAABKvL80wyoMPgAAAABJRU5ErkJggg==" alt="Atom 1.0 Weblog Feed" width="80" height="15"/></a> <a href="http://validator.w3.org/check?uri=referer"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAAAPCAMAAABEF7i9AAAB1FBMVEUHQIgIRY0MN4QNRYoSRYsXUpIYVJQeUpUhWpgjUJMjWpgmU5QnXJkuYZ0uYpwwV5YyZJ4zaKM3ZaA5aaI6aqM6a6E8ZqA8Z6BAbaRBbqdCbaVHd61KSkpKcaZQUFBUf69UgbBVVVVXfq9Yg7NZhbJZh7RagrNeXVxeh7RfjLdgYGBiiLZmZmZnZ2doirhpkbt0m8F3m8B3ncJ5lb55ocR+ocSDgX+Do8eEpMqGhoaHp8iIpMeJjnmJpseKqMeOqsqPsdCQrcyVlZWVsM2Zs9CZtNCfu9ahoaGhuNShudSivNSjtMWjvNSmpqWnpqSrw9qvxNqyxdmyxdyzsK6zs7Ozx9y0xt21yN22tra4y+K80eK/v7/AwMDExMTEy9DH2ejK2+jM2ujN3uvP0dLR0NDR3uvS3uvS3+zU4u3V1dXY2dnY4u7Y4+3b5e/d3d3d5u/d5/De3t7f39/h4uLj4uHj6/Ll7PXm7fTn7/Xo7/Tp7/bq7Ozr6unr8ffw8PDw9vvx9fny+P7z8/Pz9vnz9vv3+fv4+vz5+vz6+vr6+/36/P36///7+/77/Pz7/f37/f78/Pz8/f38/f79/f39/f79/f/9/v79///+/v7+/v////3///+tYR2LAAABKklEQVQ4y2PQoTJg0JlNVYDPQBsyAMTAqaFes8tdsmdPCtA3MDStr3GKKK6myMAprgJ9pcpWs/MlRExYJBvNZLR0sigycHYOV1S7mtjsQJ4gf+HIFPXoWMs6qIGzIRiKZs9GFoEaMRuZhhrYqqJXy8uZYauRxC/VHew7e3YTPAxnI5swG6JxNrKBNjB1EFmIgV0+HA6C8pqqzhXG7BbJJROQIwViMYQ7G2oDQQNn57JyG7kxiCfObrBmS5+BHMuYLkTzMnYDm5WY4lOZZRPKZocxes+aPbuwCFsYohiICLvZsKBAMrDTQ7K/StveU8icTzrOL8JdLpOyWJ49u8Bx9ozw8DY7UYW03hhdxZAOSg2c3jN79rSJs1vSKmfOnpFXNJmynELlvExlAADnaZpLFGEC2wAAAABJRU5ErkJggg==" alt="Valid XHTML 1.1" width="80" height="15"/></a> <a href="http://jigsaw.w3.org/css-validator/check/referer"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAAAPCAMAAABEF7i9AAAB1FBMVEUHQIgIRY0MN4QNRYoSRYsXUpIYVJQeUpUhWpgjUJMjWpgmU5QnXJkuYZ0uYpwwV5YyZJ4zaKM3ZaA5aaI6aqM6a6E8ZqA8Z6BAbaRBbqdCbaVHd61KSkpKcaZQUFBUf69UgbBVVVVXfq9Yg7NZhbJZh7RagrNeXVxeh7RfjLdgYGBiiLZmZmZnZ2doirhpkbt0m8F3m8B3ncJ5lb55ocR+ocSDgX+Do8eEpMqGhoaHp8iIpMeJjnmJpseKqMeOqsqPsdCQrcyVlZWVsM2Zs9CZtNCfu9ahoaGhuNShudSivNSjtMWjvNSmpqWnpqSrw9qvxNqyxdmyxdyzsK6zs7Ozx9y0xt21yN22tra4y+K80eK/v7/AwMDExMTEy9DH2ejK2+jM2ujN3uvP0dLR0NDR3uvS3uvS3+zU4u3V1dXY2dnY4u7Y4+3b5e/d3d3d5u/d5/De3t7f39/h4uLj4uHj6/Ll7PXm7fTn7/Xo7/Tp7/bq7Ozr6unr8ffw8PDw9vvx9fny+P7z8/Pz9vnz9vv3+fv4+vz5+vz6+vr6+/36/P36///7+/77/Pz7/f37/f78/Pz8/f38/f79/f39/f79/f/9/v79///+/v7+/v////3///+tYR2LAAABEUlEQVQ4y2PQoTJg0JlNVYDPQBsyAMTAqaFes8tdsmdPCtA3MDStr3GKKK6myMAprgJ9pcpWs/MlRExYJBvNZLR0sigycHYOV1S7mtjsQJ4gf+HIFPXoWMs6mIEQCsIjwhKoga0qerW8nBm2Gkn8Ut3BvrNnN8HCcDYM2cBIogzs8uFwEJTXVHWuMGa3SC6ZgIgUqCEwdxJr4OxcVm4jNwbxxNkN1mzpM2ajGIjsPGK9PLtZiSk+lVk2oWx2GKP3rNmzC4tQwpDoIIQb2Okh2V+lbe8pZM4nHecX4S6XSVksz55d4Dh7Rnh4m52oQlpvjK5iSAelBk7vmT172sTZLWmVM2fPyCuaTFlOoXJepjIAANlljDGY/l5pAAAAAElFTkSuQmCC" alt="Valid CSS (2.1)" width="80" height="15"/></a><br/>Copyright 2005-2014 <a href="/about/">Timo Bingmann</a> - <a href="/about/impressum.html">Impressum</a></div><script type="text/javascript">var _paq = _paq || []; _paq.push(["trackPageView"]); _paq.push(["enableLinkTracking"]);(function() {var u=(("https:" == document.location.protocol) ? "https" : "http") + "://panthema.net/wik-331/"; _paq.push(["setTrackerUrl", u+"js/"]); _paq.push(["setSiteId", "2"]);var d=document, g=d.createElement("script"), s=d.getElementsByTagName("script")[0]; g.type="text/javascript";g.defer=true; g.async=true; g.src=u+"js/"; s.parentNode.insertBefore(g,s);})();</script><noscript><p><img src="http://panthema.net/wik-331/js/?idsite=2&amp;rec=1" style="border:0" alt="" /></p></noscript></body></html>