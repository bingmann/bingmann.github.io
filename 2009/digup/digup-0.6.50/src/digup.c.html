<?xml version="1.0" encoding="iso-8859-1"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta content="text/html; charset=iso-8859-1" http-equiv="content-type" /><meta name="viewport" content="initial-scale=1"><title>/2009/digup/digup-0.6.50/src/digup.c - panthema.net</title><link rel="stylesheet" type="text/css" href="/css/base.css" /><link rel="stylesheet" type="text/css" href="/css/fonts.css" /><link rel="alternate" type="application/rss+xml" title="panthema.net Weblog Feed RSS 2.0" href="https://panthema.net/xmlfeed/weblog-rss20.xml" /><link rel="alternate" type="application/atom+xml" title="panthema.net Weblog Feed Atom 1.0" href="https://panthema.net/xmlfeed/weblog-atom10.xml" /><script type="text/javascript" src="/js/base.js"></script><script type="text/javascript">/* <!-- */makeIEHover = function() {var lis = document.getElementById('ptnav').getElementsByTagName('li');for (var i = 0; i < lis.length; i++) {lis[i].onmouseover = function() {this.className += ' sfhover';};lis[i].onmouseout = function() {this.className = this.className.replace(new RegExp(' sfhover\b'), '');};}};if (window.attachEvent) window.attachEvent('onload', makeIEHover);/* --> */</script></head><body lang="en"><div class="pttopbar"><div style="float: right"><ul id="ptnav"><li class="top"><a class="ni" href="/timeline/"><i class="icon-book"></i> Weblog</a><ul style="margin-left: -6px; margin-top: 4px" class="nx"><li><a href="/2020/">2020</a></li><li><a href="/2019/">2019</a></li><li><a href="/2018/">2018</a></li><li><a href="/2017/">2017</a></li><li><a href="/2016/">2016</a></li><li><a href="/2015/">2015</a></li><li><a href="/2014/">2014</a></li><li><a href="/2013/">2013</a></li><li><a href="/2012/">2012</a></li><li><a href="/2011/">2011</a></li><li><a href="/2010/">2010</a></li><li><a href="/2009/">2009</a></li><li><a href="/2008/">2008</a></li><li><a href="/2007/">2007</a></li><li><a href="/2006/">2006</a></li><li class="nt"><a href="/2005/">2005</a></li><li class="ns"><a href="/xmlfeed/weblog-rss20.xml">RSS Feed</a></li><li class="nt"><a href="/xmlfeed/weblog-atom10.xml">XML Atom</a></li></ul></li><li class="top"> <a class="ni" href="/tags/"><i class="icon-tags"></i> Tags</a></li><li class="top"> <a class="ni" href="#"><i class="icon-cubes"></i> Projects</a> <ul style="margin-left: -8em; margin-top: 4px;" class="nx"> <li><a href="/2019/1008-COBS-A-Compact-Bit-Sliced-Signature-Index/">COBS</a></li> <li><a href="/2009/cryptote/">CryptoTE</a></li> <li><a href="/2009/digup/">digup</a></li> <li><a href="/2013/disk-filltest/">disk-filltest</a></li> <li><a href="/2012/1119-eSAIS-Inducing-Suffix-and-LCP-Arrays-in-External-Memory/">eSAIS-LCP</a></li> <li><a href="/2007/flex-bison-cpp-example/">Flex Bison C++ Example</a></li> <li><a href="/2013/malloc_count/">malloc_count</a></li> <li><a href="/2016/0114-diploma-thesis/">On Bispanning Graphs</a></li> <li><a href="/2013/pmbw/">Parallel Memory Bandwidth</a></li> <li><a href="/2013/parallel-string-sorting/">Parallel String Sorting</a></li> <li><a href="/2014/sqlplot-tools/">SqlPlotTools</a></li> <li><a href="/2013/sound-of-sorting/">The Sound of Sorting</a></li> <li><a href="/2007/stx-btree/">STX B+ Tree</a></li> <li><a href="/2010/stx-cbtreedb/">STX Constant BTreeDB</a></li> <li><a href="/2010/stx-execpipe/">STX ExecPipe</a></li> <li><a href="/2007/stx-exparser/">STX Expression Parser</a></li> <li><a href="/tags/stxxl.html">STXXL 1.4</a></li> <li><a href="/tags/thrill.html">Thrill - Big Data Framework</a></li> <li class="nt"><a href="/2014/vncrec-rgb/">VNCrec RGB 0.4</a></li> </ul></li><li class="top"> <a class="ni" href="/publications.html"><i class="icon-graduation-cap"></i> Publications</a></li><li class="top"> <a class="ni" href="/search.html"><i class="icon-search"></i> Search</a></li><li class="top"> <a class="ni" href="/subscribe.html"><i class="icon-rss-squared"></i> Subscribe</a></li><li class="top"> <a class="ni" href="/about/"><i class="icon-info-circled"></i> About</a></li></ul></div><div style="padding: 6px"><a href="/">panthema</a>  / <a href="/2009/">2009</a> / <a href="/2009/digup/">digup</a> / <a href="/2009/digup/digup-0.6.50/">digup-0.6.50</a> / <a href="/2009/digup/digup-0.6.50/src/">src</a> / <a href="/2009/digup/digup-0.6.50/src/digup.c.html">digup.c</a> (<a href="/2009/digup/digup-0.6.50/src/digup.c">Download File</a>)</div></div><div class="ptfullwidth"><pre class="codesnippet" style="font-family: monospace"><tt><span class="comment">/*****************************************************************************</span>
<span class="comment"> * digup.c - Digest File Updating Program                                    *</span>
<span class="comment"> *                                                                           *</span>
<span class="comment"> * Copyright (C) 2010-2020 Timo Bingmann                                     *</span>
<span class="comment"> *                                                                           *</span>
<span class="comment"> * This program is free software; you can redistribute it and/or modify it   *</span>
<span class="comment"> * under the terms of the GNU General Public License as published by the     *</span>
<span class="comment"> * Free Software Foundation; either version 3, or (at your option) any       *</span>
<span class="comment"> * later version.                                                            *</span>
<span class="comment"> *                                                                           *</span>
<span class="comment"> * This program is distributed in the hope that it will be useful,           *</span>
<span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of            *</span>
<span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the             *</span>
<span class="comment"> * GNU General Public License for more details.                              *</span>
<span class="comment"> *                                                                           *</span>
<span class="comment"> * You should have received a copy of the GNU General Public License         *</span>
<span class="comment"> * along with this program; if not, write to the Free Software Foundation,   *</span>
<span class="comment"> * Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.        *</span>
<span class="comment"> *****************************************************************************/</span>

<span class="comment">/* $Id$ */</span>

<span class="preproc">#include</span><span class="normal"> </span><span class="string">&lt;assert.h&gt;</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">&lt;ctype.h&gt;</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">&lt;dirent.h&gt;</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">&lt;errno.h&gt;</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">&lt;fcntl.h&gt;</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">&lt;getopt.h&gt;</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">&lt;stdarg.h&gt;</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">&lt;stdio.h&gt;</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">&lt;stdlib.h&gt;</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">&lt;string.h&gt;</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">&lt;sys/stat.h&gt;</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">&lt;sys/types.h&gt;</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">&lt;time.h&gt;</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">&lt;unistd.h&gt;</span>

<span class="preproc">#include</span><span class="normal"> </span><span class="string">"digest.h"</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">"rbtree.h"</span>

<span class="comment">/**************************</span>
<span class="comment"> * Basic Type Definitions *</span>
<span class="comment"> **************************/</span>

<span class="keyword">typedef</span><span class="normal"> </span><span class="keyword">enum</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal"> FALSE</span><span class="symbol">,</span><span class="normal"> TRUE </span><span class="cbracket">}</span><span class="normal"> </span><span class="type">bool</span><span class="symbol">;</span>

<span class="keyword">enum</span><span class="normal"> DigestType </span><span class="cbracket">{</span><span class="normal"> DT_NONE</span><span class="symbol">,</span><span class="normal"> DT_MD5</span><span class="symbol">,</span><span class="normal"> DT_SHA1</span><span class="symbol">,</span><span class="normal"> DT_SHA256</span><span class="symbol">,</span><span class="normal"> DT_SHA512 </span><span class="cbracket">}</span><span class="symbol">;</span>

<span class="keyword">enum</span><span class="normal"> FileStatus</span>
<span class="cbracket">{</span>
<span class="normal">    FS_UNSEEN</span><span class="symbol">,</span><span class="normal">	</span><span class="comment">/* in digest file but not seen on fs yet. */</span>
<span class="normal">    FS_SEEN</span><span class="symbol">,</span><span class="normal">    </span><span class="comment">/* in digest file and seen on fs with equal mtime. */</span>
<span class="normal">    FS_NEW</span><span class="symbol">,</span><span class="normal">	</span><span class="comment">/* newly seen file on fs. */</span>
<span class="normal">    FS_TOUCHED</span><span class="symbol">,</span><span class="normal">	</span><span class="comment">/* identical in digest file and fs but with different mtime. */</span>
<span class="normal">    FS_CHANGED</span><span class="symbol">,</span><span class="normal">	</span><span class="comment">/* in digest file but modified on fs. */</span>
<span class="normal">    FS_ERROR</span><span class="symbol">,</span><span class="normal">   </span><span class="comment">/* error while reading file. */</span>
<span class="normal">    FS_COPIED</span><span class="symbol">,</span><span class="normal">  </span><span class="comment">/* copied within tree. */</span>
<span class="normal">    FS_RENAMED</span><span class="symbol">,</span><span class="normal"> </span><span class="comment">/* renamed within tree. */</span>
<span class="normal">    FS_OLDPATH</span><span class="symbol">,</span><span class="normal"> </span><span class="comment">/* original entry of a renamed file */</span>
<span class="normal">    FS_SKIPPED  </span><span class="comment">/* skipped due to --restrict */</span>
<span class="cbracket">}</span><span class="symbol">;</span>

<span class="keyword">struct</span><span class="normal"> </span><span class="classname">FileInfo</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">enum</span><span class="normal"> </span><span class="usertype">FileStatus</span><span class="normal">	status</span><span class="symbol">;</span>
<span class="normal">    </span><span class="usertype">time_t</span><span class="normal">		mtime</span><span class="symbol">;</span>
<span class="normal">    </span><span class="type">long</span><span class="normal"> </span><span class="type">long</span><span class="normal">		size</span><span class="symbol">;</span>
<span class="normal">    </span><span class="type">char</span><span class="symbol">*</span><span class="normal">		error</span><span class="symbol">;</span>
<span class="normal">    digest_result</span><span class="symbol">*</span><span class="normal">	digest</span><span class="symbol">;</span>
<span class="normal">    </span><span class="type">char</span><span class="symbol">*</span><span class="normal">               symlink</span><span class="symbol">;</span><span class="normal"> </span><span class="comment">/* target actually */</span>
<span class="normal">    </span><span class="type">char</span><span class="symbol">*</span><span class="normal">               oldpath</span><span class="symbol">;</span><span class="normal"> </span><span class="comment">/* for renamed or copied files. */</span>
<span class="cbracket">}</span><span class="symbol">;</span>

<span class="comment">/********************************</span>
<span class="comment"> * Global Variables and Options *</span>
<span class="comment"> ********************************/</span>

<span class="keyword">const</span><span class="normal"> </span><span class="type">char</span><span class="symbol">*</span><span class="normal"> g_progname </span><span class="symbol">=</span><span class="normal"> NULL</span><span class="symbol">;</span>

<span class="comment">/* various parameters set by the command line parameters */</span>

<span class="type">int</span><span class="normal"> gopt_verbose </span><span class="symbol">=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="type">bool</span><span class="normal"> gopt_batch </span><span class="symbol">=</span><span class="normal"> FALSE</span><span class="symbol">;</span>
<span class="type">bool</span><span class="normal"> gopt_fullcheck </span><span class="symbol">=</span><span class="normal"> FALSE</span><span class="symbol">;</span>
<span class="type">bool</span><span class="normal"> gopt_followsymlinks </span><span class="symbol">=</span><span class="normal"> FALSE</span><span class="symbol">;</span>
<span class="type">bool</span><span class="normal"> gopt_onlymodified </span><span class="symbol">=</span><span class="normal"> FALSE</span><span class="symbol">;</span>
<span class="type">bool</span><span class="normal"> gopt_update </span><span class="symbol">=</span><span class="normal"> FALSE</span><span class="symbol">;</span>
<span class="type">char</span><span class="symbol">*</span><span class="normal"> gopt_digestfile </span><span class="symbol">=</span><span class="normal"> NULL</span><span class="symbol">;</span>
<span class="keyword">enum</span><span class="normal"> </span><span class="usertype">DigestType</span><span class="normal"> gopt_digesttype </span><span class="symbol">=</span><span class="normal"> DT_NONE</span><span class="symbol">;</span>
<span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> gopt_modify_window </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="keyword">const</span><span class="normal"> </span><span class="type">char</span><span class="symbol">*</span><span class="normal"> gopt_exclude_marker </span><span class="symbol">=</span><span class="normal"> NULL</span><span class="symbol">;</span>
<span class="keyword">const</span><span class="normal"> </span><span class="type">char</span><span class="symbol">*</span><span class="normal"> gopt_matchpattern </span><span class="symbol">=</span><span class="normal"> NULL</span><span class="symbol">;</span>

<span class="comment">/* red-black tree mapping filename string -&gt; struct FileInfo */</span>

<span class="keyword">struct</span><span class="normal"> </span><span class="classname">rb_tree</span><span class="symbol">*</span><span class="normal"> g_filelist </span><span class="symbol">=</span><span class="normal"> NULL</span><span class="symbol">;</span>

<span class="comment">/* red-black tree mapping digest_result -&gt; filename string */</span>

<span class="keyword">struct</span><span class="normal"> </span><span class="classname">rb_tree</span><span class="symbol">*</span><span class="normal"> g_filedigestmap </span><span class="symbol">=</span><span class="normal"> NULL</span><span class="symbol">;</span>

<span class="comment">/* file status counters */</span>

<span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> g_filelist_seen </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> g_filelist_new </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> g_filelist_touched </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> g_filelist_changed </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> g_filelist_error </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> g_filelist_copied </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> g_filelist_renamed </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> g_filelist_oldpath </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> g_filelist_skipped </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="comment">/**********************************</span>
<span class="comment"> * Helper Functions and Utilities *</span>
<span class="comment"> **********************************/</span>

<span class="comment">/* functional for the g_filelist red-black tree */</span>
<span class="type">void</span><span class="normal"> </span><span class="function">rbtree_string_free</span><span class="symbol">(</span><span class="type">void</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">a</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="function">free</span><span class="symbol">((</span><span class="type">char</span><span class="symbol">*)</span><span class="normal">a</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="comment">/* functional for the g_filelist red-black tree */</span>
<span class="type">void</span><span class="normal"> </span><span class="function">rbtree_fileinfo_free</span><span class="symbol">(</span><span class="type">void</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">a</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">FileInfo</span><span class="symbol">*</span><span class="normal"> fileinfo </span><span class="symbol">=</span><span class="normal"> a</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">fileinfo</span><span class="symbol">-&gt;</span><span class="normal">error</span><span class="symbol">)</span>
<span class="normal">	</span><span class="function">free</span><span class="symbol">(</span><span class="normal">fileinfo</span><span class="symbol">-&gt;</span><span class="normal">error</span><span class="symbol">);</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">fileinfo</span><span class="symbol">-&gt;</span><span class="normal">digest</span><span class="symbol">)</span>
<span class="normal">	</span><span class="function">free</span><span class="symbol">(</span><span class="normal">fileinfo</span><span class="symbol">-&gt;</span><span class="normal">digest</span><span class="symbol">);</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">fileinfo</span><span class="symbol">-&gt;</span><span class="normal">symlink</span><span class="symbol">)</span>
<span class="normal">	</span><span class="function">free</span><span class="symbol">(</span><span class="normal">fileinfo</span><span class="symbol">-&gt;</span><span class="normal">symlink</span><span class="symbol">);</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">fileinfo</span><span class="symbol">-&gt;</span><span class="normal">oldpath</span><span class="symbol">)</span>
<span class="normal">	</span><span class="function">free</span><span class="symbol">(</span><span class="normal">fileinfo</span><span class="symbol">-&gt;</span><span class="normal">oldpath</span><span class="symbol">);</span>

<span class="normal">    </span><span class="function">free</span><span class="symbol">(</span><span class="normal">fileinfo</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="comment">/* functional for the g_filelist red-black tree */</span>
<span class="type">void</span><span class="normal"> </span><span class="function">rbtree_digest_result_free</span><span class="symbol">(</span><span class="type">void</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">a</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="function">free</span><span class="symbol">((</span><span class="normal">digest_result</span><span class="symbol">*)</span><span class="normal">a</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="comment">/* functional for the g_filelist red-black tree */</span>
<span class="type">void</span><span class="normal"> </span><span class="function">rbtree_null_free</span><span class="symbol">(</span><span class="type">void</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">a</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="symbol">(</span><span class="type">void</span><span class="symbol">)</span><span class="normal">a</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="comment">/* functional for the g_filelist red-black tree */</span>
<span class="type">int</span><span class="normal"> </span><span class="function">rbtree_string_cmp</span><span class="symbol">(</span><span class="keyword">const</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">a</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">b</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> </span><span class="function">strcmp</span><span class="symbol">((</span><span class="keyword">const</span><span class="normal"> </span><span class="type">char</span><span class="symbol">*)</span><span class="normal">a</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">(</span><span class="keyword">const</span><span class="normal"> </span><span class="type">char</span><span class="symbol">*)</span><span class="normal">b</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="comment">/* functional for the g_filelist red-black tree */</span>
<span class="type">int</span><span class="normal"> </span><span class="function">rbtree_digest_result_cmp</span><span class="symbol">(</span><span class="keyword">const</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">a</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">b</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> </span><span class="function">digest_cmp</span><span class="symbol">((</span><span class="keyword">const</span><span class="normal"> digest_result</span><span class="symbol">*)</span><span class="normal">a</span><span class="symbol">,</span><span class="normal">	</span>
<span class="normal">		      </span><span class="symbol">(</span><span class="keyword">const</span><span class="normal"> digest_result</span><span class="symbol">*)</span><span class="normal">b</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="comment">/* functional for qsort() on a char* array */</span>
<span class="keyword">static</span><span class="normal"> </span><span class="type">int</span><span class="normal"> </span><span class="function">strcmpptr</span><span class="symbol">(</span><span class="keyword">const</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">p1</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">p2</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> </span><span class="function">strcmp</span><span class="symbol">(*(</span><span class="type">char</span><span class="symbol">**)</span><span class="normal">p1</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">*(</span><span class="type">char</span><span class="symbol">**)</span><span class="normal">p2</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="comment">/* simple strndup() replacement if not in standard library. */</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="symbol">!</span><span class="normal">HAVE_STRNDUP</span>
<span class="keyword">static</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="function">strndup</span><span class="symbol">(</span><span class="keyword">const</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">str</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">size_t</span><span class="normal"> len</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="type">char</span><span class="symbol">*</span><span class="normal"> out </span><span class="symbol">=</span><span class="normal"> </span><span class="function">malloc</span><span class="symbol">(</span><span class="normal">len </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">    </span><span class="function">strncpy</span><span class="symbol">(</span><span class="normal">out</span><span class="symbol">,</span><span class="normal"> str</span><span class="symbol">,</span><span class="normal"> len</span><span class="symbol">);</span>
<span class="normal">    out</span><span class="symbol">[</span><span class="normal">len</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> out</span><span class="symbol">;</span>
<span class="cbracket">}</span>
<span class="preproc">#endif</span>

<span class="comment">/* simple asprintf() replacement if not in standard library. */</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="symbol">!</span><span class="normal">HAVE_ASPRINTF</span>
<span class="keyword">static</span><span class="normal"> </span><span class="type">int</span><span class="normal"> </span><span class="function">asprintf</span><span class="symbol">(</span><span class="type">char</span><span class="normal"> </span><span class="symbol">**</span><span class="normal">strp</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">fmt</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">...)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="usertype">va_list</span><span class="normal"> ap</span><span class="symbol">;</span>
<span class="normal">    </span><span class="usertype">ssize_t</span><span class="normal"> len</span><span class="symbol">;</span>
<span class="normal">    </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">out</span><span class="symbol">;</span>

<span class="normal">    </span><span class="function">va_start</span><span class="symbol">(</span><span class="normal">ap</span><span class="symbol">,</span><span class="normal"> fmt</span><span class="symbol">);</span>
<span class="normal">    len </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vsnprintf</span><span class="symbol">(</span><span class="normal">NULL</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> fmt</span><span class="symbol">,</span><span class="normal"> ap</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">    </span><span class="function">va_end</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ap</span><span class="symbol">);</span>

<span class="normal">    out </span><span class="symbol">=</span><span class="normal"> </span><span class="function">malloc</span><span class="symbol">(</span><span class="normal">len</span><span class="symbol">);</span>
<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">out </span><span class="symbol">==</span><span class="normal"> NULL</span><span class="symbol">)</span><span class="normal"> </span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">;</span>

<span class="normal">    </span><span class="function">va_start</span><span class="symbol">(</span><span class="normal">ap</span><span class="symbol">,</span><span class="normal"> fmt</span><span class="symbol">);</span>
<span class="normal">    len </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vsnprintf</span><span class="symbol">(</span><span class="normal">out</span><span class="symbol">,</span><span class="normal"> len</span><span class="symbol">,</span><span class="normal"> fmt</span><span class="symbol">,</span><span class="normal"> ap</span><span class="symbol">);</span>
<span class="normal">    </span><span class="function">va_end</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ap</span><span class="symbol">);</span>
<span class="normal">    </span><span class="symbol">*</span><span class="normal">strp </span><span class="symbol">=</span><span class="normal"> out</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">return</span><span class="normal"> len</span><span class="symbol">;</span>
<span class="cbracket">}</span>
<span class="preproc">#endif</span>

<span class="comment">/* select correct struct stat and functions for 64-bit file sizes in mingw */</span>
<span class="preproc">#if</span><span class="normal"> ON_WIN32</span>

<span class="keyword">typedef</span><span class="normal"> </span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">__stat64</span><span class="normal">	mystatst</span><span class="symbol">;</span>

<span class="preproc">#define</span><span class="normal"> mystat		_stat64</span>
<span class="preproc">#define</span><span class="normal"> mylstat		_stat64</span>

<span class="preproc">#else</span><span class="normal"> </span><span class="comment">/* for sane systems */</span>

<span class="keyword">typedef</span><span class="normal"> </span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">stat</span><span class="normal">	mystatst</span><span class="symbol">;</span>

<span class="preproc">#define</span><span class="normal"> mystat 		stat</span>

<span class="preproc">#if</span><span class="normal"> </span><span class="symbol">!</span><span class="normal">HAVE_LSTAT</span>
<span class="preproc">#define</span><span class="normal"> mylstat 	stat</span>
<span class="preproc">#else</span>
<span class="preproc">#define</span><span class="normal"> mylstat 	lstat</span>
<span class="preproc">#endif</span>

<span class="preproc">#endif</span>

<span class="comment">/* not so simple getline() replacement from xine-ui code. */</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="symbol">!</span><span class="normal">HAVE_GETLINE</span>

<span class="preproc">#define</span><span class="normal"> GETLINE_BLOCK_SIZE </span><span class="number">128</span>

<span class="keyword">static</span><span class="normal"> </span><span class="usertype">ssize_t</span><span class="normal"> </span><span class="function">getdelims</span><span class="symbol">(</span><span class="type">char</span><span class="normal"> </span><span class="symbol">**</span><span class="normal">lineptr</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">size_t</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">n</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">delims</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">FILE</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">stream</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="type">void</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">tmp</span><span class="symbol">;</span>
<span class="normal">    </span><span class="keyword">const</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">d</span><span class="symbol">;</span>
<span class="normal">    </span><span class="type">int</span><span class="normal"> c</span><span class="symbol">;</span>
<span class="normal">    </span><span class="usertype">size_t</span><span class="normal"> i</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">lineptr </span><span class="symbol">||</span><span class="normal"> </span><span class="symbol">!</span><span class="normal">n </span><span class="symbol">||</span><span class="normal"> </span><span class="symbol">!</span><span class="normal">delims </span><span class="symbol">||</span><span class="normal"> </span><span class="symbol">!</span><span class="normal">stream</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	errno </span><span class="symbol">=</span><span class="normal"> EINVAL</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!*</span><span class="normal">lineptr</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">n </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">    i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">c </span><span class="symbol">=</span><span class="normal"> </span><span class="function">fgetc</span><span class="symbol">(</span><span class="normal">stream</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> EOF</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">n</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">tmp </span><span class="symbol">=</span><span class="normal"> </span><span class="function">realloc</span><span class="symbol">(*</span><span class="normal">lineptr</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">n </span><span class="symbol">+</span><span class="normal"> GETLINE_BLOCK_SIZE</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> NULL</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		errno </span><span class="symbol">=</span><span class="normal"> ENOMEM</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	    </span><span class="symbol">*</span><span class="normal">lineptr </span><span class="symbol">=</span><span class="normal"> tmp</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="symbol">*</span><span class="normal">n </span><span class="symbol">+=</span><span class="normal"> GETLINE_BLOCK_SIZE</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="symbol">(*</span><span class="normal">lineptr</span><span class="symbol">)[</span><span class="normal">i</span><span class="symbol">++]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="symbol">)</span><span class="normal">c</span><span class="symbol">;</span>

<span class="normal">	d </span><span class="symbol">=</span><span class="normal"> delims</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(*</span><span class="normal">d</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="symbol">)</span><span class="normal">c </span><span class="symbol">==</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">d</span><span class="symbol">++)</span><span class="normal"> </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(*</span><span class="normal">d </span><span class="symbol">!=</span><span class="normal"> </span><span class="string">'</span><span class="specialchar">\0</span><span class="string">'</span><span class="symbol">)</span><span class="normal"> </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">(*</span><span class="normal">lineptr</span><span class="symbol">)[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="string">'</span><span class="specialchar">\0</span><span class="string">'</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">?</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="normal"> </span><span class="symbol">:</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ssize_t</span><span class="symbol">)</span><span class="normal">i</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="keyword">static</span><span class="normal"> </span><span class="usertype">ssize_t</span><span class="normal"> </span><span class="function">getline</span><span class="symbol">(</span><span class="type">char</span><span class="normal"> </span><span class="symbol">**</span><span class="normal">lineptr</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">size_t</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">n</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">FILE</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">stream</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> </span><span class="function">getdelims</span><span class="symbol">(</span><span class="normal">lineptr</span><span class="symbol">,</span><span class="normal"> n</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"</span><span class="specialchar">\n\r</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> stream</span><span class="symbol">);</span>
<span class="cbracket">}</span>
<span class="preproc">#endif</span>

<span class="comment">/**</span>
<span class="comment"> * Call readlink() as often as needed to return the complete symlink</span>
<span class="comment"> * target in a malloc()ed buffer.</span>
<span class="comment"> */</span>
<span class="type">char</span><span class="symbol">*</span><span class="normal"> </span><span class="function">readlink_dup</span><span class="symbol">(</span><span class="keyword">const</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">filename</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="preproc">#if</span><span class="normal"> HAVE_READLINK</span>

<span class="normal">    </span><span class="usertype">ssize_t</span><span class="normal"> size </span><span class="symbol">=</span><span class="normal"> </span><span class="number">128</span><span class="symbol">;</span>
<span class="normal">    </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">buffer </span><span class="symbol">=</span><span class="normal"> NULL</span><span class="symbol">;</span>
<span class="normal">    </span><span class="type">int</span><span class="normal"> nchars</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="number">1</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	buffer </span><span class="symbol">=</span><span class="normal"> </span><span class="function">realloc</span><span class="symbol">(</span><span class="normal">buffer</span><span class="symbol">,</span><span class="normal"> size</span><span class="symbol">);</span>
<span class="normal">	nchars </span><span class="symbol">=</span><span class="normal"> </span><span class="function">readlink</span><span class="symbol">(</span><span class="normal">filename</span><span class="symbol">,</span><span class="normal"> buffer</span><span class="symbol">,</span><span class="normal"> size</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">nchars </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="function">free</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">buffer</span><span class="symbol">);</span>
<span class="normal">	    </span><span class="keyword">return</span><span class="normal"> NULL</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">nchars</span><span class="symbol">+</span><span class="number">1</span><span class="normal"> </span><span class="symbol">&lt;</span><span class="normal"> size</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	    buffer</span><span class="symbol">[</span><span class="normal">nchars</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="keyword">return</span><span class="normal"> buffer</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	size </span><span class="symbol">*=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="preproc">#else</span>
<span class="normal">    </span><span class="symbol">(</span><span class="type">void</span><span class="symbol">)</span><span class="normal">filename</span><span class="symbol">;</span>
<span class="normal">    errno </span><span class="symbol">=</span><span class="normal"> EINVAL</span><span class="symbol">;</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> NULL</span><span class="symbol">;</span>
<span class="preproc">#endif</span>
<span class="cbracket">}</span>

<span class="comment">/**</span>
<span class="comment"> * fprintf() variant which also updates a CRC32 value.</span>
<span class="comment"> */</span>
<span class="type">int</span><span class="normal"> </span><span class="function">fprintfcrc</span><span class="symbol">(</span><span class="usertype">uint32_t</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">crc</span><span class="symbol">,</span><span class="normal"> FILE</span><span class="symbol">*</span><span class="normal"> fp</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">fmt</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">...)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="usertype">va_list</span><span class="normal"> ap</span><span class="symbol">;</span>
<span class="normal">    </span><span class="usertype">ssize_t</span><span class="normal"> len</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">static</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">out </span><span class="symbol">=</span><span class="normal"> NULL</span><span class="symbol">;</span>
<span class="normal">    </span><span class="keyword">static</span><span class="normal"> </span><span class="usertype">ssize_t</span><span class="normal"> outlen </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">    </span><span class="function">va_start</span><span class="symbol">(</span><span class="normal">ap</span><span class="symbol">,</span><span class="normal"> fmt</span><span class="symbol">);</span>
<span class="normal">    len </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vsnprintf</span><span class="symbol">(</span><span class="normal">NULL</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> fmt</span><span class="symbol">,</span><span class="normal"> ap</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">    </span><span class="function">va_end</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ap</span><span class="symbol">);</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">outlen </span><span class="symbol">&lt;</span><span class="normal"> len</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">outlen </span><span class="symbol">&lt;</span><span class="normal"> len</span><span class="symbol">)</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    outlen </span><span class="symbol">=</span><span class="normal"> </span><span class="number">2</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> outlen</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">outlen </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">128</span><span class="symbol">)</span><span class="normal"> outlen </span><span class="symbol">=</span><span class="normal"> </span><span class="number">128</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	out </span><span class="symbol">=</span><span class="normal"> </span><span class="function">realloc</span><span class="symbol">(</span><span class="normal">out</span><span class="symbol">,</span><span class="normal"> outlen</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">out </span><span class="symbol">==</span><span class="normal"> NULL</span><span class="symbol">)</span><span class="normal"> </span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="function">va_start</span><span class="symbol">(</span><span class="normal">ap</span><span class="symbol">,</span><span class="normal"> fmt</span><span class="symbol">);</span>
<span class="normal">    len </span><span class="symbol">=</span><span class="normal"> </span><span class="function">vsnprintf</span><span class="symbol">(</span><span class="normal">out</span><span class="symbol">,</span><span class="normal"> len</span><span class="symbol">,</span><span class="normal"> fmt</span><span class="symbol">,</span><span class="normal"> ap</span><span class="symbol">);</span>
<span class="normal">    </span><span class="function">va_end</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">ap</span><span class="symbol">);</span>

<span class="normal">    </span><span class="symbol">*</span><span class="normal">crc </span><span class="symbol">=</span><span class="normal"> </span><span class="function">crc32</span><span class="symbol">(*</span><span class="normal">crc</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="symbol">*)</span><span class="normal">out</span><span class="symbol">,</span><span class="normal"> len</span><span class="symbol">);</span>
<span class="normal">    len </span><span class="symbol">=</span><span class="normal"> </span><span class="function">fwrite</span><span class="symbol">(</span><span class="normal">out</span><span class="symbol">,</span><span class="normal"> len</span><span class="symbol">,</span><span class="normal"> </span><span class="number">1</span><span class="symbol">,</span><span class="normal"> fp</span><span class="symbol">);</span>

<span class="normal">    </span><span class="keyword">return</span><span class="normal"> len</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="comment">/**</span>
<span class="comment"> * Transform each \n to a new line and each \\ back to a slash. no</span>
<span class="comment"> * other escapes characters are allowed.</span>
<span class="comment"> */</span>
<span class="type">bool</span><span class="normal"> </span><span class="function">unescape_filename</span><span class="symbol">(</span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">str</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="usertype">size_t</span><span class="normal"> i</span><span class="symbol">,</span><span class="normal"> j </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> str</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">];</span><span class="normal"> </span><span class="symbol">++</span><span class="normal">i</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">++</span><span class="normal">j</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">str</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="string">'</span><span class="specialchar">\\</span><span class="string">'</span><span class="symbol">)</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">str</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">+</span><span class="number">1</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">	    </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="comment">/* illegal filename finishes with single backslash */</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	    </span><span class="symbol">++</span><span class="normal">i</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="keyword">switch</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">str</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">])</span>
<span class="normal">	    </span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="keyword">case</span><span class="normal"> </span><span class="string">'n'</span><span class="symbol">:</span>
<span class="normal">		str</span><span class="symbol">[</span><span class="normal">j</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="string">'</span><span class="specialchar">\n</span><span class="string">'</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="keyword">case</span><span class="normal"> </span><span class="string">'</span><span class="specialchar">\\</span><span class="string">'</span><span class="symbol">:</span>
<span class="normal">		str</span><span class="symbol">[</span><span class="normal">j</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="string">'</span><span class="specialchar">\\</span><span class="string">'</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">break</span><span class="symbol">;</span>
<span class="label">	    default:</span>
<span class="normal">		</span><span class="comment">/* invalid escape sequence. */</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> FALSE</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">!=</span><span class="normal"> j</span><span class="symbol">)</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    str</span><span class="symbol">[</span><span class="normal">j</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> str</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">];</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    str</span><span class="symbol">[</span><span class="normal">j</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">return</span><span class="normal"> TRUE</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="comment">/**</span>
<span class="comment"> * Reverse transform each \n and \. into the escaped form and signal</span>
<span class="comment"> * to main function whether escaping is needed. The function will</span>
<span class="comment"> * replaced the malloc()ed parameter string in str.</span>
<span class="comment"> */</span>
<span class="type">bool</span><span class="normal"> </span><span class="function">needescape_filename</span><span class="symbol">(</span><span class="type">char</span><span class="symbol">**</span><span class="normal"> str</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="type">int</span><span class="normal"> needescape </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">    </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">s</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">t</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">newstr</span><span class="symbol">;</span>

<span class="normal">    s </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">str</span><span class="symbol">;</span>
<span class="normal">    </span><span class="keyword">while</span><span class="symbol">(*</span><span class="normal">s</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(*</span><span class="normal">s </span><span class="symbol">==</span><span class="normal"> </span><span class="string">'</span><span class="specialchar">\\</span><span class="string">'</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">s </span><span class="symbol">==</span><span class="normal"> </span><span class="string">'</span><span class="specialchar">\n</span><span class="string">'</span><span class="symbol">)</span>
<span class="normal">	    </span><span class="symbol">++</span><span class="normal">needescape</span><span class="symbol">;</span>
<span class="normal">	</span><span class="symbol">++</span><span class="normal">s</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">needescape </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> FALSE</span><span class="symbol">;</span>

<span class="normal">    newstr </span><span class="symbol">=</span><span class="normal"> </span><span class="function">malloc</span><span class="symbol">(</span><span class="normal">s </span><span class="symbol">-</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">str </span><span class="symbol">+</span><span class="normal"> needescape </span><span class="symbol">+</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">    t </span><span class="symbol">=</span><span class="normal"> newstr</span><span class="symbol">;</span>
<span class="normal">    s </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">str</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">while</span><span class="symbol">(*</span><span class="normal">s</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(*</span><span class="normal">s </span><span class="symbol">==</span><span class="normal"> </span><span class="string">'</span><span class="specialchar">\\</span><span class="string">'</span><span class="symbol">)</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="symbol">*</span><span class="normal">t</span><span class="symbol">++</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="string">'</span><span class="specialchar">\\</span><span class="string">'</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="symbol">*</span><span class="normal">t</span><span class="symbol">++</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="string">'</span><span class="specialchar">\\</span><span class="string">'</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(*</span><span class="normal">s </span><span class="symbol">==</span><span class="normal"> </span><span class="string">'</span><span class="specialchar">\n</span><span class="string">'</span><span class="symbol">)</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="symbol">*</span><span class="normal">t</span><span class="symbol">++</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="string">'</span><span class="specialchar">\\</span><span class="string">'</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="symbol">*</span><span class="normal">t</span><span class="symbol">++</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="string">'n'</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">else</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="symbol">*</span><span class="normal">t</span><span class="symbol">++</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">s</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="symbol">++</span><span class="normal">s</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="symbol">*</span><span class="normal">t </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">    </span><span class="function">free</span><span class="symbol">(*</span><span class="normal">str</span><span class="symbol">);</span>
<span class="normal">    </span><span class="symbol">*</span><span class="normal">str </span><span class="symbol">=</span><span class="normal"> newstr</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">needescape </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="comment">/***************************************</span>
<span class="comment"> * Functions to calculate file digests *</span>
<span class="comment"> ***************************************/</span>

<span class="comment">/**</span>
<span class="comment"> * Called from digest_file() with a struct digest_ctx. If there is an</span>
<span class="comment"> * error while calculating the digest, the function returns FALSE and</span>
<span class="comment"> * outerror is filled with an error message string.</span>
<span class="comment"> */</span>
<span class="type">bool</span><span class="normal"> </span><span class="function">digest_file2</span><span class="symbol">(</span><span class="keyword">const</span><span class="normal"> </span><span class="type">char</span><span class="symbol">*</span><span class="normal"> filepath</span><span class="symbol">,</span>
<span class="normal">		  </span><span class="type">long</span><span class="normal"> </span><span class="type">long</span><span class="normal"> filesize</span><span class="symbol">,</span>
<span class="normal">		  digest_ctx</span><span class="symbol">*</span><span class="normal"> digctx</span><span class="symbol">,</span>
<span class="normal">		  digest_result</span><span class="symbol">**</span><span class="normal"> outdigest</span><span class="symbol">,</span>
<span class="normal">		  </span><span class="type">char</span><span class="symbol">**</span><span class="normal"> outerror</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="type">char</span><span class="normal"> buffer</span><span class="symbol">[</span><span class="number">1024</span><span class="symbol">*</span><span class="number">1024</span><span class="symbol">];</span>
<span class="normal">    </span><span class="usertype">ssize_t</span><span class="normal"> rb</span><span class="symbol">;</span>
<span class="normal">    </span><span class="type">long</span><span class="normal"> </span><span class="type">long</span><span class="normal"> totalread </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="preproc">#if</span><span class="normal"> ON_WIN32</span>
<span class="normal">    </span><span class="type">int</span><span class="normal"> openflags </span><span class="symbol">=</span><span class="normal"> O_RDONLY </span><span class="symbol">|</span><span class="normal"> O_BINARY</span><span class="symbol">;</span>
<span class="preproc">#else</span>
<span class="normal">    </span><span class="type">int</span><span class="normal"> openflags </span><span class="symbol">=</span><span class="normal"> O_RDONLY</span><span class="symbol">;</span>
<span class="preproc">#endif</span>

<span class="preproc">#ifdef</span><span class="normal"> O_NOATIME</span>
<span class="normal">    </span><span class="type">int</span><span class="normal"> fd </span><span class="symbol">=</span><span class="normal"> </span><span class="function">open</span><span class="symbol">(</span><span class="normal">filepath</span><span class="symbol">,</span><span class="normal"> openflags </span><span class="symbol">|</span><span class="normal"> O_NOATIME</span><span class="symbol">);</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">fd </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">0</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> errno </span><span class="symbol">==</span><span class="normal"> EPERM</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="comment">/* try without O_NOATIME for files not owned by the user */</span>
<span class="normal">	fd </span><span class="symbol">=</span><span class="normal"> </span><span class="function">open</span><span class="symbol">(</span><span class="normal">filepath</span><span class="symbol">,</span><span class="normal"> openflags</span><span class="symbol">);</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="preproc">#else</span>
<span class="normal">    </span><span class="type">int</span><span class="normal"> fd </span><span class="symbol">=</span><span class="normal"> </span><span class="function">open</span><span class="symbol">(</span><span class="normal">filepath</span><span class="symbol">,</span><span class="normal"> openflags</span><span class="symbol">);</span>
<span class="preproc">#endif</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">fd </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_verbose </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"ERROR. Could not open file: %s.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">		    </span><span class="function">strerror</span><span class="symbol">(</span><span class="normal">errno</span><span class="symbol">));</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_verbose </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s ERROR. Could not open file: %s.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">		    filepath</span><span class="symbol">,</span><span class="normal"> </span><span class="function">strerror</span><span class="symbol">(</span><span class="normal">errno</span><span class="symbol">));</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_verbose </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: could not open file </span><span class="specialchar">\"</span><span class="string">%s</span><span class="specialchar">\"</span><span class="string">: %s.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">		    g_progname</span><span class="symbol">,</span><span class="normal"> filepath</span><span class="symbol">,</span><span class="normal"> </span><span class="function">strerror</span><span class="symbol">(</span><span class="normal">errno</span><span class="symbol">));</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="function">asprintf</span><span class="symbol">(</span><span class="normal">outerror</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"Could not open file: %s."</span><span class="symbol">,</span><span class="normal"> </span><span class="function">strerror</span><span class="symbol">(</span><span class="normal">errno</span><span class="symbol">));</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> FALSE</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="keyword">while</span><span class="symbol">(</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">rb </span><span class="symbol">=</span><span class="normal"> </span><span class="function">read</span><span class="symbol">(</span><span class="normal">fd</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">buffer</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="normal">buffer</span><span class="symbol">)))</span><span class="normal"> </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">0</span><span class="normal"> </span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_verbose </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"."</span><span class="symbol">);</span>
<span class="normal">	    </span><span class="function">fflush</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	digctx</span><span class="symbol">-&gt;</span><span class="function">process</span><span class="symbol">(</span><span class="normal">digctx</span><span class="symbol">,</span><span class="normal"> buffer</span><span class="symbol">,</span><span class="normal"> rb</span><span class="symbol">);</span>

<span class="normal">	totalread </span><span class="symbol">+=</span><span class="normal"> rb</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">rb </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_verbose </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"ERROR. Could not read file: %s.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">		    </span><span class="function">strerror</span><span class="symbol">(</span><span class="normal">errno</span><span class="symbol">));</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_verbose </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s ERROR. Could not read file: %s.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">		    filepath</span><span class="symbol">,</span><span class="normal"> </span><span class="function">strerror</span><span class="symbol">(</span><span class="normal">errno</span><span class="symbol">));</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_verbose </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: could not read file </span><span class="specialchar">\"</span><span class="string">%s</span><span class="specialchar">\"</span><span class="string">: %s.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">		    g_progname</span><span class="symbol">,</span><span class="normal"> filepath</span><span class="symbol">,</span><span class="normal"> </span><span class="function">strerror</span><span class="symbol">(</span><span class="normal">errno</span><span class="symbol">));</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="function">asprintf</span><span class="symbol">(</span><span class="normal">outerror</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"Could not read file: %s."</span><span class="symbol">,</span><span class="normal"> </span><span class="function">strerror</span><span class="symbol">(</span><span class="normal">errno</span><span class="symbol">));</span>
<span class="normal">	</span><span class="function">close</span><span class="symbol">(</span><span class="normal">fd</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> FALSE</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="function">close</span><span class="symbol">(</span><span class="normal">fd</span><span class="symbol">);</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">totalread </span><span class="symbol">!=</span><span class="normal"> filesize</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_verbose </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"ERROR. Could not read complete file.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_verbose </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s ERROR. Could not read complete file.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">		    filepath</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_verbose </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: Could not read complete file </span><span class="specialchar">\"</span><span class="string">%s</span><span class="specialchar">\"</span><span class="string">.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">		    g_progname</span><span class="symbol">,</span><span class="normal"> filepath</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="function">asprintf</span><span class="symbol">(</span><span class="normal">outerror</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"Could not read complete file."</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> FALSE</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="function">assert</span><span class="symbol">(!*</span><span class="normal">outdigest</span><span class="symbol">);</span>
<span class="normal">    </span><span class="symbol">*</span><span class="normal">outdigest </span><span class="symbol">=</span><span class="normal"> digctx</span><span class="symbol">-&gt;</span><span class="function">finish</span><span class="symbol">(</span><span class="normal">digctx</span><span class="symbol">);</span>

<span class="normal">    </span><span class="keyword">return</span><span class="normal"> TRUE</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="comment">/**</span>
<span class="comment"> * Read a filepath and calucate the digest over all data. Returns it</span>
<span class="comment"> * as a malloc()ed hex string in outdigest, or returns FALSE if there</span>
<span class="comment"> * was a read error.</span>
<span class="comment"> */</span>
<span class="type">bool</span><span class="normal"> </span><span class="function">digest_file</span><span class="symbol">(</span><span class="keyword">const</span><span class="normal"> </span><span class="type">char</span><span class="symbol">*</span><span class="normal"> filepath</span><span class="symbol">,</span><span class="normal"> </span><span class="type">long</span><span class="normal"> </span><span class="type">long</span><span class="normal"> filesize</span><span class="symbol">,</span>
<span class="normal">                 digest_result</span><span class="symbol">**</span><span class="normal"> outdigest</span><span class="symbol">,</span><span class="normal"> </span><span class="type">char</span><span class="symbol">**</span><span class="normal"> outerror</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="usertype">digest_ctx</span><span class="normal"> digctx</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">switch</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_digesttype</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">case</span><span class="normal"> DT_MD5</span><span class="symbol">:</span>
<span class="normal">	</span><span class="function">digest_init_md5</span><span class="symbol">(&amp;</span><span class="normal">digctx</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">case</span><span class="normal"> DT_SHA1</span><span class="symbol">:</span>
<span class="normal">	</span><span class="function">digest_init_sha1</span><span class="symbol">(&amp;</span><span class="normal">digctx</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">case</span><span class="normal"> DT_SHA256</span><span class="symbol">:</span>
<span class="normal">	</span><span class="function">digest_init_sha256</span><span class="symbol">(&amp;</span><span class="normal">digctx</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">case</span><span class="normal"> DT_SHA512</span><span class="symbol">:</span>
<span class="normal">	</span><span class="function">digest_init_sha512</span><span class="symbol">(&amp;</span><span class="normal">digctx</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">break</span><span class="symbol">;</span>

<span class="label">    default:</span>
<span class="normal">	</span><span class="function">assert</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">);</span>
<span class="normal">	</span><span class="function">asprintf</span><span class="symbol">(</span><span class="normal">outerror</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"Invalid digest algorithm."</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> FALSE</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="keyword">return</span><span class="normal"> </span><span class="function">digest_file2</span><span class="symbol">(</span><span class="normal">filepath</span><span class="symbol">,</span><span class="normal"> filesize</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">digctx</span><span class="symbol">,</span><span class="normal"> outdigest</span><span class="symbol">,</span><span class="normal"> outerror</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="comment">/************************************</span>
<span class="comment"> * Functions to parse a digest file *</span>
<span class="comment"> ************************************/</span>

<span class="comment">/**</span>
<span class="comment"> * Parse one digest line and fill in tempinfo according or add a new</span>
<span class="comment"> * file to g_filelist. The return value is -1 for an unknown line, 0</span>
<span class="comment"> * for a correct digest or symlink line, +1 for a comment line</span>
<span class="comment"> * providing additional file info and -2 for and eof flagged line.</span>
<span class="comment"> */</span>
<span class="type">int</span><span class="normal"> </span><span class="function">parse_digestline</span><span class="symbol">(</span><span class="keyword">const</span><span class="normal"> </span><span class="type">char</span><span class="symbol">*</span><span class="normal"> line</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> linenum</span><span class="symbol">,</span>
<span class="normal">                     </span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">FileInfo</span><span class="symbol">*</span><span class="normal"> tempinfo</span><span class="symbol">,</span><span class="normal"> </span><span class="usertype">uint32_t</span><span class="normal"> crc</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="comment">/*** parse line from digest file ***/</span>
<span class="normal">    </span><span class="usertype">size_t</span><span class="normal"> p </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">    </span><span class="comment">/* skip initial whitespace */</span>
<span class="normal">    </span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="function">isspace</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">[</span><span class="normal">p</span><span class="symbol">]))</span><span class="normal"> </span><span class="symbol">++</span><span class="normal">p</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">[</span><span class="normal">p</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="string">'#'</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="comment">/* if first character is a hash then the line might be a</span>
<span class="comment">	   comment or our custom mtime indicator. */</span>

<span class="normal">	</span><span class="usertype">size_t</span><span class="normal"> p_word</span><span class="symbol">,</span><span class="normal"> p_arg</span><span class="symbol">;</span>

<span class="normal">	</span><span class="symbol">++</span><span class="normal">p</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">[</span><span class="normal">p</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="string">':'</span><span class="symbol">)</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="comment">/* usual comment */</span>
<span class="normal">	    </span><span class="keyword">return</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="symbol">++</span><span class="normal">p</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">[</span><span class="normal">p</span><span class="symbol">])</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="function">isspace</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">[</span><span class="normal">p</span><span class="symbol">]))</span><span class="normal"> </span><span class="symbol">++</span><span class="normal">p</span><span class="symbol">;</span>

<span class="normal">	    p_word </span><span class="symbol">=</span><span class="normal"> p</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="function">isalpha</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">[</span><span class="normal">p</span><span class="symbol">])</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> line</span><span class="symbol">[</span><span class="normal">p</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="string">'</span><span class="specialchar">\\</span><span class="string">'</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">++</span><span class="normal">p</span><span class="symbol">;</span>

<span class="normal">	    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="function">isspace</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">[</span><span class="normal">p</span><span class="symbol">])</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> line</span><span class="symbol">[</span><span class="normal">p</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">	    </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: </span><span class="specialchar">\"</span><span class="string">%s</span><span class="specialchar">\"</span><span class="string"> line %d: unparseable digest comment line.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">			g_progname</span><span class="symbol">,</span><span class="normal"> gopt_digestfile</span><span class="symbol">,</span><span class="normal"> linenum</span><span class="symbol">);</span>

<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="cbracket">}</span>

<span class="normal">	    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">strncmp</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">+</span><span class="normal">p_word</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"option"</span><span class="symbol">,</span><span class="normal"> p </span><span class="symbol">-</span><span class="normal"> p_word</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">	    </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="comment">/* read persistent option following */</span>

<span class="normal">		</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="function">isspace</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">[</span><span class="normal">p</span><span class="symbol">]))</span><span class="normal"> </span><span class="symbol">++</span><span class="normal">p</span><span class="symbol">;</span>

<span class="normal">		p_arg </span><span class="symbol">=</span><span class="normal"> p</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">[</span><span class="normal">p</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> line</span><span class="symbol">[</span><span class="normal">p</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="string">'='</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">++</span><span class="normal">p</span><span class="symbol">;</span>

<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">strncmp</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">+</span><span class="normal">p_arg</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"--exclude-marker"</span><span class="symbol">,</span><span class="normal"> p </span><span class="symbol">-</span><span class="normal"> p_arg</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span>
<span class="normal">                    line</span><span class="symbol">[</span><span class="normal">p</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="string">'='</span><span class="symbol">)</span>
<span class="normal">		</span><span class="cbracket">{</span>
<span class="normal">		    </span><span class="symbol">++</span><span class="normal">p</span><span class="symbol">;</span><span class="normal"> </span><span class="comment">/* skip over '=' */</span>

<span class="normal">		    p_arg </span><span class="symbol">=</span><span class="normal"> p</span><span class="symbol">;</span>
<span class="normal">		    </span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">[</span><span class="normal">p</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">++</span><span class="normal">p</span><span class="symbol">;</span>

<span class="normal">		    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_exclude_marker</span><span class="symbol">)</span><span class="normal"> </span><span class="function">free</span><span class="symbol">((</span><span class="type">void</span><span class="symbol">*)</span><span class="normal">gopt_exclude_marker</span><span class="symbol">);</span>

<span class="normal">		    gopt_exclude_marker </span><span class="symbol">=</span><span class="normal"> </span><span class="function">strndup</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">+</span><span class="normal">p_arg</span><span class="symbol">,</span><span class="normal"> p </span><span class="symbol">-</span><span class="normal"> p_arg</span><span class="symbol">);</span>

<span class="normal">		    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_verbose </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: </span><span class="specialchar">\"</span><span class="string">%s</span><span class="specialchar">\"</span><span class="string"> line %d: persistent option --exclude-marker=%s</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">				g_progname</span><span class="symbol">,</span><span class="normal"> gopt_digestfile</span><span class="symbol">,</span><span class="normal"> linenum</span><span class="symbol">,</span><span class="normal"> gopt_exclude_marker</span><span class="symbol">);</span>
<span class="normal">		    </span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">else</span>
<span class="normal">		</span><span class="cbracket">{</span>
<span class="normal">		    </span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: </span><span class="specialchar">\"</span><span class="string">%s</span><span class="specialchar">\"</span><span class="string"> line %d: unknown persistent option line.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">			    g_progname</span><span class="symbol">,</span><span class="normal"> gopt_digestfile</span><span class="symbol">,</span><span class="normal"> linenum</span><span class="symbol">);</span>

<span class="normal">		    </span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	    </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">strncmp</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">+</span><span class="normal">p_word</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"mtime"</span><span class="symbol">,</span><span class="normal"> p </span><span class="symbol">-</span><span class="normal"> p_word</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">	    </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="comment">/* read number following mtime */</span>

<span class="normal">		</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="function">isspace</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">[</span><span class="normal">p</span><span class="symbol">]))</span><span class="normal"> </span><span class="symbol">++</span><span class="normal">p</span><span class="symbol">;</span>

<span class="normal">		p_arg </span><span class="symbol">=</span><span class="normal"> p</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="function">isdigit</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">[</span><span class="normal">p</span><span class="symbol">]))</span><span class="normal"> </span><span class="symbol">++</span><span class="normal">p</span><span class="symbol">;</span>

<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="function">isspace</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">[</span><span class="normal">p</span><span class="symbol">])</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> line</span><span class="symbol">[</span><span class="normal">p</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">		</span><span class="cbracket">{</span>
<span class="normal">		    </span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: </span><span class="specialchar">\"</span><span class="string">%s</span><span class="specialchar">\"</span><span class="string"> line %d: unparseable digest comment line.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">			    g_progname</span><span class="symbol">,</span><span class="normal"> gopt_digestfile</span><span class="symbol">,</span><span class="normal"> linenum</span><span class="symbol">);</span>

<span class="normal">		    </span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>

<span class="normal">		tempinfo</span><span class="symbol">-&gt;</span><span class="normal">mtime </span><span class="symbol">=</span><span class="normal"> </span><span class="function">strtoul</span><span class="symbol">(</span><span class="normal">line </span><span class="symbol">+</span><span class="normal"> p_arg</span><span class="symbol">,</span><span class="normal"> NULL</span><span class="symbol">,</span><span class="normal"> </span><span class="number">10</span><span class="symbol">);</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	    </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">strncmp</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">+</span><span class="normal">p_word</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"size"</span><span class="symbol">,</span><span class="normal"> p </span><span class="symbol">-</span><span class="normal"> p_word</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">	    </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="comment">/* read number following size */</span>

<span class="normal">		</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="function">isspace</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">[</span><span class="normal">p</span><span class="symbol">]))</span><span class="normal"> </span><span class="symbol">++</span><span class="normal">p</span><span class="symbol">;</span>

<span class="normal">		p_arg </span><span class="symbol">=</span><span class="normal"> p</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="function">isdigit</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">[</span><span class="normal">p</span><span class="symbol">]))</span><span class="normal"> </span><span class="symbol">++</span><span class="normal">p</span><span class="symbol">;</span>

<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="function">isspace</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">[</span><span class="normal">p</span><span class="symbol">])</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> line</span><span class="symbol">[</span><span class="normal">p</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">		</span><span class="cbracket">{</span>
<span class="normal">		    </span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: </span><span class="specialchar">\"</span><span class="string">%s</span><span class="specialchar">\"</span><span class="string"> line %d: unparseable digest comment line.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">			    g_progname</span><span class="symbol">,</span><span class="normal"> gopt_digestfile</span><span class="symbol">,</span><span class="normal"> linenum</span><span class="symbol">);</span>

<span class="normal">		    </span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>

<span class="normal">		tempinfo</span><span class="symbol">-&gt;</span><span class="normal">size </span><span class="symbol">=</span><span class="normal"> </span><span class="function">strtoull</span><span class="symbol">(</span><span class="normal">line </span><span class="symbol">+</span><span class="normal"> p_arg</span><span class="symbol">,</span><span class="normal"> NULL</span><span class="symbol">,</span><span class="normal"> </span><span class="number">10</span><span class="symbol">);</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	    </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">strncmp</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">+</span><span class="normal">p_word</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"target"</span><span class="symbol">,</span><span class="normal"> p </span><span class="symbol">-</span><span class="normal"> p_word</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">	    </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="comment">/* read the complete following line (after the current</span>
<span class="comment">		 * white space) as the symlink target */</span>

<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="function">isspace</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">[</span><span class="normal">p</span><span class="symbol">]))</span>
<span class="normal">		</span><span class="cbracket">{</span>
<span class="normal">		    </span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: </span><span class="specialchar">\"</span><span class="string">%s</span><span class="specialchar">\"</span><span class="string"> line %d: unparseable digest comment line.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">			    g_progname</span><span class="symbol">,</span><span class="normal"> gopt_digestfile</span><span class="symbol">,</span><span class="normal"> linenum</span><span class="symbol">);</span>

<span class="normal">		    </span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="symbol">++</span><span class="normal">p</span><span class="symbol">;</span>

<span class="normal">		p_arg </span><span class="symbol">=</span><span class="normal"> p</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">[</span><span class="normal">p</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">++</span><span class="normal">p</span><span class="symbol">;</span>

<span class="normal">		tempinfo</span><span class="symbol">-&gt;</span><span class="normal">symlink </span><span class="symbol">=</span><span class="normal"> </span><span class="function">strndup</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">+</span><span class="normal">p_arg</span><span class="symbol">,</span><span class="normal"> p </span><span class="symbol">-</span><span class="normal"> p_arg</span><span class="symbol">);</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	    </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">strncmp</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">+</span><span class="normal">p_word</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"target</span><span class="specialchar">\\</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> p </span><span class="symbol">-</span><span class="normal"> p_word</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">	    </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="comment">/* read the complete following line (after the current</span>
<span class="comment">		 * white space) as the escaped symlink target */</span>

<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="function">isspace</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">[</span><span class="normal">p</span><span class="symbol">]))</span>
<span class="normal">		</span><span class="cbracket">{</span>
<span class="normal">		    </span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: </span><span class="specialchar">\"</span><span class="string">%s</span><span class="specialchar">\"</span><span class="string"> line %d: unparseable digest comment line.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">			    g_progname</span><span class="symbol">,</span><span class="normal"> gopt_digestfile</span><span class="symbol">,</span><span class="normal"> linenum</span><span class="symbol">);</span>

<span class="normal">		    </span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="symbol">++</span><span class="normal">p</span><span class="symbol">;</span>

<span class="normal">		p_arg </span><span class="symbol">=</span><span class="normal"> p</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">[</span><span class="normal">p</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">++</span><span class="normal">p</span><span class="symbol">;</span>

<span class="normal">		tempinfo</span><span class="symbol">-&gt;</span><span class="normal">symlink </span><span class="symbol">=</span><span class="normal"> </span><span class="function">strndup</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">+</span><span class="normal">p_arg</span><span class="symbol">,</span><span class="normal"> p </span><span class="symbol">-</span><span class="normal"> p_arg</span><span class="symbol">);</span>

<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="function">unescape_filename</span><span class="symbol">(</span><span class="normal">tempinfo</span><span class="symbol">-&gt;</span><span class="normal">symlink</span><span class="symbol">))</span>
<span class="normal">		</span><span class="cbracket">{</span>
<span class="normal">		    </span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: </span><span class="specialchar">\"</span><span class="string">%s</span><span class="specialchar">\"</span><span class="string"> line %d: improperly escaped symlink target.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">			    g_progname</span><span class="symbol">,</span><span class="normal"> gopt_digestfile</span><span class="symbol">,</span><span class="normal"> linenum</span><span class="symbol">);</span>
<span class="normal">		    </span><span class="function">free</span><span class="symbol">(</span><span class="normal">tempinfo</span><span class="symbol">-&gt;</span><span class="normal">symlink</span><span class="symbol">);</span>
<span class="normal">		    </span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	    </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">strncmp</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">+</span><span class="normal">p_word</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"symlink"</span><span class="symbol">,</span><span class="normal"> p </span><span class="symbol">-</span><span class="normal"> p_word</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">	    </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="comment">/* read the complete following line (after the current</span>
<span class="comment">		 * white space) as the symlink source file name. */</span>

<span class="normal">		</span><span class="type">char</span><span class="symbol">*</span><span class="normal"> filename</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">FileInfo</span><span class="symbol">*</span><span class="normal"> fileinfo</span><span class="symbol">;</span>

<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="function">isspace</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">[</span><span class="normal">p</span><span class="symbol">]))</span>
<span class="normal">		</span><span class="cbracket">{</span>
<span class="normal">		    </span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: </span><span class="specialchar">\"</span><span class="string">%s</span><span class="specialchar">\"</span><span class="string"> line %d: unparseable digest comment line.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">			    g_progname</span><span class="symbol">,</span><span class="normal"> gopt_digestfile</span><span class="symbol">,</span><span class="normal"> linenum</span><span class="symbol">);</span>

<span class="normal">		    </span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="symbol">++</span><span class="normal">p</span><span class="symbol">;</span>

<span class="normal">		p_arg </span><span class="symbol">=</span><span class="normal"> p</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">[</span><span class="normal">p</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">++</span><span class="normal">p</span><span class="symbol">;</span>

<span class="normal">		filename </span><span class="symbol">=</span><span class="normal"> </span><span class="function">strndup</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">+</span><span class="normal">p_arg</span><span class="symbol">,</span><span class="normal"> p </span><span class="symbol">-</span><span class="normal"> p_arg</span><span class="symbol">);</span>

<span class="normal">		fileinfo </span><span class="symbol">=</span><span class="normal"> </span><span class="function">malloc</span><span class="symbol">(</span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">FileInfo</span><span class="symbol">));</span>
<span class="normal">		</span><span class="function">memcpy</span><span class="symbol">(</span><span class="normal">fileinfo</span><span class="symbol">,</span><span class="normal"> tempinfo</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">FileInfo</span><span class="symbol">));</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">fileinfo</span><span class="symbol">-&gt;</span><span class="normal">symlink</span><span class="symbol">)</span><span class="normal"> </span><span class="comment">/* tempinfo's copy will be freed */</span>
<span class="normal">		    fileinfo</span><span class="symbol">-&gt;</span><span class="normal">symlink </span><span class="symbol">=</span><span class="normal"> </span><span class="function">strdup</span><span class="symbol">(</span><span class="normal">fileinfo</span><span class="symbol">-&gt;</span><span class="normal">symlink</span><span class="symbol">);</span>

<span class="normal">		</span><span class="comment">/* insert fileinfo into filelist */</span>

<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">rb_find</span><span class="symbol">(</span><span class="normal">g_filelist</span><span class="symbol">,</span><span class="normal"> filename</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">		</span><span class="cbracket">{</span>
<span class="normal">		    </span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: </span><span class="specialchar">\"</span><span class="string">%s</span><span class="specialchar">\"</span><span class="string"> line %d: duplicate symlink file name.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">			    g_progname</span><span class="symbol">,</span><span class="normal"> gopt_digestfile</span><span class="symbol">,</span><span class="normal"> linenum</span><span class="symbol">);</span>

<span class="normal">		    </span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>

<span class="normal">		</span><span class="function">rb_insert</span><span class="symbol">(</span><span class="normal">g_filelist</span><span class="symbol">,</span><span class="normal"> filename</span><span class="symbol">,</span><span class="normal"> fileinfo</span><span class="symbol">);</span>

<span class="normal">		</span><span class="comment">/* return +1 here to clear tempinfo. */</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	    </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">strncmp</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">+</span><span class="normal">p_word</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"symlink</span><span class="specialchar">\\</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> p </span><span class="symbol">-</span><span class="normal"> p_word</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">	    </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="comment">/* read the complete following line (after the current</span>
<span class="comment">		 * white space) as the escaped symlink source file name. */</span>

<span class="normal">		</span><span class="type">char</span><span class="symbol">*</span><span class="normal"> filename</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">FileInfo</span><span class="symbol">*</span><span class="normal"> fileinfo</span><span class="symbol">;</span>

<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="function">isspace</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">[</span><span class="normal">p</span><span class="symbol">]))</span>
<span class="normal">		</span><span class="cbracket">{</span>
<span class="normal">		    </span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: </span><span class="specialchar">\"</span><span class="string">%s</span><span class="specialchar">\"</span><span class="string"> line %d: unparseable digest comment line.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">			    g_progname</span><span class="symbol">,</span><span class="normal"> gopt_digestfile</span><span class="symbol">,</span><span class="normal"> linenum</span><span class="symbol">);</span>

<span class="normal">		    </span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="symbol">++</span><span class="normal">p</span><span class="symbol">;</span>

<span class="normal">		p_arg </span><span class="symbol">=</span><span class="normal"> p</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">[</span><span class="normal">p</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">++</span><span class="normal">p</span><span class="symbol">;</span>

<span class="normal">		filename </span><span class="symbol">=</span><span class="normal"> </span><span class="function">strndup</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">+</span><span class="normal">p_arg</span><span class="symbol">,</span><span class="normal"> p </span><span class="symbol">-</span><span class="normal"> p_arg</span><span class="symbol">);</span>

<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="function">unescape_filename</span><span class="symbol">(</span><span class="normal">filename</span><span class="symbol">))</span>
<span class="normal">		</span><span class="cbracket">{</span>
<span class="normal">		    </span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: </span><span class="specialchar">\"</span><span class="string">%s</span><span class="specialchar">\"</span><span class="string"> line %d: improperly escaped symlink filename.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">			    g_progname</span><span class="symbol">,</span><span class="normal"> gopt_digestfile</span><span class="symbol">,</span><span class="normal"> linenum</span><span class="symbol">);</span>
<span class="normal">		    </span><span class="function">free</span><span class="symbol">(</span><span class="normal">filename</span><span class="symbol">);</span>
<span class="normal">		    </span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>

<span class="normal">		fileinfo </span><span class="symbol">=</span><span class="normal"> </span><span class="function">malloc</span><span class="symbol">(</span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">FileInfo</span><span class="symbol">));</span>
<span class="normal">		</span><span class="function">memcpy</span><span class="symbol">(</span><span class="normal">fileinfo</span><span class="symbol">,</span><span class="normal"> tempinfo</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">FileInfo</span><span class="symbol">));</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">fileinfo</span><span class="symbol">-&gt;</span><span class="normal">symlink</span><span class="symbol">)</span><span class="normal"> </span><span class="comment">/* tempinfo's copy will be freed */</span>
<span class="normal">		    fileinfo</span><span class="symbol">-&gt;</span><span class="normal">symlink </span><span class="symbol">=</span><span class="normal"> </span><span class="function">strdup</span><span class="symbol">(</span><span class="normal">fileinfo</span><span class="symbol">-&gt;</span><span class="normal">symlink</span><span class="symbol">);</span>

<span class="normal">		</span><span class="comment">/* insert fileinfo into filelist */</span>

<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">rb_find</span><span class="symbol">(</span><span class="normal">g_filelist</span><span class="symbol">,</span><span class="normal"> filename</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">		</span><span class="cbracket">{</span>
<span class="normal">		    </span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: </span><span class="specialchar">\"</span><span class="string">%s</span><span class="specialchar">\"</span><span class="string"> line %d: duplicate symlink file name.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">			    g_progname</span><span class="symbol">,</span><span class="normal"> gopt_digestfile</span><span class="symbol">,</span><span class="normal"> linenum</span><span class="symbol">);</span>

<span class="normal">		    </span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>

<span class="normal">		</span><span class="function">rb_insert</span><span class="symbol">(</span><span class="normal">g_filelist</span><span class="symbol">,</span><span class="normal"> filename</span><span class="symbol">,</span><span class="normal"> fileinfo</span><span class="symbol">);</span>

<span class="normal">		</span><span class="comment">/* return +1 here to clear tempinfo. */</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	    </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">strncmp</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">+</span><span class="normal">p_word</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"crc"</span><span class="symbol">,</span><span class="normal"> p </span><span class="symbol">-</span><span class="normal"> p_word</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">	    </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="comment">/* read hex crc32 value following the word */</span>

<span class="normal">		</span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">crchex</span><span class="symbol">;</span>

<span class="normal">		</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="function">isspace</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">[</span><span class="normal">p</span><span class="symbol">]))</span><span class="normal"> </span><span class="symbol">++</span><span class="normal">p</span><span class="symbol">;</span>

<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">[</span><span class="normal">p</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="string">'0'</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> line</span><span class="symbol">[++</span><span class="normal">p</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="string">'x'</span><span class="symbol">)</span>
<span class="normal">		</span><span class="cbracket">{</span>
<span class="normal">		    </span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: </span><span class="specialchar">\"</span><span class="string">%s</span><span class="specialchar">\"</span><span class="string"> line %d: unparseable crc line.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">			    g_progname</span><span class="symbol">,</span><span class="normal"> gopt_digestfile</span><span class="symbol">,</span><span class="normal"> linenum</span><span class="symbol">);</span>
<span class="normal">		    </span><span class="keyword">return</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="symbol">++</span><span class="normal">p</span><span class="symbol">;</span>

<span class="normal">		p_arg </span><span class="symbol">=</span><span class="normal"> p</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="function">isxdigit</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">[</span><span class="normal">p</span><span class="symbol">]))</span><span class="normal"> </span><span class="symbol">++</span><span class="normal">p</span><span class="symbol">;</span>

<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">p </span><span class="symbol">-</span><span class="normal"> p_arg </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">8</span><span class="symbol">)</span>
<span class="normal">		</span><span class="cbracket">{</span>
<span class="normal">		    </span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: </span><span class="specialchar">\"</span><span class="string">%s</span><span class="specialchar">\"</span><span class="string"> line %d: unparseable sdfsdcrc line.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">			    g_progname</span><span class="symbol">,</span><span class="normal"> gopt_digestfile</span><span class="symbol">,</span><span class="normal"> linenum</span><span class="symbol">);</span>
<span class="normal">		    </span><span class="keyword">return</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>

<span class="normal">		</span><span class="function">asprintf</span><span class="symbol">(&amp;</span><span class="normal">crchex</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%08x"</span><span class="symbol">,</span><span class="normal"> crc</span><span class="symbol">);</span>
<span class="normal">		</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">strncmp</span><span class="symbol">(</span><span class="normal">crchex</span><span class="symbol">,</span><span class="normal"> line</span><span class="symbol">+</span><span class="normal">p_arg</span><span class="symbol">,</span><span class="normal"> p </span><span class="symbol">-</span><span class="normal"> p_arg</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">		</span><span class="cbracket">{</span>
<span class="normal">		    </span><span class="function">free</span><span class="symbol">(</span><span class="normal">crchex</span><span class="symbol">);</span>

<span class="normal">		    </span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: </span><span class="specialchar">\"</span><span class="string">%s</span><span class="specialchar">\"</span><span class="string"> line %d: crc32 value saved in file does not match!</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">			    g_progname</span><span class="symbol">,</span><span class="normal"> gopt_digestfile</span><span class="symbol">,</span><span class="normal"> linenum</span><span class="symbol">);</span>

<span class="normal">		    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_batch</span><span class="symbol">)</span>
<span class="normal">		    </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="function">exit</span><span class="symbol">(-</span><span class="number">1</span><span class="symbol">);</span><span class="normal"> </span><span class="comment">/* fail badly */</span>
<span class="normal">		    </span><span class="cbracket">}</span>
<span class="normal">		    </span><span class="keyword">else</span>
<span class="normal">		    </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="type">char</span><span class="normal"> input</span><span class="symbol">[</span><span class="number">256</span><span class="symbol">];</span>

<span class="normal">			</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"This indicates an unintentional or intentional modification of the digest file.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">			</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"Continue despite change (y/n)? "</span><span class="symbol">);</span>

<span class="normal">			</span><span class="function">fgets</span><span class="symbol">(</span><span class="normal">input</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="normal">input</span><span class="symbol">),</span><span class="normal"> stdin</span><span class="symbol">);</span>

<span class="normal">			</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">input</span><span class="symbol">[</span><span class="number">0</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="string">'y'</span><span class="symbol">)</span>
<span class="normal">			</span><span class="cbracket">{</span>
<span class="normal">			    </span><span class="function">exit</span><span class="symbol">(-</span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">			</span><span class="cbracket">}</span>
<span class="normal">		    </span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">else</span>
<span class="normal">		</span><span class="cbracket">{</span>
<span class="normal">		    </span><span class="function">free</span><span class="symbol">(</span><span class="normal">crchex</span><span class="symbol">);</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	    </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">strncmp</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">+</span><span class="normal">p_word</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"eof"</span><span class="symbol">,</span><span class="normal"> p </span><span class="symbol">-</span><span class="normal"> p_word</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">	    </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">-</span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	    </span><span class="keyword">else</span>
<span class="normal">	    </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: </span><span class="specialchar">\"</span><span class="string">%s</span><span class="specialchar">\"</span><span class="string"> line %d: unparseable digest comment line.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">			g_progname</span><span class="symbol">,</span><span class="normal"> gopt_digestfile</span><span class="symbol">,</span><span class="normal"> linenum</span><span class="symbol">);</span>

<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="normal">    </span><span class="keyword">else</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="comment">/* a usual digest line. */</span>

<span class="normal">	</span><span class="usertype">size_t</span><span class="normal"> p_hex1</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">FileInfo</span><span class="symbol">*</span><span class="normal"> fileinfo</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">enum</span><span class="normal"> </span><span class="usertype">DigestType</span><span class="normal"> this_digesttype </span><span class="symbol">=</span><span class="normal"> DT_NONE</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">char</span><span class="symbol">*</span><span class="normal"> filename </span><span class="symbol">=</span><span class="normal"> NULL</span><span class="symbol">;</span>

<span class="normal">	</span><span class="type">bool</span><span class="normal"> escaped_filename </span><span class="symbol">=</span><span class="normal"> FALSE</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">[</span><span class="normal">p</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="string">'</span><span class="specialchar">\\</span><span class="string">'</span><span class="symbol">)</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="symbol">++</span><span class="normal">p</span><span class="symbol">;</span>
<span class="normal">	    escaped_filename </span><span class="symbol">=</span><span class="normal"> TRUE</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	p_hex1 </span><span class="symbol">=</span><span class="normal"> p</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="function">isxdigit</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">[</span><span class="normal">p</span><span class="symbol">]))</span><span class="normal"> </span><span class="symbol">++</span><span class="normal">p</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="function">isspace</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">[</span><span class="normal">p</span><span class="symbol">]))</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="comment">/* digest is not followed by a space -&gt; error. */</span>
<span class="normal">	    </span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	fileinfo </span><span class="symbol">=</span><span class="normal"> </span><span class="function">malloc</span><span class="symbol">(</span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">FileInfo</span><span class="symbol">));</span>
<span class="normal">	</span><span class="function">memcpy</span><span class="symbol">(</span><span class="normal">fileinfo</span><span class="symbol">,</span><span class="normal"> tempinfo</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">FileInfo</span><span class="symbol">));</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">fileinfo</span><span class="symbol">-&gt;</span><span class="normal">symlink</span><span class="symbol">)</span><span class="normal"> </span><span class="comment">/* tempinfo's copy will be freed */</span>
<span class="normal">	    fileinfo</span><span class="symbol">-&gt;</span><span class="normal">symlink </span><span class="symbol">=</span><span class="normal"> </span><span class="function">strdup</span><span class="symbol">(</span><span class="normal">fileinfo</span><span class="symbol">-&gt;</span><span class="normal">symlink</span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">p_hex1 </span><span class="symbol">+</span><span class="normal"> </span><span class="number">2</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> MD5_DIGEST_SIZE </span><span class="symbol">==</span><span class="normal"> p</span><span class="symbol">)</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    fileinfo</span><span class="symbol">-&gt;</span><span class="normal">digest </span><span class="symbol">=</span><span class="normal"> </span><span class="function">digest_hex2bin</span><span class="symbol">(</span><span class="normal"> line</span><span class="symbol">+</span><span class="normal">p_hex1</span><span class="symbol">,</span><span class="normal"> p </span><span class="symbol">-</span><span class="normal"> p_hex1 </span><span class="symbol">);</span>
<span class="normal">	    this_digesttype </span><span class="symbol">=</span><span class="normal"> DT_MD5</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">p_hex1 </span><span class="symbol">+</span><span class="normal"> </span><span class="number">2</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> SHA1_DIGEST_SIZE </span><span class="symbol">==</span><span class="normal"> p</span><span class="symbol">)</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    fileinfo</span><span class="symbol">-&gt;</span><span class="normal">digest </span><span class="symbol">=</span><span class="normal"> </span><span class="function">digest_hex2bin</span><span class="symbol">(</span><span class="normal"> line</span><span class="symbol">+</span><span class="normal">p_hex1</span><span class="symbol">,</span><span class="normal"> p </span><span class="symbol">-</span><span class="normal"> p_hex1 </span><span class="symbol">);</span>
<span class="normal">	    this_digesttype </span><span class="symbol">=</span><span class="normal"> DT_SHA1</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">p_hex1 </span><span class="symbol">+</span><span class="normal"> </span><span class="number">2</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> SHA256_DIGEST_SIZE </span><span class="symbol">==</span><span class="normal"> p</span><span class="symbol">)</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    fileinfo</span><span class="symbol">-&gt;</span><span class="normal">digest </span><span class="symbol">=</span><span class="normal"> </span><span class="function">digest_hex2bin</span><span class="symbol">(</span><span class="normal"> line</span><span class="symbol">+</span><span class="normal">p_hex1</span><span class="symbol">,</span><span class="normal"> p </span><span class="symbol">-</span><span class="normal"> p_hex1 </span><span class="symbol">);</span>
<span class="normal">	    this_digesttype </span><span class="symbol">=</span><span class="normal"> DT_SHA256</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">p_hex1 </span><span class="symbol">+</span><span class="normal"> </span><span class="number">2</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> SHA512_DIGEST_SIZE </span><span class="symbol">==</span><span class="normal"> p</span><span class="symbol">)</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    fileinfo</span><span class="symbol">-&gt;</span><span class="normal">digest </span><span class="symbol">=</span><span class="normal"> </span><span class="function">digest_hex2bin</span><span class="symbol">(</span><span class="normal"> line</span><span class="symbol">+</span><span class="normal">p_hex1</span><span class="symbol">,</span><span class="normal"> p </span><span class="symbol">-</span><span class="normal"> p_hex1 </span><span class="symbol">);</span>
<span class="normal">	    this_digesttype </span><span class="symbol">=</span><span class="normal"> DT_SHA512</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">else</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: </span><span class="specialchar">\"</span><span class="string">%s</span><span class="specialchar">\"</span><span class="string"> line %d: no proper hex digest detected on line.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">		    g_progname</span><span class="symbol">,</span><span class="normal"> gopt_digestfile</span><span class="symbol">,</span><span class="normal"> linenum</span><span class="symbol">);</span>

<span class="normal">	    </span><span class="function">free</span><span class="symbol">(</span><span class="normal">fileinfo</span><span class="symbol">);</span>
<span class="normal">	    </span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">fileinfo</span><span class="symbol">-&gt;</span><span class="normal">digest</span><span class="symbol">)</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="function">assert</span><span class="symbol">(</span><span class="normal">fileinfo</span><span class="symbol">-&gt;</span><span class="normal">digest</span><span class="symbol">);</span>
<span class="normal">	    </span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: </span><span class="specialchar">\"</span><span class="string">%s</span><span class="specialchar">\"</span><span class="string"> line %d: no proper hex digest detected on line.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">		    g_progname</span><span class="symbol">,</span><span class="normal"> gopt_digestfile</span><span class="symbol">,</span><span class="normal"> linenum</span><span class="symbol">);</span>

<span class="normal">	    </span><span class="function">free</span><span class="symbol">(</span><span class="normal">fileinfo</span><span class="symbol">);</span>
<span class="normal">	    </span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_digesttype </span><span class="symbol">!=</span><span class="normal"> DT_NONE </span><span class="symbol">&amp;&amp;</span><span class="normal"> this_digesttype </span><span class="symbol">!=</span><span class="normal"> gopt_digesttype</span><span class="symbol">)</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: </span><span class="specialchar">\"</span><span class="string">%s</span><span class="specialchar">\"</span><span class="string"> line %d: different digest types in file.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">		    g_progname</span><span class="symbol">,</span><span class="normal"> gopt_digestfile</span><span class="symbol">,</span><span class="normal"> linenum</span><span class="symbol">);</span>

<span class="normal">	    </span><span class="function">free</span><span class="symbol">(</span><span class="normal">fileinfo</span><span class="symbol">);</span>
<span class="normal">	    </span><span class="function">exit</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="symbol">++</span><span class="normal">p</span><span class="symbol">;</span>

<span class="normal">	</span><span class="comment">/* after digest terminating white space follows a "type</span>
<span class="comment">	   indicator": text or binary. We always use binary. */</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">[</span><span class="normal">p</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="string">' '</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> line</span><span class="symbol">[</span><span class="normal">p</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="string">'*'</span><span class="symbol">)</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: </span><span class="specialchar">\"</span><span class="string">%s</span><span class="specialchar">\"</span><span class="string"> line %d: improper type indicator.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">		    g_progname</span><span class="symbol">,</span><span class="normal"> gopt_digestfile</span><span class="symbol">,</span><span class="normal"> linenum</span><span class="symbol">);</span>

<span class="normal">	    </span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="symbol">++</span><span class="normal">p</span><span class="symbol">;</span>

<span class="normal">	</span><span class="comment">/* all non-null character after type indicator and \n are relevant. */</span>

<span class="normal">	filename </span><span class="symbol">=</span><span class="normal"> </span><span class="function">strdup</span><span class="symbol">(</span><span class="normal">line </span><span class="symbol">+</span><span class="normal"> p</span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">escaped_filename</span><span class="symbol">)</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="function">unescape_filename</span><span class="symbol">(</span><span class="normal">filename</span><span class="symbol">))</span>
<span class="normal">	    </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: </span><span class="specialchar">\"</span><span class="string">%s</span><span class="specialchar">\"</span><span class="string"> line %d: improperly escaped file name.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">			g_progname</span><span class="symbol">,</span><span class="normal"> gopt_digestfile</span><span class="symbol">,</span><span class="normal"> linenum</span><span class="symbol">);</span>

<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="comment">/* insert fileinfo into filelist */</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">rb_find</span><span class="symbol">(</span><span class="normal">g_filelist</span><span class="symbol">,</span><span class="normal"> filename</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: </span><span class="specialchar">\"</span><span class="string">%s</span><span class="specialchar">\"</span><span class="string"> line %d: duplicate file name.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">		    g_progname</span><span class="symbol">,</span><span class="normal"> gopt_digestfile</span><span class="symbol">,</span><span class="normal"> linenum</span><span class="symbol">);</span>

<span class="normal">	    </span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="function">rb_insert</span><span class="symbol">(</span><span class="normal">g_filelist</span><span class="symbol">,</span><span class="normal"> filename</span><span class="symbol">,</span><span class="normal"> fileinfo</span><span class="symbol">);</span>

<span class="normal">	gopt_digesttype </span><span class="symbol">=</span><span class="normal"> this_digesttype</span><span class="symbol">;</span>

<span class="normal">	</span><span class="comment">/* return +1 here to clear tempinfo. */</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="type">bool</span><span class="normal"> </span><span class="function">select_digestfile</span><span class="symbol">(</span><span class="type">void</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="comment">/*</span>
<span class="comment">      Check for existing standard digest file names. However, if</span>
<span class="comment">      multiple exist, failed with an error message.</span>
<span class="comment">    */</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">access</span><span class="symbol">(</span><span class="string">"md5sum.txt"</span><span class="symbol">,</span><span class="normal"> F_OK</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	gopt_digesttype </span><span class="symbol">=</span><span class="normal"> DT_MD5</span><span class="symbol">;</span>
<span class="normal">	gopt_digestfile </span><span class="symbol">=</span><span class="normal"> </span><span class="string">"md5sum.txt"</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">access</span><span class="symbol">(</span><span class="string">"sha1sum.txt"</span><span class="symbol">,</span><span class="normal"> F_OK</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_digestfile </span><span class="symbol">!=</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: multiple digest files found in current directory. Select one using --file.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">		    g_progname</span><span class="symbol">);</span>
<span class="normal">	    </span><span class="keyword">return</span><span class="normal"> FALSE</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	gopt_digesttype </span><span class="symbol">=</span><span class="normal"> DT_SHA1</span><span class="symbol">;</span>
<span class="normal">	gopt_digestfile </span><span class="symbol">=</span><span class="normal"> </span><span class="string">"sha1sum.txt"</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">access</span><span class="symbol">(</span><span class="string">"sha128sum.txt"</span><span class="symbol">,</span><span class="normal"> F_OK</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_digestfile </span><span class="symbol">!=</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: multiple digest files found in current directory. Select one using --file.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">		    g_progname</span><span class="symbol">);</span>
<span class="normal">	    </span><span class="keyword">return</span><span class="normal"> FALSE</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	gopt_digesttype </span><span class="symbol">=</span><span class="normal"> DT_SHA1</span><span class="symbol">;</span>
<span class="normal">	gopt_digestfile </span><span class="symbol">=</span><span class="normal"> </span><span class="string">"sha128sum.txt"</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">access</span><span class="symbol">(</span><span class="string">"sha256sum.txt"</span><span class="symbol">,</span><span class="normal"> F_OK</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_digestfile </span><span class="symbol">!=</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: multiple digest files found in current directory. Select one using --file.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">		    g_progname</span><span class="symbol">);</span>
<span class="normal">	    </span><span class="keyword">return</span><span class="normal"> FALSE</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	gopt_digesttype </span><span class="symbol">=</span><span class="normal"> DT_SHA256</span><span class="symbol">;</span>
<span class="normal">	gopt_digestfile </span><span class="symbol">=</span><span class="normal"> </span><span class="string">"sha256sum.txt"</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">access</span><span class="symbol">(</span><span class="string">"sha512sum.txt"</span><span class="symbol">,</span><span class="normal"> F_OK</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_digestfile </span><span class="symbol">!=</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: multiple digest files found in current directory. Select one using --file.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">		    g_progname</span><span class="symbol">);</span>
<span class="normal">	    </span><span class="keyword">return</span><span class="normal"> FALSE</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	gopt_digesttype </span><span class="symbol">=</span><span class="normal"> DT_SHA512</span><span class="symbol">;</span>
<span class="normal">	gopt_digestfile </span><span class="symbol">=</span><span class="normal"> </span><span class="string">"sha512sum.txt"</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="keyword">return</span><span class="normal"> TRUE</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="type">bool</span><span class="normal"> </span><span class="function">read_digestfile</span><span class="symbol">(</span><span class="type">void</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    FILE</span><span class="symbol">*</span><span class="normal"> sumfile</span><span class="symbol">;</span>
<span class="normal">    </span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">FileInfo</span><span class="normal"> tempinfo</span><span class="symbol">;</span>

<span class="normal">    </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">line </span><span class="symbol">=</span><span class="normal"> NULL</span><span class="symbol">;</span>
<span class="normal">    </span><span class="usertype">size_t</span><span class="normal"> linemax </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">    </span><span class="usertype">ssize_t</span><span class="normal"> linelen</span><span class="symbol">;</span>
<span class="normal">    </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> linenum </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">    </span><span class="type">int</span><span class="normal"> res </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">    </span><span class="usertype">uint32_t</span><span class="normal"> crc </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> nextcrc</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_digestfile </span><span class="symbol">==</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="function">select_digestfile</span><span class="symbol">())</span>
<span class="normal">	    </span><span class="keyword">return</span><span class="normal"> FALSE</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_digestfile </span><span class="symbol">==</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: no digest file found. Creating </span><span class="specialchar">\"</span><span class="string">sha1sum.txt</span><span class="specialchar">\"</span><span class="string"> from full scan.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">		    g_progname</span><span class="symbol">);</span>

<span class="normal">	    gopt_digesttype </span><span class="symbol">=</span><span class="normal"> DT_SHA1</span><span class="symbol">;</span>
<span class="normal">	    gopt_digestfile </span><span class="symbol">=</span><span class="normal"> </span><span class="string">"sha1sum.txt"</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="keyword">return</span><span class="normal"> TRUE</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">    </span><span class="cbracket">}</span>


<span class="normal">    sumfile </span><span class="symbol">=</span><span class="normal"> </span><span class="function">fopen</span><span class="symbol">(</span><span class="normal">gopt_digestfile</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"rb"</span><span class="symbol">);</span>
<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">sumfile </span><span class="symbol">==</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">errno </span><span class="symbol">==</span><span class="normal"> ENOENT</span><span class="symbol">)</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: could not open digest file </span><span class="specialchar">\"</span><span class="string">%s</span><span class="specialchar">\"</span><span class="string">: performing full scan.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">		    g_progname</span><span class="symbol">,</span><span class="normal"> gopt_digestfile</span><span class="symbol">);</span>

<span class="normal">	    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_digesttype </span><span class="symbol">==</span><span class="normal"> DT_NONE</span><span class="symbol">)</span>
<span class="normal">	    </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: to create a new digest file specify the digest --type (see --help).</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">			g_progname</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> FALSE</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="cbracket">}</span>

<span class="normal">	    </span><span class="keyword">return</span><span class="normal"> TRUE</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">else</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: could not open digest file </span><span class="specialchar">\"</span><span class="string">%s</span><span class="specialchar">\"</span><span class="string">: %s</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">		    g_progname</span><span class="symbol">,</span><span class="normal"> gopt_digestfile</span><span class="symbol">,</span><span class="normal"> </span><span class="function">strerror</span><span class="symbol">(</span><span class="normal">errno</span><span class="symbol">));</span>
<span class="normal">	    </span><span class="keyword">return</span><span class="normal"> FALSE</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="function">memset</span><span class="symbol">(&amp;</span><span class="normal">tempinfo</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">FileInfo</span><span class="symbol">));</span>
<span class="normal">    tempinfo</span><span class="symbol">.</span><span class="normal">status </span><span class="symbol">=</span><span class="normal"> FS_UNSEEN</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">linelen </span><span class="symbol">=</span><span class="normal"> </span><span class="function">getline</span><span class="symbol">(&amp;</span><span class="normal">line</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">linemax</span><span class="symbol">,</span><span class="normal"> sumfile</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">0</span><span class="normal"> </span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="symbol">++</span><span class="normal">linenum</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">res </span><span class="symbol">==</span><span class="normal"> </span><span class="symbol">-</span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="comment">/* last line indicated eof */</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: </span><span class="specialchar">\"</span><span class="string">%s</span><span class="specialchar">\"</span><span class="string"> line %d: superfluous line after eof.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">		    g_progname</span><span class="symbol">,</span><span class="normal"> gopt_digestfile</span><span class="symbol">,</span><span class="normal"> linenum</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	nextcrc </span><span class="symbol">=</span><span class="normal"> </span><span class="function">crc32</span><span class="symbol">(</span><span class="normal">crc</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">(</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">char</span><span class="symbol">*)</span><span class="normal">line</span><span class="symbol">,</span><span class="normal"> linelen</span><span class="symbol">);</span>

<span class="normal">	</span><span class="comment">/* remove trailing newline */</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">linelen </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">0</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> line</span><span class="symbol">[</span><span class="normal">linelen</span><span class="symbol">-</span><span class="number">1</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="string">'</span><span class="specialchar">\n</span><span class="string">'</span><span class="symbol">)</span>
<span class="normal">	    line</span><span class="symbol">[</span><span class="normal">linelen</span><span class="symbol">-</span><span class="number">1</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">	res </span><span class="symbol">=</span><span class="normal"> </span><span class="function">parse_digestline</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">,</span><span class="normal"> linenum</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">tempinfo</span><span class="symbol">,</span><span class="normal"> crc</span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">res </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="comment">/* Illegal or valid digest line found. Clear fileinfo. */</span>

<span class="normal">	    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">tempinfo</span><span class="symbol">.</span><span class="normal">symlink</span><span class="symbol">)</span>
<span class="normal">		</span><span class="function">free</span><span class="symbol">(</span><span class="normal">tempinfo</span><span class="symbol">.</span><span class="normal">symlink</span><span class="symbol">);</span>

<span class="normal">	    </span><span class="function">memset</span><span class="symbol">(&amp;</span><span class="normal">tempinfo</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">FileInfo</span><span class="symbol">));</span>
<span class="normal">	    tempinfo</span><span class="symbol">.</span><span class="normal">status </span><span class="symbol">=</span><span class="normal"> FS_UNSEEN</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	crc </span><span class="symbol">=</span><span class="normal"> nextcrc</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">)</span><span class="normal"> </span><span class="function">free</span><span class="symbol">(</span><span class="normal">line</span><span class="symbol">);</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">rb_isempty</span><span class="symbol">(</span><span class="normal">g_filelist</span><span class="symbol">))</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: %s: no digests found in file.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">		g_progname</span><span class="symbol">,</span><span class="normal"> gopt_digestfile</span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_digesttype </span><span class="symbol">==</span><span class="normal"> DT_NONE</span><span class="symbol">)</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: to create a new digest file specify the digest --type (see --help).</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">		    g_progname</span><span class="symbol">);</span>
<span class="normal">	    </span><span class="keyword">return</span><span class="normal"> FALSE</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="normal">    </span><span class="keyword">else</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="comment">/* Insert all file digests into the map for fast lookup. */</span>
<span class="normal">	</span><span class="comment">/* Simulanteously mark files as skipped that don't match --restrict */</span>

<span class="normal">	</span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">rb_node</span><span class="symbol">*</span><span class="normal"> node</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">node </span><span class="symbol">=</span><span class="normal"> </span><span class="function">rb_begin</span><span class="symbol">(</span><span class="normal">g_filelist</span><span class="symbol">);</span><span class="normal"> node </span><span class="symbol">!=</span><span class="normal"> </span><span class="function">rb_end</span><span class="symbol">(</span><span class="normal">g_filelist</span><span class="symbol">);</span><span class="normal"> node </span><span class="symbol">=</span><span class="normal"> </span><span class="function">rb_successor</span><span class="symbol">(</span><span class="normal">g_filelist</span><span class="symbol">,</span><span class="normal"> node</span><span class="symbol">))</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">FileInfo</span><span class="symbol">*</span><span class="normal"> fileinfo </span><span class="symbol">=</span><span class="normal"> node</span><span class="symbol">-&gt;</span><span class="normal">value</span><span class="symbol">;</span>

<span class="normal">	    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_matchpattern </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="function">strstr</span><span class="symbol">(</span><span class="normal">node</span><span class="symbol">-&gt;</span><span class="normal">key</span><span class="symbol">,</span><span class="normal"> gopt_matchpattern</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">	    </span><span class="cbracket">{</span>
<span class="normal">		fileinfo</span><span class="symbol">-&gt;</span><span class="normal">status </span><span class="symbol">=</span><span class="normal"> FS_SKIPPED</span><span class="symbol">;</span>
<span class="normal">		</span><span class="symbol">++</span><span class="normal">g_filelist_skipped</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="cbracket">}</span>

<span class="normal">	    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">fileinfo</span><span class="symbol">-&gt;</span><span class="normal">digest</span><span class="symbol">)</span>
<span class="normal">	    </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">rb_insert</span><span class="symbol">(</span><span class="normal">g_filedigestmap</span><span class="symbol">,</span><span class="normal"> </span><span class="function">digest_dup</span><span class="symbol">(</span><span class="normal">fileinfo</span><span class="symbol">-&gt;</span><span class="normal">digest</span><span class="symbol">),</span><span class="normal"> node</span><span class="symbol">-&gt;</span><span class="normal">key</span><span class="symbol">);</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="function">fclose</span><span class="symbol">(</span><span class="normal">sumfile</span><span class="symbol">);</span>

<span class="normal">    </span><span class="keyword">return</span><span class="normal"> TRUE</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="comment">/*************************************************************</span>
<span class="comment"> * Functions to recursively scan directores and process file *</span>
<span class="comment"> *************************************************************/</span>

<span class="type">bool</span><span class="normal"> </span><span class="function">process_file</span><span class="symbol">(</span><span class="keyword">const</span><span class="normal"> </span><span class="type">char</span><span class="symbol">*</span><span class="normal"> filepath</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> mystatst</span><span class="symbol">*</span><span class="normal"> st</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">rb_node</span><span class="symbol">*</span><span class="normal"> fileiter</span><span class="symbol">;</span>
<span class="normal">    </span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">rb_node</span><span class="symbol">*</span><span class="normal"> digestiter</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">filepath</span><span class="symbol">[</span><span class="number">0</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="string">'.'</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> filepath</span><span class="symbol">[</span><span class="number">1</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="string">'/'</span><span class="symbol">)</span>
<span class="normal">	filepath </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>

<span class="normal">    </span><span class="comment">/* skip over the digestfile */</span>
<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">strcmp</span><span class="symbol">(</span><span class="normal">filepath</span><span class="symbol">,</span><span class="normal"> gopt_digestfile</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> TRUE</span><span class="symbol">;</span>

<span class="normal">    </span><span class="comment">/* silently skip over ignored filepaths */</span>
<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_matchpattern </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="function">strstr</span><span class="symbol">(</span><span class="normal">filepath</span><span class="symbol">,</span><span class="normal"> gopt_matchpattern</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> TRUE</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_verbose </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s "</span><span class="symbol">,</span><span class="normal"> filepath</span><span class="symbol">);</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="comment">/* lookup file info for mtime */</span>

<span class="normal">    fileiter </span><span class="symbol">=</span><span class="normal"> </span><span class="function">rb_find</span><span class="symbol">(</span><span class="normal">g_filelist</span><span class="symbol">,</span><span class="normal"> filepath</span><span class="symbol">);</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">fileiter </span><span class="symbol">!=</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">FileInfo</span><span class="symbol">*</span><span class="normal"> fileinfo </span><span class="symbol">=</span><span class="normal"> fileiter</span><span class="symbol">-&gt;</span><span class="normal">value</span><span class="symbol">;</span>
<span class="normal">	digest_result</span><span class="symbol">*</span><span class="normal"> filedigest </span><span class="symbol">=</span><span class="normal"> NULL</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">fileinfo</span><span class="symbol">-&gt;</span><span class="normal">status </span><span class="symbol">!=</span><span class="normal"> FS_UNSEEN</span><span class="symbol">)</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_verbose </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">" same file processed twice??? This should never occur.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	    </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s same file processed twice??? This should never occur.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> filepath</span><span class="symbol">);</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	    </span><span class="keyword">return</span><span class="normal"> TRUE</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_fullcheck</span><span class="symbol">)</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_verbose </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"check "</span><span class="symbol">);</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="symbol">)</span><span class="function">abs</span><span class="symbol">(</span><span class="normal">st</span><span class="symbol">-&gt;</span><span class="normal">st_mtime </span><span class="symbol">-</span><span class="normal"> fileinfo</span><span class="symbol">-&gt;</span><span class="normal">mtime</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;</span><span class="normal"> gopt_modify_window </span><span class="symbol">||</span>
<span class="normal">		 st</span><span class="symbol">-&gt;</span><span class="normal">st_size </span><span class="symbol">!=</span><span class="normal"> fileinfo</span><span class="symbol">-&gt;</span><span class="normal">size</span><span class="symbol">)</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_verbose </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"touched "</span><span class="symbol">);</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">else</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_verbose </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"untouched.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	    </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_verbose </span><span class="symbol">==</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">!</span><span class="normal">gopt_onlymodified</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s untouched.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> filepath</span><span class="symbol">);</span>
<span class="normal">	    </span><span class="cbracket">}</span>

<span class="normal">	    fileinfo</span><span class="symbol">-&gt;</span><span class="normal">status </span><span class="symbol">=</span><span class="normal"> FS_SEEN</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="symbol">++</span><span class="normal">g_filelist_seen</span><span class="symbol">;</span>

<span class="normal">	    </span><span class="keyword">return</span><span class="normal"> TRUE</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="comment">/* calculate file digest */</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="function">digest_file</span><span class="symbol">(</span><span class="normal">filepath</span><span class="symbol">,</span><span class="normal"> st</span><span class="symbol">-&gt;</span><span class="normal">st_size</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">filedigest</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">fileinfo</span><span class="symbol">-&gt;</span><span class="normal">error</span><span class="symbol">))</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    fileinfo</span><span class="symbol">-&gt;</span><span class="normal">status </span><span class="symbol">=</span><span class="normal"> FS_ERROR</span><span class="symbol">;</span>
<span class="normal">	    fileinfo</span><span class="symbol">-&gt;</span><span class="normal">mtime </span><span class="symbol">=</span><span class="normal"> st</span><span class="symbol">-&gt;</span><span class="normal">st_mtime</span><span class="symbol">;</span>
<span class="normal">	    fileinfo</span><span class="symbol">-&gt;</span><span class="normal">size </span><span class="symbol">=</span><span class="normal"> st</span><span class="symbol">-&gt;</span><span class="normal">st_size</span><span class="symbol">;</span>

<span class="normal">	    </span><span class="symbol">++</span><span class="normal">g_filelist_error</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="keyword">return</span><span class="normal"> FALSE</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">fileinfo</span><span class="symbol">-&gt;</span><span class="normal">digest </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="function">digest_equal</span><span class="symbol">(</span><span class="normal">filedigest</span><span class="symbol">,</span><span class="normal"> fileinfo</span><span class="symbol">-&gt;</span><span class="normal">digest</span><span class="symbol">))</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_verbose </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">" matched.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	    </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_verbose </span><span class="symbol">==</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">!</span><span class="normal">gopt_onlymodified</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s matched.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> filepath</span><span class="symbol">);</span>
<span class="normal">	    </span><span class="cbracket">}</span>

<span class="normal">	    fileinfo</span><span class="symbol">-&gt;</span><span class="normal">status </span><span class="symbol">=</span><span class="normal"> FS_TOUCHED</span><span class="symbol">;</span>
<span class="normal">	    fileinfo</span><span class="symbol">-&gt;</span><span class="normal">mtime </span><span class="symbol">=</span><span class="normal"> st</span><span class="symbol">-&gt;</span><span class="normal">st_mtime</span><span class="symbol">;</span>
<span class="normal">	    fileinfo</span><span class="symbol">-&gt;</span><span class="normal">size </span><span class="symbol">=</span><span class="normal"> st</span><span class="symbol">-&gt;</span><span class="normal">st_size</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="function">free</span><span class="symbol">(</span><span class="normal">filedigest</span><span class="symbol">);</span>

<span class="normal">	    </span><span class="symbol">++</span><span class="normal">g_filelist_touched</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">else</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_verbose </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">" CHANGED.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	    </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_verbose </span><span class="symbol">==</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s CHANGED.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> filepath</span><span class="symbol">);</span>
<span class="normal">	    </span><span class="cbracket">}</span>

<span class="normal">	    fileinfo</span><span class="symbol">-&gt;</span><span class="normal">status </span><span class="symbol">=</span><span class="normal"> FS_CHANGED</span><span class="symbol">;</span>
<span class="normal">	    fileinfo</span><span class="symbol">-&gt;</span><span class="normal">mtime </span><span class="symbol">=</span><span class="normal"> st</span><span class="symbol">-&gt;</span><span class="normal">st_mtime</span><span class="symbol">;</span>
<span class="normal">	    fileinfo</span><span class="symbol">-&gt;</span><span class="normal">size </span><span class="symbol">=</span><span class="normal"> st</span><span class="symbol">-&gt;</span><span class="normal">st_size</span><span class="symbol">;</span>

<span class="normal">	    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">fileinfo</span><span class="symbol">-&gt;</span><span class="normal">digest</span><span class="symbol">)</span>
<span class="normal">		</span><span class="function">free</span><span class="symbol">(</span><span class="normal">fileinfo</span><span class="symbol">-&gt;</span><span class="normal">digest</span><span class="symbol">);</span>

<span class="normal">	    fileinfo</span><span class="symbol">-&gt;</span><span class="normal">digest </span><span class="symbol">=</span><span class="normal"> filedigest</span><span class="symbol">;</span>

<span class="normal">	    </span><span class="symbol">++</span><span class="normal">g_filelist_changed</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="keyword">return</span><span class="normal"> TRUE</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="normal">    </span><span class="keyword">else</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">FileInfo</span><span class="symbol">*</span><span class="normal"> fileinfo </span><span class="symbol">=</span><span class="normal"> </span><span class="function">malloc</span><span class="symbol">(</span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">FileInfo</span><span class="symbol">));</span>
<span class="normal">	</span><span class="function">memset</span><span class="symbol">(</span><span class="normal">fileinfo</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">FileInfo</span><span class="symbol">));</span>

<span class="normal">	fileinfo</span><span class="symbol">-&gt;</span><span class="normal">status </span><span class="symbol">=</span><span class="normal"> FS_NEW</span><span class="symbol">;</span>
<span class="normal">	fileinfo</span><span class="symbol">-&gt;</span><span class="normal">mtime </span><span class="symbol">=</span><span class="normal"> st</span><span class="symbol">-&gt;</span><span class="normal">st_mtime</span><span class="symbol">;</span>
<span class="normal">	fileinfo</span><span class="symbol">-&gt;</span><span class="normal">size </span><span class="symbol">=</span><span class="normal"> st</span><span class="symbol">-&gt;</span><span class="normal">st_size</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="function">digest_file</span><span class="symbol">(</span><span class="normal">filepath</span><span class="symbol">,</span><span class="normal"> st</span><span class="symbol">-&gt;</span><span class="normal">st_size</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">fileinfo</span><span class="symbol">-&gt;</span><span class="normal">digest</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">fileinfo</span><span class="symbol">-&gt;</span><span class="normal">error</span><span class="symbol">))</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    fileinfo</span><span class="symbol">-&gt;</span><span class="normal">status </span><span class="symbol">=</span><span class="normal"> FS_ERROR</span><span class="symbol">;</span>

<span class="normal">	    </span><span class="function">rb_insert</span><span class="symbol">(</span><span class="normal">g_filelist</span><span class="symbol">,</span><span class="normal"> </span><span class="function">strdup</span><span class="symbol">(</span><span class="normal">filepath</span><span class="symbol">),</span><span class="normal"> fileinfo</span><span class="symbol">);</span>

<span class="normal">	    </span><span class="symbol">++</span><span class="normal">g_filelist_error</span><span class="symbol">;</span>

<span class="normal">	    </span><span class="keyword">return</span><span class="normal"> FALSE</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="comment">/* look for existing file with equal digest */</span>
<span class="normal">	digestiter </span><span class="symbol">=</span><span class="normal"> </span><span class="function">rb_find</span><span class="symbol">(</span><span class="normal">g_filedigestmap</span><span class="symbol">,</span><span class="normal"> fileinfo</span><span class="symbol">-&gt;</span><span class="normal">digest</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">digestiter </span><span class="symbol">!=</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="type">bool</span><span class="normal"> copied </span><span class="symbol">=</span><span class="normal"> FALSE</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">rb_node</span><span class="symbol">*</span><span class="normal"> nodecopy </span><span class="symbol">=</span><span class="normal"> digestiter</span><span class="symbol">;</span>

<span class="normal">	    </span><span class="comment">/* test if the oldfile still exists. */</span>
<span class="normal">	    </span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">nodecopy </span><span class="symbol">!=</span><span class="normal"> </span><span class="function">rb_end</span><span class="symbol">(</span><span class="normal">g_filedigestmap</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span>
<span class="normal">		   </span><span class="function">digest_equal</span><span class="symbol">((</span><span class="normal">digest_result</span><span class="symbol">*)</span><span class="normal">nodecopy</span><span class="symbol">-&gt;</span><span class="normal">key</span><span class="symbol">,</span><span class="normal"> fileinfo</span><span class="symbol">-&gt;</span><span class="normal">digest</span><span class="symbol">))</span>
<span class="normal">	    </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">access</span><span class="symbol">((</span><span class="type">char</span><span class="symbol">*)</span><span class="normal">nodecopy</span><span class="symbol">-&gt;</span><span class="normal">value</span><span class="symbol">,</span><span class="normal"> F_OK</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">		</span><span class="cbracket">{</span>
<span class="normal">		    copied </span><span class="symbol">=</span><span class="normal"> TRUE</span><span class="symbol">;</span>
<span class="normal">		    digestiter </span><span class="symbol">=</span><span class="normal"> nodecopy</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">else</span>
<span class="normal">		</span><span class="cbracket">{</span>
<span class="normal">		    </span><span class="comment">/* lookup FileInfo of matching file and set oldpath flags */</span>
<span class="normal">		    </span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">rb_node</span><span class="symbol">*</span><span class="normal"> filenode </span><span class="symbol">=</span><span class="normal"> </span><span class="function">rb_find</span><span class="symbol">(</span><span class="normal">g_filelist</span><span class="symbol">,</span><span class="normal"> nodecopy</span><span class="symbol">-&gt;</span><span class="normal">value</span><span class="symbol">);</span>

<span class="normal">		    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">filenode </span><span class="symbol">==</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">		    </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"</span><span class="specialchar">\n</span><span class="string">%s: internal error. Cannot find entry for matching file.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">				g_progname</span><span class="symbol">);</span>
<span class="normal">		    </span><span class="cbracket">}</span>
<span class="normal">		    </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(((</span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">FileInfo</span><span class="symbol">*)</span><span class="normal">filenode</span><span class="symbol">-&gt;</span><span class="normal">value</span><span class="symbol">)-&gt;</span><span class="normal">status </span><span class="symbol">==</span><span class="normal"> FS_UNSEEN</span><span class="symbol">)</span>
<span class="normal">		    </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="symbol">((</span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">FileInfo</span><span class="symbol">*)</span><span class="normal">filenode</span><span class="symbol">-&gt;</span><span class="normal">value</span><span class="symbol">)-&gt;</span><span class="normal">status </span><span class="symbol">=</span><span class="normal"> FS_OLDPATH</span><span class="symbol">;</span>
<span class="normal">			</span><span class="symbol">++</span><span class="normal">g_filelist_oldpath</span><span class="symbol">;</span>
<span class="normal">		    </span><span class="cbracket">}</span>
<span class="normal">		    </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(((</span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">FileInfo</span><span class="symbol">*)</span><span class="normal">filenode</span><span class="symbol">-&gt;</span><span class="normal">value</span><span class="symbol">)-&gt;</span><span class="normal">status </span><span class="symbol">==</span><span class="normal"> FS_OLDPATH</span><span class="symbol">)</span>
<span class="normal">		    </span><span class="cbracket">{</span>
<span class="normal">		    </span><span class="cbracket">}</span>
<span class="normal">		    </span><span class="keyword">else</span>
<span class="normal">		    </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"</span><span class="specialchar">\n</span><span class="string">%s: renamed original file still existed when scanning.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">				g_progname</span><span class="symbol">);</span>
<span class="normal">		    </span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span>

<span class="normal">		nodecopy </span><span class="symbol">=</span><span class="normal"> </span><span class="function">rb_successor</span><span class="symbol">(</span><span class="normal">g_filedigestmap</span><span class="symbol">,</span><span class="normal"> nodecopy</span><span class="symbol">);</span>
<span class="normal">	    </span><span class="cbracket">}</span>

<span class="normal">	    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">copied</span><span class="symbol">)</span>
<span class="normal">	    </span><span class="cbracket">{</span>
<span class="normal">		fileinfo</span><span class="symbol">-&gt;</span><span class="normal">status </span><span class="symbol">=</span><span class="normal"> FS_COPIED</span><span class="symbol">;</span>
<span class="normal">		</span><span class="symbol">++</span><span class="normal">g_filelist_copied</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_verbose </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		    </span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">" copied.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_verbose </span><span class="symbol">==</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		    </span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s copied.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> filepath</span><span class="symbol">);</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	    </span><span class="keyword">else</span>
<span class="normal">	    </span><span class="cbracket">{</span>
<span class="normal"> 		fileinfo</span><span class="symbol">-&gt;</span><span class="normal">status </span><span class="symbol">=</span><span class="normal"> FS_RENAMED</span><span class="symbol">;</span>
<span class="normal">		</span><span class="symbol">++</span><span class="normal">g_filelist_renamed</span><span class="symbol">;</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_verbose </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		    </span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">" renamed.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_verbose </span><span class="symbol">==</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		    </span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s renamed.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> filepath</span><span class="symbol">);</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	    </span><span class="cbracket">}</span>

<span class="normal">	    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_verbose </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"&lt;-- %s"</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">(</span><span class="type">char</span><span class="symbol">*)</span><span class="normal">digestiter</span><span class="symbol">-&gt;</span><span class="normal">value</span><span class="symbol">);</span>
<span class="normal">	    </span><span class="cbracket">}</span>

<span class="normal">	    fileinfo</span><span class="symbol">-&gt;</span><span class="normal">oldpath </span><span class="symbol">=</span><span class="normal"> </span><span class="function">strdup</span><span class="symbol">((</span><span class="type">char</span><span class="symbol">*)</span><span class="normal">digestiter</span><span class="symbol">-&gt;</span><span class="normal">value</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="function">rb_insert</span><span class="symbol">(</span><span class="normal">g_filelist</span><span class="symbol">,</span><span class="normal"> </span><span class="function">strdup</span><span class="symbol">(</span><span class="normal">filepath</span><span class="symbol">),</span><span class="normal"> fileinfo</span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">fileinfo</span><span class="symbol">-&gt;</span><span class="normal">status </span><span class="symbol">==</span><span class="normal"> FS_NEW</span><span class="symbol">)</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_verbose </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">" new."</span><span class="symbol">);</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	    </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_verbose </span><span class="symbol">==</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s new."</span><span class="symbol">,</span><span class="normal"> filepath</span><span class="symbol">);</span>
<span class="normal">	    </span><span class="cbracket">}</span>

<span class="normal">	    </span><span class="symbol">++</span><span class="normal">g_filelist_new</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_verbose </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> TRUE</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="type">bool</span><span class="normal"> </span><span class="function">process_symlink</span><span class="symbol">(</span><span class="keyword">const</span><span class="normal"> </span><span class="type">char</span><span class="symbol">*</span><span class="normal"> filepath</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> mystatst</span><span class="symbol">*</span><span class="normal"> st</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">rb_node</span><span class="symbol">*</span><span class="normal"> fileiter</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">filepath</span><span class="symbol">[</span><span class="number">0</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="string">'.'</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> filepath</span><span class="symbol">[</span><span class="number">1</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="string">'/'</span><span class="symbol">)</span>
<span class="normal">	filepath </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>

<span class="normal">    </span><span class="comment">/* skip over the digestfile */</span>
<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">strcmp</span><span class="symbol">(</span><span class="normal">filepath</span><span class="symbol">,</span><span class="normal"> gopt_digestfile</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> TRUE</span><span class="symbol">;</span>

<span class="normal">    </span><span class="comment">/* silently skip over ignored filepaths */</span>
<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_matchpattern </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="function">strstr</span><span class="symbol">(</span><span class="normal">filepath</span><span class="symbol">,</span><span class="normal"> gopt_matchpattern</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> TRUE</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_verbose </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s "</span><span class="symbol">,</span><span class="normal"> filepath</span><span class="symbol">);</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="comment">/* lookup file info */</span>

<span class="normal">    fileiter </span><span class="symbol">=</span><span class="normal"> </span><span class="function">rb_find</span><span class="symbol">(</span><span class="normal">g_filelist</span><span class="symbol">,</span><span class="normal"> filepath</span><span class="symbol">);</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">fileiter </span><span class="symbol">!=</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">FileInfo</span><span class="symbol">*</span><span class="normal"> fileinfo </span><span class="symbol">=</span><span class="normal"> fileiter</span><span class="symbol">-&gt;</span><span class="normal">value</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">char</span><span class="symbol">*</span><span class="normal"> linktarget </span><span class="symbol">=</span><span class="normal"> NULL</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">fileinfo</span><span class="symbol">-&gt;</span><span class="normal">status </span><span class="symbol">!=</span><span class="normal"> FS_UNSEEN</span><span class="symbol">)</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_verbose </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">" same symlink processed twice??? This should never occur.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	    </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s same symlink processed twice??? This should never occur.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> filepath</span><span class="symbol">);</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	    </span><span class="keyword">return</span><span class="normal"> TRUE</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="comment">/* mimic method used for regular files even though reading a</span>
<span class="comment">	 * symlink is no expensive operation. */</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_fullcheck</span><span class="symbol">)</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_verbose </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"check "</span><span class="symbol">);</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">st</span><span class="symbol">-&gt;</span><span class="normal">st_mtime </span><span class="symbol">!=</span><span class="normal"> fileinfo</span><span class="symbol">-&gt;</span><span class="normal">mtime </span><span class="symbol">||</span>
<span class="normal">		 st</span><span class="symbol">-&gt;</span><span class="normal">st_size </span><span class="symbol">!=</span><span class="normal"> fileinfo</span><span class="symbol">-&gt;</span><span class="normal">size</span><span class="symbol">)</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_verbose </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"touched "</span><span class="symbol">);</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">else</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_verbose </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"untouched.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	    </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_verbose </span><span class="symbol">==</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">!</span><span class="normal">gopt_onlymodified</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s untouched.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> filepath</span><span class="symbol">);</span>
<span class="normal">	    </span><span class="cbracket">}</span>

<span class="normal">	    fileinfo</span><span class="symbol">-&gt;</span><span class="normal">status </span><span class="symbol">=</span><span class="normal"> FS_SEEN</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="symbol">++</span><span class="normal">g_filelist_seen</span><span class="symbol">;</span>

<span class="normal">	    </span><span class="keyword">return</span><span class="normal"> TRUE</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	linktarget </span><span class="symbol">=</span><span class="normal"> </span><span class="function">readlink_dup</span><span class="symbol">(</span><span class="normal">filepath</span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">linktarget</span><span class="symbol">)</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_verbose </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">" ERROR. Could not read symlink: %s.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> </span><span class="function">strerror</span><span class="symbol">(</span><span class="normal">errno</span><span class="symbol">));</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	    </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_verbose </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s ERROR. Could not read symlink: %s.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> filepath</span><span class="symbol">,</span><span class="normal"> </span><span class="function">strerror</span><span class="symbol">(</span><span class="normal">errno</span><span class="symbol">));</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	    </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_verbose </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: could not read symlink </span><span class="specialchar">\"</span><span class="string">%s</span><span class="specialchar">\"</span><span class="string">: %s.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">			g_progname</span><span class="symbol">,</span><span class="normal"> filepath</span><span class="symbol">,</span><span class="normal"> </span><span class="function">strerror</span><span class="symbol">(</span><span class="normal">errno</span><span class="symbol">));</span>
<span class="normal">	    </span><span class="cbracket">}</span>

<span class="normal">	    </span><span class="function">asprintf</span><span class="symbol">(&amp;</span><span class="normal">fileinfo</span><span class="symbol">-&gt;</span><span class="normal">error</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"Could not read symlink: %s."</span><span class="symbol">,</span><span class="normal"> </span><span class="function">strerror</span><span class="symbol">(</span><span class="normal">errno</span><span class="symbol">));</span>

<span class="normal">	    fileinfo</span><span class="symbol">-&gt;</span><span class="normal">status </span><span class="symbol">=</span><span class="normal"> FS_ERROR</span><span class="symbol">;</span>
<span class="normal">	    fileinfo</span><span class="symbol">-&gt;</span><span class="normal">mtime </span><span class="symbol">=</span><span class="normal"> st</span><span class="symbol">-&gt;</span><span class="normal">st_mtime</span><span class="symbol">;</span>
<span class="normal">	    fileinfo</span><span class="symbol">-&gt;</span><span class="normal">size </span><span class="symbol">=</span><span class="normal"> st</span><span class="symbol">-&gt;</span><span class="normal">st_size</span><span class="symbol">;</span>

<span class="normal">	    </span><span class="symbol">++</span><span class="normal">g_filelist_error</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="keyword">return</span><span class="normal"> FALSE</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">fileinfo</span><span class="symbol">-&gt;</span><span class="normal">symlink </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="function">strcmp</span><span class="symbol">(</span><span class="normal">linktarget</span><span class="symbol">,</span><span class="normal"> fileinfo</span><span class="symbol">-&gt;</span><span class="normal">symlink</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_verbose </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"matched.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	    </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_verbose </span><span class="symbol">==</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">!</span><span class="normal">gopt_onlymodified</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s matched.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> filepath</span><span class="symbol">);</span>
<span class="normal">	    </span><span class="cbracket">}</span>

<span class="normal">	    fileinfo</span><span class="symbol">-&gt;</span><span class="normal">status </span><span class="symbol">=</span><span class="normal"> FS_TOUCHED</span><span class="symbol">;</span>
<span class="normal">	    fileinfo</span><span class="symbol">-&gt;</span><span class="normal">mtime </span><span class="symbol">=</span><span class="normal"> st</span><span class="symbol">-&gt;</span><span class="normal">st_mtime</span><span class="symbol">;</span>
<span class="normal">	    fileinfo</span><span class="symbol">-&gt;</span><span class="normal">size </span><span class="symbol">=</span><span class="normal"> st</span><span class="symbol">-&gt;</span><span class="normal">st_size</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="function">free</span><span class="symbol">(</span><span class="normal">linktarget</span><span class="symbol">);</span>

<span class="normal">	    </span><span class="symbol">++</span><span class="normal">g_filelist_touched</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">else</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_verbose </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"CHANGED.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	    </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_verbose </span><span class="symbol">==</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s CHANGED.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> filepath</span><span class="symbol">);</span>
<span class="normal">	    </span><span class="cbracket">}</span>

<span class="normal">	    fileinfo</span><span class="symbol">-&gt;</span><span class="normal">status </span><span class="symbol">=</span><span class="normal"> FS_CHANGED</span><span class="symbol">;</span>
<span class="normal">	    fileinfo</span><span class="symbol">-&gt;</span><span class="normal">mtime </span><span class="symbol">=</span><span class="normal"> st</span><span class="symbol">-&gt;</span><span class="normal">st_mtime</span><span class="symbol">;</span>
<span class="normal">	    fileinfo</span><span class="symbol">-&gt;</span><span class="normal">size </span><span class="symbol">=</span><span class="normal"> st</span><span class="symbol">-&gt;</span><span class="normal">st_size</span><span class="symbol">;</span>

<span class="normal">	    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">fileinfo</span><span class="symbol">-&gt;</span><span class="normal">symlink</span><span class="symbol">)</span>
<span class="normal">		</span><span class="function">free</span><span class="symbol">(</span><span class="normal">fileinfo</span><span class="symbol">-&gt;</span><span class="normal">symlink</span><span class="symbol">);</span>

<span class="normal">	    fileinfo</span><span class="symbol">-&gt;</span><span class="normal">symlink </span><span class="symbol">=</span><span class="normal"> linktarget</span><span class="symbol">;</span>

<span class="normal">	    </span><span class="symbol">++</span><span class="normal">g_filelist_changed</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="keyword">return</span><span class="normal"> TRUE</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="normal">    </span><span class="keyword">else</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">FileInfo</span><span class="symbol">*</span><span class="normal"> fileinfo </span><span class="symbol">=</span><span class="normal"> </span><span class="function">malloc</span><span class="symbol">(</span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">FileInfo</span><span class="symbol">));</span>
<span class="normal">	</span><span class="function">memset</span><span class="symbol">(</span><span class="normal">fileinfo</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">FileInfo</span><span class="symbol">));</span>

<span class="normal">	fileinfo</span><span class="symbol">-&gt;</span><span class="normal">status </span><span class="symbol">=</span><span class="normal"> FS_NEW</span><span class="symbol">;</span>
<span class="normal">	fileinfo</span><span class="symbol">-&gt;</span><span class="normal">mtime </span><span class="symbol">=</span><span class="normal"> st</span><span class="symbol">-&gt;</span><span class="normal">st_mtime</span><span class="symbol">;</span>
<span class="normal">	fileinfo</span><span class="symbol">-&gt;</span><span class="normal">size </span><span class="symbol">=</span><span class="normal"> st</span><span class="symbol">-&gt;</span><span class="normal">st_size</span><span class="symbol">;</span>
<span class="normal">	fileinfo</span><span class="symbol">-&gt;</span><span class="normal">symlink </span><span class="symbol">=</span><span class="normal"> </span><span class="function">readlink_dup</span><span class="symbol">(</span><span class="normal">filepath</span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">fileinfo</span><span class="symbol">-&gt;</span><span class="normal">symlink</span><span class="symbol">)</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_verbose </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">" ERROR. Could not read symlink: %s.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> </span><span class="function">strerror</span><span class="symbol">(</span><span class="normal">errno</span><span class="symbol">));</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	    </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_verbose </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s ERROR. Could not read symlink: %s.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> filepath</span><span class="symbol">,</span><span class="normal"> </span><span class="function">strerror</span><span class="symbol">(</span><span class="normal">errno</span><span class="symbol">));</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	    </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_verbose </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: could not read symlink </span><span class="specialchar">\"</span><span class="string">%s</span><span class="specialchar">\"</span><span class="string">: %s.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">			g_progname</span><span class="symbol">,</span><span class="normal"> filepath</span><span class="symbol">,</span><span class="normal"> </span><span class="function">strerror</span><span class="symbol">(</span><span class="normal">errno</span><span class="symbol">));</span>
<span class="normal">	    </span><span class="cbracket">}</span>

<span class="normal">	    </span><span class="function">asprintf</span><span class="symbol">(&amp;</span><span class="normal">fileinfo</span><span class="symbol">-&gt;</span><span class="normal">error</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"Could not read symlink: %s."</span><span class="symbol">,</span><span class="normal"> </span><span class="function">strerror</span><span class="symbol">(</span><span class="normal">errno</span><span class="symbol">));</span>

<span class="normal">	    fileinfo</span><span class="symbol">-&gt;</span><span class="normal">status </span><span class="symbol">=</span><span class="normal"> FS_ERROR</span><span class="symbol">;</span>

<span class="normal">	    </span><span class="function">rb_insert</span><span class="symbol">(</span><span class="normal">g_filelist</span><span class="symbol">,</span><span class="normal"> </span><span class="function">strdup</span><span class="symbol">(</span><span class="normal">filepath</span><span class="symbol">),</span><span class="normal"> fileinfo</span><span class="symbol">);</span>

<span class="normal">	    </span><span class="symbol">++</span><span class="normal">g_filelist_error</span><span class="symbol">;</span>

<span class="normal">	    </span><span class="keyword">return</span><span class="normal"> FALSE</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="function">rb_insert</span><span class="symbol">(</span><span class="normal">g_filelist</span><span class="symbol">,</span><span class="normal"> </span><span class="function">strdup</span><span class="symbol">(</span><span class="normal">filepath</span><span class="symbol">),</span><span class="normal"> fileinfo</span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_verbose </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"new.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_verbose </span><span class="symbol">==</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s new.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> filepath</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="symbol">++</span><span class="normal">g_filelist_new</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">return</span><span class="normal"> TRUE</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="comment">/**</span>
<span class="comment"> * Dynamically growing array of (dev_t, ino_t) pairs to test for</span>
<span class="comment"> * symlink loops while scanning.</span>
<span class="comment"> */</span>

<span class="keyword">struct</span><span class="normal"> </span><span class="classname">DirLevel</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="usertype">dev_t</span><span class="normal">	dev</span><span class="symbol">;</span>
<span class="normal">    </span><span class="usertype">ino_t</span><span class="normal">	ino</span><span class="symbol">;</span>
<span class="cbracket">}</span><span class="symbol">;</span>

<span class="keyword">struct</span><span class="normal"> </span><span class="classname">DirLevel</span><span class="symbol">*</span><span class="normal"> dirstack </span><span class="symbol">=</span><span class="normal"> NULL</span><span class="symbol">;</span>
<span class="usertype">size_t</span><span class="normal"> dirstackmax </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="usertype">size_t</span><span class="normal"> dirstacklen </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="type">bool</span><span class="normal"> </span><span class="function">dirstack_push</span><span class="symbol">(</span><span class="keyword">const</span><span class="normal"> mystatst</span><span class="symbol">*</span><span class="normal"> st</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="preproc">#if</span><span class="normal"> </span><span class="symbol">!</span><span class="normal">ON_WIN32 </span><span class="comment">/* win32 under mingw has no inode numbers. */</span>

<span class="normal">    </span><span class="usertype">size_t</span><span class="normal"> i</span><span class="symbol">;</span>

<span class="normal">    </span><span class="comment">/* first search in the current stack for the new level */</span>
<span class="normal">    </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> i </span><span class="symbol">&lt;</span><span class="normal"> dirstacklen</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">++</span><span class="normal">i</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dirstack</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">dev </span><span class="symbol">==</span><span class="normal"> st</span><span class="symbol">-&gt;</span><span class="normal">st_dev </span><span class="symbol">&amp;&amp;</span>
<span class="normal">	    dirstack</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">ino </span><span class="symbol">==</span><span class="normal"> st</span><span class="symbol">-&gt;</span><span class="normal">st_ino</span><span class="symbol">)</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="keyword">return</span><span class="normal"> FALSE</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="preproc">#endif</span>

<span class="normal">    </span><span class="comment">/* add new entry */</span>
<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dirstacklen </span><span class="symbol">&gt;=</span><span class="normal"> dirstackmax</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	dirstackmax </span><span class="symbol">=</span><span class="normal"> dirstackmax </span><span class="symbol">*</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dirstackmax </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">16</span><span class="symbol">)</span><span class="normal"> dirstackmax </span><span class="symbol">=</span><span class="normal"> </span><span class="number">16</span><span class="symbol">;</span>

<span class="normal">	dirstack </span><span class="symbol">=</span><span class="normal"> </span><span class="function">realloc</span><span class="symbol">(</span><span class="normal">dirstack</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">DirLevel</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> dirstackmax</span><span class="symbol">);</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    dirstack</span><span class="symbol">[</span><span class="normal">dirstacklen</span><span class="symbol">].</span><span class="normal">dev </span><span class="symbol">=</span><span class="normal"> st</span><span class="symbol">-&gt;</span><span class="normal">st_dev</span><span class="symbol">;</span>
<span class="normal">    dirstack</span><span class="symbol">[</span><span class="normal">dirstacklen</span><span class="symbol">].</span><span class="normal">ino </span><span class="symbol">=</span><span class="normal"> st</span><span class="symbol">-&gt;</span><span class="normal">st_ino</span><span class="symbol">;</span>

<span class="normal">    </span><span class="symbol">++</span><span class="normal">dirstacklen</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">return</span><span class="normal"> TRUE</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> </span><span class="function">dirstack_pop</span><span class="symbol">(</span><span class="keyword">const</span><span class="normal"> mystatst</span><span class="symbol">*</span><span class="normal"> st</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="function">assert</span><span class="symbol">(</span><span class="normal"> dirstacklen </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">0</span><span class="normal"> </span><span class="symbol">);</span>

<span class="normal">    </span><span class="function">assert</span><span class="symbol">(</span><span class="normal"> dirstack</span><span class="symbol">[</span><span class="normal">dirstacklen</span><span class="symbol">-</span><span class="number">1</span><span class="symbol">].</span><span class="normal">dev </span><span class="symbol">==</span><span class="normal"> st</span><span class="symbol">-&gt;</span><span class="normal">st_dev </span><span class="symbol">);</span>
<span class="normal">    </span><span class="function">assert</span><span class="symbol">(</span><span class="normal"> dirstack</span><span class="symbol">[</span><span class="normal">dirstacklen</span><span class="symbol">-</span><span class="number">1</span><span class="symbol">].</span><span class="normal">ino </span><span class="symbol">==</span><span class="normal"> st</span><span class="symbol">-&gt;</span><span class="normal">st_ino </span><span class="symbol">);</span>
<span class="normal">    </span><span class="symbol">(</span><span class="type">void</span><span class="symbol">)</span><span class="normal">st</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dirstacklen </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">	</span><span class="symbol">--</span><span class="normal">dirstacklen</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="type">bool</span><span class="normal"> </span><span class="function">scan_directory</span><span class="symbol">(</span><span class="keyword">const</span><span class="normal"> </span><span class="type">char</span><span class="symbol">*</span><span class="normal"> path</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">const</span><span class="normal"> mystatst</span><span class="symbol">*</span><span class="normal"> st</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    DIR</span><span class="symbol">*</span><span class="normal"> dirp</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">dirent</span><span class="symbol">*</span><span class="normal"> de</span><span class="symbol">;</span>

<span class="normal">    </span><span class="type">char</span><span class="normal"> </span><span class="symbol">**</span><span class="normal">filenames </span><span class="symbol">=</span><span class="normal"> NULL</span><span class="symbol">;</span>
<span class="normal">    </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> filenamepos </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">    </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> filenamemax </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">    </span><span class="type">bool</span><span class="normal"> exclude_marker_found </span><span class="symbol">=</span><span class="normal"> FALSE</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="function">dirstack_push</span><span class="symbol">(</span><span class="normal">st</span><span class="symbol">))</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: filesystem loop detected at </span><span class="specialchar">\"</span><span class="string">%s</span><span class="specialchar">\"</span><span class="string">.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">		g_progname</span><span class="symbol">,</span><span class="normal"> path</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> TRUE</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    dirp </span><span class="symbol">=</span><span class="normal"> </span><span class="function">opendir</span><span class="symbol">(</span><span class="normal">path</span><span class="symbol">);</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dirp </span><span class="symbol">==</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="function">dirstack_pop</span><span class="symbol">(</span><span class="normal">st</span><span class="symbol">);</span>
<span class="normal">	</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: could not open directory </span><span class="specialchar">\"</span><span class="string">%s</span><span class="specialchar">\"</span><span class="string">: %s</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">		g_progname</span><span class="symbol">,</span><span class="normal"> path</span><span class="symbol">,</span><span class="normal"> </span><span class="function">strerror</span><span class="symbol">(</span><span class="normal">errno</span><span class="symbol">));</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> FALSE</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">de </span><span class="symbol">=</span><span class="normal"> </span><span class="function">readdir</span><span class="symbol">(</span><span class="normal">dirp</span><span class="symbol">)))</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">de</span><span class="symbol">-&gt;</span><span class="normal">d_name</span><span class="symbol">[</span><span class="number">0</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="string">'.'</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> de</span><span class="symbol">-&gt;</span><span class="normal">d_name</span><span class="symbol">[</span><span class="number">1</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="keyword">continue</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">de</span><span class="symbol">-&gt;</span><span class="normal">d_name</span><span class="symbol">[</span><span class="number">0</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="string">'.'</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> de</span><span class="symbol">-&gt;</span><span class="normal">d_name</span><span class="symbol">[</span><span class="number">1</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="string">'.'</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> de</span><span class="symbol">-&gt;</span><span class="normal">d_name</span><span class="symbol">[</span><span class="number">2</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="keyword">continue</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">filenamepos </span><span class="symbol">&gt;=</span><span class="normal"> filenamemax</span><span class="symbol">)</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    filenamemax </span><span class="symbol">*=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">filenamemax </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> filenamemax </span><span class="symbol">=</span><span class="normal"> </span><span class="number">8</span><span class="symbol">;</span>
<span class="normal">	    filenames </span><span class="symbol">=</span><span class="normal"> </span><span class="function">realloc</span><span class="symbol">(</span><span class="normal">filenames</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="type">char</span><span class="symbol">*)</span><span class="normal"> </span><span class="symbol">*</span><span class="normal"> filenamemax</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	filenames</span><span class="symbol">[</span><span class="normal">filenamepos</span><span class="symbol">++]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="function">strdup</span><span class="symbol">(</span><span class="normal"> de</span><span class="symbol">-&gt;</span><span class="normal">d_name </span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_exclude_marker</span><span class="symbol">)</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">strcmp</span><span class="symbol">(</span><span class="normal">de</span><span class="symbol">-&gt;</span><span class="normal">d_name</span><span class="symbol">,</span><span class="normal"> gopt_exclude_marker</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">		exclude_marker_found </span><span class="symbol">=</span><span class="normal"> TRUE</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="function">closedir</span><span class="symbol">(</span><span class="normal">dirp</span><span class="symbol">);</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">exclude_marker_found</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_verbose </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: exclude marker found in </span><span class="specialchar">\"</span><span class="string">%s</span><span class="specialchar">\"</span><span class="string">: skipping.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">		    g_progname</span><span class="symbol">,</span><span class="normal"> path</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="function">free</span><span class="symbol">(</span><span class="normal">filenames</span><span class="symbol">);</span>
<span class="normal">	</span><span class="function">dirstack_pop</span><span class="symbol">(</span><span class="normal">st</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> TRUE</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="function">qsort</span><span class="symbol">(</span><span class="normal">filenames</span><span class="symbol">,</span><span class="normal"> filenamepos</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="type">char</span><span class="symbol">*),</span><span class="normal"> strcmpptr</span><span class="symbol">);</span>

<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="usertype">mystatst</span><span class="normal"> st</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> fi</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">fi </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> fi </span><span class="symbol">&lt;</span><span class="normal"> filenamepos</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">++</span><span class="normal">fi</span><span class="symbol">)</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="type">char</span><span class="symbol">*</span><span class="normal"> filepath</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="function">asprintf</span><span class="symbol">(&amp;</span><span class="normal">filepath</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s/%s"</span><span class="symbol">,</span><span class="normal"> path</span><span class="symbol">,</span><span class="normal"> filenames</span><span class="symbol">[</span><span class="normal">fi</span><span class="symbol">]);</span>

<span class="normal">	    </span><span class="function">free</span><span class="symbol">(</span><span class="normal">filenames</span><span class="symbol">[</span><span class="normal">fi</span><span class="symbol">]);</span>

<span class="preproc">#ifndef</span><span class="normal"> S_ISSOCK</span>
<span class="preproc">#define</span><span class="normal"> </span><span class="function">S_ISSOCK</span><span class="symbol">(</span><span class="normal">x</span><span class="symbol">)</span><span class="normal"> </span><span class="number">0</span>
<span class="preproc">#endif</span>
<span class="preproc">#ifndef</span><span class="normal"> S_ISLNK</span>
<span class="preproc">#define</span><span class="normal"> </span><span class="function">S_ISLNK</span><span class="symbol">(</span><span class="normal">x</span><span class="symbol">)</span><span class="normal"> </span><span class="number">0</span>
<span class="preproc">#endif</span>

<span class="normal">	    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">mylstat</span><span class="symbol">(</span><span class="normal">filepath</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">st</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">	    </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: could not stat file </span><span class="specialchar">\"</span><span class="string">%s</span><span class="specialchar">\"</span><span class="string">: %s</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">			g_progname</span><span class="symbol">,</span><span class="normal"> filepath</span><span class="symbol">,</span><span class="normal"> </span><span class="function">strerror</span><span class="symbol">(</span><span class="normal">errno</span><span class="symbol">));</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	    </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">S_ISLNK</span><span class="symbol">(</span><span class="normal">st</span><span class="symbol">.</span><span class="normal">st_mode</span><span class="symbol">))</span>
<span class="normal">	    </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">gopt_followsymlinks</span><span class="symbol">)</span>
<span class="normal">		</span><span class="cbracket">{</span>
<span class="normal">		    </span><span class="function">process_symlink</span><span class="symbol">(</span><span class="normal">filepath</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">st</span><span class="symbol">);</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">		</span><span class="keyword">else</span>
<span class="normal">		</span><span class="cbracket">{</span>
<span class="normal">		    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">mystat</span><span class="symbol">(</span><span class="normal">filepath</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">st</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">		    </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: could not stat symlink </span><span class="specialchar">\"</span><span class="string">%s</span><span class="specialchar">\"</span><span class="string">: %s</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">				g_progname</span><span class="symbol">,</span><span class="normal"> filepath</span><span class="symbol">,</span><span class="normal"> </span><span class="function">strerror</span><span class="symbol">(</span><span class="normal">errno</span><span class="symbol">));</span>
<span class="normal">		    </span><span class="cbracket">}</span>
<span class="normal">		    </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">S_ISCHR</span><span class="symbol">(</span><span class="normal">st</span><span class="symbol">.</span><span class="normal">st_mode</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> </span><span class="function">S_ISBLK</span><span class="symbol">(</span><span class="normal">st</span><span class="symbol">.</span><span class="normal">st_mode</span><span class="symbol">))</span>
<span class="normal">		    </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: skipping special device symlink </span><span class="specialchar">\"</span><span class="string">%s</span><span class="specialchar">\"\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">				g_progname</span><span class="symbol">,</span><span class="normal"> filepath</span><span class="symbol">);</span>
<span class="normal">		    </span><span class="cbracket">}</span>
<span class="normal">		    </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">S_ISFIFO</span><span class="symbol">(</span><span class="normal">st</span><span class="symbol">.</span><span class="normal">st_mode</span><span class="symbol">))</span>
<span class="normal">		    </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: skipping named pipe symlink </span><span class="specialchar">\"</span><span class="string">%s</span><span class="specialchar">\"\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">				g_progname</span><span class="symbol">,</span><span class="normal"> filepath</span><span class="symbol">);</span>
<span class="normal">		    </span><span class="cbracket">}</span>
<span class="normal">		    </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">S_ISSOCK</span><span class="symbol">(</span><span class="normal">st</span><span class="symbol">.</span><span class="normal">st_mode</span><span class="symbol">))</span>
<span class="normal">		    </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: skipping unix socket symlink </span><span class="specialchar">\"</span><span class="string">%s</span><span class="specialchar">\"\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">				g_progname</span><span class="symbol">,</span><span class="normal"> filepath</span><span class="symbol">);</span>
<span class="normal">		    </span><span class="cbracket">}</span>
<span class="normal">		    </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">S_ISDIR</span><span class="symbol">(</span><span class="normal">st</span><span class="symbol">.</span><span class="normal">st_mode</span><span class="symbol">))</span>
<span class="normal">		    </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="function">scan_directory</span><span class="symbol">(</span><span class="normal">filepath</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">st</span><span class="symbol">);</span>
<span class="normal">		    </span><span class="cbracket">}</span>
<span class="normal">		    </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="function">S_ISREG</span><span class="symbol">(</span><span class="normal">st</span><span class="symbol">.</span><span class="normal">st_mode</span><span class="symbol">))</span>
<span class="normal">		    </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: skipping special symlink </span><span class="specialchar">\"</span><span class="string">%s</span><span class="specialchar">\"\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">				g_progname</span><span class="symbol">,</span><span class="normal"> filepath</span><span class="symbol">);</span>
<span class="normal">		    </span><span class="cbracket">}</span>
<span class="normal">		    </span><span class="keyword">else</span>
<span class="normal">		    </span><span class="cbracket">{</span>
<span class="normal">			</span><span class="function">process_file</span><span class="symbol">(</span><span class="normal">filepath</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">st</span><span class="symbol">);</span>
<span class="normal">		    </span><span class="cbracket">}</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	    </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">S_ISCHR</span><span class="symbol">(</span><span class="normal">st</span><span class="symbol">.</span><span class="normal">st_mode</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> </span><span class="function">S_ISBLK</span><span class="symbol">(</span><span class="normal">st</span><span class="symbol">.</span><span class="normal">st_mode</span><span class="symbol">))</span>
<span class="normal">	    </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: skipping special device file </span><span class="specialchar">\"</span><span class="string">%s</span><span class="specialchar">\"\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">			g_progname</span><span class="symbol">,</span><span class="normal"> filepath</span><span class="symbol">);</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	    </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">S_ISFIFO</span><span class="symbol">(</span><span class="normal">st</span><span class="symbol">.</span><span class="normal">st_mode</span><span class="symbol">))</span>
<span class="normal">	    </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: skipping named pipe </span><span class="specialchar">\"</span><span class="string">%s</span><span class="specialchar">\"\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">			g_progname</span><span class="symbol">,</span><span class="normal"> filepath</span><span class="symbol">);</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	    </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">S_ISSOCK</span><span class="symbol">(</span><span class="normal">st</span><span class="symbol">.</span><span class="normal">st_mode</span><span class="symbol">))</span>
<span class="normal">	    </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: skipping unix socket </span><span class="specialchar">\"</span><span class="string">%s</span><span class="specialchar">\"\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">			g_progname</span><span class="symbol">,</span><span class="normal"> filepath</span><span class="symbol">);</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	    </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">S_ISDIR</span><span class="symbol">(</span><span class="normal">st</span><span class="symbol">.</span><span class="normal">st_mode</span><span class="symbol">))</span>
<span class="normal">	    </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">scan_directory</span><span class="symbol">(</span><span class="normal">filepath</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">st</span><span class="symbol">);</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	    </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="function">S_ISREG</span><span class="symbol">(</span><span class="normal">st</span><span class="symbol">.</span><span class="normal">st_mode</span><span class="symbol">))</span>
<span class="normal">	    </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: skipping special file </span><span class="specialchar">\"</span><span class="string">%s</span><span class="specialchar">\"\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">			g_progname</span><span class="symbol">,</span><span class="normal"> filepath</span><span class="symbol">);</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	    </span><span class="keyword">else</span>
<span class="normal">	    </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">process_file</span><span class="symbol">(</span><span class="normal">filepath</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">st</span><span class="symbol">);</span>
<span class="normal">	    </span><span class="cbracket">}</span>

<span class="normal">	    </span><span class="function">free</span><span class="symbol">(</span><span class="normal">filepath</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="function">free</span><span class="symbol">(</span><span class="normal">filenames</span><span class="symbol">);</span>
<span class="normal">    </span><span class="function">dirstack_pop</span><span class="symbol">(</span><span class="normal">st</span><span class="symbol">);</span>

<span class="normal">    </span><span class="keyword">return</span><span class="normal"> TRUE</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="type">bool</span><span class="normal"> </span><span class="function">start_scan</span><span class="symbol">(</span><span class="keyword">const</span><span class="normal"> </span><span class="type">char</span><span class="symbol">*</span><span class="normal"> path</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="usertype">mystatst</span><span class="normal"> st</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">mylstat</span><span class="symbol">(</span><span class="normal">path</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">st</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: could not stat path </span><span class="specialchar">\"</span><span class="string">%s</span><span class="specialchar">\"</span><span class="string">: %s</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">		g_progname</span><span class="symbol">,</span><span class="normal"> path</span><span class="symbol">,</span><span class="normal"> </span><span class="function">strerror</span><span class="symbol">(</span><span class="normal">errno</span><span class="symbol">));</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="normal">    </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">S_ISDIR</span><span class="symbol">(</span><span class="normal">st</span><span class="symbol">.</span><span class="normal">st_mode</span><span class="symbol">))</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="function">scan_directory</span><span class="symbol">(</span><span class="normal">path</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">st</span><span class="symbol">);</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="normal">    </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="function">S_ISREG</span><span class="symbol">(</span><span class="normal">st</span><span class="symbol">.</span><span class="normal">st_mode</span><span class="symbol">))</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: skipping special path </span><span class="specialchar">\"</span><span class="string">%s</span><span class="specialchar">\"\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">		g_progname</span><span class="symbol">,</span><span class="normal"> path</span><span class="symbol">);</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="normal">    </span><span class="keyword">else</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="function">process_file</span><span class="symbol">(</span><span class="normal">path</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">st</span><span class="symbol">);</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="keyword">return</span><span class="normal"> FALSE</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="comment">/*************************************************</span>
<span class="comment"> * Functions for interactive scan result review  *</span>
<span class="comment"> *************************************************/</span>

<span class="keyword">struct</span><span class="normal"> </span><span class="classname">CommandEntry</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">const</span><span class="normal"> </span><span class="type">char</span><span class="symbol">*</span><span class="normal"> name</span><span class="symbol">;</span>
<span class="normal">    </span><span class="type">bool</span><span class="normal">	</span><span class="symbol">(*</span><span class="normal">func</span><span class="symbol">)(</span><span class="type">void</span><span class="symbol">);</span>
<span class="normal">    </span><span class="keyword">const</span><span class="normal"> </span><span class="type">char</span><span class="symbol">*</span><span class="normal">	help</span><span class="symbol">;</span>
<span class="cbracket">}</span><span class="symbol">;</span>

<span class="keyword">static</span><span class="normal"> </span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">CommandEntry</span><span class="normal"> cmdlist</span><span class="symbol">[</span><span class="number">16</span><span class="symbol">];</span>

<span class="type">bool</span><span class="normal"> </span><span class="function">filelist_clean</span><span class="symbol">(</span><span class="type">void</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">(</span><span class="normal"> </span><span class="function">rb_size</span><span class="symbol">(</span><span class="normal">g_filelist</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> g_filelist_seen </span><span class="symbol">+</span><span class="normal"> g_filelist_touched </span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> </span><span class="function">filelist_deleted</span><span class="symbol">(</span><span class="type">void</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> </span><span class="function">rb_size</span><span class="symbol">(</span><span class="normal">g_filelist</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">-</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">g_filelist_new </span><span class="symbol">+</span><span class="normal"> g_filelist_seen </span><span class="symbol">+</span><span class="normal"> g_filelist_touched </span><span class="symbol">+</span><span class="normal"> g_filelist_changed </span><span class="symbol">+</span><span class="normal"> g_filelist_error </span><span class="symbol">+</span><span class="normal"> g_filelist_renamed </span><span class="symbol">+</span><span class="normal"> g_filelist_copied </span><span class="symbol">+</span><span class="normal"> g_filelist_oldpath </span><span class="symbol">+</span><span class="normal"> g_filelist_skipped</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> </span><span class="function">print_summary</span><span class="symbol">(</span><span class="type">void</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"File scan summary:</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">g_filelist_new</span><span class="symbol">)</span>
<span class="normal">	</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"        New: %d</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> g_filelist_new</span><span class="symbol">);</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">g_filelist_seen</span><span class="symbol">)</span>
<span class="normal">	</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"  Untouched: %d</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> g_filelist_seen</span><span class="symbol">);</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">g_filelist_touched</span><span class="symbol">)</span>
<span class="normal">	</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"    Touched: %d</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> g_filelist_touched</span><span class="symbol">);</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">g_filelist_changed</span><span class="symbol">)</span>
<span class="normal">	</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"    Changed: %d</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> g_filelist_changed</span><span class="symbol">);</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">g_filelist_error</span><span class="symbol">)</span>
<span class="normal">	</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"     Errors: %d</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> g_filelist_error</span><span class="symbol">);</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">g_filelist_renamed</span><span class="symbol">)</span>
<span class="normal">	</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"    Renamed: %d</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> g_filelist_renamed</span><span class="symbol">);</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">g_filelist_copied</span><span class="symbol">)</span>
<span class="normal">	</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"     Copied: %d</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> g_filelist_copied</span><span class="symbol">);</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">g_filelist_skipped</span><span class="symbol">)</span>
<span class="normal">	</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"    Skipped: %d</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> g_filelist_skipped</span><span class="symbol">);</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">filelist_deleted</span><span class="symbol">())</span>
<span class="normal">	</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"    Deleted: %d</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> </span><span class="function">filelist_deleted</span><span class="symbol">());</span>

<span class="normal">    </span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"      Total: %d</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> </span><span class="function">rb_size</span><span class="symbol">(</span><span class="normal">g_filelist</span><span class="symbol">));</span>
<span class="cbracket">}</span>

<span class="type">bool</span><span class="normal"> </span><span class="function">cmd_help</span><span class="symbol">(</span><span class="type">void</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="type">int</span><span class="normal"> i</span><span class="symbol">;</span>

<span class="normal">    </span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"Commands: (can be abbreviated)</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>

<span class="normal">    </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> cmdlist</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">name</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">++</span><span class="normal">i</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">cmdlist</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">help</span><span class="symbol">)</span><span class="normal"> </span><span class="keyword">continue</span><span class="symbol">;</span>

<span class="normal">	</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"  %-10s %s</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> cmdlist</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">name</span><span class="symbol">,</span><span class="normal"> cmdlist</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">help</span><span class="symbol">);</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="keyword">return</span><span class="normal"> TRUE</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="type">bool</span><span class="normal"> </span><span class="function">cmd_new</span><span class="symbol">(</span><span class="type">void</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">rb_node</span><span class="symbol">*</span><span class="normal"> node</span><span class="symbol">;</span>
<span class="normal">    </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> count </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">node </span><span class="symbol">=</span><span class="normal"> </span><span class="function">rb_begin</span><span class="symbol">(</span><span class="normal">g_filelist</span><span class="symbol">);</span><span class="normal"> node </span><span class="symbol">!=</span><span class="normal"> </span><span class="function">rb_end</span><span class="symbol">(</span><span class="normal">g_filelist</span><span class="symbol">);</span><span class="normal"> node </span><span class="symbol">=</span><span class="normal"> </span><span class="function">rb_successor</span><span class="symbol">(</span><span class="normal">g_filelist</span><span class="symbol">,</span><span class="normal"> node</span><span class="symbol">))</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">const</span><span class="normal"> </span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">FileInfo</span><span class="symbol">*</span><span class="normal"> fileinfo </span><span class="symbol">=</span><span class="normal"> node</span><span class="symbol">-&gt;</span><span class="normal">value</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">fileinfo</span><span class="symbol">-&gt;</span><span class="normal">status </span><span class="symbol">!=</span><span class="normal"> FS_NEW</span><span class="symbol">)</span><span class="normal"> </span><span class="keyword">continue</span><span class="symbol">;</span>

<span class="normal">	</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s new.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">(</span><span class="type">char</span><span class="symbol">*)</span><span class="normal">node</span><span class="symbol">-&gt;</span><span class="normal">key</span><span class="symbol">);</span>
<span class="normal">	</span><span class="symbol">++</span><span class="normal">count</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">count </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: no new files encountered during scan.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">		g_progname</span><span class="symbol">);</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="keyword">return</span><span class="normal"> TRUE</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="type">bool</span><span class="normal"> </span><span class="function">cmd_untouched</span><span class="symbol">(</span><span class="type">void</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">rb_node</span><span class="symbol">*</span><span class="normal"> node</span><span class="symbol">;</span>
<span class="normal">    </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> count </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">node </span><span class="symbol">=</span><span class="normal"> </span><span class="function">rb_begin</span><span class="symbol">(</span><span class="normal">g_filelist</span><span class="symbol">);</span><span class="normal"> node </span><span class="symbol">!=</span><span class="normal"> </span><span class="function">rb_end</span><span class="symbol">(</span><span class="normal">g_filelist</span><span class="symbol">);</span><span class="normal"> node </span><span class="symbol">=</span><span class="normal"> </span><span class="function">rb_successor</span><span class="symbol">(</span><span class="normal">g_filelist</span><span class="symbol">,</span><span class="normal"> node</span><span class="symbol">))</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">const</span><span class="normal"> </span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">FileInfo</span><span class="symbol">*</span><span class="normal"> fileinfo </span><span class="symbol">=</span><span class="normal"> node</span><span class="symbol">-&gt;</span><span class="normal">value</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">fileinfo</span><span class="symbol">-&gt;</span><span class="normal">status </span><span class="symbol">!=</span><span class="normal"> FS_SEEN</span><span class="symbol">)</span><span class="normal"> </span><span class="keyword">continue</span><span class="symbol">;</span>

<span class="normal">	</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s untouched.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">(</span><span class="type">char</span><span class="symbol">*)</span><span class="normal">node</span><span class="symbol">-&gt;</span><span class="normal">key</span><span class="symbol">);</span>
<span class="normal">	</span><span class="symbol">++</span><span class="normal">count</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">count </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: no untouched files encountered during scan.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">		g_progname</span><span class="symbol">);</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="keyword">return</span><span class="normal"> TRUE</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="type">bool</span><span class="normal"> </span><span class="function">cmd_touched</span><span class="symbol">(</span><span class="type">void</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">rb_node</span><span class="symbol">*</span><span class="normal"> node</span><span class="symbol">;</span>
<span class="normal">    </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> count </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">node </span><span class="symbol">=</span><span class="normal"> </span><span class="function">rb_begin</span><span class="symbol">(</span><span class="normal">g_filelist</span><span class="symbol">);</span><span class="normal"> node </span><span class="symbol">!=</span><span class="normal"> </span><span class="function">rb_end</span><span class="symbol">(</span><span class="normal">g_filelist</span><span class="symbol">);</span>
<span class="normal">         node </span><span class="symbol">=</span><span class="normal"> </span><span class="function">rb_successor</span><span class="symbol">(</span><span class="normal">g_filelist</span><span class="symbol">,</span><span class="normal"> node</span><span class="symbol">))</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">const</span><span class="normal"> </span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">FileInfo</span><span class="symbol">*</span><span class="normal"> fileinfo </span><span class="symbol">=</span><span class="normal"> node</span><span class="symbol">-&gt;</span><span class="normal">value</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">fileinfo</span><span class="symbol">-&gt;</span><span class="normal">status </span><span class="symbol">!=</span><span class="normal"> FS_TOUCHED</span><span class="symbol">)</span><span class="normal"> </span><span class="keyword">continue</span><span class="symbol">;</span>

<span class="normal">	</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s touched.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">(</span><span class="type">char</span><span class="symbol">*)</span><span class="normal">node</span><span class="symbol">-&gt;</span><span class="normal">key</span><span class="symbol">);</span>
<span class="normal">	</span><span class="symbol">++</span><span class="normal">count</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">count </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: no touched but unchanged files encountered during scan.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">		g_progname</span><span class="symbol">);</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="keyword">return</span><span class="normal"> TRUE</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="type">bool</span><span class="normal"> </span><span class="function">cmd_changed</span><span class="symbol">(</span><span class="type">void</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">rb_node</span><span class="symbol">*</span><span class="normal"> node</span><span class="symbol">;</span>
<span class="normal">    </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> count </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">node </span><span class="symbol">=</span><span class="normal"> </span><span class="function">rb_begin</span><span class="symbol">(</span><span class="normal">g_filelist</span><span class="symbol">);</span><span class="normal"> node </span><span class="symbol">!=</span><span class="normal"> </span><span class="function">rb_end</span><span class="symbol">(</span><span class="normal">g_filelist</span><span class="symbol">);</span>
<span class="normal">         node </span><span class="symbol">=</span><span class="normal"> </span><span class="function">rb_successor</span><span class="symbol">(</span><span class="normal">g_filelist</span><span class="symbol">,</span><span class="normal"> node</span><span class="symbol">))</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">const</span><span class="normal"> </span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">FileInfo</span><span class="symbol">*</span><span class="normal"> fileinfo </span><span class="symbol">=</span><span class="normal"> node</span><span class="symbol">-&gt;</span><span class="normal">value</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">fileinfo</span><span class="symbol">-&gt;</span><span class="normal">status </span><span class="symbol">!=</span><span class="normal"> FS_CHANGED</span><span class="symbol">)</span><span class="normal"> </span><span class="keyword">continue</span><span class="symbol">;</span>

<span class="normal">	</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s CHANGED.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">(</span><span class="type">char</span><span class="symbol">*)</span><span class="normal">node</span><span class="symbol">-&gt;</span><span class="normal">key</span><span class="symbol">);</span>
<span class="normal">	</span><span class="symbol">++</span><span class="normal">count</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">count </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: no changed files encountered during scan.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">		g_progname</span><span class="symbol">);</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="keyword">return</span><span class="normal"> TRUE</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="type">bool</span><span class="normal"> </span><span class="function">cmd_deleted</span><span class="symbol">(</span><span class="type">void</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">rb_node</span><span class="symbol">*</span><span class="normal"> node</span><span class="symbol">;</span>
<span class="normal">    </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> count </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">node </span><span class="symbol">=</span><span class="normal"> </span><span class="function">rb_begin</span><span class="symbol">(</span><span class="normal">g_filelist</span><span class="symbol">);</span><span class="normal"> node </span><span class="symbol">!=</span><span class="normal"> </span><span class="function">rb_end</span><span class="symbol">(</span><span class="normal">g_filelist</span><span class="symbol">);</span>
<span class="normal">         node </span><span class="symbol">=</span><span class="normal"> </span><span class="function">rb_successor</span><span class="symbol">(</span><span class="normal">g_filelist</span><span class="symbol">,</span><span class="normal"> node</span><span class="symbol">))</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">const</span><span class="normal"> </span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">FileInfo</span><span class="symbol">*</span><span class="normal"> fileinfo </span><span class="symbol">=</span><span class="normal"> node</span><span class="symbol">-&gt;</span><span class="normal">value</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">fileinfo</span><span class="symbol">-&gt;</span><span class="normal">status </span><span class="symbol">!=</span><span class="normal"> FS_UNSEEN</span><span class="symbol">)</span><span class="normal"> </span><span class="keyword">continue</span><span class="symbol">;</span>

<span class="normal">	</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s DELETED.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">(</span><span class="type">char</span><span class="symbol">*)</span><span class="normal">node</span><span class="symbol">-&gt;</span><span class="normal">key</span><span class="symbol">);</span>
<span class="normal">	</span><span class="symbol">++</span><span class="normal">count</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">count </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: no deleted files detected during scan.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">		g_progname</span><span class="symbol">);</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="keyword">return</span><span class="normal"> TRUE</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="type">bool</span><span class="normal"> </span><span class="function">cmd_error</span><span class="symbol">(</span><span class="type">void</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">rb_node</span><span class="symbol">*</span><span class="normal"> node</span><span class="symbol">;</span>
<span class="normal">    </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> count </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">node </span><span class="symbol">=</span><span class="normal"> </span><span class="function">rb_begin</span><span class="symbol">(</span><span class="normal">g_filelist</span><span class="symbol">);</span><span class="normal"> node </span><span class="symbol">!=</span><span class="normal"> </span><span class="function">rb_end</span><span class="symbol">(</span><span class="normal">g_filelist</span><span class="symbol">);</span>
<span class="normal">         node </span><span class="symbol">=</span><span class="normal"> </span><span class="function">rb_successor</span><span class="symbol">(</span><span class="normal">g_filelist</span><span class="symbol">,</span><span class="normal"> node</span><span class="symbol">))</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">const</span><span class="normal"> </span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">FileInfo</span><span class="symbol">*</span><span class="normal"> fileinfo </span><span class="symbol">=</span><span class="normal"> node</span><span class="symbol">-&gt;</span><span class="normal">value</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">fileinfo</span><span class="symbol">-&gt;</span><span class="normal">status </span><span class="symbol">!=</span><span class="normal"> FS_ERROR</span><span class="symbol">)</span><span class="normal"> </span><span class="keyword">continue</span><span class="symbol">;</span>

<span class="normal">	</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s ERROR. %s</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">(</span><span class="type">char</span><span class="symbol">*)</span><span class="normal">node</span><span class="symbol">-&gt;</span><span class="normal">key</span><span class="symbol">,</span><span class="normal"> fileinfo</span><span class="symbol">-&gt;</span><span class="normal">error</span><span class="symbol">);</span>
<span class="normal">	</span><span class="symbol">++</span><span class="normal">count</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">count </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: no errors encountered during scan.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">		g_progname</span><span class="symbol">);</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="keyword">return</span><span class="normal"> TRUE</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="type">bool</span><span class="normal"> </span><span class="function">cmd_copied</span><span class="symbol">(</span><span class="type">void</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">rb_node</span><span class="symbol">*</span><span class="normal"> node</span><span class="symbol">;</span>
<span class="normal">    </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> count </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">node </span><span class="symbol">=</span><span class="normal"> </span><span class="function">rb_begin</span><span class="symbol">(</span><span class="normal">g_filelist</span><span class="symbol">);</span><span class="normal"> node </span><span class="symbol">!=</span><span class="normal"> </span><span class="function">rb_end</span><span class="symbol">(</span><span class="normal">g_filelist</span><span class="symbol">);</span>
<span class="normal">         node </span><span class="symbol">=</span><span class="normal"> </span><span class="function">rb_successor</span><span class="symbol">(</span><span class="normal">g_filelist</span><span class="symbol">,</span><span class="normal"> node</span><span class="symbol">))</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">const</span><span class="normal"> </span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">FileInfo</span><span class="symbol">*</span><span class="normal"> fileinfo </span><span class="symbol">=</span><span class="normal"> node</span><span class="symbol">-&gt;</span><span class="normal">value</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">fileinfo</span><span class="symbol">-&gt;</span><span class="normal">status </span><span class="symbol">!=</span><span class="normal"> FS_COPIED</span><span class="symbol">)</span><span class="normal"> </span><span class="keyword">continue</span><span class="symbol">;</span>

<span class="normal">	</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s copied.</span><span class="specialchar">\n</span><span class="string">&lt;-- %s</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">(</span><span class="type">char</span><span class="symbol">*)</span><span class="normal">node</span><span class="symbol">-&gt;</span><span class="normal">key</span><span class="symbol">,</span><span class="normal"> fileinfo</span><span class="symbol">-&gt;</span><span class="normal">oldpath</span><span class="symbol">);</span>
<span class="normal">	</span><span class="symbol">++</span><span class="normal">count</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">count </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: no copied files detected during scan.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">		g_progname</span><span class="symbol">);</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="keyword">return</span><span class="normal"> TRUE</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="type">bool</span><span class="normal"> </span><span class="function">cmd_renamed</span><span class="symbol">(</span><span class="type">void</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">rb_node</span><span class="symbol">*</span><span class="normal"> node</span><span class="symbol">;</span>
<span class="normal">    </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> count </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">node </span><span class="symbol">=</span><span class="normal"> </span><span class="function">rb_begin</span><span class="symbol">(</span><span class="normal">g_filelist</span><span class="symbol">);</span><span class="normal"> node </span><span class="symbol">!=</span><span class="normal"> </span><span class="function">rb_end</span><span class="symbol">(</span><span class="normal">g_filelist</span><span class="symbol">);</span>
<span class="normal">         node </span><span class="symbol">=</span><span class="normal"> </span><span class="function">rb_successor</span><span class="symbol">(</span><span class="normal">g_filelist</span><span class="symbol">,</span><span class="normal"> node</span><span class="symbol">))</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">const</span><span class="normal"> </span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">FileInfo</span><span class="symbol">*</span><span class="normal"> fileinfo </span><span class="symbol">=</span><span class="normal"> node</span><span class="symbol">-&gt;</span><span class="normal">value</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">fileinfo</span><span class="symbol">-&gt;</span><span class="normal">status </span><span class="symbol">!=</span><span class="normal"> FS_RENAMED</span><span class="symbol">)</span><span class="normal"> </span><span class="keyword">continue</span><span class="symbol">;</span>

<span class="normal">	</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s renamed.</span><span class="specialchar">\n</span><span class="string">&lt;-- %s</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">(</span><span class="type">char</span><span class="symbol">*)</span><span class="normal">node</span><span class="symbol">-&gt;</span><span class="normal">key</span><span class="symbol">,</span><span class="normal"> fileinfo</span><span class="symbol">-&gt;</span><span class="normal">oldpath</span><span class="symbol">);</span>
<span class="normal">	</span><span class="symbol">++</span><span class="normal">count</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">count </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: no renamed files detected during scan.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">		g_progname</span><span class="symbol">);</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="keyword">return</span><span class="normal"> TRUE</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="type">bool</span><span class="normal"> </span><span class="function">cmd_skipped</span><span class="symbol">(</span><span class="type">void</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">rb_node</span><span class="symbol">*</span><span class="normal"> node</span><span class="symbol">;</span>
<span class="normal">    </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> count </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">node </span><span class="symbol">=</span><span class="normal"> </span><span class="function">rb_begin</span><span class="symbol">(</span><span class="normal">g_filelist</span><span class="symbol">);</span><span class="normal"> node </span><span class="symbol">!=</span><span class="normal"> </span><span class="function">rb_end</span><span class="symbol">(</span><span class="normal">g_filelist</span><span class="symbol">);</span>
<span class="normal">         node </span><span class="symbol">=</span><span class="normal"> </span><span class="function">rb_successor</span><span class="symbol">(</span><span class="normal">g_filelist</span><span class="symbol">,</span><span class="normal"> node</span><span class="symbol">))</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">const</span><span class="normal"> </span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">FileInfo</span><span class="symbol">*</span><span class="normal"> fileinfo </span><span class="symbol">=</span><span class="normal"> node</span><span class="symbol">-&gt;</span><span class="normal">value</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">fileinfo</span><span class="symbol">-&gt;</span><span class="normal">status </span><span class="symbol">!=</span><span class="normal"> FS_SKIPPED</span><span class="symbol">)</span><span class="normal"> </span><span class="keyword">continue</span><span class="symbol">;</span>

<span class="normal">	</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s SKIPPED.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">(</span><span class="type">char</span><span class="symbol">*)</span><span class="normal">node</span><span class="symbol">-&gt;</span><span class="normal">key</span><span class="symbol">);</span>
<span class="normal">	</span><span class="symbol">++</span><span class="normal">count</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">count </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: no files skipped during scan.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">		g_progname</span><span class="symbol">);</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="keyword">return</span><span class="normal"> TRUE</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="type">bool</span><span class="normal"> </span><span class="function">cmd_write</span><span class="symbol">(</span><span class="type">void</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="usertype">FILE</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">sumfile </span><span class="symbol">=</span><span class="normal"> </span><span class="function">fopen</span><span class="symbol">(</span><span class="normal">gopt_digestfile</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"wb"</span><span class="symbol">);</span>

<span class="normal">    </span><span class="usertype">uint32_t</span><span class="normal"> crc </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">    </span><span class="type">char</span><span class="normal"> digeststr</span><span class="symbol">[</span><span class="number">128</span><span class="symbol">];</span>
<span class="normal">    </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> digestcount </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">    </span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">rb_node</span><span class="symbol">*</span><span class="normal"> node</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">sumfile </span><span class="symbol">==</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: could not open %s: %s</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">		g_progname</span><span class="symbol">,</span><span class="normal"> gopt_digestfile</span><span class="symbol">,</span><span class="normal"> </span><span class="function">strerror</span><span class="symbol">(</span><span class="normal">errno</span><span class="symbol">));</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> TRUE</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="comment">/* add a small note current date at the beginning */</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="usertype">time_t</span><span class="normal"> tnow </span><span class="symbol">=</span><span class="normal"> </span><span class="function">time</span><span class="symbol">(</span><span class="normal">NULL</span><span class="symbol">);</span>
<span class="normal">	</span><span class="type">char</span><span class="normal"> datenow</span><span class="symbol">[</span><span class="number">64</span><span class="symbol">];</span>
<span class="normal">	</span><span class="function">strftime</span><span class="symbol">(</span><span class="normal">datenow</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="normal">datenow</span><span class="symbol">),</span><span class="normal"> </span><span class="string">"%Y-%m-%d %H:%M:%S %Z"</span><span class="symbol">,</span><span class="normal"> </span><span class="function">localtime</span><span class="symbol">(&amp;</span><span class="normal">tnow</span><span class="symbol">));</span>

<span class="normal">	</span><span class="function">fprintfcrc</span><span class="symbol">(&amp;</span><span class="normal">crc</span><span class="symbol">,</span><span class="normal"> sumfile</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"# %s last update: %s</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> g_progname</span><span class="symbol">,</span><span class="normal"> datenow</span><span class="symbol">);</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="comment">/* add persisent options to digest file */</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_exclude_marker</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="function">fprintfcrc</span><span class="symbol">(&amp;</span><span class="normal">crc</span><span class="symbol">,</span><span class="normal"> sumfile</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"#: option --exclude-marker=%s</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> gopt_exclude_marker</span><span class="symbol">);</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="comment">/* list files with properties and digests */</span>

<span class="normal">    </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">node </span><span class="symbol">=</span><span class="normal"> </span><span class="function">rb_begin</span><span class="symbol">(</span><span class="normal">g_filelist</span><span class="symbol">);</span><span class="normal"> node </span><span class="symbol">!=</span><span class="normal"> </span><span class="function">rb_end</span><span class="symbol">(</span><span class="normal">g_filelist</span><span class="symbol">);</span>
<span class="normal">         node </span><span class="symbol">=</span><span class="normal"> </span><span class="function">rb_successor</span><span class="symbol">(</span><span class="normal">g_filelist</span><span class="symbol">,</span><span class="normal"> node</span><span class="symbol">))</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">FileInfo</span><span class="symbol">*</span><span class="normal"> fileinfo </span><span class="symbol">=</span><span class="normal"> node</span><span class="symbol">-&gt;</span><span class="normal">value</span><span class="symbol">;</span>
<span class="normal">	</span><span class="type">char</span><span class="symbol">*</span><span class="normal"> filename</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">fileinfo</span><span class="symbol">-&gt;</span><span class="normal">status </span><span class="symbol">==</span><span class="normal"> FS_UNSEEN</span><span class="symbol">)</span><span class="normal"> </span><span class="keyword">continue</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">fileinfo</span><span class="symbol">-&gt;</span><span class="normal">status </span><span class="symbol">==</span><span class="normal"> FS_ERROR</span><span class="symbol">)</span><span class="normal"> </span><span class="keyword">continue</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">fileinfo</span><span class="symbol">-&gt;</span><span class="normal">status </span><span class="symbol">==</span><span class="normal"> FS_OLDPATH</span><span class="symbol">)</span><span class="normal"> </span><span class="keyword">continue</span><span class="symbol">;</span>

<span class="normal">	filename </span><span class="symbol">=</span><span class="normal"> </span><span class="function">strdup</span><span class="symbol">((</span><span class="type">char</span><span class="symbol">*)</span><span class="normal">node</span><span class="symbol">-&gt;</span><span class="normal">key</span><span class="symbol">);</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">fileinfo</span><span class="symbol">-&gt;</span><span class="normal">symlink</span><span class="symbol">)</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="preproc">#if</span><span class="normal"> ON_WIN32 </span><span class="comment">/* mingw uses msvcrt which uses %I64d or %I64u for long long formatting. */</span>

<span class="normal">	    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">needescape_filename</span><span class="symbol">(&amp;</span><span class="normal">fileinfo</span><span class="symbol">-&gt;</span><span class="normal">symlink</span><span class="symbol">))</span><span class="normal"> </span><span class="comment">/* may replace the symlink string */</span>
<span class="normal">		</span><span class="function">fprintfcrc</span><span class="symbol">(&amp;</span><span class="normal">crc</span><span class="symbol">,</span><span class="normal"> sumfile</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"#: mtime %ld size %I64d target</span><span class="specialchar">\\</span><span class="string"> %s</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> fileinfo</span><span class="symbol">-&gt;</span><span class="normal">mtime</span><span class="symbol">,</span><span class="normal"> fileinfo</span><span class="symbol">-&gt;</span><span class="normal">size</span><span class="symbol">,</span><span class="normal"> fileinfo</span><span class="symbol">-&gt;</span><span class="normal">symlink</span><span class="symbol">);</span>
<span class="normal">	    </span><span class="keyword">else</span>
<span class="normal">		</span><span class="function">fprintfcrc</span><span class="symbol">(&amp;</span><span class="normal">crc</span><span class="symbol">,</span><span class="normal"> sumfile</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"#: mtime %ld size %I64d target %s</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> fileinfo</span><span class="symbol">-&gt;</span><span class="normal">mtime</span><span class="symbol">,</span><span class="normal"> fileinfo</span><span class="symbol">-&gt;</span><span class="normal">size</span><span class="symbol">,</span><span class="normal"> fileinfo</span><span class="symbol">-&gt;</span><span class="normal">symlink</span><span class="symbol">);</span>

<span class="preproc">#else</span>

<span class="normal">	    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">needescape_filename</span><span class="symbol">(&amp;</span><span class="normal">fileinfo</span><span class="symbol">-&gt;</span><span class="normal">symlink</span><span class="symbol">))</span><span class="normal"> </span><span class="comment">/* may replace the symlink string */</span>
<span class="normal">		</span><span class="function">fprintfcrc</span><span class="symbol">(&amp;</span><span class="normal">crc</span><span class="symbol">,</span><span class="normal"> sumfile</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"#: mtime %ld size %lld target</span><span class="specialchar">\\</span><span class="string"> %s</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> fileinfo</span><span class="symbol">-&gt;</span><span class="normal">mtime</span><span class="symbol">,</span><span class="normal"> fileinfo</span><span class="symbol">-&gt;</span><span class="normal">size</span><span class="symbol">,</span><span class="normal"> fileinfo</span><span class="symbol">-&gt;</span><span class="normal">symlink</span><span class="symbol">);</span>
<span class="normal">	    </span><span class="keyword">else</span>
<span class="normal">		</span><span class="function">fprintfcrc</span><span class="symbol">(&amp;</span><span class="normal">crc</span><span class="symbol">,</span><span class="normal"> sumfile</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"#: mtime %ld size %lld target %s</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> fileinfo</span><span class="symbol">-&gt;</span><span class="normal">mtime</span><span class="symbol">,</span><span class="normal"> fileinfo</span><span class="symbol">-&gt;</span><span class="normal">size</span><span class="symbol">,</span><span class="normal"> fileinfo</span><span class="symbol">-&gt;</span><span class="normal">symlink</span><span class="symbol">);</span>

<span class="preproc">#endif</span>
<span class="normal">	    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">needescape_filename</span><span class="symbol">(&amp;</span><span class="normal">filename</span><span class="symbol">))</span><span class="normal"> </span><span class="comment">/* may replace the filename string */</span>
<span class="normal">		</span><span class="function">fprintfcrc</span><span class="symbol">(&amp;</span><span class="normal">crc</span><span class="symbol">,</span><span class="normal"> sumfile</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"#: symlink</span><span class="specialchar">\\</span><span class="string"> %s</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> filename</span><span class="symbol">);</span>
<span class="normal">	    </span><span class="keyword">else</span>
<span class="normal">		</span><span class="function">fprintfcrc</span><span class="symbol">(&amp;</span><span class="normal">crc</span><span class="symbol">,</span><span class="normal"> sumfile</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"#: symlink %s</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> filename</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">else</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="preproc">#if</span><span class="normal"> ON_WIN32 </span><span class="comment">/* mingw uses msvcrt which uses %I64d or %I64u for long long formatting. */</span>

<span class="normal">	    </span><span class="function">fprintfcrc</span><span class="symbol">(&amp;</span><span class="normal">crc</span><span class="symbol">,</span><span class="normal"> sumfile</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"#: mtime %ld size %I64d</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> fileinfo</span><span class="symbol">-&gt;</span><span class="normal">mtime</span><span class="symbol">,</span><span class="normal"> fileinfo</span><span class="symbol">-&gt;</span><span class="normal">size</span><span class="symbol">);</span>

<span class="preproc">#else</span>

<span class="normal">	    </span><span class="function">fprintfcrc</span><span class="symbol">(&amp;</span><span class="normal">crc</span><span class="symbol">,</span><span class="normal"> sumfile</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"#: mtime %ld size %lld</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> fileinfo</span><span class="symbol">-&gt;</span><span class="normal">mtime</span><span class="symbol">,</span><span class="normal"> fileinfo</span><span class="symbol">-&gt;</span><span class="normal">size</span><span class="symbol">);</span>

<span class="preproc">#endif</span>
<span class="normal">	    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">needescape_filename</span><span class="symbol">(&amp;</span><span class="normal">filename</span><span class="symbol">))</span><span class="normal"> </span><span class="comment">/* may replace the filename string */</span>
<span class="normal">		</span><span class="function">fprintfcrc</span><span class="symbol">(&amp;</span><span class="normal">crc</span><span class="symbol">,</span><span class="normal"> sumfile</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"</span><span class="specialchar">\\</span><span class="string">"</span><span class="symbol">);</span>

<span class="normal">	    </span><span class="function">fprintfcrc</span><span class="symbol">(&amp;</span><span class="normal">crc</span><span class="symbol">,</span><span class="normal"> sumfile</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s  %s</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> </span><span class="function">digest_bin2hex</span><span class="symbol">(</span><span class="normal">fileinfo</span><span class="symbol">-&gt;</span><span class="normal">digest</span><span class="symbol">,</span><span class="normal"> digeststr</span><span class="symbol">),</span><span class="normal"> filename</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="symbol">++</span><span class="normal">digestcount</span><span class="symbol">;</span>

<span class="normal">	</span><span class="function">free</span><span class="symbol">(</span><span class="normal">filename</span><span class="symbol">);</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">sumfile</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"#: crc 0x%08x eof</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> crc</span><span class="symbol">);</span>

<span class="normal">    </span><span class="function">fclose</span><span class="symbol">(</span><span class="normal">sumfile</span><span class="symbol">);</span>

<span class="normal">    </span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: wrote %d digests to %s</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">	    g_progname</span><span class="symbol">,</span><span class="normal"> digestcount</span><span class="symbol">,</span><span class="normal"> gopt_digestfile</span><span class="symbol">);</span>

<span class="normal">    </span><span class="keyword">return</span><span class="normal"> FALSE</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="type">bool</span><span class="normal"> </span><span class="function">cmd_quit</span><span class="symbol">(</span><span class="type">void</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> FALSE</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="keyword">static</span><span class="normal"> </span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">CommandEntry</span><span class="normal"> cmdlist</span><span class="symbol">[</span><span class="number">16</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="cbracket">{</span><span class="normal"> </span><span class="string">"help"</span><span class="symbol">,</span><span class="normal">		</span><span class="symbol">&amp;</span><span class="normal">cmd_help</span><span class="symbol">,</span><span class="normal">	</span><span class="string">"See this help text."</span><span class="normal"> </span><span class="cbracket">}</span><span class="symbol">,</span>
<span class="normal">    </span><span class="cbracket">{</span><span class="normal"> </span><span class="string">"new"</span><span class="symbol">,</span><span class="normal">		</span><span class="symbol">&amp;</span><span class="normal">cmd_new</span><span class="symbol">,</span><span class="normal">	</span><span class="string">"Print newly seen files not in digest file."</span><span class="normal"> </span><span class="cbracket">}</span><span class="symbol">,</span>
<span class="normal">    </span><span class="cbracket">{</span><span class="normal"> </span><span class="string">"untouched"</span><span class="symbol">,</span><span class="normal">	</span><span class="symbol">&amp;</span><span class="normal">cmd_untouched</span><span class="symbol">,</span><span class="normal">	</span><span class="string">"Print all untouched files."</span><span class="normal"> </span><span class="cbracket">}</span><span class="symbol">,</span>
<span class="normal">    </span><span class="cbracket">{</span><span class="normal"> </span><span class="string">"touched"</span><span class="symbol">,</span><span class="normal">	</span><span class="symbol">&amp;</span><span class="normal">cmd_touched</span><span class="symbol">,</span><span class="normal">	</span><span class="string">"Print all files with changed modification time."</span><span class="normal"> </span><span class="cbracket">}</span><span class="symbol">,</span>
<span class="normal">    </span><span class="cbracket">{</span><span class="normal"> </span><span class="string">"changed"</span><span class="symbol">,</span><span class="normal">	</span><span class="symbol">&amp;</span><span class="normal">cmd_changed</span><span class="symbol">,</span><span class="normal">	</span><span class="string">"Print files with changed contents."</span><span class="normal"> </span><span class="cbracket">}</span><span class="symbol">,</span>
<span class="normal">    </span><span class="cbracket">{</span><span class="normal"> </span><span class="string">"modified"</span><span class="symbol">,</span><span class="normal">	</span><span class="symbol">&amp;</span><span class="normal">cmd_changed</span><span class="symbol">,</span><span class="normal">	NULL </span><span class="cbracket">}</span><span class="symbol">,</span>
<span class="normal">    </span><span class="cbracket">{</span><span class="normal"> </span><span class="string">"copied"</span><span class="symbol">,</span><span class="normal">		</span><span class="symbol">&amp;</span><span class="normal">cmd_copied</span><span class="symbol">,</span><span class="normal">	</span><span class="string">"Print files copied from a different path."</span><span class="normal"> </span><span class="cbracket">}</span><span class="symbol">,</span>
<span class="normal">    </span><span class="cbracket">{</span><span class="normal"> </span><span class="string">"renamed"</span><span class="symbol">,</span><span class="normal">	</span><span class="symbol">&amp;</span><span class="normal">cmd_renamed</span><span class="symbol">,</span><span class="normal">	</span><span class="string">"Print files renamed from a different path."</span><span class="normal"> </span><span class="cbracket">}</span><span class="symbol">,</span>
<span class="normal">    </span><span class="cbracket">{</span><span class="normal"> </span><span class="string">"deleted"</span><span class="symbol">,</span><span class="normal">	</span><span class="symbol">&amp;</span><span class="normal">cmd_deleted</span><span class="symbol">,</span><span class="normal">	</span><span class="string">"Print deleted files."</span><span class="normal"> </span><span class="cbracket">}</span><span class="symbol">,</span>
<span class="normal">    </span><span class="cbracket">{</span><span class="normal"> </span><span class="string">"error"</span><span class="symbol">,</span><span class="normal">		</span><span class="symbol">&amp;</span><span class="normal">cmd_error</span><span class="symbol">,</span><span class="normal">	</span><span class="string">"Print files with read errors."</span><span class="normal"> </span><span class="cbracket">}</span><span class="symbol">,</span>
<span class="normal">    </span><span class="cbracket">{</span><span class="normal"> </span><span class="string">"skipped"</span><span class="symbol">,</span><span class="normal">	</span><span class="symbol">&amp;</span><span class="normal">cmd_skipped</span><span class="symbol">,</span><span class="normal">	</span><span class="string">"Print files skipped during scan."</span><span class="normal"> </span><span class="cbracket">}</span><span class="symbol">,</span>
<span class="normal">    </span><span class="cbracket">{</span><span class="normal"> </span><span class="string">"save"</span><span class="symbol">,</span><span class="normal">		</span><span class="symbol">&amp;</span><span class="normal">cmd_write</span><span class="symbol">,</span><span class="normal">	</span><span class="string">"Write updates to digest file and exit program."</span><span class="normal"> </span><span class="cbracket">}</span><span class="symbol">,</span>
<span class="normal">    </span><span class="cbracket">{</span><span class="normal"> </span><span class="string">"write"</span><span class="symbol">,</span><span class="normal">		</span><span class="symbol">&amp;</span><span class="normal">cmd_write</span><span class="symbol">,</span><span class="normal">	NULL </span><span class="cbracket">}</span><span class="symbol">,</span>
<span class="normal">    </span><span class="cbracket">{</span><span class="normal"> </span><span class="string">"exit"</span><span class="symbol">,</span><span class="normal">		</span><span class="symbol">&amp;</span><span class="normal">cmd_quit</span><span class="symbol">,</span><span class="normal">	</span><span class="string">"Exit program without saving updates."</span><span class="normal"> </span><span class="cbracket">}</span><span class="symbol">,</span>
<span class="normal">    </span><span class="cbracket">{</span><span class="normal"> </span><span class="string">"quit"</span><span class="symbol">,</span><span class="normal">		</span><span class="symbol">&amp;</span><span class="normal">cmd_quit</span><span class="symbol">,</span><span class="normal">	NULL </span><span class="cbracket">}</span><span class="symbol">,</span>
<span class="normal">    </span><span class="cbracket">{</span><span class="normal"> NULL</span><span class="symbol">,</span><span class="normal">             NULL</span><span class="symbol">,</span><span class="normal">		NULL </span><span class="cbracket">}</span><span class="symbol">,</span>
<span class="cbracket">}</span><span class="symbol">;</span>

<span class="comment">/**********</span>
<span class="comment"> * main() *</span>
<span class="comment"> **********/</span>

<span class="type">void</span><span class="normal"> </span><span class="function">print_usage</span><span class="symbol">(</span><span class="type">void</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="comment">/*          xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span>
<span class="comment"> */</span>

<span class="normal">    </span><span class="function">printf</span><span class="symbol">(</span><span class="string">"Usage: %s [OPTIONS...]</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">	   </span><span class="string">"</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">	   </span><span class="string">"Tool to read, verify and update MD5 or SHA digest files.</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">	   </span><span class="string">"</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> g_progname</span><span class="symbol">);</span>

<span class="normal">    </span><span class="function">printf</span><span class="symbol">(</span><span class="string">"Looks for a digest file (defaults to </span><span class="specialchar">\"</span><span class="string">md5sum.txt</span><span class="specialchar">\"</span><span class="string">, </span><span class="specialchar">\"</span><span class="string">sha1sum.txt</span><span class="specialchar">\"</span><span class="string">,</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">	   </span><span class="string">"</span><span class="specialchar">\"</span><span class="string">sha256sum.txt</span><span class="specialchar">\"</span><span class="string"> or </span><span class="specialchar">\"</span><span class="string">sha512sum.txt</span><span class="specialchar">\"</span><span class="string">) in the current directory. If one exists</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">	   </span><span class="string">"it is parsed and loaded. Then all files in the directory are recursively</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">	   </span><span class="string">"checked. Their status (new, unmodified, touched and matching, changed) is</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">	   </span><span class="string">"determined from modification time and the stored file digest. After the scan</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">	   </span><span class="string">"a manual review of the status can be done and a new digest file written.</span><span class="specialchar">\n</span><span class="string">"</span>
<span class="normal">	   </span><span class="string">"</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>

<span class="normal">    </span><span class="function">printf</span><span class="symbol">(</span><span class="string">"Options:</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">    </span><span class="function">printf</span><span class="symbol">(</span><span class="string">"  -b, --batch           enable non-interactive batch processing mode.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">    </span><span class="function">printf</span><span class="symbol">(</span><span class="string">"  -c, --check           perform full digest check ignoring modification times.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">    </span><span class="function">printf</span><span class="symbol">(</span><span class="string">"  -d, --directory=PATH  change into this directory before any operations.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">    </span><span class="function">printf</span><span class="symbol">(</span><span class="string">"      --exclude-marker=FILE  skip all directories contain this marker file.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">    </span><span class="function">printf</span><span class="symbol">(</span><span class="string">"  -f, --file=FILE       check FILE for existing digests and writing updates.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">    </span><span class="function">printf</span><span class="symbol">(</span><span class="string">"  -l, --links           follow symlinks instead of saving their destination.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">    </span><span class="function">printf</span><span class="symbol">(</span><span class="string">"  -m, --modified        suppressing printing of unchanged files.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">    </span><span class="function">printf</span><span class="symbol">(</span><span class="string">"      --modify-window=NUM  allow higher delta window for modification times.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">    </span><span class="function">printf</span><span class="symbol">(</span><span class="string">"  -q, --quiet           reduce status printing while scanning.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">    </span><span class="function">printf</span><span class="symbol">(</span><span class="string">"  -r, --restrict=PAT    run full digest check restricted to files matching PAT.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">    </span><span class="function">printf</span><span class="symbol">(</span><span class="string">"  -t, --type=TYPE       select digest type for newly created digest files.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">    </span><span class="function">printf</span><span class="symbol">(</span><span class="string">"                          TYPE = md5, sha1, sha256 or sha512.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">    </span><span class="function">printf</span><span class="symbol">(</span><span class="string">"  -u, --update          automatically update digest file in batch mode.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">    </span><span class="function">printf</span><span class="symbol">(</span><span class="string">"  -v, --verbose         increase status printing during scanning.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">    </span><span class="function">printf</span><span class="symbol">(</span><span class="string">"  -w, --windows         allow a --modify-window of 1 (for FAT filesystems).</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">    </span><span class="function">printf</span><span class="symbol">(</span><span class="string">"</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>

<span class="normal">    </span><span class="function">printf</span><span class="symbol">(</span><span class="string">"See </span><span class="specialchar">\"</span><span class="string">man 1 digup</span><span class="specialchar">\"</span><span class="string"> for further explanations. This is digup "</span><span class="normal"> VERSION </span><span class="string">"</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">    </span><span class="function">printf</span><span class="symbol">(</span><span class="string">"</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="type">int</span><span class="normal"> </span><span class="function">main</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> argc</span><span class="symbol">,</span><span class="normal"> </span><span class="type">char</span><span class="symbol">*</span><span class="normal"> argv</span><span class="symbol">[])</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="type">int</span><span class="normal"> retcode </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">    g_progname </span><span class="symbol">=</span><span class="normal"> argv</span><span class="symbol">[</span><span class="number">0</span><span class="symbol">];</span>

<span class="normal">    </span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="number">1</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">static</span><span class="normal"> </span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">option</span><span class="normal"> long_options</span><span class="symbol">[]</span><span class="normal"> </span><span class="symbol">=</span>
<span class="normal">	    </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="cbracket">{</span><span class="normal"> </span><span class="string">"batch"</span><span class="symbol">,</span><span class="normal">   	no_argument</span><span class="symbol">,</span><span class="normal">       </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="string">'b'</span><span class="normal"> </span><span class="cbracket">}</span><span class="symbol">,</span>
<span class="normal">		</span><span class="cbracket">{</span><span class="normal"> </span><span class="string">"check"</span><span class="symbol">,</span><span class="normal">   	no_argument</span><span class="symbol">,</span><span class="normal">       </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="string">'c'</span><span class="normal"> </span><span class="cbracket">}</span><span class="symbol">,</span>
<span class="normal">		</span><span class="cbracket">{</span><span class="normal"> </span><span class="string">"directory"</span><span class="symbol">,</span><span class="normal">	required_argument</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="string">'d'</span><span class="normal"> </span><span class="cbracket">}</span><span class="symbol">,</span>
<span class="normal">		</span><span class="cbracket">{</span><span class="normal"> </span><span class="string">"file"</span><span class="symbol">,</span><span class="normal">   	required_argument</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="string">'f'</span><span class="normal"> </span><span class="cbracket">}</span><span class="symbol">,</span>
<span class="normal">		</span><span class="cbracket">{</span><span class="normal"> </span><span class="string">"help"</span><span class="symbol">,</span><span class="normal">   	no_argument</span><span class="symbol">,</span><span class="normal">       </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="string">'h'</span><span class="normal"> </span><span class="cbracket">}</span><span class="symbol">,</span>
<span class="normal">		</span><span class="cbracket">{</span><span class="normal"> </span><span class="string">"links"</span><span class="symbol">,</span><span class="normal">      no_argument</span><span class="symbol">,</span><span class="normal">       </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="string">'l'</span><span class="normal"> </span><span class="cbracket">}</span><span class="symbol">,</span>
<span class="normal">		</span><span class="cbracket">{</span><span class="normal"> </span><span class="string">"modified"</span><span class="symbol">,</span><span class="normal">  	no_argument</span><span class="symbol">,</span><span class="normal">       </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="string">'m'</span><span class="normal"> </span><span class="cbracket">}</span><span class="symbol">,</span>
<span class="normal">		</span><span class="cbracket">{</span><span class="normal"> </span><span class="string">"quiet"</span><span class="symbol">,</span><span class="normal">      no_argument</span><span class="symbol">,</span><span class="normal">       </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="string">'q'</span><span class="normal"> </span><span class="cbracket">}</span><span class="symbol">,</span>
<span class="normal">		</span><span class="cbracket">{</span><span class="normal"> </span><span class="string">"restrict"</span><span class="symbol">,</span><span class="normal">   required_argument</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="string">'r'</span><span class="normal"> </span><span class="cbracket">}</span><span class="symbol">,</span>
<span class="normal">		</span><span class="cbracket">{</span><span class="normal"> </span><span class="string">"type"</span><span class="symbol">,</span><span class="normal">   	required_argument</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="string">'t'</span><span class="normal"> </span><span class="cbracket">}</span><span class="symbol">,</span>
<span class="normal">		</span><span class="cbracket">{</span><span class="normal"> </span><span class="string">"update"</span><span class="symbol">,</span><span class="normal">     no_argument</span><span class="symbol">,</span><span class="normal">       </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="string">'u'</span><span class="normal"> </span><span class="cbracket">}</span><span class="symbol">,</span>
<span class="normal">		</span><span class="cbracket">{</span><span class="normal"> </span><span class="string">"verbose"</span><span class="symbol">,</span><span class="normal">    no_argument</span><span class="symbol">,</span><span class="normal">       </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="string">'v'</span><span class="normal"> </span><span class="cbracket">}</span><span class="symbol">,</span>
<span class="normal">		</span><span class="cbracket">{</span><span class="normal"> </span><span class="string">"windows"</span><span class="symbol">,</span><span class="normal">    no_argument</span><span class="symbol">,</span><span class="normal">       </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="string">'w'</span><span class="normal"> </span><span class="cbracket">}</span><span class="symbol">,</span>
<span class="normal">		</span><span class="cbracket">{</span><span class="normal"> </span><span class="string">"modify-window"</span><span class="symbol">,</span><span class="normal"> required_argument</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="number">1</span><span class="normal"> </span><span class="cbracket">}</span><span class="symbol">,</span>
<span class="normal">		</span><span class="cbracket">{</span><span class="normal"> </span><span class="string">"exclude-marker"</span><span class="symbol">,</span><span class="normal"> required_argument</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="number">2</span><span class="normal"> </span><span class="cbracket">}</span><span class="symbol">,</span>
<span class="normal">		</span><span class="cbracket">{</span><span class="normal"> NULL</span><span class="symbol">,</span><span class="normal">	    	</span><span class="number">0</span><span class="symbol">,</span><span class="normal">                 </span><span class="number">0</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="normal"> </span><span class="cbracket">}</span>
<span class="normal">	    </span><span class="cbracket">}</span><span class="symbol">;</span>

<span class="normal">	</span><span class="comment">/* getgopt_long stores the option index here. */</span>
<span class="normal">	</span><span class="type">int</span><span class="normal"> option_index </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">	</span><span class="type">int</span><span class="normal"> c </span><span class="symbol">=</span><span class="normal"> </span><span class="function">getopt_long</span><span class="symbol">(</span><span class="normal">argc</span><span class="symbol">,</span><span class="normal"> argv</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"bcd:f:hlmqr:t:uvw"</span><span class="symbol">,</span>
<span class="normal">			    long_options</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">option_index</span><span class="symbol">);</span>

<span class="normal">     	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">c </span><span class="symbol">==</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">switch</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">c</span><span class="symbol">)</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">case</span><span class="normal"> </span><span class="number">1</span><span class="symbol">:</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">endp</span><span class="symbol">;</span>
<span class="normal">	    gopt_modify_window </span><span class="symbol">=</span><span class="normal"> </span><span class="function">strtoul</span><span class="symbol">(</span><span class="normal">optarg</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">endp</span><span class="symbol">,</span><span class="normal"> </span><span class="number">10</span><span class="symbol">);</span>
<span class="normal">	    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">endp </span><span class="symbol">||</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">endp</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: invalid valid for modify window: use an unsigned integer</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">			g_progname</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	    </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> </span><span class="number">2</span><span class="symbol">:</span>
<span class="normal">	    gopt_exclude_marker </span><span class="symbol">=</span><span class="normal"> </span><span class="function">strdup</span><span class="symbol">(</span><span class="normal">optarg</span><span class="symbol">);</span>
<span class="normal">	    </span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> </span><span class="string">'b'</span><span class="symbol">:</span>
<span class="normal">	    gopt_batch </span><span class="symbol">=</span><span class="normal"> TRUE</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="symbol">--</span><span class="normal">gopt_verbose</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> </span><span class="string">'c'</span><span class="symbol">:</span>
<span class="normal">	    gopt_fullcheck </span><span class="symbol">=</span><span class="normal"> TRUE</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> </span><span class="string">'d'</span><span class="symbol">:</span>
<span class="normal">	    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">chdir</span><span class="symbol">(</span><span class="normal">optarg</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">	    </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: could not chdir to </span><span class="specialchar">\"</span><span class="string">%s</span><span class="specialchar">\"</span><span class="string">: %s</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">			g_progname</span><span class="symbol">,</span><span class="normal"> optarg</span><span class="symbol">,</span><span class="normal"> </span><span class="function">strerror</span><span class="symbol">(</span><span class="normal">errno</span><span class="symbol">));</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	    </span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> </span><span class="string">'f'</span><span class="symbol">:</span>
<span class="normal">	    gopt_digestfile </span><span class="symbol">=</span><span class="normal"> optarg</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> </span><span class="string">'h'</span><span class="symbol">:</span>
<span class="normal">	    </span><span class="function">print_usage</span><span class="symbol">();</span>
<span class="normal">	    </span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> </span><span class="string">'l'</span><span class="symbol">:</span>
<span class="normal">	    gopt_followsymlinks </span><span class="symbol">=</span><span class="normal"> TRUE</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> </span><span class="string">'m'</span><span class="symbol">:</span>
<span class="normal">	    gopt_onlymodified </span><span class="symbol">=</span><span class="normal"> TRUE</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> </span><span class="string">'q'</span><span class="symbol">:</span>
<span class="normal">	    </span><span class="symbol">--</span><span class="normal">gopt_verbose</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> </span><span class="string">'r'</span><span class="symbol">:</span>
<span class="normal">	    gopt_matchpattern </span><span class="symbol">=</span><span class="normal"> optarg</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"Checking only paths matching: </span><span class="specialchar">\"</span><span class="string">%s</span><span class="specialchar">\"</span><span class="string">.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> gopt_matchpattern</span><span class="symbol">);</span>
<span class="normal">	    </span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> </span><span class="string">'t'</span><span class="symbol">:</span>
<span class="normal">	    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">strcasecmp</span><span class="symbol">(</span><span class="normal">optarg</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"md5"</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">	    </span><span class="cbracket">{</span>
<span class="normal">		gopt_digesttype </span><span class="symbol">=</span><span class="normal"> DT_MD5</span><span class="symbol">;</span>

<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_digestfile </span><span class="symbol">==</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">		    gopt_digestfile </span><span class="symbol">=</span><span class="normal"> </span><span class="string">"md5sum.txt"</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	    </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">strcasecmp</span><span class="symbol">(</span><span class="normal">optarg</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"sha1"</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">	    </span><span class="cbracket">{</span>
<span class="normal">		gopt_digesttype </span><span class="symbol">=</span><span class="normal"> DT_SHA1</span><span class="symbol">;</span>

<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_digestfile </span><span class="symbol">==</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">		    gopt_digestfile </span><span class="symbol">=</span><span class="normal"> </span><span class="string">"sha1sum.txt"</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	    </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">strcasecmp</span><span class="symbol">(</span><span class="normal">optarg</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"sha128"</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">	    </span><span class="cbracket">{</span>
<span class="normal">		gopt_digesttype </span><span class="symbol">=</span><span class="normal"> DT_SHA1</span><span class="symbol">;</span>

<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_digestfile </span><span class="symbol">==</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">		    gopt_digestfile </span><span class="symbol">=</span><span class="normal"> </span><span class="string">"sha128sum.txt"</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	    </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">strcasecmp</span><span class="symbol">(</span><span class="normal">optarg</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"sha256"</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">	    </span><span class="cbracket">{</span>
<span class="normal">		gopt_digesttype </span><span class="symbol">=</span><span class="normal"> DT_SHA256</span><span class="symbol">;</span>

<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_digestfile </span><span class="symbol">==</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">		    gopt_digestfile </span><span class="symbol">=</span><span class="normal"> </span><span class="string">"sha256sum.txt"</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	    </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">strcasecmp</span><span class="symbol">(</span><span class="normal">optarg</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"sha512"</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">	    </span><span class="cbracket">{</span>
<span class="normal">		gopt_digesttype </span><span class="symbol">=</span><span class="normal"> DT_SHA512</span><span class="symbol">;</span>

<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_digestfile </span><span class="symbol">==</span><span class="normal"> NULL</span><span class="symbol">)</span>
<span class="normal">		    gopt_digestfile </span><span class="symbol">=</span><span class="normal"> </span><span class="string">"sha512sum.txt"</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	    </span><span class="keyword">else</span>
<span class="normal">	    </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: unknown digest type: </span><span class="specialchar">\"</span><span class="string">%s</span><span class="specialchar">\"</span><span class="string">. See --help.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">			g_progname</span><span class="symbol">,</span><span class="normal"> optarg</span><span class="symbol">);</span>
<span class="normal">		</span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	    </span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> </span><span class="string">'u'</span><span class="symbol">:</span>
<span class="normal">	    gopt_update </span><span class="symbol">=</span><span class="normal"> TRUE</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> </span><span class="string">'v'</span><span class="symbol">:</span>
<span class="normal">	    </span><span class="symbol">++</span><span class="normal">gopt_verbose</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> </span><span class="string">'w'</span><span class="symbol">:</span>
<span class="normal">	    gopt_modify_window </span><span class="symbol">=</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="keyword">break</span><span class="symbol">;</span>

<span class="normal">	</span><span class="keyword">case</span><span class="normal"> </span><span class="string">'?'</span><span class="symbol">:</span>
<span class="normal">	    </span><span class="comment">/* getgopt_long already printed an error message. */</span>
<span class="normal">	    </span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"Try </span><span class="specialchar">\"</span><span class="string">%s --help</span><span class="specialchar">\"</span><span class="string"> for more information on program usage.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> g_progname</span><span class="symbol">);</span>
<span class="normal">	    </span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">;</span>

<span class="label">	default:</span>
<span class="normal">	    </span><span class="function">assert</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">);</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="comment">/* print any remaining unknown command line arguments. */</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">optind </span><span class="symbol">&lt;</span><span class="normal"> argc</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">optind </span><span class="symbol">&lt;</span><span class="normal"> argc</span><span class="symbol">)</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: superfluous argument </span><span class="specialchar">\"</span><span class="string">%s</span><span class="specialchar">\"\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> g_progname</span><span class="symbol">,</span><span class="normal"> argv</span><span class="symbol">[</span><span class="normal">optind</span><span class="symbol">++]);</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="comment">/* reduce level for only-modified printing */</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_onlymodified </span><span class="symbol">&amp;&amp;</span><span class="normal"> gopt_verbose </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span>
<span class="normal">	gopt_verbose </span><span class="symbol">=</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_update </span><span class="symbol">&amp;&amp;</span><span class="normal"> </span><span class="symbol">!</span><span class="normal">gopt_batch</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stderr</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: automaticcaly updating the digest file requires --batch mode.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> g_progname</span><span class="symbol">);</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="comment">/* initialize red-black trees */</span>

<span class="normal">    g_filelist </span><span class="symbol">=</span><span class="normal"> </span><span class="function">rb_create</span><span class="symbol">(</span><span class="normal">rbtree_string_cmp</span><span class="symbol">,</span><span class="normal"> rbtree_string_free</span><span class="symbol">,</span><span class="normal"> rbtree_fileinfo_free</span><span class="symbol">,</span><span class="normal"> NULL</span><span class="symbol">,</span><span class="normal"> NULL</span><span class="symbol">);</span>

<span class="normal">    g_filedigestmap </span><span class="symbol">=</span><span class="normal"> </span><span class="function">rb_create</span><span class="symbol">(</span><span class="normal">rbtree_digest_result_cmp</span><span class="symbol">,</span><span class="normal"> rbtree_digest_result_free</span><span class="symbol">,</span><span class="normal"> rbtree_null_free</span><span class="symbol">,</span><span class="normal"> NULL</span><span class="symbol">,</span><span class="normal"> NULL</span><span class="symbol">);</span>

<span class="normal">    </span><span class="comment">/* read digest file if it exists */</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="function">read_digestfile</span><span class="symbol">())</span>
<span class="normal">	</span><span class="keyword">return</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">;</span>

<span class="normal">    </span><span class="comment">/* recursively scan current directory */</span>

<span class="normal">    </span><span class="function">start_scan</span><span class="symbol">(</span><span class="string">"."</span><span class="symbol">);</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">filelist_deleted</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> </span><span class="number">0</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> </span><span class="symbol">!</span><span class="normal">gopt_onlymodified</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="comment">/* always print deleted files, otherwise they may be silently ignored. */</span>
<span class="normal">	</span><span class="function">cmd_deleted</span><span class="symbol">();</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="comment">/* batch processing */</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_batch</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="function">filelist_clean</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">||</span><span class="normal"> </span><span class="symbol">!</span><span class="normal">gopt_onlymodified</span><span class="symbol">)</span>
<span class="normal">	    </span><span class="function">print_summary</span><span class="symbol">();</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_update</span><span class="symbol">)</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="function">cmd_write</span><span class="symbol">();</span>
<span class="normal">	</span><span class="cbracket">}</span>

<span class="normal">	</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">filelist_clean</span><span class="symbol">())</span>
<span class="normal">	    retcode </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">	</span><span class="keyword">else</span>
<span class="normal">	    retcode </span><span class="symbol">=</span><span class="normal"> </span><span class="number">1</span><span class="symbol">;</span><span class="normal"> </span><span class="comment">/* changes, renames, moves, deletes or read errors detected. */</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="normal">    </span><span class="comment">/* interactive processing */</span>
<span class="normal">    </span><span class="keyword">else</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">	</span><span class="type">char</span><span class="normal"> input</span><span class="symbol">[</span><span class="number">256</span><span class="symbol">];</span>

<span class="normal">	</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"Scan finished. "</span><span class="symbol">);</span>

<span class="normal">	</span><span class="comment">/* print scan summary */</span>

<span class="normal">	</span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal"> </span><span class="function">print_summary</span><span class="symbol">(),</span>
<span class="normal">		</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"Command (see help)? "</span><span class="symbol">),</span>
<span class="normal">		</span><span class="function">fgets</span><span class="symbol">(</span><span class="normal">input</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="normal">input</span><span class="symbol">),</span><span class="normal"> stdin</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">)</span>
<span class="normal">	</span><span class="cbracket">{</span>
<span class="normal">	    </span><span class="comment">/* Run through command table and determine entry by prefix matching */</span>
<span class="normal">	    </span><span class="type">int</span><span class="normal"> cmd </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="type">unsigned</span><span class="normal"> </span><span class="type">int</span><span class="normal"> i</span><span class="symbol">;</span>

<span class="normal">	    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">strlen</span><span class="symbol">(</span><span class="normal">input</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">&gt;</span><span class="normal"> </span><span class="number">0</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> input</span><span class="symbol">[</span><span class="function">strlen</span><span class="symbol">(</span><span class="normal">input</span><span class="symbol">)-</span><span class="number">1</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="string">'</span><span class="specialchar">\n</span><span class="string">'</span><span class="symbol">)</span>
<span class="normal">		input</span><span class="symbol">[</span><span class="function">strlen</span><span class="symbol">(</span><span class="normal">input</span><span class="symbol">)-</span><span class="number">1</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>

<span class="normal">	    </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">i </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> cmdlist</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">name</span><span class="symbol">;</span><span class="normal"> </span><span class="symbol">++</span><span class="normal">i</span><span class="symbol">)</span>
<span class="normal">	    </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="function">strncmp</span><span class="symbol">(</span><span class="normal">input</span><span class="symbol">,</span><span class="normal"> cmdlist</span><span class="symbol">[</span><span class="normal">i</span><span class="symbol">].</span><span class="normal">name</span><span class="symbol">,</span><span class="normal"> </span><span class="function">strlen</span><span class="symbol">(</span><span class="normal">input</span><span class="symbol">))</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">		</span><span class="cbracket">{</span>
<span class="normal">		    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">cmd </span><span class="symbol">==</span><span class="normal"> </span><span class="symbol">-</span><span class="number">1</span><span class="symbol">)</span><span class="normal"> cmd </span><span class="symbol">=</span><span class="normal"> i</span><span class="symbol">;</span>
<span class="normal">		    </span><span class="keyword">else</span><span class="normal"> cmd </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">-</span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">		</span><span class="cbracket">}</span>
<span class="normal">	    </span><span class="cbracket">}</span>

<span class="normal">	    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">cmd </span><span class="symbol">&gt;=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span>
<span class="normal">	    </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">cmdlist</span><span class="symbol">[</span><span class="normal">cmd</span><span class="symbol">].</span><span class="function">func</span><span class="symbol">())</span>
<span class="normal">		    </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	    </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">cmd </span><span class="symbol">==</span><span class="normal"> </span><span class="symbol">-</span><span class="number">2</span><span class="symbol">)</span>
<span class="normal">	    </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: Ambigious command. See </span><span class="specialchar">\"</span><span class="string">help</span><span class="specialchar">\"</span><span class="string">.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">			g_progname</span><span class="symbol">);</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	    </span><span class="keyword">else</span>
<span class="normal">	    </span><span class="cbracket">{</span>
<span class="normal">		</span><span class="function">fprintf</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"%s: Unknown command. See </span><span class="specialchar">\"</span><span class="string">help</span><span class="specialchar">\"</span><span class="string">.</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span>
<span class="normal">			g_progname</span><span class="symbol">);</span>
<span class="normal">	    </span><span class="cbracket">}</span>
<span class="normal">	</span><span class="cbracket">}</span>
<span class="normal">    </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="function">rb_destroy</span><span class="symbol">(</span><span class="normal">g_filelist</span><span class="symbol">);</span>
<span class="normal">    </span><span class="function">rb_destroy</span><span class="symbol">(</span><span class="normal">g_filedigestmap</span><span class="symbol">);</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">dirstack</span><span class="symbol">)</span><span class="normal"> </span><span class="function">free</span><span class="symbol">(</span><span class="normal">dirstack</span><span class="symbol">);</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">gopt_exclude_marker</span><span class="symbol">)</span><span class="normal"> </span><span class="function">free</span><span class="symbol">((</span><span class="type">void</span><span class="symbol">*)</span><span class="normal">gopt_exclude_marker</span><span class="symbol">);</span>

<span class="normal">    </span><span class="keyword">return</span><span class="normal"> retcode</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="comment">/*****************************************************************************/</span>
</tt></pre></div><footer><div style="text-align: right; padding: 8pt; font-size: 13px"><a href="/xmlfeed/weblog-rss20.xml"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAAAPAgMAAAAOp6AcAAAADFBMVEVmZmb/ZgD///+JjnlbTUWmAAAACXBIWXMAAABIAAAASABGyWs+AAAACXZwQWcAAABQAAAADwCexKkxAAAAWUlEQVQYlWNgwAa0VmGAFQyqoSCQ/x8J/CBFMCt0ZdTU/F/7/+1HEkydFpoKVPn+93sUlUujQvP/7UcRTAuNDJ2a//s/imDqtKVZofm/1qGYSZk7sfodGwAAiobBJtffoNAAAAAASUVORK5CYII=" alt="RSS 2.0 Weblog Feed" width="80" height="15"/></a> <a href="/xmlfeed/weblog-atom10.xml"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAAAPAgMAAAAOp6AcAAAADFBMVEVmZmb/ZgD///+JjnlbTUWmAAAAaklEQVQYlWNgwAa0VmGAFQyqoSCQ/x8J/CBFMDV16rTQ/H/7V//69+//v/3/9oMEI6cuAwr+fv/+/b5d///v//0eJBgWOhMo+Gs9UPAdXDBy6lSYyn9wQZCZS0GCYDPXQcykzJ1Y/Y4NAABKvL80wyoMPgAAAABJRU5ErkJggg==" alt="Atom 1.0 Weblog Feed" width="80" height="15"/></a> <a href="http://validator.w3.org/check?uri=referer"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAAAPCAMAAABEF7i9AAAB1FBMVEUHQIgIRY0MN4QNRYoSRYsXUpIYVJQeUpUhWpgjUJMjWpgmU5QnXJkuYZ0uYpwwV5YyZJ4zaKM3ZaA5aaI6aqM6a6E8ZqA8Z6BAbaRBbqdCbaVHd61KSkpKcaZQUFBUf69UgbBVVVVXfq9Yg7NZhbJZh7RagrNeXVxeh7RfjLdgYGBiiLZmZmZnZ2doirhpkbt0m8F3m8B3ncJ5lb55ocR+ocSDgX+Do8eEpMqGhoaHp8iIpMeJjnmJpseKqMeOqsqPsdCQrcyVlZWVsM2Zs9CZtNCfu9ahoaGhuNShudSivNSjtMWjvNSmpqWnpqSrw9qvxNqyxdmyxdyzsK6zs7Ozx9y0xt21yN22tra4y+K80eK/v7/AwMDExMTEy9DH2ejK2+jM2ujN3uvP0dLR0NDR3uvS3uvS3+zU4u3V1dXY2dnY4u7Y4+3b5e/d3d3d5u/d5/De3t7f39/h4uLj4uHj6/Ll7PXm7fTn7/Xo7/Tp7/bq7Ozr6unr8ffw8PDw9vvx9fny+P7z8/Pz9vnz9vv3+fv4+vz5+vz6+vr6+/36/P36///7+/77/Pz7/f37/f78/Pz8/f38/f79/f39/f79/f/9/v79///+/v7+/v////3///+tYR2LAAABKklEQVQ4y2PQoTJg0JlNVYDPQBsyAMTAqaFes8tdsmdPCtA3MDStr3GKKK6myMAprgJ9pcpWs/MlRExYJBvNZLR0sigycHYOV1S7mtjsQJ4gf+HIFPXoWMs6qIGzIRiKZs9GFoEaMRuZhhrYqqJXy8uZYauRxC/VHew7e3YTPAxnI5swG6JxNrKBNjB1EFmIgV0+HA6C8pqqzhXG7BbJJROQIwViMYQ7G2oDQQNn57JyG7kxiCfObrBmS5+BHMuYLkTzMnYDm5WY4lOZZRPKZocxes+aPbuwCFsYohiICLvZsKBAMrDTQ7K/StveU8icTzrOL8JdLpOyWJ49u8Bx9ozw8DY7UYW03hhdxZAOSg2c3jN79rSJs1vSKmfOnpFXNJmynELlvExlAADnaZpLFGEC2wAAAABJRU5ErkJggg==" alt="Valid XHTML 1.1" width="80" height="15"/></a> <a href="http://jigsaw.w3.org/css-validator/check/referer"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAAAPCAMAAABEF7i9AAAB1FBMVEUHQIgIRY0MN4QNRYoSRYsXUpIYVJQeUpUhWpgjUJMjWpgmU5QnXJkuYZ0uYpwwV5YyZJ4zaKM3ZaA5aaI6aqM6a6E8ZqA8Z6BAbaRBbqdCbaVHd61KSkpKcaZQUFBUf69UgbBVVVVXfq9Yg7NZhbJZh7RagrNeXVxeh7RfjLdgYGBiiLZmZmZnZ2doirhpkbt0m8F3m8B3ncJ5lb55ocR+ocSDgX+Do8eEpMqGhoaHp8iIpMeJjnmJpseKqMeOqsqPsdCQrcyVlZWVsM2Zs9CZtNCfu9ahoaGhuNShudSivNSjtMWjvNSmpqWnpqSrw9qvxNqyxdmyxdyzsK6zs7Ozx9y0xt21yN22tra4y+K80eK/v7/AwMDExMTEy9DH2ejK2+jM2ujN3uvP0dLR0NDR3uvS3uvS3+zU4u3V1dXY2dnY4u7Y4+3b5e/d3d3d5u/d5/De3t7f39/h4uLj4uHj6/Ll7PXm7fTn7/Xo7/Tp7/bq7Ozr6unr8ffw8PDw9vvx9fny+P7z8/Pz9vnz9vv3+fv4+vz5+vz6+vr6+/36/P36///7+/77/Pz7/f37/f78/Pz8/f38/f79/f39/f79/f/9/v79///+/v7+/v////3///+tYR2LAAABEUlEQVQ4y2PQoTJg0JlNVYDPQBsyAMTAqaFes8tdsmdPCtA3MDStr3GKKK6myMAprgJ9pcpWs/MlRExYJBvNZLR0sigycHYOV1S7mtjsQJ4gf+HIFPXoWMs6mIEQCsIjwhKoga0qerW8nBm2Gkn8Ut3BvrNnN8HCcDYM2cBIogzs8uFwEJTXVHWuMGa3SC6ZgIgUqCEwdxJr4OxcVm4jNwbxxNkN1mzpM2ajGIjsPGK9PLtZiSk+lVk2oWx2GKP3rNmzC4tQwpDoIIQb2Okh2V+lbe8pZM4nHecX4S6XSVksz55d4Dh7Rnh4m52oQlpvjK5iSAelBk7vmT172sTZLWmVM2fPyCuaTFlOoXJepjIAANlljDGY/l5pAAAAAElFTkSuQmCC" alt="Valid CSS (2.1)" width="80" height="15"/></a><br/>Copyright 2005-2022 <a href="/about/">Timo Bingmann</a>. All rights reserved.</div></footer></body></html>